# Proxy / WAF Protections Bypass

Tehnike [iz ovog istraživanja](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Primer Nginx pravila:

```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```

### **NodeJS - Express**

| Nginx verzija | **Node.js Karakteri za Obilaženje** |
| ------------- | ----------------------------------- |
| 1.22.0        | `\xA0`                              |
| 1.21.6        | `\xA0`                              |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`              |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`              |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`              |

### **Flask**

| Nginx verzija | **Flask Karakteri za Obilaženje**                              |
| ------------- | -------------------------------------------------------------- |
| 1.22.0        | `\x85`, `\xA0`                                                 |
| 1.21.6        | `\x85`, `\xA0`                                                 |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### **Spring Boot**

| Nginx verzija | **Spring Boot Karakteri za Obilaženje** |
| ------------- | --------------------------------------- |
| 1.22.0        | `;`                                     |
| 1.21.6        | `;`                                     |
| 1.20.2        | `\x09`, `;`                             |
| 1.18.0        | `\x09`, `;`                             |
| 1.16.1        | `\x09`, `;`                             |

### **PHP-FPM**

Konfiguracija Nginx FPM:

```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```

Nginx je konfigurisan da blokira pristup `/admin.php`, ali je moguće zaobići to pristupanjem `/admin.php/index.php`.

### Kako sprečiti

```plaintext
location ~* ^/admin {
deny all;
}
```

## Bypassovanje Mod Security pravila <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Konfuzija putanje

[U ovom postu](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) je objašnjeno da ModSecurity v3 (do 3.0.12), **nepropisno implementirao promenljivu `REQUEST_FILENAME`** koja je trebalo da sadrži pristupljenu putanju (do početka parametara). To je zato što je vršio URL dekodiranje da bi dobio putanju.\
Stoga, zahtev poput `http://example.com/foo%3f';alert(1);foo=` u mod security će pretpostaviti da je putanja samo `/foo` jer se `%3f` transformiše u `?` završavajući URL putanju, ali zapravo putanja koju će server primiti će biti `/foo%3f';alert(1);foo=`.

Promenljive `REQUEST_BASENAME` i `PATH_INFO` takođe su bile pogođene ovim bagom.

Nešto slično se dogodilo u verziji 2 Mod Security-ja koja je omogućila zaobilaženje zaštite koja je sprečavala korisnika da pristupi fajlovima sa specifičnim ekstenzijama vezanim za rezervne kopije fajlova (kao što su `.bak`) jednostavno slanjem tačke URL enkodiranu u `%2e`, na primer: `https://example.com/backup%2ebak`.

## Bypassovanje AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Deformisani zaglavlje

[Ovo istraživanje](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) pominje da je bilo moguće zaobići AWS WAF pravila primenjena na HTTP zaglavlja slanjem "deformisanog" zaglavlja koje nije bilo pravilno parsirano od strane AWS-a, ali jeste od strane serverske aplikacije.

Na primer, slanjem sledećeg zahteva sa SQL injection-om u zaglavlju X-Query:

```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```

## Reference

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
