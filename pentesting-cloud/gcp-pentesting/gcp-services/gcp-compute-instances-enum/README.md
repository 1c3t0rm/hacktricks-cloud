# GCP - Compute Enum

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## GCP VPC & Networking

Learn about how this works in:

{% content-ref url="gcp-vpc-and-networking.md" %}
[gcp-vpc-and-networking.md](gcp-vpc-and-networking.md)
{% endcontent-ref %}

### Enumeration

{% code overflow="wrap" %}
```bash
# List networks
gcloud compute networks list
gcloud compute networks describe <network>

# List subnetworks
gcloud compute networks subnets list
gcloud compute networks subnets get-iam-policy <name> --region <region>
gcloud compute networks subnets describe <name> --region <region>

# List FW rules in networks
gcloud compute firewall-rules list --format="table(
name,
network,
direction,
priority,
sourceRanges.list():label=SRC_RANGES,
destinationRanges.list():label=DEST_RANGES,
allowed[].map().firewall_rule().list():label=ALLOW,
denied[].map().firewall_rule().list():label=DENY,
sourceTags.list():label=SRC_TAGS,
sourceServiceAccounts.list():label=SRC_SVC_ACCT,
targetTags.list():label=TARGET_TAGS,
targetServiceAccounts.list():label=TARGET_SVC_ACCT,
disabled
)"

# List Hierarchical Firewalls
gcloud compute firewall-policies list  (--folder <value>| --organization <value>)
gcloud compute firewall-policies describe <fw_policy>
gcloud compute firewall-policies list-rules <fw_policy>

# Get Firewalls of each region
gcloud compute network-firewall-policies list
## Get final FWs applied in a region
gcloud compute network-firewall-policies get-effective-firewalls --network=<vpc_name> --region <region>
```
{% endcode %}

**Qapla'!** QaStaHvIS GCP vItlhutlhlaHbe'lu'chugh, compute instances vItlhutlhlaHbe'lu'chugh, vaj firewall rules vItlhutlhlaHbe'lu'chugh. [https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum](https://gitlab.com/gitlab-com/gl-security/security-operations/gl-redteam/gcp\_firewall\_enum) DaH jImej.

## Compute instances

**GCP vItlhutlhlaHbe'lu'chugh, virtual machines vItlhutlhlaHbe'lu'chugh.** Qapla'! QaStaHvIS vItlhutlhlaHbe'lu'chugh:

{% content-ref url="gcp-compute-instance.md" %}
[gcp-compute-instance.md](gcp-compute-instance.md)
{% endcontent-ref %}

### Enumeration
```bash
# Get list of zones
# It's interesting to know which zones are being used
gcloud compute regions list | grep -E "NAME|[^0]/"

# List compute instances & get info
gcloud compute instances list
gcloud compute instances describe <instance name>
gcloud compute instances get-iam-policy <instance> --zone=ZONE
gcloud compute instances get-screenshot <instance name> # Instace must have "Display Device" enabled
gcloud compute instances os-inventory list-instances # Get OS info of instances (OS Config agent is running on instances)


# Enumerate disks
gcloud compute disks list
gcloud compute disks describe <disk>
gcloud compute disks get-iam-policy <disk>
```
### Privilege Escalation

In the following page, you can check how to **abuse compute permissions to escalate privileges**:

{% content-ref url="../../gcp-privilege-escalation/gcp-compute-privesc/" %}
[gcp-compute-privesc](../../gcp-privilege-escalation/gcp-compute-privesc/)
{% endcontent-ref %}

### Unauthenticated Enum

{% content-ref url="../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md" %}
[gcp-compute-unauthenticated-enum.md](../../../gcp-security/gcp-unaunthenticated-enum-and-access/gcp-compute-unauthenticated-enum.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md" %}
[gcp-compute-post-exploitation.md](../../../gcp-security/gcp-post-exploitation/gcp-compute-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../../gcp-security/gcp-persistence/gcp-compute-persistence.md" %}
[gcp-compute-persistence.md](../../../gcp-security/gcp-persistence/gcp-compute-persistence.md)
{% endcontent-ref %}

## Serial Console Logs

Compute Engine Serial Console Logs are a feature that allows you to **view and diagnose the boot and operating system logs** of your virtual machine instances.

Serial Console Logs provide a **low-level view of the instance's boot process**, including kernel messages, init scripts, and other system events that occur during boot-up. This can be useful for debugging boot issues, identifying misconfigurations or software errors, or troubleshooting network connectivity problems.

These logs **may expose sensitive information** from the system logs which low privileged user may not usually see, but with the appropriate IAM permissions you may be able to read them.

You can use the following [gcloud command](https://cloud.google.com/sdk/gcloud/reference/compute/instances/get-serial-port-output) to query the serial port logs (the permission required is `compute.instances.getSerialPortOutput`):
```bash
gcloud compute instances get-serial-port-output <instance-name>
```
## OS Configuration Manager

**QaStaHvIS OS configuration management** service vItlhutlh, **deploy, query, and maintain consistent configurations** (desired state and software) for your VM instance (VM). Compute Engine Daq, [guest policies](https://cloud.google.com/compute/docs/os-config-management#guest-policy) vItlhutlh, VM Daq consistent software configurations vItlhutlh.

OS Configuration management feature vItlhutlh, configuration policies vItlhutlh, software packages vItlhutlh, services vItlhutlh, files or configurations vItlhutlh, VMmey. VMmey software configuration vItlhutlh, declarative approach vItlhutlh, configuration management process automate and scale vItlhutlh.

qaStaHvIS login vItlhutlh instances via IAM permissions, so it's very **useful for privesc and pivoting**.

{% hint style="warning" %}
**os-config enable** **project Daq instance Daq** **metadata** key **`enable-oslogin`** **`true`** set vItlhutlh.\
metadata **`enable-oslogin-2fa`** **`true`** set vItlhutlh 2fa enable vItlhutlh.

instance Daq crating enable vItlhutlh metadata keys automatically set vItlhutlh.
{% endhint %}

**2fa in OS-config** vItlhutlh, **user Daq apply only**, SA (like the compute SA) vItlhutlh, extra vItlhutlh.

### Enumeration
```bash
gcloud compute os-config patch-deployments list
gcloud compute os-config patch-deployments describe <patch-deployment>

gcloud compute os-config patch-jobs list
gcloud compute os-config patch-jobs describe <patch-job>
```
## Images

### Custom Images

**Custom compute images may contain sensitive details** or other vulnerable configurations that you can exploit.

When an image is created you can choose **3 types of encryption**: Using **Google managed key** (default), a **key from KMS**, or a **raw key** given by the client.

#### Enumeration

You can query the list of non-standard images in a project with the following command:

{% code overflow="wrap" %}
```bash
gcloud compute machine-images list
gcloud compute machine-images describe <name>
gcloud compute machine-images get-iam-policy <name>
```
{% endcode %}

**Qap** [**export**](https://cloud.google.com/sdk/gcloud/reference/compute/images/export) **the virtual disks** from any image in multiple formats. The following command would export the image `test-image` in qcow2 format, allowing you to download the file and build a VM locally for further investigation:

{% endcode %}
```bash
gcloud compute images export --image test-image \
--export-format qcow2 --destination-uri [BUCKET]

# Execute container inside a docker
docker run --rm -ti gcr.io/<project-name>/secret:v1 sh
```
#### Qa'leS

Qa'leS Compute Instances qa'leS 'ejwI' qaStaHvIS.

### Custom Instance Templates

[**'ejwI' template**](https://cloud.google.com/compute/docs/instance-templates/) **qaStaHvIS properties** 'e' vItlhutlh. vaj qaStaHvIS metadata custom qaStaHvIS qaStaHvIS. vaj vItlhutlh investigate commands vItlhutlh:
```bash
# List the available templates
gcloud compute instance-templates list

# Get the details of a specific template
gcloud compute instance-templates describe [TEMPLATE NAME]
```
**Snapshots**:
**Snapshots** are backups of disks. Note that this is not the same as cloning a disk (another available feature). The **snapshot** will use the **same encryption as the disk** it's taken from.

### Enumeration (Klingon translation):

**Snapshots**:
**Snapshots** vItlhutlh backups DISK. Qagh DISK cloning (available feature) vItlhutlh. **Snapshot** DISK encryption vItlhutlh.
```bash
gcloud compute snapshots list
gcloud compute snapshots describe <snapshot>
gcloud compute snapshots get-iam-policy <snapshot>
```
### Privilege Escalation

Qa' Compute Instances privilege escalation qutlh.

## References

* [https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching](https://blog.raphael.karger.is/articles/2022-08/GCP-OS-Patching)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>DaH jImej</strong></a><strong>!</strong></summary>

lo'laHbe'chugh HackTricks:

* qaStaHvIS **company advertised in HackTricks** be'nal **download HackTricks in PDF** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) qet!
* [**official PEASS & HackTricks swag**](https://peass.creator-spring.com) ghaH **Get**
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) jatlh [**NFTs**](https://opensea.io/collection/the-peass-family) **Discover**
* üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) be'nal [**telegram group**](https://t.me/peass) **Join** qet **follow** **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
