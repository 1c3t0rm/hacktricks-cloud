# GWS - Phishing en Plataformas de Google

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Metodología Genérica de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing en Google Groups

Al parecer, por defecto, en Workspace los miembros [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo electrónico que se enviará al usuario **añadiendo algunos enlaces**. El **correo electrónico vendrá de una dirección de Google**, por lo que parecerá **legítimo** y la gente podría hacer clic en el enlace.

También es posible configurar la dirección **FROM** como el **correo electrónico del grupo de Google** para enviar **más correos electrónicos a los usuarios dentro del grupo**, como en la siguiente imagen donde se creó el grupo **`google--support@googlegroups.com`** y se **envió un correo electrónico a todos los miembros** del grupo (que fueron añadidos sin ningún consentimiento)

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Phishing en Google Chat

Podrías ser capaz de **iniciar un chat** con una persona solo teniendo su dirección de correo electrónico o enviar una **invitación para hablar**. Además, es posible **crear un Espacio** que puede tener cualquier nombre (por ejemplo, "Soporte de Google") e **invitar** a miembros a él. Si aceptan, podrían pensar que están hablando con el Soporte de Google:

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Sin embargo, en mis pruebas, los miembros invitados ni siquiera recibieron una invitación.**
{% endhint %}

Puedes comprobar cómo funcionaba esto en el pasado en: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing en Google Docs

En el pasado era posible crear un **documento aparentemente legítimo** y luego en un comentario **mencionar algún correo electrónico (como @user@gmail.com)**. Google **enviaba un correo electrónico a esa dirección** notificando que fueron mencionados en el documento.\
Hoy en día, esto no funciona pero si **das acceso al documento al correo electrónico de la víctima**, Google enviará un correo electrónico indicándolo. Este es el mensaje que aparece cuando mencionas a alguien:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Las víctimas podrían tener mecanismos de protección que impidan que los correos electrónicos que indican que un documento externo fue compartido con ellos lleguen a su correo.
{% endhint %}

## Phishing en Google Calendar

Puedes **crear un evento en el calendario** y añadir tantas direcciones de correo electrónico de la empresa que estás atacando como tengas. Programa este evento en el calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca legítimo y **pon un comentario y un título indicando que necesitan leer algo** (con el **enlace de phishing**).

Esta es la alerta que aparecerá en el navegador con un título de reunión "Despidiendo a la Gente", por lo que podrías establecer un título más parecido al phishing (e incluso cambiar el nombre asociado con tu correo electrónico).

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Para que parezca menos sospechoso:

* Configúralo para que los **receptores no puedan ver a las otras personas invitadas**
* **NO envíes correos electrónicos notificando sobre el evento**. Entonces, la gente solo verá su advertencia sobre una reunión en 5 minutos y que necesitan leer ese enlace.
* Al parecer, usando la API puedes configurar en **Verdadero** que las **personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

## Phishing con Aplicaciones OAuth

Cualquiera de las técnicas anteriores podría usarse para hacer que el usuario acceda a una **aplicación OAuth de Google** que **solicitará** al usuario algún **acceso**. Si el usuario **confía** en la **fuente**, podría **confiar** en la **aplicación** (incluso si está pidiendo permisos de alto privilegio).

{% hint style="info" %}
Nota que Google presenta un aviso feo advirtiendo que la aplicación no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones OAuth.
{% endhint %}

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicación para **actuar en nombre de otros usuarios**, el desarrollador necesita crear una **aplicación OAuth dentro de GCP** e indicar los ámbitos (permisos) a los que la aplicación necesita acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicación**, se le **pedirá** que **acepte** que la aplicación tendrá acceso a sus datos especificados en los ámbitos.

Esta es una forma muy atractiva de **phishing** para usuarios no técnicos para usar **aplicaciones que acceden a información sensible** porque podrían no entender las consecuencias. Sin embargo, en cuentas de organizaciones, hay formas de prevenir que esto suceda.

### Aviso de Aplicación No Verificada

Como se mencionó, Google siempre presentará un **aviso al usuario para aceptar** los permisos que están dando a la aplicación en su nombre. Sin embargo, si la aplicación se considera **peligrosa**, Google mostrará **primero** un **aviso** indicando que es **peligrosa** y **haciendo más difícil** para el usuario otorgar los permisos a la aplicación.

Este aviso aparece en aplicaciones que:

* Usan cualquier ámbito que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (las aplicaciones > 100 también necesitan un proceso de revisión para dejar de mostrar el aviso de no verificada)

### Ámbitos Interesantes

[**Aquí**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los ámbitos OAuth de Google.

* **cloud-platform**: Ver y gestionar tus datos a través de los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **admin.directory.user.readonly**: Ver y descargar el directorio de GSuite de tu organización. Obtener nombres, teléfonos, URLs de calendario de todos los usuarios.

### Crear una Aplicación OAuth

**Comienza creando un ID de Cliente OAuth**

1. Ve a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) y haz clic en configurar la pantalla de consentimiento.
2. Luego, se te preguntará si el **tipo de usuario** es **interno** (solo para personas en tu organización) o **externo**. Selecciona el que se ajuste a tus necesidades.
* Interno podría ser interesante si ya has comprometido a un usuario de la organización y estás creando esta App para hacer phishing a otro.
3. Dale un **nombre** a la app, un **correo electrónico de soporte** (nota que puedes configurar un correo electrónico de googlegroup para intentar anonimizarte un poco más), un **logo**, **dominios autorizados** y otro **correo electrónico** para **actualizaciones**.
4. **Selecciona** los **ámbitos OAuth**.
* Esta página está dividida en permisos no sensibles, permisos sensibles y permisos restringidos. Cada vez que añades un nuevo permiso se añade en su categoría. Dependiendo de los permisos solicitados, aparecerán diferentes avisos al usuario indicando cuán sensibles son estos permisos.
* Tanto **`admin.directory.user.readonly`** como **`cloud-platform`** son permisos sensibles.
5. **Añade los usuarios de prueba.** Mientras el estado de la app sea de prueba, solo estos usuarios podrán acceder a la app, así que asegúrate de **añadir el correo electrónico al que vas a hacer phishing**.

Ahora obtengamos **credenciales para una aplicación web** usando el **ID de Cliente OAuth creado anteriormente**:

1. Vuelve a [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), esta vez aparecerá una opción diferente.
2. Selecciona para **crear credenciales para una aplicación web**
3. Configura los **orígenes de Javascript necesarios** y los **URI de redirección**
* Puedes configurar en ambos algo como **`http://localhost:8000/callback`** para pruebas
4. Obtén las **credenciales de tu aplicación**

Finalmente, ejecutemos **una aplicación web que usará las credenciales de la aplicación OAuth**. Puedes encontrar un ejemplo en [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Ve a **`http://localhost:8000`** y haz clic en el botón Iniciar sesión con Google, se te **mostrará** un mensaje como este:

<figure><img src="../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

La aplicación mostrará el **token de acceso y de actualización** que pueden ser utilizados fácilmente. Para más información sobre **cómo utilizar estos tokens consulta**:

{% content-ref url="../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Usando `gcloud`

Es posible hacer algo usando gcloud en lugar de la consola web, consulta:

{% content-ref url="../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, ¿Cómo hago Red Team en GSuite?

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
