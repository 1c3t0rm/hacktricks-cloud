# GWS - Phishing sur les plateformes Google

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## M√©thodologie G√©n√©rique de Phishing

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Phishing avec Google Groups

Apparemment, par d√©faut, dans Workspace les membres [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes**. Vous pouvez ensuite modifier l'email qui sera envoy√© √† l'utilisateur **en ajoutant des liens**. **L'email proviendra d'une adresse Google**, donc il semblera **l√©gitime** et les gens pourraient cliquer sur le lien.

Il est √©galement possible de d√©finir l'adresse **FROM** comme l'**email du groupe Google** pour envoyer **plus d'emails aux utilisateurs √† l'int√©rieur du groupe**, comme dans l'image suivante o√π le groupe **`google--support@googlegroups.com`** a √©t√© cr√©√© et un **email a √©t√© envoy√© √† tous les membres** du groupe (qui ont √©t√© ajout√©s sans aucun consentement)

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Phishing avec Google Chat

Vous pourriez √™tre capable de **d√©marrer une discussion** avec une personne en ayant simplement son adresse email ou d'envoyer une **invitation √† discuter**. De plus, il est possible de **cr√©er un Espace** qui peut avoir n'importe quel nom (par exemple, "Support Google") et **inviter** des membres. S'ils acceptent, ils pourraient penser qu'ils parlent au Support Google :

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**Cependant, lors de mes tests, les membres invit√©s n'ont m√™me pas re√ßu d'invitation.**
{% endhint %}

Vous pouvez v√©rifier comment cela fonctionnait dans le pass√© sur : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Phishing avec Google Doc

Dans le pass√©, il √©tait possible de cr√©er un **document apparemment l√©gitime** et dans un commentaire **mentionner un email (comme @user@gmail.com)**. Google **envoyait un email √† cette adresse email** pour notifier qu'elle avait √©t√© mentionn√©e dans le document.\
Aujourd'hui, cela ne fonctionne plus, mais si vous **donnez √† l'email de la victime l'acc√®s au document**, Google enverra un email l'indiquant. Voici le message qui appara√Æt lorsque vous mentionnez quelqu'un :

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
Les victimes peuvent avoir des m√©canismes de protection qui emp√™chent les emails indiquant qu'un document externe a √©t√© partag√© avec eux d'atteindre leur bo√Æte de r√©ception.
{% endhint %}

## Phishing avec Google Calendar

Vous pouvez **cr√©er un √©v√©nement dans le calendrier** et ajouter autant d'adresses email de l'entreprise que vous attaquez que vous en avez. Planifiez cet √©v√©nement dans le calendrier pour **5 ou 15 min** √† partir de l'heure actuelle. Rendez l'√©v√©nement l√©gitime et **mettez un commentaire et un titre indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).

Voici l'alerte qui appara√Ætra dans le navigateur avec un titre de r√©union "Licenciement de personnes", donc vous pourriez mettre un titre plus enclin au phishing (et m√™me changer le nom associ√© √† votre email).

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Pour le rendre moins suspect :

* Configurez-le de sorte que **les destinataires ne puissent pas voir les autres personnes invit√©es**
* Ne **PAS envoyer d'emails notifiant de l'√©v√©nement**. Ainsi, les gens verront seulement leur avertissement concernant une r√©union dans 5 minutes et qu'ils doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir sur **Vrai** que **les personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er **des commentaires en leur nom**.

## Phishing avec les applications OAuth

N'importe laquelle des techniques pr√©c√©dentes pourrait √™tre utilis√©e pour amener l'utilisateur √† acc√©der √† une **application Google OAuth** qui **demandera** √† l'utilisateur un **acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il pourrait **faire confiance** √† l'**application** (m√™me si elle demande des permissions hautement privil√©gi√©es).

{% hint style="info" %}
Notez que Google pr√©sente une invite d√©sagr√©able avertissant que l'application n'est pas fiable dans plusieurs cas et les administrateurs de Workspace peuvent m√™me emp√™cher les gens d'accepter des applications OAuth.
{% endhint %}

**Google** permet de cr√©er des applications qui peuvent **interagir au nom des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir au nom d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les √©tendues (permissions) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** souhaite **utiliser** cette **application**, il sera **invit√©** √† **accepter** que l'application ait acc√®s √† ses donn√©es sp√©cifi√©es dans les √©tendues.

C'est une mani√®re tr√®s attrayante de **phisher** des utilisateurs non techniques en les utilisant **des applications qui acc√®dent √† des informations sensibles** car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes d'organisations, il existe des moyens d'emp√™cher cela.

### Invite d'application non v√©rifi√©e

Comme mentionn√©, Google pr√©sentera toujours une **invite √† l'utilisateur pour accepter** les permissions qu'ils donnent √† l'application en leur nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google montrera **d'abord** une **invite** indiquant qu'elle est **dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les permissions √† l'application.

Cette invite appara√Æt dans les applications qui :

* Utilisent une √©tendue qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (les applications > 100 n√©cessitent √©galement un processus de r√©vision pour arr√™ter d'afficher l'invite non v√©rifi√©e)

### √âtendues Int√©ressantes

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes) vous pouvez trouver une liste de toutes les √©tendues OAuth de Google.

* **cloud-platform** : Voir et g√©rer vos donn√©es √† travers les services **Google Cloud Platform**. Vous pouvez vous faire passer pour l'utilisateur dans GCP.
* **admin.directory.user.readonly** : Voir et t√©l√©charger l'annuaire GSuite de votre organisation. Obtenir les noms, t√©l√©phones, URLs de calendrier de tous les utilisateurs.

### Cr√©er une application OAuth

**Commencez par cr√©er un ID client OAuth**

1. Allez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient) et cliquez sur configurer l'√©cran de consentement.
2. Ensuite, on vous demandera si le **type d'utilisateur** est **interne** (seulement pour les personnes de votre org) ou **externe**. S√©lectionnez celui qui convient √† vos besoins
* Interne pourrait √™tre int√©ressant si vous avez d√©j√† compromis un utilisateur de l'organisation et que vous cr√©ez cette application pour phisher un autre.
3. Donnez un **nom** √† l'application, un **email de support** (notez que vous pouvez d√©finir un email de googlegroup pour essayer de vous anonymiser un peu plus), un **logo**, des **domaines autoris√©s** et un autre **email** pour les **mises √† jour**.
4. **S√©lectionnez** les **√©tendues OAuth**.
* Cette page est divis√©e en permissions non sensibles, permissions sensibles et permissions restreintes. Chaque fois que vous ajoutez une nouvelle permission, elle est ajout√©e dans sa cat√©gorie. Selon les permissions demand√©es, diff√©rentes invites appara√Ætront √† l'utilisateur indiquant la sensibilit√© de ces permissions.
* Les permissions **`admin.directory.user.readonly`** et **`cloud-platform`** sont sensibles.
5. **Ajoutez les utilisateurs de test.** Tant que le statut de l'application est en test, seuls ces utilisateurs pourront acc√©der √† l'application, alors assurez-vous d'**ajouter l'email que vous allez phisher**.

Maintenant, obtenons les **identifiants pour une application web** en utilisant l'**ID client OAuth pr√©c√©demment cr√©√©** :

1. Revenez sur [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient), une option diff√©rente appara√Ætra cette fois.
2. S√©lectionnez pour **cr√©er des identifiants pour une application Web**
3. D√©finissez les **origines Javascript n√©cessaires** et les **URI de redirection**
* Vous pouvez d√©finir dans les deux quelque chose comme **`http://localhost:8000/callback`** pour les tests
4. Obtenez vos **identifiants d'application**

Enfin, ex√©cutons **une application web qui utilisera les identifiants de l'application OAuth**. Vous pouvez trouver un exemple sur [https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example).
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
Rendez-vous sur **`http://localhost:8000`** et cliquez sur le bouton Se connecter avec Google, un message comme celui-ci s'affichera :

<figure><img src="../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

L'application affichera **le token d'acc√®s et le token de rafra√Æchissement** qui peuvent √™tre facilement utilis√©s. Pour plus d'informations sur **comment utiliser ces tokens, consultez** :

{% content-ref url="../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### Utilisation de `gcloud`

Il est possible de faire quelque chose en utilisant gcloud au lieu de la console web, consultez :

{% content-ref url="../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch et Beau Bullock - OK Google, Comment faire du Red Team sur GSuite ?

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
