# GWS - Google Platforms Phishing

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Generic Phishing Methodology

{% embed url="https://book.hacktricks.xyz/generic-methodologies-and-resources/phishing-methodology" %}

## Google Groups Phishing

デフォルトでは、workspaceのメンバーは[**グループを作成**](https://groups.google.com/all-groups)し、**人々を招待することができます**。その後、ユーザーに送信されるメールに**リンクを追加することができます**。**メールはGoogleのアドレスから送信される**ため、正当に見え、人々はリンクをクリックする可能性があります。

また、**FROM**アドレスを**Googleグループのメール**として設定し、グループ内のユーザーに**さらにメールを送信する**ことも可能です。以下の画像では、グループ**`google--support@googlegroups.com`**が作成され、グループのメンバー全員に（同意なしに追加された）**メールが送信されました**。

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

## Google Chat Phishing

メールアドレスを知っているだけで**チャットを開始**するか、**トークへの招待**を送ることができるかもしれません。さらに、任意の名前（例："Googleサポート"）を持つ**スペースを作成**し、メンバーを招待することができます。彼らが受け入れた場合、Googleサポートと話していると思うかもしれません：

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
**ただし、私のテストでは招待されたメンバーは招待を受け取っていませんでした。**
{% endhint %}

過去にどのように機能していたかは、こちらをチェックしてください：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

## Google Doc Phishing

過去には、**一見正当なドキュメント**を作成し、コメントで**メールアドレス（例：@user@gmail.com）**を**言及**することができました。Googleはそのメールアドレスにメールを送信し、ドキュメントで言及されたことを通知しました。\
現在では、これは機能しませんが、**被害者のメールにドキュメントへのアクセスを与える**と、Googleはそのようなメールを送信します。これは、誰かを言及したときに表示されるメッセージです：

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

{% hint style="success" %}
被害者には、外部ドキュメントが共有されたことを示すメールがメールに届かないようにする保護メカニズムがあるかもしれません。
{% endhint %}

## Google Calendar Phishing

**カレンダーイベントを作成**し、攻撃している会社のできるだけ多くのメールアドレスを追加します。このカレンダーイベントを現在時刻から**5分または15分後**にスケジュールします。イベントを正当に見せ、**何かを読む必要があることを示すコメントとタイトルを入れます**（**フィッシングリンク**付き）。

これは、会議のタイトルが「Firing People」というブラウザに表示されるアラートです。したがって、よりフィッシングのようなタイトルを設定し、メールに関連付けられた名前を変更することもできます。

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

怪しまれないようにするために：

* 受信者が他の招待された人を見ることができないように設定します
* イベントに関するメール通知を**送信しない**。そうすると、人々は5分後の会議に関する警告と、そのリンクを読む必要があることだけを見るでしょう。
* APIを使用すると、人々がイベントを**受け入れた**と**True**に設定し、さらに彼らに代わって**コメントを作成する**ことが可能です。

## OAuth Apps Phishing

上記のいずれかの手法を使用して、ユーザーが**Google OAuthアプリケーション**にアクセスし、ユーザーにいくつかの**アクセスを要求する**ことができます。ユーザーが**ソースを信頼している**場合、彼らは**アプリケーションを信頼する**かもしれません（たとえそれが高い権限を要求していても）。

{% hint style="info" %}
Googleは、アプリケーションが信頼されていないと警告する醜いプロンプトをいくつかのケースで表示し、Workspaceの管理者はOAuthアプリケーションを受け入れることを人々が防ぐことさえできることに注意してください。
{% endhint %}

**Google**は、開発者が**GCP**内で**OAuthアプリを作成**し、アプリがユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要がある、ユーザーに代わっていくつかの**Googleサービス**と**対話する**アプリケーションを作成することを許可しています。\
**ユーザー**がその**アプリケーションを使用**したい場合、彼らはスコープで指定されたデータへのアクセスをアプリケーションに許可するよう**促されます**。

これは、非技術的なユーザーを**機密情報にアクセスするアプリケーションの使用に騙す**非常に魅力的な方法です。なぜなら、彼らは結果を理解していないかもしれないからです。ただし、組織のアカウントでは、これが起こらないようにする方法があります。

### Unverified App prompt

言及されたように、googleは常にユーザーにアプリケーションに代わって与える権限を受け入れるよう**プロンプトを表示します**。しかし、アプリケーションが**危険と見なされる**場合、googleは**最初に**、それが**危険である**ことを示す**プロンプト**を表示し、ユーザーがアプリに権限を付与することを**より困難にします**。

このプロンプトは以下のアプリで表示されます：

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQuery...）
* 100ユーザー未満のアプリ（100ユーザーを超えるアプリには、未検証のプロンプトを表示しないようにするためのレビュープロセスも必要です）

### Interesting Scopes

[**ここ**](https://developers.google.com/identity/protocols/oauth2/scopes)で、すべてのGoogle OAuthスコープのリストを見つけることができます。

* **cloud-platform**: **Google Cloud Platform**サービス全体でデータを表示および管理します。GCPでユーザーになりすますことができます。
* **admin.directory.user.readonly**: 組織のGSuiteディレクトリを表示およびダウンロードします。すべてのユーザーの名前、電話、カレンダーURLを取得します。

### Create an OAuth App

**OAuthクライアントIDの作成を開始します**

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)にアクセスし、同意画面の設定をクリックします。
2. 次に、**ユーザータイプ**が**内部**（組織内の人々のみ）か**外部**かを尋ねられます。ニーズに合ったものを選択します
* すでに組織のユーザーを侵害しており、このアプリを別のユーザーをフィッシングするために作成している場合、内部は興味深いかもしれません。
3. アプリに**名前**を付け、**サポートメール**（googlegroupのメールを設定して自分を少し匿名化することができます）、**ロゴ**、**承認されたドメイン**、および**アップデート用の別のメール**を設定します。
4. **OAuthスコープを選択**します。
* このページは、非感染性の権限、感染性の権限、および制限された権限に分かれています。新しい許可を追加するたびに、それはそのカテゴリに追加されます。要求された許可に応じて、ユーザーにこれらの許可がどれほど敏感であるかを示す異なるプロンプトが表示されます。
* **`admin.directory.user.readonly`**と**`cloud-platform`**は、敏感な権限です。
5. **テストユーザーを追加します。**アプリのステータスがテスト中である限り、これらのユーザーのみがアプリにアクセスできるので、**フィッシングするメールを追加する**ことを確認してください。

次に、**以前に作成したOAuthクライアントIDを使用してWebアプリケーションの資格情報を取得しましょう**：

1. [https://console.cloud.google.com/apis/credentials/oauthclient](https://console.cloud.google.com/apis/credentials/oauthclient)に戻ります。今回は異なるオプションが表示されます。
2. **Webアプリケーションの資格情報を作成する**を選択します
3. 必要な**Javascriptの起源**と**リダイレクトURI**を設定します
* テスト用に**`http://localhost:8000/callback`**のようなものを両方に設定できます
4. アプリケーションの**資格情報を取得**します

最後に、**OAuthアプリケーションの資格情報を使用するWebアプリケーションを実行しましょう**。例は[https://github.com/carlospolop/gcp\_oauth\_phishing\_example](https://github.com/carlospolop/gcp\_oauth\_phishing\_example)で見つけることができます。
```bash
git clone ttps://github.com/carlospolop/gcp_oauth_phishing_example
cd gcp_oauth_phishing_example
pip install flask requests google-auth-oauthlib
python3 app.py --client-id "<client_id>" --client-secret "<client_secret>"
```
**`http://localhost:8000`** にアクセスし、Googleでログインするボタンをクリックすると、このようなメッセージが**表示されます**：

<figure><img src="../../.gitbook/assets/image (144).png" alt=""><figcaption></figcaption></figure>

アプリケーションは**アクセスとリフレッシュトークン**を表示し、これらは簡単に使用できます。これらのトークンの**使用方法についての詳細は**：

{% content-ref url="../gcp-security/gcp-persistence/gcp-non-svc-persistance.md" %}
[gcp-non-svc-persistance.md](../gcp-security/gcp-persistence/gcp-non-svc-persistance.md)
{% endcontent-ref %}

#### `glcoud`を使用する

gcloudを使用してWebコンソールの代わりに何かを行うことが可能です。詳細は：

{% content-ref url="../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md" %}
[gcp-clientauthconfig-privesc.md](../gcp-security/gcp-privilege-escalation/gcp-clientauthconfig-privesc.md)
{% endcontent-ref %}

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - G Suiteのハッキング：ダークApps Script Magicの力
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, GSuiteのレッドチームはどうやって？

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
