# AWS - VPC & Informations de base sur le r√©seau

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux** d√©p√¥ts github [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## R√©seau AWS en un clin d'≈ìil

Un **VPC** contient un **CIDR r√©seau** comme 10.0.0.0/16 (avec sa **table de routage** et son **ACL r√©seau**).

Ce r√©seau VPC est divis√© en **sous-r√©seaux**, donc un **sous-r√©seau** est directement **li√©** au **VPC**, √† la **table de routage** et √† l'**ACL r√©seau**.

Ensuite, les **interfaces r√©seau** attach√©es aux services (comme les instances EC2) sont **connect√©es** aux **sous-r√©seaux** avec **groupe(s) de s√©curit√©**.

Par cons√©quent, un **groupe de s√©curit√©** limitera les ports expos√©s des interfaces r√©seau **l'utilisant**, **ind√©pendamment du sous-r√©seau**. Et une **ACL r√©seau** limitera les ports expos√©s √† **l'ensemble du r√©seau**.

De plus, pour **acc√©der √† Internet**, il y a quelques configurations int√©ressantes √† v√©rifier :

* Un **sous-r√©seau** peut **attribuer automatiquement des adresses IPv4 publiques**
* Une **instance** cr√©√©e dans le r√©seau qui **attribue automatiquement des adresses IPv4 peut en obtenir une**
* Une **passerelle Internet** doit √™tre **attach√©e** au **VPC**
* Vous pourriez √©galement utiliser des **passerelles Internet sortantes uniquement**
* Vous pourriez √©galement avoir une **passerelle NAT** dans un **sous-r√©seau priv√©** afin qu'il soit possible de **se connecter √† des services externes** depuis ce sous-r√©seau priv√©, mais il est **impossible d'y acc√©der de l'ext√©rieur**.
* La passerelle NAT peut √™tre **publique** (acc√®s √† Internet) ou **priv√©e** (acc√®s √† d'autres VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) vous permet de **lancer des ressources AWS dans un r√©seau virtuel** que vous avez d√©fini. Ce r√©seau virtuel aura plusieurs sous-r√©seaux, des passerelles Internet pour acc√©der √† Internet, des ACL, des groupes de s√©curit√©, des IPs...

### Sous-r√©seaux

Les sous-r√©seaux aident √† renforcer un niveau de s√©curit√© plus √©lev√©. Le **regroupement logique de ressources similaires** aide √©galement √† maintenir une **facilit√© de gestion** √† travers votre infrastructure.

* Les CIDR valides vont d'un masque de r√©seau /16 √† un /28.
* Un sous-r√©seau ne peut pas √™tre dans diff√©rentes zones de disponibilit√© en m√™me temps.
* **AWS r√©serve les trois premi√®res adresses IP h√¥tes** de chaque sous-r√©seau **pour** **l'utilisation interne d'AWS** : la premi√®re adresse h√¥te utilis√©e est pour le routeur VPC. La deuxi√®me adresse est r√©serv√©e pour le DNS AWS et la troisi√®me adresse est r√©serv√©e pour une utilisation future.
* On appelle **sous-r√©seaux publics** ceux qui ont **un acc√®s direct √† Internet, contrairement aux sous-r√©seaux priv√©s**.

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tables de routage

Les tables de routage d√©terminent le routage du trafic pour un sous-r√©seau au sein d'un VPC. Elles d√©terminent quel trafic r√©seau est transmis √† Internet ou √† une connexion VPN. Vous trouverez g√©n√©ralement l'acc√®s √† :

* Le VPC local
* NAT
* Passerelles Internet / Passerelles Internet sortantes uniquement (n√©cessaires pour donner un acc√®s √† Internet √† un VPC).
* Afin de rendre un sous-r√©seau public, vous devez **cr√©er** et **attacher** une **passerelle Internet** √† votre VPC.
* Points de terminaison VPC (pour acc√©der √† S3 depuis des r√©seaux priv√©s)

Dans les images suivantes, vous pouvez v√©rifier les diff√©rences dans un r√©seau public par d√©faut et un r√©seau priv√© :

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listes de contr√¥le d'acc√®s r√©seau (ACLs)** : Les ACLs r√©seau sont des r√®gles de pare-feu qui contr√¥lent le trafic r√©seau entrant et sortant vers un sous-r√©seau. Elles peuvent √™tre utilis√©es pour autoriser ou refuser le trafic vers des adresses IP sp√©cifiques ou des plages.

* Il est plus fr√©quent d'autoriser/refuser l'acc√®s en utilisant des groupes de s√©curit√©, mais c'est le seul moyen de couper compl√®tement les shells invers√©s √©tablis. Une r√®gle modifi√©e dans un groupe de s√©curit√© n'arr√™te pas les connexions d√©j√† √©tablies
* Cependant, cela s'applique √† l'ensemble du sous-r√©seau, soyez prudent lorsque vous interdisez des choses car des fonctionnalit√©s n√©cessaires pourraient √™tre perturb√©es

### Groupes de s√©curit√©

Les groupes de s√©curit√© sont un **pare-feu virtuel** qui contr√¥le le trafic r√©seau entrant et sortant vers les instances dans un VPC. Relation 1 SG √† M instances (g√©n√©ralement 1 √† 1).\
G√©n√©ralement, cela est utilis√© pour ouvrir des ports dangereux dans les instances, comme le port 22 par exemple :

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Adresses IP √©lastiques

Une _adresse IP √©lastique_ est une **adresse IPv4 statique** con√ßue pour le cloud computing dynamique. Une adresse IP √©lastique est allou√©e √† votre compte AWS, et est √† vous jusqu'√† ce que vous la lib√©riez. En utilisant une adresse IP √©lastique, vous pouvez masquer la d√©faillance d'une instance ou d'un logiciel en remappant rapidement l'adresse √† une autre instance de votre compte.

### Connexion entre sous-r√©seaux

Par d√©faut, tous les sous-r√©seaux ont **l'attribution automatique d'adresses IP publiques d√©sactiv√©e** mais cela peut √™tre activ√©.

**Une route locale dans une table de routage permet la communication entre les sous-r√©seaux d'un VPC.**

Si vous **connectez un sous-r√©seau √† un sous-r√©seau diff√©rent, vous ne pouvez pas acc√©der aux sous-r√©seaux connect√©s** avec l'autre sous-r√©seau, vous devez cr√©er une connexion avec eux directement. **Cela s'applique √©galement aux passerelles Internet**. Vous ne pouvez pas passer par une connexion de sous-r√©seau pour acc√©der √† Internet, vous devez attribuer la passerelle Internet √† votre sous-r√©seau.

### Appariement VPC

L'appariement VPC vous permet de **connecter deux VPC ou plus ensemble**, en utilisant IPV4 ou IPV6, comme s'ils faisaient partie du m√™me r√©seau.

Une fois la connectivit√© par paire √©tablie, **les ressources d'un VPC peuvent acc√©der aux ressources de l'autre**. La connectivit√© entre les VPC est mise en ≈ìuvre via l'infrastructure r√©seau AWS existante, et est donc hautement disponible sans goulot d'√©tranglement de bande passante. Comme **les connexions par paire fonctionnent comme si elles faisaient partie du m√™me r√©seau**, il y a des restrictions en ce qui concerne vos plages de blocs CIDR qui peuvent √™tre utilis√©es.\
Si vous avez des plages CIDR **chevauchantes ou dupliqu√©es** pour vos VPC, alors **vous ne pourrez pas appairer les VPC** ensemble.\
Chaque VPC AWS ne communiquera **qu'avec son pair**. Par exemple, si vous avez une connexion par paire entre le VPC 1 et le VPC 2, et une autre connexion entre le VPC 2 et le VPC 3 comme illustr√©, alors le VPC 1 et le VPC 2 pourraient communiquer directement entre eux, tout comme le VPC 2 et le VPC 3, cependant, le VPC 1 et le VPC 3 ne pourraient pas. **Vous ne pouvez pas router √† travers un VPC pour en atteindre un autre.**

### **Journalisation du flux VPC**

Au sein de votre VPC, vous pourriez potentiellement avoir des centaines voire des milliers de ressources toutes en communication entre diff√©rents sous-r√©seaux publics et priv√©s et √©galement entre diff√©rents VPC via des connexions d'appariement VPC. **Les journaux de flux VPC vous permettent de capturer des informations sur le trafic IP qui circule entre vos interfaces r√©seau de vos ressources au sein de votre VPC**.

Contrairement aux journaux d'acc√®s S3 et CloudFront, les **donn√©es de journal g√©n√©r√©es par les journaux de flux VPC ne sont pas stock√©es dans S3. Au lieu de cela, les donn√©es de journal captur√©es sont envoy√©es aux journaux CloudWatch**.

Limitations :

* Si vous ex√©cutez une connexion d'appariement VPC, alors vous ne pourrez voir que les journaux de flux des VPC appair√©s qui sont dans le m√™me compte.
* Si vous ex√©cutez toujours des ressources dans l'environnement EC2-Classic, alors malheureusement vous ne pourrez pas r√©cup√©rer d'informations de leurs interfaces
* Une fois qu'un journal de flux VPC a √©t√© cr√©√©, il ne peut pas √™tre modifi√©. Pour modifier la configuration du journal de flux VPC, vous devez le supprimer puis en recr√©er un nouveau.
* Le trafic suivant n'est pas surveill√© et captur√© par les journaux. Le trafic DHCP au sein du VPC, le trafic des instances destin√© au serveur DNS Amazon.
* Tout trafic destin√© √† l'adresse IP du routeur par d√©faut du VPC et le trafic vers et depuis les adresses suivantes, 169.254.169.254 qui est utilis√© pour collecter les m√©tadonn√©es de l'instance, et 169.254.169.123 qui est utilis√© pour le service de synchronisation de l'heure Amazon.
* Le trafic relatif √† une licence d'activation Windows Amazon d'une instance Windows
* Le trafic entre une interface de r√©partiteur de charge r√©seau et une interface r√©seau de point de terminaison

Pour chaque interface r√©seau qui publie des donn√©es dans le groupe de journaux CloudWatch, elle utilisera un flux de journaux diff√©rent. Et dans chacun de ces flux, il y aura les donn√©es d'√©v√©nements de journal de flux qui montrent le contenu des entr√©es de journal. Chacun de ces **journaux capture des donn√©es pendant une fen√™tre d'environ 10 √† 15 minutes**.

## VPN

### Composants de base du VPN AWS

1. **Passerelle client** :
* Une passerelle client est une ressource que vous cr√©ez dans AWS pour repr√©senter votre c√¥t√© d'une connexion VPN.
* C'est essentiellement un appareil physique ou une application logicielle de votre c√¥t√© de la connexion VPN Site-√†-Site.
* Vous fournissez des informations de routage et l'adresse IP publique de votre appareil r√©seau (comme un routeur ou un pare-feu) √† AWS pour cr√©er une passerelle client.
* Elle sert de point de r√©f√©rence pour configurer la connexion VPN et n'entra√Æne pas de frais suppl√©mentaires.
2. **Passerelle priv√©e virtuelle** :
* Une passerelle priv√©e virtuelle (VPG) est le concentrateur VPN du c√¥t√© Amazon de la connexion VPN Site-√†-Site.
* Elle est attach√©e √† votre VPC et sert de cible pour votre connexion VPN.
* VPG est le point de terminaison c√¥t√© AWS pour la connexion VPN.
* Elle g√®re la communication s√©curis√©e entre votre VPC et votre r√©seau sur site.
3. **Connexion VPN Site-√†-Site** :
* Une connexion VPN Site-√†-Site connecte votre r√©seau sur site √† un VPC via un tunnel VPN s√©curis√© IPsec.
* Ce type de connexion n√©cessite une passerelle client et une passerelle priv√©e virtuelle.
* Elle est utilis√©e pour une communication s√©curis√©e, stable et coh√©rente entre votre centre de donn√©es ou r√©seau et votre environnement AWS.
* Typiquement utilis√©e pour des connexions r√©guli√®res et √† long terme et est factur√©e en fonction de la quantit√© de donn√©es transf√©r√©es sur la connexion.
4. **Point de terminaison VPN client** :
* Un point de terminaison VPN client est une ressource que vous cr√©ez dans AWS pour activer et g√©rer les sessions VPN client.
* Il est utilis√© pour permettre √† des appareils individuels (comme des ordinateurs portables, des smartphones, etc.) de se connecter en toute s√©curit√© aux ressources AWS ou √† votre r√©seau sur site.
* Il diff√®re du VPN Site-√†-Site en ce qu'il est con√ßu pour des clients individuels plut√¥t que pour connecter des r√©seaux entiers.
* Avec le VPN client, chaque appareil client utilise un logiciel client VPN pour √©tablir une connexion s√©curis√©e.

### VPN Site-√†-Site

**Connectez votre r√©seau sur site √† votre VPC.**

* **Connexion VPN** : Une connexion s√©curis√©e entre votre √©quipement sur site et vos VPCs.
*   **Tunnel VPN** : Un lien crypt√© o√π les donn√©es peuvent passer du r√©seau client √† AWS ou inversement.

Chaque connexion VPN comprend deux tunnels VPN que vous pouvez utiliser simultan√©ment pour une haute disponibilit√©.
* **Passerelle client** : Une ressource AWS qui fournit des informations √† AWS sur votre appareil de passerelle client.
* **Appareil de passerelle client** : Un appareil physique ou une application
