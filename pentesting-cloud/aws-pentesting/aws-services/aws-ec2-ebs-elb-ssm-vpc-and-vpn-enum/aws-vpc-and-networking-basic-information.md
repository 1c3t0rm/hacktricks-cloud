# AWS - Informaci칩n B치sica de VPC y Redes

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de HackTricks para AWS)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Redes en AWS en Resumen

Un **VPC** contiene un **CIDR de red** como 10.0.0.0/16 (con su **tabla de enrutamiento** y **ACL de red**).

Esta red VPC se divide en **subredes**, por lo que una **subred** est치 directamente **relacionada** con el **VPC**, la **tabla de enrutamiento** y el **ACL de red**.

Luego, las **Interfaces de Red** conectadas a servicios (como instancias EC2) est치n **conectadas** a las **subredes** con **grupo(s) de seguridad**.

Por lo tanto, un **grupo de seguridad** limitar치 los puertos expuestos de las interfaces de red **que lo usan**, **independientemente de la subred**. Y un **ACL de red** limitar치 los puertos expuestos a **toda la red**.

Adem치s, para **acceder a Internet**, hay algunas configuraciones interesantes para verificar:

* Una **subred** puede **asignar autom치ticamente direcciones IPv4 p칰blicas**
* Una **instancia** creada en la red que **asigna autom치ticamente direcciones IPv4 puede obtener una**
* Se necesita **adjuntar una puerta de enlace a Internet** al **VPC**
* Tambi칠n podr칤as usar **puertas de enlace a Internet solo de salida**
* Tambi칠n podr칤as tener una **puerta de enlace NAT** en una **subred privada** para que sea posible **conectarse a servicios externos** desde esa subred privada, pero **no es posible llegar a ellos desde el exterior**.
* La puerta de enlace NAT puede ser **p칰blica** (acceso a internet) o **privada** (acceso a otros VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) te permite **lanzar recursos de AWS en una red virtual** que has definido. Esta red virtual tendr치 varias subredes, puertas de enlace a Internet, ACLs, grupos de seguridad, IPs...

### Subredes

Las subredes ayudan a imponer un mayor nivel de seguridad. El **agrupamiento l칩gico de recursos similares** tambi칠n te ayuda a mantener una **facilidad de gesti칩n** en tu infraestructura.

* Los CIDR v치lidos van desde una m치scara de red /16 hasta una /28.
* Una subred no puede estar en diferentes zonas de disponibilidad al mismo tiempo.
* **AWS reserva las tres primeras direcciones IP de host** de cada subred **para** **uso interno de AWS**: la primera direcci칩n de host utilizada es para el enrutador VPC. La segunda direcci칩n est치 reservada para AWS DNS y la tercera direcci칩n est치 reservada para uso futuro.
* Se llama **subredes p칰blicas** a aquellas que tienen **acceso directo a Internet, mientras que las subredes privadas no.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tablas de Rutas

Las tablas de rutas determinan el enrutamiento del tr치fico para una subred dentro de un VPC. Determinan qu칠 tr치fico de red se env칤a a Internet o a una conexi칩n VPN. Normalmente encontrar치s acceso a:

* VPC local
* NAT
* Puertas de enlace a Internet / puertas de enlace a Internet solo de salida (necesarias para dar acceso a Internet a un VPC).
* Para hacer una subred p칰blica necesitas **crear** y **adjuntar** una **puerta de enlace a Internet** a tu VPC.
* Puntos finales de VPC (para acceder a S3 desde redes privadas)

En las siguientes im치genes puedes ver las diferencias en una red p칰blica predeterminada y una privada:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Listas de Control de Acceso a la Red (ACLs)**: Las ACLs de red son reglas de firewall que controlan el tr치fico de red entrante y saliente a una subred. Se pueden usar para permitir o denegar el tr치fico a direcciones IP espec칤ficas o rangos.

* Es m치s frecuente permitir/denegar el acceso usando grupos de seguridad, pero esta es la 칰nica forma de cortar completamente shells reversas establecidas. Una regla modificada en un grupo de seguridad no detiene las conexiones ya establecidas
* Sin embargo, esto se aplica a toda la subred, ten cuidado al prohibir cosas porque la funcionalidad necesaria podr칤a verse afectada

### Grupos de Seguridad

Los grupos de seguridad son un **firewall virtual** que controla el tr치fico de red entrante y saliente a instancias en un VPC. Relaci칩n 1 SG a M instancias (generalmente 1 a 1).\
Normalmente esto se usa para abrir puertos peligrosos en instancias, como el puerto 22 por ejemplo:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Direcciones IP El치sticas

Una _Direcci칩n IP El치stica_ es una **direcci칩n IPv4 est치tica** dise침ada para la computaci칩n en la nube din치mica. Una direcci칩n IP el치stica se asigna a tu cuenta de AWS y es tuya hasta que la liberes. Al usar una direcci칩n IP el치stica, puedes enmascarar el fallo de una instancia o software reasignando r치pidamente la direcci칩n a otra instancia en tu cuenta.

### Conexi칩n entre subredes

Por defecto, todas las subredes tienen la **asignaci칩n autom치tica de direcciones IP p칰blicas desactivada** pero se puede activar.

**Una ruta local dentro de una tabla de rutas permite la comunicaci칩n entre subredes de VPC.**

Si est치s **conectando una subred con una subred diferente no puedes acceder a las subredes conectadas** con la otra subred, necesitas crear conexi칩n con ellas directamente. **Esto tambi칠n se aplica a las puertas de enlace a Internet**. No puedes pasar por una conexi칩n de subred para acceder a Internet, necesitas asignar la puerta de enlace a Internet a tu subred.

### Emparejamiento de VPC

El emparejamiento de VPC te permite **conectar dos o m치s VPCs juntas**, usando IPV4 o IPV6, como si fueran parte de la misma red.

Una vez que se establece la conectividad entre pares, **los recursos en un VPC pueden acceder a recursos en el otro**. La conectividad entre los VPCs se implementa a trav칠s de la infraestructura de red existente de AWS, y por lo tanto es altamente disponible sin cuellos de botella de ancho de banda. Como las **conexiones entre pares operan como si fueran parte de la misma red**, hay restricciones en cuanto a los rangos de bloques CIDR que se pueden usar.\
Si tienes **rangos CIDR superpuestos o duplicados** para tus VPC, entonces **no podr치s emparejar los VPCs** juntos.\
Cada VPC de AWS **solo se comunicar치 con su par**. Como ejemplo, si tienes una conexi칩n de emparejamiento entre VPC 1 y VPC 2, y otra conexi칩n entre VPC 2 y VPC 3 como se muestra, entonces VPC 1 y 2 podr칤an comunicarse entre s칤 directamente, al igual que VPC 2 y VPC 3, sin embargo, VPC 1 y VPC 3 no podr칤an. **No puedes enrutar a trav칠s de un VPC para llegar a otro.**

### **Registros de Flujo de VPC**

Dentro de tu VPC, podr칤as tener potencialmente cientos o incluso miles de recursos todos comunic치ndose entre diferentes subredes tanto p칰blicas como privadas y tambi칠n entre diferentes VPCs a trav칠s de conexiones de emparejamiento de VPC. **Los Registros de Flujo de VPC te permiten capturar informaci칩n de tr치fico IP que fluye entre tus interfaces de red de tus recursos dentro de tu VPC**.

A diferencia de los registros de acceso de S3 y CloudFront, los **datos de registro generados por los Registros de Flujo de VPC no se almacenan en S3. En cambio, los datos de registro capturados se env칤an a los registros de CloudWatch**.

Limitaciones:

* Si est치s ejecutando una conexi칩n de emparejamiento de VPC, entonces solo podr치s ver los registros de flujo de VPCs emparejados que est칠n dentro de la misma cuenta.
* Si todav칤a est치s ejecutando recursos dentro del entorno EC2-Classic, entonces desafortunadamente no podr치s recuperar informaci칩n de sus interfaces
* Una vez que se ha creado un Registro de Flujo de VPC, no se puede cambiar. Para alterar la configuraci칩n del Registro de Flujo de VPC, necesitas eliminarlo y luego recrear uno nuevo.
* El siguiente tr치fico no es monitoreado y capturado por los registros. Tr치fico DHCP dentro del VPC, tr치fico de instancias destinado al Servidor DNS de Amazon.
* Cualquier tr치fico destinado a la direcci칩n IP del enrutador predeterminado del VPC y tr치fico hacia y desde las siguientes direcciones, 169.254.169.254 que se usa para recopilar metadatos de instancia, y 169.254.169.123 que se usa para el Servicio de Sincronizaci칩n de Tiempo de Amazon.
* Tr치fico relacionado con una licencia de activaci칩n de Windows de Amazon desde una instancia de Windows
* Tr치fico entre una interfaz de balanceador de carga de red y una interfaz de red de punto final

Para cada interfaz de red que publica datos al grupo de registros de CloudWatch, utilizar치 un flujo de registros diferente. Y dentro de cada uno de estos flujos, habr치 datos de eventos de registro de flujo que muestran el contenido de las entradas de registro. Cada uno de estos **registros captura datos durante una ventana de aproximadamente 10 a 15 minutos**.

## VPN

### Componentes B치sicos de VPN en AWS

1. **Puerta de Enlace del Cliente**:
* Una Puerta de Enlace del Cliente es un recurso que creas en AWS para representar tu lado de una conexi칩n VPN.
* Es esencialmente un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN de Sitio a Sitio.
* Proporcionas informaci칩n de enrutamiento y la direcci칩n IP p칰blica de tu dispositivo de red (como un enrutador o un firewall) a AWS para crear una Puerta de Enlace del Cliente.
* Sirve como punto de referencia para configurar la conexi칩n VPN y no incurre en cargos adicionales.
2. **Puerta de Enlace Privada Virtual**:
* Una Puerta de Enlace Privada Virtual (VPG) es el concentrador VPN del lado de Amazon de la conexi칩n VPN de Sitio a Sitio.
* Se adjunta a tu VPC y sirve como objetivo para tu conexi칩n VPN.
* VPG es el punto final del lado de AWS para la conexi칩n VPN.
* Maneja la comunicaci칩n segura entre tu VPC y tu red local.
3. **Conexi칩n VPN de Sitio a Sitio**:
* Una conexi칩n VPN de Sitio a Sitio conecta tu red local a un VPC a trav칠s de un t칰nel VPN seguro, IPsec.
* Este tipo de conexi칩n requiere una Puerta de Enlace del Cliente y una Puerta de Enlace Privada Virtual.
* Se utiliza para una comunicaci칩n segura, estable y consistente entre tu centro de datos o red y tu entorno de AWS.
* T칤picamente se utiliza para conexiones regulares y a largo plazo y se factura en base a la cantidad de datos transferidos sobre la conexi칩n.
4. **Punto Final de VPN del Cliente**:
* Un Punto Final de VPN del Cliente es un recurso que creas en AWS para habilitar y gestionar sesiones de VPN del cliente.
* Se utiliza para permitir que dispositivos individuales (como laptops, smartphones, etc.) se conecten de manera segura a recursos de AWS o a tu red local.
* Se diferencia de la VPN de Sitio a Sitio en que est치 dise침ado para clientes individuales en lugar de conectar redes enteras.
* Con la VPN del Cliente, cada dispositivo cliente utiliza un software de cliente VPN para establecer una conexi칩n segura.

### VPN de Sitio a Sitio

**Conecta tu red local con tu VPC.**

* **Conexi칩n VPN**: Una conexi칩n segura entre tu equipo local y tus VPCs.
*   **T칰nel VPN**: Un enlace cifrado donde los datos pueden pasar del cliente a AWS o viceversa.

Cada conexi칩n VPN incluye dos t칰neles VPN que puedes usar simult치neamente para alta disponibilidad.
* **Puerta de enlace del cliente**: Un recurso de AWS que proporciona informaci칩n a AWS sobre tu dispositivo de puerta de enlace del cliente.
* **Dispositivo de puerta de enlace del cliente**: Un dispositivo f칤sico o una aplicaci칩n de software en tu lado de la conexi칩n VPN de Sitio a Sitio.
* **Puerta de enlace privada virtual**: El concentrador VPN del lado de Amazon de la conexi칩n VPN de Sitio a Sitio. Utilizas una puerta de enlace privada virtual o una puerta de enlace de tr치nsito como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de Sitio a Sitio.
* **Puerta de enlace de tr치nsito**: Un centro de tr치nsito que se puede utilizar para interconectar tus VPCs y redes locales. Utilizas una puerta de enlace de tr치nsito o una puerta de enlace privada virtual como la puerta de enlace para el lado de Amazon de la conexi칩n VPN de Sitio a Sitio.
