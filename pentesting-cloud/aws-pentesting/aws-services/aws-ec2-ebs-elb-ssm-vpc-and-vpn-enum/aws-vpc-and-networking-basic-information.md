# AWS - Osnovne informacije o VPC-u i mrežnom povezivanju

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite videti **oglašavanje vaše kompanije u HackTricks-u** ili **preuzeti HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## AWS Mrežno povezivanje ukratko

**VPC** sadrži **mrežni CIDR** kao što je 10.0.0.0/16 (sa svojom **tabelom rutiranja** i **mrežnim ACL-om**).

Ova VPC mreža je podeljena u **podmreže**, pa je **podmreža** direktno **povezana** sa **VPC-om**, **tabelom rutiranja** i **mrežnim ACL-om**.

Zatim, **mrežni interfejsi** povezani sa uslugama (kao što su EC2 instance) su **povezani** sa **podmrežama** pomoću **sigurnosnih grupa**.

Stoga, **sigurnosna grupa** će ograničiti izložene portove mrežnih **interfejsa koji je koriste**, **nezavisno od podmreže**. A **mrežni ACL** će **ograničiti** izložene portove na **celu mrežu**.

Osim toga, kako bi se **pristupilo Internetu**, postoje neke zanimljive konfiguracije koje treba proveriti:

* **Podmreža** može **automatski dodeljivati javne IPv4 adrese**
* **Instanca** kreirana u mreži koja **automatski dodeljuje IPv4 adrese može dobiti jednu**
* **Internet gateway** mora biti **povezan** sa **VPC-om**
* Takođe možete koristiti **Egress-only internet gateways**
* Takođe možete imati **NAT gateway** u **privatnoj podmreži** tako da je moguće **povezivanje sa spoljnim uslugama** iz te privatne podmreže, ali nije **moguće doći do njih sa spoljne strane**.
* NAT gateway može biti **javni** (pristup internetu) ili **privatni** (pristup drugim VPC-ovima)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) omogućava vam da **pokrenete AWS resurse u virtuelnoj mreži** koju ste definisali. Ova virtuelna mreža će imati nekoliko podmreža, Internet Gateway-e za pristup Internetu, ACL-ove, sigurnosne grupe, IP adrese...

### Podmreže

Podmreže pomažu u primeni većeg nivoa sigurnosti. **Logičko grupisanje sličnih resursa** takođe vam pomaže da održavate **lakšu upravljivost** infrastrukturom.

* Validne CIDR adrese su od /16 netmaske do /28 netmaske.
* Podmreža ne može biti istovremeno u različitim dostupnostnim zonama.
* **AWS rezerviše prve tri IP adrese hosta** svake podmreže **za internu AWS upotrebu**: prva adresa hosta se koristi za VPC ruter. Druga adresa je rezervisana za AWS DNS, a treća adresa je rezervisana za buduću upotrebu.
* Podmreže koje imaju **direktan pristup Internetu** nazivaju se **javne podmreže**, dok **privatne podmreže** to nemaju.

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabele rutiranja

Tabele rutiranja određuju rutiranje saobraćaja za podmrežu unutar VPC-a. One određuju koji mrežni saobraćaj se prosleđuje ka internetu ili ka VPN vezi. Obično ćete imati pristup:

* Lokalnom VPC-u
* NAT-u
* Internet Gateway-ima / Egress-only Internet gateway-ima (potrebno za omogućavanje pristupa VPC-u Internetu).
* Da biste napravili podmrežu javnom, morate **kreirati** i **povezati** Internet gateway sa svojim VPC-om.
* VPC endpointima (za pristup S3 iz privatnih mreža)

Na sledećim slikama možete videti razlike između podrazumevane javne mreže i privatne mreže:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL-ovi

**Network Access Control Lists (ACL-ovi)**: ACL-ovi su firewall pravila koja kontrolišu dolazni i odlazni mrežni saobraćaj ka podmreži. Mogu se koristiti za dozvoljavanje ili zabranjivanje saobraćaja ka određenim IP adresama ili opsezima.

* Najčešće se koristi dozvola/zabrana pristupa pomoću sigurnosnih grupa, ali to je jedini način da se potpuno prekinu uspostavljene reverzne veze. Izmenjeno pravilo u sigurnosnoj grupi ne zaustavlja već uspostavljene veze.
* Međutim, ovo se odnosi na celu podmrežu, pa budite oprezni kada zabranjujete stvari jer može biti poreme
### Bezbednosne grupe

Bezbednosne grupe su virtuelni **firewall** koji kontroliše dolazni i odlazni mrežni **saobraćaj ka instancama** u VPC-u. Odnos 1 SG prema M instancama (obično 1 prema 1).\
Obično se koristi za otvaranje opasnih portova na instancama, kao što je na primer port 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastične IP adrese

Elastična IP adresa je **statička IPv4 adresa** namenjena dinamičnom računarstvu u oblaku. Elastična IP adresa se dodeljuje vašem AWS nalogu i ostaje vaša sve dok je ne oslobodite. Korišćenjem elastične IP adrese, možete prikriti kvar instance ili softvera tako što ćete brzo preusmeriti adresu na drugu instancu u vašem nalogu.

### Veza između podmreža

Podrazumevano, sve podmreže imaju **automatsko dodeljivanje javnih IP adresa isključeno**, ali se može uključiti.

**Lokalna ruta unutar tabele ruta omogućava komunikaciju između VPC podmreža.**

Ako povezujete podmrežu sa drugom podmrežom, ne možete pristupiti povezanim podmrežama povezane sa drugom podmrežom, već morate direktno uspostaviti vezu sa njima. **Ovo se takođe odnosi na internet kapije**. Ne možete proći kroz vezu podmreže da biste pristupili internetu, već morate dodeliti internet kapiju svojoj podmreži.

### VPC povezivanje

VPC povezivanje vam omogućava da **povežete dve ili više VPC-ova zajedno**, koristeći IPV4 ili IPV6, kao da su deo iste mreže.

Kada se uspostavi veza između parova, **resursi u jednom VPC-u mogu pristupiti resursima u drugom**. Veza između VPC-ova se implementira kroz postojeću AWS mrežnu infrastrukturu i stoga je visoko dostupna bez ograničenja propusnog opsega. Pošto **povezane veze funkcionišu kao da su deo iste mreže**, postoje ograničenja kada je reč o opsezima CIDR blokova koji se mogu koristiti.\
Ako imate **preklapajuće ili duplicirane CIDR opsege** za vaš VPC, tada **nećete moći povezati VPC-ove** zajedno.\
Svaki AWS VPC će **komunicirati samo sa svojim parom**. Na primer, ako imate vezu između VPC 1 i VPC 2, i drugu vezu između VPC 2 i VPC 3 kao što je prikazano, tada VPC 1 i 2 mogu direktno komunicirati jedan sa drugim, kao i VPC 2 i VPC 3, međutim, VPC 1 i VPC 3 ne mogu. **Ne možete rutirati kroz jedan VPC da biste došli do drugog.**

### **VPC Flow Logs**

U okviru vašeg VPC-a, moguće je imati stotine ili čak hiljade resursa koji komuniciraju između različitih podmreža, kako javnih tako i privatnih, kao i između različitih VPC-ova putem VPC povezivanja. **VPC Flow Logs vam omogućavaju da zabeležite informacije o IP saobraćaju koji protiče između mrežnih interfejsa vaših resursa unutar vašeg VPC-a**.

Za razliku od S3 pristupnih zapisa i CloudFront pristupnih zapisa, **podaci o zapisima generisanim od strane VPC Flow Logs nisu smešteni u S3. Umesto toga, zabeleženi podaci se šalju u CloudWatch zapise**.

Ograničenja:

* Ako koristite VPC povezivanje, moći ćete videti samo zapise o protoku povezanih VPC-ova koji su u istom nalogu.
* Ako još uvek koristite resurse unutar EC2-Classic okruženja, nažalost nećete moći dobiti informacije sa njihovih interfejsa.
* Kada se jednom kreira VPC Flow Log, ne može se promeniti. Da biste promenili konfiguraciju VPC Flow Log-a, morate ga izbrisati i zatim ponovo kreirati.
* Sledeći saobraćaj nije praćen i zabeležen zapisima: DHCP saobraćaj unutar VPC-a, saobraćaj sa instanci namenjen Amazon DNS serveru.
* Bilo koji saobraćaj namenjen IP adresi za podrazumevanog rutera VPC-a i saobraćaj ka i od sledećih adresa: 169.254.169.254 koja se koristi za prikupljanje metapodataka instance, i 169.254.169.123 koja se koristi za Amazon Time Sync Service.
* Saobraćaj koji se odnosi na aktivacionu licencu za Amazon Windows sa Windows instance
* Saobraćaj između interfejsa mrežnog opterećenja i interfejsa krajnje tačke mreže

Za svaki mrežni interfejs koji objavljuje podatke u CloudWatch grupu zapisa, koristiće se zaseban tok zapisa. A unutar svakog od ovih tokova, biće podaci o događajima protoka zapisa koji prikazuju sadržaj unosa zapisa. Svaki od ovih **zapisa beleži podatke tokom prozora od otprilike 10 do 15 minuta**.

## VPN

### Osnovni AWS VPN komponenti

1. **Korisnička kapija**:
* Korisnička kapija je resurs koji kreirate u AWS-u da predstavlja vašu stranu VPN veze.
* To je suštinski fizički uređaj ili softverska aplikacija na vašoj strani VPN veze sa mesta do mesta.
* Pružate rutinske informacije i javnu IP adresu vašeg mrežnog uređaja (kao što je ruter ili firewall) AWS-u kako biste kreirali korisničku kapiju.
* Služi kao referentna tačka za podešavanje VPN veze i ne podleže dodatnim naplatama.
2. **Virtualna privatna kapija**:
* Virtualna privatna kapija (VPG) je VPN koncentrator na Amazon strani VPN veze sa mesta do mesta.
* Povezana je sa vašim VPC-om i služi kao cilj za vašu VPN vezu.
* VPG je AWS strana krajnja tačka za VPN vezu.
* Obradjuje sigurnu komunikaciju između vašeg VPC-a i vaše lokalne mreže.
3. **Veza sa mesta do mesta VPN**:
* Veza sa mesta do mesta VPN povezuje vašu lokalnu mrežu sa VPC-om putem sigurnog IPsec VPN tunela.
* Ovaj tip veze zahteva korisničku kapiju i virtualnu privatnu kapiju.
* Koristi se za sigurnu, stabilnu i doslednu komunikaciju između vašeg data centra ili mreže i vašeg AWS okruženja.
* Obično se koristi za redovne, dugoročne veze i naplaćuje se na osnovu količine prenetih podataka preko veze.
4. **Klijentska VPN krajnja tačka**:
* Klijentska VPN krajnja tačka je resurs koji kreirate u AWS-u da omogućite i upravljate sesijama klijentske VPN.
* Koristi se za omogućavanje pojedinačnim uređajima (poput laptop
#### Ograničenja

* IPv6 saobraćaj nije podržan za VPN veze na virtuelnoj privatnoj kapiji.
* AWS VPN veza ne podržava otkrivanje putanje MTU.

Pored toga, uzmite u obzir sledeće kada koristite Site-to-Site VPN.

* Kada povezujete svoje VPC-ove sa zajedničkom mrežom na lokaciji, preporučujemo da koristite ne-preklapajuće CIDR blokove za svoje mreže.

### Klijentski VPN <a href="#what-is-components" id="what-is-components"></a>

**Povezivanje sa vašeg računara na vaš VPC**

#### Koncepti

* **Klijentski VPN krajnja tačka:** Resurs koji kreirate i konfigurišete da omogućite i upravljate klijentskim VPN sesijama. To je resurs na kojem se završavaju sve klijentske VPN sesije.
* **Ciljna mreža:** Ciljna mreža je mreža koju povezujete sa klijentskom VPN krajnjom tačkom. **Podmreža iz VPC-a je ciljna mreža**. Povezivanje podmreže sa klijentskom VPN krajnjom tačkom omogućava vam uspostavljanje VPN sesija. Možete povezati više podmreža sa klijentskom VPN krajnjom tačkom radi visoke dostupnosti. Sve podmreže moraju biti iz istog VPC-a. Svaka podmreža mora pripadati drugoj dostupnoj zoni.
* **Ruta**: Svaka klijentska VPN krajnja tačka ima tabelu ruta koja opisuje dostupne rute za odredišne mreže. Svaka ruta u tabeli ruta određuje put za saobraćaj ka određenim resursima ili mrežama.
* **Pravila autorizacije:** Pravilo autorizacije **ograničava korisnike koji mogu pristupiti mreži**. Za određenu mrežu konfigurišete grupu Active Directory ili provajdera identiteta (IdP) kojoj je dozvoljen pristup. Samo korisnici koji pripadaju ovoj grupi mogu pristupiti određenoj mreži. **Podrazumevano, ne postoje pravila autorizacije** i morate konfigurisati pravila autorizacije da biste omogućili korisnicima pristup resursima i mrežama.
* **Klijent:** Krajnji korisnik koji se povezuje na klijentsku VPN krajnju tačku radi uspostavljanja VPN sesije. Krajnji korisnici moraju preuzeti OpenVPN klijent i koristiti konfiguracioni fajl klijentske VPN krajnje tačke koji ste kreirali da biste uspostavili VPN sesiju.
* **Opseg klijentskog CIDR-a:** Opseg IP adresa iz kojeg se dodeljuju IP adrese klijentima. Svaka veza sa klijentskom VPN krajnjom tačkom dobija jedinstvenu IP adresu iz opsega klijentskog CIDR-a. Vi birate opseg klijentskog CIDR-a, na primer, `10.2.0.0/16`.
* **Portovi klijentskog VPN-a:** AWS klijentski VPN podržava portove 443 i 1194 za TCP i UDP. Podrazumevani port je 443.
* **Mrežni interfejsi klijentskog VPN-a:** Kada povežete podmrežu sa klijentskom VPN krajnjom tačkom, mi kreiramo mrežne interfejse klijentskog VPN-a u toj podmreži. **Saobraćaj koji se šalje ka VPC-u sa klijentske VPN krajnje tačke se šalje preko mrežnog interfejsa klijentskog VPN-a**. Tada se primenjuje prevodjenje izvorne IP adrese iz opsega klijentskog CIDR-a u IP adresu mrežnog interfejsa klijentskog VPN-a.
* **Evidencija povezivanja:** Možete omogućiti evidenciju povezivanja za vašu klijentsku VPN krajnju tačku da biste beležili događaje povezivanja. Možete koristiti ove informacije za forenziku, analizu korišćenja vaše klijentske VPN krajnje tačke ili otklanjanje problema sa povezivanjem.
* **Portal za samouslugu:** Možete omogućiti portal za samouslugu za vašu klijentsku VPN krajnju tačku. Klijenti se mogu prijaviti na web portal koristeći svoje akreditive i preuzeti najnoviju verziju konfiguracionog fajla klijentske VPN krajnje tačke ili najnoviju verziju klijenta koju pruža AWS.

#### Ograničenja

* **Opsezi klijentskog CIDR-a ne smeju se preklapati sa lokalnim CIDR-om** VPC-a u kojem se nalazi povezana podmreža, niti sa bilo kojim ručno dodatim rutama u tabeli ruta klijentske VPN krajnje tačke.
* Opsezi klijentskog CIDR-a moraju imati veličinu bloka **najmanje /22** i ne smeju biti veći od /12.
* **Deo adresa** u opsegu klijentskog CIDR-a se koristi za **podršku modela dostupnosti** klijentske VPN krajnje tačke i ne mogu biti dodeljene klijentima. Zato preporučujemo da **dodelite CIDR blok koji sadrži dvostruko više IP adresa nego što je potrebno** da biste omogućili maksimalan broj istovremenih veza koje planirate da podržite na klijentskoj VPN krajnjoj tački.
* **Opseg klijentskog CIDR-a se ne može promeniti** nakon što kreirate klijentsku VPN krajnju tačku.
* **Podmreže** povezane sa klijentskom VPN krajnjom tačkom **mora biti u istom VPC-u**.
* **Ne možete povezati više podmreža iz iste dostupne zone sa klijentskom VPN krajnjom tačkom**.
* Klijentska VPN krajnja tačka **ne podržava povezivanje podmreža u VPC-u sa dedikovanim zakupom**.
* Klijentski VPN podržava samo **IPv4** saobraćaj.
* Klijentski VPN **nije** usklađen sa Federalnim standardima za obradu informacija (**FIPS**).
*   Ako je višefaktorska autentifikacija (MFA) onemogućena za vaš Active Directory, lozinka korisnika ne može biti u sledećem formatu.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Portal za samouslugu **nije dostupan za klijente koji se autentifikuju koristeći međusobnu autentifikaciju**.

<details>

<summary><strong>Naučite hakovanje AWS-a od početka do naprednog nivoa sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini da podržite HackTricks:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje tako što ćete slati PR-ove na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
