# AWS - Taarifa Msingi za VPC na Mtandao

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha** [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Mtandao wa AWS kwa Kifupi

**VPC** ina **CIDR ya mtandao** kama 10.0.0.0/16 (na **meza ya uhamishaji** na **ACL ya mtandao**).

Mtandao huu wa VPC umegawanywa katika **subnetworks**, hivyo **subnetwork** inahusiana moja kwa moja na **VPC**, **meza ya uhamishaji** na **ACL ya mtandao**.

Kisha, **Interface ya Mtandao** zilizounganishwa na huduma (kama mifano ya EC2) zina **unganishwa** na **subnetworks** na **kikundi cha usalama**.

Hivyo, **kikundi cha usalama** kitapunguza bandari zilizofichuliwa za **interfaces za mtandao zinazotumia**, **bila kujali subnetwork**. Na **ACL ya mtandao** itapunguza bandari zilizofichuliwa kwa **mtandao wote**.

Zaidi ya hayo, ili **kufikia Mtandao**, kuna mipangilio ya kuvutia ya kuangalia:

* **Subnetwork** inaweza **kujipatia moja kwa moja anwani za IPv4 za umma**
* **Kifaa** kilichoundwa kwenye mtandao ambacho **kina jipatia moja kwa moja anwani za IPv4 inaweza kupata moja**
* **Geti la Mtandao** linahitaji kuwa **limeunganishwa** na **VPC**
* Unaweza pia kutumia **Geti la Mtandao la Kutoka tu** (Egress-only internet gateways)
* Unaweza pia kuwa na **Geti la NAT** katika **subnetwork ya faragha** hivyo ni rahisi **kuunganisha huduma za nje** kutoka kwa subnetwork hiyo ya faragha, lakini **si rahisi kufikia kutoka nje**.
* Geti la NAT linaweza kuwa **la umma** (kufikia mtandao) au **la faragha** (kufikia VPC nyingine)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

**Virtual Private Cloud** ya Amazon (Amazon VPC) inakuwezesha **kuzindua rasilimali za AWS kwenye mtandao wa kubuni**. Mtandao huu wa kubuni utakuwa na subnet kadhaa, Geti la Mtandao la kufikia Mtandao, ACLs, Vikundi vya Usalama, IPs...

### Subnets

Subnets husaidia kutekeleza kiwango kikubwa cha usalama. **Kikundi la mantiki la rasilimali kama** pia husaidia katika **kudumisha** **urahisi wa usimamizi** kote kwenye miundombinu yako.

* CIDR halali ni kutoka kwa netmask ya /16 hadi netmask ya /28.
* Subnet haiwezi kuwa katika maeneo tofauti ya upatikanaji wakati huo huo.
* **AWS inahifadhi anwani tatu za IP za mwenyeji wa kwanza** ya kila subnet **kwa matumizi ya ndani ya AWS**: anwani ya kwanza ya mwenyeji inayotumiwa ni kwa router ya VPC. Anwani ya pili inahifadhiwa kwa DNS ya AWS na anwani ya tatu inahifadhiwa kwa matumizi ya baadaye.
* Inaitwa **subnets za umma** zile ambazo zina **upatikanaji wa moja kwa moja kwenye Mtandao, wakati subnets za faragha hazina.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Meza za Uhamishaji

Meza za uhamishaji hupanga uhamishaji wa trafiki kwa subnet ndani ya VPC. Zinabainisha ni trafiki gani ya mtandao inayopelekwa kwenye mtandao au kwenye uhusiano wa VPN. Kwa kawaida utapata upatikanaji wa:

* VPC ya ndani
* NAT
* Geti la Mtandao la kufikia Mtandao / Geti la Mtandao la Kutoka tu (linahitajika kumpa VPC upatikanaji wa Mtandao).
* Ili kufanya subnet kuwa ya umma unahitaji **kuunda** na **kuunganisha** **Geti la Mtandao** kwenye VPC yako.
* Vipindi vya VPC (kupata S3 kutoka kwa mitandao ya faragha)

Katika picha zifuatazo unaweza kuangalia tofauti kati ya mtandao wa umma wa kawaida na wa faragha:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Majedwali ya Kudhibiti Upatikanaji wa Mtandao (ACLs)**: ACLs za Mtandao ni sheria za firewall zinazodhibiti trafiki ya mtandao ya kuingia na kutoka kwa subnet. Zinaweza kutumika kuruhusu au kukataa trafiki kwa anwani au safu maalum za IP.

* Mara nyingi ni kawaida kuruhusu/kukataa upatikanaji kwa kutumia vikundi vya usalama, lakini hii ni njia pekee ya kukata kabisa mizunguko iliyowekwa nyuma. Kanuni iliyobadilishwa katika vikundi vya usalama haikomeshi mawasiliano yaliyoanzishwa tayari
* Hata hivyo, hii inatumika kwa subnetwork nzima kuwa mwangalifu wakati wa kupiga marufuku vitu kwa sababu utendaji muhimu unaweza kusumbuliwa
### Vikundi vya Usalama

Vikundi vya usalama ni **firewall** ya kisasa inayodhibiti **trafiki ya kuingia na kutoka kwa mifano** katika VPC. Uhusiano 1 SG kwa M mifano (kawaida 1 kwa 1).\
Kawaida hii hutumiwa kufungua bandari hatari kwenye mifano, kama vile bandari 22 kwa mfano:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Anwani za IP za Elastic

Anwani ya _Elastic IP_ ni **anwani ya IPv4 ya static** iliyoundwa kwa kompyuta ya wingu ya kudumu. Anwani ya Elastic IP inatengwa kwa akaunti yako ya AWS, na ni yako mpaka uachilie. Kwa kutumia anwani ya Elastic IP, unaweza kuficha kushindwa kwa mfano au programu kwa haraka kwa kubadilisha upya anwani kwa mfano mwingine katika akaunti yako.

### Uunganisho kati ya subneti

Kwa chaguo-msingi, subneti zote zina **kuzimwa kwa moja kwa moja kwa anwani za IP za umma** lakini inaweza kuwasha.

**Njia ya ndani ndani ya meza ya njia inawezesha mawasiliano kati ya subneti za VPC.**

Ikiwa unach **unganisha subneti na subneti tofauti huwezi kufikia subneti zilizounganishwa** na subneti nyingine, unahitaji kuunda uhusiano nao moja kwa moja. **Hii pia inatumika kwa malango ya mtandao**. Huwezi kupitia uhusiano wa subneti kufikia mtandao, unahitaji kumtambulisha lango la mtandao kwa subneti yako.

### Peering ya VPC

Peering ya VPC inakuruhusu **kuunganisha VPC mbili au zaidi pamoja**, ukitumia IPV4 au IPV6, kana kwamba zilikuwa sehemu ya mtandao mmoja.

Marape ya peering inapowekwa, **rasilimali katika VPC moja inaweza kufikia rasilimali katika nyingine**. Uunganisho kati ya VPC unatekelezwa kupitia miundombinu ya mtandao ya AWS iliyopo, na kwa hivyo inapatikana sana bila kizuizi cha upana wa bandari. Kwa kuwa **mawasiliano ya peered hufanya kazi kana kwamba zilikuwa sehemu ya mtandao mmoja**, kuna vizuizi linapokuja suala la safu zako za CIDR zinazoweza kutumika.\
Ikiwa una **safu za CIDR zinazolingana au zinazofanana** kwa VPC yako, basi **hutaweza kupeera VPCs** pamoja.\
Kila VPC ya AWS ita **mawasiliano tu na mwenzake**. Kwa mfano, ikiwa una uhusiano wa peering kati ya VPC 1 na VPC 2, na uhusiano mwingine kati ya VPC 2 na VPC 3 kama inavyoonyeshwa, basi VPC 1 na 2 wanaweza kufanya mawasiliano moja kwa moja, kama vile VPC 2 na VPC 3, hata hivyo, VPC 1 na VPC 3 hawawezi. **Huwezi kupitia VPC moja kwenda nyingine.**
#### Mapungufu

* Trafiki ya IPv6 haitegemezwi kwa miunganisho ya VPN kwenye lango la faragha la kimagharibi.
* Miunganisho ya VPN ya AWS haitegemezi Ugunduzi wa Path MTU.

Mbali na hayo, chukua yafuatayo kuzingatia unapotumia VPN ya Tovuti-kwa-Tovuti.

* Unapounganisha VPCs yako kwenye mtandao wa kawaida wa ndani, tunapendekeza utumie vitalu vya CIDR visivyolingana kwa mitandao yako.

### VPN ya Mteja <a href="#what-is-components" id="what-is-components"></a>

**Unaweza kuunganisha kutoka kwa mashine yako kwenda kwa VPC yako**

#### Dhana

* **Mwisho wa VPN ya Mteja:** Rasimu unayounda na kusanidi kuwezesha na kusimamia vikao vya VPN vya mteja. Ni rasilimali ambapo vikao vyote vya VPN vya mteja vinamalizika.
* **Mtandao lengwa:** Mtandao lengwa ni mtandao unaoambatisha na Mwisho wa VPN ya Mteja. **Subnet kutoka kwa VPC ni mtandao lengwa**. Kuambatisha subnet na Mwisho wa VPN ya Mteja kunakuwezesha kuanzisha vikao vya VPN. Unaweza kuambatisha subnets kadhaa na Mwisho wa VPN ya Mteja kwa upatikanaji wa juu. Subnets zote lazima ziwe kutoka kwa VPC moja. Kila subnet lazima iwe katika Eneo la Upatikanaji tofauti.
* **Njia**: Kila Mwisho wa VPN ya Mteja una jedwali la njia linaloelezea njia zilizopo za mtandao wa marudio. Kila njia katika jedwali la njia inaelezea njia ya trafiki kwa rasilimali au mitandao maalum.
* **Mipangilio ya idhini:** Mipangilio ya idhini **inazuia watumiaji wanaoweza kufikia mtandao**. Kwa mtandao uliowekwa, unasanidi kikundi cha Active Directory au mtoa huduma wa kitambulisho (IdP) ambacho kinaruhusiwa kupata. Watumiaji wanaopatikana kwa kikundi hiki tu wanaweza kupata mtandao uliowekwa. **Kwa chaguo-msingi, hakuna mipangilio ya idhini** na lazima usanidi mipangilio ya idhini kuwezesha watumiaji kupata rasilimali na mitandao.
* **Mteja:** Mtumiaji anayeunganisha kwenye Mwisho wa VPN ya Mteja kuanzisha kikao cha VPN. Watumiaji wa mwisho wanahitaji kupakua mteja wa OpenVPN na kutumia faili ya usanidi wa Mwisho wa VPN ya Mteja uliyounda kuanzisha kikao cha VPN.
* **Upeo wa CIDR wa Mteja:** Safu ya anwani ya IP ambayo itapewa anwani za IP za mteja. Kila uunganisho kwa Mwisho wa VPN ya Mteja unapewa anwani ya IP ya kipekee kutoka kwa upeo wa CIDR wa mteja. Unachagua upeo wa CIDR wa mteja, kwa mfano, `10.2.0.0/16`.
* **Bandari za VPN ya Mteja:** AWS Client VPN inasaidia bandari 443 na 1194 kwa TCP na UDP. Chaguo-msingi ni bandari 443.
* **Interface za mtandao wa VPN ya Mteja:** Unapoambatisha subnet na Mwisho wa VPN ya Mteja wako, tunajenga interface za mtandao wa VPN ya Mteja katika subnet hiyo. **Trafiki inayotumwa kwa VPC kutoka kwa Mwisho wa VPN ya Mteja inatumwa kupitia interface ya mtandao wa VPN ya Mteja**. Ubadilishaji wa anwani ya mtandao wa asili (SNAT) unatumika, ambapo anwani ya IP ya chanzo kutoka kwa upeo wa CIDR wa mteja inabadilishwa kuwa anwani ya IP ya interface ya mtandao wa VPN ya Mteja.
* **Kuingiza kumbukumbu ya uunganisho:** Unaweza kuwezesha kuingiza kumbukumbu ya uunganisho kwa Mwisho wa VPN ya Mteja wako ili kurekodi matukio ya uunganisho. Unaweza kutumia habari hii kufanya uchunguzi wa kisayansi, kuchambua jinsi Mwisho wa VPN ya Mteja unavyotumiwa, au kutatua matatizo ya uunganisho.
* **Lango la huduma binafsi:** Unaweza kuwezesha lango la huduma binafsi kwa Mwisho wa VPN ya Mteja wako. Wateja wanaweza kuingia kwenye lango la wavuti kwa kutumia sifa zao na kupakua toleo la karibuni la faili ya usanidi wa Mwisho wa VPN ya Mteja, au toleo la karibuni la mteja uliotolewa na AWS.

#### Mapungufu

* **Upeo wa CIDR wa Wateja hauwezi kufanana na CIDR ya eneo** ya VPC ambayo subnet inayohusishwa iko, au njia yoyote iliyowekwa kwa mkono kwenye jedwali la njia la Mwisho wa VPN ya Mteja.
* Upeo wa CIDR wa Wateja lazima uwe na saizi ya **angalau /22** na lazima **usizidi /12.**
* **Sehemu ya anwani** katika upeo wa CIDR wa mteja hutumiwa kusaidia mfano wa upatikanaji wa Mwisho wa VPN ya Mteja, na haziwezi kutengwa kwa wateja. Kwa hivyo, tunapendekeza **utoe kibali cha CIDR kinachojumuisha mara mbili idadi ya anwani za IP zinazohitajika** kuwezesha idadi kubwa ya uunganisho wa wakati mmoja unapanga kusaidia kwenye Mwisho wa VPN ya Mteja.
* **Upeo wa CIDR wa mteja hauwezi kubadilishwa** baada ya kuunda Mwisho wa VPN ya Mteja.
* **Subnets** zilizohusishwa na Mwisho wa VPN ya Mteja **lazima ziwe katika VPC moja**.
* **Hauwezi kuambatisha subnets kadhaa kutoka kwa Eneo la Upatikanaji moja na Mwisho wa VPN ya Mteja**.
* Mwisho wa VPN ya Mteja **hausaidii uhusishaji wa subnets katika VPC ya kukodisha kwa kujitolea**.
* VPN ya Mteja inasaidia trafiki ya **IPv4** pekee.
* VPN ya Mteja **haikubaliani** na Viwango vya Usindikaji wa Habari vya Shirikisho (**FIPS**).
*   Ikiwa uthibitishaji wa hatua nyingi (MFA) umefungwa kwa Active Directory yako, nywila ya mtumiaji haiwezi kuwa katika muundo ufuatao.

```
SCRV1:<kamba_iliyofungwa_kwa_base64>:<kamba_iliyofungwa_kwa_base64>
```
* Lango la huduma binafsi **halipatikani kwa wateja wanaothibitisha kwa kutumia uthibitishaji wa pande zote**.
