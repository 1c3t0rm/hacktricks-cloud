# AWS - Podstawowe informacje o VPC i sieciach

<details>

<summary><strong>Dowiedz się, jak hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriów GitHub.**

</details>

## Sieciowanie w AWS w skrócie

**VPC** zawiera **CIDR sieci** takie jak 10.0.0.0/16 (z jej **tabelą routingu** i **ACL sieciowym**).

Ta sieć VPC jest podzielona na **podsieci**, więc **podsieć** jest bezpośrednio **powiązana** z **VPC**, **tabelą routingu** i **ACL sieciowym**.

Następnie, **Interfejsy sieciowe** podłączone do usług (takich jak instancje EC2) są **połączone** z **podsieciami** za pomocą **grup zabezpieczeń**.

Dlatego **grupa zabezpieczeń** ogranicza wystawione porty interfejsów sieciowych **korzystających z niej**, **niezależnie od podsieci**. Natomiast **ACL sieciowy** ogranicza wystawione porty dla **całej sieci**.

Ponadto, aby **uzyskać dostęp do Internetu**, istnieją pewne interesujące konfiguracje do sprawdzenia:

* **Podsieć** może **automatycznie przypisywać publiczne adresy IPv4**
* **Instancja** utworzona w sieci, która **automatycznie przypisuje adresy IPv4, może otrzymać jeden**
* Do **VPC** musi być **dołączony brama internetowa**
* Można również używać **bram wyłącznie do wychodzącego ruchu do Internetu**
* Można również mieć **bramę NAT** w **prywatnej podsieci**, dzięki czemu możliwe jest **połączenie z zewnętrznymi usługami** z tej prywatnej podsieci, ale **nie można ich osiągnąć z zewnątrz**.
* Brama NAT może być **publiczna** (dostęp do Internetu) lub **prywatna** (dostęp do innych VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) umożliwia **uruchamianie zasobów AWS w wirtualnej sieci**, którą zdefiniowałeś. Ta wirtualna sieć będzie miała kilka podsieci, Bramy internetowe do dostępu do Internetu, ACL, Grupy zabezpieczeń, adresy IP...

### Podsieci

Podsieci pomagają w większym zabezpieczeniu. **Logiczne grupowanie podobnych zasobów** pomaga również w **łatwiejszym zarządzaniu** infrastrukturą.

* Poprawne CIDR to od maski sieci /16 do maski sieci /28.
* Podsieć nie może znajdować się jednocześnie w różnych strefach dostępności.
* **AWS zastrzega trzy pierwsze adresy IP hosta** każdej podsieci **dla wewnętrznego użytku AWS**: pierwszy używany adres hosta jest dla routera VPC. Drugi adres jest zarezerwowany dla DNS AWS, a trzeci adres jest zarezerwowany na przyszłe użycie.
* Nazywa się je **publicznymi podsieciami**, które mają **bezpośredni dostęp do Internetu, podczas gdy prywatne podsieci nie mają.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabele routingu

Tabele routingu określają trasowanie ruchu dla podsieci w ramach VPC. Określają, który ruch sieciowy jest przekazywany do Internetu lub do połączenia VPN. Zazwyczaj znajdziesz dostęp do:

* Lokalnej VPC
* NAT
* Bram internetowych / Bram internetowych wyłącznie do wychodzącego ruchu (potrzebne do zapewnienia VPC dostępu do Internetu).
* Aby uczynić podsieć publiczną, musisz **utworzyć** i **dołączyć** **bramę internetową** do swojej VPC.
* Punkty końcowe VPC (do dostępu do S3 z prywatnych sieci)

Na poniższych obrazach możesz sprawdzić różnice między domyślną siecią publiczną a prywatną:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL sieciowy

**Kontrola dostępu do sieci (ACL)**: ACL sieciowe to reguły zapory sieciowej, które kontrolują przychodzący i wychodzący ruch sieciowy do podsieci. Mogą być używane do zezwalania lub blokowania ruchu do określonych adresów IP lub zakresów.

* Najczęściej zezwala się/blokuje dostęp za pomocą grup zabezpieczeń, ale jest to jedyny sposób, aby całkowicie zatrzymać już ustanowione odwrócone powłoki. Zmodyfikowana reguła w grupie zabezpieczeń nie zatrzymuje już ustanowionych połączeń
* Jednak dotyczy to całej podsieci, więc bądź ostrożny, gdy zakazujesz czegoś, ponieważ potrzebna funkcjonalność może zostać zakłócona
### Grupy zabezpieczeń

Grupy zabezpieczeń są wirtualnym **firewallem**, który kontroluje ruch sieciowy **przychodzący i wychodzący do instancji** w VPC. Relacja 1 SG do M instancji (zazwyczaj 1 do 1).\
Zazwyczaj jest to używane do otwierania niebezpiecznych portów w instancjach, takich jak na przykład port 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastyczne adresy IP

Elastyczny adres IP to **statyczny adres IPv4** zaprojektowany do dynamicznego obliczeń w chmurze. Elastyczny adres IP jest przydzielany do twojego konta AWS i pozostaje twoją własnością, dopóki go nie zwolnisz. Korzystając z elastycznego adresu IP, możesz ukryć awarię instancji lub oprogramowania, szybko przypisując adres do innej instancji w twoim koncie.

### Połączenie między podsiecią

Domyślnie wszystkie podsieci mają **automatyczne przypisywanie publicznych adresów IP wyłączone**, ale można je włączyć.

**Lokalna trasa w tablicy tras umożliwia komunikację między podsiecią VPC.**

Jeśli **łączysz podsieć z inną podsiecią, nie możesz uzyskać dostępu do podsieci połączonych** z inną podsiecią, musisz bezpośrednio utworzyć połączenie z nimi. **Dotyczy to również bram internetowych**. Nie możesz przechodzić przez połączenie podsieci, aby uzyskać dostęp do internetu, musisz przypisać bramę internetową do swojej podsieci.

### VPC Peering

VPC Peering umożliwia **połączenie dwóch lub więcej VPC** za pomocą IPV4 lub IPV6, tak jakby były częścią tej samej sieci.

Po ustanowieniu połączenia peer, **zasoby w jednym VPC mogą uzyskać dostęp do zasobów w drugim**. Połączenie między VPC jest realizowane za pomocą istniejącej infrastruktury sieciowej AWS, dlatego jest wysoce dostępne bez wąskiego gardła przepustowości. Ponieważ **połączenia peer działają tak, jakby były częścią tej samej sieci**, istnieją ograniczenia dotyczące zakresów bloków CIDR, które można używać.\
Jeśli masz **nakładające się lub zduplikowane zakresy CIDR** dla swojego VPC, **nie będziesz w stanie połączyć VPC**.\
Każde VPC AWS **komunikuje się tylko ze swoim peerem**. Na przykład, jeśli masz połączenie peer między VPC 1 i VPC 2, a innym połączeniem między VPC 2 i VPC 3, jak pokazano na rysunku, VPC 1 i 2 mogą komunikować się bezpośrednio, tak samo jak VPC 2 i VPC 3, jednak VPC 1 i VPC 3 nie mogą. **Nie można przekierować ruchu przez jedno VPC, aby dotrzeć do innego.**

### **Rejestry przepływu VPC**

W ramach VPC możesz mieć potencjalnie setki lub nawet tysiące zasobów, które komunikują się między różnymi podsieciami, zarówno publicznymi, jak i prywatnymi, a także między różnymi VPC za pośrednictwem połączeń peer. **Rejestry przepływu VPC pozwalają rejestrować informacje o ruchu IP, który przepływa między interfejsami sieciowymi twoich zasobów w ramach VPC**.

W przeciwieństwie do rejestrów dostępu S3 i rejestrów dostępu CloudFront, **dane logów generowane przez rejestry przepływu VPC nie są przechowywane w S3. Zamiast tego, przechwytywane dane logów są wysyłane do logów CloudWatch**.

Ograniczenia:

* Jeśli korzystasz z połączenia peer VPC, będziesz mógł zobaczyć tylko logi przepływu z połączonych VPC, które znajdują się w tym samym koncie.
* Jeśli nadal korzystasz z zasobów w środowisku EC2-Classic, niestety nie możesz pobierać informacji z ich interfejsów.
* Po utworzeniu rejestru przepływu VPC nie można go zmienić. Aby zmienić konfigurację rejestru przepływu VPC, musisz go usunąć, a następnie utworzyć nowy.
* Następujący ruch nie jest monitorowany i przechwytywany przez logi: ruch DHCP w ramach VPC, ruch z instancji do serwera DNS Amazona.
* Ruch kierowany na adres IP routera domyślnego VPC i ruch do i od następujących adresów: 169.254.169.254, który jest używany do zbierania metadanych instancji, i 169.254.169.123, który jest używany do usługi synchronizacji czasu Amazona.
* Ruch dotyczący licencji aktywacji systemu Windows Amazona z instancji systemu Windows.
* Ruch między interfejsem równoważenia obciążenia sieci a interfejsem sieci punktu końcowego.

Dla każdego interfejsu sieciowego, który publikuje dane do grupy logów CloudWatch, zostanie użyty inny strumień logów. W każdym z tych strumieni znajdują się dane zdarzeń rejestru przepływu, które pokazują zawartość wpisów logów. Każdy z tych **logów rejestruje dane przez około 10 do 15 minut**.

## VPN

### Podstawowe komponenty AWS VPN

1. **Brama klienta**:
* Brama klienta to zasób, który tworzysz w AWS, aby reprezentować twoją stronę połączenia VPN.
* Jest to w zasadzie fizyczne urządzenie lub aplikacja oprogramowania po twojej stronie połączenia VPN typu site-to-site.
* Przekazujesz informacje o routingu i publicznym adresie IP urządzenia sieciowego (takiego jak router lub zapora ogniowa) do AWS, aby utworzyć bramę klienta.
* Służy jako punkt odniesienia do konfiguracji połączenia VPN i nie generuje dodatkowych opłat.
2. **Wirtualna prywatna brama**:
* Wirtualna prywatna brama (VPG) to koncentrator VPN po stronie Amazona w połączeniu VPN typu site-to-site.
* Jest ona dołączona do twojego VPC i służy jako cel dla twojego połączenia VPN.
* VPG jest punktem końcowym po stronie AWS dla połączenia VPN.
* Obsługuje bezpieczną komunikację między twoim VPC a siecią lokalną.
3. **Połączenie VPN typu site-to-site**:
* Połączenie VPN typu site-to-site łączy twoją sieć lokalną z VPC za pośrednictwem bezpiecznego tunelu VPN IPsec.
* Ten rodzaj połączenia wymaga bramy klienta i wirtualnej prywatnej bramy.
* Służy do bezpiecznej, stabilnej i spójnej komunikacji między twoim centrum danych lub siecią a środowiskiem AWS.
* Zazwyczaj używane do regularnych, długoterminowych połączeń i rozliczane na podstawie ilości przesyłanych danych w ramach połączenia.
4. **Punkt końcowy klienta VPN**:
* Punkt końcowy klienta VPN to zasób, który tworzysz w AWS, aby umożliwić i zarządzać sesjami klienta VPN.
* Służy do umożliwienia indywidualnym urządzeniom (takim jak laptopy, smartfony itp.) bezpiecznego połączenia z zasobami AWS lub siecią lokalną.
* Różni się od połączenia VPN typu site-to
#### Ograniczenia

* Ruch IPv6 nie jest obsługiwany dla połączeń VPN na wirtualnej bramie prywatnej.
* Połączenie VPN AWS nie obsługuje odkrywania MTU ścieżki.

Ponadto, należy wziąć pod uwagę następujące kwestie podczas korzystania z VPN typu Site-to-Site.

* Podczas łączenia VPC z wspólną siecią lokalną zalecamy korzystanie z niezachodzących na siebie bloków CIDR dla sieci.

### VPN klienta <a href="#what-is-components" id="what-is-components"></a>

**Połącz się z Twojego urządzenia do Twojej VPC**

#### Pojęcia

* **Punkt końcowy VPN klienta:** Zasób, który tworzysz i konfigurujesz, aby umożliwić i zarządzać sesjami VPN klienta. Jest to zasób, w którym kończą się wszystkie sesje VPN klienta.
* **Sieć docelowa:** Sieć docelowa to sieć, którą powiązujesz z punktem końcowym VPN klienta. **Podsieć z VPC jest siecią docelową**. Powiązanie podsieci z punktem końcowym VPN klienta umożliwia nawiązanie sesji VPN. Możesz powiązać wiele podsieci z punktem końcowym VPN klienta w celu zapewnienia wysokiej dostępności. Wszystkie podsieci muszą pochodzić z tej samej VPC. Każda podsieć musi należeć do innej strefy dostępności.
* **Trasa**: Każdy punkt końcowy VPN klienta ma tablicę tras, która opisuje dostępne trasy sieci docelowych. Każda trasa w tabeli tras określa ścieżkę dla ruchu do określonych zasobów lub sieci.
* **Zasady autoryzacji:** Zasada autoryzacji **ogranicza użytkowników, którzy mogą uzyskać dostęp do sieci**. Dla określonej sieci konfigurujesz grupę Active Directory lub dostawcę tożsamości (IdP), który ma dostęp. Tylko użytkownicy należący do tej grupy mogą uzyskać dostęp do określonej sieci. **Domyślnie nie ma zasad autoryzacji** i musisz skonfigurować zasady autoryzacji, aby umożliwić użytkownikom dostęp do zasobów i sieci.
* **Klient:** Użytkownik końcowy łączący się z punktem końcowym VPN klienta w celu nawiązania sesji VPN. Użytkownicy końcowi muszą pobrać klienta OpenVPN i użyć pliku konfiguracyjnego punktu końcowego VPN klienta, który utworzyłeś, aby nawiązać sesję VPN.
* **Zakres CIDR klienta:** Zakres adresów IP, z którego przypisywane są adresy IP klientów. Każde połączenie z punktem końcowym VPN klienta otrzymuje unikalny adres IP z zakresu CIDR klienta. Wybierasz zakres CIDR klienta, na przykład `10.2.0.0/16`.
* **Porty VPN klienta:** AWS Client VPN obsługuje porty 443 i 1194 zarówno dla protokołu TCP, jak i UDP. Domyślnie używany jest port 443.
* **Interfejsy sieci VPN klienta:** Po powiązaniu podsieci z punktem końcowym VPN klienta, tworzymy interfejsy sieci VPN klienta w tej podsieci. **Ruch wysyłany do VPC z punktu końcowego VPN klienta jest przesyłany przez interfejs sieci VPN klienta**. Następnie stosowane jest tłumaczenie adresów źródłowych sieci (SNAT), gdzie adres IP źródłowy z zakresu CIDR klienta jest tłumaczony na adres IP interfejsu sieci VPN klienta.
* **Rejestrowanie połączeń:** Możesz włączyć rejestrowanie połączeń dla punktu końcowego VPN klienta, aby rejestrować zdarzenia połączenia. Możesz użyć tych informacji do przeprowadzania analizy forensycznej, analizowania sposobu korzystania z punktu końcowego VPN klienta lub rozwiązywania problemów z połączeniem.
* **Portal samoobsługowy:** Możesz włączyć portal samoobsługowy dla punktu końcowego VPN klienta. Klienci mogą zalogować się do portalu internetowego za pomocą swoich danych uwierzytelniających i pobrać najnowszą wersję pliku konfiguracyjnego punktu końcowego VPN klienta lub najnowszą wersję klienta dostarczonego przez AWS.

#### Ograniczenia

* **Zakresy CIDR klienta nie mogą się pokrywać z lokalnym CIDR** VPC, w którym znajduje się powiązana podsieć, ani z żadnymi ręcznie dodanymi trasami do tabeli tras punktu końcowego VPN klienta.
* Zakresy CIDR klienta muszą mieć rozmiar bloku **co najmniej /22** i nie mogą być większe niż /12.
* **Część adresów** w zakresie CIDR klienta jest używana do **obsługi modelu dostępności** punktu końcowego VPN klienta i nie może być przypisana klientom. Dlatego zalecamy, abyś **przypisał blok CIDR zawierający dwa razy więcej adresów IP, niż jest wymagane**, aby umożliwić maksymalną liczbę jednoczesnych połączeń, które planujesz obsłużyć na punkcie końcowym VPN klienta.
* **Zakres CIDR klienta nie może być zmieniony** po utworzeniu punktu końcowego VPN klienta.
* **Podsieci** powiązane z punktem końcowym VPN klienta **muszą znajdować się w tej samej VPC**.
* **Nie można powiązać wielu podsieci z tej samej strefy dostępności z punktem końcowym VPN klienta**.
* Punkt końcowy VPN klienta **nie obsługuje powiązań podsieci w VPC o dedykowanej dzierżawie**.
* VPN klienta obsługuje tylko ruch **IPv4**.
* VPN klienta **nie jest zgodny** z Federalnymi Standardami Przetwarzania Informacji (**FIPS**).
* Jeśli wieloczynnikowe uwierzytelnianie (MFA) jest wyłączone dla Twojego Active Directory, hasło użytkownika nie może mieć następującego formatu.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Portal samoobsługowy **nie jest dostępny dla klientów uwierzytelniających się za pomocą uwierzytelniania wzajemnego**.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć **reklamę swojej firmy w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
