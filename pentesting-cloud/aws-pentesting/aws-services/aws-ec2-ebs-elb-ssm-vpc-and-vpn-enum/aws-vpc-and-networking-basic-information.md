# AWS - VPC & Networking Basic Information

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## AWS Networking in a Nutshell

A **VPC** contains a **network CIDR** like 10.0.0.0/16 (with its **routing table** and **network ACL**).

This VPC network is divided in **subnetworks**, so a **subnetwork** is directly **related** with the **VPC**, **routing** **table** and **network ACL**.

Then, **Network Interface**s attached to services (like EC2 instances) are **connected** to the **subnetworks** with **security group(s)**.

Therefore, a **security group** will limit the exposed ports of the network **interfaces using it**, **independently of the subnetwork**. And a **network ACL** will **limit** the exposed ports to to the **whole network**.

Moreover, in order to **access Internet**, there are some interesting configurations to check:

* A **subnetwork** can **auto-assign public IPv4 addresses**
* An **instance** created in the network that **auto-assign IPv4 addresses can get one**
* An **Internet gateway** need to be **attached** to the **VPC**
* You could also use **Egress-only internet gateways**
* You could also have a **NAT gateway** in a **private subnet** so it's possible to **connect to external services** from that private subnet, but it's **not possible to reach them from the outside**.
* The NAT gateway can be **public** (access to the internet) or **private** (access to other VPCs)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) enables you to **launch AWS resources into a virtual network** that you've defined. This virtual network will have several subnets, Internet Gateways to access Internet, ACLs, Security groups, IPs...

### Subnets

Subnets helps to enforce a greater level of security. **Logical grouping of similar resources** also helps you to maintain an **ease of management** across your infrastructure.

* Valid CIDR are from a /16 netmask to a /28 netmask.
* A subnet cannot be in different availability zones at the same time.
* **AWS reserves the first three host IP addresses** of each subnet **for** **internal AWS usage**: he first host address used is for the VPC router. The second address is reserved for AWS DNS and the third address is reserved for future use.
* It's called **public subnets** to those that have **direct access to the Internet, whereas private subnets do not.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Route Tables

Route tables determine the traffic routing for a subnet within a VPC. They determine which network traffic is forwarded to the internet or to a VPN connection. You will usually find access to the:

* Local VPC
* NAT
* Internet Gateways / Egress-only Internet gateways (needed to give a VPC access to the Internet).
* In order to make a subnet public you need to **create** and **attach** an **Internet gateway** to your VPC.
* VPC endpoints (to access S3 from private networks)

In the following images you can check the differences in a default public network and a private one:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**Network Access Control Lists (ACLs)**: Network ACLs are firewall rules that control incoming and outgoing network traffic to a subnet. They can be used to allow or deny traffic to specific IP addresses or ranges.

* It‚Äôs most frequent to allow/deny access using security groups, but this is only way to completely cut established reverse shells. A modified rule in a security groups doesn‚Äôt stop already established connections
* However, this apply to the whole subnetwork be careful when forbidding stuff because needed functionality might be disturbed
### Security Groups

Security groups are a virtual **firewall** that control inbound and outbound network **traffic to instances** in a VPC. Relation 1 SG to M instances (usually 1 to 1).\
Usually this is used to open dangerous ports in instances, such as port 22 for example:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Elastic IP Addresses

An _Elastic IP address_ is a **static IPv4 address** designed for dynamic cloud computing. An Elastic IP address is allocated to your AWS account, and is yours until you release it. By using an Elastic IP address, you can mask the failure of an instance or software by rapidly remapping the address to another instance in your account.

### Connection between subnets

By default, all subnets have the **automatic assigned of public IP addresses turned off** but it can be turned on.

**A local route within a route table enables communication between VPC subnets.**

If you are **connection a subnet with a different subnet you cannot access the subnets connected** with the other subnet, you need to create connection with them directly. **This also applies to internet gateways**. You cannot go through a subnet connection to access internet, you need to assign the internet gateway to your subnet.

### VPC Peering

VPC peering allows you to **connect two or more VPCs together**, using IPV4 or IPV6, as if they were a part of the same network.

Once the peer connectivity is established, **resources in one VPC can access resources in the other**. The connectivity between the VPCs is implemented through the existing AWS network infrastructure, and so it is highly available with no bandwidth bottleneck. As **peered connections operate as if they were part of the same network**, there are restrictions when it comes to your CIDR block ranges that can be used.\
If you have **overlapping or duplicate CIDR** ranges for your VPC, then **you'll not be able to peer the VPCs** together.\
Each AWS VPC will **only communicate with its peer**. As an example, if you have a peering connection between VPC 1 and VPC 2, and another connection between VPC 2 and VPC 3 as shown, then VPC 1 and 2 could communicate with each other directly, as can VPC 2 and VPC 3, however, VPC 1 and VPC 3 could not. **You can't route through one VPC to get to another.**

### **VPC Flow Logs**

Within your VPC, you could potentially have hundreds or even thousands of resources all communicating between different subnets both public and private and also between different VPCs through VPC peering connections. **VPC Flow Logs allow you to capture IP traffic information that flows between your network interfaces of your resources within your VPC**.

Unlike S3 access logs and CloudFront access logs, the **log data generated by VPC Flow Logs is not stored in S3. Instead, the log data captured is sent to CloudWatch logs**.

Limitations:

* If you are running a VPC peered connection, then you'll only be able to see flow logs of peered VPCs that are within the same account.
* If you are still running resources within the EC2-Classic environment, then unfortunately you are not able to retrieve information from their interfaces
* Once a VPC Flow Log has been created, it cannot be changed. To alter the VPC Flow Log configuration, you need to delete it and then recreate a new one.
* The following traffic is not monitored and captured by the logs. DHCP traffic within the VPC, traffic from instances destined for the Amazon DNS Server.
* Any traffic destined to the IP address for the VPC default router and traffic to and from the following addresses, 169.254.169.254 which is used for gathering instance metadata, and 169.254.169.123 which is used for the Amazon Time Sync Service.
* Traffic relating to an Amazon Windows activation license from a Windows instance
* Traffic between a network load balancer interface and an endpoint network interface

For every network interface that publishes data to the CloudWatch log group, it will use a different log stream. And within each of these streams, there will be the flow log event data that shows the content of the log entries. Each of these **logs captures data during a window of approximately 10 to 15 minutes**.

## VPN

### Basic AWS VPN Components

1. **Customer Gateway**:
* A Customer Gateway is a resource that you create in AWS to represent your side of a VPN connection.
* It is essentially a physical device or software application on your side of the Site-to-Site VPN connection.
* You provide routing information and the public IP address of your network device (such as a router or a firewall) to AWS to create a Customer Gateway.
* It serves as a reference point for setting up the VPN connection and doesn't incur additional charges.
2. **Virtual Private Gateway**:
* A Virtual Private Gateway (VPG) is the VPN concentrator on the Amazon side of the Site-to-Site VPN connection.
* It is attached to your VPC and serves as the target for your VPN connection.
* VPG is the AWS side endpoint for the VPN connection.
* It handles the secure communication between your VPC and your on-premises network.
3. **Site-to-Site VPN Connection**:
* A Site-to-Site VPN connection connects your on-premises network to a VPC through a secure, IPsec VPN tunnel.
* This type of connection requires a Customer Gateway and a Virtual Private Gateway.
* It's used for secure, stable, and consistent communication between your data center or network and your AWS environment.
* Typically used for regular, long-term connections and is billed based on the amount of data transferred over the connection.
4. **Client VPN Endpoint**:
* A Client VPN endpoint is a resource that you create in AWS to enable and manage client VPN sessions.
* It is used for allowing individual devices (like laptops, smartphones, etc.) to securely connect to AWS resources or your on-premises network.
* It differs from Site-to-Site VPN in that it is designed for individual clients rather than connecting entire networks.
* With Client VPN, each client device uses a VPN client software to establish a secure connection.

### Site-to-Site VPN

**Connect your on premisses network with your VPC.**

* **VPN connection**: A secure connection between your on-premises equipment and your VPCs.
*   **VPN tunnel**: An encrypted link where data can pass from the customer network to or from AWS.

Each VPN connection includes two VPN tunnels which you can simultaneously use for high availability.
* **Customer gateway**: An AWS resource which provides information to AWS about your customer gateway device.
* **Customer gateway device**: A physical device or software application on your side of the Site-to-Site VPN connection.
* **Virtual private gateway**: The VPN concentrator on the Amazon side of the Site-to-Site VPN connection. You use a virtual private gateway or a transit gateway as the gateway for the Amazon side of the Site-to-Site VPN connection.
* **Transit gateway**: A transit hub that can be used to interconnect your VPCs and on-premises networks. You use a transit gateway or virtual private gateway as the gateway for the Amazon side of the Site-to-Site VPN connection.
#### qImHa'

* VPN qab 'ej IPv6 traffic jatlhqa' neH.
* AWS VPN qab Path MTU Discovery jatlhqa'.

vaj, Site-to-Site VPN lo'laHbe'chugh, vaj jatlhqa'chuqmoH.

* VPCmeyDaq on-premises network lo'laHbe'chugh, networkmeyDaq non-overlapping CIDR blocks lo'laHbe'chugh jatlhqa'.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**machinemeyDaq VPCmeyDaq lo'laH**

#### QaD

* **Client VPN endpoint:** lo'laHbe'chugh vaj configure qar'a'wI'pu' client VPN sessions lo'laH. 'Iv endpoint Hoch 'ej client VPN sessions jatlhqa'.
* **Target network:** Target network Hoch 'ej Client VPN endpoint lo'laHbe'chugh network. **VPC subnet Hoch target network**. Subnet Hoch Client VPN endpoint lo'laHbe'chugh vaj VPN sessions lo'laH. Hoch 'ej Hoch subnets Client VPN endpoint lo'laHbe'chugh vaj Hoch availability. Subnets Hoch Hoch VPCmeyDaq. Subnet Hoch Hoch Availability Zone.
* **Route**: Client VPN endpoint Hoch route table Hoch Hoch available destination network routes jatlhqa'. Route Hoch route table Hoch Hoch traffic Hoch Hoch resources Hoch networks path jatlhqa'.
* **Authorization rules:** Hoch Hoch authorization rule Hoch Hoch users Hoch access network. Hoch network Hoch Hoch Active Directory Hoch identity provider (IdP) group Hoch allowed access configure. Hoch group Hoch Hoch network access. **authorization rules Hoch Hoch Hoch** Hoch Hoch Hoch Hoch Hoch Hoch resources Hoch networks access enable.
* **Client:** Client VPN endpoint Hoch VPN session lo'laHbe'chugh client. Client Hoch OpenVPN client Hoch Hoch Client VPN configuration file Hoch Hoch VPN session lo'laHbe'chugh.
* **Client CIDR range:** Hoch Hoch client IP addresses assign IP address range. Client VPN endpoint Hoch connection Hoch unique IP address assign client CIDR range. Hoch client CIDR range Hoch choose, 'ej, `10.2.0.0/16` Hoch example.
* **Client VPN ports:** AWS Client VPN Hoch ports 443 Hoch 1194 Hoch TCP Hoch UDP jatlhqa'. Hoch port 443 Hoch default.
* **Client VPN network interfaces:** Hoch subnet Hoch Client VPN endpoint lo'laHbe'chugh, Hoch Client VPN network interfaces Hoch Hoch subnet lo'laHbe'chugh. Hoch VPC Hoch Client VPN endpoint Hoch traffic Hoch Client VPN network interface Hoch Hoch. Source network address translation (SNAT) Hoch Hoch, Hoch client CIDR range Hoch source IP address Hoch Client VPN network interface IP address Hoch Hoch.
* **Connection logging:** Hoch connection logging Hoch Client VPN endpoint enable Hoch connection events log. Hoch information Hoch forensics run, analyze Hoch Client VPN endpoint Hoch used, Hoch connection issues debug.
* **Self-service portal:** Hoch self-service portal Hoch Client VPN endpoint enable. Clients Hoch web-based portal Hoch Hoch credentials Hoch log Hoch, Hoch latest version Hoch Client VPN endpoint configuration file Hoch download, Hoch latest version Hoch AWS provided client Hoch download.

#### qImHa'

* **Client CIDR ranges Hoch local CIDR Hoch overlap** VPC Hoch associated subnet Hoch Hoch, Hoch Client VPN endpoint's route table Hoch manually added routes Hoch Hoch.
* Client CIDR ranges Hoch block size Hoch **/22 Hoch Hoch** Hoch **/12 Hoch Hoch**.
* Hoch **portion addresses** client CIDR range Hoch Hoch availability model Hoch Client VPN endpoint support, Hoch clients Hoch Hoch assign. Hoch Hoch CIDR block Hoch assign, IP addresses number twice Hoch contain recommend enable maximum number concurrent connections Client VPN endpoint support plan.
* **client CIDR range Hoch change** Hoch Client VPN endpoint create Hoch Hoch.
* **subnets** Hoch Client VPN endpoint **Hoch VPC Hoch Hoch**.
* Hoch **subnets multiple** Hoch Availability Zone Hoch Hoch Client VPN endpoint **Hoch associate**.
* Client VPN endpoint **Hoch subnet associations Hoch dedicated tenancy VPC Hoch support**.
* Client VPN Hoch **IPv4** traffic jatlhqa'.
* Client VPN Hoch Federal Information Processing Standards (FIPS) Hoch compliant Hoch.
*   Active Directory Hoch multi-factor authentication (MFA) Hoch disabled, user password Hoch Hoch format.

```
SCRV1:<base64_encoded_string>:<base64_encoded_string>
```
* Hoch self-service portal Hoch clients authenticate using mutual authentication Hoch available.

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
