# AWS - VPC & ネットワーキング基本情報

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のPRを提出して、あなたのハッキングのコツを共有する [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリ。

</details>

## AWSネットワーキングの概要

**VPC**は、10.0.0.0/16のような**ネットワークCIDR**（**ルーティングテーブル**と**ネットワークACL**を含む）を含んでいます。

このVPCネットワークは**サブネットワーク**に分割され、**サブネットワーク**は直接**VPC**、**ルーティング** **テーブル**、**ネットワークACL**と**関連**しています。

次に、サービス（EC2インスタンスなど）にアタッチされた**ネットワークインターフェース**は、**セキュリティグループ**を持つ**サブネットワーク**に**接続**されます。

したがって、**セキュリティグループ**は、**サブネットワークに関係なく**、それを使用するネットワーク**インターフェースの公開ポートを制限します。そして、**ネットワークACL**は、**全ネットワーク**に対して公開ポートを**制限**します。

さらに、**インターネットへのアクセス**には、チェックする価値のあるいくつかの興味深い設定があります：

* **サブネットワーク**は**パブリックIPv4アドレスを自動割り当て**できます
* IPv4アドレスを自動割り当てするネットワークで作成された**インスタンス**は、IPv4アドレスを取得できます
* **インターネットゲートウェイ**は**VPC**に**アタッチ**する必要があります
* **Egress-onlyインターネットゲートウェイ**も使用できます
* **NATゲートウェイ**を**プライベートサブネット**に設置することで、そのプライベートサブネットから外部サービスに**接続**することが可能ですが、外部からそれらに**到達することはできません**。
* NATゲートウェイは**パブリック**（インターネットへのアクセス）または**プライベート**（他のVPCへのアクセス）にすることができます

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) は、定義した仮想ネットワークにAWSリソースを**起動する**ことを可能にします。この仮想ネットワークには、いくつかのサブネット、インターネットゲートウェイ、ACL、セキュリティグループ、IPなどがあります...

### サブネット

サブネットは、より高いレベルのセキュリティを強化するのに役立ちます。**類似のリソースの論理的なグループ化**は、インフラストラクチャ全体の**管理の容易さ**を維持するのにも役立ちます。

* 有効なCIDRは/16ネットマスクから/28ネットマスクまでです。
* サブネットは同時に異なるアベイラビリティゾーンには存在できません。
* **AWSは各サブネットの最初の3つのホストIPアドレスを**内部AWS使用のために**予約しています**：最初のホストアドレスはVPCルーター用です。2番目のアドレスはAWS DNS用に予約され、3番目のアドレスは将来の使用のために予約されています。
* **インターネットへの直接アクセスがあるサブネット**を**パブリックサブネット**と呼び、プライベートサブネットはそうではありません。

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### ルートテーブル

ルートテーブルは、VPC内のサブネットのトラフィックルーティングを決定します。それらは、どのネットワークトラフィックがインターネットまたはVPN接続に転送されるかを決定します。通常、以下へのアクセスが見られます：

* ローカルVPC
* NAT
* インターネットゲートウェイ/ Egress-onlyインターネットゲートウェイ（VPCにインターネットアクセスを提供するために必要）。
* サブネットをパブリックにするためには、**インターネットゲートウェイ**を作成してVPCに**アタッチ**する必要があります。
* VPCエンドポイント（プライベートネットワークからS3にアクセスするため）

以下の画像では、デフォルトのパブリックネットワークとプライベートネットワークの違いを確認できます：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL

**ネットワークアクセスコントロールリスト（ACL）**: ネットワークACLは、サブネットへの入出力ネットワークトラフィックを制御するファイアウォールルールです。特定のIPアドレスや範囲へのトラフィックを許可または拒否するために使用できます。

* セキュリティグループを使用してアクセスを許可/拒否することが最も一般的ですが、これは確立されたリバースシェルを完全にカットする唯一の方法です。セキュリティグループのルールを変更しても、既に確立された接続は停止しません
* しかし、これはサブネットワーク全体に適用されるので、機能が必要なものを禁止する際には注意してください

### セキュリティグループ

セキュリティグループは、VPC内のインスタンスへの入出力ネットワーク**トラフィックを制御する仮想**ファイアウォールです。関係は1 SGからMインスタンスまで（通常は1対1）。\
通常、インスタンスで危険なポートを開くために使用されます。例えば、ポート22など：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### エラスティックIPアドレス

_Elastic IPアドレス_は、ダイナミッククラウドコンピューティング用に設計された**静的IPv4アドレス**です。Elastic IPアドレスはAWSアカウントに割り当てられ、解放するまであなたのものです。Elastic IPアドレスを使用することで、インスタンスまたはソフトウェアの障害を迅速にリマッピングして別のインスタンスにマスクすることができます。

### サブネット間の接続

デフォルトでは、すべてのサブネットはパブリックIPアドレスの自動割り当てがオフになっていますが、オンにすることができます。

**ルートテーブル内のローカルルートにより、VPCサブネット間の通信が可能になります。**

**異なるサブネットを接続している場合、他のサブネットに接続されているサブネットにアクセスすることはできません**。直接接続を作成する必要があります。**これはインターネットゲートウェイにも適用されます**。サブネット接続を通じてインターネットにアクセスすることはできません。インターネットゲートウェイをサブネットに割り当てる必要があります。

### VPCピアリング

VPCピアリングにより、IPV4またはIPV6を使用して、2つ以上のVPCを同じネットワークの一部であるかのように接続することができます。

ピア接続が確立されると、**あるVPCのリソースが他のVPCのリソースにアクセスできます**。VPC間の接続は既存のAWSネットワークインフラストラクチャを介して実装されるため、帯域幅のボトルネックがない高可用性です。**ピア接続は同じネットワークの一部であるかのように動作するため**、使用できるCIDRブロック範囲には制限があります。\
VPCのCIDR範囲が**重複している場合や重複している場合は**、VPCをピアリングすることはできません。\
各AWS VPCは**ピアとのみ通信します**。例えば、VPC 1とVPC 2の間にピアリング接続があり、VPC 2とVPC 3の間に別の接続がある場合、VPC 1と2は直接互いに通信できますし、VPC 2とVPC 3も同様ですが、VPC 1とVPC 3は通信できません。**一つのVPCを通じて別のVPCに到達することはできません。**

### **VPCフローログ**

VPC内では、公共およびプライベートの異なるサブネット間、またはVPCピアリング接続を介して異なるVPC間で通信するリソースが数百または数千も存在する可能性があります。**VPCフローログにより、VPC内のリソースのネットワークインターフェース間で流れるIPトラフィック情報をキャプチャすることができます**。

S3アクセスログやCloudFrontアクセスログとは異なり、**VPCフローログによって生成されるログデータはS3に保存されません。代わりに、キャプチャされたログデータはCloudWatchログに送信されます**。

制限事項：

* 仮想プライベートゲートウェイでVPN接
