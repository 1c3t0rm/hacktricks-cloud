# AWS - Informazioni di base su VPC e Networking

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di github.

</details>

## Networking di AWS in breve

Un **VPC** contiene un **CIDR di rete** come 10.0.0.0/16 (con la sua **tabella di routing** e **ACL di rete**).

Questa rete VPC √® divisa in **sottoreti**, quindi una **sottorete** √® direttamente **collegata** al **VPC**, alla **tabella di routing** e all'**ACL di rete**.

Successivamente, le **interfacce di rete** collegate ai servizi (come le istanze EC2) sono **collegate** alle **sottoreti** con **gruppi di sicurezza**.

Pertanto, un **gruppo di sicurezza** limiter√† le porte esposte delle **interfacce di rete che lo utilizzano**, **indipendentemente dalla sottorete**. E un'**ACL di rete** limiter√† le porte esposte all'intera rete.

Inoltre, per **accedere a Internet**, ci sono alcune configurazioni interessanti da verificare:

* Una **sottorete** pu√≤ **assegnare automaticamente indirizzi IPv4 pubblici**
* Un'**istanza** creata nella rete che **assegna automaticamente indirizzi IPv4 pu√≤ ottenerne uno**
* √à necessario **collegare** un **gateway Internet** al **VPC**
* √à anche possibile utilizzare **gateway Internet solo per l'egresso**
* √à anche possibile avere un **gateway NAT** in una **sottorete privata** in modo da poter **connettersi a servizi esterni** da quella sottorete privata, ma **non √® possibile raggiungerli dall'esterno**.
* Il gateway NAT pu√≤ essere **pubblico** (accesso a Internet) o **privato** (accesso ad altri VPC)

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **Virtual Private Cloud** (Amazon VPC) consente di **avviare risorse AWS in una rete virtuale** che hai definito. Questa rete virtuale avr√† diverse sottoreti, gateway Internet per accedere a Internet, ACL, gruppi di sicurezza, indirizzi IP...

### Sottoreti

Le sottoreti aiutano a garantire un livello maggiore di sicurezza. **Raggruppamento logico di risorse simili** ti aiuta anche a mantenere una **facilit√† di gestione** nell'infrastruttura.

* Gli CIDR validi vanno da una maschera di rete /16 a una maschera di rete /28.
* Una sottorete non pu√≤ essere in diverse zone di disponibilit√† contemporaneamente.
* **AWS riserva i primi tre indirizzi IP host** di ogni sottorete **per uso interno di AWS**: il primo indirizzo host utilizzato √® per il router VPC. Il secondo indirizzo √® riservato per AWS DNS e il terzo indirizzo √® riservato per un uso futuro.
* Si chiamano **sottoreti pubbliche** quelle che hanno **accesso diretto a Internet, mentre le sottoreti private no.**

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### Tabelle di routing

Le tabelle di routing determinano il routing del traffico per una sottorete all'interno di un VPC. Determinano quale traffico di rete viene inoltrato a Internet o a una connessione VPN. Di solito troverai l'accesso a:

* VPC locale
* NAT
* Gateway Internet / Gateway Internet solo per l'egresso (necessario per dare accesso a Internet a un VPC).
* Per rendere una sottorete pubblica √® necessario **creare** e **collegare** un **gateway Internet** al tuo VPC.
* Endpoint VPC (per accedere a S3 da reti private)

Nelle immagini seguenti puoi verificare le differenze tra una rete pubblica predefinita e una privata:

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACL di rete

**Network Access Control Lists (ACL di rete)**: Le ACL di rete sono regole del firewall che controllano il traffico di rete in ingresso e in uscita verso una sottorete. Possono essere utilizzate per consentire o negare il traffico a indirizzi IP o intervalli specifici.

* √à pi√π frequente consentire/negare l'accesso utilizzando i gruppi di sicurezza, ma questo √® l'unico modo per interrompere completamente le reverse shell gi√† stabilite. Una regola modificata in un gruppo di sicurezza non interrompe le connessioni gi√† stabilite
* Tuttavia, ci√≤ si applica all'intera sottorete, quindi fai attenzione quando vietare cose perch√© potrebbe essere disturbata una funzionalit√† necessaria
### Gruppi di sicurezza

I gruppi di sicurezza sono un **firewall virtuale** che controlla il traffico di rete in entrata e in uscita verso le istanze in una VPC. Relazione 1 SG per M istanze (di solito 1 a 1).\
Di solito viene utilizzato per aprire porte pericolose nelle istanze, come ad esempio la porta 22:

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### Indirizzi IP elastici

Un indirizzo IP elastico √® un **indirizzo IPv4 statico** progettato per il cloud computing dinamico. Un indirizzo IP elastico viene allocato al tuo account AWS ed √® tuo finch√© non lo rilasci. Utilizzando un indirizzo IP elastico, puoi mascherare il guasto di un'istanza o di un software riassegnando rapidamente l'indirizzo a un'altra istanza nel tuo account.

### Connessione tra subnet

Per impostazione predefinita, tutte le subnet hanno **l'assegnazione automatica degli indirizzi IP pubblici disattivata**, ma pu√≤ essere attivata.

**Una route locale all'interno di una tabella di routing consente la comunicazione tra le subnet della VPC.**

Se stai **connettendo una subnet con un'altra subnet non puoi accedere alle subnet connesse** all'altra subnet, devi crearne una connessione diretta con loro. **Questo si applica anche ai gateway Internet**. Non puoi passare attraverso una connessione di subnet per accedere a Internet, devi assegnare il gateway Internet alla tua subnet.

### VPC Peering

Il VPC peering consente di **connettere due o pi√π VPC insieme**, utilizzando IPV4 o IPV6, come se facessero parte della stessa rete.

Una volta stabilita la connettivit√† tra i peer, **le risorse in una VPC possono accedere alle risorse nell'altra**. La connettivit√† tra le VPC √® implementata attraverso l'infrastruttura di rete esistente di AWS ed √® quindi altamente disponibile senza restrizioni sulla larghezza di banda. Poich√© **le connessioni peer operano come se facessero parte della stessa rete**, ci sono restrizioni per quanto riguarda i blocchi CIDR che possono essere utilizzati.\
Se hai **blocchi CIDR sovrapposti o duplicati** per le tue VPC, allora **non sarai in grado di collegare le VPC tra loro**.\
Ogni VPC AWS **comunicher√† solo con il suo peer**. Ad esempio, se hai una connessione di peering tra VPC 1 e VPC 2 e un'altra connessione tra VPC 2 e VPC 3 come mostrato, allora VPC 1 e 2 potrebbero comunicare direttamente tra loro, cos√¨ come VPC 2 e VPC 3, tuttavia VPC 1 e VPC 3 non potrebbero farlo. **Non puoi instradare attraverso una VPC per raggiungere un'altra.**

### **VPC Flow Logs**

All'interno della tua VPC, potresti avere potenzialmente centinaia o addirittura migliaia di risorse che comunicano tra diverse subnet, sia pubbliche che private, e anche tra diverse VPC tramite connessioni di peering VPC. **I VPC Flow Logs ti consentono di acquisire informazioni sul traffico IP che fluisce tra le interfacce di rete delle tue risorse all'interno della tua VPC**.

A differenza dei log di accesso S3 e dei log di accesso CloudFront, i **dati di log generati dai VPC Flow Logs non vengono archiviati in S3. Invece, i dati di log catturati vengono inviati ai log di CloudWatch**.

Limitazioni:

* Se stai eseguendo una connessione di peering VPC, potrai vedere solo i log di flusso delle VPC collegate che si trovano nello stesso account.
* Se stai ancora eseguendo risorse nell'ambiente EC2-Classic, purtroppo non sarai in grado di recuperare informazioni dalle loro interfacce.
* Una volta creato un VPC Flow Log, non pu√≤ essere modificato. Per modificare la configurazione del VPC Flow Log, √® necessario eliminarlo e quindi crearne uno nuovo.
* Il traffico seguente non viene monitorato e catturato dai log: traffico DHCP all'interno della VPC, traffico dalle istanze destinato al server DNS di Amazon.
* Qualsiasi traffico destinato all'indirizzo IP del router predefinito della VPC e traffico da e verso gli indirizzi seguenti: 169.254.169.254, utilizzato per raccogliere i metadati dell'istanza, e 169.254.169.123, utilizzato per il servizio di sincronizzazione dell'ora di Amazon.
* Traffico relativo a una licenza di attivazione di Windows Amazon da un'istanza Windows.
* Traffico tra un'interfaccia del bilanciamento del carico di rete e un'interfaccia di rete di destinazione.

Per ogni interfaccia di rete che pubblica dati nel gruppo di log di CloudWatch, verr√† utilizzato un flusso di log diverso. E all'interno di ciascuno di questi flussi, ci saranno i dati degli eventi di log di flusso che mostrano il contenuto delle voci di log. Ciascuno di questi **log acquisisce dati durante una finestra di circa 10-15 minuti**.

## VPN

### Componenti di base di AWS VPN

1. **Customer Gateway**:
* Un Customer Gateway √® una risorsa che crei in AWS per rappresentare il tuo lato di una connessione VPN.
* √à essenzialmente un dispositivo fisico o un'applicazione software sul tuo lato della connessione VPN da sito a sito.
* Fornisci informazioni di routing e l'indirizzo IP pubblico del tuo dispositivo di rete (come un router o un firewall) ad AWS per creare un Customer Gateway.
* Serve come punto di riferimento per la configurazione della connessione VPN e non comporta costi aggiuntivi.
2. **Virtual Private Gateway**:
* Un Virtual Private Gateway (VPG) √® il concentratore VPN sul lato Amazon della connessione VPN da sito a sito.
* √à collegato alla tua VPC e serve come destinazione per la tua connessione VPN.
* VPG √® il punto di accesso lato AWS per la connessione VPN.
* Gestisce la comunicazione sicura tra la tua VPC e la tua rete in loco.
3. **Connessione VPN da sito a sito**:
* Una connessione VPN da sito a sito collega la tua rete in loco a una VPC tramite un tunnel VPN IPsec sicuro.
* Questo tipo di connessione richiede un Customer Gateway e un Virtual Private Gateway.
* Viene utilizzato per la comunicazione sicura, stabile e coerente tra il tuo data center o la tua rete e il tuo ambiente AWS.
* Di solito utilizzato per connessioni regolari a lungo termine e viene fatturato in base alla quantit√† di dati trasferiti sulla connessione.
4. **Endpoint VPN per clienti**:
* Un endpoint VPN per clienti √® una risorsa che crei in AWS per abilitare e gestire le sessioni VPN per clienti.
* Viene utilizzato per consentire a dispositivi individuali (come laptop, smartphone, ecc.) di connettersi in modo sicuro alle risorse AWS o alla tua rete in loco.
* Si differenzia dalla VPN da sito a sito in quanto √® progettato per clienti individuali anzich√© per connettere intere reti.
* Con Client VPN, ogni dispositivo client utilizza un software client VPN per stabilire una connessione sicura.

### VPN da sito a sito

**Collega la tua rete in loco alla tua VPC.**

* **Connessione VPN**: una connessione sicura tra il tuo equipaggiamento in loco e le tue VPC.
* **Tunnel VPN**: un collegamento crittografato in cui i dati possono passare dalla rete del cliente ad AWS e viceversa.

Ogni connessione VPN include due tunnel VPN che √® possibile utilizzare contemporaneamente per garantire l'alta disponibilit√†.
* **Customer gateway**: una risorsa AWS che fornisce informazioni ad AWS sul dispositivo del gateway del cliente.
* **Dispositivo del gateway del cliente**: un dispositivo fisico o un'applicazione software sul tuo lato della connessione VPN da sito a sito.
* **Virtual private gateway**: il concentratore VPN sul lato Amazon della connessione VPN da sito a sito. Utilizzi un gateway privato virtuale o un gateway di transito come gateway per il lato Amazon della connessione VPN da sito a sito.
* **Gateway di transito**: un hub di transito che pu√≤ essere utilizzato per interconnettere le tue VPC e le reti in loco. Utiliz
#### Limitazioni

* Il traffico IPv6 non √® supportato per le connessioni VPN su un gateway privato virtuale.
* Una connessione VPN AWS non supporta la scoperta del percorso MTU.

Inoltre, prendi in considerazione quanto segue quando utilizzi una VPN da sito a sito.

* Quando colleghi le tue VPC a una rete locale comune, ti consigliamo di utilizzare blocchi CIDR non sovrapposti per le tue reti.

### Client VPN <a href="#what-is-components" id="what-is-components"></a>

**Connettiti dal tuo computer alla tua VPC**

#### Concetti

* **Endpoint Client VPN:** La risorsa che crei e configuri per abilitare e gestire le sessioni VPN del client. √à la risorsa in cui vengono terminate tutte le sessioni VPN del client.
* **Rete di destinazione:** Una rete di destinazione √® la rete che associ a un endpoint Client VPN. **Una subnet di una VPC √® una rete di destinazione**. Associare una subnet a un endpoint Client VPN consente di stabilire sessioni VPN. Puoi associare pi√π subnet a un endpoint Client VPN per l'alta disponibilit√†. Tutte le subnet devono appartenere alla stessa VPC. Ogni subnet deve appartenere a una diversa zona di disponibilit√†.
* **Percorso**: Ogni endpoint Client VPN ha una tabella di routing che descrive i percorsi di rete di destinazione disponibili. Ogni percorso nella tabella di routing specifica il percorso per il traffico verso risorse o reti specifiche.
* **Regole di autorizzazione:** Una regola di autorizzazione **limita gli utenti che possono accedere a una rete**. Per una rete specifica, configuri il gruppo Active Directory o il provider di identit√† (IdP) che ha accesso consentito. Solo gli utenti appartenenti a questo gruppo possono accedere alla rete specificata. **Per impostazione predefinita, non ci sono regole di autorizzazione** e devi configurare le regole di autorizzazione per consentire agli utenti di accedere alle risorse e alle reti.
* **Client:** L'utente finale che si connette all'endpoint Client VPN per stabilire una sessione VPN. Gli utenti finali devono scaricare un client OpenVPN e utilizzare il file di configurazione del client VPN che hai creato per stabilire una sessione VPN.
* **Intervallo CIDR del client:** Un intervallo di indirizzi IP da cui assegnare gli indirizzi IP del client. Ogni connessione all'endpoint Client VPN viene assegnato un indirizzo IP univoco dall'intervallo CIDR del client. Scegli l'intervallo CIDR del client, ad esempio `10.2.0.0/16`.
* **Porte del client VPN:** AWS Client VPN supporta le porte 443 e 1194 sia per TCP che per UDP. Il valore predefinito √® la porta 443.
* **Interfacce di rete del client VPN:** Quando associ una subnet al tuo endpoint Client VPN, creiamo interfacce di rete del client VPN in quella subnet. **Il traffico inviato alla VPC dall'endpoint Client VPN viene inviato tramite un'interfaccia di rete del client VPN**. Viene quindi applicata la traduzione degli indirizzi IP di origine della rete di origine (SNAT), in cui l'indirizzo IP di origine dall'intervallo CIDR del client viene tradotto nell'indirizzo IP dell'interfaccia di rete del client VPN.
* **Registrazione delle connessioni:** Puoi abilitare la registrazione delle connessioni per il tuo endpoint Client VPN per registrare gli eventi di connessione. Puoi utilizzare queste informazioni per eseguire analisi forensi, analizzare come viene utilizzato il tuo endpoint Client VPN o risolvere problemi di connessione.
* **Portale self-service:** Puoi abilitare un portale self-service per il tuo endpoint Client VPN. I client possono accedere al portale basato sul web utilizzando le proprie credenziali e scaricare l'ultima versione del file di configurazione dell'endpoint Client VPN o l'ultima versione del client fornito da AWS.

#### Limitazioni

* **Gli intervalli CIDR del client non possono sovrapporsi con il CIDR locale** della VPC in cui si trova la subnet associata o con eventuali percorsi aggiunti manualmente alla tabella di routing dell'endpoint Client VPN.
* Gli intervalli CIDR del client devono avere una dimensione di blocco di almeno /22 e non devono essere superiori a /12.
* Una **porzione degli indirizzi** nell'intervallo CIDR del client viene utilizzata per **supportare il modello di disponibilit√†** dell'endpoint Client VPN e non pu√≤ essere assegnata ai client. Pertanto, ti consigliamo di **assegnare un blocco CIDR che contenga il doppio del numero di indirizzi IP richiesti** per abilitare il numero massimo di connessioni simultanee che prevedi di supportare sull'endpoint Client VPN.
* L'**intervallo CIDR del client non pu√≤ essere modificato** dopo la creazione dell'endpoint Client VPN.
* Le **subnet** associate a un endpoint Client VPN **devono trovarsi nella stessa VPC**.
* **Non puoi associare pi√π subnet della stessa zona di disponibilit√† a un endpoint Client VPN**.
* Un endpoint Client VPN **non supporta associazioni di subnet in una VPC a tenancy dedicato**.
* Il client VPN supporta solo il traffico **IPv4**.
* Il client VPN **non √® conforme agli standard Federal Information Processing Standards (FIPS)**.
* Se l'autenticazione a pi√π fattori (MFA) √® disabilitata per la tua Active Directory, una password utente non pu√≤ essere nel seguente formato.

```
SCRV1:<stringa_codificata_in_base64>:<stringa_codificata_in_base64>
```
* Il portale self-service **non √® disponibile per i client che si autenticano utilizzando l'autenticazione reciproca**.

<details>

<summary><strong>Impara l'hacking AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
