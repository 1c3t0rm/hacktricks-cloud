# AWS - VPC & 网络基础信息

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## AWS 网络简介

一个 **VPC** 包含一个 **网络CIDR**，如10.0.0.0/16（带有其**路由表**和**网络ACL**）。

这个VPC网络被划分为**子网**，所以一个**子网**直接与**VPC**、**路由表**和**网络ACL**相关联。

然后，连接到服务（如EC2实例）的**网络接口**连接到带有**安全组**的**子网**。

因此，**安全组**将限制使用它的网络**接口**的暴露端口，**独立于子网**。而**网络ACL**将**限制**暴露给**整个网络**的端口。

此外，为了**访问互联网**，有一些有趣的配置需要检查：

* 一个**子网**可以**自动分配公共IPv4地址**
* 在自动分配IPv4地址的网络中创建的**实例**可以获得一个
* 需要将**互联网网关**连接到**VPC**
* 您还可以使用**仅出口互联网网关**
* 您还可以在**私有子网**中拥有一个**NAT网关**，以便从该私有子网**连接到外部服务**，但**无法从外部到达它们**。
* NAT网关可以是**公共的**（访问互联网）或**私有的**（访问其他VPC）

![](<../../../../.gitbook/assets/image (73).png>)

## VPC

Amazon **虚拟私有云**（Amazon VPC）使您能够**将AWS资源启动到您定义的虚拟网络中**。这个虚拟网络将拥有多个子网、访问互联网的互联网网关、ACLs、安全组、IP等...

### 子网

子网有助于加强安全级别。**逻辑分组类似资源**也有助于您在基础设施中保持**易于管理**。

* 有效的CIDR从/16网掩码到/28网掩码。
* 子网不能同时位于不同的可用区。
* **AWS保留每个子网的前三个主机IP地址**供**内部AWS使用**：第一个使用的主机地址是VPC路由器。第二个地址保留给AWS DNS，第三个地址保留给将来使用。
* **公共子网**是指那些可以**直接访问互联网的子网**，而私有子网则不能。

<figure><img src="https://lh5.googleusercontent.com/N_WTrTrDAHwN61FMKJvLSHVua2EM0IazHH1fSTg8JQfTChm-dLN9mn7wkjz2MlpD-uOUqtWdMZpqKOp4VxaHy5-5X66GD1K8y1UGc27r-GbHdFty9ImpXdcjEsC7u4vjxKme_B_HwDOUnG6camxENYECTw=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh3.googleusercontent.com/MmjfVzGmV4jM7tO8lVoTKONoeqbq6E40DGeKUoo4kN-lmMDKnEiGNB-gGVx3EvjK9UV844im225CA8aAjomHf1Modt3MramHrHZdEGbeSZncWhVuT9R8f7tQZ2pXjdSJxeNfErmJ-0mmcUaV6dcU0TAd2A=s2048" alt=""><figcaption></figcaption></figure>

### 路由表

路由表决定了VPC内子网的流量路由。它们决定哪些网络流量被转发到互联网或VPN连接。您通常会发现可以访问：

* 本地VPC
* NAT
* 互联网网关/仅出口互联网网关（需要给VPC访问互联网）。
* 为了使子网公开，您需要**创建**并**连接**一个**互联网网关**到您的VPC。
* VPC端点（从私有网络访问S3）

在以下图片中，您可以检查默认公共网络和私有网络的区别：

<figure><img src="https://lh3.googleusercontent.com/q4ASpcLAYqijdNMLhMLl8EoowDtTMU5I_7YCVfk7-5hxDyeQOik9ImHnD2SYy32XUA2qXjEbXTAxA1lP--znJASdhYOdBveDcrD42f9XBKZ3EmjJCazN3YPLC6oS0xtRMmfORuwCszmMt-KrAkH07_izwg=s2048" alt=""><figcaption></figcaption></figure>

<figure><img src="https://lh5.googleusercontent.com/30psylXAI0gRN6_LK-reP00aGIlMma64E1qafCVPunn6nS-y5jAO6Y2JiempKcf6-LFi7ScicYcOh7BbHEya2VWtksnFX_8SPXQf97tKkg2tNZzrArWbiDCCn2m2LP1QUq6MZ_KayH3yir7t8zpO7CEQOw=s2048" alt=""><figcaption></figcaption></figure>

### ACLs

**网络访问控制列表（ACLs）**：网络ACL是控制进出子网网络流量的防火墙规则。它们可以用来允许或拒绝特定IP地址或范围的流量。

* 最常见的是使用安全组允许/拒绝访问，但这是完全切断已建立的反向shell的唯一方法。安全组中的修改规则不会停止已经建立的连接
* 然而，这适用于整个子网，禁止东西时要小心，因为可能会扰乱所需的功能

### 安全组

安全组是一个虚拟**防火墙**，控制进出VPC中实例的网络**流量**。关系1 SG到M实例（通常是1对1）。\
通常这用于在实例中打开危险端口，例如端口22：

<figure><img src="https://lh5.googleusercontent.com/LliB7eb3cYfkEyOpyw1-eYgWsn2kq1yF6uRn5VYndvOuTvDlURimYx9UvuK8F2impTLmx50mid4MdTXE-Ljt2i_rxaIfnKUdji_hFjCdU9tdoW-axng9-W4tSL71gbbjrPQ7IYY5lAdH_G3UoMRMGGGOxQ=s2048" alt=""><figcaption></figcaption></figure>

### 弹性IP地址

_弹性IP地址_ 是为动态云计算设计的**静态IPv4地址**。弹性IP地址分配给您的AWS账户，并且是您的，直到您释放它。通过使用弹性IP地址，您可以通过快速重新映射地址到您账户中的另一个实例，来掩盖实例或软件的故障。

### 子网间连接

默认情况下，所有子网都关闭了**自动分配公共IP地址**的功能，但可以打开。

**路由表中的本地路由允许VPC子网之间的通信。**

如果您**连接一个子网与不同的子网，您无法访问与其他子网连接的子网**，您需要直接与它们建立连接。**这也适用于互联网网关**。您不能通过子网连接访问互联网，您需要将互联网网关分配给您的子网。

### VPC 对等连接

VPC对等连接允许您**将两个或更多的VPC连接在一起**，使用IPV4或IPV6，就像它们是同一个网络的一部分。

一旦建立了对等连接，**一个VPC中的资源就可以访问另一个VPC中的资源**。VPC之间的连接是通过现有的AWS网络基础设施实现的，因此它具有高可用性，没有带宽瓶颈。由于**对等连接的操作就像它们是同一个网络的一部分**，所以在您可以使用的CIDR块范围方面有限制。\
如果您的VPC有**重叠或重复的CIDR**范围，那么**您将无法将VPC对等连接在一起**。\
每个AWS VPC将**只与其对等方通信**。例如，如果您在VPC 1和VPC 2之间建立了对等连接，并且在VPC 2和VPC 3之间建立了另一个连接，那么VPC 1和2可以直接相互通信，VPC 2和VPC 3也可以，但是，VPC 1和VPC 3不能。**您不能通过一个VPC路由到另一个VPC。**

### **VPC 流日志**

在您的VPC中，您可能有数百甚至数千个资源在不同的公共和私有子网之间以及通过VPC对等连接在不同VPC之间通信。**VPC流日志允许您捕获在VPC内您的资源的网络接口之间流动的IP流量信息**。

与S3访问日志和CloudFront访问日志不同，**VPC流日志生成的日志数据不存储在S3中。相反，捕获的日志数据发送到CloudWatch日志**。

限制：

* 如果您正在运行VPC对等连接，那么您只能看到同一个账户内对等VPC的流日志。
* 如果您仍在EC2-Classic环境中运行资源，那么不幸的是您无法检索它们接口的信息
* 一旦创建了VPC流日志，就无法更改。要更改VPC流日志配置，您需要删除它，然后重新创建一个新的。
* 以下流量不会被日志监控和捕获。VPC内的DHCP流量，从实例到Amazon DNS服务器的流量。
* 任何目的地是VPC默认路由器IP地址的流量以及到以下地址的流量，169.254.169.254用于收集实例元数据，169.254.169.123用于Amazon时间同步服务。
* 与Amazon Windows激活许可证相关的Windows实例的流量
* 与网络负载均衡器接口和端点网络接口之间的流量

对于每个将数据发布到CloudWatch日志组的网络接口，它将使用不同的日志流。在每个流中，将有流日志事件数据，显示日志条目的内容。每个**日志在大约10到15分钟的窗口期间捕获数据**。

## VPN

### 基本的AWS VPN组件

1. **客户网关**：
* 客户网关是您在AWS中创建的资源，代表您的VPN连接的一侧。
* 它本质上是您的站点到站点VPN连接一侧的物理设备或软件应用程序。
* 您向AWS提供路由信息和您的网络设备（如路由器或防火墙）的公共IP地址来创建客户网关。
* 它作为设置VPN连接的参考点，并不会产生额外费用。
2. **虚拟私有网关**：
* 虚拟私有网关（VPG）是站点到站点VPN连接Amazon一侧的VPN集中器。
* 它连接到您的VPC，并作为您的VPN连接的目标。
* VPG是VPN连接Amazon一侧的端点。
* 它处理您的VPC和您的本地网络之间的安全通信。
3. **站点到站点VPN连接**：
* 站点到站点VPN连接通过安全的IPsec VPN隧道将您的本地网络连接到VPC。
* 这种类型的连接需要客户网关和虚拟私有网关。
* 它用于在您的数据中心或网络与您的AWS环境之间进行安全、稳定和一致的通信。
* 通常用于常规的长期连接，并根据连接上的数据传输量收费。
4. **客户VPN端点**：
* 客户VPN端点是您在AWS中创建的资源，用于启用和管理客户VPN会话。
* 它用于允许个人设备（如笔记本电脑、智能手机等）安全地连接到AWS资源或您的本地网络。
* 它与站点到站点VPN不同，因为它是为个别客户端设计的，而不是连接整个网络。
* 使用客户VPN时，每个客户端设备都使用VPN客户端软件建立安全连接。

### 站点到站点VPN

**将您的本地网络与您的VPC连接。**

* **VPN连接**：您的本地设备和VPC之间的安全连接。
*   **VPN隧道**：一个加密的链接，数据可以通过它从客户网络传输到或来自AWS。

每个VPN连接包括两个VPN隧道，您可以同时使用它们以实现高可用性。
* **客户网关**：一个AWS资源，向AWS提供有关您的客户网关设备的信息。
* **客户网关设备**：站点到站点VPN连接一侧的物理设备或软件应用程序。
* **虚拟私有网关**：站点到站点VPN连接Amazon一侧的VPN集中器。您使用虚拟私有网关或传输网关作为站点到站点VPN连接Amazon一侧的网关。
* **传输网关**：一个传输中心，可用于互连您的VPC和本地网络。您使用传输网关或虚拟私有网关作为站点到站点VPN连接Amazon一侧的网关。

#### 限制

* 虚拟私有网关上的VPN连接不支持IPv6流量。
* AWS VPN连接不支持
