# AWS - IAM рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВ.

</details>

## IAM

IAM рдПрдХреНрд╕реЗрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

{% content-ref url="../../aws-security/aws-services/aws-iam-enum.md" %}
[aws-iam-enum.md](../../aws-security/aws-services/aws-iam-enum.md)
{% endcontent-ref %}

## Confused Deputy Problem

рдпрджрд┐ рдЖрдк **рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A)** рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ **рд░реЛрд▓** рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╢рд╛рдпрдж **0 рджреГрд╢реНрдпрддрд╛** рд╣реЛрдЧреА рдХрд┐ **рдХреМрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЙрд╕ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ**. рдпрд╣ рдПрдХ рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдХреЛрдИ рдЕрдиреНрдп рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (B) рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ (A) рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **B рднреА рдЖрдкрдХреЗ рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИ**.

рдЗрд╕рд▓рд┐рдП, рдЬрдм рдЖрдк рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рдХреЛ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк `ExternalId` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ. рдпрд╣ рдПрдХ "рдЧреБрдкреНрдд" рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИ рдЬрд┐рд╕реЗ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ (A) **рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ** рддрд╛рдХрд┐ **рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рдореЗрдВ рд░реЛрд▓ рдХреЛ рдорд╛рди рд▓рд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**. рдЪреВрдВрдХрд┐ **рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ B рдЗрд╕ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдирд╣реАрдВ рдЬрд╛рдирддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЙрд╕рдХреЗ рдкрд╛рд╕ A рдкрд░ рдкрд╣реБрдВрдЪ рд╣реИ рддреЛ рднреА рд╡рд╣ **рдЖрдкрдХреЗ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реЛрдЧрд╛**.

<figure><img src="../../../.gitbook/assets/image (1) (7).png" alt=""><figcaption></figcaption></figure>

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ `ExternalId` "рдЧреБрдкреНрдд" **рдПрдХ рдЧреБрдкреНрдд рдирд╣реАрдВ рд╣реИ**, рдЬреЛ рдХреЛрдИ рднреА **IAM рдЕрд╕реНрдпреВрдо рд░реЛрд▓ рдкреЙрд▓рд┐рд╕реА рдХреЛ рдкрдврд╝ рд╕рдХрддрд╛ рд╣реИ рд╡рд╣ рдЗрд╕реЗ рджреЗрдЦ рд╕рдХрддрд╛ рд╣реИ**. рд▓реЗрдХрд┐рди рдЬрдм рддрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ A рдЗрд╕реЗ рдЬрд╛рдирддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдмрд╛рд╣рд░реА рдЦрд╛рддрд╛ **B рдЗрд╕реЗ рдирд╣реАрдВ рдЬрд╛рдирддрд╛ рд╣реИ**, рдпрд╣ **B рдХреЛ A рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдкрдХреЗ рд░реЛрд▓ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ**.

рдЙрджрд╛рд╣рд░рдг:
```json
{
"Version": "2012-10-17",
"Statement": {
"Effect": "Allow",
"Principal": {
"AWS": "Example Corp's AWS Account ID"
},
"Action": "sts:AssumeRole",
"Condition": {
"StringEquals": {
"sts:ExternalId": "12345"
}
}
}
}
```
{% hint style="warning" %}
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рд▓рд┐рдП рдПрдХ рднреНрд░рдорд┐рдд рдбреЗрдкреНрдпреБрдЯреА рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЙрд╕реЗ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╡рд░реНрддрдорд╛рди рдЦрд╛рддреЗ рдХреЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕ рджреВрд╕рд░реЗ рдЦрд╛рддреЛрдВ рдореЗрдВ рд░реЛрд▓реНрд╕ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### рдЕрдирдкреЗрдХреНрд╖рд┐рдд рд╡рд┐рд╢реНрд╡рд╛рд╕

#### рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб
```json
{
"Action": "sts:AssumeRole",
"Effect": "Allow",
"Principal": { "AWS": "*" },
}
```
рдпрд╣ рдиреАрддрд┐ **рд╕рднреА AWS рдХреЛ** рднреВрдорд┐рдХрд╛ рдЧреНрд░рд╣рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

#### рд╕реЗрд╡рд╛ рдореБрдЦреНрдп рд░реВрдк рдореЗрдВ
```json
{
"Action": "lambda:InvokeFunction",
"Effect": "Allow",
"Principal": { "Service": "apigateway.amazonaws.com" },
"Resource": "arn:aws:lambda:000000000000:function:foo"
}
```
рдпрд╣ рдиреАрддрд┐ **рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ** рдЕрдкрдиреЗ apigateway рдХреЛ рдЗрд╕ Lambda рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

#### S3 рдХреЛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ
```json
"Condition": {
"ArnLike": { "aws:SourceArn": "arn:aws:s3:::source-bucket" },
"StringEquals": {
"aws:SourceAccount": "123456789012"
}
}
```
рдпрджрд┐ рдПрдХ S3 рдмрдХреЗрдЯ рдХреЛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ S3 рдмрдХреЗрдЯреНрд╕ рдХреЗ рдкрд╛рд╕ рдПрдХ Account ID рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рдЕрдЧрд░ рдЖрдкрдиреЗ **рдЕрдкрдирд╛ рдмрдХреЗрдЯ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдиреЗ** рдЗрд╕реЗ рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдмрдирд╛ рд▓рд┐рдпрд╛, рддреЛ рд╡реЗ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИ
```json
{
"Effect": "Allow",
"Principal": {"Service": "cloudtrail.amazonaws.com"},
"Action": "s3:PutObject",
"Resource": "arn:aws:s3:::myBucketName/AWSLogs/MY_ACCOUNT_ID/*"
}
```
Confused Deputy рд╕рдорд╕реНрдпрд╛рдУрдВ рд╕реЗ рдмрдЪрдиреЗ рдХрд╛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ `AWS:SourceArn` рдХреЗ рд╕рд╛рде рдПрдХ рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ рдЬреЛ рдореВрд▓ ARN рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдХреБрдЫ рд╕реЗрд╡рд╛рдПрдВ рдЗрд╕рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА рд╣реИрдВ** (рдЬреИрд╕реЗ рдХрд┐ рдХреБрдЫ рд╕реНрд░реЛрддреЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░ CloudTrail).

## рд╕рдВрджрд░реНрдн

* [https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рдореБрдЭреЗ рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
