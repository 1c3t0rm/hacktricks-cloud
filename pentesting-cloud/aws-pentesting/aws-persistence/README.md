# AWS - QI'yaH

---

## Introduction

In this section, we will explore various techniques for achieving persistence in AWS environments. Persistence refers to the ability to maintain access and control over a compromised system or network even after a reboot or other system changes. By establishing persistence, an attacker can ensure continued access to the target environment, allowing for further exploitation and data exfiltration.

## Table of Contents

- [Introduction](#introduction)
- [User Data Scripts](#user-data-scripts)
- [Lambda Functions](#lambda-functions)
- [Scheduled Tasks](#scheduled-tasks)
- [CloudFormation Templates](#cloudformation-templates)
- [Instance Metadata Service](#instance-metadata-service)
- [Conclusion](#conclusion)

---

## User Data Scripts

User Data Scripts are commonly used in AWS to automate the configuration of instances during launch. These scripts can be leveraged by an attacker to achieve persistence by modifying the script to include backdoor functionality. By injecting malicious code into the User Data Script, an attacker can ensure that the code is executed every time the instance is launched or rebooted.

To exploit this technique, an attacker needs to gain access to the User Data configuration of the target instance. This can be achieved through various means, such as compromising the AWS management console, exploiting misconfigurations, or leveraging other vulnerabilities.

Once access to the User Data configuration is obtained, the attacker can modify the script to include their desired backdoor functionality. This can involve adding a reverse shell, creating a new user with administrative privileges, or installing additional tools for persistence and further exploitation.

---

## Lambda Functions

AWS Lambda is a serverless computing service that allows users to run code without provisioning or managing servers. Lambda functions can be triggered by various events, such as changes to data in an S3 bucket or updates to a DynamoDB table. This makes Lambda functions an attractive target for achieving persistence in AWS environments.

To establish persistence using Lambda functions, an attacker can create a malicious Lambda function and configure it to execute on a regular schedule or in response to specific events. The function can be designed to perform various actions, such as maintaining a persistent connection to an external command and control server or exfiltrating sensitive data from the target environment.

To deploy the malicious Lambda function, the attacker needs to gain access to the AWS management console or leverage other means of compromising the target environment. Once the function is deployed, it will continue to execute as configured, allowing the attacker to maintain persistence and carry out further attacks.

---

## Scheduled Tasks

AWS provides a service called CloudWatch Events, which allows users to schedule automated actions in response to events in their AWS environment. This service can be leveraged by an attacker to achieve persistence by scheduling malicious actions to occur at specific times or in response to specific events.

To establish persistence using scheduled tasks, an attacker needs to gain access to the AWS management console or other means of compromising the target environment. Once access is obtained, the attacker can create a CloudWatch Event rule and configure it to trigger a Lambda function or other action at the desired time or in response to a specific event.

The scheduled task can be designed to perform various actions, such as executing a malicious script, exfiltrating data, or maintaining a persistent connection to an external server. By scheduling these actions, the attacker can ensure that they are executed even after system reboots or other changes.

---

## CloudFormation Templates

AWS CloudFormation is a service that allows users to define and provision AWS infrastructure as code. CloudFormation templates can be used to automate the deployment of resources in an AWS environment. This automation can be leveraged by an attacker to achieve persistence by modifying the CloudFormation template to include malicious actions.

To exploit this technique, an attacker needs to gain access to the CloudFormation template used to provision resources in the target environment. This can be achieved through various means, such as compromising the AWS management console, exploiting misconfigurations, or leveraging other vulnerabilities.

Once access to the CloudFormation template is obtained, the attacker can modify it to include their desired malicious actions. This can involve adding additional resources with backdoor functionality, modifying existing resources to enable persistence, or executing arbitrary commands during the deployment process.

---

## Instance Metadata Service

The AWS Instance Metadata Service (IMDS) is a service that provides temporary credentials and metadata about an EC2 instance. This service can be leveraged by an attacker to achieve persistence by exploiting misconfigurations or vulnerabilities in the way the IMDS is accessed.

To exploit the IMDS for persistence, an attacker needs to gain access to the EC2 instance or leverage other means of compromising the target environment. Once access is obtained, the attacker can interact with the IMDS to retrieve temporary credentials or modify the metadata associated with the instance.

By modifying the metadata, an attacker can configure the instance to execute arbitrary commands or scripts during the boot process. This can be used to establish persistence by ensuring that the malicious code is executed every time the instance is started or rebooted.

---

## Conclusion

Achieving persistence in AWS environments is crucial for an attacker to maintain access and control over a compromised system or network. By leveraging techniques such as User Data Scripts, Lambda Functions, Scheduled Tasks, CloudFormation Templates, and the Instance Metadata Service, an attacker can ensure continued access and carry out further exploitation and data exfiltration. It is important for organizations to be aware of these techniques and implement appropriate security measures to detect and mitigate them.
