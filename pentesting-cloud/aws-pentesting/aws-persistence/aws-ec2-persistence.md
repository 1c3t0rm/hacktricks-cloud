# AWS - EC2 永続性

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## EC2

詳細については以下をチェックしてください:

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### セキュリティグループ接続追跡による永続性

防御者が**EC2インスタンスが侵害された**と判断した場合、おそらくそのマシンの**ネットワークを隔離**しようとするでしょう。これは、**Deny NACL**（ただしNACLはサブネット全体に影響します）を明示的に使用するか、**セキュリティグループを変更して**、**あらゆる種類のインバウンドまたはアウトバウンド**トラフィックを許可しないことで行うことができます。

攻撃者が**マシンから発信されたリバースシェル**を持っていた場合、SGがインバウンドまたはアウトバウンドトラフィックを許可しないように変更されても、[**セキュリティグループ接続追跡**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)のため、**接続は切断されません**。

### EC2ライフサイクルマネージャー

このサービスは、**AMIとスナップショットの作成をスケジュール**し、さらに**他のアカウントと共有する**ことを可能にします。\
攻撃者は、すべてのイメージまたはすべてのボリュームの**AMIまたはスナップショットの生成を毎週**設定し、**自分のアカウントと共有する**ことができます。

### スケジュールされたインスタンス

インスタンスを毎日、毎週、または毎月実行するようにスケジュールすることが可能です。攻撃者は、高い権限を持つか興味深いアクセスを持つマシンを実行し、アクセスすることができます。

### スポットフリートリクエスト

スポットインスタンスは通常のインスタンスよりも**安価**です。攻撃者は、例えば**5年間の小規模なスポットフリートリクエスト**を**自動IP**割り当てと、スポットインスタンスが開始されたときと**IPアドレス**を攻撃者に送信する**ユーザーデータ**と、**高権限のIAMロール**を使用して起動することができます。

### バックドアインスタンス

攻撃者はインスタンスにアクセスし、バックドアを仕掛けることができます:

* 例えば従来の**ルートキット**を使用する
* 新しい**公開SSHキーを追加する**（[EC2権限昇格オプション](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)をチェック）
* **ユーザーデータをバックドアする**

### **バックドア起動設定**

* 使用されているAMIをバックドアする
* ユーザーデータをバックドアする
* キーペアをバックドアする

### VPN

攻撃者が直接VPCに接続できるようにVPNを作成します。

### VPCピアリング

被害者のVPCと攻撃者のVPCの間にピアリング接続を作成し、被害者のVPCにアクセスできるようにします。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
