# AWS - EC2 持久性

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## EC2

更多信息请查看：

{% content-ref url="../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-security/aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### 安全组连接跟踪持久性

如果防御者发现**EC2实例被入侵**，他可能会尝试**隔离**机器的**网络**。他可以通过显式**拒绝NACL**来做到这一点（但NACL会影响整个子网），或者**更改安全组**不允许**任何类型的入站或出站**流量。

如果攻击者有一个**起源于机器的反向Shell**，即使SG被修改为不允许入站或出站流量，**连接也不会因为** [**安全组连接跟踪**](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/security-group-connection-tracking.html)**而被终止。**

### EC2生命周期管理器

此服务允许**计划** **创建AMI和快照**，甚至可以**与其他账户共享**。\
攻击者可以配置**生成所有镜像或所有卷的AMI或快照**，**每周一次**，并**与他的账户共享**。

### 计划实例

可以安排实例每天、每周甚至每月运行。攻击者可以运行具有高权限或有趣访问权限的机器，他可以访问。

### Spot Fleet请求

Spot实例比常规实例**更便宜**。攻击者可以发起一个**小型Spot Fleet请求，为期5年**（例如），具有**自动IP**分配和一个**用户数据**，该数据在Spot实例启动时发送给攻击者**IP地址**，并具有**高权限的IAM角色**。

### 后门实例

攻击者可以访问实例并对其进行后门处理：

* 例如使用传统的**rootkit**
* 添加一个新的**公共SSH密钥**（查看 [EC2权限提升选项](../../aws-security/aws-privilege-escalation/aws-ec2-privesc.md)）
* 后门**用户数据**

### **后门启动配置**

* 后门使用的AMI
* 后门用户数据
* 后门密钥对

### VPN

创建VPN，攻击者将能够直接通过它连接到VPC。

### VPC对等连接

在受害者VPC和攻击者VPC之间创建对等连接，这样他就能够访问受害者VPC。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
