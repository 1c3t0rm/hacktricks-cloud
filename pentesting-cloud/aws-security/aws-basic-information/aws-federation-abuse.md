# AWS - Federation Abuse

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## SAML

For info about SAML please check:

{% embed url="https://book.hacktricks.xyz/pentesting-web/saml-attacks" %}

In order to configure an **Identity Federation through SAML** you just need to provide a **name** and the **metadata XML** containing all the SAML configuration (**endpoints**, **certificate** with public key)

## OIDC - Github Actions Abuse

In order to add a github action as Identity provider:

1. For _Provider type_, select **OpenID Connect**.
2. For _Provider URL_, enter `https://token.actions.githubusercontent.com`
3. Click on _Get thumbprint_ to get the thumbprint of the provider
4. For _Audience_, enter `sts.amazonaws.com`
5. Create a **new role** with the **permissions** the github action need and a **trust policy** that trust the provider like:
* ```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::0123456789:oidc-provider/token.actions.githubusercontent.com"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"token.actions.githubusercontent.com:sub": [
"repo:ORG_OR_USER_NAME/REPOSITORY:pull_request",
"repo:ORG_OR_USER_NAME/REPOSITORY:ref:refs/heads/main"
],
"token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
}
}
}
]
}
```
6. Note in the previous policy how only a **branch** from **repository** of an **organization** was authorized with a specific **trigger**.
7. The **ARN** of the **role** the github action is going to be able to **impersonate** is going to be the "secret" the github action needs to know, so **store** it inside a **secret** inside an **environment**.
8. Finally use a github action to configure the AWS creds to be used by the workflow:
```yaml
name: 'test AWS Access'

# The workflow should only trigger on pull requests to the main branch
on:
pull_request:
branches:
- main

# Required to get the ID Token that will be used for OIDC
permissions:
id-token: write
contents: read # needed for private repos to checkout

jobs:
aws:
runs-on: ubuntu-latest
steps:
- name: Checkout
uses: actions/checkout@v3

- name: Configure AWS Credentials
uses: aws-actions/configure-aws-credentials@v1
with:
aws-region: eu-west-1
role-to-assume: ${{ secrets.READ_ROLE }}
role-session-name: OIDCSession

- run: aws sts get-caller-identity
shell: bash
```
## OIDC - EKS Qap

### Introduction

In an Amazon Elastic Kubernetes Service (EKS) cluster, OpenID Connect (OIDC) is used to authenticate and authorize users. OIDC allows users to obtain temporary credentials from an identity provider (IdP) and use them to access the EKS cluster.

### Abuse Scenario

An attacker can abuse the OIDC functionality in EKS to gain unauthorized access to the cluster or perform malicious actions. This can be done by exploiting misconfigurations or vulnerabilities in the OIDC setup.

### Exploitation Steps

1. Identify the OIDC endpoint: The attacker needs to identify the OIDC endpoint used by the EKS cluster. This can be found in the EKS cluster configuration or by querying the AWS API.

2. Register a malicious application: The attacker registers a malicious application with the IdP, using the OIDC endpoint as the redirect URI. This allows the attacker to receive the authorization code and access token.

3. Obtain the authorization code: The attacker tricks a legitimate user into visiting the malicious application and logging in with their IdP credentials. The application captures the authorization code returned by the IdP.

4. Exchange the authorization code for an access token: The attacker exchanges the authorization code for an access token by making a request to the OIDC endpoint with the code and client credentials.

5. Access the EKS cluster: With the obtained access token, the attacker can authenticate to the EKS cluster and perform actions on behalf of the legitimate user.

### Mitigation

To mitigate OIDC abuse in EKS, follow these best practices:

- Secure the OIDC endpoint: Ensure that the OIDC endpoint is properly secured and accessible only to trusted entities.

- Implement strong authentication: Enforce strong authentication mechanisms, such as multi-factor authentication (MFA), for IdP logins.

- Monitor OIDC logs: Regularly monitor OIDC logs for any suspicious activity or unauthorized access attempts.

- Regularly update and patch: Keep the EKS cluster and associated components up to date with the latest security patches and updates.

- Limit permissions: Follow the principle of least privilege and grant only necessary permissions to users and applications.

By following these practices, you can reduce the risk of OIDC abuse in your EKS cluster.
```bash
# Crate an EKS cluster (~10min)
eksctl create cluster --name demo --fargate
```

```bash
# Create an Identity Provider for an EKS cluster
eksctl utils associate-iam-oidc-provider --cluster Testing --approve
```
**OIDC providers** jatlh **EKS** cluster vItlhutlh **OIDC URL** vItlhutlh **new Open ID Identity provider** ghaH. vaj vItlhutlh 'ej vItlhutlh **common default policy**.
```json
{
"Version": "2012-10-17",
"Statement": [
{
"Effect": "Allow",
"Principal": {
"Federated": "arn:aws:iam::123456789098:oidc-provider/oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B"
},
"Action": "sts:AssumeRoleWithWebIdentity",
"Condition": {
"StringEquals": {
"oidc.eks.us-east-1.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:aud": "sts.amazonaws.com"
}
}
}
]
}
```
vaj **EKS cluster** **id** `20C159CDF6F2349B68846BEC03BE031B` **role** **assume** **can** **only** **indicate** **correctly** **policy** **This**. **However**, **assume** **can** **role** **the** **service account with a web identity token** **ANY** **means** **that** **able to** **be** **going**.

**role** **assume** **able to** **should be** **account service** **which** **specify** **to order** **In**, **condition** **a** **specify** **to** **needed** **it's** **role** **assume** **the** **name account service** **the** **where** **condition** **a** **such as**:&#x20;

{% code overflow="wrap" %}
```bash
"oidc.eks.region-code.amazonaws.com/id/20C159CDF6F2349B68846BEC03BE031B:sub": "system:serviceaccount:default:my-service-account",
```
{% endcode %}

## References

* [https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/](https://www.eliasbrange.dev/posts/secure-aws-deploys-from-github-actions-with-oidc/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
