# AWS - KMS Enum

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## KMS - Key Management Service

AWS Key Management Service (AWS KMS) is presented as a managed service, simplifying the process for users to **create and manage customer master keys** (CMKs). These CMKs are integral in the encryption of user data. A notable feature of AWS KMS is that CMKs are predominantly **secured by hardware security modules** (HSMs), enhancing the protection of the encryption keys.

KMS uses **symmetric cryptography**. This is used to **encrypt information as rest** (for example, inside a S3). If you need to **encrypt information in transit** you need to use something like **TLS**.

KMS is a **region specific service**.

**Administrators at Amazon do not have access to your keys**. They cannot recover your keys and they do not help you with encryption of your keys. AWS simply administers the operating system and the underlying application it's up to us to administer our encryption keys and administer how those keys are used.

**Customer Master Keys** (CMK): Can encrypt data up to 4KB in size. They are typically used to create, encrypt, and decrypt the DEKs (Data Encryption Keys). Then the DEKs are used to encrypt the data.

A customer master key (CMK) is a logical representation of a master key in AWS KMS. In addition to the master key's identifiers and other metadata, including its creation date, description, and key state, a **CMK contains the key material which used to encrypt and decrypt data**. When you create a CMK, by default, AWS KMS generates the key material for that CMK. However, you can choose to create a CMK without key material and then import your own key material into that CMK.

There are 2 types of master keys:

* **AWS managed CMKs: Used by other services to encrypt data**. It's used by the service that created it in a region. They are created the first time you implement the encryption in that service. Rotates every 3 years and it's not possible to change it.
* **Customer manager CMKs**: Flexibility, rotation, configurable access and key policy. Enable and disable keys.

**Envelope Encryption** in the context of Key Management Service (KMS): Two-tier hierarchy system to **encrypt data with data key and then encrypt data key with master key**.

### Key Policies

These defines **who can use and access a key in KMS**.

By **default:**

*   It gives the **AWS account that owns the KMS key full access** to the KMS key.

Unlike other AWS resource policies, a AWS **KMS key policy does not automatically give permission to the account or any of its users**. To give permission to account administrators, the **key policy must include an explicit statement** that provides this permission, like this one.

* Without allowing the account(`"AWS": "arn:aws:iam::111122223333:root"`) IAM permissions won't work.
*   It **allows the account to use IAM policies** to allow access to the KMS key, in addition to the key policy.

**Without this permission, IAM policies that allow access to the key are ineffective**, although IAM policies that deny access to the key are still effective.
* It **reduces the risk of the key becoming unmanageable** by giving access control permission to the account administrators, including the account root user, which cannot be deleted.

**Default policy** example:
```json
{
"Sid": "Enable IAM policies",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::111122223333:root"
},
"Action": "kms:*",
"Resource": "*"
}
```
{% hint style="warning" %}
**QaStaHvIS** (`"arn:aws:iam::111122223333:root"`) **Hoch** **choHwI'** **IAM permissions** **QaStaHvIS** **KMS key** **vaj** **principal** **Hoch** **QaStaHvIS**. **'ej** **role** **ARN** **QaStaHvIS** **Key Policy** **allowed** **Hoch**, **role** **Hoch** **IAM permissions** **QaStaHvIS**.
{% endhint %}

<details>

<summary>Policy Details</summary>

**Policy** **Properties**:

* **JSON** **based** **document**
* **Resource** --> **Affected** **resources** (can be "\*")
* **Action** --> **kms:Encrypt**, **kms:Decrypt**, **kms:CreateGrant** ... (**permissions**)
* **Effect** --> **Allow/Deny**
* **Principal** --> **arn** **affected**
* **Conditions** (optional) --> **Condition** **permissions** **ghap**

**Grants**:

* **Allow** **delegate** **permissions** **AWS principal** **AWS account** **vaj**. **AWS KMS APIs** **vaj** **create**. **CMK identifier**, **grantee principal**, **required level** **opoeration** (Decrypt, Encrypt, GenerateDataKey...) **vaj** **indicated**.

**GrantToken** **GratID** **issued** **grants** **created** **after**.

**Access**:

* **key policy** **Via** -- **exist**, **precedent** **IAM policy** **over** **takes**
* **IAM policy** **Via**
* **grants** **Via**

</details>

### Key Administrators

**Key administrator** **default**:

* **KMS manage** **access** **not** **encrypt** **decrypt data**
* **IAM users** **roles** **added** **Key Administrators** **list** (**groups** **not**)
* **external CMK** **used**, **Key Administrators** **permission** **import key material**

### Rotation of CMKs

* **key** **same** **left** **place**, **data** **encrypted** **key**, **key** **breached**, **blast area** **data** **risk** **wider** **the**. **addition** **this**, **key** **active**, **probability** **breached** **increases**.
* **KMS rotate customer keys every 365 days** (or you can perform the process manually whenever you want) and **keys managed by AWS every 3 years** and this time it cannot be changed.
* **Older keys are retained** **decrypt data** **encrypted** **prior** **rotation**
* **break**, **rotating** **key** **won't remove** **threat** **possible** **decrypt** **data** **encrypted** **compromised key**. **However**, **new data** **encrypted** **new key**.
* **CMK** **state** **disabled** **pending** **deletion**, **KMS** **perform** **key rotation** **CMK** **re-enabled** **deletion** **cancelled** **not**.

#### Manual rotation

* **CMK** **new** **created**, **CMK-ID** **new** **created**, **update** **need** **application** **reference** **CMK-ID** **new**.
* **process** **easier** **use aliases** **refer** **key-id** **update** **key** **alias** **referring**.
* **old keys** **decrypt old files** **encrypted** **with**.

**import keys** **on-premises key infrastructure** **You** **can**.

### Other relevant KMS information

**KMS** **priced** **number** **encryption/decryption requests** **received** **services** **per month**.

**KMS** **full audit** **compliance integration with CloudTrail**; **audit** **changes** **performed** **KMS** **can**.

**KMS policy** **do** **following**:

* **Limit** **create data keys** **services** **access** **use** **keys**
* **Limit** **systems access** **encrypt only**, **decrypt only** **both**
* **Define** **enable systems access** **keys** **regions** (**recommended** **not** **although** **failure** **region** **hosting KMS** **affect** **availability** **systems** **regions**).

**synchronize** **move/copy keys** **regions** **You** **define** **rules** **allow access** **region** **only**.

### Enumeration
```bash
aws kms list-keys
aws kms list-key-policies --key-id <id>
aws kms list-grants --key-id <id>
aws kms describe-key --key-id <id>
aws kms get-key-policy --key-id <id> --policy-name <name> # Default policy name is "default"
aws kms describe-custom-key-stores
```
### Privesc

{% content-ref url="../aws-privilege-escalation/aws-kms-privesc.md" %}
[aws-kms-privesc.md](../aws-privilege-escalation/aws-kms-privesc.md)
{% endcontent-ref %}

### Post Exploitation

{% content-ref url="../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md" %}
[aws-kms-post-exploitation.md](../../aws-pentesting/aws-post-exploitation/aws-kms-post-exploitation.md)
{% endcontent-ref %}

### Persistence

{% content-ref url="../../aws-pentesting/aws-persistence/aws-kms-persistence.md" %}
[aws-kms-persistence.md](../../aws-pentesting/aws-persistence/aws-kms-persistence.md)
{% endcontent-ref %}

## References

* [https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html](https://docs.aws.amazon.com/kms/latest/developerguide/key-policy-default.html)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
