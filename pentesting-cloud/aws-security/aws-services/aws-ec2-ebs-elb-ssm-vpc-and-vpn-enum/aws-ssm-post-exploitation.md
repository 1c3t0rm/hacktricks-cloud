# AWS - Post-Explotación de SSM

<details>

<summary><strong>Aprende hacking de AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## MitM SSM

### Interceptar Mensajes de SSM Enviados a una Instancia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Con **acceso a las credenciales IAM de una instancia EC2**, puedes interceptar mensajes de EC2 y sesiones de SSM debido al manejo de autenticación de SSM.

El [**Agente de SSM**](https://github.com/aws/amazon-ssm-agent) llama continuamente a **`ec2messages:GetMessages`**, manteniendo la **conexión abierta** durante **20 segundos**. Si se envía un mensaje, como a través de [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), se recibe a través de esta conexión abierta.

Un **atacante** puede interceptar mensajes de EC2 llamando a **`ec2messages:GetMessages`** con más frecuencia. Este [**prueba de concepto**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) demuestra esto escuchando mensajes de send-command. El atacante también puede **enviar cualquier respuesta** que desee a los mensajes.

El atacante también podría **enviar cualquier respuesta** que desee a los mensajes.

### Interceptar Mensajes de Sesión de SSM

Esto es más complejo, involucra múltiples conexiones WebSocket y un protocolo binario único. Cuando el **Agente de SSM se inicia**, **crea** una conexión **WebSocket** con AWS. Cuando un usuario inicia una sesión de SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), el **canal de control inicia un canal de datos** para la comunicación entre el usuario y la instancia EC2.

El código fuente del Agente de SSM, disponible [aquí](https://github.com/aws/amazon-ssm-agent), puede usarse para crear los mensajes en el formato binario, como [esto](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar Sesiones de SSM es más fiable que los mensajes de EC2** ya que los **canales de control son de larga duración** y AWS solo se comunica con el **más reciente**. Esta [prueba de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) muestra cómo crear un canal de control e interactuar con la sesión.

Desde una perspectiva de abuso, **interceptar Sesiones de SSM es más fiable que los mensajes de EC2**. La razón de esto es que los **canales de control son de larga duración**, y al igual que con los mensajes de EC2, AWS solo se comunicará con el **más reciente**. Como resultado, podemos crear nuestro propio canal de control y escuchar las sesiones entrantes. Usando el código fuente del Agente de SSM, podemos crear los mensajes en el formato binario (si miras la [prueba de concepto](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), notarás que he traducido literalmente el Go a Python), e interactuar con la sesión.

También es posible robar comandos (**información sensible**) y suministrar la salida del atacante.

## Referencias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Aprende hacking de AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
