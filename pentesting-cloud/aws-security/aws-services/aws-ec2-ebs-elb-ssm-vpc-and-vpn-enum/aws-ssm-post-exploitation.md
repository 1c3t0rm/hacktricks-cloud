# AWS - Exploitation post-SSM

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## MitM SSM

### Interception des messages SSM envoy√©s √† une instance EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Avec **l'acc√®s aux identifiants IAM d'une instance EC2**, vous pouvez intercepter les messages EC2 et les sessions SSM en raison de la gestion de l'authentification par SSM.

L'[**Agent SSM**](https://github.com/aws/amazon-ssm-agent) appelle continuellement **`ec2messages:GetMessages`**, maintenant la **connexion ouverte** pendant **20 secondes**. Si un message est envoy√©, comme via [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), il est re√ßu √† travers cette connexion ouverte.

Un **attaquant** peut intercepter les messages EC2 en appelant **`ec2messages:GetMessages`** plus fr√©quemment. Ce [**proof of concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) d√©montre cela en √©coutant les messages send-command. L'attaquant peut √©galement **envoyer n'importe quelle r√©ponse** qu'il souhaite aux messages.

L'attaquant pourrait √©galement **envoyer n'importe quelle r√©ponse** qu'il aime aux messages.

### Interception des messages de session SSM

C'est plus complexe, impliquant plusieurs connexions WebSocket et un protocole binaire unique. Lorsque **l'Agent SSM d√©marre**, il **cr√©e** une connexion **WebSocket** avec AWS. Lorsqu'un utilisateur d√©marre une session SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), le **canal de contr√¥le initie un canal de donn√©es** pour la communication utilisateur-instance EC2.

Le code source de l'Agent SSM, disponible [ici](https://github.com/aws/amazon-ssm-agent), peut √™tre utilis√© pour fabriquer les messages au format binaire, comme [cela](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Intercepter les sessions SSM est plus fiable que les messages EC2** car les **canaux de contr√¥le sont √† longue dur√©e de vie** et AWS communique uniquement avec le **plus r√©cent**. Ce [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) montre comment cr√©er un canal de contr√¥le et interagir avec la session.

D'un point de vue abus, **intercepter les sessions SSM est plus fiable que les messages EC2**. La raison en est que les **canaux de contr√¥le sont √† longue dur√©e de vie**, et tout comme avec les messages EC2, AWS ne communiquera qu'avec le **plus r√©cent**. En cons√©quence, nous pouvons cr√©er notre propre canal de contr√¥le et √©couter les sessions entrantes. En utilisant le code source de l'Agent SSM, nous pouvons fabriquer les messages au format binaire (si vous regardez le [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), vous remarquerez que j'ai litt√©ralement traduit le Go en Python), et interagir avec la session.

Il est √©galement possible de voler des commandes (**informations sensibles**) et de fournir la sortie de l'attaquant.

## R√©f√©rences

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
