# AWS - P√≥s-Explora√ß√£o SSM

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## MitM SSM

### Interceptar Mensagens SSM Enviadas para uma Inst√¢ncia EC2 <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

Com **acesso √†s credenciais IAM de uma inst√¢ncia EC2**, voc√™ pode interceptar mensagens EC2 e sess√µes SSM devido ao tratamento de autentica√ß√£o do SSM.

O [**Agente SSM**](https://github.com/aws/amazon-ssm-agent) chama continuamente **`ec2messages:GetMessages`**, mantendo a **conex√£o aberta** por **20 segundos**. Se uma mensagem √© enviada, como por meio de [**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html), ela √© recebida atrav√©s desta conex√£o aberta.

Um **atacante** pode interceptar mensagens EC2 chamando **`ec2messages:GetMessages`** com mais frequ√™ncia. Este [**proof of concept**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) demonstra isso ao ouvir mensagens de send-command. O atacante tamb√©m pode **enviar qualquer resposta** que desejar √†s mensagens.

O atacante tamb√©m poderia **enviar qualquer resposta** que ele quiser √†s mensagens.

### Interceptar Mensagens de Sess√£o SSM

Isso √© mais complexo, envolvendo m√∫ltiplas conex√µes WebSocket e um protocolo bin√°rio √∫nico. Quando o **Agente SSM inicia**, ele **cria** uma conex√£o **WebSocket** com a AWS. Quando um usu√°rio inicia uma sess√£o SSM ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)), o **canal de controle inicia um canal de dados** para comunica√ß√£o entre o usu√°rio e a inst√¢ncia EC2.

O c√≥digo-fonte do Agente SSM, dispon√≠vel [aqui](https://github.com/aws/amazon-ssm-agent), pode ser usado para criar as mensagens no formato bin√°rio, como [isto](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73).

**Interceptar Sess√µes SSM √© mais confi√°vel do que mensagens EC2** pois os **canais de controle s√£o de longa dura√ß√£o** e a AWS s√≥ se comunica com o **mais recente**. Este [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) mostra como criar um canal de controle e interagir com a sess√£o.

Do ponto de vista do abuso, **interceptar Sess√µes SSM √© mais confi√°vel do que mensagens EC2**. A raz√£o para isso √© que os **canais de controle s√£o de longa dura√ß√£o**, e assim como com mensagens EC2, a AWS s√≥ se comunicar√° com o **mais recente**. Como resultado, podemos criar nosso pr√≥prio canal de controle e ouvir as sess√µes que chegam. Usando o c√≥digo-fonte do Agente SSM, podemos criar as mensagens no formato bin√°rio (se voc√™ olhar para o [proof of concept](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception), voc√™ notar√° que eu literalmente apenas traduzi o Go para Python), e interagir com a sess√£o.

Tamb√©m √© poss√≠vel roubar comandos (**informa√ß√µes sens√≠veis**) e fornecer a sa√≠da do atacante.

## Refer√™ncias

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
