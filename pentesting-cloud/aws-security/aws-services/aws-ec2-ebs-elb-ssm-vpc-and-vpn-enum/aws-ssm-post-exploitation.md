# AWS - SSM ポストエクスプロイト

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) でゼロからヒーローまで AWS ハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に **参加する** か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを共有する。

</details>

## MitM SSM

### EC2 インスタンスに送信される MitM SSM メッセージ <a href="#intercept-ec2-messages" id="intercept-ec2-messages"></a>

**EC2 インスタンスの IAM 資格情報にアクセスする** ことで、SSM の認証処理のため、EC2 メッセージと SSM セッションを傍受することができます。

[**SSM エージェント**](https://github.com/aws/amazon-ssm-agent) は継続的に **`ec2messages:GetMessages`** を呼び出し、**20 秒間** **接続を開いたまま** にします。メッセージが送信されると、[**`ssm:SendCommand`**](https://docs.aws.amazon.com/cli/latest/reference/ssm/send-command.html) 経由であれば、この開いた接続を通じて受信されます。

**攻撃者** は **`ec2messages:GetMessages`** をより頻繁に呼び出すことで EC2 メッセージを傍受することができます。この [**実証例**](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-document-interception) は、send-command メッセージをリッスンする方法を示しています。攻撃者はまた、メッセージに対して **任意の応答** を送信することもできます。

攻撃者はまた、メッセージに対して **好きな応答** を送信することもできます。

### MitM SSM セッションメッセージ

これはより複雑で、複数の WebSocket 接続と独自のバイナリプロトコルを含んでいます。**SSM エージェントが起動する** と、AWS に対して **WebSocket** 接続を **作成** します。ユーザーが SSM セッション ([ssm:StartSession](https://docs.aws.amazon.com/cli/latest/reference/ssm/start-session.html)) を開始すると、**コントロールチャネルがデータチャネルを開始** し、ユーザーと EC2 インスタンス間の通信が行われます。

SSM エージェントのソースコードは [こちら](https://github.com/aws/amazon-ssm-agent) で利用可能で、バイナリ形式でメッセージを作成するために使用できます。例えば [これ](https://github.com/aws/amazon-ssm-agent/blob/21c85d674bbb44dd13cd8738d1b9d86658a6b18e/agent/session/contracts/agentmessage.go#L73) のように。

**SSM セッションを傍受することは EC2 メッセージよりも信頼性が高い** とされています。なぜなら **コントロールチャネルは長期間存在** し、AWS は **最新のものとのみ通信** するからです。この [実証例](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) は、コントロールチャネルを作成し、セッションと対話する方法を示しています。

悪用の観点から見ると、**SSM セッションを傍受することは EC2 メッセージよりも信頼性が高い** です。その理由は **コントロールチャネルは長期間存在** し、EC2 メッセージと同様に AWS は **最新のものとのみ通信** するためです。その結果、私たちは自分のコントロールチャネルを作成し、着信セッションを待ち受けることができます。SSM エージェントのソースコードを使用して、バイナリ形式でメッセージを作成することができます（[実証例](https://github.com/Frichetten/ssm-agent-research/tree/main/ssm-session-interception) を見ると、Go を Python に翻訳しただけですが）、そしてセッションと対話することができます。

また、コマンド（**機密情報**）を盗み、攻撃者の出力を提供することも可能です。

## 参考文献

* [https://frichetten.com/blog/ssm-agent-tomfoolery/](https://frichetten.com/blog/ssm-agent-tomfoolery/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) でゼロからヒーローまで AWS ハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見する、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に **参加する** か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを共有する。

</details>
