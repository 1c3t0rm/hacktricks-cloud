# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

**Pesquisa copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## Sequestro de chamadas de API da AWS

### Usando a modifica√ß√£o do Route53 e certificados ACM-PCA

Publicado em 11 de mar√ßo de 2022

H√° algum tempo, realizei algumas pesquisas sobre poss√≠veis amea√ßas de Man-in-the-Middle na AWS. Este post do blog descreve os resultados dessa pesquisa e mostra uma maneira interessante de escalar os privil√©gios do IAM na VPC da AWS.

Vamos come√ßar com os pr√©-requisitos de que o atacante assumiu o papel do IAM que permite fazer modifica√ß√µes no Route53 e emitir os certificados assinados pela CA privada do ACM-PCA.

As permiss√µes m√≠nimas do IAM que o papel deve ter para fazer a mesma explora√ß√£o s√£o:
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
As outras permiss√µes do IAM que podem ser √∫teis na enumera√ß√£o, mas n√£o s√£o obrigat√≥rias para explorar:
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
### Descoberta <a href="#discovery" id="discovery"></a>

A descoberta come√ßou com a explora√ß√£o do route53, ao primeiro criar a zona hospedada para amazonaws.com, que falhou:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Tentei o mesmo para us-east-1.amazonaws.com, que deu os mesmos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Mas para minha surpresa, o secretsmanager.us-east-1.amazonaws.com funcionou:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Agora, pode-se criar um registro A para o secretsmanager.us-east-1.amazonaws.com apontando para um IP interno dentro do VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando a v√≠tima listando segredos na m√°quina da v√≠tima e na m√°quina do atacante, recebemos a conex√£o que √© tr√°fego criptografado TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

A comunica√ß√£o √© criptografada TLS, mas se as aplica√ß√µes no VPC confiam na CA privada gerida pela ACM-PCA e o atacante tem permiss√µes IAM para controlar essa CA privada na ACM-PCA, seria poss√≠vel fazer um ataque Man-In-The-Middle completo e escalar privil√©gios IAM.

### Explora√ß√£o <a href="#exploitation" id="exploitation"></a>

Voc√™ pode assistir toda a explora√ß√£o aqui:

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Se preferir ler e acompanhar a captura de tela, por favor, continue.

Para fins de demonstra√ß√£o, vamos assumir que o atacante comprometeu um dos ec2 com o seguinte papel IAM assumido:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

No mundo real, o ec2 n√£o deveria ter permiss√µes t√£o amplas, mas voc√™ pode encontrar algum papel de desenvolvedor ou DevOps que tenha.

O ec2 comprometido com o papel IAM privilegiado tem o IP interno 10.0.0.87, a aplica√ß√£o v√≠tima roda no ec2 com IP 10.0.0.224.

Agora na m√°quina controlada pelo atacante, criamos a zona hospedada para secretsmanager.us-east-1.amazonaws.com:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

Em seguida, definimos o registro A para secretsmanager.us-east-1.amazonaws.com apontando para o 10.0.0.87:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

Sabemos que h√° uma CA Privada definida na ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

A Aplica√ß√£o Java rodando na m√°quina da v√≠tima (10.0.0.224) confia nesta CA Privada para assinar o certificado do servi√ßo web. A CA Privada est√° no Java TrustStore.

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

Agora na m√°quina do atacante, geramos a chave privada e CSR. Ent√£o, chamamos a acm-ca para emitir um certificado assinado pela CA privada. A API responde com o ARN do certificado assinado: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

Ent√£o, o atacante recupera o certificado assinado da ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

Para simular as chamadas da Aplica√ß√£o Java para o Secrets Manager a partir da m√°quina da v√≠tima, executei os testes JUnit atrav√©s do maven, na captura de tela abaixo voc√™ pode ver que n√£o h√° exce√ß√µes, o que significa que o certificado √© confi√°vel: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

Finalmente, no ouvinte ncat, podemos ver a solicita√ß√£o HTTP enviada pelo AWS SDK da Aplica√ß√£o Java. ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

Como escalar os privil√©gios IAM usando isso? N√£o temos permiss√£o para fazer s3:GetObject em qualquer objeto s3 ou para fazer secretsmanager:GetSecretValue, mas se interceptarmos o tr√°fego para o S3 ou secretsmanager com essas chamadas, podemos encaminhar as solicita√ß√µes para o respectivo VPCE e obter acesso a Objetos armazenados no S3 ou segredos armazenados no secretsmanager.
### Conclus√µes <a href="#conclusions" id="conclusions"></a>

√â recomendado evitar permiss√µes amplas do IAM do route53 no que diz respeito √† cria√ß√£o de uma zona hospedada privada ou route53:ChangeResourceRecordSets sem restri√ß√µes. Como o ACM-PCA n√£o permite aplicar restri√ß√µes sobre qual certificado de dom√≠nio pode ser assinado pela CA privada, tamb√©m √© recomendado prestar aten√ß√£o especial √†s permiss√µes do IAM acm-pca:IssueCertificate.

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
