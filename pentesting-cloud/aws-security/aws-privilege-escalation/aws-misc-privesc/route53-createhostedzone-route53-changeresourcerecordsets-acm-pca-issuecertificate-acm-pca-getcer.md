# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Recherche copi√©e depuis :** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## D√©tournement des appels d'API AWS

### Utilisation de la modification Route53 et des certificats ACM-PCA

Publi√© le 11 mars 2022

Il y a quelque temps, j'ai men√© des recherches sur les menaces potentielles de Man-in-the-Middle dans AWS. Ce billet de blog d√©crit les r√©sultats de cette recherche et montre une mani√®re int√©ressante d'escalader les privil√®ges IAM dans le VPC AWS.

Commen√ßons par les pr√©requis que l'attaquant a pris le contr√¥le du r√¥le IAM qui permet de faire des modifications √† Route53 et d'√©mettre les certificats sign√©s par une CA priv√©e de ACM-PCA.

Les permissions IAM minimales que le r√¥le doit avoir pour faire la m√™me exploitation sont :
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
Les autres permissions IAM qui peuvent √™tre utiles pour l'√©num√©ration mais ne sont pas obligatoires pour exploiter :
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
### D√©couverte <a href="#discovery" id="discovery"></a>

La d√©couverte a commenc√© en jouant avec route53, en cr√©ant d'abord la zone h√©berg√©e pour amazonaws.com, qui a √©chou√© :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

J'ai essay√© la m√™me chose pour us-east-1.amazonaws.com, qui a donn√© les m√™mes r√©sultats :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Mais √† ma grande surprise, secretsmanager.us-east-1.amazonaws.com a fonctionn√© :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Maintenant, on peut cr√©er un enregistrement A pour secretsmanager.us-east-1.amazonaws.com pointant vers une IP interne dans le VPC :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

En simulant la victime listant les secrets dans la machine de la victime et dans la machine de l'attaquant, nous recevons la connexion qui est un trafic chiffr√© TLS :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La communication est chiffr√©e TLS mais si les applications dans le VPC font confiance au CA priv√© g√©r√© par l'ACM-PCA et que l'attaquant a les permissions IAM pour contr√¥ler ce CA priv√© dans l'ACM-PCA, il serait possible de faire une interception compl√®te de type Man-In-The-Middle et d'escalader les privil√®ges IAM.

### Exploitation <a href="#exploitation" id="exploitation"></a>

Vous pouvez regarder toute l'exploitation ici :

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Si vous pr√©f√©rez lire et passer en revue les captures d'√©cran, veuillez continuer.

Pour les besoins de la d√©monstration, supposons que l'attaquant a compromis un des ec2 avec le r√¥le IAM suivant assum√© :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

Dans le monde r√©el, l'ec2 ne devrait pas avoir des permissions aussi larges mais vous pourriez rencontrer un r√¥le de d√©veloppeur ou DevOps les ayant.

L'ec2 compromis avec le r√¥le IAM privil√©gi√© a l'IP interne 10.0.0.87, l'application victime fonctionne sur l'ec2 avec l'IP 10.0.0.224.

Maintenant, sur la machine poss√©d√©e par l'attaquant, nous cr√©ons la zone h√©berg√©e pour secretsmanager.us-east-1.amazonaws.com :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

Ensuite, d√©finissez l'enregistrement A pour secretsmanager.us-east-1.amazonaws.com pointant vers le 10.0.0.87 :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

Nous savons qu'il y a un CA priv√© d√©fini dans l'ACM-PCA :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

L'application Java fonctionnant sur la machine victime (10.0.0.224) fait confiance √† ce CA priv√© pour signer le certificat du service web. Le CA priv√© est dans le Java TrustStore.

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

Maintenant, sur la machine de l'attaquant, nous g√©n√©rons la cl√© priv√©e et le CSR. Ensuite, nous appelons l'acm-ca pour √©mettre un certificat sign√© par le CA priv√©. L'API r√©pond avec l'ARN du certificat sign√© : ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

Ensuite, l'attaquant r√©cup√®re le certificat sign√© de l'ACM-PCA :

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

Pour simuler les appels de l'application Java √† Secrets Manager depuis la machine de la victime, j'ai ex√©cut√© les tests JUnit via maven, dans la capture d'√©cran ci-dessous, vous pouvez voir qu'il n'y a pas d'exceptions, ce qui signifie que le certificat est fiable : ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

Enfin, dans l'√©couteur ncat, nous pouvons voir la requ√™te HTTP envoy√©e par l'AWS SDK de l'application Java. ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

Comment escalader les privil√®ges IAM en utilisant cela ? Nous n'avons pas les permissions pour faire s3:GetObject sur un objet s3 ou pour faire secretsmanager:GetSecretValue, mais si nous interceptons le trafic vers S3 ou secretsmanager avec ces appels, nous pouvons transf√©rer les requ√™tes vers le VPCE respectif et obtenir l'acc√®s aux objets stock√©s dans S3 ou aux secrets stock√©s dans secretsmanager.
### Conclusions <a href="#conclusions" id="conclusions"></a>

Il est recommand√© d'√©viter des permissions IAM route53 trop larges en ce qui concerne la cr√©ation d'une zone h√©berg√©e priv√©e ou route53:ChangeResourceRecordSets sans restrictions. Puisque ACM-PCA ne permet pas d'appliquer des restrictions sur le domaine dont le certificat peut √™tre sign√© par l'AC priv√©, il est √©galement recommand√© de pr√™ter une attention particuli√®re aux permissions IAM acm-pca:IssueCertificate.

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
