# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

**研究内容复制自：** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## 劫持AWS API调用

### 使用Route53修改和ACM-PCA证书

发布于2022年3月11日

不久前，我对AWS中可能的中间人攻击威胁进行了一些研究。这篇博客文章描述了这项研究的结果，并展示了一种在AWS VPC中提升IAM权限的有趣方法。

让我们从攻击者接管允许对Route53进行修改并从ACM-PCA签发由私有CA签名的证书的IAM角色的先决条件开始。

角色必须具备的最低IAM权限以进行相同的利用是：
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
其他对枚举有用但不是必需的IAM权限包括：
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
### 发现 <a href="#discovery" id="discovery"></a>

发现始于尝试使用route53，首先为amazonaws.com创建托管区域，但失败了：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

我尝试了对us-east-1.amazonaws.com进行同样的操作，结果也是一样的：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

但令我惊讶的是，secretsmanager.us-east-1.amazonaws.com却成功了：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

现在，可以为secretsmanager.us-east-1.amazonaws.com创建一个指向VPC内部某个IP的A记录：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

模拟受害者在受害机器上列出秘密，在攻击者的机器上，我们接收到的是TLS加密的流量：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

通信是TLS加密的，但如果VPC中的应用程序信任ACM-PCA管理的私有CA，并且攻击者有权限控制ACM-PCA中的私有CA，那么就有可能进行完全的中间人攻击并提升IAM权限。

### 利用 <a href="#exploitation" id="exploitation"></a>

您可以在这里观看整个利用过程：

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

如果您更喜欢阅读并查看截图，请继续。

为了演示目的，假设攻击者已经攻破了一个具有以下IAM角色的ec2：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

在现实世界中，ec2不应该拥有如此广泛的权限，但你可能会遇到一些开发者或DevOps角色拥有这样的权限。

被攻破的ec2拥有特权IAM角色，内部IP为10.0.0.87，受害者应用程序运行在IP为10.0.0.224的ec2上。

现在在攻击者拥有的机器上，我们为secretsmanager.us-east-1.amazonaws.com创建托管区域：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

然后设置一个指向10.0.0.87的secretsmanager.us-east-1.amazonaws.com的A记录：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

我们知道ACM-PCA中定义了一个私有CA：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

运行在受害机器（10.0.0.224）上的Java应用程序信任这个私有CA来签署网络服务证书。私有CA在Java TrustStore中。

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

现在在攻击者的机器上，我们生成私钥和CSR。然后，我们调用acm-ca来签发一个由私有CA签名的证书。API以签名证书ARN响应： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

然后，攻击者从ACM-PCA检索签名证书：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

为了模拟受害者机器上的Java应用程序对Secrets Manager的调用，我通过maven运行了JUnit测试，在下面的截图中你可以看到没有异常，这意味着证书是受信任的： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

最后，在ncat监听器中，我们可以看到由Java应用程序的AWS SDK发送的HTTP请求。 ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

如何使用这种方法提升IAM权限？我们没有权限对任何s3对象执行s3:GetObject或对secretsmanager执行secretsmanager:GetSecretValue，但如果我们嗅探到S3或secretsmanager的流量，并将请求转发到相应的VPCE，我们可以获得对存储在S3中的对象或存储在secretsmanager中的秘密的访问权限。
### 结论 <a href="#conclusions" id="conclusions"></a>

建议避免对于创建私有托管区域或不受限的route53:ChangeResourceRecordSets授予过宽的route53 IAM权限。由于ACM-PCA不允许对私有CA可以签名哪个域的证书施加限制，因此也建议特别注意acm-pca:IssueCertificate IAM权限。

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

其他支持HackTricks的方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
