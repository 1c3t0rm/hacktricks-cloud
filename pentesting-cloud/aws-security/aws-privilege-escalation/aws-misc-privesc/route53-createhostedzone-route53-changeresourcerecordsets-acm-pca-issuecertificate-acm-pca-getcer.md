# route53:CreateHostedZone、route53:ChangeResourceRecordSets、acm-pca:IssueCertificate、acm-pca:GetCer

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

**研究コピー元:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## AWS APIコールのハイジャック

### Route53の変更とACM-PCA証明書の使用

2022年3月11日に投稿

少し前に、AWSでのMan-in-the-Middle脅威についての研究を行いました。このブログ投稿では、その研究結果を説明し、AWS VPC内でIAM権限をエスカレーションする興味深い方法を示しています。

攻撃者がIAMロールを乗っ取り、Route53の変更を行い、ACM-PCAからプライベートCAによって署名された証明書を発行することができる前提から始めましょう。

同じ搾取を行うためにロールが持っていなければならない最小限のIAM権限は：
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
他のIAM権限は列挙に役立つことがありますが、悪用するためには必須ではありません:
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
攻撃者がroute53とacm-pcaに最小限のIAM権限を持っている場合、AWS APIへの呼び出しをハイジャックし、関連するVPCエンドポイントにハイジャックされたAWS API呼び出しを転送し、レスポンス（例：secretsmanager:GetSecretValue呼び出し）を読むことで、AWSデプロイメント内のIAM権限を正常にエスカレーションすることができます。

これが可能だと知り、驚きました。なぜなら、私の誤った仮定に基づいていたからです：1) AWS SDKは証明書ピンニングのようなものを使用している、2) route53とacm-pcaはAWSの内部ドメイン名の制御を許可しないだろう。

これらの仮定はすべて真実ではありませんでした。AWSセキュリティに相談しましたが、セキュリティバグではないことがわかりました。クライアントがAWS APIへのトラフィックのためにプロキシやカスタムルーティングを設定したいというユースケースがあります。他のクラウドペネトレーションテスターにとって有用かもしれないと考え、この挙動を文書化して共有することにしました。

### 発見 <a href="#discovery" id="discovery"></a>

発見はroute53で遊んでいることから始まりました。最初にamazonaws.comのホストゾーンを作成しようとしましたが、失敗しました：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

us-east-1.amazonaws.comに対しても同じことを試みましたが、同じ結果でした：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

しかし、驚いたことにsecretsmanager.us-east-1.amazonaws.comはうまくいきました：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

これで、secretsmanager.us-east-1.amazonaws.comをVPC内のある内部IPに指すAレコードを作成できます：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

被害者のマシンでシークレットをリストすることをシミュレートし、攻撃者のマシンではTLS暗号化されたトラフィックの接続を受け取ります：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

通信はTLSで暗号化されていますが、VPC内のアプリケーションがACM-PCAによって管理されるプライベートCAを信頼し、攻撃者がACM-PCA内のそのプライベートCAを制御するIAM権限を持っている場合、完全な中間者攻撃を行い、IAM権限をエスカレーションすることが可能です。

### 悪用 <a href="#exploitation" id="exploitation"></a>

こちらで悪用の全過程を見ることができます：

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

スクリーンショットを見ながら読むことを好む場合は、続けてください。

デモンストレーションの目的で、攻撃者が以下のIAMロールを想定したec2の1つを侵害したと仮定しましょう：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

実際の世界では、ec2はこれほど広範な権限を持つべきではありませんが、開発者やDevOpsの役割でそういったものに遭遇することがあります。

特権IAMロールを持つ侵害されたec2は内部IPが10.0.0.87で、被害者アプリケーションはIPが10.0.0.224のec2上で実行されています。

攻撃者が所有するマシンでは、secretsmanager.us-east-1.amazonaws.comのホストゾーンを作成します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

次に、secretsmanager.us-east-1.amazonaws.comを10.0.0.87を指すAレコードに設定します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

ACM-PCAにプライベートCAが定義されていることがわかります：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

被害者マシン（10.0.0.224）上で実行されているJavaアプリケーションは、このプライベートCAがウェブサービス証明書を署名することを信頼しています。プライベートCAはJava TrustStoreにあります。

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

攻撃者のマシンでは、プライベートキーとCSRを生成します。次に、acm-caにプライベートCAによって署名された証明書の発行を要求します。APIは署名された証明書ARNで応答します： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

次に、攻撃者はACM-PCAから署名された証明書を取得します：

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

被害者のマシンからSecrets ManagerへのJavaアプリケーションの呼び出しをシミュレートするために、JUnitテストをmavenを通じて実行しました。以下のスクリーンショットでは例外がないことがわかります。これは証明書が信頼されていることを意味します： ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

最後に、ncatリスナーでは、JavaアプリケーションからAWS SDKによって送信されたHTTPリクエストを見ることができます。 ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

それを使用してIAM権限をどのようにエスカレーションするか？ s3:GetObjectを任意のs3オブジェクトに対して行う権限も、secretsmanager:GetSecretValueを行う権限もありませんが、S3またはsecretsmanagerへのトラフィックをそれらの呼び出しで嗅ぎ取ることができれば、リクエストをそれぞれのVPCEに転送し、S3に保存されているオブジェクトまたはsecretsmanagerに保存されているシークレットへのアクセスを取得することができます。
### 結論 <a href="#conclusions" id="conclusions"></a>

プライベートホストゾーンの作成や制限のないroute53:ChangeResourceRecordSetsに関しては、広範なroute53 IAM権限を避けることを推奨します。ACM-PCAではプライベートCAによって署名されるドメインの証明書に制限を適用することができないため、acm-pca:IssueCertificate IAM権限にも特に注意を払うことを推奨します。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
