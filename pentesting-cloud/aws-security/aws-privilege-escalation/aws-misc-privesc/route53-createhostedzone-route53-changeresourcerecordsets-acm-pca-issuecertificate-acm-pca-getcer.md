# route53:CreateHostedZone, route53:ChangeResourceRecordSets, acm-pca:IssueCertificate, acm-pca:GetCer

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Investigación copiada de:** [**https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/**](https://niebardzo.github.io/2022-03-11-aws-hijacking-route53/)****

## Secuestro de llamadas a la API de AWS

### Utilizando la modificación de Route53 y los certificados ACM-PCA

Publicado el 11 de marzo de 2022

Hace algún tiempo realicé una investigación sobre posibles amenazas de Man-in-the-Middle en AWS. Esta entrada de blog describe los resultados de esta investigación y muestra una forma interesante de escalar los privilegios IAM en el VPC de AWS.

Empecemos con los requisitos previos que el atacante ha tomado el rol IAM que permite hacer modificaciones en Route53 y emitir los certificados firmados por una CA privada de ACM-PCA.

Los permisos mínimos de IAM que el rol debe tener para hacer la misma explotación son:
```
route53:CreateHostedZone
route53:ChangeResourceRecordSets
acm-pca:IssueCertificate
acm-pca:GetCertificate
```
Los otros permisos de IAM que pueden ser útiles en la enumeración pero no son obligatorios para explotar:
```
route53:GetHostedZone
route53:ListHostedZones
acm-pca:ListCertificateAuthorities
ec2:DescribeVpcs
```
Una vez que el atacante tiene permisos mínimos de IAM en route53 y acm-pca, él o ella podrían secuestrar las llamadas a la API de AWS y escalar con éxito los privilegios de IAM en la implementación de AWS, al reenviar las llamadas secuestradas de la API de AWS a los respectivos Puntos Finales de VPC y leer las respuestas, por ejemplo, la llamada secretsmanager:GetSecretValue.

Me sorprendió que esto fuera posible, debido a mi falsa suposición de que: 1) AWS SDK utiliza una especie de fijación de certificados, 2) Ni route53 ni acm-pca permitirían controlar los nombres de dominio internos de AWS.

Todas esas suposiciones no son ciertas. Se consultó a AWS Security, pero resultó que no es un fallo de seguridad. Hay casos de uso donde los clientes quieren configurar un proxy o enrutamiento personalizado para el tráfico a las APIs de AWS. He decidido documentar y compartir este comportamiento, ya que podría ser útil para otros pentesters de la nube.

### Descubrimiento <a href="#discovery" id="discovery"></a>

El descubrimiento comenzó jugando con route53, al crear primero la zona alojada para amazonaws.com, lo cual falló:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_1.png)

Intenté lo mismo para us-east-1.amazonaws.com, que dio los mismos resultados:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_2.png)

Pero para mi sorpresa, secretsmanager.us-east-1.amazonaws.com funcionó:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_3.png)

Ahora, uno puede crear un registro A para secretsmanager.us-east-1.amazonaws.com apuntando a alguna IP interna dentro del VPC:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_4.png)

Simulando que la víctima lista secretos en la máquina de la víctima y en la máquina del atacante, recibimos la conexión que es tráfico cifrado TLS:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_5.png)

La comunicación está cifrada con TLS, pero si las aplicaciones en el VPC confían en la CA privada gestionada por ACM-PCA y el atacante tiene permisos de IAM para controlar esa CA privada en ACM-PCA, sería posible realizar un ataque Man-In-The-Middle completo y escalar los privilegios de IAM.

### Explotación <a href="#exploitation" id="exploitation"></a>

Puedes ver toda la explotación aquí:

[https://youtu.be/I-IakgPyEtk](https://youtu.be/I-IakgPyEtk)

Si prefieres leer y seguir las capturas de pantalla, continúa.

Para el propósito de la demostración, supongamos que el atacante comprometió uno de los ec2 con el siguiente rol de IAM asumido:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_7.png)

En el mundo real, el ec2 no debería tener permisos tan amplios, pero podrías encontrar algún rol de desarrollador o DevOps que los tenga.

El ec2 comprometido con el rol de IAM privilegiado tiene la IP interna 10.0.0.87, la aplicación víctima se ejecuta en el ec2 con IP 10.0.0.224.

Ahora, en la máquina controlada por el atacante, creamos la zona alojada para secretsmanager.us-east-1.amazonaws.com:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_8.png)

Luego configuramos el registro A para secretsmanager.us-east-1.amazonaws.com apuntando al 10.0.0.87:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_9.png)

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_10.png)

Sabemos que hay una CA Privada definida en ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_11.png)

La Aplicación Java que se ejecuta en la máquina de la víctima (10.0.0.224) confía en esta CA Privada para firmar el certificado del servicio web. La CA Privada está en el Java TrustStore.

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_12.png)

Ahora, en la máquina del atacante, generamos la clave privada y CSR. Luego, llamamos a acm-ca para emitir un certificado firmado por la CA privada. La API responde con el ARN del certificado firmado: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_13.png) ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_14.png)

Luego, el atacante recupera el certificado firmado de ACM-PCA:

![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_15.png)

Para simular las llamadas de la Aplicación Java a Secrets Manager desde la máquina de la víctima, he ejecutado las pruebas JUnit a través de maven, en la captura de pantalla a continuación puedes ver que no hay excepciones, lo que significa que el certificado es de confianza: ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_16.png)

Finalmente, en el oyente de ncat, podemos ver la solicitud HTTP enviada por AWS SDK desde la Aplicación Java. ![aws\_hijack](https://github.com/niebardzo/niebardzo.github.io/raw/master/img/2022-03-11-aws-hijack\_17.png)

¿Cómo escalar los privilegios de IAM usando eso? No tenemos permisos para hacer s3:GetObject en ningún objeto de s3 o para hacer secretsmanager:GetSecretValue, pero si olfateamos el tráfico a S3 o secretsmanager con esas llamadas, podemos reenviar las solicitudes a los respectivos VPCE y obtener acceso a Objetos almacenados en S3 o secretos almacenados en secretsmanager.
### Conclusiones <a href="#conclusions" id="conclusions"></a>

Se recomienda evitar permisos IAM de route53 demasiado amplios en lo que respecta a la creación de una zona alojada privada o route53:ChangeResourceRecordSets sin restricciones. Dado que ACM-PCA no permite aplicar restricciones sobre qué certificado de dominio puede ser firmado por la CA privada, también se recomienda prestar especial atención a los permisos IAM de acm-pca:IssueCertificate.

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
