# GCP vers le pivotement de Workspace

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Ce post est un r√©sum√© de celui de [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) qui peut √™tre consult√© pour plus de d√©tails.

## **Comprendre la d√©l√©gation √† l'√©chelle du domaine**

La d√©l√©gation √† l'√©chelle du domaine de Google Workspace permet √† un objet d'identit√©, soit une **application externe** du Marketplace de Google Workspace ou un **compte de service GCP** interne, d'**acc√©der aux donn√©es √† travers Workspace au nom des utilisateurs**. Cette fonctionnalit√©, cruciale pour les applications interagissant avec les API Google ou les services n√©cessitant une usurpation d'identit√©, am√©liore l'efficacit√© et r√©duit les erreurs humaines en automatisant les t√¢ches. Utilisant OAuth 2.0, les d√©veloppeurs d'applications et les administrateurs peuvent donner √† ces comptes de service l'acc√®s aux donn√©es des utilisateurs sans le consentement individuel de ces derniers.\
\
Google Workspace permet la cr√©ation de deux principaux types d'identit√©s d√©l√©gu√©es globales :

* **Applications GWS :** Les applications du Marketplace de Workspace peuvent √™tre configur√©es comme une identit√© d√©l√©gu√©e. Avant d'√™tre disponibles sur le marketplace, chaque application Workspace est examin√©e par Google pour minimiser les abus potentiels. Bien que cela n'√©limine pas enti√®rement le risque d'abus, cela augmente consid√©rablement la difficult√© pour de tels incidents de se produire.
* **Compte de service GCP :** En savoir plus sur [**les comptes de service GCP ici**](gcp-basic-information.md#service-accounts).

### **D√©l√©gation √† l'√©chelle du domaine : Sous le capot**

Voici comment un compte de service GCP peut acc√©der aux API Google au nom d'autres identit√©s dans Google Workspace :

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **L'identit√© cr√©e un JWT :** L'identit√© utilise la cl√© priv√©e du compte de service (partie du fichier de paire de cl√©s JSON) pour signer un JWT. Ce JWT contient des affirmations sur le compte de service, l'utilisateur cible √† usurper et les √©tendues OAuth d'acc√®s √† l'API REST qui est demand√©e.
2. **L'identit√© utilise le JWT pour demander un jeton d'acc√®s :** L'application/utilisateur utilise le JWT pour demander un jeton d'acc√®s au service OAuth 2.0 de Google. La demande inclut √©galement l'utilisateur cible √† usurper (l'email Workspace de l'utilisateur) et les √©tendues pour lesquelles l'acc√®s est demand√©.
3. **Le service OAuth 2.0 de Google retourne un jeton d'acc√®s :** Le jeton d'acc√®s repr√©sente l'autorit√© du compte de service d'agir au nom de l'utilisateur pour les √©tendues sp√©cifi√©es. Ce jeton est g√©n√©ralement de courte dur√©e et doit √™tre rafra√Æchi p√©riodiquement (selon le besoin de l'application). Il est essentiel de comprendre que les √©tendues OAuth sp√©cifi√©es dans le jeton JWT ont une validit√© et un impact sur le jeton d'acc√®s r√©sultant. Par exemple, les jetons d'acc√®s poss√©dant plusieurs √©tendues seront valables pour de nombreuses applications API REST.
4. **L'identit√© utilise le jeton d'acc√®s pour appeler les API Google** : Maintenant avec un jeton d'acc√®s pertinent, le service peut acc√©der √† l'API REST requise. L'application utilise ce jeton d'acc√®s dans l'en-t√™te "Authorization" de ses requ√™tes HTTP destin√©es aux API Google. Ces API utilisent le jeton pour v√©rifier l'identit√© usurp√©e et confirmer qu'elle a l'autorisation n√©cessaire.
5. **Les API Google retournent les donn√©es demand√©es** : Si le jeton d'acc√®s est valide et que le compte de service a l'autorisation appropri√©e, les API Google retournent les donn√©es demand√©es. Par exemple, dans l'image suivante, nous avons utilis√© la m√©thode _users.messages.list_ pour lister tous les identifiants de messages Gmail associ√©s √† un utilisateur Workspace cible.

## Nouvelle d√©l√©gation avec acc√®s interactif GWS

Dans le premier sc√©nario, un acteur obtient g√©n√©ralement un acc√®s initial √† une identit√© IAM, avec la capacit√© de **cr√©er des comptes de service dans un projet GCP.** En outre, il d√©tient maintenant un **privil√®ge de super administrateur pour GWS.**

**√âtapes de l'attaque :**

1. **G√©n√©ration d'un nouveau compte de service et d'une paire de cl√©s correspondante :** Sur GCP, de nouvelles ressources de compte de service peuvent √™tre produites soit de mani√®re interactive via la console, soit de mani√®re programmatique en utilisant des appels API directs et des outils CLI. Cela n√©cessite le **r√¥le `iam.serviceAccountAdmin`** ou tout r√¥le personnalis√© √©quip√© de la **permission `iam.serviceAccounts.create`**. Une fois le compte de service cr√©√©, nous proc√©derons √† la g√©n√©ration d'une **paire de cl√©s associ√©e** (**permission `iam.serviceAccountKeys.create`**).
2. **Cr√©ation d'une nouvelle d√©l√©gation** : Apr√®s avoir un objet d'identit√© pertinent et une cl√© priv√©e associ√©e qui permet l'authentification avec les API Google, nous devons **√©tablir une nouvelle r√®gle de d√©l√©gation pour la ressource de compte de service au sein de Google Workspace**. Cette r√®gle de d√©l√©gation nous permettra de r√©aliser l'activit√© des API Google sur les applications API REST de Workspace. Il est important de comprendre que **seul le r√¥le de Super Admin poss√®de la capacit√© de configurer une d√©l√©gation globale √† l'√©chelle du domaine dans Google Workspace** et la d√©l√©gation √† l'√©chelle du domaine **ne peut pas √™tre configur√©e de mani√®re programmatique,** elle ne peut √™tre cr√©√©e et ajust√©e **manuellement** que via la console Google Workspace **.**

La cr√©ation de la r√®gle peut √™tre trouv√©e sous la page **Contr√¥les API ‚Üí G√©rer la d√©l√©gation √† l'√©chelle du domaine dans la console d'administration de Google Workspace**.
3. **Attribution du privil√®ge des √©tendues OAuth** : Lors de la configuration d'une nouvelle d√©l√©gation, Google ne demande que 2 param√®tres, l'ID client, qui est **l'ID OAuth du compte de service GCP**, et les **√©tendues OAuth** qui d√©finissent quels appels API la d√©l√©gation n√©cessite.\
La **liste compl√®te des √©tendues OAuth** peut √™tre trouv√©e [**ici**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Agir au nom de l'identit√© cible :** √Ä ce stade, nous avons un objet d√©l√©gu√© fonctionnel dans GWS. Maintenant, **en utilisant la cl√© priv√©e du compte de service GCP, nous pouvons effectuer des appels API** (dans l'√©tendue d√©finie dans le param√®tre d'√©tendue OAuth) pour l'activer et **agir au nom de toute identit√© qui existe dans Google Workspace**. Comme nous l'avons appris, le compte de service g√©n√©rera des jetons d'acc√®s selon ses besoins et selon l'autorisation qu'il a pour les applications API REST.

### D√©l√©gation inter-organisationnelle

L'ID SA OAuth est global et peut √™tre utilis√© pour une **d√©l√©gation inter-organisationnelle**. Aucune restriction n'a √©t√© mise en ≈ìuvre pour emp√™cher la d√©l√©gation globale inter-organisationnelle. En termes simples, **les comptes de service de diff√©rentes organisations GCP peuvent √™tre utilis√©s pour configurer une d√©l√©gation √† l'√©chelle du domaine sur d'autres organisations Workspace**. Cela se traduirait par **seulement besoin d'un acc√®s Super Admin √† Workspace**, et non d'un acc√®s au m√™me compte GCP, car l'adversaire peut cr√©er des comptes de service et des cl√©s priv√©es sur son compte GCP personnellement contr√¥l√©.

## Compromettre une d√©l√©gation existante - DeleFriend

Dans le cas o√π nous avons acc√®s √† une ressource de compte de service GCP pertinente avec **une d√©l√©gation √† l'√©chelle du domaine existante** dans la politique IAM, rien ne nous emp√™che de cr√©er une nouvelle cl√©, d'√©num√©rer toutes les possibilit√©s de JWT existantes et d'utiliser cette d√©l√©gation existante pour effectuer des appels API √† Google Workspace au nom d'autres identit√©s dans le domaine.

{% hint style="danger" %}
Apr√®s avoir compromis d'une mani√®re ou d'une autre une organisation/projet GCP, un attaquant pourrait v√©rifier √† quels comptes de service GCP il peut cr√©er des **cl√©s json**, les cr√©er et v√©rifier si le **SA a acc√®s au nom d'autres identit√©s √† certains √©tendues OAuth de Workspace**.
{% endhint %}

Voici les √©tapes exactes :

1. **√ânum√©rer les projets GCP** en utilisant l'API Resource Manager.
2. It√©rer sur chaque ressource de projet et **√©num√©rer les ressources de compte de service GCP** auxquelles l'utilisateur IAM initial a acc√®s en utilisant _GetIAMPolicy_.
3. It√©rer sur **chaque r√¥le de compte de service**, et trouver des r√¥les int√©gr√©s, de base et personnalis√©s avec la permission _**serviceAccountKeys.create**_ sur la ressource de compte de service cible. Il convient de noter que le r√¥le d'√âditeur poss√®de intrins√®quement cette permission.
4. Cr√©er une **nouvelle cl√© priv√©e \_KEY\_ALG\_RSA\_2048**\_\*\* pour chaque ressource de compte de service\*\* trouv√©e avec la permission pertinente dans la politique IAM.
5. It√©rer sur **chaque nouveau compte de service et cr√©er un objet \_JWT**\_\*\* pour celui-ci qui est compos√© des informations d'identification de la cl√© priv√©e SA et d'une √©tendue OAuth. Le processus de cr√©ation d'un nouvel objet _JWT_ va **it√©rer sur toutes les combinaisons existantes d'√©tendues OAuth** √† partir de la liste **oauth\_scopes.txt**, afin de trouver toutes les possibilit√©s de d√©l√©gation. La liste **oauth\_scopes.txt** est mise √† jour avec toutes les √©tendues OAuth que nous avons trouv√©es pertinentes pour abuser des identit√©s Workspace.
6. La m√©thode _\_make\_authorization\_grant\_assertion_ r√©v√®le la n√©cessit√© de d√©clarer un **utilisateur workspace cible**, appel√© _subject_, pour g√©n√©rer des JWT sous DWD. Bien que cela puisse sembler n√©cessiter un utilisateur sp√©cifique, il est important de r√©aliser que **DWD influence chaque identit√© au sein d'un domaine**. Par cons√©quent, cr√©er un JWT pour **tout utilisateur de domaine** affecte toutes les identit√©s de ce domaine, conform√©ment √† notre v√©rification d'√©num√©ration des combinaisons. En d'autres termes, un utilisateur Workspace valide est suffisant pour avancer.\
Cet utilisateur peut √™tre d√©fini dans le fichier _config.yaml_ de DeleFriend. Si un utilisateur workspace cible n'est pas d√©j√† connu, l'outil facilite l'identification automatique des utilisateurs workspace valides en scannant les utilisateurs de domaine avec des r√¥les sur les projets GCP. Il est cl√© de noter (encore une fois) que les JWT sont sp√©cifiques au domaine et ne sont pas g√©n√©r√©s pour chaque utilisateur ; par cons√©quent, le processus automatique cible une identit√© unique par domaine.
7. **√ânum√©rer et cr√©er un nouveau jeton d'acc√®s porteur** pour chaque JWT et valider le jeton contre l'API tokeninfo.

**Vous pouvez trouver l'outil pour effectuer cette attaque automatiquement dans :** [**DeleFriend**](https://github.com/axon-git/DeleFriend)



## **M√âLANGEZ CECI**

## Se propager √† Workspace via la d√©l√©gation √† l'√©chelle du domaine de l'autorit√© <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) est la **plateforme de collaboration et de productivit√©** de Google qui comprend des choses comme Gmail, Google Calendar, Google Drive, Google Docs, etc.

Les **comptes de service** dans GCP peuvent se voir accorder les **droits d'acc√©der programmatiquement aux donn√©es des utilisateurs** dans Workspace en se faisant passer pour des utilisateurs l√©gitimes. Cela est connu sous le nom de [d√©l√©gation √† l'√©chelle du domaine](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Cela inclut des actions comme **lire** **les emails** dans Gmail, acc√©der √† Google Docs, et m√™me cr√©er de nouveaux comptes d'utilisateurs dans l'organisation G Suite.

Workspace dispose de [sa propre API](https://developers.google.com/gsuite/aspects/apis), compl√®tement s√©par√©e de GCP. Les autorisations sont accord√©es √† Workspace et **il n'y a aucune relation par d√©faut entre GCP et Workspace**.

Cependant, il est possible de **donner** √† un compte de service **des autorisations** sur un utilisateur de Workspace. Si vous avez acc√®s √† l'interface Web √† ce stade, vous pouvez naviguer vers **IAM -> Comptes de service** et voir si l'un des comptes a **"Activ√©" r√©pertori√© sous la colonne "d√©l√©gation √† l'√©chelle du domaine"**. La colonne elle-m√™me peut **ne pas appara√Ætre si aucun compte n'est activ√©** (vous pouvez lire les d√©tails de chaque compte de service pour confirmer cela). √Ä l'heure actuelle, il n'existe aucun moyen de le faire de mani√®re programmatique, bien qu'il y ait une [demande pour cette fonctionnalit√©](https://issuetracker.google.com/issues/116182848) dans le suivi des bugs de Google.

Pour cr√©er cette relation, il est n√©cessaire de **l'activer dans GCP et aussi dans Workforce**.

#### Tester l'acc√®s √† Workspace

Pour tester cet acc√®s, vous aurez besoin des **informations d'identification du compte de service export√©es au format JSON**. Vous avez peut-√™tre acquis ces informations lors d'une √©tape pr√©c√©dente, ou vous avez peut-√™tre maintenant l'acc√®s requis pour cr√©er une cl√© pour un compte de service dont vous savez qu'il a la d√©l√©gation √† l'√©chelle du domaine activ√©e.

Ce sujet est un peu d√©licat‚Ä¶ votre compte de service a quelque chose appel√© "client\_email" que vous pouvez voir dans le fichier d'informations d'identification JSON que vous exportez. Cela ressemble probablement √† quelque chose comme `account-name@project-name.iam.gserviceaccount.com`. Si vous essayez d'acc√©der directement aux appels API de Workforce avec cet email, m√™me avec la d√©l√©gation activ√©e, vous √©chouerez. C'est parce que l'annuaire Workforce n'inclura pas les adresses e-mail des comptes de service GCP. Au lieu de cela, pour interagir avec Workforce, nous devons r√©ellement nous faire passer pour des utilisateurs Workforce valides.

Ce que vous voulez vraiment faire, c'est vous **faire passer pour un utilisateur avec un acc√®s administratif**, puis utiliser cet acc√®s pour faire quelque chose comme **r√©initialiser un mot de passe, d√©sactiver l'authentification √† plusieurs facteurs, ou simplement vous cr√©er un nouveau compte administratif**.

Gitlab a cr√©√© [ce script Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) qui peut faire deux choses - lister l'annuaire des
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
Vous pouvez essayer ce script sur une s√©rie d'adresses e-mail pour vous faire passer pour **divers** **utilisateurs**. La sortie standard indiquera si le compte de service a acc√®s √† Workforce, et inclura un **mot de passe al√©atoire pour le nouveau compte admin** si un est cr√©√©.

Si vous r√©ussissez √† cr√©er un nouveau compte admin, vous pouvez vous connecter √† la [console d'administration Google](https://admin.google.com) et avoir un contr√¥le total sur tout dans G Suite pour chaque utilisateur - e-mail, documents, calendrier, etc. L√¢chez-vous.

## R√©f√©rences

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
