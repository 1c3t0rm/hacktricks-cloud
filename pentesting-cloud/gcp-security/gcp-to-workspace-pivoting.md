# GCP a Workspace Pivoting

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Este post es un resumen del que se encuentra en [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover) al cual se puede acceder para m√°s detalles.

## **Entendiendo la Delegaci√≥n de Dominio Amplio**

La delegaci√≥n de dominio amplio de Google Workspace permite que un objeto de identidad, ya sea una **aplicaci√≥n externa** del Marketplace de Google Workspace o una **Cuenta de Servicio de GCP**, **acceda a datos a trav√©s de Workspace en nombre de los usuarios**. Esta caracter√≠stica, crucial para aplicaciones que interact√∫an con las APIs de Google o servicios que necesitan suplantaci√≥n de usuario, mejora la eficiencia y minimiza errores humanos automatizando tareas. Utilizando OAuth 2.0, desarrolladores de aplicaciones y administradores pueden dar a estas cuentas de servicio acceso a datos de usuario sin consentimiento individual.\
\
Google Workspace permite la creaci√≥n de dos tipos principales de identidades delegadas globales:

* **Aplicaciones GWS:** Aplicaciones del Marketplace de Workspace pueden configurarse como una identidad delegada. Antes de estar disponibles en el marketplace, cada aplicaci√≥n de Workspace pasa por una revisi√≥n de Google para minimizar el posible mal uso. Aunque esto no elimina completamente el riesgo de abuso, aumenta significativamente la dificultad para que ocurran tales incidentes.
* **Cuenta de Servicio de GCP:** Aprende m√°s sobre [**Cuentas de Servicio de GCP aqu√≠**](gcp-basic-information.md#service-accounts).

### **Delegaci√≥n de Dominio Amplio: Detr√°s de Escena**

As√≠ es como una Cuenta de Servicio de GCP puede acceder a las APIs de Google en nombre de otras identidades en Google Workspace:

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **La Identidad crea un JWT:** La Identidad usa la clave privada de la cuenta de servicio (parte del archivo de par de claves JSON) para firmar un JWT. Este JWT contiene afirmaciones sobre la cuenta de servicio, el usuario objetivo a suplantar y los alcances de OAuth para el acceso a la API REST que se est√° solicitando.
2. **La Identidad usa el JWT para solicitar un token de acceso:** La aplicaci√≥n/usuario usa el JWT para solicitar un token de acceso del servicio OAuth 2.0 de Google. La solicitud tambi√©n incluye el usuario objetivo a suplantar (el correo electr√≥nico de Workspace del usuario) y los alcances para los cuales se solicita acceso.
3. **El servicio OAuth 2.0 de Google devuelve un token de acceso:** El token de acceso representa la autoridad de la cuenta de servicio para actuar en nombre del usuario para los alcances especificados. Este token generalmente tiene una vida corta y debe ser renovado peri√≥dicamente (seg√∫n la necesidad de la aplicaci√≥n). Es esencial entender que los alcances de OAuth especificados en el token JWT tienen validez e impacto en el token de acceso resultante. Por ejemplo, los tokens de acceso que poseen m√∫ltiples alcances tendr√°n validez para numerosas aplicaciones de API REST.
4. **La Identidad usa el token de acceso para llamar a las APIs de Google**: Ahora con un token de acceso relevante, el servicio puede acceder a la API REST requerida. La aplicaci√≥n utiliza este token de acceso en el encabezado "Authorization" de sus solicitudes HTTP destinadas a las APIs de Google. Estas APIs utilizan el token para verificar la identidad suplantada y confirmar que tiene la autorizaci√≥n necesaria.
5. **Las APIs de Google devuelven los datos solicitados**: Si el token de acceso es v√°lido y la cuenta de servicio tiene la autorizaci√≥n adecuada, las APIs de Google devuelven los datos solicitados. Por ejemplo, en la siguiente imagen, hemos utilizado el m√©todo _users.messages.list_ para listar todos los IDs de mensajes de Gmail asociados con un usuario objetivo de Workspace.

## Nueva delegaci√≥n con acceso interactivo a GWS

En el primer escenario, un actor generalmente obtiene acceso inicial a una identidad IAM, con la capacidad de **crear cuentas de servicio en un proyecto de GCP.** Adem√°s, ahora posee un **privilegio de super administrador en GWS.**

**Pasos del ataque:**

1. **Generando una Nueva Cuenta de Servicio y Par de Claves Correspondiente:** En GCP, se pueden producir nuevos recursos de cuenta de servicio de manera interactiva a trav√©s de la consola o program√°ticamente utilizando llamadas directas a la API y herramientas CLI. Esto requiere el **rol `iam.serviceAccountAdmin`** o cualquier rol personalizado equipado con el **permiso `iam.serviceAccounts.create`**. Una vez creada la cuenta de servicio, procederemos a generar un **par de claves relacionado** (**permiso `iam.serviceAccountKeys.create`**).
2.  **Creaci√≥n de nueva delegaci√≥n**: Despu√©s de tener un objeto de identidad relevante y una clave privada relacionada que permite la autenticaci√≥n con las APIs de Google, necesitamos **establecer una nueva regla de delegaci√≥n para el recurso de cuenta de servicio dentro de Google Workspace**. Esta regla de delegaci√≥n nos permitir√° realizar la actividad de las APIs de Google en aplicaciones de API REST de Workspace. Es importante entender que **solo el rol de Super Administrador posee la capacidad de configurar la delegaci√≥n de dominio amplio global en Google Workspace** y la delegaci√≥n de dominio amplio **no se puede configurar program√°ticamente,** solo se puede crear y ajustar **manualmente** a trav√©s de la consola de **Google Workspace**.

La creaci√≥n de la regla se puede encontrar en la p√°gina **Controles de API ‚Üí Administrar la delegaci√≥n de dominio amplio en la consola de administraci√≥n de Google Workspace**.
3. **Adjuntando privilegio de alcances OAuth**: Al configurar una nueva delegaci√≥n, Google solo requiere 2 par√°metros, el ID de Cliente, que es el **ID de OAuth de la Cuenta de Servicio de GCP** y los **alcances de OAuth** que definen qu√© llamadas a la API requiere la delegaci√≥n.\
La **lista completa de alcances de OAuth** se puede encontrar [**aqu√≠**](https://developers.google.com/identity/protocols/oauth2/scopes).
4. **Actuando en nombre de la identidad objetivo:** En este punto, tenemos un objeto delegado funcional en GWS. Ahora, **usando la clave privada de la Cuenta de Servicio de GCP, podemos realizar llamadas a la API** (en el alcance definido en el par√°metro de alcance de OAuth) para activarlo y **actuar en nombre de cualquier identidad que exista en Google Workspace**. Como aprendimos, la cuenta de servicio generar√° tokens de acceso seg√∫n sus necesidades y de acuerdo con el permiso que tiene para aplicaciones de API REST.

### Delegaci√≥n entre organizaciones

El ID de SA de OAuth es global y se puede utilizar para **delegaci√≥n entre organizaciones**. No se ha implementado ninguna restricci√≥n para prevenir la delegaci√≥n global cruzada. En t√©rminos simples, **cuentas de servicio de diferentes organizaciones de GCP se pueden utilizar para configurar la delegaci√≥n de dominio amplio en otras organizaciones de Workspace**. Esto resultar√≠a en **solo necesitar acceso de Super Administrador a Workspace**, y no acceso a la misma cuenta de GCP, ya que el adversario puede crear Cuentas de Servicio y claves privadas en su cuenta de GCP controlada personalmente.

## Comprometer la delegaci√≥n existente - DeleFriend

En caso de que tengamos acceso a un recurso de cuenta de servicio de GCP relevante con **delegaci√≥n de dominio amplio existente** dentro de la Pol√≠tica IAM, nada nos impide crear una nueva clave, enumerar todas las posibilidades de JWT existentes y usar esa delegaci√≥n existente para realizar llamadas a la API a Google Workspace en nombre de otras identidades en el dominio.

{% hint style="danger" %}
Despu√©s de comprometer de alguna manera una organizaci√≥n/proyecto de GCP, un atacante podr√≠a verificar a qu√© Cuentas de Servicio de GCP puede crear **claves json**, crearlas y verificar si la **SA tiene acceso en nombre de otras identidades a algunos alcances de OAuth de Workspace**.
{% endhint %}

Estos son los pasos exactos:

1. **Enumerar Proyectos de GCP** utilizando la API de Resource Manager.
2. Iterar en cada recurso de proyecto y **enumerar recursos de Cuenta de Servicio de GCP** a los que el usuario IAM inicial tiene acceso usando _GetIAMPolicy_.
3. Iterar en **cada rol de cuenta de servicio**, y encontrar roles integrados, b√°sicos y personalizados con permiso _**serviceAccountKeys.create**_ en el recurso de cuenta de servicio objetivo. Cabe se√±alar que el rol de Editor posee inherentemente este permiso.
4. Crear una **nueva \_KEY\_ALG\_RSA\_2048**\_\*\* clave privada para cada recurso de cuenta de servicio\*\* que se encuentre con el permiso relevante en la pol√≠tica IAM.
5. Iterar en **cada nueva cuenta de servicio y crear un \_JWT**\_\*\* objeto\*\* para ella que est√© compuesto por las credenciales de clave privada de SA y un alcance de OAuth. El proceso de crear un nuevo objeto _JWT_ **iterar√° en todas las combinaciones existentes de alcances de OAuth** de la lista **oauth\_scopes.txt**, para encontrar todas las posibilidades de delegaci√≥n. La lista **oauth\_scopes.txt** se actualiza con todos los alcances de OAuth que hemos encontrado relevantes para abusar de las identidades de Workspace.
6. El m√©todo _\_make\_authorization\_grant\_assertion_ revela la necesidad de declarar un **usuario de workspace objetivo**, referido como _subject_, para generar JWTs bajo DWD. Aunque esto puede parecer que requiere un usuario espec√≠fico, es importante darse cuenta de que **DWD influye en cada identidad dentro de un dominio**. En consecuencia, crear un JWT para **cualquier usuario de dominio** afecta a todas las identidades en ese dominio, consistente con nuestra verificaci√≥n de enumeraci√≥n de combinaciones. En pocas palabras, un usuario v√°lido de Workspace es suficiente para avanzar.\
Este usuario se puede definir en el archivo _config.yaml_ de DeleFriend. Si no se conoce ya un usuario de workspace objetivo, la herramienta facilita la identificaci√≥n autom√°tica de usuarios v√°lidos de workspace escaneando usuarios de dominio con roles en proyectos de GCP. Es clave notar (de nuevo) que los JWT son espec√≠ficos del dominio y no se generan para cada usuario; por lo tanto, el proceso autom√°tico se dirige a una identidad √∫nica por dominio.
7. **Enumerar y crear un nuevo token de acceso bearer** para cada JWT y validar el token contra la API de tokeninfo.

**Puedes encontrar la herramienta para realizar este ataque autom√°ticamente en:** [**DeleFriend**](https://github.com/axon-git/DeleFriend)



## **MIX THIS**

## Propagaci√≥n a Workspace a trav√©s de la delegaci√≥n de autoridad de dominio amplio <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com) es la **plataforma de colaboraci√≥n y productividad** de Google que consta de cosas como Gmail, Google Calendar, Google Drive, Google Docs, etc.

Las **cuentas de servicio** en GCP pueden recibir los **derechos para acceder program√°ticamente a datos de usuario** en Workspace suplantando a usuarios leg√≠timos. Esto se conoce como [delegaci√≥n de dominio amplio](https://developers.google.com/admin-sdk/reports/v1/guides/delegation). Esto incluye acciones como **leer** **correo electr√≥nico** en Gmail, acceder a Google Docs e incluso crear nuevas cuentas de usuario en la organizaci√≥n de G Suite.

Workspace tiene [su propia API](https://developers.google.com/gsuite/aspects/apis), completamente separada de GCP. Los permisos se otorgan a Workspace y **no hay ninguna relaci√≥n predeterminada entre GCP y Workspace**.

Sin embargo, es posible **dar** a una cuenta de servicio **permisos** sobre un usuario de Workspace. Si tienes acceso a la interfaz web en este punto, puedes navegar a **IAM -> Cuentas de Servicio** y ver si alguna de las cuentas tiene **"Habilitado" listado bajo la columna "delegaci√≥n de dominio amplio"**. La columna en s√≠ **puede no aparecer si no hay cuentas habilitadas** (puedes leer los detalles de cada cuenta de servicio para confirmar esto). Hasta la fecha de este escrito, no hay forma de hacer esto program√°ticamente, aunque hay una [solicitud para esta caracter√≠stica](https://issuetracker.google.com/issues/116182848) en el rastreador de errores de Google.

Para crear esta relaci√≥n es necesario **habilitarlo en GCP y tambi√©n en Workforce**.

#### Probar acceso a Workspace

Para probar este acceso necesitar√°s las **credenciales de la cuenta de servicio exportadas en formato JSON**. Puede que hayas adquirido estas en un paso anterior, o puede que ahora tengas el acceso requerido para crear una clave para una cuenta de servicio que sepas que tiene habilitada la delegaci√≥n de dominio amplio.

Este tema es un poco complicado... tu cuenta de servicio tiene algo llamado "client\_email" que puedes ver en el archivo de credenciales JSON que exportas. Probablemente se vea algo as√≠ como `account-name@project-name.iam.gserviceaccount.com`. Si intentas acceder directamente a las llamadas de la API de Workforce con ese correo electr√≥nico, incluso con la delegaci√≥n habilitada, fallar√°s. Esto se debe a que el directorio de Workforce no incluir√° las direcciones de correo electr√≥nico de las cuentas de servicio de GCP. En su lugar, para interactuar con Workforce, necesitamos suplantar a usuarios v√°lidos de Workforce.

Lo que realmente quieres hacer es **suplantar a un usuario con acceso administrativo**, y luego usar ese acceso para hacer algo como **restablecer una contrase√±a, deshabilitar la autenticaci√≥n de m√∫ltiples factores, o simplemente crearte una nueva cuenta de administrador**.

Gitlab ha creado [este script de Python](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) que puede hacer dos cosas: listar el directorio de usuarios y crear una nueva cuenta administrativa. Aqu√≠ te mostramos c√≥mo usarlo:
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
Puede probar este script con un rango de direcciones de correo electr√≥nico para suplantar a **varios** **usuarios**. La salida est√°ndar indicar√° si la cuenta de servicio tiene acceso a Workforce e incluir√° una **contrase√±a aleatoria para la nueva cuenta de administrador** si se crea una.

Si tiene √©xito creando una nueva cuenta de administrador, puede iniciar sesi√≥n en la [consola de administraci√≥n de Google](https://admin.google.com) y tener control total sobre todo en G Suite para cada usuario: correo electr√≥nico, documentos, calendario, etc. Disfrute al m√°ximo.

## Referencias

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Aprenda hacking de AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si desea ver su **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulte los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obtenga el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önase al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠game** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparta sus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
