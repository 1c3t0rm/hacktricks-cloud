```markdown
# GCPからWorkspaceへのピボット

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>

この投稿は、詳細については[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)でアクセスできるものの要約です。

## **ドメイン全体委任の理解**

Google Workspaceのドメイン全体委任は、Google Workspace Marketplaceの**外部アプリ**または内部の**GCPサービスアカウント**などのアイデンティティオブジェクトが、ユーザーに代わってWorkspace全体のデータに**アクセスする**ことを可能にします。この機能は、Google APIやユーザーのなりすましを必要とするサービスと対話するアプリにとって重要であり、タスクを自動化することで効率を向上させ、人為的なエラーを最小限に抑えます。OAuth 2.0を使用して、アプリ開発者と管理者は、個々のユーザーの同意なしにこれらのサービスアカウントにユーザーデータへのアクセスを許可することができます。\
\
Google Workspaceでは、2種類のグローバル委任オブジェクトアイデンティティを作成できます：

* **GWSアプリケーション：** Workspace Marketplaceのアプリケーションは、委任されたアイデンティティとして設定できます。マーケットプレイスで利用可能になる前に、各WorkspaceアプリケーションはGoogleによってレビューされ、潜在的な悪用を最小限に抑えます。これにより、乱用のリスクは完全には排除されませんが、そのような事件が発生する難易度は大幅に高まります。
* **GCPサービスアカウント：** [**GCPサービスアカウントについてはこちら**](gcp-basic-information.md#service-accounts)をご覧ください。

### **ドメイン全体委任の内部**

これは、GCPサービスアカウントがGoogle Workspace内の他のアイデンティティに代わってGoogle APIにアクセスする方法です：

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **アイデンティティがJWTを作成します：** アイデンティティは、サービスアカウントのプライベートキー（JSONキーペアファイルの一部）を使用してJWTに署名します。このJWTには、サービスアカウント、なりすまし対象のユーザー、および要求されているREST APIへのアクセスのOAuthスコープに関するクレームが含まれています。
2. **アイデンティティがJWTを使用してアクセストークンを要求します：** アプリケーション/ユーザーはJWTを使用して、GoogleのOAuth 2.0サービスからアクセストークンを要求します。要求には、なりすまし対象のユーザー（ユーザーのWorkspaceメール）、およびアクセスが要求されるスコープも含まれます。
3. **GoogleのOAuth 2.0サービスがアクセストークンを返します：** アクセストークンは、指定されたスコープに対してユーザーに代わって行動するサービスアカウントの権限を表します。このトークンは通常、短命であり、定期的に更新する必要があります（アプリケーションのニーズに応じて）。JWTトークンに指定されたOAuthスコープが有効であり、結果として得られるアクセストークンに影響を与えることを理解することが重要です。たとえば、複数のスコープを持つアクセストークンは、複数のREST APIアプリケーションに対して有効です。
4. **アイデンティティがアクセストークンを使用してGoogle APIを呼び出します：** 関連するアクセストークンを持つサービスは、必要なREST APIにアクセスできます。アプリケーションは、このアクセストークンをHTTPリクエストの「Authorization」ヘッダーに使用して、Google APIに送信します。これらのAPIはトークンを使用して、なりすましアイデンティティを検証し、必要な承認を持っていることを確認します。
5. **Google APIが要求されたデータを返します：** アクセストークンが有効であり、サービスアカウントが適切な承認を持っている場合、Google APIは要求されたデータを返します。たとえば、以下の画像では、_users.messages.list_ メソッドを利用して、対象のWorkspaceユーザーに関連するすべてのGmailメッセージIDをリストしています。

## 対話型GWSアクセスを持つ新しい委任

最初のシナリオでは、アクターは通常、GCPプロジェクト内で**サービスアカウントを作成する**能力を持つIAMアイデンティティへの初期アクセスを獲得します。さらに、彼は今やGWSの**スーパーアドミン権限**を持っています。

**攻撃ステップ：**

1. **新しいサービスアカウントと対応するキーペアの生成：** GCPでは、新しいサービスアカウントリソースは、コンソールを介して対話的に、または直接API呼び出しとCLIツールを使用してプログラム的に生成できます。これには、**ロール `iam.serviceAccountAdmin`** または **`iam.serviceAccounts.create`** **権限**を備えたカスタムロールが必要です。サービスアカウントが作成されたら、関連する**キーペア**（**`iam.serviceAccountKeys.create`** 権限）の生成に進みます。
2. **新しい委任の作成：** 関連するアイデンティティオブジェクトとGoogle APIで認証を可能にする関連するプライベートキーを持っているため、Google Workspace内でサービスアカウントリソースのための新しい委任ルールを**確立する必要があります**。この委任ルールにより、Workspace REST APIアプリケーションでGoogle APIのアクティビティを実行できるようになります。Google Workspaceでグローバルドメイン全体委任を設定できるのは**スーパーアドミンロールのみ**であり、ドメイン全体委任は**プログラム的に設定することはできません**。Google Workspaceの**コンソール**を通じて**手動で**のみ作成および調整できます。

ルールの作成は、Google Workspace管理コンソールの**APIコントロール → ドメイン全体委任の管理**ページで見つけることができます。
3. **OAuthスコープ権限の添付：** 新しい委任を設定する際、GoogleはクライアントID（GCPサービスアカウントリソースの**OAuth ID**）と、委任が必要とするAPI呼び出しを定義する**OAuthスコープ**の2つのパラメータのみを要求します。\
**OAuthスコープの完全なリスト**は[**こちら**](https://developers.google.com/identity/protocols/oauth2/scopes)で見つけることができます。
4. **対象アイデンティティに代わって行動する：** この時点で、GWSに機能する委任オブジェクトがあります。これで、**GCPサービスアカウントのプライベートキーを使用してAPI呼び出しを実行**できるようになり（OAuthスコープパラメータで定義されたスコープ内で）、Google Workspace内の任意のアイデンティティに代わって行動することができます。学んだように、サービスアカウントは、REST APIアプリケーションへのアクセス権限に応じて、必要に応じてアクセストークンを生成します。

### 組織間委任

OAuth SA IDはグローバルであり、**組織間委任**に使用できます。クロスグローバル委任を防ぐための制限は実装されていません。簡単に言うと、**異なるGCP組織のサービスアカウントを使用して、他のWorkspace組織でドメイン全体委任を設定することができます**。これにより、Workspaceへのスーパーアドミンアクセスのみが必要になり、敵対者は自分が管理するGCPアカウントでサービスアカウントとプライベートキーを作成できるため、同じGCPアカウントへのアクセスは必要ありません。

## 既存の委任の妥協 - DeleFriend

IAMポリシー内で**既存のドメイン全体委任**を持つ関連するGCPサービスアカウントリソースへのアクセスがある場合、新しいキーを作成し、すべての既存のJWTの可能性を列挙し、その既存の委任を使用して、ドメイン内の他のアイデンティティに代わってGoogle WorkspaceへのAPI呼び出しを実行することを妨げるものはありません。

{% hint style="danger" %}
GCP組織/プロジェクトを何らかの方法で妥協した後、攻撃者は**jsonキー**を作成できるGCPサービスアカウントをチェックし、それらを作成して、**SAがWorkspace OAuthスコープの他のアイデンティティに代わってアクセスできるかどうか**を確認できます。
{% endhint %}

これが正確なステップです：

1. リソースマネージャAPIを使用して**GCPプロジェクトを列挙します**。
2. 各プロジェクトリソースに対して繰り返し、初期IAMユーザーがアクセスできる**GCPサービスアカウントリソースを列挙します** _GetIAMPolicy_を使用して。
3. **各サービスアカウントの役割を繰り返し**、対象のサービスアカウントリソースに対する_**serviceAccountKeys.create**_権限を持つ組み込み、基本、およびカスタムロールを見つけます。エディタロールはこの権限を本来持っていることに注意してください。
4. IAMポリシーで関連する権限が見つかった各サービスアカウントリソースに対して、**新しい\_KEY\_ALG\_RSA\_2048**\_\*\*プライベートキーを作成します\*\*。
5. **各新しいサービスアカウントに対して\_JWT**\_\*\*オブジェクトを作成し\*\*、SAプライベートキーの資格情報とOAuthスコープを含むJWTオブジェクトを作成します。新しい_JWT_オブジェクトの作成プロセスは、**oauth\_scopes.txt**リストから**すべての委任の可能性を見つけるために、OAuthスコープのすべての既存の組み合わせを繰り返し**ます。リスト**oauth\_scopes.txt**は、Workspaceアイデンティティを悪用するために関連性があると判断されたすべてのOAuthスコープで更新されます。
6. _\_make\_authorization\_grant\_assertion_メソッドは、JWTを生成するためにDWDの下で**対象のworkspaceユーザー**を宣言する必要性を明らかにします。これは、特定のユーザーが必要
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
以下のスクリプトを様々なメールアドレスに対して試して、**様々な** **ユーザー**を偽装できます。標準出力は、サービスアカウントがWorkforceにアクセスできるかどうかを示し、新しい管理者アカウントが作成された場合は、**ランダムなパスワード**も含まれます。

新しい管理者アカウントの作成に成功した場合、[Google管理コンソール](https://admin.google.com)にログオンして、G Suiteのすべてのユーザーのメール、ドキュメント、カレンダーなど、すべてを完全に制御できます。存分に活用してください。

## 参考文献

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**のGitHubリポジトリ[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>
