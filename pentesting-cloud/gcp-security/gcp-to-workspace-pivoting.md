# GCP到Workspace的权限转移

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

本文是对[https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)文章的总结，您可以访问该链接以获取更多详情。

## **理解域范围委派**

Google Workspace的域范围委派允许一个身份对象，无论是来自Google Workspace市场的**外部应用**还是内部的**GCP服务账户**，代表用户**访问Workspace中的数据**。这个功能对于与Google API互动或需要用户模拟的服务至关重要，它通过自动化任务提高效率并减少人为错误。使用OAuth 2.0，应用开发者和管理员可以授权这些服务账户访问用户数据，而无需单独用户同意。\
\
Google Workspace允许创建两种主要类型的全局委派身份对象：

* **GWS应用程序：**来自Workspace市场的应用程序可以设置为委派身份。每个Workspace应用程序在市场上提供之前都会经过Google的审核，以尽量减少潜在的滥用风险。虽然这并不能完全消除滥用的风险，但它显著增加了此类事件发生的难度。
* **GCP服务账户：**了解更多关于[**GCP服务账户**](gcp-basic-information.md#service-accounts)。

### **域范围委派：内部原理**

以下是GCP服务账户代表Google Workspace中其他身份访问Google API的方式：

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

1. **身份创建JWT：**身份使用服务账户的私钥（JSON密钥对文件的一部分）签署JWT。这个JWT包含关于服务账户、要模拟的目标用户以及请求的REST API访问范围的声明。
2. **身份使用JWT请求访问令牌：**应用程序/用户使用JWT向Google的OAuth 2.0服务请求访问令牌。请求还包括要模拟的目标用户（用户的Workspace电子邮件）和请求访问的范围。
3. **Google的OAuth 2.0服务返回访问令牌：**访问令牌代表服务账户代表用户行事的权限，适用于指定的范围。这个令牌通常是短期的，必须定期刷新（根据应用程序的需要）。理解JWT令牌中指定的OAuth范围的有效性和对结果访问令牌的影响至关重要。例如，拥有多个范围的访问令牌将对多个REST API应用程序有效。
4. **身份使用访问令牌调用Google API：**现在有了相关的访问令牌，服务可以访问所需的REST API。应用程序在其发送到Google API的HTTP请求的"Authorization"头中使用这个访问令牌。这些API使用令牌来验证模拟的身份并确认它具有必要的授权。
5. **Google API返回请求的数据：**如果访问令牌有效且服务账户具有适当的授权，则Google API返回请求的数据。例如，在下图中，我们利用了_users.messages.list_方法列出了与目标Workspace用户关联的所有Gmail消息ID。

## 通过交互式GWS访问新委派

在第一个场景中，行动者通常获得对IAM身份的初始访问权限，具有**在GCP项目中创建服务账户的能力。**此外，他现在拥有GWS的**超级管理员权限。**

**攻击步骤：**

1. **生成新的服务账户和相应的密钥对：**在GCP上，可以通过控制台交互式或使用直接API调用和CLI工具以编程方式生成新的服务账户资源。这需要**角色`iam.serviceAccountAdmin`**或任何配备了**`iam.serviceAccounts.create`** **权限**的自定义角色。创建服务账户后，我们将继续生成一个**相关的密钥对**（**`iam.serviceAccountKeys.create`**权限）。
2.  **创建新的委派：**拥有相关的身份对象和相关的私钥后，这些私钥使我们能够与Google API进行身份验证，我们需要**在Google Workspace中为服务账户资源建立新的委派规则**。这个委派规则将使我们能够在Workspace REST API应用程序上执行Google API活动。重要的是要理解，**只有超级管理员角色具有在Google Workspace中设置全局域范围委派的能力**，而且域范围委派**不能以编程方式设置，**它只能通过Google Workspace**控制台**手动创建和调整。

规则的创建可以在**API控制 → 管理域范围委派的Google Workspace管理员控制台**页面下找到。
3. **附加OAuth范围权限：**配置新委派时，Google只需要两个参数，客户端ID，即**GCP服务账户**资源的**OAuth ID**，以及定义委派所需API调用的**OAuth范围**。\
可以在[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes)找到**完整的OAuth范围列表**。
4. **代表目标身份行事：**此时，我们在GWS中有了一个功能正常的委派对象。现在，**使用GCP服务账户的私钥，我们可以执行API调用**（在OAuth范围参数中定义的范围内）来触发它并**代表Google Workspace中存在的任何身份行事**。正如我们所学的，服务账户将根据其需要和对REST API应用程序的权限生成访问令牌。

### 跨组织委派

OAuth SA ID是全局的，可以用于**跨组织委派**。尚未实施任何限制以防止跨全球委派。简单来说，**不同GCP组织的服务账户可以用于在其他Workspace组织上配置域范围委派**。这将导致**只需要对Workspace的超级管理员访问权限**，而不需要访问同一个GCP账户，因为对手可以在他个人控制的GCP账户上创建服务账户和私钥。

## 危害现有委派 - DeleFriend

如果我们可以访问具有**现有域范围委派**的相关GCP服务账户资源，在IAM策略中，没有什么可以阻止我们创建一个新的密钥，枚举所有现有的JWT可能性，并使用现有的委派来代表域中其他身份对Google Workspace执行API调用。

{% hint style="danger" %}
在以某种方式危害了GCP组织/项目后，攻击者可以检查他可以为哪些GCP服务账户创建**json密钥**，创建它们并检查**SA是否代表其他身份访问某些Workspace OAuth范围**。
{% endhint %}

这些是确切的步骤：

1. 使用资源管理器API**枚举GCP项目**。
2. 迭代每个项目资源，并使用_GetIAMPolicy_**枚举初始IAM用户可以访问的GCP服务账户资源**。
3. 迭代**每个服务账户角色**，并找到具有_**serviceAccountKeys.create**_权限的内置、基本和自定义角色在目标服务账户资源上。应该注意的是，编辑者角色本身就具有这个权限。
4. 为在IAM策略中找到具有相关权限的每个服务账户资源创建一个**新的\_KEY\_ALG\_RSA\_2048**\_\*\*私钥\*\*。
5. 迭代**每个新服务账户并为其创建一个\_JWT**\_\*\*对象\*\*，该对象由SA私钥凭据和OAuth范围组成。创建新的_JWT_对象的过程将**迭代所有现有的OAuth范围组合**，从**oauth\_scopes.txt**列表中，以找到所有的委派可能性。列表**oauth\_scopes.txt**已更新，包含我们发现的所有与滥用Workspace身份相关的OAuth范围。
6. _\_make\_authorization\_grant\_assertion_ 方法揭示了声明一个**目标workspace用户**的必要性，称为_subject_，用于在DWD下生成JWT。虽然这似乎需要一个特定的用户，但重要的是要意识到**DWD影响域中的每个身份**。因此，为**任何域用户**创建JWT会影响该域中的所有身份，与我们的组合枚举检查一致。简而言之，一个有效的Workspace用户就足以继续前进。\
如果目标workspace用户尚未知晓，该工具可以通过扫描在GCP项目上具有角色的域用户来自动识别有效的workspace用户。关键是要注意（再次），JWT是特定于域的，不是为每个用户生成的；因此，自动过程针对每个域的单一唯一身份。
7. **枚举并为每个JWT创建一个新的持有者访问令牌**，并根据tokeninfo API验证令牌。

**您可以在以下位置找到自动执行此攻击的工具：** [**DeleFriend**](https://github.com/axon-git/DeleFriend)



## **混合这个**

## 通过域范围委派的权限传播到Workspace <a href="#spreading-to-g-suite-via-domain-wide-delegation-of-authority" id="spreading-to-g-suite-via-domain-wide-delegation-of-authority"></a>

[**Workspace**](https://gsuite.google.com)是Google的**协作和生产力平台**，包括Gmail、Google日历、Google云端硬盘、Google文档等。

GCP中的**服务账户**可以通过模拟合法用户，被授予**以编程方式访问Workspace用户数据的权利**。这被称为[域范围委派](https://developers.google.com/admin-sdk/reports/v1/guides/delegation)。这包括像在GMail中**阅读** **电子邮件**、访问Google文档，甚至在G Suite组织中创建新的用户账户等操作。

Workspace拥有[自己的API](https://developers.google.com/gsuite/aspects/apis)，与GCP完全分开。权限被授予Workspace，**GCP和Workspace之间没有任何默认关系**。

然而，可以**给**服务账户**权限**来控制Workspace用户。如果此时您可以访问Web UI，您可以浏览到**IAM -> 服务账户**，看看是否有任何账户在**"域范围委派"列下列出了"已启用"**。如果没有启用的账户，该列本身可能**不会显示**（您可以阅读每个服务账户的详细信息来确认这一点）。截至本文撰写时，没有办法以编程方式做到这一点，尽管在Google的错误跟踪器中有一个[此功能的请求](https://issuetracker.google.com/issues/116182848)。

要创建这种关系，需要在GCP和Workforce中**启用它**。

#### 测试Workspace访问

要测试此访问，您需要将**服务账户凭据以JSON**格式导出。您可能已经在之前的步骤中获得了这些，或者您现在可能有权限为您知道已启用域范围委派的服务账户创建密钥。

这个话题有点棘手……您的服务账户有一个称为"client_email"的东西，您可以在导出的JSON凭证文件中看到。它可能看起来像`account-name@project-name.iam.gserviceaccount.com`。如果您尝试直接使用该电子邮件访问Workforce API调用，即使启用了委派，您也会失败。这是因为Workforce目录不会包含GCP服务账户的电子邮件地址。相反，要与Workforce互动，我们实际上需要模拟有效的Workforce用户。

您真正想做的是**模拟具有管理访问权限的用户**，然后使用该访问权限做一些事情，比如**重置密码、禁用多因素认证，或者只是为自己创建一个崭新的管理员账户**。

Gitlab创建了[这个Python脚本](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp_misc/blob/master/gcp_delegation.py)，它可以做两件事 - 列出用户目录和创建一个新的管理账户。以下是您使用它的方式：
```bash
# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
您可以尝试在一系列电子邮件地址上运行此脚本，以模拟**各种** **用户**。标准输出将指示服务账户是否有权访问Workforce，并将包括**随机密码用于新管理员账户**（如果创建了一个）。

如果您成功创建了一个新的管理员账户，您可以登录到[Google管理控制台](https://admin.google.com)，并完全控制G Suite中每个用户的一切 - 电子邮件、文档、日历等。尽情享用。

## 参考资料

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
