# GCP - KMS Manager Enum

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## KMS

[**Cloud Key Management Service**](https://cloud.google.com/kms/docs/)は、**暗号化および復号化に使用される暗号鍵**などを**保存するリポジトリ**です。個々の鍵は鍵リングに保存され、鍵リングまたは鍵レベルで細かい権限を適用できます。

KMS鍵リングは**デフォルトでグローバルに作成され**、その鍵リング内の鍵はどのリージョンからでもアクセス可能です。ただし、**特定のリージョン**で特定の鍵リングを作成することも可能です。

### 鍵の保護レベル

* **ソフトウェア鍵**: ソフトウェア鍵は**完全にソフトウェアでKMSによって作成および管理されます**。これらの鍵は**ハードウェアセキュリティモジュール（HSM）によって保護されていません**。テストや開発目的に使用できますが、セキュリティが低く攻撃に対して脆弱であるため、**本番環境での使用は推奨されません**。
* **クラウドホスト型鍵**: クラウドホスト型鍵は、高可用性かつ信頼性の高いインフラを使用して**クラウドでKMSによって作成および管理されます**。これらの鍵は**HSMによって保護されています**が、HSMは**特定の顧客に専用ではありません**。クラウドホスト型鍵は、ほとんどの本番環境のユースケースに適しています。
* **外部鍵**: 外部鍵は**KMSの外部で作成および管理され**、暗号化操作に使用するためにKMSにインポートされます。外部鍵は**顧客の好みに応じてハードウェアセキュリティモジュール（HSM）またはソフトウェアライブラリに保存できます**。

### 鍵の目的

* **対称暗号化/復号化**: **単一の鍵を使用してデータを暗号化および復号化するために使用されます**。対称鍵は、大量のデータを暗号化および復号化するために迅速かつ効率的です。
* **対応**: [cryptoKeys.encrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/encrypt), [cryptoKeys.decrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys/decrypt)
* **非対称署名**: 二者間の安全な通信に使用され、鍵を共有することなく行います。非対称鍵は、**公開鍵と秘密鍵**のペアで構成されます。公開鍵は他者と共有され、秘密鍵は秘密に保たれます。
* **対応:** [cryptoKeyVersions.asymmetricSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricSign), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **非対称復号化**: メッセージやデータの真正性を検証するために使用されます。デジタル署名は秘密鍵を使用して作成され、対応する公開鍵を使用して検証できます。
* **対応:** [cryptoKeyVersions.asymmetricDecrypt](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/asymmetricDecrypt), [cryptoKeyVersions.getPublicKey](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/getPublicKey)
* **MAC署名**: **秘密鍵を使用してメッセージ認証コード（MAC）を作成することにより、データの完全性と真正性を保証するために使用されます**。HMACは、ネットワークプロトコルやソフトウェアアプリケーションでメッセージ認証に一般的に使用されます。
* **対応:** [cryptoKeyVersions.macSign](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macSign), [cryptoKeyVersions.macVerify](https://cloud.google.com/kms/docs/reference/rest/v1/projects.locations.keyRings.cryptoKeys.cryptoKeyVersions/macVerify)

### 回転期間 & 破壊予定期間

**デフォルト**では、**90日ごと**ですが、**簡単に**かつ**完全にカスタマイズ可能です**。

「破壊予定」期間は、ユーザーが鍵の削除を要求してから鍵が**削除される**までの**時間**です。鍵が作成された後は変更できません（デフォルトは1日）。

### 列挙

**鍵のリストを表示する権限がある場合**、以下の方法でアクセスできます：
```bash
# List the global keyrings available
gcloud kms keyrings list --location global
gcloud kms keyrings get-iam-policy <KEYRING>

# List the keys inside a keyring
gcloud kms keys list --keyring <KEYRING> --location <global/other_locations>
gcloud kms keys get-iam-policy <KEY>

# Encrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global

# Decrypt a file using one of your keys
gcloud kms decrypt --ciphertext-file=[INFILE] \
--plaintext-file=[OUTFILE] \
--key [KEY] \
--keyring [KEYRING] \
--location global
```
### 権限昇格

{% content-ref url="../gcp-privilege-escalation/gcp-kms-privesc.md" %}
[gcp-kms-privesc.md](../gcp-privilege-escalation/gcp-kms-privesc.md)
{% endcontent-ref %}

## 参考文献

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/#reviewing-stackdriver-logging)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
