# GCP - Basic Information

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Resource hierarchy**

Google Cloud uses a [Resource hierarchy](https://cloud.google.com/resource-manager/docs/cloud-platform-resource-hierarchy) that is similar, conceptually, to that of a traditional filesystem. This provides a logical parent/child workflow with specific attachment points for policies and permissions.

At a high level, it looks like this:
```
Organization
--> Folders
--> Projects
--> Resources
```
# **Projects Migration**

**ghItlh** **Compute Instance** **(Compute Instance)** **resource** **ghItlh**. **resource** **project** **resides** **ghItlh**, **Compute Instances**, **storage buckets**, **etc**. **ghItlh**.

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Organization Policies**

**ghItlh** **centralize control** **organization's cloud resources**:

* **ghItlh** **configure restrictions** **organization‚Äôs resources** **ghItlh**.
* **ghItlh** **guardrails** **development teams** **compliance boundaries** **ghItlh**.
* **ghItlh** **project owners** **teams move quickly** **breaking compliance**.

**policies** **ghItlh** **created** **affect** **complete organization, folder(s) or project(s)**. **Descendants** **targeted resource hierarchy node** **inherit organization policy**.

**ghItlh** **define** **organization policy**, **ghItlh** **choose a** [**constraint**](https://cloud.google.com/resource-manager/docs/organization-policy/overview#constraints)**, which** **restriction** **Google Cloud service** **group** **Google Cloud services**. **ghItlh** **configure** **constraint** **desired restrictions**.

<figure><img src="../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

#### **Common use cases <a href="#common_use_cases" id="common_use_cases"></a>**

* **Limit resource sharing** **domain**.
* **Limit usage** **Identity and Access Management service accounts**.
* **Restrict physical location** **newly created resources**.
* **Disable service account creation**.

<figure><img src="../../.gitbook/assets/image (83).png" alt=""><figcaption></figcaption></figure>

**policies** **ghItlh** **give** **fine-grained control** **organization's resources**. **ghItlh** **more information**, **[list of all Organization Policy Service constraints](https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints)**.

### **Default Organization Policies**

<details>

<summary>**ghItlh** **policies** **Google** **add** **default** **setting up** **GCP organization**:</summary>

**Access Management Policies**

* **Domain restricted contacts:** **Prevents adding users** **Essential Contacts** **specified domains**. **ghItlh** **Essential Contacts** **allow managed user identities** **selected domains** **receive platform notifications**.
* **Domain restricted sharing:** **Prevents adding users** **IAM policies** **specified domains**. **ghItlh** **IAM policies** **allow managed user identities** **selected domains** **access resources** **organization**.
* **Public access prevention:** **Prevents Cloud Storage buckets** **exposed** **public**. **ghItlh** **developer** **configure Cloud Storage buckets** **unauthenticated internet access**.
* **Uniform bucket level access:** **Prevents object-level access control lists (ACLs)** **Cloud Storage buckets**. **ghItlh** **simplify access management** **apply IAM policies consistently** **objects** **Cloud Storage buckets**.
* **Require OS login:** **VMs created** **new projects** **OS Login enabled**. **ghItlh** **manage SSH access** **instances** **IAM** **create** **manage individual SSH keys**.

**Additional security policies** **service accounts**

* **Disable automatic IAM grants**: **Prevents default App Engine** **Compute Engine service accounts** **automatically granted** **Editor IAM role** **project** **creation**. **ghItlh** **service accounts** **receive overly-permissive IAM roles** **creation**.
* **Disable service account key creation**: **Prevents creation** **public service account keys**. **ghItlh** **reduce risk** **exposing persistent credentials**.
* **Disable service account key upload**: **Prevents uploading** **public service account keys**. **ghItlh** **reduce risk** **leaked** **reused key material**.

**Secure VPC network configuration policies**

* **Define allowed external IPs** **VM instances**: **Prevents creation** **Compute instances** **public IP**, **expose** **internet traffic**.

<!---->

* **Disable VM nested virtualization**: **Prevents creation** **nested VMs** **Compute Engine VMs**. **ghItlh** **decrease security risk** **unmonitored nested VMs**.

<!---->

* **Disable VM serial port:** **Prevents serial port access** **Compute Engine VMs**. **ghItlh** **prevent input** **server‚Äôs serial port** **Compute Engine API**.

<!---->

* **Restrict authorized networks** **Cloud SQL instances:** **Prevents public** **non-internal network ranges** **accessing** **Cloud SQL databases**.

<!---->

* **Restrict Protocol Forwarding Based** **type** **IP Address:** **Prevents VM protocol forwarding** **external IP addresses**.

<!---->

* **Restrict Public IP access** **Cloud SQL instances:** **Prevents creation** **Cloud SQL instances** **public IP**, **expose** **internet traffic**.

<!---->

* **Restrict shared VPC project lien removal:** **Prevents accidental deletion** **Shared VPC host projects**.

<!---->

* **Sets internal DNS setting** **new projects** **Zonal DNS Only:** **Prevents use** **legacy DNS setting** **reduced service availability**.

<!---->

* **Skip default network creation:** **Prevents automatic creation** **default VPC network** **related resources**. **ghItlh** **avoid overly-permissive default firewall rules**.

<!---->

* **Disable VPC External IPv6 usage:** **Prevents creation** **external IPv6 subnets**, **expose** **unauthorized internet access**.

</details>

## **IAM Roles**

**ghItlh** **IAM policies** **AWS** **role** **contains** **set of permissions**.

**However**, **AWS**, **ghItlh** **centralized repo** **roles**. **ghItlh** **resources** **give X access roles** **Y principals**, **ghItlh** **find out** **access** **resource** **use** **`get-iam-policy` method** **resource**.\
**ghItlh** **problem** **ghItlh** **means** **find out** **permissions** **principal** **ask every resource** **giving permissions to**, **user** **permissions** **get permissions** **resources**.

**ghItlh** **three types** **roles** **IAM**:

* **Basic/Primitive roles**, **include** **Owner**, **Editor**, **Viewer** roles** **existed** **introduction** **IAM**.
* **Predefined roles**, **provide granular access** **specific service** **managed** **Google Cloud**. **ghItlh** **lot** **predefined roles**, **see all of them with the privileges they have** [**here**](https://cloud.google.com/iam/docs/understanding-roles#predefined\_roles)**.**
* **Custom roles**, **provide granular access** **according** **user-specified list** **permissions**.

**ghItlh** **thousands of permissions** **GCP**. **ghItlh** **check** **role** **permissions** **[search the permission here](https://cloud.google.com/iam/docs/permissions-reference)** **see** **roles** **have it**.

**ghItlh** **search** **predefined roles** **[search here predefined roles](https://cloud.google.com/iam/docs/understanding-roles#product\_specific\_documentation)** **offered** **product**. **ghItlh** **roles** **attached** **users** **SAs** **permissions** **contain**.\
**Moreover**, **ghItlh** **permissions** **take effect** **attached** **relevant service**.

**ghItlh** **check** **custom role** **use** **[specific permission in here](https://cloud.google.com/iam/docs/custom-roles-permissions-support)**.

{% content-ref url="gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}
## Users <a href="#default-credentials" id="default-credentials"></a>

**GCP console** **ghItlh** **Users or Groups** management, **Google Workspace**. **identity provider** synchronize **Google Workspace**.

Workspaces **users and groups in** [**https://admin.google.com**](https://admin.google.com/) **access**.

**MFA** **forced** Workspaces users, **attacker** **token** GCP **cli MFA protected** (MFA **user logins generate**: `gcloud auth login`).

## Groups

organisation **created** groups **strongly suggested** **created.** manage **compromised** organization:

<table data-header-hidden><thead><tr><th width="299.3076923076923"></th><th></th></tr></thead><tbody><tr><td><strong>Group</strong></td><td><strong>Function</strong></td></tr><tr><td><strong><code>gcp-organization-admins</code></strong><br><em>(group or individual accounts required for checklist)</em></td><td>Administering any resource that belongs to the organization. Assign this role sparingly; org admins have access to all of your Google Cloud resources. Alternatively, because this function is highly privileged, consider using individual accounts instead of creating a group.</td></tr><tr><td><strong><code>gcp-network-admins</code></strong><br><em>(required for checklist)</em></td><td>Creating networks, subnets, firewall rules, and network devices such as Cloud Router, Cloud VPN, and cloud load balancers.</td></tr><tr><td><strong><code>gcp-billing-admins</code></strong><br><em>(required for checklist)</em></td><td>Setting up billing accounts and monitoring their usage.</td></tr><tr><td><strong><code>gcp-developers</code></strong><br><em>(required for checklist)</em></td><td>Designing, coding, and testing applications.</td></tr><tr><td><strong><code>gcp-security-admins</code></strong><br></td><td>Establishing and managing security policies for the entire organization, including access management and <a href="https://cloud.google.com/resource-manager/docs/organization-policy/org-policy-constraints">organization constraint policies</a>. See the <a href="https://cloud.google.com/architecture/security-foundations/authentication-authorization#users_and_groups">Google Cloud security foundations guide</a> for more information about planning your Google Cloud security infrastructure.</td></tr><tr><td><strong><code>gcp-devops</code></strong></td><td>Creating or managing end-to-end pipelines that support continuous integration and delivery, monitoring, and system provisioning.</td></tr><tr><td><strong><code>gcp-logging-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-logging-viewers</code></strong></td><td></td></tr><tr><td><strong><code>gcp-monitor-admins</code></strong></td><td></td></tr><tr><td><strong><code>gcp-billing-viewer</code></strong><br><em>(no longer by default)</em></td><td>Monitoring the spend on projects. Typical members are part of the finance team.</td></tr><tr><td><strong><code>gcp-platform-viewer</code></strong><br><em>(no longer by default)</em></td><td>Reviewing resource information across the Google Cloud organization.</td></tr><tr><td><strong><code>gcp-security-reviewer</code></strong><br><em>(no longer by default)</em></td><td>Reviewing cloud security.</td></tr><tr><td><strong><code>gcp-network-viewer</code></strong><br><em>(no longer by default)</em></td><td>Reviewing network configurations.</td></tr><tr><td><strong><code>grp-gcp-audit-viewer</code></strong><br><em>(no longer by default)</em></td><td>Viewing audit logs.</td></tr><tr><td><strong><code>gcp-scc-admin</code></strong><br><em>(no longer by default)</em></td><td>Administering Security Command Center.</td></tr><tr><td><strong><code>gcp-secrets-admin</code></strong><br><em>(no longer by default)</em></td><td>Managing secrets in Secret Manager.</td></tr></tbody></table>

## **Default Password Policy**

* Enforce strong passwords
* Between 8 and 100 characters
* No reuse
* No expiration
* If people is accessing Workspace through a third party provider, these requirements aren't applied.

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## **Service accounts**

**resources** **attached** **access** GCP **principals** **have** **attached** **interact**. **example**, **auth token** Service Account **attached to a VM** **metadata** **access**.\
**conflicts** **IAM and access scopes** **possible**. **example**, service account **IAM role** `compute.instanceAdmin` **instance** **breached** **scope limitation** `https://www.googleapis.com/auth/compute.readonly`. **prevent** **changes** OAuth token **automatically assigned** instance.

**IAM roles from AWS** **similar**. **AWS**, **any** service account **attached to any service** (allow **policy**).

**automatically generated by GCP** **service accounts** **start using a service**, like:
```
PROJECT_NUMBER-compute@developer.gserviceaccount.com
PROJECT_ID@appspot.gserviceaccount.com
```
**Qagh**, 'e' vItlhutlh resources **custom service accounts** yuQjIjDI' 'ej **attach**.
```
SERVICE_ACCOUNT_NAME@PROJECT_NAME.iam.gserviceaccount.com
```
### **QapHa'mey**

QapHa'mey **OAuth tokens**-e' **GCP API endpoints**-mey **ghItlh**. QapHa'mey **OAuth token**-mey **ghItlh**-e' **ghItlh**.\
QapHa'mey token **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**-e' **ghItlh**.

Google [recommends](https://cloud.google.com/compute/docs/access/service-accounts#service\_account\_permissions) **access scopes are not used and to rely totally on IAM**. The web management portal actually enforces this, but access scopes can still be applied to instances using custom service accounts programmatically.

You can see what **scopes** are **assigned** by **querying:**

{% code overflow="wrap" %}
```bash
curl 'https://www.googleapis.com/oauth2/v1/tokeninfo?access_token=<access_token>'

{
"issued_to": "223044615559.apps.googleusercontent.com",
"audience": "223044615559.apps.googleusercontent.com",
"user_id": "139746512919298469201",
"scope": "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/appengine.admin https://www.googleapis.com/auth/sqlservice.login https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/accounts.reauth",
"expires_in": 2253,
"email": "username@testing.com",
"verified_email": true,
"access_type": "offline"
}
```
{% endcode %}

**Scopes** qetlh **default** **`gcloud`** **'e** **data** **access** **'e'** **generated**. **'ach** **'e'** **`gcloud`** **'e'** **use** **token OAuth** **create** **'ej** **endpoints** **contact** **'e'** **'ej** **use**.

**'ach** **important scope** **'e'** **'oH** **potentially** **'oH** **`cloud-platform`**, **'ej** **basically** **'oH** **'ej** **'oH** **'ej** **GCP** **service** **access** **possible**.

**'ej** **'oH** **'e'** **[list** **possible scopes** **'e'** **'ej** **'oH** **'e'**](https://developers.google.com/identity/protocols/googlescopes)**.**

**'ej** **'oH** **'e'** **'oH** **'e'** **token** **'ej** **scopes** **'oH** **obtain** **possible,** **'ach** **something** **like** **'e'**:

{% code overflow="wrap" %}
```bash
# Maybe you can get a user token with other scopes changing the scopes array from ~/.config/gcloud/credentials.db

# Set new scopes for SDKs credentials
gcloud auth application-default login --scopes=https://www.googleapis.com/auth/userinfo.email,https://www.googleapis.com/auth/cloud-platform,https://www.googleapis.com/auth/sqlservice.login,https://www.googleapis.com/auth/appengine.admin,https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/accounts.reauth,https://www.googleapis.com/auth/admin.directory.user,https://www.googleapis.com/auth/admin.directory.group,https://www.googleapis.com/auth/admin.directory.domain,https://www.googleapis.com/auth/admin.directory.user

# Print new token
gcloud auth application-default print-access-token

# To use this token with some API you might need to use curl to indicate the project header with --header "X-Goog-User-Project: <project-name>"
```
{% endcode %}

## **Terraform IAM Policies, Bindings and Memberships**

As defined by terraform in [https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google\_project\_iam) using terraform with GCP there are different ways to grant a principal access over a resource:

* **Memberships**: You set **principals as members of roles** **without restrictions** over the role or the principals. You can put a user as a member of a role and then put a group as a member of the same role and also set those principals (user and group) as member of other roles.
* **Bindings**: Several **principals can be binded to a role**. Those **principals can still be binded or be members of other roles**. However, if a principal which isn‚Äôt binded to the role is set as **member of a binded role**, the next time the **binding is applied, the membership will disappear**.
* **Policies**: A policy is **authoritative**, it indicates roles and principals and then, **those principals cannot have more roles and those roles cannot have more principals** unless that policy is modified (not even in other policies, bindings or memberships). Therefore, when a role or principal is specified in policy all its privileges are **limited by that policy**. Obviously, this can be bypassed in case the principal is given the option to modify the policy or privilege escalation permissions (like create a new principal and bind him a new role).

## References

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
