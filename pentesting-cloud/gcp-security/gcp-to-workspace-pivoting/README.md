# GCP <--> Workspace Pivoting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **From GCP to GWS**

### **Domain Wide Delegation basics**

Google Workspace's Domain-Wide delegation allows an identity object, either an **external app** from Google Workspace Marketplace or an internal **GCP Service Account**, to **access data across the Workspace on behalf of users**.

{% hint style="info" %}
This basically means that **service accounts** inside GCP projects of an organization might be able to i**mpersonate Workspace users** of the same organization (or even from a different one).
{% endhint %}

For more information about how this exactly works check:

{% content-ref url="gcp-understanding-domain-wide-delegation.md" %}
[gcp-understanding-domain-wide-delegation.md](gcp-understanding-domain-wide-delegation.md)
{% endcontent-ref %}

### Compromise existing delegation

If an attacker **compromised some access over GCP** and **known a valid Workspace user email** (preferably **super admin**) of the company, he could **enumerate all the projects** he has access to, **enumerate all the SAs** of the projects, check to which **service accounts he has access to**, and **repeat** all these steps with each SA he can impersonate.\
With a **list of all the service accounts** he has **access** to and the list of **Workspace** **emails**, the attacker could try to **impersonate user with each service account**.

{% hint style="danger" %}
Note that when configuring the domain wide delegation no Workspace user is needed, therefore just know **one valid one is enough and required for the impersonation**.\
However, the **privileges of the impersonated user will be used**, so if it's Super Admin you will be able to access everything. If it doesn't have any access this will be useless.
{% endhint %}

#### [**DeleFriend**](https://github.com/axon-git/DeleFriend)

This is a tool that can perform the attack following these steps:

1. **Enumerate GCP Projects** using Resource Manager API.
2. Iterate on each project resource, and **enumerate GCP Service account resources** to which the initial IAM user has access using _GetIAMPolicy_.
3. Iterate on **each service account role**, and find built-in, basic, and custom roles with _**serviceAccountKeys.create**_ permission on the target service account resource. It should be noted that the Editor role inherently possesses this permission.
4. Create a **new `KEY_ALG_RSA_2048`** private key to each service account resource which is found with relevant permission in the IAM policy.
5. Iterate on **each new service account and create a `JWT`** **object** for it which is composed of the SA private key credentials and an OAuth scope. The process of creating a new _JWT_ object will **iterate on all the existing combinations of OAuth scopes** from **oauth\_scopes.txt** list, in order to find all the delegation possibilities. The list **oauth\_scopes.txt** is updated with all of the OAuth scopes we‚Äôve found to be relevant for abusing Workspace identities.
6. The `_make_authorization_grant_assertion` method reveals the necessity to declare a t**arget workspace user**, referred to as _subject_, for generating JWTs under DWD. While this may seem to require a specific user, it's important to realize that **DWD influences every identity within a domain**. Consequently, creating a JWT for **any domain user** affects all identities in that domain, consistent with our combination enumeration check. Simply put, one valid Workspace user is adequate to move forward.\
This user can be defined in DeleFriend‚Äôs _config.yaml_ file. If a target workspace user is not already known, the tool facilitates the automatic identification of valid workspace users by scanning domain users with roles on GCP projects. It's key to note (again) that JWTs are domain-specific and not generated for every user; hence, the automatic process targets a single unique identity per domain.
7. **Enumerate and create a new bearer access token** for each JWT and validate the token against tokeninfo API.

#### [Gitlab's Python script](https://gitlab.com/gitlab-com/gl-security/threatmanagement/redteam/redteam-public/gcp\_misc/-/blob/master/gcp\_delegation.py)

Gitlab've created [this Python script](https://gitlab.com/gitlab-com/gl-security/gl-redteam/gcp\_misc/blob/master/gcp\_delegation.py) that can do two things - list the user directory and create a new administrative account while indicating a json with SA credentials and the user to impersonate. Here is how you would use it:
```bash
# Install requirements
pip install --upgrade --user oauth2client

# Validate access only
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com

# List the directory
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--list

# Create a new admin account
./gcp_delegation.py --keyfile ./credentials.json \
--impersonate steve.admin@target-org.com \
--domain target-org.com \
--account pwned
```
### Qa'chuq Delegation Qap (Persistence)

**https://admin.google.com/u/1/ac/owl/domainwidedelegation** [**https://admin.google.com/u/1/ac/owl/domainwidedelegation**](https://admin.google.com/u/1/ac/owl/domainwidedelegation)**.** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations** **Domain Wide Delegations**
```bash
# Create project
gcloud projects create <uniq-projec-name> --name=proj-name
# Set project
gcloud config set project <uniq-projec-name>
# Enable svcs
gcloud services enable admin.googleapis.com
gcloud services enable cloudidentity.googleapis.com
# Get org ID
gcloud organizations list
# Get currents email user groups
gcloud identity groups memberships search-transitive-groups --member-email <email> --labels=cloudidentity.googleapis.com/groups.discussion_forum

# FROM HERE THE USER NEEDS TO HAVE ENOUGH WORKSPACE ACCESS
gcloud beta identity groups preview --customer <org-cust-id>
```
{% endcode %}

**more enumeration in** **ghItlhvam** **chel**:

{% content-ref url="../gcp-services/gcp-iam-and-org-policies-enum.md" %}
[gcp-iam-and-org-policies-enum.md](../gcp-services/gcp-iam-and-org-policies-enum.md)
{% endcontent-ref %}

## GWS to GCP

### **GWS** **ghaH** **GCP** **ghaH**

**GWS** **ghaH** **ghaH** **'e'** **attackers** **'e'** **GWS** **ghaH** **'e'** **users** **'e'** **GCP** **ghaH** **'e'** **'e'** **"simple"** **'e'** **'ach** **users** **GWS** **ghaH** **'e'** **'e'** **high privileges** **GCP**.&#x20;

### Google Groups **ghaH** **'ej** **Privilege Escalation**

**users** **'e'** **'ach** **Workspace** **ghaH** **'e'** **Organization** **ghaH** **'ej** **groups** **'e'** **'ach** **GCP** **permissions** **'e'** **assigned** (check your groups in [https://groups.google.com/](https://groups.google.com/)).

**google groups privesc** **ghaH** **'ej** **'ach** **group** **'e'** **privileged access** **GCP** **'e'** **escalate**.

### References

* [https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover](https://www.hunters.security/en/blog/delefriend-a-newly-discovered-design-flaw-in-domain-wide-delegation-could-leave-google-workspace-vulnerable-for-takeover)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
