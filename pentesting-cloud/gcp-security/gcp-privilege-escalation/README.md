# GCP - Privilege Escalation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Introduction to GCP Privilege Escalation <a href="#introduction-to-gcp-privilege-escalation" id="introduction-to-gcp-privilege-escalation"></a>

GCPëŠ” ë‹¤ë¥¸ í´ë¼ìš°ë“œì™€ ë§ˆì°¬ê°€ì§€ë¡œ ëª‡ ê°€ì§€ **ì£¼ì²´**: ì‚¬ìš©ì, ê·¸ë£¹ ë° ì„œë¹„ìŠ¤ ê³„ì •ê³¼ ëª‡ ê°€ì§€ **ë¦¬ì†ŒìŠ¤**: ì»´í“¨íŠ¸ ì—”ì§„, í´ë¼ìš°ë“œ í•¨ìˆ˜ ë“±ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.\
ê·¸ëŸ° ë‹¤ìŒ ì—­í• ì„ í†µí•´ **ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì£¼ì²´ì˜ ê¶Œí•œì´ ë¶€ì—¬ë©ë‹ˆë‹¤**. ì´ê²ƒì€ GCPì—ì„œ ì£¼ì²´ê°€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ ê°€ì§€ëŠ” ê¶Œí•œì„ ì§€ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.\
ì‚¬ìš©ìê°€ ë¦¬ì†ŒìŠ¤ ë˜ëŠ” ì œ3ì ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ **ë” ë§ì€ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆëŠ” íŠ¹ì • ê¶Œí•œ**ì´ ìˆìœ¼ë©°, ì´ë¥¼ **ê¶Œí•œ ìƒìŠ¹**ì´ë¼ê³  í•©ë‹ˆë‹¤(ë˜í•œ, ë” ë§ì€ ê¶Œí•œì„ ì–»ê¸° ìœ„í•œ ì·¨ì•½ì  ì•…ìš©).

ë”°ë¼ì„œ GCP ê¶Œí•œ ìƒìŠ¹ ê¸°ìˆ ì„ **2ê°œ ê·¸ë£¹**ìœ¼ë¡œ ë‚˜ëˆ„ê³ ì í•©ë‹ˆë‹¤:

* **ì£¼ì²´ì— ëŒ€í•œ ê¶Œí•œ ìƒìŠ¹**: ì´ëŠ” ë‹¤ë¥¸ ì£¼ì²´ë¥¼ **ê°€ì¥í•  ìˆ˜ ìˆê²Œ í•´ì£¼ë©°**, ë”°ë¼ì„œ ëª¨ë“  ê¶Œí•œìœ¼ë¡œ í–‰ë™í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì˜ˆ: _getAccessToken_ì„ ì•…ìš©í•˜ì—¬ ì„œë¹„ìŠ¤ ê³„ì •ì„ ê°€ì¥í•©ë‹ˆë‹¤.
* **ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œ ìƒìŠ¹**: ì´ëŠ” íŠ¹ì • ë¦¬ì†ŒìŠ¤ì— ëŒ€í•´ **ë” ë§ì€ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ì˜ˆ: í´ë¼ìš°ë“œ í•¨ìˆ˜ì— ëŒ€í•´ _setIamPolicy_ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ íŠ¸ë¦¬ê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
* ì¼ë¶€ **ë¦¬ì†ŒìŠ¤ ê¶Œí•œì€ ë¦¬ì†ŒìŠ¤ì— ì„ì˜ì˜ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì—°ê²°í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ì´ëŠ” SAì™€ í•¨ê»˜ ë¦¬ì†ŒìŠ¤ë¥¼ ì‹œì‘í•˜ê³ , ë¦¬ì†ŒìŠ¤ì— ë“¤ì–´ê°€ì„œ **SA í† í°ì„ í›”ì¹  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤**. ë”°ë¼ì„œ ì´ëŠ” ë¦¬ì†ŒìŠ¤ ìƒìŠ¹ì„ í†µí•´ ì£¼ì²´ë¡œ ìƒìŠ¹í•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤. ì´ëŠ” ì´ì „ì— ì—¬ëŸ¬ ë¦¬ì†ŒìŠ¤ì—ì„œ ë°œìƒí–ˆì§€ë§Œ, ì§€ê¸ˆì€ ëœ ë¹ˆë²ˆí•©ë‹ˆë‹¤(í•˜ì§€ë§Œ ì—¬ì „íˆ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤).

ëª…ë°±íˆ, ê°€ì¥ í¥ë¯¸ë¡œìš´ ê¶Œí•œ ìƒìŠ¹ ê¸°ìˆ ì€ **ë‘ ë²ˆì§¸ ê·¸ë£¹**ì˜ ê¸°ìˆ ì…ë‹ˆë‹¤. ì™œëƒí•˜ë©´ ì´ëŠ” **ì´ë¯¸ ì¼ë¶€ ê¶Œí•œì´ ìˆëŠ” ë¦¬ì†ŒìŠ¤ ì™¸ë¶€ì—ì„œ ë” ë§ì€ ê¶Œí•œì„ ì–»ì„ ìˆ˜ ìˆê²Œ í•´ì£¼ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤**. ê·¸ëŸ¬ë‚˜ **ë¦¬ì†ŒìŠ¤ì—ì„œ ìƒìŠ¹í•˜ëŠ” ê²ƒ**ì€ **ë¯¼ê°í•œ ì •ë³´**ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œê³µí•˜ê±°ë‚˜ ì‹¬ì§€ì–´ **ë‹¤ë¥¸ ì£¼ì²´**ì— ëŒ€í•œ ì ‘ê·¼ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤(ì•„ë§ˆë„ SAì˜ í† í°ì„ í¬í•¨í•˜ëŠ” ë¹„ë°€ì„ ì½ìŒìœ¼ë¡œì¨).

{% hint style="warning" %}
**GCP ì„œë¹„ìŠ¤ ê³„ì •ì€ ì£¼ì²´ì™€ ê¶Œí•œ ëª¨ë‘**ë¼ëŠ” ì ë„ ì¤‘ìš”í•©ë‹ˆë‹¤. ë”°ë¼ì„œ SAì—ì„œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ë©´ ê·¸ê²ƒì„ ê°€ì¥í•  ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.
{% endhint %}

{% hint style="info" %}
ê´„í˜¸ ì•ˆì˜ ê¶Œí•œì€ `gcloud`ë¡œ ì·¨ì•½ì ì„ ì•…ìš©í•˜ëŠ” ë° í•„ìš”í•œ ê¶Œí•œì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. APIë¥¼ í†µí•´ ì•…ìš©í•  ê²½ìš° í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
{% endhint %}

## Permissions for Privilege Escalation Methodology

ì´ê²ƒì€ GCP ë‚´ì—ì„œ íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ **íŠ¹ì • ê¶Œí•œì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤.

1. github ë¦¬í¬ì§€í† ë¦¬ ë‹¤ìš´ë¡œë“œ [https://github.com/carlospolop/gcp\_privesc\_scripts](https://github.com/carlospolop/gcp_privesc_scripts)
2. tests/ì— ìƒˆ ìŠ¤í¬ë¦½íŠ¸ ì¶”ê°€

## Bypassing access scopes <a href="#bypassing-access-scopes" id="bypassing-access-scopes"></a>

GCP ë©”íƒ€ë°ì´í„° ì„œë¹„ìŠ¤ì—ì„œ ìœ ì¶œëœ SAì˜ í† í°ì€ **ì•¡ì„¸ìŠ¤ ë²”ìœ„**ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” í† í°ì´ ê°€ì§„ **ê¶Œí•œ**ì— ëŒ€í•œ **ì œí•œ**ì…ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, í† í°ì´ **`https://www.googleapis.com/auth/cloud-platform`** ë²”ìœ„ë¥¼ ê°€ì§€ë©´ ëª¨ë“  GCP ì„œë¹„ìŠ¤ì— **ì „ì²´ ì ‘ê·¼**í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ í† í°ì´ **`https://www.googleapis.com/auth/cloud-platform.read-only`** ë²”ìœ„ë¥¼ ê°€ì§€ë©´ SAê°€ IAMì—ì„œ ë” ë§ì€ ê¶Œí•œì„ ê°€ì§€ê³  ìˆë”ë¼ë„ ëª¨ë“  GCP ì„œë¹„ìŠ¤ì— ëŒ€í•´ **ì½ê¸° ì „ìš© ì ‘ê·¼**ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ê¶Œí•œì„ ìš°íšŒí•˜ëŠ” ì§ì ‘ì ì¸ ë°©ë²•ì€ ì—†ì§€ë§Œ, ì†ìƒëœ í˜¸ìŠ¤íŠ¸ì—ì„œ **ìƒˆ ìê²© ì¦ëª…**ì„ ê²€ìƒ‰í•˜ê±°ë‚˜, **ì œí•œ ì—†ì´ OAuth í† í°ì„ ìƒì„±í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤ í‚¤ë¥¼ ì°¾ê±°ë‚˜**, **ì œí•œì´ ëœí•œ ë‹¤ë¥¸ VMìœ¼ë¡œ ì í”„**í•˜ëŠ” ê²ƒì„ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[ì•¡ì„¸ìŠ¤ ë²”ìœ„](https://cloud.google.com/compute/docs/access/service-accounts#accesscopesiam)ê°€ ì‚¬ìš©ë  ë•Œ, ì»´í“¨íŒ… ì¸ìŠ¤í„´ìŠ¤(VM)ì— ëŒ€í•´ ìƒì„±ëœ OAuth í† í°ì€ **ì œí•œì´ í¬í•¨ëœ** [**ë²”ìœ„**](https://oauth.net/2/scope/)ë¥¼ ê°€ì§‘ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì†ìƒëœ ê³„ì •ì´ ê°€ì§„ ê¶Œí•œì„ ì•…ìš©í•˜ê³  ì´ ì œí•œì„ **ìš°íšŒ**í•  ìˆ˜ ìˆì„ì§€ë„ ëª¨ë¦…ë‹ˆë‹¤.

ì´ ì œí•œì„ **ìš°íšŒí•˜ëŠ” ê°€ì¥ ì¢‹ì€ ë°©ë²•**ì€ ì†ìƒëœ í˜¸ìŠ¤íŠ¸ì—ì„œ **ìƒˆ ìê²© ì¦ëª…**ì„ ì°¾ê±°ë‚˜, **ì œí•œ ì—†ì´ OAuth í† í°ì„ ìƒì„±í•˜ê¸° ìœ„í•œ ì„œë¹„ìŠ¤ í‚¤ë¥¼ ì°¾ê±°ë‚˜**, **ëœ ì œí•œëœ SAê°€ ìˆëŠ” ë‹¤ë¥¸ VMì„ ì†ìƒì‹œí‚¤ëŠ” ê²ƒ**ì…ë‹ˆë‹¤.

Check SA with keys generated with:
```bash
for i in $(gcloud iam service-accounts list --format="table[no-heading](email)"); do
echo "Looking for keys for $i:"
gcloud iam service-accounts keys list --iam-account $i
done
```
## Privilege Escalation Techniques

AWSì—ì„œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ëŠ” ë°©ë²•ì€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ ê³„ì •/ì‚¬ìš©ì/ê·¸ë£¹ì˜ ê¶Œí•œì— ì ‘ê·¼í•  ìˆ˜ ìˆì„ ë§Œí¼ ì¶©ë¶„í•œ ê¶Œí•œì„ ê°–ëŠ” ê²ƒì…ë‹ˆë‹¤. ê¶Œí•œ ìƒìŠ¹ì„ ì—°ê²°í•˜ì—¬ ì¡°ì§ì— ëŒ€í•œ ê´€ë¦¬ì ì ‘ê·¼ ê¶Œí•œì„ ì–»ëŠ” ê²ƒì…ë‹ˆë‹¤.

{% hint style="warning" %}
GCPì—ëŠ” ì—”í‹°í‹°ì— ë¶€ì—¬ë  ìˆ˜ ìˆëŠ” **ìˆ˜ë°±** (ì•„ë‹ˆë©´ ìˆ˜ì²œ)ì˜ **ê¶Œí•œ**ì´ ìˆìŠµë‹ˆë‹¤. ì´ ì±…ì—ì„œëŠ” **ë‚´ê°€ ì•„ëŠ” ëª¨ë“  ê¶Œí•œ**ì„ ì°¾ì„ ìˆ˜ ìˆìœ¼ë©°, ì´ë¥¼ **ì•…ìš©í•˜ì—¬ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜** ìˆì§€ë§Œ, ì—¬ê¸° ì–¸ê¸‰ë˜ì§€ ì•Šì€ **ì–´ë–¤ ê²½ë¡œ**ë¥¼ **ì•Œê³  ìˆë‹¤ë©´** **ê³µìœ í•´ ì£¼ì„¸ìš”**.
{% endhint %}

**ì´ ì„¹ì…˜ì˜ í•˜ìœ„ í˜ì´ì§€ëŠ” ì„œë¹„ìŠ¤ë³„ë¡œ ì •ë ¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê° ì„œë¹„ìŠ¤ì—ì„œ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¤ëŠ” ë‹¤ì–‘í•œ ë°©ë²•ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

### GCPë¥¼ ì•…ìš©í•˜ì—¬ ë¡œì»¬ì—ì„œ ê¶Œí•œ ìƒìŠ¹í•˜ê¸°

GCPì˜ ë¨¸ì‹  ë‚´ë¶€ì— ìˆë‹¤ë©´ ê¶Œí•œì„ ì•…ìš©í•˜ì—¬ ë¡œì»¬ì—ì„œë„ ê¶Œí•œì„ ìƒìŠ¹ì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

{% content-ref url="gcp-local-privilege-escalation-ssh-pivoting.md" %}
[gcp-local-privilege-escalation-ssh-pivoting.md](gcp-local-privilege-escalation-ssh-pivoting.md)
{% endcontent-ref %}

## References

* [https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/](https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/)
* [https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/](https://rhinosecuritylabs.com/cloud-security/privilege-escalation-google-cloud-platform-part-2/#gcp-privesc-scanner)
* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
