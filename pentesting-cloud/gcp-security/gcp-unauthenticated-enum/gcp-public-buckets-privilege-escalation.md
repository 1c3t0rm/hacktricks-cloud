# GCP - Escalaci√≥n de Privilegios en Buckets P√∫blicos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Escalaci√≥n de Privilegios en Buckets

Si la pol√≠tica del bucket permite que "allUsers" o "allAuthenticatedUsers" **escriban en su pol√≠tica de bucket** (el permiso **storage.buckets.setIamPolicy**), entonces cualquiera puede modificar la pol√≠tica del bucket y otorgarse acceso completo.

### Verificar Permisos

Hay 2 formas de verificar los permisos sobre un bucket. La primera es solicitarlos haciendo una petici√≥n a `https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam` o ejecutando `gsutil iam get gs://BUCKET_NAME`.

Sin embargo, si tu usuario (potencialmente perteneciente a "allUsers" o "allAuthenticatedUsers") no tiene permisos para leer la pol√≠tica iam del bucket (storage.buckets.getIamPolicy), eso no funcionar√°.

La otra opci√≥n, que siempre funcionar√°, es utilizar el endpoint testPermissions del bucket para averiguar si tienes el permiso especificado, por ejemplo accediendo a: `https://www.googleapis.com/storage/v1/b/BUCKET_NAME/iam/testPermissions?permissions=storage.buckets.delete&permissions=storage.buckets.get&permissions=storage.buckets.getIamPolicy&permissions=storage.buckets.setIamPolicy&permissions=storage.buckets.update&permissions=storage.objects.create&permissions=storage.objects.delete&permissions=storage.objects.get&permissions=storage.objects.list&permissions=storage.objects.update`

### Escalando

Con el programa CLI de Google Storage "gsutil", podemos ejecutar el siguiente comando para otorgar acceso al rol de "Storage Admin" a "allAuthenticatedUsers", **escalando as√≠ los privilegios que nos fueron otorgados** al bucket:
```
gsutil iam ch group:allAuthenticatedUsers:admin gs://BUCKET_NAME
```
Uno de los principales atractivos para escalar de LegacyBucketOwner a Storage Admin es la capacidad de usar el privilegio "storage.buckets.delete". En teor√≠a, podr√≠as **eliminar el bucket despu√©s de escalar tus privilegios, luego podr√≠as crear el bucket en tu propia cuenta para robar el nombre**.

## Referencias

* [https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/](https://rhinosecuritylabs.com/gcp/google-cloud-platform-gcp-bucket-enumeration/)

<details>

<summary><strong>Aprende AWS hacking de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
