# Az - Tokens & Public Applications

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Entra ID es la plataforma de gesti칩n de identidad y acceso (IAM) basada en la nube de Microsoft, que sirve como el sistema fundamental de autenticaci칩n y autorizaci칩n para servicios como Microsoft 365 y Azure Resource Manager. Azure AD implementa el marco de autorizaci칩n OAuth 2.0 y el protocolo de autenticaci칩n OpenID Connect (OIDC) para gestionar el acceso a los recursos.

### OAuth

**Participantes Clave en OAuth 2.0:**

1. **Servidor de Recursos (RS):** Protege los recursos propiedad del propietario del recurso.
2. **Propietario del Recurso (RO):** T칤picamente un usuario final que posee los recursos protegidos.
3. **Aplicaci칩n Cliente (CA):** Una aplicaci칩n que busca acceso a recursos en nombre del propietario del recurso.
4. **Servidor de Autorizaci칩n (AS):** Emite tokens de acceso a las aplicaciones cliente despu칠s de autenticar y autorizar.

**츼mbitos y Consentimiento:**

* **츼mbitos:** Permisos granulares definidos en el servidor de recursos que especifican niveles de acceso.
* **Consentimiento:** El proceso mediante el cual un propietario de recurso otorga a una aplicaci칩n cliente permiso para acceder a recursos con 치mbitos espec칤ficos.

**Integraci칩n con Microsoft 365:**

* Microsoft 365 utiliza Azure AD para IAM y est치 compuesto por m칰ltiples aplicaciones OAuth de "primera parte".
* Estas aplicaciones est치n profundamente integradas y a menudo tienen relaciones de servicio interdependientes.
* Para simplificar la experiencia del usuario y mantener la funcionalidad, Microsoft otorga "consentimiento impl칤cito" o "pre-consentimiento" a estas aplicaciones de primera parte.
* **Consentimiento Impl칤cito:** Ciertas aplicaciones son autom치ticamente **otorgadas acceso a 치mbitos espec칤ficos sin aprobaci칩n expl칤cita del usuario o administrador**.
* Estos 치mbitos pre-consentidos suelen estar ocultos tanto para los usuarios como para los administradores, haci칠ndolos menos visibles en las interfaces de gesti칩n est치ndar.

**Tipos de Aplicaciones Cliente:**

1. **Clientes Confidenciales:**
* Poseen sus propias credenciales (por ejemplo, contrase침as o certificados).
* Pueden **autenticarse de manera segura** ante el servidor de autorizaci칩n.
2. **Clientes P칰blicos:**
* No tienen credenciales 칰nicas.
* No pueden autenticarse de manera segura ante el servidor de autorizaci칩n.
* **Implicaci칩n de Seguridad:** Un atacante puede suplantar una aplicaci칩n cliente p칰blica al solicitar tokens, ya que no hay un mecanismo para que el servidor de autorizaci칩n verifique la legitimidad de la aplicaci칩n.

## Authentication Tokens

Hay **tres tipos de tokens** utilizados en OIDC:

* [**Access Tokens**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** El cliente presenta este token al servidor de recursos para **acceder a los recursos**. Solo se puede usar para una combinaci칩n espec칤fica de usuario, cliente y recurso y **no puede ser revocado** hasta su expiraci칩n, que es de 1 hora por defecto.
* **ID Tokens**: El cliente recibe este **token del servidor de autorizaci칩n**. Contiene informaci칩n b치sica sobre el usuario. Est치 **vinculado a una combinaci칩n espec칤fica de usuario y cliente**.
* **Refresh Tokens**: Proporcionados al cliente con el token de acceso. Se utilizan para **obtener nuevos tokens de acceso e ID**. Est치 vinculado a una combinaci칩n espec칤fica de usuario y cliente y puede ser revocado. La expiraci칩n por defecto es de **90 d칤as** para tokens de actualizaci칩n inactivos y **sin expiraci칩n para tokens activos** (es posible obtener nuevos tokens de actualizaci칩n a partir de un token de actualizaci칩n).
* Un token de actualizaci칩n debe estar vinculado a un **`aud`**, a algunos **치mbitos**, y a un **inquilino** y solo deber칤a poder generar tokens de acceso para ese aud, 치mbitos (y no m치s) e inquilino. Sin embargo, este no es el caso con los **tokens de aplicaciones FOCI**.
* Un token de actualizaci칩n est치 cifrado y solo Microsoft puede descifrarlo.
* Obtener un nuevo token de actualizaci칩n no revoca el token de actualizaci칩n anterior.

{% hint style="warning" %}
La informaci칩n para **acceso condicional** est치 **almacenada** dentro del **JWT**. As칤 que, si solicitas el **token desde una direcci칩n IP permitida**, esa **IP** ser치 **almacenada** en el token y luego puedes usar ese token desde una **IP no permitida para acceder a los recursos**.
{% endhint %}

### Access Tokens "aud"

El campo indicado en el campo "aud" es el **servidor de recursos** (la aplicaci칩n) utilizado para realizar el inicio de sesi칩n.

El comando `az account get-access-token --resource-type [...]` soporta los siguientes tipos y cada uno de ellos a침adir치 un "aud" espec칤fico en el token de acceso resultante:

{% hint style="danger" %}
Ten en cuenta que los siguientes son solo las API soportadas por `az account get-access-token`, pero hay m치s.
{% endhint %}

<details>

<summary>ejemplos de aud</summary>

* **aad-graph (Azure Active Directory Graph API)**: Utilizado para acceder a la API de Azure AD Graph heredada (obsoleta), que permite a las aplicaciones leer y escribir datos de directorio en Azure Active Directory (Azure AD).
* `https://graph.windows.net/`

- **arm (Azure Resource Manager)**: Utilizado para gestionar recursos de Azure a trav칠s de la API de Azure Resource Manager. Esto incluye operaciones como crear, actualizar y eliminar recursos como m치quinas virtuales, cuentas de almacenamiento, y m치s.
* `https://management.core.windows.net/ or https://management.azure.com/`

* **batch (Azure Batch Services)**: Utilizado para acceder a Azure Batch, un servicio que permite aplicaciones de computaci칩n paralela y de alto rendimiento a gran escala de manera eficiente en la nube.
* `https://batch.core.windows.net/`

- **data-lake (Azure Data Lake Storage)**: Utilizado para interactuar con Azure Data Lake Storage Gen1, que es un servicio de almacenamiento y an치lisis de datos escalable.
* `https://datalake.azure.net/`

* **media (Azure Media Services)**: Utilizado para acceder a Azure Media Services, que proporciona servicios de procesamiento y entrega de medios basados en la nube para contenido de video y audio.
* `https://rest.media.azure.net`

- **ms-graph (Microsoft Graph API)**: Utilizado para acceder a la API de Microsoft Graph, el punto de acceso unificado para los datos de servicios de Microsoft 365. Permite acceder a datos e informaci칩n de servicios como Azure AD, Office 365, Enterprise Mobility y servicios de Seguridad.
* `https://graph.microsoft.com`

* **oss-rdbms (Azure Open Source Relational Databases)**: Utilizado para acceder a los servicios de base de datos de Azure para motores de bases de datos relacionales de c칩digo abierto como MySQL, PostgreSQL y MariaDB.
* `https://ossrdbms-aad.database.windows.net`

</details>

### Access Tokens Scopes "scp"

El 치mbito de un token de acceso se almacena dentro de la clave scp dentro del JWT del token de acceso. Estos 치mbitos definen a qu칠 tiene acceso el token de acceso.

Si un JWT tiene permitido contactar una API espec칤fica pero **no tiene el 치mbito** para realizar la acci칩n solicitada, **no podr치 realizar la acci칩n** con ese JWT.

### Get refresh & access token example
```python
# Code example from https://github.com/secureworks/family-of-client-ids-research
import msal
import requests
import jwt
from pprint import pprint
from typing import Any, Dict, List


# LOGIN VIA CODE FLOW AUTHENTICATION
azure_cli_client = msal.PublicClientApplication(
"04b07795-8ddb-461a-bbee-02f9e1bf7b46" # ID for Azure CLI client
)
device_flow = azure_cli_client.initiate_device_flow(
scopes=["https://graph.microsoft.com/.default"]
)
print(device_flow["message"])

# Perform device code flow authentication

azure_cli_bearer_tokens_for_graph_api = azure_cli_client.acquire_token_by_device_flow(
device_flow
)
pprint(azure_cli_bearer_tokens_for_graph_api)



# DECODE JWT
def decode_jwt(base64_blob: str) -> Dict[str, Any]:
"""Decodes base64 encoded JWT blob"""
return jwt.decode(
base64_blob, options={"verify_signature": False, "verify_aud": False}
)
decoded_access_token = decode_jwt(
azure_cli_bearer_tokens_for_graph_api.get("access_token")
)
pprint(decoded_access_token)


# GET NEW ACCESS TOKEN AND REFRESH TOKEN
new_azure_cli_bearer_tokens_for_graph_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
azure_cli_bearer_tokens_for_graph_api.get("refresh_token"),
# Same scopes as original authorization
scopes=["https://graph.microsoft.com/.default"],
)
)
pprint(new_azure_cli_bearer_tokens_for_graph_api)
```
## Escalaci칩n de privilegios de tokens FOCI

Anteriormente se mencion칩 que los tokens de actualizaci칩n deben estar vinculados a los **alcances** con los que se generaron, a la **aplicaci칩n** y al **inquilino** para el que se generaron. Si se rompe alguno de estos l칤mites, es posible escalar privilegios, ya que ser치 posible generar tokens de acceso a otros recursos e inquilinos a los que el usuario tiene acceso y con m치s alcances de los que se pretend칤a originalmente.

Adem치s, **esto es posible con todos los tokens de actualizaci칩n** en la [plataforma de identidad de Microsoft](https://learn.microsoft.com/en-us/entra/identity-platform/) (cuentas de Microsoft Entra, cuentas personales de Microsoft y cuentas sociales como Facebook y Google) porque, como mencionan los [**docs**](https://learn.microsoft.com/en-us/entra/identity-platform/refresh-tokens): "Los tokens de actualizaci칩n est치n vinculados a una combinaci칩n de usuario y cliente, pero **no est치n vinculados a un recurso o inquilino**. Un cliente puede usar un token de actualizaci칩n para adquirir tokens de acceso **a trav칠s de cualquier combinaci칩n de recurso e inquilino** donde tenga permiso para hacerlo. Los tokens de actualizaci칩n est치n encriptados y solo la plataforma de identidad de Microsoft puede leerlos."

Adem치s, tenga en cuenta que las aplicaciones FOCI son aplicaciones p칰blicas, por lo que **no se necesita un secreto** para autenticarse en el servidor.

Los clientes FOCI conocidos reportados en la [**investigaci칩n original**](https://github.com/secureworks/family-of-client-ids-research/tree/main) se pueden [**encontrar aqu칤**](https://github.com/secureworks/family-of-client-ids-research/blob/main/known-foci-clients.csv).

### Obtener un alcance diferente

Siguiendo con el c칩digo de ejemplo anterior, en este c칩digo se solicita un nuevo token para un alcance diferente:
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
azure_cli_bearer_tokens_for_outlook_api = (
# Same client as original authorization
azure_cli_client.acquire_token_by_refresh_token(
new_azure_cli_bearer_tokens_for_graph_api.get(
"refresh_token"
),
# But different scopes than original authorization
scopes=[
"https://outlook.office.com/.default"
],
)
)
pprint(azure_cli_bearer_tokens_for_outlook_api)
```
### Obtener diferentes clientes y 치mbitos
```python
# Code from https://github.com/secureworks/family-of-client-ids-research
microsoft_office_client = msal.PublicClientApplication("d3590ed6-52b3-4102-aeff-aad2292ab01c")
microsoft_office_bearer_tokens_for_graph_api = (
# This is a different client application than we used in the previous examples
microsoft_office_client.acquire_token_by_refresh_token(
# But we can use the refresh token issued to our original client application
azure_cli_bearer_tokens_for_outlook_api.get("refresh_token"),
# And request different scopes too
scopes=["https://graph.microsoft.com/.default"],
)
)
# How is this possible?
pprint(microsoft_office_bearer_tokens_for_graph_api)
```
## Referencias

* [https://github.com/secureworks/family-of-client-ids-research](https://github.com/secureworks/family-of-client-ids-research)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
