# Az - Conditional Access Policies / MFA Bypass

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basic Information

Azure Conditional Access policies are rules set up in Microsoft Azure to enforce access controls to Azure services and applications based on certain **conditions**. These policies help organizations secure their resources by applying the right access controls under the right circumstances.\
Conditional access policies basically **defines** **Who** can access **What** from **Where** and **How**.

Here are a couple of examples:

1. **Sign-In Risk Policy**: This policy could be set to require multi-factor authentication (MFA) when a sign-in risk is detected. For example, if a user's login behavior is unusual compared to their regular pattern, such as logging in from a different country, the system can prompt for additional authentication.
2. **Device Compliance Policy**: This policy can restrict access to Azure services only to devices that are compliant with the organization's security standards. For instance, access could be allowed only from devices that have up-to-date antivirus software or are running a certain operating system version.

## Conditional Acces Policies Bypasses

It's possible that a conditional access policy is **checking some information that can be easily tampered allowing a bypass of the policy**. And if for example the policy was configuring MFA, the attacker will be able to bypass it.

### Device Platforms - Device Condition

It's possible to set a condition based on the **device platform** (Android, iOS, Windows, macOS), however, this is based on the **user-agent** so it's pretty easy to bypass. Even **making all the options enforce MFA**, if you use a **user-agent that it doesn't recognize** you will be able to bypass the MFA.

### Locations: Countries, IP ranges - Device Condition

Of course if this is set in the conditional policy, an attacker could just use a **VPN** in the **allowed country** or try to find a way to access from an **allowed IP address** to bypass these conditions.

### Office365 Client Apps

You could indicate that if clients **access Office 365 apps from the browser they need MFA**:

<figure><img src="../../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

To bypass this, it's possible to pretend you log-in into an app from a desktop application (like to Microsoft Teams in the following example) which will bypass the protection:
```bash
roadrecon auth -u user@email.com -r https://outlook.office.com/ -c 1fec8e78-bce4-4aaf-ab1b-5451cc387264 --tokrns-stdout

<token>
```
As Microsoft Teams app has a lot of permissions, you will be able to use that access.

{% hint style="success" %}
You can find the I**D of more public applications** with predefined Office365 permissions in the database of roadtools:

{% code overflow="wrap" %}
Klingon Translation:

**jatlh Microsoft Teams app vItlhutlh permissions, 'oH access vItlhutlh.**

{% hint style="success" %}
**public applications** 'e' vItlhutlh Office365 permissions predefined I**D** roadtools database vItlhutlh:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

**vItlhutlh** **attack** **vItlhutlh** **vItlhutlh** **Office365** **applications** **permissions** **access** **data**.

### **lo'laHbe'**

**lo'laHbe'** **users** **permissions** **private**.\
**'oH** **users** **'oH** **'oH** **permissions** **'oH**.

**scenario** **policy** **MFA** **application** **user** **browser** (**web application** **way**), **proxy application** -**users** **interact** **apps**- **user** **login** **proxy application** **login** **MFA protected app**.

**[Invoke-MFASweep](az-conditional-access-policies-mfa-bypass.md#invoke-mfasweep)** **[donkeytoken](az-conditional-access-policies-mfa-bypass.md#donkeytoken)**.

## **lo'laHbe' Az MFA Bypasses**

### **Ring tone**

**Azure MFA** **option** **configured phone number** **call** **char `#`** **send** **user**.

{% hint style="danger" %}
**chars** **tones**, **attacker** **compromise** **voicemail** **phone number**, **message** **tone `#`** **configure**, **requesting** **MFA** **victims phone** **busy** (calling it) **Azure call** **redirected** **voice mail**.
{% endhint %}

### **Compliant Devices**

**Policies** **compliant device** **MFA**, **attacker** **register** **compliant device**, **PRT** **token** **bypass** **MFA**.

**register** **compliant device** **Intune**, **PRT** **get** **vItlhutlh**.
```powershell
$prtKeys = Get-AADIntuneUserPRTKeys - PfxFileName .\<uuid>.pfx -Credentials $credentials

$prtToken = New-AADIntUserPRTToken -Settings $prtKeys -GertNonce

Get-AADIntAccessTokenForAADGraph -PRTToken $prtToken

<token returned>
```
jImej vItlhutlh pagh:

{% content-ref url="../az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](../az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Tooling

### [roadrecon](https://github.com/dirkjanm/ROADtools)

ghItlh policies vItlhutlh.
```bash
roadrecon plugin policies
```
### [Invoke-MFASweep](https://github.com/dafthack/MFASweep)

MFASweep jenbogh vItlhutlh PowerShell script'e' 'ej **Microsoft services vItlhutlh credentials set provided log in attempt 'ej MFA enabled vItlhutlh**. conditional access policies 'ej multi-factor authentication settings configured protocols 'oH single factor left end up. ADFS configurations 'ej on-prem ADFS server detected log in attempt vItlhutlh check additional.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### [donkeytoken](https://github.com/silverhack/donkeytoken)

Donkey token jup 'e' set 'o' functions vaj 'e' 'o' security consultants vaj 'e' validate Conditional Access Policies, tests for 2FA-enabled Microsoft portals, etc..
```powershell
Import-Module 'C:\Users\Administrador\Desktop\Azure\Modulos ps1\donkeytoken' -Force
```
**Test each portal** if it's possible to **login without MFA**:

**qaStaHvIS portal** **yIlo'** **login** **ghItlh** **MFA** **chImej**.
```powershell
Test-MFA -credential $cred -Verbose -Debug -InformationAction Continue
```
**Azure** **portal** **QIn** **not constrained** **'e'** **token** **gather** **portal endpoint** **access** **service detected** **previous execution** **possible**. **Sharepoint** **identified**, **token** **access** **requested**:

{% code overflow="wrap" %}
```powershell
$token = Get-DelegationTokenFromAzurePortal -credential $cred -token_type microsoft.graph -extension_type Microsoft_Intune
Read-JWTtoken -token $token.access_token
```
{% endcode %}

Supposing the token has the permission Sites.Read.All (from Sharepoint), even if you cannot access Sharepoint from the web because of MFA, it's possible to use the token to access the files with the generated token:

---

{% endcode %}


Supposing the token has the permission Sites.Read.All (from Sharepoint), even if you cannot access Sharepoint from the web because of MFA, it's possible to use the token to access the files with the generated token:
```powershell
$data = Get-SharePointFilesFromGraph -authentication $token $data[0].downloadUrl
```
## References

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
