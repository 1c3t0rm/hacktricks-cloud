# Az - Pol√≠ticas de Acesso Condicional / Bypass de MFA

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

As pol√≠ticas de Acesso Condicional do Azure s√£o regras configuradas no Microsoft Azure para impor controles de acesso aos servi√ßos e aplica√ß√µes do Azure com base em certas **condi√ß√µes**. Essas pol√≠ticas ajudam as organiza√ß√µes a proteger seus recursos aplicando os controles de acesso corretos nas circunst√¢ncias adequadas.\
As pol√≠ticas de acesso condicional basicamente **definem** **Quem** pode acessar **O qu√™** de **Onde** e **Como**.

Aqui est√£o alguns exemplos:

1. **Pol√≠tica de Risco de Sign-In**: Esta pol√≠tica pode ser configurada para exigir autentica√ß√£o de m√∫ltiplos fatores (MFA) quando um risco de sign-in √© detectado. Por exemplo, se o comportamento de login de um usu√°rio √© incomum em compara√ß√£o com seu padr√£o regular, como fazer login de um pa√≠s diferente, o sistema pode solicitar autentica√ß√£o adicional.
2. **Pol√≠tica de Conformidade de Dispositivos**: Esta pol√≠tica pode restringir o acesso aos servi√ßos do Azure apenas a dispositivos que estejam em conformidade com os padr√µes de seguran√ßa da organiza√ß√£o. Por exemplo, o acesso pode ser permitido apenas de dispositivos que tenham software antiv√≠rus atualizado ou que estejam executando uma vers√£o espec√≠fica do sistema operacional.

## Bypasses de Pol√≠ticas de Acesso Condicional

√â poss√≠vel que uma pol√≠tica de acesso condicional esteja **verificando algumas informa√ß√µes que podem ser facilmente adulteradas permitindo um bypass da pol√≠tica**. E se, por exemplo, a pol√≠tica estava configurando MFA, o atacante poder√° contorn√°-la.

### Plataformas de Dispositivos - Condi√ß√£o de Dispositivo

√â poss√≠vel definir uma condi√ß√£o baseada na **plataforma do dispositivo** (Android, iOS, Windows, macOS), no entanto, isso √© baseado no **user-agent** ent√£o √© bem f√°cil de contornar. Mesmo **fazendo todas as op√ß√µes aplicarem MFA**, se voc√™ usar um **user-agent que n√£o seja reconhecido** voc√™ poder√° contornar o MFA.

### Localiza√ß√µes: Pa√≠ses, Faixas de IP - Condi√ß√£o de Dispositivo

Claro que se isso estiver configurado na pol√≠tica condicional, um atacante poderia simplesmente usar uma **VPN** no **pa√≠s permitido** ou tentar encontrar uma maneira de acessar de um **endere√ßo IP permitido** para contornar essas condi√ß√µes.

### Aplicativos Cliente do Office365

Voc√™ poderia indicar que se os clientes **acessarem aplicativos do Office 365 pelo navegador eles precisam de MFA**:

<figure><img src="../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Para contornar isso, √© poss√≠vel fingir que voc√™ est√° fazendo login em um aplicativo de um aplicativo de desktop (como o Microsoft Teams no exemplo a seguir) que contornar√° a prote√ß√£o:

<figure><img src="../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

Como o aplicativo Microsoft Teams tem muitas permiss√µes, voc√™ poder√° usar esse acesso.

{% hint style="success" %}
Voc√™ pode encontrar o **ID de mais aplica√ß√µes p√∫blicas** com permiss√µes predefinidas do Office365 no banco de dados do roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Este ataque √© especialmente interessante porque, por padr√£o, aplica√ß√µes p√∫blicas do Office365 ter√£o permiss√µes para acessar alguns dados.

### Outras aplica√ß√µes

Por padr√£o, outras aplica√ß√µes criadas por usu√°rios n√£o ter√£o permiss√µes e podem ser privadas.\
No entanto, usu√°rios tamb√©m podem criar **aplica√ß√µes p√∫blicas** concedendo-lhes algumas **permiss√µes.**

Um cen√°rio potencial onde uma pol√≠tica √© definida para **exigir MFA para acessar uma aplica√ß√£o** quando o usu√°rio est√° usando um **navegador** (talvez porque seja uma aplica√ß√£o web e, portanto, ser√° a √∫nica maneira), se houver uma **aplica√ß√£o proxy** - uma aplica√ß√£o permitida para **interagir com outras aplica√ß√µes em nome dos usu√°rios** -, o usu√°rio poderia **fazer login na aplica√ß√£o proxy** e ent√£o, atrav√©s desta aplica√ß√£o proxy, **fazer login na aplica√ß√£o inicialmente protegida por MFA**.

## Outros M√©todos de Bypass do Az MFA

### Tom de chamada

Uma op√ß√£o do Azure MFA √© **receber uma chamada no n√∫mero de telefone configurado** onde ser√° pedido ao usu√°rio para **enviar o caractere `#`**.

{% hint style="danger" %}
Como caracteres s√£o apenas **tons**, um atacante poderia **comprometer** a **mensagem de correio de voz** do n√∫mero de telefone, configurar como mensagem o **tom de `#`** e ent√£o, ao solicitar o MFA, certificar-se de que o **telefone da v√≠tima est√° ocupado** (chamando-o) para que a chamada do Azure seja redirecionada para o correio de voz.
{% endhint %}

### Dispositivos Compat√≠veis

Pol√≠ticas frequentemente pedem por um dispositivo compat√≠vel ou MFA, ent√£o um **atacante poderia registrar um dispositivo compat√≠vel**, obter um token **PRT** e **bypassar o MFA desta forma**.

Comece registrando um **dispositivo compat√≠vel no Intune**, depois **obtenha o PRT** com:

<figure><img src="../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

Encontre mais informa√ß√µes sobre este tipo de ataque na seguinte p√°gina:

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Ferramentas

### Invoke-MFASweep

MFASweep √© um script PowerShell que tenta **fazer login em v√°rios servi√ßos da Microsoft usando um conjunto fornecido de credenciais e tentar√° identificar se o MFA est√° habilitado**. Dependendo de como as pol√≠ticas de acesso condicional e outras configura√ß√µes de autentica√ß√£o multifator est√£o configuradas, alguns protocolos podem acabar sendo deixados com um √∫nico fator. Ele tamb√©m tem uma verifica√ß√£o adicional para configura√ß√µes de ADFS e pode tentar fazer login no servidor ADFS local se detectado.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### roadrecon

Obtenha todas as pol√≠ticas
```bash
roadrecon plugin policies
```
## Refer√™ncias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
