# Az - 条件付きアクセスポリシー / MFAバイパス

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

## 基本情報

Azure 条件付きアクセスポリシーは、特定の**条件**に基づいてAzureサービスとアプリケーションへのアクセス制御を強制するためにMicrosoft Azureで設定されるルールです。これらのポリシーは、適切な状況下で適切なアクセス制御を適用することにより、組織のリソースを保護するのに役立ちます。\
条件付きアクセスポリシーは基本的に**誰**が**何**に**どこから**そして**どのように**アクセスできるかを**定義します**。

いくつかの例を挙げます：

1. **サインインリスクポリシー**：このポリシーは、サインインリスクが検出された場合に多要素認証（MFA）を要求するように設定できます。例えば、ユーザーのログイン行動が通常のパターンと異なる場合、例えば異なる国からのログインなど、システムは追加の認証を求めることができます。
2. **デバイスコンプライアンスポリシー**：このポリシーは、組織のセキュリティ基準に準拠しているデバイスのみにAzureサービスへのアクセスを制限することができます。例えば、最新のアンチウイルスソフトウェアがインストールされているデバイスや、特定のオペレーティングシステムバージョンを実行しているデバイスからのみアクセスを許可することができます。

## 条件付きアクセスポリシーのバイパス

条件付きアクセスポリシーが**簡単に改ざんできる情報をチェックしている可能性があり、ポリシーをバイパスすることができます**。例えば、ポリシーがMFAを設定していた場合、攻撃者はそれをバイパスすることができるでしょう。

### デバイスプラットフォーム - デバイス条件

**デバイスプラットフォーム**（Android、iOS、Windows、macOS）に基づいて条件を設定することができますが、これは**ユーザーエージェント**に基づいているため、バイパスは非常に簡単です。**すべてのオプションでMFAを強制しても**、**認識されないユーザーエージェントを使用する**と、MFAをバイパスすることができます。

### 位置情報：国、IP範囲 - デバイス条件

もちろん、これが条件付きポリシーに設定されている場合、攻撃者は**許可された国のVPN**を使用するか、**許可されたIPアドレス**からアクセスする方法を見つけることで、これらの条件をバイパスすることができます。

### Office365クライアントアプリ

ブラウザからOffice 365アプリにアクセスするクライアントはMFAが必要であると指定することができます：

<figure><img src="../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

これをバイパスするには、デスクトップアプリケーション（以下の例のMicrosoft Teamsのように）からアプリにログインするふりをすることができ、これにより保護をバイパスすることができます：

<figure><img src="../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

Microsoft Teamsアプリには多くの権限があるため、そのアクセスを使用することができます。

{% hint style="success" %}
roadtoolsのデータベースで、事前に定義されたOffice365の権限を持つ**より多くの公開アプリケーションのID**を見つけることができます：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

この攻撃は特に興味深いです。なぜなら、デフォルトでは公開されているOffice365アプリケーションは、ある程度のデータへのアクセス権を持っているからです。

### その他のアプリ

デフォルトでは、ユーザーが作成したその他のアプリは権限を持たず、プライベートである可能性があります。\
しかし、ユーザーは**公開**された**アプリ**を作成し、それにいくつかの**権限**を与えることもできます。

ポリシーが**アプリケーションへのアクセスにMFAを要求する**ように設定されている場合、ユーザーが**ブラウザ**を使用しているとき（おそらくウェブアプリケーションであるため、それが唯一の方法になるでしょう）、**プロキシアプリケーション**がある場合 - ユーザーに代わって他のアプリと**対話することを許可されたアプリケーション** - ユーザーは**プロキシアプリケーションにログイン**し、そのプロキシアプリケーションを介して当初MFAで保護されていたアプリに**ログインする**ことができます。

## その他のAz MFAバイパス

### リングトーン

Azure MFAのオプションの一つに、設定された電話番号に**電話を受け、ユーザーに`#`キャラクターの**送信を求めるものがあります。

{% hint style="danger" %}
キャラクターは単なる**トーン**であるため、攻撃者は電話番号の**ボイスメール**メッセージを**侵害**し、メッセージとして`#`の**トーン**を設定し、MFAを要求する際に**被害者の電話が使用中**であることを確認します（それに電話をかける）ので、Azureの電話がボイスメールに転送されます。
{% endhint %}

### コンプライアントデバイス

ポリシーはしばしば、コンプライアントデバイスまたはMFAを要求するため、**攻撃者はコンプライアントデバイスを登録**し、**PRT**トークンを取得し、この方法で**MFAをバイパス**することができます。

Intuneで**コンプライアントデバイスを登録**し、次に**PRTを取得**します：

<figure><img src="../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

この種の攻撃に関する詳細情報は、以下のページで見つけることができます：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## ツール

### Invoke-MFASweep

MFASweepはPowerShellスクリプトで、提供された資格情報を使用して様々なMicrosoftサービスに**ログインを試み、MFAが有効になっているかどうかを特定しようとします**。条件付きアクセスポリシーとその他の多要素認証設定によっては、一部のプロトコルがシングルファクターのままになる可能性があります。また、ADFSの設定に対する追加チェックがあり、検出された場合にはオンプレミスのADFSサーバーにログインを試みることができます。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### roadrecon

すべてのポリシーを取得
```bash
roadrecon plugin policies
```
## 参考文献

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
