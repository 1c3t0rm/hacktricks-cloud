# Az - Pol√≠ticas de Acceso Condicional / Bypass de MFA

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repos de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

Las pol√≠ticas de Acceso Condicional de Azure son reglas establecidas en Microsoft Azure para hacer cumplir controles de acceso a servicios y aplicaciones de Azure basados en ciertas **condiciones**. Estas pol√≠ticas ayudan a las organizaciones a asegurar sus recursos aplicando los controles de acceso correctos bajo las circunstancias adecuadas.\
Las pol√≠ticas de acceso condicional b√°sicamente **definen** **Qui√©n** puede acceder a **Qu√©** desde **D√≥nde** y **C√≥mo**.

Aqu√≠ hay un par de ejemplos:

1. **Pol√≠tica de Riesgo de Inicio de Sesi√≥n**: Esta pol√≠tica podr√≠a configurarse para requerir autenticaci√≥n de m√∫ltiples factores (MFA) cuando se detecta un riesgo de inicio de sesi√≥n. Por ejemplo, si el comportamiento de inicio de sesi√≥n de un usuario es inusual en comparaci√≥n con su patr√≥n regular, como iniciar sesi√≥n desde otro pa√≠s, el sistema puede solicitar autenticaci√≥n adicional.
2. **Pol√≠tica de Cumplimiento de Dispositivos**: Esta pol√≠tica puede restringir el acceso a servicios de Azure solo a dispositivos que cumplan con los est√°ndares de seguridad de la organizaci√≥n. Por ejemplo, el acceso podr√≠a permitirse solo desde dispositivos que tengan software antivirus actualizado o que est√©n ejecutando una versi√≥n espec√≠fica del sistema operativo.

## Bypass de Pol√≠ticas de Acceso Condicional

Es posible que una pol√≠tica de acceso condicional est√© **verificando informaci√≥n que puede ser f√°cilmente manipulada permitiendo el bypass de la pol√≠tica**. Y si por ejemplo la pol√≠tica estaba configurando MFA, el atacante podr√° eludirla.

### Plataformas de Dispositivos - Condici√≥n de Dispositivo

Es posible establecer una condici√≥n basada en la **plataforma del dispositivo** (Android, iOS, Windows, macOS), sin embargo, esto se basa en el **agente de usuario** por lo que es bastante f√°cil de eludir. Incluso **haciendo que todas las opciones hagan cumplir MFA**, si usas un **agente de usuario que no reconoce** podr√°s eludir el MFA.

### Ubicaciones: Pa√≠ses, Rangos de IP - Condici√≥n de Dispositivo

Por supuesto, si esto se establece en la pol√≠tica condicional, un atacante podr√≠a simplemente usar una **VPN** en el **pa√≠s permitido** o tratar de encontrar una manera de acceder desde una **direcci√≥n IP permitida** para eludir estas condiciones.

### Aplicaciones Cliente de Office365

Podr√≠as indicar que si los clientes **acceden a aplicaciones de Office 365 desde el navegador necesitan MFA**:

<figure><img src="../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Para eludir esto, es posible fingir que inicias sesi√≥n en una aplicaci√≥n desde una aplicaci√≥n de escritorio (como Microsoft Teams en el siguiente ejemplo) lo que eludir√° la protecci√≥n:

<figure><img src="../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

Como la aplicaci√≥n de Microsoft Teams tiene muchos permisos, podr√°s usar ese acceso.

{% hint style="success" %}
Puedes encontrar el **ID de m√°s aplicaciones p√∫blicas** con permisos predefinidos de Office365 en la base de datos de roadtools:

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Este ataque es especialmente interesante porque por defecto las aplicaciones p√∫blicas de Office365 tendr√°n permisos para acceder a algunos datos.

### Otras aplicaciones

Por defecto, otras aplicaciones creadas por usuarios no tendr√°n permisos y podr√≠an ser privadas.\
Sin embargo, los usuarios tambi√©n podr√≠an crear **aplicaciones p√∫blicas** otorg√°ndoles algunos **permisos.**

Un escenario potencial donde se establece una pol√≠tica para **requerir MFA para acceder a una aplicaci√≥n** cuando el usuario est√° utilizando un **navegador** (quiz√°s porque es una aplicaci√≥n web y por lo tanto ser√° la √∫nica manera), si hay una **aplicaci√≥n proxy** -una aplicaci√≥n permitida para **interactuar con otras aplicaciones en nombre de los usuarios**-, el usuario podr√≠a **iniciar sesi√≥n en la aplicaci√≥n proxy** y luego a trav√©s de esta aplicaci√≥n proxy **iniciar sesi√≥n en la aplicaci√≥n inicialmente protegida por MFA**.

## Otros m√©todos de evasi√≥n de MFA de Az

### Tono de llamada

Una opci√≥n de MFA de Azure es **recibir una llamada en el n√∫mero de tel√©fono configurado** donde se le pedir√° al usuario que **env√≠e el car√°cter `#`**.

{% hint style="danger" %}
Como los caracteres son solo **tonos**, un atacante podr√≠a **comprometer** el mensaje de **buz√≥n de voz** del n√∫mero de tel√©fono, configurar como mensaje el **tono de `#`** y luego, al solicitar el MFA, asegurarse de que el **tel√©fono de la v√≠ctima est√© ocupado** (llam√°ndolo) para que la llamada de Azure se redirija al buz√≥n de voz.
{% endhint %}

### Dispositivos compatibles

Las pol√≠ticas a menudo solicitan un dispositivo compatible o MFA, por lo que un **atacante podr√≠a registrar un dispositivo compatible**, obtener un token **PRT** y **evadir de esta manera el MFA**.

Comience registrando un **dispositivo compatible en Intune**, luego **obtenga el PRT** con:

<figure><img src="../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

Encuentre m√°s informaci√≥n sobre este tipo de ataque en la siguiente p√°gina:

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Herramientas

### Invoke-MFASweep

MFASweep es un script de PowerShell que intenta **iniciar sesi√≥n en varios servicios de Microsoft utilizando un conjunto de credenciales proporcionado e intentar√° identificar si MFA est√° habilitado**. Dependiendo de c√≥mo est√©n configuradas las pol√≠ticas de acceso condicional y otros ajustes de autenticaci√≥n multifactor, algunos protocolos pueden terminar siendo de un solo factor. Tambi√©n tiene una verificaci√≥n adicional para configuraciones de ADFS y puede intentar iniciar sesi√≥n en el servidor ADFS local si se detecta.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### roadrecon

Obt√©n todas las pol√≠ticas
```bash
roadrecon plugin policies
```
## Referencias

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
