# Az - Politiques d'Acc√®s Conditionnel / Contournement MFA

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de Base

Les politiques d'Acc√®s Conditionnel Azure sont des r√®gles √©tablies dans Microsoft Azure pour appliquer des contr√¥les d'acc√®s aux services et applications Azure en fonction de certaines **conditions**. Ces politiques aident les organisations √† s√©curiser leurs ressources en appliquant les bons contr√¥les d'acc√®s dans les bonnes circonstances.\
Les politiques d'acc√®s conditionnel d√©finissent essentiellement **Qui** peut acc√©der √† **Quoi** depuis **O√π** et **Comment**.

Voici quelques exemples :

1. **Politique de Risque de Connexion** : Cette politique pourrait exiger une authentification √† plusieurs facteurs (MFA) lorsqu'un risque de connexion est d√©tect√©. Par exemple, si le comportement de connexion d'un utilisateur est inhabituel par rapport √† son sch√©ma r√©gulier, comme se connecter depuis un autre pays, le syst√®me peut demander une authentification suppl√©mentaire.
2. **Politique de Conformit√© des Appareils** : Cette politique peut restreindre l'acc√®s aux services Azure uniquement aux appareils conformes aux normes de s√©curit√© de l'organisation. Par exemple, l'acc√®s pourrait √™tre autoris√© uniquement depuis des appareils disposant d'un logiciel antivirus √† jour ou fonctionnant sous une certaine version du syst√®me d'exploitation.

## Contournements des Politiques d'Acc√®s Conditionnel

Il est possible qu'une politique d'acc√®s conditionnel **v√©rifie certaines informations qui peuvent √™tre facilement alt√©r√©es permettant un contournement de la politique**. Et si par exemple la politique configurait la MFA, l'attaquant pourra la contourner.

### Plateformes d'Appareils - Condition d'Appareil

Il est possible de d√©finir une condition bas√©e sur la **plateforme d'appareil** (Android, iOS, Windows, macOS), cependant, cela repose sur le **user-agent** donc c'est assez facile √† contourner. M√™me en **rendant obligatoire la MFA pour toutes les options**, si vous utilisez un **user-agent qu'il ne reconna√Æt pas**, vous pourrez contourner la MFA.

### Emplacements : Pays, Plages IP - Condition d'Appareil

Bien s√ªr, si cela est d√©fini dans la politique conditionnelle, un attaquant pourrait simplement utiliser un **VPN** dans le **pays autoris√©** ou essayer de trouver un moyen d'acc√©der depuis une **adresse IP autoris√©e** pour contourner ces conditions.

### Applications Client Office365

Vous pourriez indiquer que si les clients **acc√®dent aux applications Office 365 depuis le navigateur, ils ont besoin de la MFA** :

<figure><img src="../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

Pour contourner cela, il est possible de pr√©tendre que vous vous connectez √† une application depuis une application de bureau (comme Microsoft Teams dans l'exemple suivant) ce qui contournera la protection :

<figure><img src="../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

Comme l'application Microsoft Teams a beaucoup de permissions, vous pourrez utiliser cet acc√®s.

{% hint style="success" %}
Vous pouvez trouver l'**ID de plus d'applications publiques** avec des permissions Office365 pr√©d√©finies dans la base de donn√©es de roadtools :

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

Cette attaque est particuli√®rement int√©ressante car par d√©faut, les applications Office365 publiques auront la permission d'acc√©der √† certaines donn√©es.

### Autres applications

Par d√©faut, les autres applications cr√©√©es par les utilisateurs n'auront pas de permissions et pourraient √™tre priv√©es.\
Cependant, les utilisateurs pourraient √©galement cr√©er des **applications publiques** leur accordant certaines **permissions.**

Un sc√©nario potentiel o√π une politique est d√©finie pour **exiger MFA pour acc√©der √† une application** lorsque l'utilisateur utilise un **navigateur** (peut-√™tre parce que c'est une application web et donc ce sera le seul moyen), s'il existe une **application proxy** - une application autoris√©e √† **interagir avec d'autres applications au nom des utilisateurs** -, l'utilisateur pourrait **se connecter dans l'application proxy** et ensuite √† travers cette application proxy **se connecter √† l'application initialement prot√©g√©e par MFA**.

## Autres contournements de MFA Az

### Sonnerie

Une option de MFA Azure est de **recevoir un appel sur le num√©ro de t√©l√©phone configur√©** o√π il sera demand√© √† l'utilisateur d'**envoyer le caract√®re `#`**.

{% hint style="danger" %}
Comme les caract√®res sont juste des **tons**, un attaquant pourrait **compromettre** le message de **messagerie vocale** du num√©ro de t√©l√©phone, configurer comme message le **ton de `#`** et ensuite, lors de la demande de MFA, s'assurer que le **t√©l√©phone de la victime est occup√©** (en l'appelant) pour que l'appel Azure soit redirig√© vers la messagerie vocale.
{% endhint %}

### Appareils conformes

Les politiques demandent souvent un appareil conforme ou MFA, donc un **attaquant pourrait enregistrer un appareil conforme**, obtenir un token **PRT** et **contourner de cette mani√®re le MFA**.

Commencez par enregistrer un **appareil conforme dans Intune**, puis **obtenez le PRT** avec :

<figure><img src="../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

Trouvez plus d'informations sur ce type d'attaque √† la page suivante :

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## Outils

### Invoke-MFASweep

MFASweep est un script PowerShell qui tente de **se connecter √† divers services Microsoft en utilisant un ensemble d'identifiants fournis et essaiera d'identifier si MFA est activ√©**. Selon la configuration des politiques d'acc√®s conditionnel et d'autres param√®tres de multi-facteurs, certains protocoles peuvent finir par √™tre laiss√©s √† un seul facteur. Il dispose √©galement d'une v√©rification suppl√©mentaire pour les configurations ADFS et peut tenter de se connecter au serveur ADFS local s'il est d√©tect√©.
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### roadrecon

Obtenez toutes les politiques
```bash
roadrecon plugin policies
```
## R√©f√©rences

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
