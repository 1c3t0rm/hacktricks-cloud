# Az - 条件访问策略 / MFA 绕过

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

Azure 条件访问策略是在 Microsoft Azure 中设置的规则，根据特定**条件**强制对 Azure 服务和应用程序进行访问控制。这些策略通过在正确的情况下应用正确的访问控制，帮助组织保护其资源。\
条件访问策略基本上**定义了** **谁**可以从**哪里**以及**如何**访问**什么**。

以下是几个例子：

1. **登录风险策略**：此策略可以设置为在检测到登录风险时要求多因素认证（MFA）。例如，如果用户的登录行为与他们的常规模式不同，比如从不同的国家登录，系统可以提示进行额外的认证。
2. **设备合规性策略**：此策略可以限制只有符合组织安全标准的设备才能访问 Azure 服务。例如，只允许从安装了最新防病毒软件或运行特定操作系统版本的设备访问。

## 条件访问策略绕过

有可能条件访问策略**正在检查一些可以轻松篡改的信息，从而允许绕过策略**。如果例如策略配置了 MFA，攻击者将能够绕过它。

### 设备平台 - 设备条件

可以根据**设备平台**（Android、iOS、Windows、macOS）设置条件，但这是基于**用户代理**的，因此很容易绕过。即使**使所有选项强制执行 MFA**，如果您使用的是**它无法识别的用户代理**，您将能够绕过 MFA。

### 位置：国家、IP 范围 - 设备条件

当然，如果这是在条件策略中设置的，攻击者可以使用**允许国家的 VPN** 或尝试找到一种方法从**允许的 IP 地址**访问以绕过这些条件。

### Office365 客户端应用程序

您可以指示如果客户端**从浏览器访问 Office 365 应用程序，他们需要 MFA**：

<figure><img src="../../.gitbook/assets/image (129).png" alt=""><figcaption></figcaption></figure>

为了绕过这个，可以假装您是从桌面应用程序（如以下示例中的 Microsoft Teams）登录的，这将绕过保护：

<figure><img src="../../.gitbook/assets/image (130).png" alt=""><figcaption></figcaption></figure>

由于 Microsoft Teams 应用程序具有很多权限，您将能够使用该访问权限。

{% hint style="success" %}
您可以在 roadtools 的数据库中找到具有预定义 Office365 权限的更多公共应用程序的**ID**：

{% code overflow="wrap" %}
```sql
SELECT appId, displayName FROM ApplicationRefs WHERE publicCLient = 1 ORDER BY displayName ASC
```
{% endcode %}
{% endhint %}

这种攻击特别有趣，因为默认情况下，公共Office365应用程序将有权限访问一些数据。

### 其他应用程序

默认情况下，用户创建的其他应用程序可能没有权限，并且可能是私有的。\
然而，用户也可以创建**公共** **应用程序**，授予它们一些**权限**。

一个潜在的场景是，策略设置为**要求使用MFA访问应用程序**，当用户使用**浏览器**时（可能是因为它是一个Web应用程序，因此这将是唯一的方式），如果有一个**代理应用程序** - 一个允许**代表用户与其他应用程序交互**的应用程序 - 用户可以**在代理应用程序中登录**，然后通过这个代理应用程序**登录最初受MFA保护的应用程序**。

## 其他Az MFA绕过方法

### 铃声

Azure MFA的一个选项是**在配置的电话号码上接收电话**，它会要求用户**发送字符`#`**。

{% hint style="danger" %}
由于字符只是**音调**，攻击者可以**攻击**电话号码的**语音邮件**，将**`#`的音调**配置为消息，然后，在请求MFA时确保**受害者的电话忙线**（呼叫它），这样Azure的电话就会被转接到语音邮件。
{% endhint %}

### 合规设备

策略通常要求使用合规设备或MFA，因此**攻击者可以注册一个合规设备**，获取一个**PRT**令牌，**通过这种方式绕过MFA**。

首先在Intune中注册一个**合规设备**，然后**获取PRT**：

<figure><img src="../../.gitbook/assets/image (131).png" alt=""><figcaption></figcaption></figure>

在以下页面中找到更多关于这种攻击的信息：

{% content-ref url="az-lateral-movement-cloud-on-prem/pass-the-prt.md" %}
[pass-the-prt.md](az-lateral-movement-cloud-on-prem/pass-the-prt.md)
{% endcontent-ref %}

## 工具

### Invoke-MFASweep

MFASweep是一个PowerShell脚本，它尝试**使用提供的一组凭据登录到各种Microsoft服务，并将尝试识别是否启用了MFA**。根据条件访问策略和其他多因素认证设置的配置，有些协议可能最终被留下单一因素。它还有一个ADFS配置的额外检查，并且如果检测到，可以尝试登录到本地ADFS服务器。
```bash
Invoke-MFASweep -Username <username> -Password <pass>
```
### roadrecon

获取所有策略
```bash
roadrecon plugin policies
```
## 参考资料

* [https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s](https://www.youtube.com/watch?v=yOJ6yB9anZM\&t=296s)
* [https://www.youtube.com/watch?v=xei8lAPitX8](https://www.youtube.com/watch?v=xei8lAPitX8)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客技术，成为英雄！</strong></summary>

其他支持HackTricks的方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
