# Az - Qa'vIn

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>DaH jImej</strong></a><strong>!</strong></summary>

HackTricks DaH jImej:

* **tlhIngan Hol** **HackTricks** **advertise** **company** **want** **or** **HackTricks** **PDF** **download** **want** **If** **Check** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* [**official PEASS & HackTricks swag**](https://peass.creator-spring.com) **Get**
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) **Discover**, [**NFTs**](https://opensea.io/collection/the-peass-family) **exclusive** **collection** **our**
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) **or** [**telegram group**](https://t.me/peass) **or** **follow** **us** **on** **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) **and** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github repos**.

</details>

## Organization Hierarchy

<figure><img src="../../.gitbook/assets/image (62).png" alt=""><figcaption></figcaption></figure>

### Management Groups

**Azure subscriptions** **many** **organization** **your** **If** **need**, **efficiently manage access**, **policies**, **compliance** **way** **a** **provide** **management groups**. **Management groups** **subscriptions** **above governance scope** **a**.

**10,000 management groups** **single directory** **supported** **be** **can** **management groups** **depth** **of levels six** **up to** **support** **tree group management** **other** **unlike** **deleted**, **moved** **be** **can't** **group management root** **This**.

[From the docs](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview#root-management-group-for-each-directory): **root** **the group management** **top-level management group called** **single directory** **given** **Each**. **it** **up to fold subscriptions** **and groups management** **role assignments Azure** **policies global** **for** **applied be** **to** **level directory** **the at**. **group root** **this of role** **Administrator Access User** **the to** **themselves elevate** **needs** **Administrator Global AD Azure** **Azure** **the of role** **Administrator Access User** **the to** **initially group root** **this**. **hierarchy manage** **to groups directory or users** **directory other** **assign role Azure** **can administrator** **As** **group management root** **the of owner** **as account own** **your** **assign can**.

**have might** **subscriptions type** **what matter** **scale at management** **enterprise-grade** **give groups management** **Management**. **tenant AD Azure** **same the trust** **must** **group management single a within subscriptions **all**.

<figure><img src="../../.gitbook/assets/image (76).png" alt=""><figcaption></figcaption></figure>

### Azure Subscriptions

Azure, **provisioning** **purpose** **the for** **container logical** **a serves** **subscription** **A**. **others among**, **databases**, **VMs**, **machines virtual** **such** **resources** **technical business** **provisioning** **of details** **the maintains** **container** **This**. **it** **with associated** **subscription** **the of creation the Upon** **specified is** **it**. **mechanisms access-control based role** **utilizing**, **access** **delegation** **the facilitates** **structure** **This**.

### Resource Groups

[From the docs:](https://learn.microsoft.com/en-us/azure/azure-resource-manager/management/manage-resource-groups-python?tabs=macos#what-is-a-resource-group) **Azure solution** **an for** **resources related** **holds** **container** **a is group resource** **A**. **group resource** **the only** **manage to want you** **resources** **those** **or** **solution the for** **all** **include** **can** **group resource** **same the** **that** **resources** **add** **Generally** **group resource** **a to** **them** **delete** **and** **update** **deploy** **easily** **can** **you**.

**it inside** **group resource** **a to belong** **can** **resources** **the** **All** **deleted** **is** **it inside** **group resource** **a if**.

### Administrative Units

[From the docs:](https://learn.microsoft.com/en-us/entra/identity/role-based-access-control/admin-units-manage) **unit** **that** **any** **your organization** **subdivide** **let** **units administrative** **Administrative**. **unit administrative** **an** **of members** **the** **only** **manage** **can** **administrators specific** **assign** **and** **want** **you** **that unit** **of members** **the** **control access**, **users manage**, **policies set** **and**.

**devices** **groups** **users** **members** **be** **and**, **units administrative** **an** **of members** **the** **manage** **can** **administrators specific** **unit administrative** **that** **over permissions assigned** **be** **will** **principals other** **and** **unit administrative** **the** **of members** **the** **manage** **to** **use** **can** **they**.

**unit administrative** **an** **members** **some contain** **will** **Administrative unit** **an** **Therefore**, **unit administrative** **the** **of members** **the** **manage** **to** **permissions assigned** **be** **will** **principals other**.

## Azure vs Azure AD vs Azure AD Domain Services

**Azure** **inside** **service** **AD Azure** **important** **It's** **note**. **Azure** **Microsoft's** **platform cloud** **is** **whereas** **service identity enterprise** **AD Azure** **is** **AD Azure** **like Active Directory Windows** **not**, **way different complete** **a** **works** **service identity** **an** **is AD Azure**. **environment Directory Active Windows** **your for Azure** **in Controller Domain** **a run** **to want you** **If** **Services Domain AD Azure** **use to need**.

## Principals

**support** **Azure** **different** **Azure** **principals type**:

* **person** **regular** **A**: **User** **credentials** **with** **access** **to**.
* **managed together** **principals of group** **A**: **Group**. **members** **its by** **inherited** **are** **granted** **Permissions**.
* **tools automated** **services hosted**, **applications** **with** **use** **for** **created** **identity** **an**: **Service Principal/Enterprise Applications**. **resources Azure** **access be can** **which** **over assigned roles** **the** **principal service** **the to** **control** **giving**, **level which** **and** **access be can** **resources Azure** **to** **tools automated** **with** **principals service** **use to** **always** **recommended** **For** **identity user** **a with** **in** **log** **to** **allowing** **rather** **tools automated** **with** **principals service** **use to**.

**principal service** **a creating** **When** **authentication certificate** **or** **authentication password** **between** **choose can you**.

* **authentication password** **choose you** **If** **auth password** **choose you**, **again it access to able be won't** **generated password** **the** **save** **you** **as**.
* **authentication certificate**, **key private the over** **have will application the** **that** **access have will** **application the** **make** **you**, **authentication certificate** **choose you** **If**.
* **(Metadata Creds) Identity Managed**: **Directory Active Azure** **compatible** **resources** **to** **connecting** **purpose** **the for** **applications** **of identity** **the** **managing automatically** **for** **solution** **a offer** **Directory Active Azure** **in** **identities managed**. **credentials handle to** **need the** **eliminating** **while tokens AD Azure** **secure** **can** **applications** **by** **used** **are** **identities managed** **utilizing**.
**identities managed** **types two** **are**:
* **System-assigned**. **instance service a on** **identity managed** **enable to
## Roles & Permissions

**Roles** are **assigned** to **principals** on a **scope**: `principal -[HAS ROLE]->(scope)`

**Roles** assigned to **groups** are **inherited** by all the **members** of the group.

Depending on the scope the role was assigned to, the **role** cold be **inherited** to **other resources** inside the scope container. For example, if a user A has a **role on the subscription**, he will have that **role on all the resource groups** inside the subscription and on **all the resources** inside the resource group.

### **Classic Roles**

| **Owner**                     | <ul><li>Full access to all resources</li><li>Can manage access for other users</li></ul> | All resource types |
| ----------------------------- | ---------------------------------------------------------------------------------------- | ------------------ |
| **Contributor**               | <ul><li>Full access to all resources</li><li>Cannot manage access</li></ul>              | All resource types |
| **Reader**                    | ‚Ä¢ View all resources                                                                     | All resource types |
| **User Access Administrator** | <ul><li>View all resources</li><li>Can manage access for other users</li></ul>           | All resource types |

### Built-In roles

[From the docs: ](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)[Azure role-based access control (Azure RBAC)](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview) has several Azure **built-in roles** that you can **assign** to **users, groups, service principals, and managed identities**. Role assignments are the way you control **access to Azure resources**. If the built-in roles don't meet the specific needs of your organization, you can create your own [**Azure custom roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles)**.**

**Built-In** roles apply only to the **resources** they are **meant** to, for example check this 2 examples of **Built-In roles over Compute** resources:

| [Disk Backup Reader](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#disk-backup-reader)                 | Provides permission to backup vault to perform disk backup.      | 3e5e47e6-65f7-47ef-90b5-e5dd4d455f24 |
| ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------ |
| [Virtual Machine User Login](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles#virtual-machine-user-login) | View Virtual Machines in the portal and login as a regular user. | fb879df8-f326-4884-b1cf-06f3ad86be52 |

This roles can **also be assigned over logic containers** (such as management groups, subscriptions and resource groups) and the principals affected will have them **over the resources inside those containers**.

* Find here a list with [**all the Azure built-in roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/built-in-roles).
* Find here a list with [**all the Azure AD built-in roles**](https://learn.microsoft.com/en-us/azure/active-directory/roles/permissions-reference).

### Custom Roles

Azure also allow to create [**custom roles**](https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles) with the permissions the user needs.

### Permission Denied

* In order for a **principal to have some access over a resource** he needs an explicit role being granted to him (anyhow) **granting him that permission**.
* An explicit **deny role assignment takes precedence** over the role granting the permission.

<figure><img src="../../.gitbook/assets/image (32).png" alt=""><figcaption></figcaption></figure>

### Global Administrator

Users with the Global Administrator role has the ability to '**elevate' to User Access Administrator Azure role to the root management group**. This means that a Global Administrator will be able to manage access **all Azure subscriptions and management groups.**\
This elevation can be done at the end of the page: [https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties](https://portal.azure.com/#view/Microsoft\_AAD\_IAM/ActiveDirectoryMenuBlade/\~/Properties)

<figure><img src="../../.gitbook/assets/image (41).png" alt=""><figcaption></figcaption></figure>

### Azure Policies

Azure policies are a set of **rules and regulations in Microsoft Azur**e, a cloud computing service, that help manage and enforce organizational standards and to assess compliance at-scale. These policies enforce different rules over your **Azure resources**, ensuring that those resources stay compliant with corporate standards and service level agreements.

Azure policies are crucial for cloud governance and security, helping to ensure that resources are used properly and efficiently, and that they comply with external regulations and internal policies.\
Som examples:

1. **Ensuring Compliance with Specific Azure Regions**: This policy ensures that all resources are deployed in specific Azure regions. For example, a company might want to ensure all its data is stored in Europe for GDPR compliance.
2. **Enforcing Naming Standards**: Policies can enforce naming conventions for Azure resources. This helps in organizing and easily identifying resources based on their names, which is helpful in large environments.
3. **Restricting Certain Resource Types**: This policy can restrict the creation of certain types of resources. For example, a policy could be set to prevent the creation of expensive resource types, like certain VM sizes, to control costs.
4. **Enforcing Tagging Policies**: Tags are key-value pairs associated with Azure resources used for resource management. Policies can enforce that certain tags must be present, or have specific values, for all resources. This is useful for cost tracking, ownership, or categorization of resources.
5. **Limiting Public Access to Resources**: Policies can enforce that certain resources, like storage accounts or databases, do not have public endpoints, ensuring that they are only accessible within the organization's network.
6. **Automatically Applying Security Settings**: Policies can be used to automatically apply security settings to resources, such as applying a specific network security group to all VMs or ensuring that all storage accounts use encryption.

Note that Azure Policies can be attached to any level of the Azure hierarchy, but they are **commonly used in the root management group** or in other management groups.

### Permissions Scope

In Azure **permissions are can be assigned to any part of the hierarchy**. That includes management groups, subscriptions, resource groups, and individual resources. Permissions are **inherited** by  contained **resources** of the entity where they were assigned.

This hierarchical structure allows for efficient and scalable management of access permissions.

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Azure RBAC vs ABAC

**RBAC** (role-based access control) is what we have seen already in the previous sections: **Assigning a role to a principal to grant him access** over a resource.\
However, in some cases you might want to provide **more fined-grained access management** or **simplify** the management of **hundreds** of role **assignments**.

Azure **ABAC** (attribute-based access control) builds on Azure RBAC by adding **role assignment conditions based on attributes** in the context of specific actions. A _role assignment condition_ is an **additional check that you can optionally add to your role assignment** to provide more fine-grained access control. A condition filters down permissions granted as a part of the role definition and role assignment. For example, you can **add a condition that requires an object to have a specific tag to read the object**.\
You **cannot** explicitly **deny** **access** to specific resources **using conditions**.
### Default User Permissions

A basic user will have some **default permissions** to enumerate some parts of AzureAD:

* Read all users, Groups, Applications, Devices, Roles, Subscriptions, and their public properties
* Invite Guests (_can be turned off_)
* Create Security groups
* Read non-hidden Group memberships
* Add guests to Owned groups
* Create new application (_can be turned off_)
* Add up to 50 devices to Azure (_can be turned off_)

You can see the full [list of **default permissions of users** in the docs](https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/users-default-permissions). Moreover, note that in that list you can also see the **guests default permissions list**.

{% hint style="info" %}
Remember that to enumerate Azure resources the user needs an explicit grant of the permission.
{% endhint %}

### Privileged Identity Management (PIM)

Privileged Identity Management (PIM) in Azure is a tool that **manages, controls, and monitors privileged access** in Azure Active Directory and Azure. It enhances security by providing **just-in-time and time-limited privileged access**, **enforcing approval workflows, and requiring additional authentication**. This approach minimizes the risk of unauthorized access by ensuring that elevated permissions are granted only when necessary and for a specific duration.

## Authentication Tokens

There are **three types of tokens** used in OIDC:

* [**Access Tokens**](https://learn.microsoft.com/en-us/azure/active-directory/develop/access-tokens)**:** The client presents this token to the resource server to **access resources**. It can be used only for a specific combination of user, client, and resource and **cannot be revoked** until expiry - that is 1 hour by default. Detection is low using this.
* **ID Tokens**: The client receives this **token from the authorization server**. It contains basic information about the user. It is **bound to a specific combination of user and client**.
* **Refresh Tokens**: Provided to the client with access token. Used to **get new access and ID tokens**. It is bound to a specific combination of user and client and can be revoked. Default expiry is **90 days** for inactive refresh tokens and **no expiry for active tokens**.

{% hint style="warning" %}
Information for **conditional access** is **stored** inside the **JWT**. So, if you request the **token from an allowed IP address**, that **IP** will be **stored** in the token and then you can use that token from a **non-allowed IP to access the resources**.
{% endhint %}

Check the following page to learn different ways to **request access tokens** and login with them:

{% content-ref url="az-azuread/" %}
[az-azuread](az-azuread/)
{% endcontent-ref %}

The most common API endpoints are:

* **Azure Resource Manager** (ARM): management.azure.com
* **Microsoft Graph**: graph.microsoft.com (Azure AD Graph which is deprecated is graph.windows.net)

## References

* [https://learn.microsoft.com/en-us/azure/governance/management-groups/overview](https://learn.microsoft.com/en-us/azure/governance/management-groups/overview)
* [https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/organize-subscriptions)
* [https://abouttmc.com/glossary/azure-subscription/#:\~:text=An%20Azure%20subscription%20is%20a,the%20subscription%20it%20belongs%20to.](https://abouttmc.com/glossary/azure-subscription/)
* [https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource](https://learn.microsoft.com/en-us/azure/role-based-access-control/overview#how-azure-rbac-determines-if-a-user-has-access-to-a-resource)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
