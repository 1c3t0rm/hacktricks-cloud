# Az - Service Bus Post Exploitation

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}

## Service Bus

Aby uzyska wicej informacji, sprawd藕:

{% content-ref url="../az-services/az-servicebus-enum.md" %}
[az-servicebus-enum.md](../az-services/az-servicebus-enum.md)
{% endcontent-ref %}

### Akcje: `Microsoft.ServiceBus/namespaces/Delete`

Atakujcy z tym uprawnieniem mo偶e usun cay namespace Azure Service Bus. Ta akcja usuwa namespace oraz wszystkie powizane zasoby, w tym kolejki, tematy, subskrypcje i ich wiadomoci, powodujc szerokie zak贸cenia i trwa utrat danych we wszystkich zale偶nych systemach i przepywach pracy.

{% code overflow="wrap" %}
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
{% endcode %}

### Dziaania: `Microsoft.ServiceBus/namespaces/topics/Delete`

Atakujcy z tym uprawnieniem mo偶e usun temat Azure Service Bus. Ta akcja usuwa temat oraz wszystkie jego powizane subskrypcje i wiadomoci, co mo偶e prowadzi do utraty krytycznych danych i zak贸cenia system贸w oraz przepyw贸w pracy opartych na tym temacie.

{% code overflow="wrap" %}
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Dziaania: `Microsoft.ServiceBus/namespaces/queues/Delete`

Atakujcy z tym uprawnieniem mo偶e usun kolejk Azure Service Bus. Ta akcja usuwa kolejk oraz wszystkie wiadomoci w niej, co mo偶e prowadzi do utraty krytycznych danych i zak贸cenia system贸w oraz proces贸w zale偶nych od kolejki.

{% code overflow="wrap" %}
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Akcje: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Atakujcy z tym uprawnieniem mo偶e usun subskrypcj Azure Service Bus. Ta akcja usuwa subskrypcj oraz wszystkie jej powizane wiadomoci, co mo偶e zak贸ci przepywy pracy, przetwarzanie danych i operacje systemowe polegajce na subskrypcji.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}

### Dziaania: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Napastnik z uprawnieniami do tworzenia lub modyfikowania przestrzeni nazw Azure Service Bus mo偶e to wykorzysta do zak贸cania operacji, wdra偶ania nieautoryzowanych zasob贸w lub ujawniania wra偶liwych danych. Mog zmienia krytyczne konfiguracje, takie jak wczanie dostpu do sieci publicznej, obni偶anie ustawie szyfrowania lub zmiana SKU w celu pogorszenia wydajnoci lub zwikszenia koszt贸w. Dodatkowo mog wyczy lokaln autoryzacj, manipulowa lokalizacjami replik lub dostosowywa wersje TLS, aby osabi kontrole bezpieczestwa, co sprawia, 偶e bdna konfiguracja przestrzeni nazw stanowi istotne ryzyko po eksploatacji.

{% code overflow="wrap" %}
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
{% endcode %}


### Actions: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Atakujcy z uprawnieniami do tworzenia lub modyfikowania kolejek Azure Service Bus (aby zmodyfikowa kolejk, potrzebne bd r贸wnie偶 uprawnienia do Akcji: `Microsoft.ServiceBus/namespaces/queues/read`) mo偶e to wykorzysta do przechwytywania danych, zak贸cania przepyw贸w pracy lub umo偶liwienia nieautoryzowanego dostpu. Mog zmienia krytyczne konfiguracje, takie jak przekazywanie wiadomoci do zoliwych punkt贸w kocowych, dostosowywanie TTL wiadomoci w celu niewaciwego przechowywania lub usuwania danych, lub wczanie dead-lettering w celu zak贸cania obsugi bd贸w. Dodatkowo mog manipulowa rozmiarami kolejek, czasami blokady lub statusami, aby zak贸ca funkcjonalno usugi lub unika wykrycia, co stanowi istotne ryzyko po eksploatacji.

{% code overflow="wrap" %}
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Napastnik z uprawnieniami do tworzenia lub modyfikowania temat贸w (aby zmodyfikowa temat, bdziesz r贸wnie偶 potrzebowa akcji: `Microsoft.ServiceBus/namespaces/topics/read`) w obrbie przestrzeni nazw Azure Service Bus mo偶e to wykorzysta do zak贸cania przepyw贸w wiadomoci, ujawniania wra偶liwych danych lub umo偶liwienia nieautoryzowanych dziaa. U偶ywajc polece takich jak az servicebus topic update, mog manipulowa konfiguracjami, takimi jak wczanie partycjonowania w celu niewaciwego wykorzystania skalowalnoci, zmienianie ustawie TTL, aby niewaciwie zatrzymywa lub odrzuca wiadomoci, lub wyczanie wykrywania duplikat贸w, aby obej kontrole. Dodatkowo mog dostosowa limity rozmiaru temat贸w, zmieni status, aby zak贸ci dostpno, lub skonfigurowa tematy ekspresowe do tymczasowego przechowywania przechwyconych wiadomoci, co sprawia, 偶e zarzdzanie tematami jest kluczowym punktem w zakresie agodzenia skutk贸w po eksploatacji.

{% code overflow="wrap" %}
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Dziaania: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Atakujcy z uprawnieniami do tworzenia lub modyfikowania subskrypcji (aby zmodyfikowa subskrypcj, bdziesz r贸wnie偶 potrzebowa akcji: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) w obrbie tematu Azure Service Bus mo偶e to wykorzysta do przechwytywania, przekierowywania lub zak贸cania przepyw贸w wiadomoci. U偶ywajc polece takich jak az servicebus topic subscription update, mog manipulowa konfiguracjami, takimi jak wczanie dead lettering w celu przekierowania wiadomoci, przesyanie wiadomoci do nieautoryzowanych punkt贸w kocowych lub modyfikowanie TTL i czasu blokady, aby zatrzyma lub zak贸ci dostarczanie wiadomoci. Dodatkowo mog zmienia ustawienia statusu lub maksymalnej liczby dostarcze, aby zak贸ca operacje lub unika wykrycia, co sprawia, 偶e kontrola subskrypcji jest kluczowym aspektem scenariuszy po eksploatacji.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}


### Dziaania: `AuthorizationRules` Wysyanie i Odbieranie Wiadomoci

Zobacz tutaj:

{% content-ref url="../az-services/az-queue-privesc.md" %}
[az-queue-privesc.md](../az-services/az-queue-privesc.md)
{% endcontent-ref %}

## Odniesienia

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
* https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
* https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
* https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

<details>

<summary>Wsparcie HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w na GitHubie.

</details>
{% endhint %}
