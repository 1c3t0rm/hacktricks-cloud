# Az - Service Bus Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Service Bus

Per ulteriori informazioni controlla:

{% content-ref url="../az-services/az-servicebus-enum.md" %}
[az-servicebus-enum.md](../az-services/az-servicebus-enum.md)
{% endcontent-ref %}

### Azioni: `Microsoft.ServiceBus/namespaces/Delete`

Un attaccante con questo permesso pu√≤ eliminare un intero namespace di Azure Service Bus. Questa azione rimuove il namespace e tutte le risorse associate, comprese code, argomenti, iscrizioni e i loro messaggi, causando ampie interruzioni e perdita permanente di dati in tutti i sistemi e flussi di lavoro dipendenti. 

{% code overflow="wrap" %}
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/topics/Delete`

Un attaccante con questo permesso pu√≤ eliminare un argomento di Azure Service Bus. Questa azione rimuove l'argomento e tutte le sue sottoscrizioni e messaggi associati, causando potenzialmente la perdita di dati critici e interrompendo i sistemi e i flussi di lavoro che si basano sull'argomento.

{% code overflow="wrap" %}
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/queues/Delete`

Un attaccante con questo permesso pu√≤ eliminare una coda di Azure Service Bus. Questa azione rimuove la coda e tutti i messaggi al suo interno, causando potenzialmente la perdita di dati critici e interrompendo i sistemi e i flussi di lavoro dipendenti dalla coda.

{% code overflow="wrap" %}
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Un attaccante con questo permesso pu√≤ eliminare un abbonamento di Azure Service Bus. Questa azione rimuove l'abbonamento e tutti i suoi messaggi associati, potenzialmente interrompendo flussi di lavoro, elaborazione dei dati e operazioni di sistema che dipendono dall'abbonamento.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Un attaccante con permessi per creare o modificare i namespace di Azure Service Bus pu√≤ sfruttare questo per interrompere le operazioni, distribuire risorse non autorizzate o esporre dati sensibili. Possono modificare configurazioni critiche come abilitare l'accesso alla rete pubblica, ridurre le impostazioni di crittografia o cambiare gli SKU per degradare le prestazioni o aumentare i costi. Inoltre, potrebbero disabilitare l'autenticazione locale, manipolare le posizioni delle repliche o regolare le versioni TLS per indebolire i controlli di sicurezza, rendendo la misconfigurazione del namespace un rischio significativo post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
{% endcode %}


### Azioni: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Un attaccante con permessi per creare o modificare le code di Azure Service Bus (per modificare la coda √® necessario anche l'azione: `Microsoft.ServiceBus/namespaces/queues/read`) pu√≤ sfruttare questo per intercettare dati, interrompere flussi di lavoro o abilitare accessi non autorizzati. Possono alterare configurazioni critiche come l'inoltro di messaggi a endpoint malevoli, regolare il TTL dei messaggi per mantenere o eliminare dati in modo improprio, o abilitare il dead-lettering per interferire con la gestione degli errori. Inoltre, potrebbero manipolare le dimensioni delle code, le durate di blocco o gli stati per interrompere la funzionalit√† del servizio o eludere la rilevazione, rendendo questo un rischio significativo post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Un attaccante con permessi per creare o modificare argomenti (per modificare l'argomento √® necessario anche l'azione: `Microsoft.ServiceBus/namespaces/topics/read`) all'interno di uno spazio dei nomi di Azure Service Bus pu√≤ sfruttare questo per interrompere i flussi di messaggi, esporre dati sensibili o abilitare azioni non autorizzate. Utilizzando comandi come az servicebus topic update, possono manipolare configurazioni come abilitare il partizionamento per un uso improprio della scalabilit√†, modificare le impostazioni TTL per mantenere o scartare messaggi in modo improprio, o disabilitare il rilevamento dei duplicati per eludere i controlli. Inoltre, potrebbero regolare i limiti di dimensione degli argomenti, cambiare lo stato per interrompere la disponibilit√†, o configurare argomenti espressi per memorizzare temporaneamente i messaggi intercettati, rendendo la gestione degli argomenti un focus critico per la mitigazione post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Azioni: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Un attaccante con permessi per creare o modificare le sottoscrizioni (per modificare la sottoscrizione √® necessario anche l'azione: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) all'interno di un argomento di Azure Service Bus pu√≤ sfruttare questo per intercettare, reindirizzare o interrompere i flussi di lavoro dei messaggi. Utilizzando comandi come az servicebus topic subscription update, possono manipolare configurazioni come l'abilitazione del dead lettering per deviare i messaggi, inoltrare messaggi a endpoint non autorizzati o modificare la durata TTL e di blocco per trattenere o interferire con la consegna dei messaggi. Inoltre, possono alterare lo stato o le impostazioni del conteggio massimo di consegna per interrompere le operazioni o eludere la rilevazione, rendendo il controllo delle sottoscrizioni un aspetto critico degli scenari di post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}


### Azioni: `AuthorizationRules` Invia & Ricevi Messaggi

Dai un'occhiata qui:

{% content-ref url="../az-services/az-queue-privesc.md" %}
[az-queue-privesc.md](../az-services/az-queue-privesc.md)
{% endcontent-ref %}

## Riferimenti

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
* https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
* https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
* https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
