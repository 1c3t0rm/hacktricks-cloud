# Az - Service Bus Post Exploitation

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Service Bus

Pour plus d'informations, consultez :

{% content-ref url="../az-services/az-servicebus-enum.md" %}
[az-servicebus-enum.md](../az-services/az-servicebus-enum.md)
{% endcontent-ref %}

### Actions : `Microsoft.ServiceBus/namespaces/Delete`

Un attaquant avec cette permission peut supprimer un namespace Azure Service Bus entier. Cette action supprime le namespace et toutes les ressources associ√©es, y compris les files d'attente, les sujets, les abonnements et leurs messages, provoquant des perturbations g√©n√©ralis√©es et une perte de donn√©es permanente dans tous les syst√®mes et flux de travail d√©pendants.

{% code overflow="wrap" %}
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
{% endcode %}

### Actions : `Microsoft.ServiceBus/namespaces/topics/Delete`

Un attaquant disposant de cette autorisation peut supprimer un sujet Azure Service Bus. Cette action supprime le sujet ainsi que toutes ses abonnements et messages associ√©s, ce qui peut entra√Æner la perte de donn√©es critiques et perturber les syst√®mes et flux de travail d√©pendant du sujet.

{% code overflow="wrap" %}
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/queues/Delete`

Un attaquant disposant de cette autorisation peut supprimer une file d'attente Azure Service Bus. Cette action supprime la file d'attente et tous les messages qu'elle contient, ce qui peut entra√Æner la perte de donn√©es critiques et perturber les syst√®mes et les flux de travail d√©pendant de la file d'attente.

{% code overflow="wrap" %}
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Un attaquant disposant de cette autorisation peut supprimer un abonnement Azure Service Bus. Cette action supprime l'abonnement et tous ses messages associ√©s, perturbant potentiellement les flux de travail, le traitement des donn√©es et les op√©rations syst√®me s'appuyant sur l'abonnement.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}

### Actions : `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Un attaquant ayant des permissions pour cr√©er ou modifier des espaces de noms Azure Service Bus peut exploiter cela pour perturber les op√©rations, d√©ployer des ressources non autoris√©es ou exposer des donn√©es sensibles. Ils peuvent modifier des configurations critiques telles que l'activation de l'acc√®s au r√©seau public, la r√©duction des param√®tres de cryptage ou le changement de SKU pour d√©grader les performances ou augmenter les co√ªts. De plus, ils pourraient d√©sactiver l'authentification locale, manipuler les emplacements des r√©pliques ou ajuster les versions TLS pour affaiblir les contr√¥les de s√©curit√©, rendant la mauvaise configuration des espaces de noms un risque significatif apr√®s exploitation.

{% code overflow="wrap" %}
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
{% endcode %}


### Actions : `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Un attaquant ayant des permissions pour cr√©er ou modifier des files d'attente Azure Service Bus (pour modifier la file d'attente, vous aurez √©galement besoin de l'Action : `Microsoft.ServiceBus/namespaces/queues/read`) peut exploiter cela pour intercepter des donn√©es, perturber des flux de travail ou permettre un acc√®s non autoris√©. Ils peuvent modifier des configurations critiques telles que le transfert de messages vers des points de terminaison malveillants, ajuster le TTL des messages pour conserver ou supprimer des donn√©es de mani√®re inappropri√©e, ou activer le dead-lettering pour interf√©rer avec la gestion des erreurs. De plus, ils pourraient manipuler les tailles de file d'attente, les dur√©es de verrouillage ou les statuts pour perturber la fonctionnalit√© du service ou √©chapper √† la d√©tection, ce qui en fait un risque significatif apr√®s exploitation.

{% code overflow="wrap" %}
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Actions : `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Un attaquant ayant les permissions de cr√©er ou de modifier des sujets (pour modifier le sujet, vous aurez √©galement besoin de l'Action : `Microsoft.ServiceBus/namespaces/topics/read`) au sein d'un espace de noms Azure Service Bus peut exploiter cela pour perturber les flux de messages, exposer des donn√©es sensibles ou permettre des actions non autoris√©es. En utilisant des commandes comme az servicebus topic update, ils peuvent manipuler des configurations telles que l'activation du partitionnement pour un usage abusif de l'√©volutivit√©, modifier les param√®tres de TTL pour conserver ou rejeter des messages de mani√®re inappropri√©e, ou d√©sactiver la d√©tection des doublons pour contourner les contr√¥les. De plus, ils pourraient ajuster les limites de taille des sujets, changer le statut pour perturber la disponibilit√©, ou configurer des sujets express pour stocker temporairement des messages intercept√©s, faisant de la gestion des sujets un point critique pour l'att√©nuation post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Actions : `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Un attaquant ayant des permissions pour cr√©er ou modifier des abonnements (pour modifier l'abonnement, vous aurez √©galement besoin de l'Action : `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) au sein d'un sujet Azure Service Bus peut exploiter cela pour intercepter, rediriger ou perturber les flux de messages. En utilisant des commandes comme az servicebus topic subscription update, ils peuvent manipuler des configurations telles que l'activation du dead lettering pour d√©tourner des messages, le transfert de messages vers des points de terminaison non autoris√©s, ou la modification de la dur√©e de vie (TTL) et de la dur√©e de verrouillage pour conserver ou interf√©rer avec la livraison des messages. De plus, ils peuvent modifier les param√®tres de statut ou de nombre maximal de livraisons pour perturber les op√©rations ou √©chapper √† la d√©tection, faisant du contr√¥le des abonnements un aspect critique des sc√©narios de post-exploitation.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}


### Actions : `AuthorizationRules` Envoyer & Recevoir des Messages

Regardez ici :

{% content-ref url="../az-services/az-queue-privesc.md" %}
[az-queue-privesc.md](../az-services/az-queue-privesc.md)
{% endcontent-ref %}

## R√©f√©rences

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
* https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
* https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
* https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

<details>

<summary>Support HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
