# Az - Service Bus Post Exploitation

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## Service Bus

F√ºr weitere Informationen siehe:

{% content-ref url="../az-services/az-servicebus-enum.md" %}
[az-servicebus-enum.md](../az-services/az-servicebus-enum.md)
{% endcontent-ref %}

### Aktionen: `Microsoft.ServiceBus/namespaces/Delete`

Ein Angreifer mit dieser Berechtigung kann einen gesamten Azure Service Bus-Namespace l√∂schen. Diese Aktion entfernt den Namespace und alle zugeh√∂rigen Ressourcen, einschlie√ülich Warteschlangen, Themen, Abonnements und deren Nachrichten, was zu weitreichenden St√∂rungen und permanentem Datenverlust in allen abh√§ngigen Systemen und Workflows f√ºhrt.

{% code overflow="wrap" %}
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/topics/Delete`

Ein Angreifer mit dieser Berechtigung kann ein Azure Service Bus-Thema l√∂schen. Diese Aktion entfernt das Thema sowie alle zugeh√∂rigen Abonnements und Nachrichten, was potenziell zu einem Verlust kritischer Daten f√ºhren und Systeme sowie Arbeitsabl√§ufe, die auf das Thema angewiesen sind, st√∂ren kann.

{% code overflow="wrap" %}
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/queues/Delete`

Ein Angreifer mit dieser Berechtigung kann eine Azure Service Bus-Warteschlange l√∂schen. Diese Aktion entfernt die Warteschlange und alle darin enthaltenen Nachrichten, was m√∂glicherweise zu einem Verlust kritischer Daten f√ºhrt und Systeme sowie Arbeitsabl√§ufe, die von der Warteschlange abh√§ngen, st√∂rt.

{% code overflow="wrap" %}
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

Ein Angreifer mit dieser Berechtigung kann ein Azure Service Bus-Abonnement l√∂schen. Diese Aktion entfernt das Abonnement und alle zugeh√∂rigen Nachrichten, was potenziell Arbeitsabl√§ufe, Datenverarbeitung und Systemoperationen, die auf das Abonnement angewiesen sind, st√∂ren kann.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

Ein Angreifer mit Berechtigungen zum Erstellen oder √Ñndern von Azure Service Bus-Namensr√§umen kann dies ausnutzen, um den Betrieb zu st√∂ren, unautorisierte Ressourcen bereitzustellen oder sensible Daten offenzulegen. Sie k√∂nnen kritische Konfigurationen √§ndern, wie z.B. den Zugriff auf √∂ffentliche Netzwerke zu aktivieren, Verschl√ºsselungseinstellungen herabzustufen oder SKUs zu √§ndern, um die Leistung zu verschlechtern oder die Kosten zu erh√∂hen. Dar√ºber hinaus k√∂nnten sie die lokale Authentifizierung deaktivieren, Replikationsstandorte manipulieren oder TLS-Versionen anpassen, um die Sicherheitskontrollen zu schw√§chen, was die Fehlkonfiguration von Namensr√§umen zu einem erheblichen Risiko nach der Ausnutzung macht.

{% code overflow="wrap" %}
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
{% endcode %}


### Aktionen: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

Ein Angreifer mit Berechtigungen zum Erstellen oder √Ñndern von Azure Service Bus-Warteschlangen (um die Warteschlange zu √§ndern, ben√∂tigen Sie auch die Aktion: `Microsoft.ServiceBus/namespaces/queues/read`) kann dies ausnutzen, um Daten abzufangen, Arbeitsabl√§ufe zu st√∂ren oder unbefugten Zugriff zu erm√∂glichen. Sie k√∂nnen kritische Konfigurationen √§ndern, wie das Weiterleiten von Nachrichten an b√∂sartige Endpunkte, das Anpassen der Nachrichten-TTL, um Daten unangemessen zu behalten oder zu l√∂schen, oder das Aktivieren von Dead-Lettering, um die Fehlerbehandlung zu st√∂ren. Dar√ºber hinaus k√∂nnten sie Warteschlangen Gr√∂√üen, Sperrdauern oder Status manipulieren, um die Funktionalit√§t des Dienstes zu st√∂ren oder der Erkennung zu entkommen, was dies zu einem erheblichen Risiko nach der Ausnutzung macht.

{% code overflow="wrap" %}
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

Ein Angreifer mit Berechtigungen zum Erstellen oder √Ñndern von Themen (um das Thema zu √§ndern, ben√∂tigen Sie auch die Aktion: `Microsoft.ServiceBus/namespaces/topics/read`) innerhalb eines Azure Service Bus-Namensraums kann dies ausnutzen, um Nachrichten-Workflows zu st√∂ren, sensible Daten offenzulegen oder unbefugte Aktionen zu erm√∂glichen. Mit Befehlen wie az servicebus topic update k√∂nnen sie Konfigurationen manipulieren, wie z.B. das Aktivieren von Partitionierung f√ºr Missbrauch der Skalierbarkeit, das √Ñndern von TTL-Einstellungen, um Nachrichten unangemessen zu behalten oder zu verwerfen, oder das Deaktivieren der Duplikaterkennung, um Kontrollen zu umgehen. Dar√ºber hinaus k√∂nnten sie die Themen-Gr√∂√üenbeschr√§nkungen anpassen, den Status √§ndern, um die Verf√ºgbarkeit zu st√∂ren, oder Express-Themen konfigurieren, um vor√ºbergehend abgefangene Nachrichten zu speichern, wodurch das Management von Themen ein kritischer Fokus f√ºr die Minderung nach der Ausnutzung wird.

{% code overflow="wrap" %}
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Aktionen: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

Ein Angreifer mit Berechtigungen zum Erstellen oder √Ñndern von Abonnements (um das Abonnement zu √§ndern, ben√∂tigen Sie auch die Aktion: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`) innerhalb eines Azure Service Bus-Themen kann dies ausnutzen, um Nachrichten-Workflows abzufangen, umzuleiten oder zu st√∂ren. Mit Befehlen wie az servicebus topic subscription update k√∂nnen sie Konfigurationen manipulieren, wie das Aktivieren von Dead Lettering, um Nachrichten umzuleiten, Nachrichten an unbefugte Endpunkte weiterzuleiten oder TTL- und Sperrdauer zu √§ndern, um die Zustellung von Nachrichten zu behalten oder zu st√∂ren. Dar√ºber hinaus k√∂nnen sie Status- oder maximale Zustellanzahl-Einstellungen √§ndern, um den Betrieb zu st√∂ren oder der Erkennung zu entkommen, was die Kontrolle √ºber Abonnements zu einem kritischen Aspekt von Post-Exploitation-Szenarien macht.

{% code overflow="wrap" %}
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}


### Aktionen: `AuthorizationRules` Nachrichten senden & empfangen

Schau dir das hier an:

{% content-ref url="../az-services/az-queue-privesc.md" %}
[az-queue-privesc.md](../az-services/az-queue-privesc.md)
{% endcontent-ref %}

## Referenzen

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
* https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
* https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
* https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
