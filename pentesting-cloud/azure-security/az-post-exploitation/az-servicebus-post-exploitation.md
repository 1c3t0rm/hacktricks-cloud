# Az - Service Bus Post Exploitation

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Service Bus

æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../az-services/az-servicebus-enum.md" %}
[az-servicebus-enum.md](../az-services/az-servicebus-enum.md)
{% endcontent-ref %}

### æ“ä½œ: `Microsoft.ServiceBus/namespaces/Delete`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ é™¤æ•´ä¸ª Azure Service Bus å‘½åç©ºé—´ã€‚æ­¤æ“ä½œä¼šåˆ é™¤å‘½åç©ºé—´åŠæ‰€æœ‰ç›¸å…³èµ„æºï¼ŒåŒ…æ‹¬é˜Ÿåˆ—ã€ä¸»é¢˜ã€è®¢é˜…åŠå…¶æ¶ˆæ¯ï¼Œå¯¼è‡´æ‰€æœ‰ä¾èµ–ç³»ç»Ÿå’Œå·¥ä½œæµçš„å¹¿æ³›ä¸­æ–­å’Œæ°¸ä¹…æ•°æ®ä¸¢å¤±ã€‚ 

{% code overflow="wrap" %}
```bash
az servicebus namespace delete --resource-group <ResourceGroupName> --name <NamespaceName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/topics/Delete`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ é™¤ Azure Service Bus ä¸»é¢˜ã€‚æ­¤æ“ä½œä¼šåˆ é™¤ä¸»é¢˜åŠå…¶æ‰€æœ‰ç›¸å…³çš„è®¢é˜…å’Œæ¶ˆæ¯ï¼Œå¯èƒ½å¯¼è‡´å…³é”®æ•°æ®ä¸¢å¤±ï¼Œå¹¶å¹²æ‰°ä¾èµ–äºè¯¥ä¸»é¢˜çš„ç³»ç»Ÿå’Œå·¥ä½œæµç¨‹ã€‚

{% code overflow="wrap" %}
```bash
az servicebus topic delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/queues/Delete`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ é™¤ Azure Service Bus é˜Ÿåˆ—ã€‚æ­¤æ“ä½œä¼šåˆ é™¤é˜Ÿåˆ—åŠå…¶å†…æ‰€æœ‰æ¶ˆæ¯ï¼Œå¯èƒ½å¯¼è‡´å…³é”®æ•°æ®ä¸¢å¤±ï¼Œå¹¶å¹²æ‰°ä¾èµ–äºè¯¥é˜Ÿåˆ—çš„ç³»ç»Ÿå’Œå·¥ä½œæµç¨‹ã€‚

{% code overflow="wrap" %}
```bash
az servicebus queue delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### æ“ä½œ: `Microsoft.ServiceBus/namespaces/topics/subscriptions/Delete`

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ é™¤ Azure Service Bus è®¢é˜…ã€‚æ­¤æ“ä½œå°†åˆ é™¤è®¢é˜…åŠå…¶æ‰€æœ‰ç›¸å…³æ¶ˆæ¯ï¼Œå¯èƒ½ä¼šå¹²æ‰°ä¾èµ–äºè¯¥è®¢é˜…çš„å·¥ä½œæµç¨‹ã€æ•°æ®å¤„ç†å’Œç³»ç»Ÿæ“ä½œã€‚

{% code overflow="wrap" %}
```bash
az servicebus topic subscription delete --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/write` & `Microsoft.ServiceBus/namespaces/read`

æ‹¥æœ‰åˆ›å»ºæˆ–ä¿®æ”¹ Azure Service Bus å‘½åç©ºé—´æƒé™çš„æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥å¹²æ‰°æ“ä½œã€éƒ¨ç½²æœªç»æˆæƒçš„èµ„æºæˆ–æš´éœ²æ•æ„Ÿæ•°æ®ã€‚ä»–ä»¬å¯ä»¥æ›´æ”¹å…³é”®é…ç½®ï¼Œä¾‹å¦‚å¯ç”¨å…¬å…±ç½‘ç»œè®¿é—®ã€é™ä½åŠ å¯†è®¾ç½®æˆ–æ›´æ”¹ SKUï¼Œä»¥é™ä½æ€§èƒ½æˆ–å¢åŠ æˆæœ¬ã€‚æ­¤å¤–ï¼Œä»–ä»¬è¿˜å¯ä»¥ç¦ç”¨æœ¬åœ°èº«ä»½éªŒè¯ã€æ“çºµå‰¯æœ¬ä½ç½®æˆ–è°ƒæ•´ TLS ç‰ˆæœ¬ï¼Œä»¥å‰Šå¼±å®‰å…¨æ§åˆ¶ï¼Œä½¿å‘½åç©ºé—´é”™è¯¯é…ç½®æˆä¸ºä¸€ä¸ªé‡è¦çš„åæœŸåˆ©ç”¨é£é™©ã€‚

{% code overflow="wrap" %}
```bash
az servicebus namespace create --resource-group <ResourceGroupName> --name <NamespaceName> --location <Location>
az servicebus namespace update --resource-group <ResourceGroupName> --name <NamespaceName> --tags <Key=Value>
```
{% endcode %}


### Actions: `Microsoft.ServiceBus/namespaces/queues/write` (`Microsoft.ServiceBus/namespaces/queues/read`)

æ‹¥æœ‰åˆ›å»ºæˆ–ä¿®æ”¹ Azure Service Bus é˜Ÿåˆ—æƒé™çš„æ”»å‡»è€…ï¼ˆè¦ä¿®æ”¹é˜Ÿåˆ—ï¼Œæ‚¨è¿˜éœ€è¦æ“ä½œï¼š`Microsoft.ServiceBus/namespaces/queues/read`ï¼‰å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥æ‹¦æˆªæ•°æ®ã€å¹²æ‰°å·¥ä½œæµç¨‹æˆ–å¯ç”¨æœªç»æˆæƒçš„è®¿é—®ã€‚ä»–ä»¬å¯ä»¥æ›´æ”¹å…³é”®é…ç½®ï¼Œä¾‹å¦‚å°†æ¶ˆæ¯è½¬å‘åˆ°æ¶æ„ç«¯ç‚¹ã€è°ƒæ•´æ¶ˆæ¯ TTL ä»¥ä¸å½“ä¿ç•™æˆ–åˆ é™¤æ•°æ®ï¼Œæˆ–å¯ç”¨æ­»ä¿¡å¤„ç†ä»¥å¹²æ‰°é”™è¯¯å¤„ç†ã€‚æ­¤å¤–ï¼Œä»–ä»¬è¿˜å¯ä»¥æ“çºµé˜Ÿåˆ—å¤§å°ã€é”å®šæŒç»­æ—¶é—´æˆ–çŠ¶æ€ï¼Œä»¥å¹²æ‰°æœåŠ¡åŠŸèƒ½æˆ–é€ƒé¿æ£€æµ‹ï¼Œè¿™ä½¿å¾—è¿™æˆä¸ºä¸€ä¸ªé‡è¦çš„åæœŸåˆ©ç”¨é£é™©ã€‚

{% code overflow="wrap" %}
```bash
az servicebus queue create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
az servicebus queue update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <QueueName>
```
{% endcode %}

### Actions: `Microsoft.ServiceBus/namespaces/topics/write` (`Microsoft.ServiceBus/namespaces/topics/read`)

æ‹¥æœ‰åœ¨ Azure Service Bus å‘½åç©ºé—´ä¸­åˆ›å»ºæˆ–ä¿®æ”¹ä¸»é¢˜æƒé™çš„æ”»å‡»è€…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æƒé™å¹²æ‰°æ¶ˆæ¯å·¥ä½œæµã€æš´éœ²æ•æ„Ÿæ•°æ®æˆ–å¯ç”¨æœªç»æˆæƒçš„æ“ä½œã€‚ä½¿ç”¨è¯¸å¦‚ az servicebus topic update çš„å‘½ä»¤ï¼Œä»–ä»¬å¯ä»¥æ“çºµé…ç½®ï¼Œä¾‹å¦‚å¯ç”¨åˆ†åŒºä»¥æ»¥ç”¨å¯æ‰©å±•æ€§ã€ä¿®æ”¹ TTL è®¾ç½®ä»¥ä¸å½“ä¿ç•™æˆ–ä¸¢å¼ƒæ¶ˆæ¯ï¼Œæˆ–ç¦ç”¨é‡å¤æ£€æµ‹ä»¥ç»•è¿‡æ§åˆ¶ã€‚æ­¤å¤–ï¼Œä»–ä»¬è¿˜å¯ä»¥è°ƒæ•´ä¸»é¢˜å¤§å°é™åˆ¶ã€æ”¹å˜çŠ¶æ€ä»¥å¹²æ‰°å¯ç”¨æ€§ï¼Œæˆ–é…ç½®å¿«é€Ÿä¸»é¢˜ä»¥æš‚æ—¶å­˜å‚¨æ‹¦æˆªçš„æ¶ˆæ¯ï¼Œä½¿ä¸»é¢˜ç®¡ç†æˆä¸ºåæœŸåˆ©ç”¨ç¼“è§£çš„å…³é”®é‡ç‚¹ã€‚

{% code overflow="wrap" %}
```bash
az servicebus topic create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
az servicebus topic update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --name <TopicName>
```
{% endcode %}

### æ“ä½œ: `Microsoft.ServiceBus/namespaces/topics/subscriptions/write` (`Microsoft.ServiceBus/namespaces/topics/subscriptions/read`)

æ‹¥æœ‰åˆ›å»ºæˆ–ä¿®æ”¹è®¢é˜…æƒé™çš„æ”»å‡»è€…ï¼ˆè¦ä¿®æ”¹è®¢é˜…ï¼Œæ‚¨è¿˜éœ€è¦æ“ä½œ: `Microsoft.ServiceBus/namespaces/topics/subscriptions/read`ï¼‰å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ¥æ‹¦æˆªã€é‡å®šå‘æˆ–å¹²æ‰°æ¶ˆæ¯å·¥ä½œæµã€‚ä½¿ç”¨è¯¸å¦‚ az servicebus topic subscription update çš„å‘½ä»¤ï¼Œä»–ä»¬å¯ä»¥æ“æ§é…ç½®ï¼Œä¾‹å¦‚å¯ç”¨æ­»ä¿¡ä»¥è½¬ç§»æ¶ˆæ¯ï¼Œå°†æ¶ˆæ¯è½¬å‘åˆ°æœªç»æˆæƒçš„ç«¯ç‚¹ï¼Œæˆ–ä¿®æ”¹ TTL å’Œé”å®šæŒç»­æ—¶é—´ä»¥ä¿ç•™æˆ–å¹²æ‰°æ¶ˆæ¯ä¼ é€’ã€‚æ­¤å¤–ï¼Œä»–ä»¬å¯ä»¥æ›´æ”¹çŠ¶æ€æˆ–æœ€å¤§äº¤ä»˜è®¡æ•°è®¾ç½®ï¼Œä»¥å¹²æ‰°æ“ä½œæˆ–é€ƒé¿æ£€æµ‹ï¼Œä½¿è®¢é˜…æ§åˆ¶æˆä¸ºåæœŸåˆ©ç”¨åœºæ™¯ä¸­çš„å…³é”®æ–¹é¢ã€‚

{% code overflow="wrap" %}
```bash
az servicebus topic subscription create --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
az servicebus topic subscription update --resource-group <ResourceGroupName> --namespace-name <NamespaceName> --topic-name <TopicName> --name <SubscriptionName>
```
{% endcode %}


### æ“ä½œ: `AuthorizationRules` å‘é€å’Œæ¥æ”¶æ¶ˆæ¯

è¯·æŸ¥çœ‹è¿™é‡Œ:

{% content-ref url="../az-services/az-queue-privesc.md" %}
[az-queue-privesc.md](../az-services/az-queue-privesc.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* https://learn.microsoft.com/en-us/azure/storage/queues/storage-powershell-how-to-use-queues
* https://learn.microsoft.com/en-us/rest/api/storageservices/queue-service-rest-api
* https://learn.microsoft.com/en-us/azure/storage/queues/queues-auth-abac-attributes
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-python-how-to-use-topics-subscriptions?tabs=passwordless
* https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/integration#microsoftservicebus
* https://learn.microsoft.com/en-us/cli/azure/servicebus/namespace?view=azure-cli-latest
* https://learn.microsoft.com/en-us/cli/azure/servicebus/queue?view=azure-cli-latest

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
