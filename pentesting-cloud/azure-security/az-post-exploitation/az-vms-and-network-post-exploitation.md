# Az - VMs & Network Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## VMs & Network

Para m谩s informaci贸n sobre Azure VMs y redes, consulta la siguiente p谩gina:

{% content-ref url="../az-services/vms/" %}
[vms](../az-services/vms/)
{% endcontent-ref %}

### VM Application Pivoting

Las aplicaciones de VM pueden ser compartidas con otras suscripciones y inquilinos. Si una aplicaci贸n est谩 siendo compartida, probablemente sea porque est谩 siendo utilizada. As铆 que, si el atacante logra **comprometer la aplicaci贸n y sube una versi贸n con puerta trasera**, podr铆a ser posible que sea **ejecutada en otro inquilino o suscripci贸n**.

### Informaci贸n sensible en im谩genes

Puede ser posible encontrar **informaci贸n sensible dentro de im谩genes** tomadas de VMs en el pasado.

1. **Listar im谩genes** de galer铆as
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Listar im谩genes personalizadas**
```bash
az image list -o table
```
3. **Crear VM a partir de ID de imagen** y buscar informaci贸n sensible dentro de ella
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Informaci贸n sensible en puntos de restauraci贸n

Puede ser posible encontrar **informaci贸n sensible dentro de los puntos de restauraci贸n**.

1. **Listar puntos de restauraci贸n**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Crear un disco** a partir de un punto de restauraci贸n

{% code overflow="wrap" %}
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
{% endcode %}

3. **Adjuntar el disco a una VM** (el atacante necesita haber comprometido una VM dentro de la cuenta ya)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Montar** el disco y **buscar informaci贸n sensible**

{% tabs %}
{% tab title="Linux" %}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{% endtab %}

{% tab title="Windows" %}
#### **1. Abrir la Administraci贸n de Discos**

1. Haz clic derecho en **Inicio** y selecciona **Administraci贸n de Discos**.
2. El disco adjunto deber铆a aparecer como **Desconectado** o **No asignado**.

#### **2. Conectar el Disco**

1. Localiza el disco en el panel inferior.
2. Haz clic derecho en el disco (por ejemplo, **Disco 1**) y selecciona **Conectar**.

#### **3. Inicializar el Disco**

1. Si el disco no est谩 inicializado, haz clic derecho y selecciona **Inicializar Disco**.
2. Elige el estilo de partici贸n:
* **MBR** (Registro de Arranque Maestro) o **GPT** (Tabla de Particiones GUID). Se recomienda GPT para sistemas modernos.

#### **4. Crear un Nuevo Volumen**

1. Haz clic derecho en el espacio no asignado en el disco y selecciona **Nuevo Volumen Simple**.
2. Sigue el asistente para:
* Asignar una letra de unidad (por ejemplo, `D:`).
* Formatear el disco (elige NTFS en la mayor铆a de los casos).
{% endtab %}
{% endtabs %}

### Informaci贸n sensible en discos y instant谩neas

Puede ser posible encontrar **informaci贸n sensible dentro de discos o incluso instant谩neas de discos antiguos**.

1. **Listar instant谩neas**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Crear disco a partir de una instant谩nea** (si es necesario)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Adjuntar y montar el disco** a una VM y buscar informaci贸n sensible (consulta la secci贸n anterior para ver c贸mo hacerlo)

### Informaci贸n sensible en extensiones de VM y aplicaciones de VM

Puede ser posible encontrar **informaci贸n sensible dentro de extensiones de VM y aplicaciones de VM**.

1. **Listar todas las aplicaciones de VM**

{% code overflow="wrap" %}
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

2. Instale la extensi贸n en una VM y **busque informaci贸n sensible**

{% code overflow="wrap" %}
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endcode %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
