# Az - VMs & Network Post Exploitation

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## VMs & R√©seau

Pour plus d'informations sur les VMs Azure et le r√©seau, consultez la page suivante :

{% content-ref url="../az-services/vms/" %}
[vms](../az-services/vms/)
{% endcontent-ref %}

### Pivotement d'application VM

Les applications VM peuvent √™tre partag√©es avec d'autres abonnements et locataires. Si une application est partag√©e, c'est probablement parce qu'elle est utilis√©e. Donc, si l'attaquant parvient √† **compromettre l'application et t√©l√©charge une version avec un backdoor**, il pourrait √™tre possible qu'elle soit **ex√©cut√©e dans un autre locataire ou abonnement**.

### Informations sensibles dans les images

Il pourrait √™tre possible de trouver **des informations sensibles √† l'int√©rieur des images** prises des VMs dans le pass√©.

1. **Lister les images** des galeries
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Lister les images personnalis√©es**
```bash
az image list -o table
```
3. **Cr√©er une VM √† partir de l'ID d'image** et rechercher des informations sensibles √† l'int√©rieur.
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Informations sensibles dans les points de restauration

Il pourrait √™tre possible de trouver **des informations sensibles √† l'int√©rieur des points de restauration**.

1. **Lister les points de restauration**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Cr√©er un disque** √† partir d'un point de restauration

{% code overflow="wrap" %}
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
{% endcode %}

3. **Attacher le disque √† une VM** (l'attaquant doit d√©j√† avoir compromis une VM √† l'int√©rieur du compte)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Montez** le disque et **recherchez des informations sensibles**

{% tabs %}
{% tab title="Linux" %}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{% endtab %}

{% tab title="Windows" %}
#### **1. Ouvrir la gestion des disques**

1. Faites un clic droit sur **D√©marrer** et s√©lectionnez **Gestion des disques**.
2. Le disque attach√© devrait appara√Ætre comme **Hors ligne** ou **Non allou√©**.

#### **2. Mettre le disque en ligne**

1. Localisez le disque dans le panneau inf√©rieur.
2. Faites un clic droit sur le disque (par exemple, **Disque 1**) et s√©lectionnez **En ligne**.

#### **3. Initialiser le disque**

1. Si le disque n'est pas initialis√©, faites un clic droit et s√©lectionnez **Initialiser le disque**.
2. Choisissez le style de partition :
* **MBR** (Master Boot Record) ou **GPT** (GUID Partition Table). GPT est recommand√© pour les syst√®mes modernes.

#### **4. Cr√©er un nouveau volume**

1. Faites un clic droit sur l'espace non allou√© sur le disque et s√©lectionnez **Nouveau volume simple**.
2. Suivez l'assistant pour :
* Attribuer une lettre de lecteur (par exemple, `D:`).
* Formater le disque (choisissez NTFS dans la plupart des cas).
{% endtab %}
{% endtabs %}

### Informations sensibles dans les disques et les instantan√©s

Il pourrait √™tre possible de trouver **des informations sensibles √† l'int√©rieur des disques ou m√™me dans les anciens instantan√©s de disque**.

1. **Lister les instantan√©s**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Cr√©er un disque √† partir d'un instantan√©** (si n√©cessaire)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Attacher et monter le disque** √† une VM et rechercher des informations sensibles (voir la section pr√©c√©dente pour savoir comment faire cela)

### Informations sensibles dans les extensions VM et les applications VM

Il pourrait √™tre possible de trouver **des informations sensibles √† l'int√©rieur des extensions VM et des applications VM**.

1. **Lister toutes les applications VM**

{% code overflow="wrap" %}
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

2. Installez l'extension dans une VM et **recherchez des informations sensibles**

{% code overflow="wrap" %}
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endcode %}

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team AWS (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Formation Expert Red Team GCP (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
