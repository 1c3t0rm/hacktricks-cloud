# Az - VMs & Network Post Exploitation

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## VMs & Network

Para mais informa√ß√µes sobre VMs e redes do Azure, confira a seguinte p√°gina:

{% content-ref url="../az-services/vms/" %}
[vms](../az-services/vms/)
{% endcontent-ref %}

### VM Application Pivoting

As aplica√ß√µes de VM podem ser compartilhadas com outras assinaturas e locat√°rios. Se uma aplica√ß√£o est√° sendo compartilhada, provavelmente √© porque est√° sendo utilizada. Portanto, se o atacante conseguir **comprometer a aplica√ß√£o e enviar uma vers√£o com backdoor**, pode ser poss√≠vel que ela seja **executada em outro locat√°rio ou assinatura**.

### Informa√ß√µes sens√≠veis em imagens

Pode ser poss√≠vel encontrar **informa√ß√µes sens√≠veis dentro de imagens** tiradas de VMs no passado.

1. **Listar imagens** de galerias
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **Listar imagens personalizadas**
```bash
az image list -o table
```
3. **Criar VM a partir do ID da imagem** e procurar informa√ß√µes sens√≠veis dentro dela
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### Informa√ß√µes sens√≠veis em pontos de restaura√ß√£o

Pode ser poss√≠vel encontrar **informa√ß√µes sens√≠veis dentro de pontos de restaura√ß√£o**.

1. **Listar pontos de restaura√ß√£o**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **Criar um disco** a partir de um ponto de restaura√ß√£o

{% code overflow="wrap" %}
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
{% endcode %}

3. **Anexar o disco a uma VM** (o atacante precisa j√° ter comprometido uma VM dentro da conta)
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **Montar** o disco e **procurar informa√ß√µes sens√≠veis**

{% tabs %}
{% tab title="Linux" %}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{% endtab %}

{% tab title="Windows" %}
#### **1. Abra o Gerenciamento de Disco**

1. Clique com o bot√£o direito em **Iniciar** e selecione **Gerenciamento de Disco**.
2. O disco conectado deve aparecer como **Offline** ou **N√£o Alocado**.

#### **2. Coloque o Disco Online**

1. Localize o disco no painel inferior.
2. Clique com o bot√£o direito no disco (por exemplo, **Disco 1**) e selecione **Online**.

#### **3. Inicialize o Disco**

1. Se o disco n√£o estiver inicializado, clique com o bot√£o direito e selecione **Inicializar Disco**.
2. Escolha o estilo de parti√ß√£o:
* **MBR** (Master Boot Record) ou **GPT** (GUID Partition Table). GPT √© recomendado para sistemas modernos.

#### **4. Crie um Novo Volume**

1. Clique com o bot√£o direito no espa√ßo n√£o alocado no disco e selecione **Novo Volume Simples**.
2. Siga o assistente para:
* Atribuir uma letra de unidade (por exemplo, `D:`).
* Formatar o disco (escolha NTFS na maioria dos casos).
{% endtab %}
{% endtabs %}

### Informa√ß√µes sens√≠veis em discos e snapshots

Pode ser poss√≠vel encontrar **informa√ß√µes sens√≠veis dentro de discos ou at√© mesmo snapshots antigos de discos**.

1. **Listar snapshots**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **Criar disco a partir de snapshot** (se necess√°rio)
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **Anexar e montar o disco** a uma VM e procurar por informa√ß√µes sens√≠veis (verifique a se√ß√£o anterior para ver como fazer isso)

### Informa√ß√µes sens√≠veis em Extens√µes de VM e Aplica√ß√µes de VM

Pode ser poss√≠vel encontrar **informa√ß√µes sens√≠veis dentro de extens√µes de VM e aplica√ß√µes de VM**.

1. **Listar todos os aplicativos de VM**

{% code overflow="wrap" %}
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

2. Instale a extens√£o em uma VM e **procure por informa√ß√µes sens√≠veis**

{% code overflow="wrap" %}
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endcode %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporte o HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
