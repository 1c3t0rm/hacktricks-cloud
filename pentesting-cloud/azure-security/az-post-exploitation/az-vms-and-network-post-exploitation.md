# Az - VMs & Network Post Exploitation

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## VMs & Network

æœ‰å…³ Azure VMs å’Œç½‘ç»œçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ä»¥ä¸‹é¡µé¢ï¼š

{% content-ref url="../az-services/vms/" %}
[vms](../az-services/vms/)
{% endcontent-ref %}

### VM åº”ç”¨ç¨‹åºè½¬å‘

VM åº”ç”¨ç¨‹åºå¯ä»¥ä¸å…¶ä»–è®¢é˜…å’Œç§Ÿæˆ·å…±äº«ã€‚å¦‚æœä¸€ä¸ªåº”ç”¨ç¨‹åºæ­£åœ¨è¢«å…±äº«ï¼Œå¯èƒ½æ˜¯å› ä¸ºå®ƒæ­£åœ¨è¢«ä½¿ç”¨ã€‚å› æ­¤ï¼Œå¦‚æœæ”»å‡»è€…è®¾æ³• **ç ´åäº†åº”ç”¨ç¨‹åºå¹¶ä¸Šä¼ äº†ä¸€ä¸ªåé—¨** ç‰ˆæœ¬ï¼Œå¯èƒ½ä¼šåœ¨ **å¦ä¸€ä¸ªç§Ÿæˆ·æˆ–è®¢é˜…ä¸­æ‰§è¡Œ**ã€‚

### å›¾åƒä¸­çš„æ•æ„Ÿä¿¡æ¯

å¯èƒ½ä¼šå‘ç° **è¿‡å»ä» VMs æ‹æ‘„çš„å›¾åƒä¸­åŒ…å«æ•æ„Ÿä¿¡æ¯**ã€‚

1. **åˆ—å‡º** æ¥è‡ªç”»å»Šçš„å›¾åƒ
```bash
# Get galleries
az sig list -o table

# List images inside gallery
az sig image-definition list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
-o table

# Get images versions
az sig image-version list \
--resource-group <RESOURCE_GROUP> \
--gallery-name <GALLERY_NAME> \
--gallery-image-definition <IMAGE_DEFINITION> \
-o table
```
2. **åˆ—å‡ºè‡ªå®šä¹‰é•œåƒ**
```bash
az image list -o table
```
3. **ä»é•œåƒ ID åˆ›å»ºè™šæ‹Ÿæœº** å¹¶åœ¨å…¶ä¸­æœç´¢æ•æ„Ÿä¿¡æ¯
```bash
# Create VM from image
az vm create \
--resource-group <RESOURCE_GROUP> \
--name <VM_NAME> \
--image /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/galleries/<GALLERY_NAME>/images/<IMAGE_DEFINITION>/versions/<IMAGE_VERSION> \
--admin-username <ADMIN_USERNAME> \
--generate-ssh-keys
```
### æ¢å¤ç‚¹ä¸­çš„æ•æ„Ÿä¿¡æ¯

å¯èƒ½ä¼šåœ¨**æ¢å¤ç‚¹ä¸­æ‰¾åˆ°æ•æ„Ÿä¿¡æ¯**ã€‚

1. **åˆ—å‡ºæ¢å¤ç‚¹**
```bash
az restore-point list \
--resource-group <RESOURCE_GROUP> \
--restore-point-collection-name <COLLECTION_NAME> \
-o table
```
2. **ä»è¿˜åŸç‚¹åˆ›å»ºç£ç›˜**

{% code overflow="wrap" %}
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <NEW_DISK_NAME> \
--source /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/restorePointCollections/<COLLECTION_NAME>/restorePoints/<RESTORE_POINT_NAME>
```
{% endcode %}

3. **å°†ç£ç›˜é™„åŠ åˆ°è™šæ‹Ÿæœº**ï¼ˆæ”»å‡»è€…éœ€è¦å·²ç»å…¥ä¾µäº†å¸æˆ·å†…çš„è™šæ‹Ÿæœºï¼‰
```bash
az vm disk attach \
--resource-group <RESOURCE_GROUP> \
--vm-name <VM_NAME> \
--name <DISK_NAME>
```
4. **æŒ‚è½½**ç£ç›˜å¹¶**æœç´¢æ•æ„Ÿä¿¡æ¯**

{% tabs %}
{% tab title="Linux" %}
```bash
# List all available disks
sudo fdisk -l

# Check disk format
sudo file -s /dev/sdX

# Mount it
sudo mkdir /mnt/mydisk
sudo mount /dev/sdX1 /mnt/mydisk
```
{% endtab %}

{% tab title="Windows" %}
#### **1. æ‰“å¼€ç£ç›˜ç®¡ç†**

1. å³é”®ç‚¹å‡» **å¼€å§‹**ï¼Œé€‰æ‹© **ç£ç›˜ç®¡ç†**ã€‚
2. é™„åŠ çš„ç£ç›˜åº”è¯¥æ˜¾ç¤ºä¸º **ç¦»çº¿** æˆ– **æœªåˆ†é…**ã€‚

#### **2. å°†ç£ç›˜ä¸Šçº¿**

1. åœ¨åº•éƒ¨çª—æ ¼ä¸­æ‰¾åˆ°ç£ç›˜ã€‚
2. å³é”®ç‚¹å‡»ç£ç›˜ï¼ˆä¾‹å¦‚ï¼Œ**ç£ç›˜ 1**ï¼‰å¹¶é€‰æ‹© **åœ¨çº¿**ã€‚

#### **3. åˆå§‹åŒ–ç£ç›˜**

1. å¦‚æœç£ç›˜æœªåˆå§‹åŒ–ï¼Œå³é”®ç‚¹å‡»å¹¶é€‰æ‹© **åˆå§‹åŒ–ç£ç›˜**ã€‚
2. é€‰æ‹©åˆ†åŒºæ ·å¼ï¼š
* **MBR**ï¼ˆä¸»å¼•å¯¼è®°å½•ï¼‰æˆ– **GPT**ï¼ˆGUID åˆ†åŒºè¡¨ï¼‰ã€‚ç°ä»£ç³»ç»Ÿæ¨èä½¿ç”¨ GPTã€‚

#### **4. åˆ›å»ºæ–°å·**

1. å³é”®ç‚¹å‡»ç£ç›˜ä¸Šçš„æœªåˆ†é…ç©ºé—´ï¼Œé€‰æ‹© **æ–°å»ºç®€å•å·**ã€‚
2. æŒ‰ç…§å‘å¯¼æ“ä½œï¼š
* åˆ†é…é©±åŠ¨å™¨å­—æ¯ï¼ˆä¾‹å¦‚ï¼Œ`D:`ï¼‰ã€‚
* æ ¼å¼åŒ–ç£ç›˜ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹é€‰æ‹© NTFSï¼‰ã€‚
{% endtab %}
{% endtabs %}

### ç£ç›˜å’Œå¿«ç…§ä¸­çš„æ•æ„Ÿä¿¡æ¯

å¯èƒ½ä¼šåœ¨ **ç£ç›˜æˆ–æ—§ç£ç›˜å¿«ç…§ä¸­æ‰¾åˆ°æ•æ„Ÿä¿¡æ¯**ã€‚

1. **åˆ—å‡ºå¿«ç…§**
```bash
az snapshot list \
--resource-group <RESOURCE_GROUP> \
-o table
```
2. **ä»å¿«ç…§åˆ›å»ºç£ç›˜**ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
```bash
az disk create \
--resource-group <RESOURCE_GROUP> \
--name <DISK_NAME> \
--source <SNAPSHOT_ID> \
--size-gb <DISK_SIZE>
```
3. **å°†ç£ç›˜é™„åŠ å¹¶æŒ‚è½½**åˆ°è™šæ‹Ÿæœºå¹¶æœç´¢æ•æ„Ÿä¿¡æ¯ï¼ˆæŸ¥çœ‹ä¸Šä¸€èŠ‚ä»¥äº†è§£å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼‰

### è™šæ‹Ÿæœºæ‰©å±•å’Œè™šæ‹Ÿæœºåº”ç”¨ä¸­çš„æ•æ„Ÿä¿¡æ¯

å¯èƒ½ä¼šåœ¨**è™šæ‹Ÿæœºæ‰©å±•å’Œè™šæ‹Ÿæœºåº”ç”¨ä¸­æ‰¾åˆ°æ•æ„Ÿä¿¡æ¯**ã€‚

1. **åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿæœºåº”ç”¨** 

{% code overflow="wrap" %}
```bash
## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

2. åœ¨è™šæ‹Ÿæœºä¸­å®‰è£…æ‰©å±•å¹¶**æœç´¢æ•æ„Ÿä¿¡æ¯**

{% code overflow="wrap" %}
```bash
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endcode %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ **ä¸Šå…³æ³¨æˆ‘ä»¬** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
