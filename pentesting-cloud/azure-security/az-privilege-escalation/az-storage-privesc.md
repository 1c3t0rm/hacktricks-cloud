# Az - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage Privesc

Aby uzyska wicej informacji na temat przechowywania, sprawd藕:

{% content-ref url="../az-services/az-storage.md" %}
[az-storage.md](../az-services/az-storage.md)
{% endcontent-ref %}

### Microsoft.Storage/storageAccounts/listkeys/action

Podmiot z tym uprawnieniem bdzie m贸g wylistowa (i wartoci sekretne) **kluczy dostpu** kont przechowywania. Pozwoli to podmiotowi na eskalacj jego uprawnie w kontach przechowywania.
```bash
az storage account keys list --account-name <acc-name>
```
### Microsoft.Storage/storageAccounts/regenerateKey/action

Osoba z tym uprawnieniem bdzie moga odnowi i uzyska now warto sekretu **kluczy dostpu** konta magazynowego. Pozwoli to osobie na eskalacj jej uprawnie w odniesieniu do kont magazynowych.

Ponadto w odpowiedzi u偶ytkownik otrzyma warto odnowionego klucza oraz warto klucza, kt贸ry nie zosta odnowiony:
```bash
az storage account keys renew --account-name <acc-name> --key key2
```
### Microsoft.Storage/storageAccounts/write

Principal z tym uprawnieniem bdzie m贸g tworzy lub aktualizowa istniejce konto magazynu, aktualizujc dowolne ustawienie, takie jak zasady sieciowe lub polityki.

{% code overflow="wrap" %}
```bash
# e.g. set default action to allow so network restrictions are avoided
az storage account update --name <acc-name> --default-action Allow

# e.g. allow an IP address
az storage account update --name <acc-name> --add networkRuleSet.ipRules value=<ip-address>
```
{% endcode %}

## Blobs Specyficzne privesc

### Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write | Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete

Pierwsze uprawnienie pozwala na **modyfikacj polityk niezmiennoci** w kontenerach, a drugie na ich usunicie.

{% hint style="info" %}
Zauwa偶, 偶e jeli polityka niezmiennoci jest w stanie blokady, nie mo偶esz wykona 偶adnej z tych operacji
{% endhint %}
```bash
az storage container immutability-policy delete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP>

az storage container immutability-policy update \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP> \
--period <NEW_RETENTION_PERIOD_IN_DAYS>
```
## File shares specific privesc

### Microsoft.Storage/storageAccounts/fileServices/takeOwnership/action

To powinno umo偶liwi u偶ytkownikowi posiadajcemu t uprawnienie przejcie wasnoci plik贸w w udostpnionym systemie plik贸w.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action

To powinno umo偶liwi u偶ytkownikowi posiadajcemu t uprawnienie modyfikacj uprawnie plik贸w w udostpnionym systemie plik贸w.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action

To powinno umo偶liwi u偶ytkownikowi posiadajcemu t uprawnienie wykonywanie dziaa w systemie plik贸w jako superu偶ytkownik.

### Microsoft.Storage/storageAccounts/localusers/write (Microsoft.Storage/storageAccounts/localusers/read)

Dziki temu uprawnieniu, atakujcy mo偶e tworzy i aktualizowa (jeli ma ```Microsoft.Storage/storageAccounts/localusers/read``` uprawnienie) nowego lokalnego u偶ytkownika dla konta Azure Storage (skonfigurowanego z hierarchiczn przestrzeni nazw), w tym okrelenie uprawnie u偶ytkownika i katalogu domowego. To uprawnienie jest istotne, poniewa偶 pozwala atakujcemu przyzna sobie dostp do konta storage z okrelonymi uprawnieniami, takimi jak odczyt (r), zapis (w), usunicie (d) i lista (l) oraz inne. Dodatkowo metody uwierzytelniania, kt贸re to wykorzystuje, mog by hasami generowanymi przez Azure i parami kluczy SSH. Nie ma sprawdzenia, czy u偶ytkownik ju偶 istnieje, wic mo偶na nadpisa innych u偶ytkownik贸w, kt贸rzy ju偶 tam s. Atakujcy m贸gby podnie swoje uprawnienia i uzyska dostp SSH do konta storage, potencjalnie ujawniajc lub kompromitujc wra偶liwe dane.

{% code overflow="wrap" %}
```bash
az storage account local-user create \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME> \
--permission-scope permissions=rwdl service=blob resource-name=<CONTAINER_NAME> \
--home-directory <HOME_DIRECTORY> \
--has-ssh-key false/true # Depends on the auth method to use
```
{% endcode %}

### Microsoft.Storage/storageAccounts/localusers/regeneratePassword/action

Dziki temu uprawnieniu, atakujcy mo偶e zregenerowa haso dla lokalnego u偶ytkownika w koncie Azure Storage. Daje to atakujcemu mo偶liwo uzyskania nowych powiadcze uwierzytelniajcych (takich jak haso SSH lub SFTP) dla u偶ytkownika. Wykorzystujc te powiadczenia, atakujcy mo偶e uzyska nieautoryzowany dostp do konta storage, przeprowadza transfery plik贸w lub manipulowa danymi w kontenerach storage. Mo偶e to prowadzi do wycieku danych, uszkodzenia lub zoliwej modyfikacji zawartoci konta storage.

{% code overflow="wrap" %}
```bash
az storage account local-user regenerate-password \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME>
```
{% endcode %}

Aby uzyska dostp do Azure Blob Storage za pomoc SFTP przy u偶yciu lokalnego u偶ytkownika przez SFTP, mo偶esz (mo偶esz r贸wnie偶 u偶y klucza ssh do poczenia):

{% code overflow="wrap" %}
```bash
sftp <local-user-name>@<storage-account-name>.blob.core.windows.net
#regenerated-password
```
{% endcode %}

### Microsoft.Storage/storageAccounts/restoreBlobRanges/action, Microsoft.Storage/storageAccounts/blobServices/containers/read, Microsoft.Storage/storageAccounts/read && Microsoft.Storage/storageAccounts/listKeys/action

Dziki tym uprawnieniom atakujcy mo偶e przywr贸ci usunity kontener, podajc jego identyfikator wersji usunitej lub przywr贸ci konkretne bloby w kontenerze, jeli wczeniej zostay one usunite w spos贸b mikki. Ta eskalacja uprawnie mo偶e pozwoli atakujcemu na odzyskanie wra偶liwych danych, kt贸re miay zosta trwale usunite, co potencjalnie prowadzi do nieautoryzowanego dostpu.

{% code overflow="wrap" %}
```bash
#Restore the soft deleted container
az storage container restore \
--account-name <STORAGE_ACCOUNT_NAME> \
--name <CONTAINER_NAME> \
--deleted-version <VERSION>

#Restore the soft deleted blob
az storage blob undelete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--name "fileName.txt"
```
{% endcode %}

### Microsoft.Storage/storageAccounts/fileServices/shares/restore/action && Microsoft.Storage/storageAccounts/read

Dziki tym uprawnieniom, atakujcy mo偶e przywr贸ci usunit usug plik贸w Azure, okrelajc jej identyfikator wersji usunitej. Ta eskalacja uprawnie mo偶e pozwoli atakujcemu na odzyskanie wra偶liwych danych, kt贸re miay zosta trwale usunite, co mo偶e prowadzi do nieautoryzowanego dostpu.

{% code overflow="wrap" %}
```bash
az storage share-rm restore \
--storage-account <STORAGE_ACCOUNT_NAME> \
--name <FILE_SHARE_NAME> \
--deleted-version <VERSION>
```
{% endcode %}

## Inne interesujce uprawnienia (TODO)

* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/manageOwnership/action: Zmienia waciciela bloba
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/modifyPermissions/action: Modyfikuje uprawnienia bloba
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/runAsSuperUser/action: Zwraca wynik polecenia bloba
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/immutableStorage/runAsSuperUser/action

## Odniesienia

* [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage)
* [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)


{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
