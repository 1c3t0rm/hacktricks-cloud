# Az - Storage Privesc

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Storage Privesc

Za vi코e informacija o skladi코tu proverite:

{% content-ref url="../az-services/az-storage.md" %}
[az-storage.md](../az-services/az-storage.md)
{% endcontent-ref %}

### Microsoft.Storage/storageAccounts/listkeys/action

Principalu sa ovom dozvolom bi캖e omogu캖eno da prika쬰 (i tajne vrednosti) **pristupne klju캜eve** skladi코nih ra캜una. To omogu캖ava principalu da eskalira svoje privilegije nad skladi코nim ra캜unima.
```bash
az storage account keys list --account-name <acc-name>
```
### Microsoft.Storage/storageAccounts/regenerateKey/action

Princip sa ovom dozvolom 캖e mo캖i da obnovi i dobije novu tajnu vrednost **access keys** za naloge za skladi코tenje. To omogu캖ava principalu da eskalira svoje privilegije nad nalozima za skladi코tenje.

Pored toga, u odgovoru, korisnik 캖e dobiti vrednost obnovljenog klju캜a, kao i vrednost neobnovljenog:
```bash
az storage account keys renew --account-name <acc-name> --key key2
```
### Microsoft.Storage/storageAccounts/write

Princip sa ovom dozvolom 캖e mo캖i da kreira ili a쬿rira postoje캖i nalog za skladi코tenje, a쬿riraju캖i bilo koju postavku kao 코to su pravila mre쬰 ili politike.

{% code overflow="wrap" %}
```bash
# e.g. set default action to allow so network restrictions are avoided
az storage account update --name <acc-name> --default-action Allow

# e.g. allow an IP address
az storage account update --name <acc-name> --add networkRuleSet.ipRules value=<ip-address>
```
{% endcode %}

## Blobs Specifi캜ne privesc

### Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/write | Microsoft.Storage/storageAccounts/blobServices/containers/immutabilityPolicies/delete

Prvo dopu코tenje omogu캖ava **modifikaciju politika nepromenljivosti** u kontejnerima, a drugo da ih obri코ete.

{% hint style="info" %}
Imajte na umu da ako je politika nepromenljivosti u stanju zaklju캜avanja, ne mo쬰te uraditi nijedno od ta dva
{% endhint %}
```bash
az storage container immutability-policy delete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP>

az storage container immutability-policy update \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--resource-group <RESOURCE_GROUP> \
--period <NEW_RETENTION_PERIOD_IN_DAYS>
```
## File shares specific privesc

### Microsoft.Storage/storageAccounts/fileServices/takeOwnership/action

Ovo bi trebalo da omogu캖i korisniku koji ima ovu dozvolu da preuzme vlasni코tvo nad datotekama unutar deljenog datote캜nog sistema.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/modifypermissions/action

Ovo bi trebalo da omogu캖i korisniku koji ima ovu dozvolu da mo쬰 da menja dozvole datoteka unutar deljenog datote캜nog sistema.

### Microsoft.Storage/storageAccounts/fileServices/fileshares/files/actassuperuser/action

Ovo bi trebalo da omogu캖i korisniku koji ima ovu dozvolu da mo쬰 da izvr코ava radnje unutar datote캜nog sistema kao superkorisnik.

### Microsoft.Storage/storageAccounts/localusers/write (Microsoft.Storage/storageAccounts/localusers/read)

Sa ovom dozvolom, napada캜 mo쬰 da kreira i a쬿rira (ako ima ```Microsoft.Storage/storageAccounts/localusers/read``` dozvolu) novog lokalnog korisnika za Azure Storage nalog (konfigurisano sa hijerarhijskim imenskim prostorom), uklju캜uju캖i odre캠ivanje dozvola korisnika i po캜etnog direktorijuma. Ova dozvola je zna캜ajna jer omogu캖ava napada캜u da sebi dodeli pristup skladi코nom nalogu sa specifi캜nim dozvolama kao 코to su 캜itanje (r), pisanje (w), brisanje (d) i listanje (l) i jo코 mnogo toga. Dodatno, metode autentifikacije koje se koriste mogu biti Azure-generisane lozinke i SSH parovi klju캜eva. Nema provere da li korisnik ve캖 postoji, tako da mo쬰te prepisati druge korisnike koji su ve캖 prisutni. Napada캜 bi mogao da eskalira svoje privilegije i dobije SSH pristup skladi코nom nalogu, potencijalno izla쬿캖i ili kompromituju캖i osetljive podatke.

{% code overflow="wrap" %}
```bash
az storage account local-user create \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME> \
--permission-scope permissions=rwdl service=blob resource-name=<CONTAINER_NAME> \
--home-directory <HOME_DIRECTORY> \
--has-ssh-key false/true # Depends on the auth method to use
```
{% endcode %}

### Microsoft.Storage/storageAccounts/localusers/regeneratePassword/action

Sa ovom dozvolom, napada캜 mo쬰 regenerisati lozinku za lokalnog korisnika u Azure Storage nalogu. Ovo omogu캖ava napada캜u da dobije nove autentifikacione kredencijale (kao 코to su SSH ili SFTP lozinka) za korisnika. Kori코캖enjem ovih kredencijala, napada캜 bi mogao dobiti neovla코캖en pristup storage nalogu, izvr코iti transfer fajlova ili manipulisati podacima unutar storage kontejnera. Ovo bi moglo rezultirati curenjem podataka, o코te캖enjem ili zlonamernom izmenom sadr쬬ja storage naloga.

{% code overflow="wrap" %}
```bash
az storage account local-user regenerate-password \
--account-name <STORAGE_ACCOUNT_NAME> \
--resource-group <RESOURCE_GROUP_NAME> \
--name <LOCAL_USER_NAME>
```
{% endcode %}

Da biste pristupili Azure Blob Storage putem SFTP koriste캖i lokalnog korisnika putem SFTP, mo쬰te (tako캠e mo쬰te koristiti ssh klju캜 za povezivanje):

{% code overflow="wrap" %}
```bash
sftp <local-user-name>@<storage-account-name>.blob.core.windows.net
#regenerated-password
```
{% endcode %}

### Microsoft.Storage/storageAccounts/restoreBlobRanges/action, Microsoft.Storage/storageAccounts/blobServices/containers/read, Microsoft.Storage/storageAccounts/read && Microsoft.Storage/storageAccounts/listKeys/action

Sa ovim dozvolama, napada캜 mo쬰 da vrati obrisani kontejner tako 코to 캖e navesti njegov ID obrisane verzije ili da ponovo aktivira odre캠ene blobove unutar kontejnera, ako su prethodno bili soft-obrisani. Ova eskalacija privilegija mo쬰 omogu캖iti napada캜u da povrati osetljive podatke koji su trebali biti trajno obrisani, 코to mo쬰 dovesti do neovla코캖enog pristupa.

{% code overflow="wrap" %}
```bash
#Restore the soft deleted container
az storage container restore \
--account-name <STORAGE_ACCOUNT_NAME> \
--name <CONTAINER_NAME> \
--deleted-version <VERSION>

#Restore the soft deleted blob
az storage blob undelete \
--account-name <STORAGE_ACCOUNT_NAME> \
--container-name <CONTAINER_NAME> \
--name "fileName.txt"
```
{% endcode %}


## Ostale zanimljive dozvole (TODO)

* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/manageOwnership/action: Menja vlasni코tvo nad blob-om
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/modifyPermissions/action: Menja dozvole blob-a
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/runAsSuperUser/action: Vra캖a rezultat komande blob-a
* Microsoft.Storage/storageAccounts/blobServices/containers/blobs/immutableStorage/runAsSuperUser/action

## Reference

* [https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage](https://learn.microsoft.com/en-us/azure/role-based-access-control/permissions/storage#microsoftstorage)
* [https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support](https://learn.microsoft.com/en-us/azure/storage/blobs/secure-file-transfer-protocol-support)


{% hint style="success" %}
U캜ite i ve쬭ajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
U캜ite i ve쬭ajte GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podr쬴te HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridru쬴te se** 游눫 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitter-u** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
