# Az - ダイナミックグループによる権限昇格

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

**ダイナミックグループ**は、一連の**ルール**が設定されており、ルールに一致する**ユーザーやデバイス**がグループに追加されます。ユーザーやデバイスの**属性**が**変更される**たびに、ダイナミックルールは**再チェック**されます。そして、**新しいルール**が**作成される**と、すべてのデバイスとユーザーが**チェック**されます。

ダイナミックグループには**Azure RBACロールを割り当てる**ことができますが、ダイナミックグループに**AzureADロール**を追加することは**できません**。

この機能にはAzure ADプレミアムP1ライセンスが必要です。

## 権限昇格

デフォルトでは、任意のユーザーがAzure ADにゲストを招待できることに注意してください。したがって、ダイナミックグループの**ルール**が新しい**ゲスト**に設定できる**属性**に基づいてユーザーに**権限**を与える場合、これらの属性を持つ**ゲストを作成**して**権限を昇格**させることが可能です。また、ゲストは自分のプロファイルを管理し、これらの属性を変更することも可能です。

ダイナミックメンバーシップを許可するグループを取得する: `Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}`

### 例

* **ルールの例**: `(user.otherMails -any (_ -contains "tester")) -and (user.userType -eq "guest")`
* **ルールの説明**: セカンダリメールに'stranger'という文字列が含まれているゲストユーザーはグループに追加されます

1. **Azure Active Directory** -> **Users** に移動し、`Want to switch back to the legacy users list experience? Click here to leave the preview`を**クリック**します。
2. **`New guest user`** をクリックし、メールを**招待**します。
3. 招待が送信されると、**ユーザーのプロファイル**がAzure ADに**追加**されます。ユーザーのプロファイルを開き、**招待を受け入れた下で(管理)をクリック**します。
* ![](<../../.gitbook/assets/image (87) (1).png>)
4. **`Resend invite?`** を**Yes**に変更すると、招待URLが取得できます：
* ![](<../../.gitbook/assets/image (11) (1) (2) (1).png>)
5. **URL**をコピーし、開いて、招待されたユーザーとして**ログイン**し、招待を**受け入れ**ます。
6.  CLIでユーザーとして**ログイン**し、セカンダリメールを設定します。

{% code overflow="wrap" %}
```powershell
# ログイン
$password = ConvertTo-SecureString 'password' - AsPlainText -Force
$creds = New-Object
System.Management.Automation.PSCredential('externaltester@somedomain.onmicrosoft.com', $Password)
Connect-AzureAD -Credential $creds -TenantId <tenant_id_of_attacked_domain>

# OtherMailsの設定を変更
Set-AzureADUser -ObjectId <OBJECT-ID> -OtherMails <Username>@<TENANT_NAME>.onmicrosoft.com -Verbose
```
{% endcode %}



## 参考文献

* [https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/](https://www.mnemonic.io/resources/blog/abusing-dynamic-groups-in-azure-ad-for-privilege-escalation/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでのAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
