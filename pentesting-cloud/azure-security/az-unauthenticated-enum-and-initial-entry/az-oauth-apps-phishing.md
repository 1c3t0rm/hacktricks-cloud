# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Mifumo ya Azure** imewekwa na ruhusa ambazo zitakuwa na uwezo wa kuzitumia wakati mtumiaji anapokubali programu (kama vile kuhesabu saraka, kufikia faili, au kufanya vitendo vingine). Kumbuka, kwamba programu itakuwa ikifanya kwa niaba ya mtumiaji, hivyo hata kama programu inaweza kuwa inahitaji ruhusa za usimamizi, ikiwa **mtumiaji anayekubali hana ruhusa hiyo**, programu **haitaweza kufanya vitendo vya usimamizi**.

### Ruhusa za kukubali programu

Kwa kawaida **mtumiaji yeyote anaweza kutoa ruhusa kwa programu**, ingawa hii inaweza kuwekwa ili watumiaji waweze kukubali tu **programu kutoka kwa wachapishaji waliothibitishwa kwa ruhusa zilizochaguliwa** au hata **kuondoa ruhusa** kwa watumiaji kukubali programu.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Ikiwa watumiaji hawawezi kukubali, **wasimamizi** kama `GA`, `Application Administrator` au `Cloud Application` `Administrator` wanaweza **kukubali programu** ambazo watumiaji wataweza kutumia.

Zaidi ya hayo, ikiwa watumiaji wanaweza kukubali tu programu zinazotumia **ruhusa za hatari ndogo**, ruhusa hizi kwa kawaida ni **openid**, **profile**, **email**, **User.Read** na **offline\_access**, ingawa inawezekana **kuongeza zaidi** kwenye orodha hii.

Na ikiwa wanaweza kukubali programu zote, wanaweza kukubali programu zote.

### Aina 2 za mashambulizi

* **Isiyo na uthibitisho**: Kutoka kwa akaunti ya nje tengeneza programu yenye **ruhusa za hatari ndogo** `User.Read` na `User.ReadBasic.All` kwa mfano, phish mtumiaji, na utaweza kufikia taarifa za saraka.
* Hii inahitaji mtumiaji aliye phished kuwa **na uwezo wa kukubali programu za OAuth kutoka kwa mpangilio wa nje**
* Ikiwa mtumiaji aliye phished ni msimamizi ambaye anaweza **kukubali programu yoyote yenye ruhusa yoyote**, programu hiyo inaweza pia **kuomba ruhusa za kipaumbele**
* **Iliyothibitishwa**: Baada ya kuathiri mtu mwenye ruhusa za kutosha, **tengeneza programu ndani ya akaunti** na **phish** mtumiaji **aliye na ruhusa** ambaye anaweza kukubali ruhusa za kipaumbele za OAuth.
* Katika kesi hii tayari unaweza kufikia taarifa za saraka, hivyo ruhusa `User.ReadBasic.All` si ya kuvutia tena.
* Huenda unavutiwa na **ruhusa zinazohitaji msimamizi kuzipatia**, kwa sababu mtumiaji wa kawaida hawezi kutoa ruhusa yoyote kwa programu za OAuth, ndio maana unahitaji **phish tu watumiaji hao** (zaidi kuhusu ni nafasi/ruhusa zipi zinatoa kipaumbele hiki baadaye)

### Watumiaji wanaruhusiwa kukubali

Kumbuka kwamba unahitaji kutekeleza amri hii kutoka kwa mtumiaji ndani ya mpangilio, huwezi kupata usanidi huu wa mpangilio kutoka kwa mpangilio wa nje. CLI ifuatayo inaweza kusaidia kuelewa ruhusa za watumiaji:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Watumiaji wanaweza kukubali programu zote: Ikiwa ndani ya **`permissionGrantPoliciesAssigned`** unaweza kupata: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` basi watumiaji wanaweza kukubali kila programu.
* Watumiaji wanaweza kukubali programu kutoka kwa wachapishaji waliothibitishwa au shirika lako, lakini tu kwa ruhusa unazochagua: Ikiwa ndani ya **`permissionGrantPoliciesAssigned`** unaweza kupata: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` basi watumiaji wanaweza kukubali kila programu.
* **Zima idhini ya mtumiaji**: Ikiwa ndani ya **`permissionGrantPoliciesAssigned`** unaweza tu kupata: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` na `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` basi watumiaji hawawezi kukubali chochote.

Inawezekana kupata maana ya kila sera iliyotajwa katika: 

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Wasimamizi wa Programu**

Angalia watumiaji wanaoonekana kama wasimamizi wa programu (wanaweza kukubali programu mpya):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Muhtasari wa Mchakato wa Shambulio**

Shambulio linajumuisha hatua kadhaa zinazolenga kampuni ya kawaida. Hapa kuna jinsi linavyoweza kuendelea:

1. **Usajili wa Kikoa na Kuweka Programu**: Mshambuliaji anasajili kikoa kinachofanana na tovuti ya kuaminika, kwa mfano, "safedomainlogin.com". Chini ya kikoa hiki, subdomain inaundwa (mfano, "companyname.safedomainlogin.com") ili kuweka programu iliyoundwa kukamata nambari za idhini na kuomba alama za ufikiaji.
2. **Usajili wa Programu katika Azure AD**: Mshambuliaji kisha anasajili Programu ya Multi-Tenant katika Azure AD Tenant yao, akiiita kwa jina la kampuni lengwa ili kuonekana halali. Wanatengeneza URL ya Redirect ya programu hiyo kuelekea subdomain inayohifadhi programu mbaya.
3. **Kuweka Ruhusa**: Mshambuliaji anapanga programu hiyo na ruhusa mbalimbali za API (mfano, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ruhusa hizi, mara tu zinapopewa na mtumiaji, zinamruhusu mshambuliaji kutoa taarifa nyeti kwa niaba ya mtumiaji.
4. **Kusambaza Viungo Mbaya**: Mshambuliaji anaunda kiungo kinachokuwa na kitambulisho cha mteja wa programu mbaya na kukishiriki na watumiaji walengwa, akiwadanganya kuwapa idhini.

## Mfano wa Shambulio

1. Sajili **programu mpya**. Inaweza kuwa tu kwa saraka ya sasa ikiwa unatumia mtumiaji kutoka saraka iliyoathiriwa au kwa saraka yoyote ikiwa hii ni shambulio la nje (kama katika picha ifuatayo).
1. Pia weka **redirect URI** kwa URL inayotarajiwa ambapo unataka kupokea nambari za kupata alama (`http://localhost:8000/callback` kwa chaguo-msingi).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Kisha tengeneza siri ya programu:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. Chagua ruhusa za API (mfano, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Tekeleza ukurasa wa wavuti (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** unaoomba ruhusa:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Tuma URL kwa mwathirika**
1. Katika kesi hii `http://localhost:8000`
6. **Waathirika** wanahitaji **kukubali ombi:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Tumia **token ya ufikiaji kupata ruhusa zilizohitajika**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Other Tools

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Angalia [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) kujifunza jinsi ya kuikamilisha.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-Exploitation

### Phishing Post-Exploitation

Kulingana na ruhusa zilizotolewa unaweza kuwa na uwezo wa **kufikia data tofauti za mpangaji** (orodha ya watumiaji, vikundi... au hata kubadilisha mipangilio) na **taarifa za mtumiaji** (faili, maelezo, barua pepe...). Kisha, unaweza kutumia ruhusa hizi kufanya vitendo hivyo.

### Application Post Exploitation

Angalia sehemu za Maombi na Huduma Kuu za ukurasa:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## References

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Angalia [**mpango wa usajili**](https://github.com/sponsors/carlospolop)!
* **Jiunge na** üí¨ [**kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **fuata** sisi kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu za hacking kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
{% endhint %}
