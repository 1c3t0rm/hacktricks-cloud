# Az - OAuth Apps Phishing

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos no** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Phishing de Aplicativos OAuth

**Aplica√ß√µes Azure** s√£o configuradas com as permiss√µes que poder√£o usar quando um usu√°rio consente a aplica√ß√£o (como enumerar o diret√≥rio, acessar arquivos ou realizar outras a√ß√µes). Note que a aplica√ß√£o estar√° agindo em nome do usu√°rio, ent√£o mesmo que o app possa estar pedindo permiss√µes de administra√ß√£o, se o **usu√°rio que consente n√£o tiver essa permiss√£o**, o app **n√£o poder√° realizar a√ß√µes administrativas**.

### Permiss√µes de consentimento do app

Por padr√£o, qualquer **usu√°rio pode dar consentimento a apps**, embora isso possa ser configurado para que os usu√°rios s√≥ possam consentir a **apps de editores verificados para permiss√µes selecionadas** ou at√© mesmo **remover a permiss√£o** para que os usu√°rios consintam a aplica√ß√µes.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Se os usu√°rios n√£o puderem consentir, **administradores** como `GA`, `Application Administrator` ou `Cloud Application` `Administrator` podem **consentir as aplica√ß√µes** que os usu√°rios poder√£o usar.

Al√©m disso, se os usu√°rios puderem consentir apenas a apps usando permiss√µes de **baixo risco**, essas permiss√µes s√£o por padr√£o **openid**, **profile**, **email**, **User.Read** e **offline\_access**, embora seja poss√≠vel **adicionar mais** a essa lista.

E se eles puderem consentir a todos os apps, poder√£o consentir a todos os apps.

### 2 Tipos de ataques

* **N√£o autenticado**: De uma conta externa, crie uma aplica√ß√£o com as **permiss√µes de baixo risco** `User.Read` e `User.ReadBasic.All`, por exemplo, phishing de um usu√°rio, e voc√™ poder√° acessar informa√ß√µes do diret√≥rio.
* Isso requer que o usu√°rio phishing esteja **capaz de aceitar apps OAuth de inquilinos externos**.
* Se o usu√°rio phishing for um administrador que pode **consentir qualquer app com quaisquer permiss√µes**, a aplica√ß√£o tamb√©m poder√° **solicitar permiss√µes privilegiadas**.
* **Autenticado**: Tendo comprometido um principal com privil√©gios suficientes, **crie uma aplica√ß√£o dentro da conta** e **phishing** de algum **usu√°rio privilegiado** que pode aceitar permiss√µes OAuth privilegiadas.
* Nesse caso, voc√™ j√° pode acessar as informa√ß√µes do diret√≥rio, ent√£o a permiss√£o `User.ReadBasic.All` n√£o √© mais interessante.
* Voc√™ provavelmente est√° interessado em **permiss√µes que requerem um administrador para conced√™-las**, porque um usu√°rio comum n√£o pode dar permiss√µes a apps OAuth, por isso voc√™ precisa **phishing apenas aqueles usu√°rios** (mais sobre quais fun√ß√µes/permiss√µes concedem esse privil√©gio mais tarde).

### Usu√°rios podem consentir

Note que voc√™ precisa executar este comando de um usu√°rio dentro do inquilino, voc√™ n√£o pode encontrar essa configura√ß√£o de um inquilino externo. O seguinte cli pode ajud√°-lo a entender as permiss√µes dos usu√°rios:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Os usu√°rios podem consentir a todos os aplicativos: Se dentro de **`permissionGrantPoliciesAssigned`** voc√™ encontrar: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy`, ent√£o os usu√°rios podem aceitar todos os aplicativos.
* Os usu√°rios podem consentir a aplicativos de editores verificados ou da sua organiza√ß√£o, mas apenas para permiss√µes que voc√™ selecionar: Se dentro de **`permissionGrantPoliciesAssigned`** voc√™ encontrar: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, ent√£o os usu√°rios podem aceitar todos os aplicativos.
* **Desativar o consentimento do usu√°rio**: Se dentro de **`permissionGrantPoliciesAssigned`** voc√™ encontrar apenas: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` e `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, ent√£o os usu√°rios n√£o podem consentir nada.

√â poss√≠vel encontrar o significado de cada uma das pol√≠ticas comentadas em:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Administradores de Aplicativos**

Verifique os usu√°rios que s√£o considerados administradores de aplicativos (podem aceitar novas aplica√ß√µes):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Vis√£o Geral do Fluxo de Ataque**

O ataque envolve v√°rias etapas direcionadas a uma empresa gen√©rica. Veja como pode se desenrolar:

1. **Registro de Dom√≠nio e Hospedagem de Aplica√ß√£o**: O atacante registra um dom√≠nio que se assemelha a um site confi√°vel, por exemplo, "safedomainlogin.com". Sob este dom√≠nio, um subdom√≠nio √© criado (por exemplo, "companyname.safedomainlogin.com") para hospedar uma aplica√ß√£o projetada para capturar c√≥digos de autoriza√ß√£o e solicitar tokens de acesso.
2. **Registro da Aplica√ß√£o no Azure AD**: O atacante ent√£o registra uma Aplica√ß√£o Multi-Tenant em seu Tenant do Azure AD, nomeando-a ap√≥s a empresa alvo para parecer leg√≠tima. Eles configuram a URL de Redirecionamento da aplica√ß√£o para apontar para o subdom√≠nio que hospeda a aplica√ß√£o maliciosa.
3. **Configura√ß√£o de Permiss√µes**: O atacante configura a aplica√ß√£o com v√°rias permiss√µes de API (por exemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Essas permiss√µes, uma vez concedidas pelo usu√°rio, permitem que o atacante extraia informa√ß√µes sens√≠veis em nome do usu√°rio.
4. **Distribui√ß√£o de Links Maliciosos**: O atacante cria um link contendo o id do cliente da aplica√ß√£o maliciosa e o compartilha com usu√°rios-alvo, enganando-os para conceder consentimento.

## Exemplo de Ataque

1. Registre uma **nova aplica√ß√£o**. Pode ser apenas para o diret√≥rio atual se voc√™ estiver usando um usu√°rio do diret√≥rio atacado ou para qualquer diret√≥rio se este for um ataque externo (como na imagem a seguir).
1. Tamb√©m defina a **URI de redirecionamento** para a URL esperada onde voc√™ deseja receber o c√≥digo para obter tokens (`http://localhost:8000/callback` por padr√£o).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Em seguida, crie um segredo da aplica√ß√£o:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. Selecione permiss√µes de API (por exemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Execute a p√°gina da web (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** que solicita as permiss√µes:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Envie a URL para a v√≠tima**
1. Neste caso `http://localhost:8000`
6. **As v√≠timas** precisam **aceitar o aviso:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Use o **token de acesso para acessar as permiss√µes solicitadas**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Outras Ferramentas

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Confira [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender como configur√°-lo.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## P√≥s-Explora√ß√£o

### Phishing P√≥s-Explora√ß√£o

Dependendo das permiss√µes solicitadas, voc√™ pode ser capaz de **acessar diferentes dados do locat√°rio** (listar usu√°rios, grupos... ou at√© mesmo modificar configura√ß√µes) e **informa√ß√µes do usu√°rio** (arquivos, notas, e-mails...). Ent√£o, voc√™ pode usar essas permiss√µes para realizar essas a√ß√µes.

### P√≥s Explora√ß√£o de Aplica√ß√µes

Verifique as se√ß√µes de Aplica√ß√µes e Principal de Servi√ßo da p√°gina:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## Refer√™ncias

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
