# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure åº”ç”¨ç¨‹åº** é…ç½®äº†ç”¨æˆ·åŒæ„åº”ç”¨ç¨‹åºæ—¶å°†èƒ½å¤Ÿä½¿ç”¨çš„æƒé™ï¼ˆä¾‹å¦‚æšä¸¾ç›®å½•ã€è®¿é—®æ–‡ä»¶æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œï¼‰ã€‚è¯·æ³¨æ„ï¼Œåº”ç”¨ç¨‹åºå°†ä»£è¡¨ç”¨æˆ·è¿›è¡Œæ“ä½œï¼Œå› æ­¤å³ä½¿åº”ç”¨ç¨‹åºå¯èƒ½è¯·æ±‚ç®¡ç†æƒé™ï¼Œå¦‚æœ **åŒæ„çš„ç”¨æˆ·æ²¡æœ‰è¯¥æƒé™**ï¼Œåº”ç”¨ç¨‹åº **å°†æ— æ³•æ‰§è¡Œç®¡ç†æ“ä½œ**ã€‚

### åº”ç”¨ç¨‹åºåŒæ„æƒé™

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»»ä½• **ç”¨æˆ·éƒ½å¯ä»¥ç»™åº”ç”¨ç¨‹åºæä¾›åŒæ„**ï¼Œå°½ç®¡å¯ä»¥é…ç½®ä¸ºç”¨æˆ·åªèƒ½åŒæ„ **æ¥è‡ªç»è¿‡éªŒè¯çš„å‘å¸ƒè€…çš„ç‰¹å®šæƒé™çš„åº”ç”¨ç¨‹åº**ï¼Œç”šè‡³ **ç§»é™¤ç”¨æˆ·åŒæ„åº”ç”¨ç¨‹åºçš„æƒé™**ã€‚

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

å¦‚æœç”¨æˆ·æ— æ³•åŒæ„ï¼Œåƒ `GA`ã€`Application Administrator` æˆ– `Cloud Application` `Administrator` çš„ **ç®¡ç†å‘˜** å¯ä»¥ **åŒæ„ç”¨æˆ·å°†èƒ½å¤Ÿä½¿ç”¨çš„åº”ç”¨ç¨‹åº**ã€‚

æ­¤å¤–ï¼Œå¦‚æœç”¨æˆ·åªèƒ½åŒæ„ä½¿ç”¨ **ä½é£é™©** æƒé™çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›æƒé™é»˜è®¤æ˜¯ **openid**ã€**profile**ã€**email**ã€**User.Read** å’Œ **offline\_access**ï¼Œå°½ç®¡å¯ä»¥ **å‘æ­¤åˆ—è¡¨æ·»åŠ æ›´å¤š**ã€‚

å¦‚æœä»–ä»¬å¯ä»¥åŒæ„æ‰€æœ‰åº”ç”¨ç¨‹åºï¼Œä»–ä»¬å¯ä»¥åŒæ„æ‰€æœ‰åº”ç”¨ç¨‹åºã€‚

### 2 ç§æ”»å‡»ç±»å‹

* **æœªè®¤è¯**ï¼šä»å¤–éƒ¨å¸æˆ·åˆ›å»ºä¸€ä¸ªå…·æœ‰ **ä½é£é™©æƒé™** `User.Read` å’Œ `User.ReadBasic.All` çš„åº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚ï¼Œé’“é±¼ç”¨æˆ·ï¼Œæ‚¨å°†èƒ½å¤Ÿè®¿é—®ç›®å½•ä¿¡æ¯ã€‚
* è¿™è¦æ±‚è¢«é’“é±¼çš„ç”¨æˆ· **èƒ½å¤Ÿæ¥å—æ¥è‡ªå¤–éƒ¨ç§Ÿæˆ·çš„ OAuth åº”ç”¨ç¨‹åº**
* å¦‚æœè¢«é’“é±¼çš„ç”¨æˆ·æ˜¯å¯ä»¥ **åŒæ„ä»»ä½•åº”ç”¨ç¨‹åºçš„ä»»ä½•æƒé™** çš„æŸäº›ç®¡ç†å‘˜ï¼Œåˆ™è¯¥åº”ç”¨ç¨‹åºä¹Ÿå¯ä»¥ **è¯·æ±‚ç‰¹æƒæƒé™**
* **å·²è®¤è¯**ï¼šåœ¨æ‹¥æœ‰è¶³å¤Ÿæƒé™çš„ä¸»ä½“è¢«æ”»é™·åï¼Œ**åœ¨å¸æˆ·å†…åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åº** å¹¶ **é’“é±¼** ä¸€äº› **ç‰¹æƒ** ç”¨æˆ·ï¼Œè¿™äº›ç”¨æˆ·å¯ä»¥æ¥å—ç‰¹æƒ OAuth æƒé™ã€‚
* åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å·²ç»å¯ä»¥è®¿é—®ç›®å½•çš„ä¿¡æ¯ï¼Œå› æ­¤æƒé™ `User.ReadBasic.All` ä¸å†æœ‰è¶£ã€‚
* æ‚¨å¯èƒ½å¯¹ **éœ€è¦ç®¡ç†å‘˜æˆäºˆçš„æƒé™** æ„Ÿå…´è¶£ï¼Œå› ä¸ºæ™®é€šç”¨æˆ·æ— æ³•ç»™ OAuth åº”ç”¨ç¨‹åºä»»ä½•æƒé™ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‚¨éœ€è¦ **ä»…é’“é±¼è¿™äº›ç”¨æˆ·**ï¼ˆç¨åä¼šè¯¦ç»†ä»‹ç»å“ªäº›è§’è‰²/æƒé™æˆäºˆæ­¤ç‰¹æƒï¼‰ã€‚

### ç”¨æˆ·è¢«å…è®¸åŒæ„

è¯·æ³¨æ„ï¼Œæ‚¨éœ€è¦ä»ç§Ÿæˆ·å†…çš„ç”¨æˆ·æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œæ‚¨æ— æ³•ä»å¤–éƒ¨ç§Ÿæˆ·æ‰¾åˆ°æ­¤é…ç½®ã€‚ä»¥ä¸‹ CLI å¯ä»¥å¸®åŠ©æ‚¨äº†è§£ç”¨æˆ·æƒé™ï¼š

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* ç”¨æˆ·å¯ä»¥å¯¹æ‰€æœ‰åº”ç”¨ç¨‹åºè¿›è¡ŒåŒæ„ï¼šå¦‚æœåœ¨ **`permissionGrantPoliciesAssigned`** ä¸­å¯ä»¥æ‰¾åˆ°ï¼š`ManagePermissionGrantsForSelf.microsoft-user-default-legacy`ï¼Œåˆ™ç”¨æˆ·å¯ä»¥æ¥å—æ¯ä¸ªåº”ç”¨ç¨‹åºã€‚
* ç”¨æˆ·å¯ä»¥å¯¹æ¥è‡ªç»è¿‡éªŒè¯çš„å‘å¸ƒè€…æˆ–æ‚¨ç»„ç»‡çš„åº”ç”¨ç¨‹åºè¿›è¡ŒåŒæ„ï¼Œä½†ä»…é™äºæ‚¨é€‰æ‹©çš„æƒé™ï¼šå¦‚æœåœ¨ **`permissionGrantPoliciesAssigned`** ä¸­å¯ä»¥æ‰¾åˆ°ï¼š`ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`ï¼Œåˆ™ç”¨æˆ·å¯ä»¥æ¥å—æ¯ä¸ªåº”ç”¨ç¨‹åºã€‚
* **ç¦ç”¨ç”¨æˆ·åŒæ„**ï¼šå¦‚æœåœ¨ **`permissionGrantPoliciesAssigned`** ä¸­åªèƒ½æ‰¾åˆ°ï¼š`ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` å’Œ `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`ï¼Œåˆ™ç”¨æˆ·æ— æ³•è¿›è¡ŒåŒæ„ã€‚

å¯ä»¥åœ¨ä»¥ä¸‹ä½ç½®æ‰¾åˆ°æ¯ä¸ªæ³¨é‡Šç­–ç•¥çš„å«ä¹‰ï¼š

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **åº”ç”¨ç¨‹åºç®¡ç†å‘˜**

æ£€æŸ¥è¢«è§†ä¸ºåº”ç”¨ç¨‹åºç®¡ç†å‘˜çš„ç”¨æˆ·ï¼ˆå¯ä»¥æ¥å—æ–°åº”ç”¨ç¨‹åºï¼‰ï¼š

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **æ”»å‡»æµç¨‹æ¦‚è¿°**

æ”»å‡»æ¶‰åŠå‡ ä¸ªæ­¥éª¤ï¼Œé’ˆå¯¹ä¸€ä¸ªé€šç”¨å…¬å¸ã€‚ä»¥ä¸‹æ˜¯å¯èƒ½çš„å±•å¼€æ–¹å¼ï¼š

1. **åŸŸåæ³¨å†Œå’Œåº”ç”¨æ‰˜ç®¡**ï¼šæ”»å‡»è€…æ³¨å†Œä¸€ä¸ªç±»ä¼¼äºå¯ä¿¡ç½‘ç«™çš„åŸŸåï¼Œä¾‹å¦‚ "safedomainlogin.com"ã€‚åœ¨è¯¥åŸŸåä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªå­åŸŸåï¼ˆä¾‹å¦‚ "companyname.safedomainlogin.com"ï¼‰æ¥æ‰˜ç®¡ä¸€ä¸ªæ—¨åœ¨æ•è·æˆæƒä»£ç å’Œè¯·æ±‚è®¿é—®ä»¤ç‰Œçš„åº”ç”¨ç¨‹åºã€‚
2. **åœ¨ Azure AD ä¸­æ³¨å†Œåº”ç”¨**ï¼šæ”»å‡»è€…éšååœ¨å…¶ Azure AD ç§Ÿæˆ·ä¸­æ³¨å†Œä¸€ä¸ªå¤šç§Ÿæˆ·åº”ç”¨ï¼Œå‘½åä¸ºç›®æ ‡å…¬å¸çš„åç§°ï¼Œä»¥æ˜¾å¾—åˆæ³•ã€‚ä»–ä»¬å°†åº”ç”¨çš„é‡å®šå‘ URL é…ç½®ä¸ºæŒ‡å‘æ‰˜ç®¡æ¶æ„åº”ç”¨çš„å­åŸŸåã€‚
3. **è®¾ç½®æƒé™**ï¼šæ”»å‡»è€…ä¸ºåº”ç”¨è®¾ç½®å„ç§ API æƒé™ï¼ˆä¾‹å¦‚ `Mail.Read`ã€`Notes.Read.All`ã€`Files.ReadWrite.All`ã€`User.ReadBasic.All`ã€`User.Read`ï¼‰ã€‚ä¸€æ—¦ç”¨æˆ·æˆäºˆè¿™äº›æƒé™ï¼Œæ”»å‡»è€…å°±å¯ä»¥ä»£è¡¨ç”¨æˆ·æå–æ•æ„Ÿä¿¡æ¯ã€‚
4. **åˆ†å‘æ¶æ„é“¾æ¥**ï¼šæ”»å‡»è€…åˆ¶ä½œä¸€ä¸ªåŒ…å«æ¶æ„åº”ç”¨å®¢æˆ·ç«¯ ID çš„é“¾æ¥ï¼Œå¹¶ä¸ç›®æ ‡ç”¨æˆ·åˆ†äº«ï¼Œè¯±ä½¿ä»–ä»¬æˆäºˆæƒé™ã€‚

## ç¤ºä¾‹æ”»å‡»

1. æ³¨å†Œä¸€ä¸ª **æ–°åº”ç”¨**ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯è¢«æ”»å‡»ç›®å½•ä¸­çš„ç”¨æˆ·ï¼Œåˆ™åªèƒ½é’ˆå¯¹å½“å‰ç›®å½•ï¼Œæˆ–è€…å¦‚æœè¿™æ˜¯å¤–éƒ¨æ”»å‡»ï¼Œåˆ™å¯ä»¥é’ˆå¯¹ä»»ä½•ç›®å½•ï¼ˆå¦‚ä»¥ä¸‹å›¾åƒæ‰€ç¤ºï¼‰ã€‚
1. è¿˜è¦å°† **é‡å®šå‘ URI** è®¾ç½®ä¸ºæ‚¨å¸Œæœ›æ¥æ”¶ä»£ç ä»¥è·å–ä»¤ç‰Œçš„é¢„æœŸ URLï¼ˆé»˜è®¤å€¼ä¸º `http://localhost:8000/callback`ï¼‰ã€‚

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. ç„¶ååˆ›å»ºä¸€ä¸ªåº”ç”¨å¯†é’¥ï¼š

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. é€‰æ‹© API æƒé™ï¼ˆä¾‹å¦‚ `Mail.Read`ã€`Notes.Read.All`ã€`Files.ReadWrite.All`ã€`User.ReadBasic.All`ã€`User.Read`ï¼‰

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **æ‰§è¡Œç½‘é¡µ (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)**ï¼Œè¯·æ±‚æƒé™ï¼š

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **å°† URL å‘é€ç»™å—å®³è€…**
1. åœ¨è¿™ç§æƒ…å†µä¸‹ `http://localhost:8000`
6. **å—å®³è€…** éœ€è¦ **æ¥å—æç¤ºï¼š**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. ä½¿ç”¨ **è®¿é—®ä»¤ç‰Œè®¿é—®è¯·æ±‚çš„æƒé™**ï¼š
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## å…¶ä»–å·¥å…·

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** æŸ¥çœ‹ [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) äº†è§£å¦‚ä½•é…ç½®å®ƒã€‚
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## åæœŸåˆ©ç”¨

### é’“é±¼åæœŸåˆ©ç”¨

æ ¹æ®è¯·æ±‚çš„æƒé™ï¼Œæ‚¨å¯èƒ½èƒ½å¤Ÿ**è®¿é—®ç§Ÿæˆ·çš„ä¸åŒæ•°æ®**ï¼ˆåˆ—å‡ºç”¨æˆ·ã€ç»„...æˆ–ç”šè‡³ä¿®æ”¹è®¾ç½®ï¼‰å’Œ**ç”¨æˆ·çš„ä¿¡æ¯**ï¼ˆæ–‡ä»¶ã€ç¬”è®°ã€ç”µå­é‚®ä»¶...ï¼‰ã€‚ç„¶åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›æƒé™æ‰§è¡Œè¿™äº›æ“ä½œã€‚

### åº”ç”¨ç¨‹åºåæœŸåˆ©ç”¨

æŸ¥çœ‹é¡µé¢çš„åº”ç”¨ç¨‹åºå’ŒæœåŠ¡ä¸»ä½“éƒ¨åˆ†ï¼š

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
å­¦ä¹ å’Œå®è·µ AWS é»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ å’Œå®è·µ GCP é»‘å®¢æ”»å‡»ï¼š<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**ç”µæŠ¥ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)** ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
