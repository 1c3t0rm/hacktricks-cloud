# Az - OAuth Apps Phishing

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## OAuth App Phishing

**Azure Applications** рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХреА рдЬрд╛рддреА рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рд╡реЗ рддрдм рдХрд░ рд╕рдХреЗрдВрдЧреА рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рд╕рд╣рдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдирд╛, рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛, рдпрд╛ рдЕрдиреНрдп рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░рдирд╛)ред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдУрд░ рд╕реЗ рд╣реЛрдЧрд╛, рдЗрд╕рд▓рд┐рдП рднрд▓реЗ рд╣реА рдРрдк рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреВрдЫ рд╕рдХрддрд╛ рд╣реИ, рдпрджрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИ**, рддреЛ рдРрдк **рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдХреНрд░рд┐рдпрд╛рдПрдБ рдирд╣реАрдВ рдХрд░ рд╕рдХреЗрдЧрд╛**ред

### App consent permissions

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЛрдИ рднреА **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдРрдкреНрд╕ рдХреЛ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ**, рд╣рд╛рд▓рд╛рдБрдХрд┐ рдЗрд╕реЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ **рдЪрдпрдирд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рддреНрдпрд╛рдкрд┐рдд рдкреНрд░рдХрд╛рд╢рдХреЛрдВ рдХреЗ рдРрдкреНрд╕ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХреЗрдВ** рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ **рдЕрдиреБрдорддрд┐ рдХреЛ рд╣рдЯрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрд░ рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХреЗрдВред

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ **рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ** рдЬреИрд╕реЗ `GA`, `Application Administrator` рдпрд╛ `Cloud Application` `Administrator` рдЙрди **рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд░ рд╕рдХреЗрдВрдЧреЗред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ **рдХрдо рдЬреЛрдЦрд┐рдо** рд╡рд╛рд▓реА рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдРрдкреНрд╕ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **openid**, **profile**, **email**, **User.Read** рдФрд░ **offline\_access** рд╣реИрдВ, рд╣рд╛рд▓рд╛рдБрдХрд┐ рдЗрд╕ рд╕реВрдЪреА рдореЗрдВ **рдЕрдзрд┐рдХ рдЬреЛрдбрд╝рдирд╛** рд╕рдВрднрд╡ рд╣реИред

рдФрд░ рдпрджрд┐ рд╡реЗ рд╕рднреА рдРрдкреНрд╕ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рд╡реЗ рд╕рднреА рдРрдкреНрд╕ рдкрд░ рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВред

### 2 Types of attacks

* **Unauthenticated**: рдПрдХ рдмрд╛рд╣рд░реА рдЦрд╛рддреЗ рд╕реЗ **рдХрдо рдЬреЛрдЦрд┐рдо рд╡рд╛рд▓реА рдЕрдиреБрдорддрд┐рдпреЛрдВ** `User.Read` рдФрд░ `User.ReadBasic.All` рдХреЗ рд╕рд╛рде рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдмрдирд╛рдПрдВ, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдлрд╝рд┐рд╢ рдХрд░реЗрдВ, рдФрд░ рдЖрдк рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВрдЧреЗред
* рдпрд╣ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдлрд╝рд┐рд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдмрд╛рд╣рд░реА рдЯреЗрдиреЗрдЯ рд╕реЗ OAuth рдРрдкреНрд╕ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ**ред
* рдпрджрд┐ рдлрд╝рд┐рд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛрдИ рдРрд╕рд╛ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╣реИ рдЬреЛ **рдХрд┐рд╕реА рднреА рдРрдк рдХреЛ рдХрд┐рд╕реА рднреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ**, рддреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рднреА **рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред
* **Authenticated**: рдкрд░реНрдпрд╛рдкреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, **рдЦрд╛рддреЗ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдмрдирд╛рдПрдВ** рдФрд░ **рдлрд╝рд┐рд╢** рдХрд░реЗрдВ рдХреБрдЫ **рд╡рд┐рд╢рд┐рд╖реНрдЯ** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ OAuth рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░ рдЪреБрдХреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдЕрдиреБрдорддрд┐ `User.ReadBasic.All` рдЕрдм рджрд┐рд▓рдЪрд╕реНрдк рдирд╣реАрдВ рд╣реИред
* рдЖрдк рд╕рдВрднрд╡рддрдГ **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдореЗрдВ рд░реБрдЪрд┐ рд░рдЦрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ**, рдХреНрдпреЛрдВрдХрд┐ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ OAuth рдРрдкреНрд╕ рдХреЛ рдХреЛрдИ рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗ рд╕рдХрддрд╛, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ **рдХреЗрд╡рд▓ рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдлрд╝рд┐рд╢ рдХрд░рдирд╛ рд╣реЛрдЧрд╛** (рдмрд╛рдж рдореЗрдВ рдХрд┐рди рднреВрдорд┐рдХрд╛рдУрдВ/рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╕реЗ рдпрд╣ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдорд┐рд▓рддрд╛ рд╣реИ, рдЗрд╕ рдкрд░ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА)ред

### Users are allowed to consent

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдкрдХреЛ рдпрд╣ рдХрдорд╛рдВрдб рдЯреЗрдиреЗрдЯ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреА рд╣реЛрдЧреА, рдЖрдк рдмрд╛рд╣рд░реА рдЯреЗрдиреЗрдЯ рд╕реЗ рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдирд╣реАрдВ рдвреВрдВрдв рд╕рдХрддреЗред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд CLI рдЖрдкрдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕рдордЭрдиреЗ рдореЗрдВ рдорджрдж рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/authorizationPolicy"
```
{% endcode %}

* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рднреА рдРрдкреНрд╕ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ: рдпрджрд┐ **`permissionGrantPoliciesAssigned`** рдХреЗ рдЕрдВрджрд░ рдЖрдк рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `ManagePermissionGrantsForSelf.microsoft-user-default-legacy` рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рддреНрдпрд╛рдкрд┐рдд рдкреНрд░рдХрд╛рд╢рдХреЛрдВ рдпрд╛ рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рдХреЗ рдРрдкреНрд╕ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдЙрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ рдЖрдк рдЪреБрдирддреЗ рд╣реИрдВ: рдпрджрд┐ **`permissionGrantPoliciesAssigned`** рдХреЗ рдЕрдВрджрд░ рдЖрдк рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рд╣рдорддрд┐ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ**: рдпрджрд┐ **`permissionGrantPoliciesAssigned`** рдХреЗ рдЕрдВрджрд░ рдЖрдк рдХреЗрд╡рд▓ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-chat` рдФрд░ `ManagePermissionGrantsForOwnedResource.microsoft-dynamically-managed-permissions-for-team` рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд┐рд╕реА рднреА рдЪреАрдЬрд╝ рдкрд░ рд╕рд╣рдорддрд┐ рдирд╣реАрдВ рджреЗ рд╕рдХрддреЗред

рдпрд╣рд╛рдВ рдкреНрд░рддреНрдпреЗрдХ рдЯрд┐рдкреНрдкрдгреА рдХреА рдЧрдИ рдиреАрддрд┐ рдХрд╛ рдЕрд░реНрде рдЬрд╛рдирдирд╛ рд╕рдВрднрд╡ рд╣реИ:

{% code overflow="wrap" %}
```bash
az rest --method GET --url "https://graph.microsoft.com/v1.0/policies/permissionGrantPolicies"
```
{% endcode %}

### **рдРрдкреНрд▓рд┐рдХреЗрд╢рди рдкреНрд░рд╢рд╛рд╕рдХ**

рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдРрдкреНрд▓рд┐рдХреЗрд╢рди рдкреНрд░рд╢рд╛рд╕рдХ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ (рдирдП рдРрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ):

{% code overflow="wrap" %}
```bash
# Get list of roles
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles"

# Get Global Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1b2256f9-46c1-4fc2-a125-5b2f51bb43b7/members"

# Get Application Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/1e92c3b7-2363-4826-93a6-7f7a5b53e7f9/members"

# Get Cloud Applications Administrators
az rest --method GET --url "https://graph.microsoft.com/v1.0/directoryRoles/0d601d27-7b9c-476f-8134-8e7cd6744f02/members"
```
{% endcode %}

## **рд╣рдорд▓реЗ рдХрд╛ рдкреНрд░рд╡рд╛рд╣ рдЕрд╡рд▓реЛрдХрди**

рд╣рдорд▓рд╛ рдХрдИ рдЪрд░рдгреЛрдВ рдореЗрдВ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдХрдВрдкрдиреА рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

1. **рдбреЛрдореЗрди рдкрдВрдЬреАрдХрд░рдг рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╣реЛрд╕реНрдЯрд┐рдВрдЧ**: рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдРрд╕рд╛ рдбреЛрдореЗрди рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╕рд╛рдЗрдЯ рдХреЗ рд╕рдорд╛рди рд╣реЛ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, "safedomainlogin.com"ред рдЗрд╕ рдбреЛрдореЗрди рдХреЗ рддрд╣рдд, рдПрдХ рдЙрдкрдбреЛрдореЗрди рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕реЗ, "companyname.safedomainlogin.com") рдЬреЛ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╣реЛрд╕реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЛрдб рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдФрд░ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
2. **Azure AD рдореЗрдВ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрдВрдЬреАрдХрд░рдг**: рдлрд┐рд░ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдиреЗ Azure AD рдЯреЗрдиреЗрдЯ рдореЗрдВ рдПрдХ рдорд▓реНрдЯреА-рдЯреЗрдиреЗрдВрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкрдВрдЬреАрдХреГрдд рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдирд╛рдо рд▓рдХреНрд╖рд┐рдд рдХрдВрдкрдиреА рдХреЗ рдирд╛рдо рдкрд░ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рд╡реИрдз рдкреНрд░рддреАрдд рд╣реЛред рд╡реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ URL рдХреЛ рдЙрд╕ рдЙрдкрдбреЛрдореЗрди рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╣реЛрд╕реНрдЯ рдХрд░рддрд╛ рд╣реИред
3. **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рд╕реЗрдЯрд┐рдВрдЧ**: рд╣рдорд▓рд╛рд╡рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╡рд┐рднрд┐рдиреНрди API рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ (рдЬреИрд╕реЗ, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)ред рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ, рдПрдХ рдмрд╛рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рджреА рдЧрдИ, рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдУрд░ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВред
4. **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд▓рд┐рдВрдХ рд╡рд┐рддрд░рд┐рдд рдХрд░рдирд╛**: рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рд▓рд┐рдВрдХ рддреИрдпрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдЖрдИрдбреА рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рд▓рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рд╕рд╣рдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗрддрд╛ рд╣реИред

## рдЙрджрд╛рд╣рд░рдг рд╣рдорд▓рд╛

1. рдПрдХ **рдирдпрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди** рдкрдВрдЬреАрдХреГрдд рдХрд░реЗрдВред рдпрд╣ рдХреЗрд╡рд▓ рд╡рд░реНрддрдорд╛рди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдпрджрд┐ рдЖрдк рд╣рдорд▓реЗ рдХреА рдЧрдИ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдпрд╛ рдХрд┐рд╕реА рднреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдпрджрд┐ рдпрд╣ рдПрдХ рдмрд╛рд╣рд░реА рд╣рдорд▓рд╛ рд╣реИ (рдЬреИрд╕реЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЫрд╡рд┐ рдореЗрдВ)ред
1. **рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ URI** рдХреЛ рднреА рдЙрд╕ рдЕрдкреЗрдХреНрд╖рд┐рдд URL рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдВ рдЬрд╣рд╛рдБ рдЖрдк рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЛрдб рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ (`http://localhost:8000/callback` рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ)ред

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

2. рдлрд┐рд░ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реАрдХреНрд░реЗрдЯ рдмрдирд╛рдПрдВ:

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

3. API рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЪреБрдиреЗрдВ (рдЬреИрд╕реЗ, `Mail.Read`, `Notes.Read.All`, `Files.ReadWrite.All`, `User.ReadBasic.All`, `User.Read`)

<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

4. **рд╡реЗрдм рдкреГрд╖реНрда рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ (**[**azure\_oauth\_phishing\_example**](https://github.com/carlospolop/azure_oauth_phishing_example)**)** рдЬреЛ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкреВрдЫрддрд╛ рд╣реИ:

{% code overflow="wrap" %}
```bash
# From https://github.com/carlospolop/azure_oauth_phishing_example
python3 azure_oauth_phishing_example.py --client-secret <client-secret> --client-id <client-id> --scopes "email,Files.ReadWrite.All,Mail.Read,Notes.Read.All,offline_access,openid,profile,User.Read"
```
{% endcode %}

5. **рд╢рд┐рдХрд╛рд░ рдХреЛ URL рднреЗрдЬреЗрдВ**
1. рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `http://localhost:8000`
6. **рд╢рд┐рдХрд╛рд░** рдХреЛ **рдкреНрд░реЙрдореНрдкреНрдЯ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛:**

<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

7. **рдЕрдиреБрд░реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ** рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП **рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**:
```bash
export ACCESS_TOKEN=<ACCESS_TOKEN>

# List drive files
curl -X GET \
https://graph.microsoft.com/v1.0/me/drive/root/children \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List eails
curl -X GET \
https://graph.microsoft.com/v1.0/me/messages \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"

# List notes
curl -X GET \
https://graph.microsoft.com/v1.0/me/onenote/notebooks \
-H "Authorization: Bearer $ACCESS_TOKEN" \
-H "Accept: application/json"
```
## рдЕрдиреНрдп рдЙрдкрдХрд░рдг

* [**365-Stealer**](https://github.com/AlteredSecurity/365-Stealer)**:** рдЗрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer) рдкрд░ рдЬрд╛рдПрдВред
* [**O365-Attack-Toolkit**](https://github.com/mdsecactivebreach/o365-attack-toolkit)

## рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

### рдлрд╝рд┐рд╢рд┐рдВрдЧ рдкреЛрд╕реНрдЯ-рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

рдЕрдиреБрд░реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдЖрдк **рдЯреЗрдиреЗрдВрдЯ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ** (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ, рд╕рдореВрд╣реЛрдВ рдХреА рд╕реВрдЪреА... рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛) рдФрд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЬрд╛рдирдХрд╛рд░реА** (рдлрд╛рдЗрд▓реЗрдВ, рдиреЛрдЯреНрд╕, рдИрдореЗрд▓...)ред рдлрд┐рд░, рдЖрдк рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрди рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди

рдкреГрд╖реНрда рдХреЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рд╕реЗрд╡рд╛ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдЕрдиреБрднрд╛рдЧреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

{% content-ref url="../az-privilege-escalation/az-entraid-privesc/" %}
[az-entraid-privesc](../az-privilege-escalation/az-entraid-privesc/)
{% endcontent-ref %}

## рд╕рдВрджрд░реНрдн

* [https://www.alteredsecurity.com/post/introduction-to-365-stealer](https://www.alteredsecurity.com/post/introduction-to-365-stealer)
* [https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/](https://swisskyrepo.github.io/InternalAllTheThings/cloud/azure/azure-phishing/)

{% hint style="success" %}
AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рдФрд░ рдЕрднреНрдпрд╛рд╕ рдХрд░реЗрдВ: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░реЗрдВ</summary>

* [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* **рд╣рдорд╛рд░реЗ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рд╣рдореЗрдВ **рдлреЙрд▓реЛ рдХрд░реЗрдВ** [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдЧрд┐рдЯрд╣рдм рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдореЗрдВ PR рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред

</details>
{% endhint %}
