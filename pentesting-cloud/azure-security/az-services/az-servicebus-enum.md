# Az - Service Bus Enum

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 游눫 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Service Bus

Azure Service Bus es un **servicio de mensajer칤a** basado en la nube dise침ado para permitir una **comunicaci칩n confiable entre diferentes partes de una aplicaci칩n o aplicaciones separadas**. Act칰a como un intermediario seguro, asegurando que los mensajes se entreguen de manera segura, incluso si el remitente y el receptor no est치n operando simult치neamente. Al desacoplar sistemas, permite que las aplicaciones funcionen de manera independiente mientras a칰n intercambian datos o instrucciones. Es particularmente 칰til para escenarios que requieren balanceo de carga entre m칰ltiples trabajadores, entrega confiable de mensajes o coordinaci칩n compleja, como procesar tareas en orden o gestionar el acceso de manera segura.

### Key Concepts

1. **Colas:** su prop칩sito es almacenar mensajes hasta que el receptor est칠 listo.
- Los mensajes est치n ordenados, tienen marca de tiempo y se almacenan de manera duradera.
- Se entregan en modo de extracci칩n (recuperaci칩n bajo demanda).
- Soporta comunicaci칩n punto a punto.
2. **Temas:** Mensajer칤a de publicaci칩n-suscripci칩n para difusi칩n.
- M칰ltiples suscripciones independientes reciben copias de los mensajes.
- Las suscripciones pueden tener reglas/filtros para controlar la entrega o agregar metadatos.
- Soporta comunicaci칩n de muchos a muchos.
3. **Espacios de nombres:** Un contenedor para todos los componentes de mensajer칤a, colas y temas, es como tu propia parte de un poderoso cl칰ster de Azure, proporcionando capacidad dedicada y opcionalmente abarcando tres zonas de disponibilidad.

### Advance Features
Algunas caracter칤sticas avanzadas son:

- **Sesiones de Mensajes**: Asegura el procesamiento FIFO y soporta patrones de solicitud-respuesta.
- **Reenv칤o Autom치tico**: Transfiere mensajes entre colas o temas en el mismo espacio de nombres.
- **Manejo de Mensajes No Entregables**: Captura mensajes no entregables para revisi칩n.
- **Entrega Programada**: Retrasa el procesamiento de mensajes para tareas futuras.
- **Diferimiento de Mensajes**: Pospone la recuperaci칩n de mensajes hasta que est칠 listo.
- **Transacciones**: Agrupa operaciones en ejecuci칩n at칩mica.
- **Filtros y Acciones**: Aplica reglas para filtrar o anotar mensajes.
- **Eliminaci칩n Autom치tica en Inactividad**: Elimina colas despu칠s de inactividad (m칤n: 5 minutos).
- **Detecci칩n de Duplicados**: Elimina mensajes duplicados durante reenv칤os.
- **Eliminaci칩n por Lotes**: Elimina en bloque mensajes expirados o innecesarios.

### Authorization-Rule / SAS Policy

Las pol칤ticas SAS definen los permisos de acceso para las entidades del espacio de nombres de Azure Service Bus (el m치s importante), colas y temas. Cada pol칤tica tiene los siguientes componentes:

- **Permisos**: Casillas de verificaci칩n para especificar niveles de acceso:
- Administrar: Otorga control total sobre la entidad, incluyendo la configuraci칩n y gesti칩n de permisos.
- Enviar: Permite enviar mensajes a la entidad.
- Escuchar: Permite recibir mensajes de la entidad.
- **Claves Primarias y Secundarias**: Estas son claves criptogr치ficas utilizadas para generar tokens seguros para autenticar el acceso.
- **Cadenas de Conexi칩n Primarias y Secundarias**: Cadenas de conexi칩n preconfiguradas que incluyen el punto final y la clave para un uso f치cil en aplicaciones.
- **ID de Pol칤tica SAS ARM**: La ruta del Administrador de Recursos de Azure (ARM) a la pol칤tica para identificaci칩n program치tica.

### NameSpace

sku, regla de autorizaci칩n,

### Enumeration

{% code overflow="wrap" %}
```bash
# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>

# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>
```
{% endcode %}

### Escalaci칩n de Privilegios

{% content-ref url="../az-services/az-servicebus-privesc.md" %}
[az-servicebus-privesc.md](../az-services/az-servicebus-privesc.md)
{% endcontent-ref %}

### Post Explotaci칩n

{% content-ref url="../az-post-exploitation/az-servicebus-post-exploitation.md" %}
[az-servicebus-post-exploitation.md](../az-post-exploitation/az-servicebus-post-exploitation.md)
{% endcontent-ref %}

## Referencias

* https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
