# Az - Service Bus Enum

{% hint style="success" %}
学习与实践 AWS 黑客技术：<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">[**HackTricks 培训 AWS 红队专家 (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../.gitbook/assets/image (1) (1).png" alt="" data-size="line">\
学习与实践 GCP 黑客技术： <img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">[**HackTricks 培训 GCP 红队专家 (GRTE)**<img src="../../.gitbook/assets/image (2).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 分享黑客技巧。

</details>
{% endhint %}

## Service Bus

Azure Service Bus 是一种基于云的 **消息服务**，旨在实现 **应用程序不同部分或独立应用程序之间的可靠通信**。它充当安全的中介，确保消息安全送达，即使发送者和接收者并不同时操作。通过解耦系统，它允许应用程序独立工作，同时仍然交换数据或指令。它特别适用于需要在多个工作者之间进行负载均衡、可靠消息传递或复杂协调的场景，例如按顺序处理任务或安全管理访问。

### 关键概念

1. **队列：** 其目的是存储消息，直到接收者准备好。
- 消息是有序的、带时间戳的，并且持久存储。
- 以拉取模式（按需检索）交付。
- 支持点对点通信。
2. **主题：** 用于广播的发布-订阅消息。
- 多个独立订阅接收消息的副本。
- 订阅可以有规则/过滤器来控制交付或添加元数据。
- 支持多对多通信。
3. **命名空间：** 所有消息组件、队列和主题的容器，就像您自己的一部分强大 Azure 集群，提供专用容量，并可选择跨越三个可用区。

### 高级功能
一些高级功能包括：

- **消息会话**：确保 FIFO 处理并支持请求-响应模式。
- **自动转发**：在同一命名空间内在队列或主题之间转移消息。
- **死信处理**：捕获无法送达的消息以供审查。
- **定时交付**：延迟消息处理以进行未来任务。
- **消息延迟**：推迟消息检索直到准备好。
- **事务**：将操作分组为原子执行。
- **过滤器和操作**：应用规则以过滤或注释消息。
- **空闲时自动删除**：在不活动后删除队列（最小：5分钟）。
- **重复检测**：在重发期间删除重复消息。
- **批量删除**：批量删除过期或不必要的消息。

### 授权规则 / SAS 策略

SAS 策略定义了 Azure Service Bus 实体命名空间（最重要的一个）、队列和主题的访问权限。每个策略具有以下组件：

- **权限**：复选框用于指定访问级别：
- 管理：授予对实体的完全控制，包括配置和权限管理。
- 发送：允许向实体发送消息。
- 监听：允许从实体接收消息。
- **主密钥和次密钥**：这些是用于生成安全令牌以验证访问的加密密钥。
- **主连接字符串和次连接字符串**：预配置的连接字符串，包括端点和密钥，便于在应用程序中使用。
- **SAS 策略 ARM ID**：用于程序识别的策略的 Azure 资源管理器（ARM）路径。

### 命名空间

sku，授权规则，

### 枚举

{% code overflow="wrap" %}
```bash
# Queue Enumeration
az servicebus queue list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyQueue>

# Topic Enumeration
az servicebus topic list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus topic show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyTopic>

# Susbscription Enumeration
az servicebus topic subscription list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus topic subscription show --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic> --name <MySubscription>

# Namespace Enumeration
az servicebus namespace list
az servicebus namespace network-rule-set list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace show --resource-group <MyResourceGroup> --name <MyNamespace>
az servicebus namespace network-rule-set show --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace private-endpoint-connection list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus namespace exists --name ProposedNamespace

# Authorization Rule Enumeration
az servicebus namespace authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace>
az servicebus queue authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --queue-name <MyQueue>
az servicebus topic authorization-rule list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --topic-name <MyTopic>
az servicebus namespace authorization-rule keys list --resource-group <MyResourceGroup> --namespace-name <MyNamespace> --name <MyAuthRule>
```
{% endcode %}

### 权限提升

{% content-ref url="../az-services/az-servicebus-privesc.md" %}
[az-servicebus-privesc.md](../az-services/az-servicebus-privesc.md)
{% endcontent-ref %}

### 利用后

{% content-ref url="../az-post-exploitation/az-servicebus-post-exploitation.md" %}
[az-servicebus-post-exploitation.md](../az-post-exploitation/az-servicebus-post-exploitation.md)
{% endcontent-ref %}

## 参考文献

* https://learn.microsoft.com/en-us/powershell/module/az.servicebus/?view=azps-13.0.0
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-messaging-overview
* https://learn.microsoft.com/en-us/azure/service-bus-messaging/service-bus-quickstart-cli

<details>

<summary>支持 HackTricks</summary>

* 查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来分享黑客技巧。

</details>
{% endhint %}
