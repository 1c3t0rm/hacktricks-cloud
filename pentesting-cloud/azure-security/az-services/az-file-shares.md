# Az - File Shares

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

**Azure Files** je potpuno upravljana usluga skladiÅ¡tenja datoteka u oblaku koja pruÅ¾a deljeno skladiÅ¡tenje datoteka dostupno putem standardnih **SMB (Server Message Block)** i **NFS (Network File System)** protokola. Iako je glavni protokol koji se koristi SMB, NFS Azure deljenja datoteka nisu podrÅ¾ana za Windows (prema [**docs**](https://learn.microsoft.com/en-us/azure/storage/files/files-nfs-protocol)). OmoguÄ‡ava vam da kreirate visoko dostupna mreÅ¾na deljenja datoteka koja mogu biti istovremeno dostupna viÅ¡e virtuelnim maÅ¡inama (VM) ili lokalnim sistemima, omoguÄ‡avajuÄ‡i besprekornu deljenje datoteka izmeÄ‘u okruÅ¾enja.

### Access Tiers

* **Transaction Optimized**: Optimizovano za operacije sa velikim brojem transakcija.
* **Hot**: Izbalansirano izmeÄ‘u transakcija i skladiÅ¡tenja.
* **Cool**: EkonomiÄno za skladiÅ¡tenje.
* **Premium:** SkladiÅ¡tenje datoteka visokih performansi optimizovano za radne optereÄ‡enja sa niskom latencijom i visokim IOPS.

### Backups

* **Daily backup**: TaÄka rezervne kopije se kreira svakog dana u odreÄ‘enom vremenu (npr. 19.30 UTC) i Äuva se od 1 do 200 dana.
* **Weekly backup**: TaÄka rezervne kopije se kreira svake nedelje u odreÄ‘enom danu i vremenu (nedeljom u 19.30) i Äuva se od 1 do 200 nedelja.
* **Monthly backup**: TaÄka rezervne kopije se kreira svakog meseca u odreÄ‘enom danu i vremenu (npr. prva nedelja u mesecu u 19.30) i Äuva se od 1 do 120 meseci.
* **Yearly backup**: TaÄka rezervne kopije se kreira svake godine u odreÄ‘enom danu i vremenu (npr. prva nedelja u januaru u 19.30) i Äuva se od 1 do 10 godina.
* TakoÄ‘e je moguÄ‡e izvrÅ¡iti **ruÄne rezervne kopije i snimke u bilo kojem trenutku**. Rezervne kopije i snimci su zapravo isto u ovom kontekstu.

### Supported Authentications via SMB

* **On-premises AD DS Authentication**: Koristi lokalne Active Directory akreditive sinhronizovane sa Microsoft Entra ID za pristup zasnovan na identitetu. Zahteva mreÅ¾nu povezanost sa lokalnim AD DS.
* **Microsoft Entra Domain Services Authentication**: Koristi Microsoft Entra Domain Services (oblaku zasnovan AD) za pruÅ¾anje pristupa koristeÄ‡i Microsoft Entra akreditive.
* **Microsoft Entra Kerberos for Hybrid Identities**: OmoguÄ‡ava Microsoft Entra korisnicima da autentifikuju Azure deljenja datoteka putem interneta koristeÄ‡i Kerberos. PodrÅ¾ava hibridne Microsoft Entra pridruÅ¾ene ili Microsoft Entra pridruÅ¾ene VM bez potrebe za povezivanjem sa lokalnim kontrolerima domena. Ali ne podrÅ¾ava identitete koji su samo u oblaku.
* **AD Kerberos Authentication for Linux Clients**: OmoguÄ‡ava Linux klijentima da koriste Kerberos za SMB autentifikaciju putem lokalnog AD DS ili Microsoft Entra Domain Services.

## Enumeration

{% code overflow="wrap" %}
```bash
# Get storage accounts
az storage account list #Get the account name from here

# List file shares
az storage share list --account-name <name>
# Get dirs/files inside the share
az storage file list --account-name <name> --share-name <share-name>
## If type is "dir", you can continue enumerating files inside of it
az storage file list --account-name <name> --share-name <prev_dir/share-name>
# Download a complete share (with directories and files inside of them)
az storage file download-batch -d . --source <share-name> --account-name <name>

# Get snapshots/backups
az storage share list --account-name <name> --include-snapshots --query "[?snapshot != null]"
# List contents of a snapshot/backup
az storage file list --account-name <name> --share-name <share-name> --snapshot <snapshot-version> #e.g. "2024-11-25T11:26:59.0000000Z"
# Download snapshot/backup
az storage file download-batch -d . --account-name <name> --source <share-name> --snapshot <snapshot-version>
```
{% endcode %}

{% hint style="info" %}
Podrazumevano `az` cli Ä‡e koristiti kljuÄ naloga za potpisivanje kljuÄa i izvrÅ¡avanje akcije. Da biste koristili privilegije Entra ID glavnog korisnika, koristite parametre `--auth-mode login --enable-file-backup-request-intent`.
{% endhint %}

{% hint style="success" %}
Koristite parametar `--account-key` da naznaÄite kljuÄ naloga koji Ä‡e se koristiti\
Koristite parametar `--sas-token` sa SAS tokenom za pristup putem SAS tokena
{% endhint %}

### Povezivanje

Ovo su skripte koje je predloÅ¾io Azure u vreme pisanja za povezivanje sa File Share:

Morate zameniti `<STORAGE-ACCOUNT>`, `<ACCESS-KEY>` i `<FILE-SHARE-NAME>` mesta za umetanje.

{% tabs %}
{% tab title="Windows" %}
{% code overflow="wrap" %}
```powershell
$connectTestResult = Test-NetConnection -ComputerName filescontainersrdtfgvhb.file.core.windows.net -Port 445
if ($connectTestResult.TcpTestSucceeded) {
# Save the password so the drive will persist on reboot
cmd.exe /C "cmdkey /add:`"<STORAGE-ACCOUNT>.file.core.windows.net`" /user:`"localhost\<STORAGE-ACCOUNT>`" /pass:`"<ACCESS-KEY>`""
# Mount the drive
New-PSDrive -Name Z -PSProvider FileSystem -Root "\\<STORAGE-ACCOUNT>.file.core.windows.net\<FILE-SHARE-NAME>" -Persist
} else {
Write-Error -Message "Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port."
}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
{% code overflow="wrap" %}
```bash
sudo mkdir /mnt/disk-shareeifrube
if [ ! -d "/etc/smbcredentials" ]; then
sudo mkdir /etc/smbcredentials
fi
if [ ! -f "/etc/smbcredentials/<STORAGE-ACCOUNT>.cred" ]; then
sudo bash -c 'echo "username=<STORAGE-ACCOUNT>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
sudo bash -c 'echo "password=<ACCESS-KEY>" >> /etc/smbcredentials/<STORAGE-ACCOUNT>.cred'
fi
sudo chmod 600 /etc/smbcredentials/<STORAGE-ACCOUNT>.cred

sudo bash -c 'echo "//<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> cifs nofail,credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30" >> /etc/fstab'
sudo mount -t cifs //<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME> /mnt/<FILE-SHARE-NAME> -o credentials=/etc/smbcredentials/<STORAGE-ACCOUNT>.cred,dir_mode=0777,file_mode=0777,serverino,nosharesock,actimeo=30
```
{% endcode %}
{% endtab %}

{% tab title="macOS" %}
{% code overflow="wrap" %}
```bash
open smb://<STORAGE-ACCOUNT>:<ACCESS-KEY>@<STORAGE-ACCOUNT>.file.core.windows.net/<FILE-SHARE-NAME>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Redovna enumeracija skladiÅ¡ta (pristupni kljuÄevi, SAS...)

{% content-ref url="az-storage.md" %}
[az-storage.md](az-storage.md)
{% endcontent-ref %}

## Eskalacija privilegija

Isto kao skladiÅ¡na eskalacija privilegija:

{% content-ref url="../az-privilege-escalation/az-storage-privesc.md" %}
[az-storage-privesc.md](../az-privilege-escalation/az-storage-privesc.md)
{% endcontent-ref %}

## Post eksploatacija

{% content-ref url="../az-post-exploitation/az-file-share-post-exploitation.md" %}
[az-file-share-post-exploitation.md](../az-post-exploitation/az-file-share-post-exploitation.md)
{% endcontent-ref %}

## Postojanost

Isto kao skladiÅ¡na postojanost:

{% content-ref url="../az-persistence/az-storage-persistence.md" %}
[az-storage-persistence.md](../az-persistence/az-storage-persistence.md)
{% endcontent-ref %}

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
