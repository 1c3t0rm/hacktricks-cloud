# Az - Azure Network

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **å…³æ³¨** æˆ‘ä»¬çš„ **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}

## åŸºæœ¬ä¿¡æ¯

Azure æä¾› **è™šæ‹Ÿç½‘ç»œ (VNet)**ï¼Œå…è®¸ç”¨æˆ·åœ¨ Azure äº‘ä¸­åˆ›å»º **éš”ç¦»çš„** **ç½‘ç»œ**ã€‚åœ¨è¿™äº› VNet ä¸­ï¼Œå¯ä»¥å®‰å…¨åœ°æ‰˜ç®¡å’Œç®¡ç†è™šæ‹Ÿæœºã€åº”ç”¨ç¨‹åºã€æ•°æ®åº“ç­‰èµ„æºã€‚Azure ä¸­çš„ç½‘ç»œæ”¯æŒäº‘å†…é€šä¿¡ï¼ˆåœ¨ Azure æœåŠ¡ä¹‹é—´ï¼‰ä»¥åŠä¸å¤–éƒ¨ç½‘ç»œå’Œäº’è”ç½‘çš„è¿æ¥ã€‚\
æ­¤å¤–ï¼Œå¯ä»¥ **è¿æ¥** VNet ä¸å…¶ä»– VNet ä»¥åŠæœ¬åœ°ç½‘ç»œã€‚

## è™šæ‹Ÿç½‘ç»œ (VNET) å’Œå­ç½‘

Azure è™šæ‹Ÿç½‘ç»œ (VNet) æ˜¯æ‚¨åœ¨äº‘ä¸­è‡ªå·±ç½‘ç»œçš„è¡¨ç¤ºï¼Œæä¾›åœ¨ Azure ç¯å¢ƒä¸­ä¸“é—¨ä¸ºæ‚¨çš„è®¢é˜…è€Œè®¾çš„ **é€»è¾‘éš”ç¦»**ã€‚VNet å…è®¸æ‚¨åœ¨ Azure ä¸­é…ç½®å’Œç®¡ç†è™šæ‹Ÿä¸“ç”¨ç½‘ç»œ (VPN)ï¼Œæ‰˜ç®¡è™šæ‹Ÿæœº (VM)ã€æ•°æ®åº“å’Œåº”ç”¨æœåŠ¡ç­‰èµ„æºã€‚å®ƒä»¬æä¾› **å¯¹ç½‘ç»œè®¾ç½®çš„å®Œå…¨æ§åˆ¶**ï¼ŒåŒ…æ‹¬ IP åœ°å€èŒƒå›´ã€å­ç½‘åˆ›å»ºã€è·¯ç”±è¡¨å’Œç½‘ç»œç½‘å…³ã€‚

**å­ç½‘** æ˜¯ VNet å†…çš„ç»†åˆ†ï¼Œç”±ç‰¹å®šçš„ **IP åœ°å€èŒƒå›´** å®šä¹‰ã€‚é€šè¿‡å°† VNet åˆ’åˆ†ä¸ºå¤šä¸ªå­ç½‘ï¼Œæ‚¨å¯ä»¥æ ¹æ®ç½‘ç»œæ¶æ„ç»„ç»‡å’Œä¿æŠ¤èµ„æºã€‚\
é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ Azure è™šæ‹Ÿç½‘ç»œ (VNet) å†…çš„æ‰€æœ‰å­ç½‘ **å¯ä»¥ç›¸äº’é€šä¿¡**ï¼Œæ²¡æœ‰ä»»ä½•é™åˆ¶ã€‚

**ç¤ºä¾‹ï¼š**

* `MyVNet` çš„ IP åœ°å€èŒƒå›´ä¸º 10.0.0.0/16ã€‚
* **å­ç½‘-1ï¼š** 10.0.0.0/24 ç”¨äº Web æœåŠ¡å™¨ã€‚
* **å­ç½‘-2ï¼š** 10.0.1.0/24 ç”¨äºæ•°æ®åº“æœåŠ¡å™¨ã€‚

### æšä¸¾

è¦åˆ—å‡º Azure è´¦æˆ·ä¸­çš„æ‰€æœ‰ VNet å’Œå­ç½‘ï¼Œå¯ä»¥ä½¿ç”¨ Azure å‘½ä»¤è¡Œç•Œé¢ (CLI)ã€‚ä»¥ä¸‹æ˜¯æ­¥éª¤ï¼š

{% code overflow="wrap" %}
```bash
# List VNets
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}"

# List subnets of a VNet
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, addressPrefix:addressPrefix}" -o table
```
{% endcode %}

## ç½‘ç»œå®‰å…¨ç»„ (NSG)

ä¸€ä¸ª **ç½‘ç»œå®‰å…¨ç»„ (NSG)** è¿‡æ»¤ Azure è™šæ‹Ÿç½‘ç»œ (VNet) å†… Azure èµ„æºçš„ç½‘ç»œæµé‡ã€‚å®ƒåŒ…å«ä¸€ç»„ **å®‰å…¨è§„åˆ™**ï¼Œå¯ä»¥æŒ‡ç¤º **å“ªäº›ç«¯å£å¯ä»¥ç”¨äºå…¥ç«™å’Œå‡ºç«™æµé‡**ï¼Œé€šè¿‡æºç«¯å£ã€æº IPã€ç«¯å£ç›®æ ‡ï¼Œå¹¶ä¸”å¯ä»¥åˆ†é…ä¼˜å…ˆçº§ï¼ˆä¼˜å…ˆçº§æ•°å­—è¶Šä½ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼‰ã€‚

NSG å¯ä»¥ä¸ **å­ç½‘å’Œ NIC å…³è”ã€‚**

**è§„åˆ™ç¤ºä¾‹ï¼š**

* ä¸€ä¸ªå…¥ç«™è§„åˆ™ï¼Œå…è®¸æ¥è‡ªä»»ä½•æºçš„ HTTP æµé‡ï¼ˆç«¯å£ 80ï¼‰åˆ°æ‚¨çš„ Web æœåŠ¡å™¨ã€‚
* ä¸€ä¸ªå‡ºç«™è§„åˆ™ï¼Œä»…å…è®¸ SQL æµé‡ï¼ˆç«¯å£ 1433ï¼‰åˆ°ç‰¹å®šçš„ç›®æ ‡ IP åœ°å€èŒƒå›´ã€‚

### æšä¸¾

{% code overflow="wrap" %}
```bash
# List NSGs
az network nsg list --query "[].{name:name, location:location}" -o table
az network nsg show --name <nsg-name>

# Get NSG rules
az network nsg rule list --nsg-name <NSGName> --resource-group <ResourceGroupName> --query "[].{name:name, priority:priority, direction:direction, access:access, protocol:protocol, sourceAddressPrefix:sourceAddressPrefix, destinationAddressPrefix:destinationAddressPrefix, sourcePortRange:sourcePortRange, destinationPortRange:destinationPortRange}" -o table

# Get NICs and subnets using this NSG
az network nsg show --name MyLowCostVM-nsg --resource-group Resource_Group_1 --query "{subnets: subnets, networkInterfaces: networkInterfaces}"
```
{% endcode %}

## Azure Firewall

Azure Firewall æ˜¯ Azure ä¸­çš„ä¸€ä¸ª **æ‰˜ç®¡ç½‘ç»œå®‰å…¨æœåŠ¡**ï¼Œé€šè¿‡æ£€æŸ¥å’Œæ§åˆ¶æµé‡æ¥ä¿æŠ¤äº‘èµ„æºã€‚å®ƒæ˜¯ä¸€ä¸ª **æœ‰çŠ¶æ€é˜²ç«å¢™**ï¼Œæ ¹æ®ç¬¬ 3 å±‚åˆ°ç¬¬ 7 å±‚çš„è§„åˆ™è¿‡æ»¤æµé‡ï¼Œæ”¯æŒ **åœ¨ Azure å†…éƒ¨**ï¼ˆä¸œè¥¿å‘æµé‡ï¼‰å’Œ **ä¸å¤–éƒ¨ç½‘ç»œä¹‹é—´**ï¼ˆå—åŒ—å‘æµé‡ï¼‰çš„é€šä¿¡ã€‚éƒ¨ç½²åœ¨ **è™šæ‹Ÿç½‘ç»œï¼ˆVNetï¼‰çº§åˆ«**ï¼Œä¸º VNet ä¸­çš„æ‰€æœ‰å­ç½‘æä¾›é›†ä¸­ä¿æŠ¤ã€‚Azure Firewall è‡ªåŠ¨æ‰©å±•ä»¥åº”å¯¹æµé‡éœ€æ±‚ï¼Œå¹¶ç¡®ä¿é«˜å¯ç”¨æ€§ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®ã€‚

å®ƒæä¾›ä¸‰ç§ SKUâ€”â€”**åŸºæœ¬ç‰ˆ**ã€**æ ‡å‡†ç‰ˆ**å’Œ **é«˜çº§ç‰ˆ**ï¼Œæ¯ç§ç‰ˆæœ¬éƒ½é’ˆå¯¹ç‰¹å®šå®¢æˆ·éœ€æ±‚é‡èº«å®šåˆ¶ï¼š

| **æ¨èä½¿ç”¨æ¡ˆä¾‹**             | éœ€æ±‚æœ‰é™çš„å°å‹/ä¸­å‹ä¼ä¸š (SMBs) | ä¸€èˆ¬ä¼ä¸šä½¿ç”¨ï¼Œç¬¬ 3 å±‚â€“ç¬¬ 7 å±‚è¿‡æ»¤ | é«˜åº¦æ•æ„Ÿçš„ç¯å¢ƒï¼ˆä¾‹å¦‚ï¼Œæ”¯ä»˜å¤„ç†ï¼‰  |
| ---------------------------- | ------------------------------ | --------------------------------- | --------------------------------- |
| **æ€§èƒ½**                    | é«˜è¾¾ 250 Mbps ååé‡         | é«˜è¾¾ 30 Gbps ååé‡               | é«˜è¾¾ 100 Gbps ååé‡              |
| **å¨èƒæƒ…æŠ¥**                | ä»…è­¦æŠ¥                       | è­¦æŠ¥å’Œé˜»æ­¢ï¼ˆæ¶æ„ IP/åŸŸåï¼‰       | è­¦æŠ¥å’Œé˜»æ­¢ï¼ˆé«˜çº§å¨èƒæƒ…æŠ¥ï¼‰       |
| **L3â€“L7 è¿‡æ»¤**              | åŸºæœ¬è¿‡æ»¤                     | è·¨åè®®çš„æœ‰çŠ¶æ€è¿‡æ»¤               | å…·æœ‰é«˜çº§æ£€æŸ¥çš„æœ‰çŠ¶æ€è¿‡æ»¤         |
| **é«˜çº§å¨èƒä¿æŠ¤**            | ä¸å¯ç”¨                       | åŸºäºå¨èƒæƒ…æŠ¥çš„è¿‡æ»¤               | åŒ…æ‹¬å…¥ä¾µæ£€æµ‹å’Œé˜²å¾¡ç³»ç»Ÿ (IDPS)    |
| **TLS æ£€æŸ¥**                | ä¸å¯ç”¨                       | ä¸å¯ç”¨                           | æ”¯æŒå…¥ç«™/å‡ºç«™ TLS ç»ˆæ­¢           |
| **å¯ç”¨æ€§**                  | å›ºå®šåç«¯ï¼ˆ2 ä¸ªè™šæ‹Ÿæœºï¼‰       | è‡ªåŠ¨æ‰©å±•                         | è‡ªåŠ¨æ‰©å±•                         |
| **ç®¡ç†ç®€æ˜“æ€§**              | åŸºæœ¬æ§åˆ¶                     | é€šè¿‡é˜²ç«å¢™ç®¡ç†å™¨ç®¡ç†             | é€šè¿‡é˜²ç«å¢™ç®¡ç†å™¨ç®¡ç†             |

### Enumeration

{% code overflow="wrap" %}
```bash
# List Azure Firewalls
az network firewall list --query "[].{name:name, location:location, subnet:subnet, publicIp:publicIp}" -o table

# Get network rules of a firewall
az network firewall network-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get application rules of a firewall
az network firewall application-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table

# Get nat rules of a firewall
az network firewall nat-rule collection list --firewall-name <FirewallName> --resource-group <ResourceGroupName> --query "[].{name:name, rules:rules}" -o table
```
{% endcode %}

## Azure è·¯ç”±è¡¨

Azure **è·¯ç”±è¡¨** ç”¨äºæ§åˆ¶å­ç½‘å†…ç½‘ç»œæµé‡çš„è·¯ç”±ã€‚å®ƒä»¬å®šä¹‰äº†è§„åˆ™ï¼ŒæŒ‡å®šæ•°æ®åŒ…åº”å¦‚ä½•è½¬å‘ï¼Œè½¬å‘ç›®æ ‡å¯ä»¥æ˜¯ Azure èµ„æºã€äº’è”ç½‘æˆ–ç‰¹å®šçš„ä¸‹ä¸€è·³ï¼Œå¦‚è™šæ‹Ÿè®¾å¤‡æˆ– Azure é˜²ç«å¢™ã€‚æ‚¨å¯ä»¥å°†è·¯ç”±è¡¨ä¸ **å­ç½‘** å…³è”ï¼Œæ‰€æœ‰åœ¨è¯¥å­ç½‘å†…çš„èµ„æºå°†éµå¾ªè¡¨ä¸­çš„è·¯ç”±ã€‚

**ç¤ºä¾‹ï¼š** å¦‚æœä¸€ä¸ªå­ç½‘æ‰˜ç®¡éœ€è¦é€šè¿‡ç½‘ç»œè™šæ‹Ÿè®¾å¤‡ (NVA) è¿›è¡Œæ£€æŸ¥çš„å‡ºç«™æµé‡çš„èµ„æºï¼Œæ‚¨å¯ä»¥åœ¨è·¯ç”±è¡¨ä¸­åˆ›å»ºä¸€ä¸ª **è·¯ç”±**ï¼Œå°†æ‰€æœ‰æµé‡ï¼ˆä¾‹å¦‚ï¼Œ`0.0.0.0/0`ï¼‰é‡å®šå‘åˆ° NVA çš„ç§æœ‰ IP åœ°å€ä½œä¸ºä¸‹ä¸€è·³ã€‚

### **æšä¸¾**

{% code overflow="wrap" %}
```bash
# List Route Tables
az network route-table list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List routes for a table
az network route-table route list --route-table-name <RouteTableName> --resource-group <ResourceGroupName> --query "[].{name:name, addressPrefix:addressPrefix, nextHopType:nextHopType, nextHopIpAddress:nextHopIpAddress}" -o table
```
{% endcode %}

## Azure Private Link

Azure Private Link æ˜¯ Azure ä¸­çš„ä¸€é¡¹æœåŠ¡ï¼Œ**é€šè¿‡ç¡®ä¿æ‚¨çš„ Azure è™šæ‹Ÿç½‘ç»œ (VNet) ä¸æœåŠ¡ä¹‹é—´çš„æµé‡å®Œå…¨åœ¨ Microsoft çš„ Azure ä¸»å¹²ç½‘ç»œå†…ä¼ è¾“ï¼Œä»è€Œå®ç°å¯¹ Azure æœåŠ¡çš„ç§æœ‰è®¿é—®**ã€‚å®ƒæœ‰æ•ˆåœ°å°†æœåŠ¡å¼•å…¥æ‚¨çš„ VNetã€‚æ­¤è®¾ç½®é€šè¿‡ä¸å°†æ•°æ®æš´éœ²äºå…¬å…±äº’è”ç½‘æ¥å¢å¼ºå®‰å…¨æ€§ã€‚

Private Link å¯ä»¥ä¸å„ç§ Azure æœåŠ¡ä¸€èµ·ä½¿ç”¨ï¼Œå¦‚ Azure Storageã€Azure SQL Database å’Œé€šè¿‡ Private Link å…±äº«çš„è‡ªå®šä¹‰æœåŠ¡ã€‚å®ƒæä¾›äº†ä¸€ç§å®‰å…¨çš„æ–¹å¼ï¼Œä»æ‚¨è‡ªå·±çš„ VNet æˆ–ç”šè‡³ä¸åŒçš„ Azure è®¢é˜…ä¸­ä½¿ç”¨æœåŠ¡ã€‚

{% hint style="danger" %}
NSG ä¸é€‚ç”¨äºç§æœ‰ç«¯ç‚¹ï¼Œè¿™æ¸…æ¥šåœ°æ„å‘³ç€å°† NSG ä¸åŒ…å« Private Link çš„å­ç½‘å…³è”å°†æ²¡æœ‰æ•ˆæœã€‚
{% endhint %}

**ç¤ºä¾‹ï¼š**

è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæ‚¨æœ‰ä¸€ä¸ª **å¸Œæœ›ä»æ‚¨çš„ VNet å®‰å…¨è®¿é—®çš„ Azure SQL Database**ã€‚é€šå¸¸ï¼Œè¿™å¯èƒ½æ¶‰åŠç©¿è¶Šå…¬å…±äº’è”ç½‘ã€‚é€šè¿‡ Private Linkï¼Œæ‚¨å¯ä»¥åœ¨æ‚¨çš„ VNet ä¸­åˆ›å»ºä¸€ä¸ª **ç§æœ‰ç«¯ç‚¹**ï¼Œç›´æ¥è¿æ¥åˆ° Azure SQL Database æœåŠ¡ã€‚æ­¤ç«¯ç‚¹ä½¿æ•°æ®åº“çœ‹èµ·æ¥åƒæ˜¯æ‚¨è‡ªå·± VNet çš„ä¸€éƒ¨åˆ†ï¼Œå¯ä»¥é€šè¿‡ç§æœ‰ IP åœ°å€è®¿é—®ï¼Œä»è€Œç¡®ä¿å®‰å…¨å’Œç§å¯†çš„è®¿é—®ã€‚

### **Enumeration**

{% code overflow="wrap" %}
```bash
# List Private Link Services
az network private-link-service list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List Private Endpoints
az network private-endpoint list --query "[].{name:name, location:location, resourceGroup:resourceGroup, privateLinkServiceConnections:privateLinkServiceConnections}" -o table
```
{% endcode %}

## Azure æœåŠ¡ç«¯ç‚¹

Azure æœåŠ¡ç«¯ç‚¹æ‰©å±•äº†æ‚¨çš„è™šæ‹Ÿç½‘ç»œç§æœ‰åœ°å€ç©ºé—´å’Œ VNet çš„èº«ä»½ï¼Œé€šè¿‡ç›´æ¥è¿æ¥åˆ° Azure æœåŠ¡ã€‚é€šè¿‡å¯ç”¨æœåŠ¡ç«¯ç‚¹ï¼Œ**æ‚¨ VNet ä¸­çš„èµ„æºå¯ä»¥å®‰å…¨åœ°è¿æ¥åˆ° Azure æœåŠ¡**ï¼Œå¦‚ Azure å­˜å‚¨å’Œ Azure SQL æ•°æ®åº“ï¼Œä½¿ç”¨ Azure çš„éª¨å¹²ç½‘ç»œã€‚è¿™ç¡®ä¿äº†**ä» VNet åˆ° Azure æœåŠ¡çš„æµé‡ä¿æŒåœ¨ Azure ç½‘ç»œå†…**ï¼Œæä¾›äº†æ›´å®‰å…¨å’Œå¯é çš„è·¯å¾„ã€‚

**ç¤ºä¾‹ï¼š**

ä¾‹å¦‚ï¼Œ**Azure å­˜å‚¨**å¸æˆ·é»˜è®¤å¯ä»¥é€šè¿‡å…¬å…±äº’è”ç½‘è®¿é—®ã€‚é€šè¿‡åœ¨æ‚¨çš„ VNet å†…å¯ç”¨**Azure å­˜å‚¨çš„æœåŠ¡ç«¯ç‚¹**ï¼Œæ‚¨å¯ä»¥ç¡®ä¿åªæœ‰æ¥è‡ªæ‚¨ VNet çš„æµé‡å¯ä»¥è®¿é—®å­˜å‚¨å¸æˆ·ã€‚ç„¶åå¯ä»¥é…ç½®å­˜å‚¨å¸æˆ·é˜²ç«å¢™ï¼Œä»…æ¥å—æ¥è‡ªæ‚¨ VNet çš„æµé‡ã€‚

### **æšä¸¾**

{% code overflow="wrap" %}
```bash
# List Virtual Networks with Service Endpoints
az network vnet list --query "[].{name:name, location:location, serviceEndpoints:serviceEndpoints}" -o table

# List Subnets with Service Endpoints
az network vnet subnet list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, serviceEndpoints:serviceEndpoints}" -o table
```
{% endcode %}

### æœåŠ¡ç«¯ç‚¹ä¸ç§æœ‰é“¾æ¥ä¹‹é—´çš„åŒºåˆ«

Microsoft åœ¨ [**docs**](https://learn.microsoft.com/en-us/azure/virtual-network/vnet-integration-for-azure-services#compare-private-endpoints-and-service-endpoints) ä¸­å»ºè®®ä½¿ç”¨ç§æœ‰é“¾æ¥ï¼š

<figure><img src="../../../../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

**æœåŠ¡ç«¯ç‚¹ï¼š**

* ä»æ‚¨çš„ VNet åˆ° Azure æœåŠ¡çš„æµé‡é€šè¿‡ Microsoft Azure éª¨å¹²ç½‘ç»œä¼ è¾“ï¼Œç»•è¿‡å…¬å…±äº’è”ç½‘ã€‚
* è¯¥ç«¯ç‚¹æ˜¯ä¸ Azure æœåŠ¡çš„ç›´æ¥è¿æ¥ï¼Œå¹¶æœªä¸º VNet å†…çš„æœåŠ¡æä¾›ç§æœ‰ IPã€‚
* é™¤éæ‚¨é…ç½®æœåŠ¡é˜²ç«å¢™ä»¥é˜»æ­¢æ­¤ç±»æµé‡ï¼Œå¦åˆ™æœåŠ¡æœ¬èº«ä»å¯é€šè¿‡å…¶å…¬å…±ç«¯ç‚¹ä» VNet å¤–éƒ¨è®¿é—®ã€‚
* å­ç½‘ä¸ Azure æœåŠ¡ä¹‹é—´æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚
* æ¯”ç§æœ‰é“¾æ¥ä¾¿å®œã€‚

**ç§æœ‰é“¾æ¥ï¼š**

* ç§æœ‰é“¾æ¥é€šè¿‡ç§æœ‰ç«¯ç‚¹å°† Azure æœåŠ¡æ˜ å°„åˆ°æ‚¨çš„ VNetï¼Œè¯¥ç§æœ‰ç«¯ç‚¹æ˜¯æ‚¨ VNet å†…å…·æœ‰ç§æœ‰ IP åœ°å€çš„ç½‘ç»œæ¥å£ã€‚
* ä½¿ç”¨æ­¤ç§æœ‰ IP åœ°å€è®¿é—® Azure æœåŠ¡ï¼Œä½¿å…¶çœ‹èµ·æ¥åƒæ˜¯æ‚¨ç½‘ç»œçš„ä¸€éƒ¨åˆ†ã€‚
* é€šè¿‡ç§æœ‰é“¾æ¥è¿æ¥çš„æœåŠ¡åªèƒ½ä»æ‚¨çš„ VNet æˆ–è¿æ¥çš„ç½‘ç»œè®¿é—®ï¼›æ²¡æœ‰å…¬å…±äº’è”ç½‘è®¿é—®è¯¥æœåŠ¡ã€‚
* å®ƒä¸º Azure æœåŠ¡æˆ–æ‚¨åœ¨ Azure ä¸­æ‰˜ç®¡çš„è‡ªæœ‰æœåŠ¡æä¾›å®‰å…¨è¿æ¥ï¼Œä»¥åŠä¸ä»–äººå…±äº«çš„æœåŠ¡çš„è¿æ¥ã€‚
* å®ƒé€šè¿‡æ‚¨ VNet ä¸­çš„ç§æœ‰ç«¯ç‚¹æä¾›æ›´ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼Œè€Œä¸æ˜¯é€šè¿‡æœåŠ¡ç«¯ç‚¹åœ¨å­ç½‘çº§åˆ«æä¾›æ›´å¹¿æ³›çš„è®¿é—®æ§åˆ¶ã€‚

æ€»ä¹‹ï¼Œè™½ç„¶æœåŠ¡ç«¯ç‚¹å’Œç§æœ‰é“¾æ¥éƒ½æä¾›å®‰å…¨çš„ Azure æœåŠ¡è¿æ¥ï¼Œ**ç§æœ‰é“¾æ¥é€šè¿‡ç¡®ä¿æœåŠ¡ä»¥ç§å¯†æ–¹å¼è®¿é—®è€Œä¸æš´éœ²äºå…¬å…±äº’è”ç½‘ï¼Œæä¾›äº†æ›´é«˜æ°´å¹³çš„éš”ç¦»å’Œå®‰å…¨æ€§**ã€‚å¦ä¸€æ–¹é¢ï¼ŒæœåŠ¡ç«¯ç‚¹åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ›´æ˜“äºè®¾ç½®ï¼Œé€‚ç”¨äºéœ€è¦ç®€å•ã€å®‰å…¨è®¿é—® Azure æœåŠ¡è€Œä¸éœ€è¦ VNet ä¸­çš„ç§æœ‰ IP çš„åœºæ™¯ã€‚

## Azure Front Door (AFD) å’Œ AFD WAF

**Azure Front Door** æ˜¯ä¸€ä¸ªå¯æ‰©å±•ä¸”å®‰å…¨çš„å…¥å£ç‚¹ï¼Œç”¨äº **å¿«é€Ÿäº¤ä»˜** æ‚¨çš„å…¨çƒ web åº”ç”¨ç¨‹åºã€‚å®ƒ **ç»“åˆ** äº†å…¨çƒ **è´Ÿè½½å‡è¡¡ã€ç«™ç‚¹åŠ é€Ÿã€SSL å¸è½½å’Œ Web åº”ç”¨é˜²ç«å¢™ (WAF)** åŠŸèƒ½äºä¸€ä½“ã€‚Azure Front Door æä¾›åŸºäº **ç¦»ç”¨æˆ·æœ€è¿‘çš„è¾¹ç¼˜ä½ç½®** çš„æ™ºèƒ½è·¯ç”±ï¼Œç¡®ä¿æœ€ä½³æ€§èƒ½å’Œå¯é æ€§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜æä¾›åŸºäº URL çš„è·¯ç”±ã€å¤šç«™ç‚¹æ‰˜ç®¡ã€ä¼šè¯äº²å’Œæ€§å’Œåº”ç”¨å±‚å®‰å…¨æ€§ã€‚

**Azure Front Door WAF** æ—¨åœ¨ **ä¿æŠ¤ web åº”ç”¨ç¨‹åºå…å—åŸºäº web çš„æ”»å‡»**ï¼Œæ— éœ€ä¿®æ”¹åç«¯ä»£ç ã€‚å®ƒåŒ…æ‹¬è‡ªå®šä¹‰è§„åˆ™å’Œç®¡ç†è§„åˆ™é›†ï¼Œä»¥é˜²èŒƒ SQL æ³¨å…¥ã€è·¨ç«™è„šæœ¬å’Œå…¶ä»–å¸¸è§æ”»å‡»ç­‰å¨èƒã€‚

**ç¤ºä¾‹ï¼š**

æƒ³è±¡ä¸€ä¸‹ï¼Œæ‚¨æœ‰ä¸€ä¸ªå…¨çƒåˆ†å¸ƒçš„åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·éå¸ƒä¸–ç•Œå„åœ°ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ Azure Front Door **å°†ç”¨æˆ·è¯·æ±‚è·¯ç”±åˆ°æœ€è¿‘çš„åŒºåŸŸæ•°æ®ä¸­å¿ƒ** æ‰˜ç®¡æ‚¨çš„åº”ç”¨ç¨‹åºï¼Œä»è€Œå‡å°‘å»¶è¿Ÿï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒï¼Œå¹¶ **åˆ©ç”¨ WAF åŠŸèƒ½ä¿æŠ¤å…¶å…å— web æ”»å‡»**ã€‚å¦‚æœæŸä¸ªç‰¹å®šåŒºåŸŸå‘ç”Ÿåœæœºï¼ŒAzure Front Door å¯ä»¥è‡ªåŠ¨å°†æµé‡é‡æ–°è·¯ç”±åˆ°ä¸‹ä¸€ä¸ªæœ€ä½³ä½ç½®ï¼Œç¡®ä¿é«˜å¯ç”¨æ€§ã€‚

### æšä¸¾

{% code overflow="wrap" %}
```bash
# List Azure Front Door Instances
az network front-door list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table

# List Front Door WAF Policies
az network front-door waf-policy list --query "[].{name:name, resourceGroup:resourceGroup, location:location}" -o table
```
{% endcode %}

## Azure åº”ç”¨ç¨‹åºç½‘å…³å’Œ Azure åº”ç”¨ç¨‹åºç½‘å…³ WAF

Azure åº”ç”¨ç¨‹åºç½‘å…³æ˜¯ä¸€ä¸ª **ç½‘ç»œæµé‡è´Ÿè½½å‡è¡¡å™¨**ï¼Œä½¿æ‚¨èƒ½å¤Ÿç®¡ç†å¯¹æ‚¨çš„ **ç½‘ç»œ** åº”ç”¨ç¨‹åºçš„æµé‡ã€‚å®ƒåœ¨åº”ç”¨ç¨‹åºäº¤ä»˜æ§åˆ¶å™¨ (ADC) ä¸­æä¾› **ç¬¬ 7 å±‚è´Ÿè½½å‡è¡¡ã€SSL ç»ˆæ­¢å’Œç½‘ç»œåº”ç”¨ç¨‹åºé˜²ç«å¢™ (WAF) åŠŸèƒ½**ã€‚ä¸»è¦åŠŸèƒ½åŒ…æ‹¬åŸºäº URL çš„è·¯ç”±ã€åŸºäº cookie çš„ä¼šè¯äº²å’Œæ€§å’Œå®‰å…¨å¥—æ¥å­—å±‚ (SSL) å¸è½½ï¼Œè¿™äº›å¯¹äºéœ€è¦å¤æ‚è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„åº”ç”¨ç¨‹åºè‡³å…³é‡è¦ï¼Œä¾‹å¦‚å…¨çƒè·¯ç”±å’ŒåŸºäºè·¯å¾„çš„è·¯ç”±ã€‚

**ç¤ºä¾‹ï¼š**

è€ƒè™‘ä¸€ä¸ªåœºæ™¯ï¼Œæ‚¨æœ‰ä¸€ä¸ªç”µå­å•†åŠ¡ç½‘ç«™ï¼Œå…¶ä¸­åŒ…æ‹¬å¤šä¸ªå­åŸŸä»¥å®ç°ä¸åŒåŠŸèƒ½ï¼Œä¾‹å¦‚ç”¨æˆ·å¸æˆ·å’Œæ”¯ä»˜å¤„ç†ã€‚Azure åº”ç”¨ç¨‹åºç½‘å…³å¯ä»¥ **æ ¹æ® URL è·¯å¾„å°†æµé‡è·¯ç”±åˆ°é€‚å½“çš„ç½‘ç»œæœåŠ¡å™¨**ã€‚ä¾‹å¦‚ï¼Œæµé‡åˆ° `example.com/accounts` å¯ä»¥è¢«å®šå‘åˆ°ç”¨æˆ·å¸æˆ·æœåŠ¡ï¼Œè€Œæµé‡åˆ° `example.com/pay` å¯ä»¥è¢«å®šå‘åˆ°æ”¯ä»˜å¤„ç†æœåŠ¡ã€‚\
å¹¶ä¸” **ä½¿ç”¨ WAF åŠŸèƒ½ä¿æŠ¤æ‚¨çš„ç½‘ç«™å…å—æ”»å‡»ã€‚**

### **æšä¸¾**

{% code overflow="wrap" %}
```bash
# List the Web Application Firewall configurations for your Application Gateways
az network application-gateway waf-config list --gateway-name <AppGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, firewallMode:firewallMode, ruleSetType:ruleSetType, ruleSetVersion:ruleSetVersion}" -o table
```
{% endcode %}

## Azure Hub, Spoke & VNet Peering

**VNet Peering** æ˜¯ Azure ä¸­çš„ä¸€é¡¹ç½‘ç»œåŠŸèƒ½ï¼Œ**å…è®¸ä¸åŒçš„è™šæ‹Ÿç½‘ç»œï¼ˆVNetsï¼‰ç›´æ¥æ— ç¼è¿æ¥**ã€‚é€šè¿‡ VNet å¯¹ç­‰è¿æ¥ï¼Œä¸€ä¸ª VNet ä¸­çš„èµ„æºå¯ä»¥ä½¿ç”¨ç§æœ‰ IP åœ°å€ä¸å¦ä¸€ä¸ª VNet ä¸­çš„èµ„æºè¿›è¡Œé€šä¿¡ï¼Œ**å°±åƒå®ƒä»¬åœ¨åŒä¸€ç½‘ç»œä¸­ä¸€æ ·**ã€‚\
**VNet å¯¹ç­‰è¿æ¥è¿˜å¯ä»¥ä¸æœ¬åœ°ç½‘ç»œä¸€èµ·ä½¿ç”¨**ï¼Œé€šè¿‡è®¾ç½®ç«™ç‚¹åˆ°ç«™ç‚¹çš„ VPN æˆ– Azure ExpressRouteã€‚

**Azure Hub and Spoke** æ˜¯ä¸€ç§åœ¨ Azure ä¸­ç”¨äºç®¡ç†å’Œç»„ç»‡ç½‘ç»œæµé‡çš„ç½‘ç»œæ‹“æ‰‘ã€‚**â€œä¸­å¿ƒâ€æ˜¯ä¸€ä¸ªæ§åˆ¶å’Œè·¯ç”±ä¸åŒâ€œè¾æ¡â€ä¹‹é—´æµé‡çš„ä¸­å¿ƒç‚¹**ã€‚ä¸­å¿ƒé€šå¸¸åŒ…å«å…±äº«æœåŠ¡ï¼Œå¦‚ç½‘ç»œè™šæ‹Ÿè®¾å¤‡ï¼ˆNVAï¼‰ã€Azure VPN ç½‘å…³ã€Azure é˜²ç«å¢™æˆ– Azure Bastionã€‚**â€œè¾æ¡â€æ˜¯æ‰¿è½½å·¥ä½œè´Ÿè½½å¹¶é€šè¿‡ VNet å¯¹ç­‰è¿æ¥åˆ°ä¸­å¿ƒçš„ VNets**ï¼Œä½¿å®ƒä»¬èƒ½å¤Ÿåˆ©ç”¨ä¸­å¿ƒå†…çš„å…±äº«æœåŠ¡ã€‚è¯¥æ¨¡å‹ä¿ƒè¿›äº†æ¸…æ™°çš„ç½‘ç»œå¸ƒå±€ï¼Œé€šè¿‡é›†ä¸­å¤šä¸ª VNet ä¸­çš„å·¥ä½œè´Ÿè½½å¯ä»¥ä½¿ç”¨çš„å…¬å…±æœåŠ¡æ¥å‡å°‘å¤æ‚æ€§ã€‚

{% hint style="danger" %}
**åœ¨ Azure ä¸­ï¼ŒVNET å¯¹ç­‰è¿æ¥æ˜¯éä¼ é€’çš„**ï¼Œè¿™æ„å‘³ç€å¦‚æœè¾æ¡ 1 è¿æ¥åˆ°è¾æ¡ 2ï¼Œè¾æ¡ 2 è¿æ¥åˆ°è¾æ¡ 3ï¼Œåˆ™è¾æ¡ 1 ä¸èƒ½ç›´æ¥ä¸è¾æ¡ 3 é€šä¿¡ã€‚
{% endhint %}

**ç¤ºä¾‹ï¼š**

æƒ³è±¡ä¸€ä¸ªå…¬å¸æœ‰ç‹¬ç«‹çš„éƒ¨é—¨ï¼Œå¦‚é”€å”®ã€HR å’Œå¼€å‘ï¼Œ**æ¯ä¸ªéƒ¨é—¨éƒ½æœ‰è‡ªå·±çš„ VNetï¼ˆè¾æ¡ï¼‰**ã€‚è¿™äº› VNets **éœ€è¦è®¿é—®å…±äº«èµ„æº**ï¼Œå¦‚ä¸­å¤®æ•°æ®åº“ã€é˜²ç«å¢™å’Œäº’è”ç½‘ç½‘å…³ï¼Œè¿™äº›èµ„æºéƒ½ä½äº**å¦ä¸€ä¸ª VNetï¼ˆä¸­å¿ƒï¼‰**ä¸­ã€‚é€šè¿‡ä½¿ç”¨ Hub and Spoke æ¨¡å‹ï¼Œæ¯ä¸ªéƒ¨é—¨å¯ä»¥**é€šè¿‡ä¸­å¿ƒ VNet å®‰å…¨åœ°è¿æ¥åˆ°å…±äº«èµ„æºï¼Œè€Œä¸å°†è¿™äº›èµ„æºæš´éœ²äºå…¬å…±äº’è”ç½‘**æˆ–åˆ›å»ºå…·æœ‰ä¼—å¤šè¿æ¥çš„å¤æ‚ç½‘ç»œç»“æ„ã€‚

### Enumeration

{% code overflow="wrap" %}
```bash
# List all VNets in your subscription
az network vnet list --query "[].{name:name, location:location, addressSpace:addressSpace}" -o table

# List VNet peering connections for a given VNet
az network vnet peering list --resource-group <ResourceGroupName> --vnet-name <VNetName> --query "[].{name:name, peeringState:peeringState, remoteVnetId:remoteVnetId}" -o table

# List Shared Resources (e.g., Azure Firewall) in the Hub
az network firewall list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table
```
{% endcode %}

## Site-to-Site VPN

åœ¨ Azure ä¸­ï¼ŒSite-to-Site VPN å…è®¸æ‚¨ **å°†æœ¬åœ°ç½‘ç»œè¿æ¥åˆ° Azure è™šæ‹Ÿç½‘ç»œ (VNet)**ï¼Œä½¿ Azure ä¸­çš„èµ„æºï¼ˆå¦‚è™šæ‹Ÿæœºï¼‰çœ‹èµ·æ¥å°±åƒåœ¨æ‚¨çš„æœ¬åœ°ç½‘ç»œä¸Šã€‚æ­¤è¿æ¥æ˜¯é€šè¿‡ **VPN ç½‘å…³åŠ å¯†ä¸¤ä¸ªç½‘ç»œä¹‹é—´çš„æµé‡** æ¥å»ºç«‹çš„ã€‚

**ç¤ºä¾‹ï¼š**

ä¸€å®¶æ€»éƒ¨ä½äºçº½çº¦çš„ä¼ä¸šæ‹¥æœ‰ä¸€ä¸ªæœ¬åœ°æ•°æ®ä¸­å¿ƒï¼Œéœ€è¦å®‰å…¨åœ°è¿æ¥åˆ°å…¶åœ¨ Azure ä¸­çš„ VNetï¼Œè¯¥ VNet æ‰˜ç®¡å…¶è™šæ‹ŸåŒ–å·¥ä½œè´Ÿè½½ã€‚é€šè¿‡è®¾ç½® **Site-to-Site VPNï¼Œè¯¥å…¬å¸å¯ä»¥ç¡®ä¿æœ¬åœ°æœåŠ¡å™¨ä¸ Azure è™šæ‹Ÿæœºä¹‹é—´çš„åŠ å¯†è¿æ¥**ï¼Œä½¿å¾—ä¸¤ä¸ªç¯å¢ƒä¸­çš„èµ„æºå¯ä»¥åƒåœ¨åŒä¸€æœ¬åœ°ç½‘ç»œä¸­ä¸€æ ·å®‰å…¨åœ°è®¿é—®ã€‚

### **Enumeration**

{% code overflow="wrap" %}
```bash
# List VPN Gateways
az network vnet-gateway list --query "[].{name:name, location:location, resourceGroup:resourceGroup}" -o table

# List VPN Connections
az network vpn-connection list --gateway-name <VpnGatewayName> --resource-group <ResourceGroupName> --query "[].{name:name, connectionType:connectionType, connectionStatus:connectionStatus}" -o table
```
{% endcode %}

## Azure ExpressRoute

Azure ExpressRoute æ˜¯ä¸€é¡¹æœåŠ¡ï¼Œæä¾› **æ‚¨æœ¬åœ°åŸºç¡€è®¾æ–½ä¸ Azure æ•°æ®ä¸­å¿ƒä¹‹é—´çš„ç§æœ‰ã€ä¸“ç”¨ã€é«˜é€Ÿè¿æ¥**ã€‚æ­¤è¿æ¥é€šè¿‡è¿æ¥æä¾›å•†å»ºç«‹ï¼Œç»•è¿‡å…¬å…±äº’è”ç½‘ï¼Œæä¾›æ¯”å…¸å‹äº’è”ç½‘è¿æ¥æ›´é«˜çš„å¯é æ€§ã€æ›´å¿«çš„é€Ÿåº¦ã€æ›´ä½çš„å»¶è¿Ÿå’Œæ›´é«˜çš„å®‰å…¨æ€§ã€‚

**ç¤ºä¾‹ï¼š**

ä¸€å®¶è·¨å›½å…¬å¸ç”±äºæ•°æ®é‡å¤§å’Œé«˜ååé‡çš„éœ€æ±‚ï¼Œéœ€è¦ **ä¸å…¶ Azure æœåŠ¡ä¹‹é—´ä¿æŒä¸€è‡´å’Œå¯é çš„è¿æ¥**ã€‚è¯¥å…¬å¸é€‰æ‹© Azure ExpressRoute ç›´æ¥å°†å…¶æœ¬åœ°æ•°æ®ä¸­å¿ƒè¿æ¥åˆ° Azureï¼Œä¿ƒè¿›å¤§è§„æ¨¡æ•°æ®ä¼ è¾“ï¼Œä¾‹å¦‚æ¯æ—¥å¤‡ä»½å’Œå®æ—¶æ•°æ®åˆ†æï¼ŒåŒæ—¶å¢å¼ºéšç§å’Œé€Ÿåº¦ã€‚

### **Enumeration**

{% code overflow="wrap" %}
```bash
# List ExpressRoute Circuits
az network express-route list --query "[].{name:name, location:location, resourceGroup:resourceGroup, serviceProviderName:serviceProviderName, peeringLocation:peeringLocation}" -o table
```
{% endcode %}

{% hint style="success" %}
å­¦ä¹ ä¸å®è·µ AWS é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ AWS çº¢é˜Ÿä¸“å®¶ (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
å­¦ä¹ ä¸å®è·µ GCP é»‘å®¢æŠ€æœ¯ï¼š<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks åŸ¹è®­ GCP çº¢é˜Ÿä¸“å®¶ (GRTE)**<img src="../../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>æ”¯æŒ HackTricks</summary>

* æŸ¥çœ‹ [**è®¢é˜…è®¡åˆ’**](https://github.com/sponsors/carlospolop)!
* **åŠ å…¥** ğŸ’¬ [**Discord ç¾¤ç»„**](https://discord.gg/hRep4RUj7f) æˆ– [**Telegram ç¾¤ç»„**](https://t.me/peass) æˆ– **åœ¨ Twitter ä¸Šå…³æ³¨** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **é€šè¿‡å‘** [**HackTricks**](https://github.com/carlospolop/hacktricks) å’Œ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub ä»“åº“æäº¤ PR æ¥åˆ†äº«é»‘å®¢æŠ€å·§ã€‚

</details>
{% endhint %}
