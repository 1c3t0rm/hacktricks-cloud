# Az - Function Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informaci贸n B谩sica

Azure Functions es una soluci贸n **sin servidor** que te permite escribir menos c贸digo, mantener menos infraestructura y ahorrar en costos. En lugar de preocuparte por desplegar y mantener servidores, la infraestructura en la nube proporciona todos los recursos actualizados necesarios para mantener tus aplicaciones en funcionamiento.

En el portal de Azure, se facilita la integraci贸n entre Azure Functions y Azure API Management, permitiendo que **los puntos finales de funci贸n activados por HTTP se expongan como APIs REST**. Las APIs expuestas de esta manera se describen utilizando una definici贸n OpenAPI, proporcionando una interfaz est谩ndar y agn贸stica al lenguaje para APIs RESTful.

### Diferentes Planes

* El **plan de Consumo Flex** ofrece escalado din谩mico y basado en eventos con opciones de computaci贸n flexibles. Agrega o elimina autom谩ticamente instancias de funci贸n seg煤n la demanda, asegurando un uso eficiente de los recursos y rentabilidad a trav茅s de un **modelo de pago por uso**. Este plan admite redes virtuales para mayor seguridad y te permite reducir los inicios en fr铆o al preaprovisionar instancias. Es ideal para aplicaciones que experimentan cargas de trabajo variables y requieren escalado r谩pido sin necesidad de soporte de contenedores.
* El **plan de Consumo** tradicional para Azure Functions es la opci贸n de alojamiento sin servidor predeterminada, donde solo pagas por los recursos de computaci贸n cuando tus funciones est谩n en ejecuci贸n. Escala autom谩ticamente seg煤n el n煤mero de eventos entrantes, lo que lo hace altamente rentable para aplicaciones con cargas de trabajo intermitentes o impredecibles. Aunque no admite implementaciones de contenedores, incluye optimizaciones para reducir los tiempos de inicio en fr铆o y es adecuado para una amplia gama de aplicaciones sin servidor que requieren escalado autom谩tico sin la sobrecarga de gestionar infraestructura.
* El **plan Premium** para Azure Functions est谩 dise帽ado para aplicaciones que necesitan un rendimiento consistente y caracter铆sticas avanzadas. Escala autom谩ticamente seg煤n la demanda utilizando trabajadores precalentados, eliminando los inicios en fr铆o y asegurando que las funciones se ejecuten puntualmente incluso despu茅s de per铆odos de inactividad. Este plan ofrece instancias m谩s potentes, tiempos de ejecuci贸n extendidos y admite conectividad de red virtual. Adem谩s, permite el uso de im谩genes de Linux personalizadas, lo que lo hace adecuado para aplicaciones cr铆ticas que requieren alto rendimiento y mayor control sobre los recursos.
* El **plan Dedicado**, tambi茅n conocido como el plan de App Service, ejecuta tus funciones en m谩quinas virtuales dedicadas dentro de un entorno de App Service. Este plan proporciona facturaci贸n predecible y permite el escalado manual o autom谩tico de instancias, lo que lo hace ideal para escenarios de larga duraci贸n donde las Durable Functions no son adecuadas. Admite la ejecuci贸n de m煤ltiples aplicaciones web y de funci贸n en el mismo plan, ofrece tama帽os de computaci贸n m谩s grandes y asegura un aislamiento completo de computaci贸n y acceso seguro a la red a trav茅s de Entornos de App Service (ASE). Esta opci贸n es la mejor para aplicaciones que necesitan asignaci贸n de recursos consistente y personalizaci贸n extensa.
* **Container Apps** te permiten desplegar aplicaciones de funci贸n en contenedores dentro de un entorno completamente gestionado alojado por Azure Container Apps. Esta opci贸n es perfecta para construir aplicaciones sin servidor basadas en eventos que se ejecutan junto a otros microservicios, APIs y flujos de trabajo. Admite empaquetar bibliotecas personalizadas con tu c贸digo de funci贸n, migrar aplicaciones heredadas a microservicios nativos de la nube y aprovechar la potencia de procesamiento de alto rendimiento con recursos de GPU. Container Apps simplifican el despliegue al eliminar la necesidad de gestionar cl煤steres de Kubernetes, lo que las hace ideales para desarrolladores que buscan flexibilidad y escalabilidad en un entorno de contenedores.

### **Buckets de Almacenamiento**

Al crear una nueva Function App no contenedorizada (pero proporcionando el c贸digo para ejecutar), **el c贸digo y otros datos relacionados con la funci贸n se almacenar谩n en una cuenta de almacenamiento**. Por defecto, la consola web crear谩 una nueva por funci贸n para almacenar el c贸digo.

Adem谩s, cada vez que se necesite ejecutar una nueva instancia de la aplicaci贸n, **el c贸digo de la aplicaci贸n se recoger谩 de aqu铆 y se ejecutar谩**.

{% hint style="danger" %}
Esto es muy interesante desde la perspectiva de un atacante, ya que **el acceso de escritura sobre este bucket** permitir谩 a un atacante **comprometer el c贸digo y escalar privilegios** a las identidades gestionadas dentro de la Function App.
{% endhint %}

### Redes

* Es posible dar acceso a una funci贸n a todo Internet sin requerir ninguna autenticaci贸n o dar acceso basado en IAM.
* Tambi茅n es posible dar o restringir el acceso a la Function App desde Internet, dando acceso a una red interna (VPC) a la Function App.

{% hint style="danger" %}
Esto es muy interesante desde la perspectiva de un atacante, ya que podr铆a ser posible **pivotar a redes internas** desde una funci贸n Lambda vulnerable expuesta a Internet.
{% endhint %}

### **Function Apps admiten Identidades Gestionadas.**

Adem谩s, la Function App puede tener ciertos puntos finales que requieren un cierto nivel de autenticaci贸n, como "admin" o "an贸nimo".\
Un atacante podr铆a intentar acceder a los **puntos finales permitidos an贸nimamente** para eludir las restricciones y obtener acceso a datos o funcionalidades sensibles.

## Claves de Acceso

{% hint style="info" %}
Ten en cuenta que no hay permisos RBAC para dar acceso a los usuarios para invocar las funciones. La **invocaci贸n de la funci贸n depende del trigger** seleccionado cuando se cre贸 y si se seleccion贸 un Trigger HTTP, podr铆a ser necesario usar una **clave de acceso**.
{% endhint %}

Al crear un punto final dentro de una funci贸n utilizando un **trigger HTTP**, es posible indicar el **nivel de autorizaci贸n de clave de acceso** necesario para activar la funci贸n. Hay tres opciones disponibles:

* **ANNIMO**: **Todos** pueden acceder a la funci贸n a trav茅s de la URL.
* **FUNCIN**: El punto final solo es accesible para usuarios que utilizan una **clave de funci贸n, host o maestra**.
* **ADMIN**: El punto final solo es accesible para usuarios con una **clave maestra**.

**Tipo de claves:**

* **Claves de Funci贸n:** Las claves de funci贸n pueden ser predeterminadas o definidas por el usuario y est谩n dise帽adas para otorgar acceso exclusivamente a **puntos finales de funci贸n espec铆ficos** dentro de una Function App. Esto permite un control de seguridad m谩s detallado, asegurando que solo los usuarios o servicios autorizados puedan invocar funciones particulares sin exponer toda la aplicaci贸n.
* **Claves de Host:** Las claves de host, que tambi茅n pueden ser predeterminadas o definidas por el usuario, proporcionan acceso a **todos los puntos finales de funci贸n dentro de una Function App**. Esto es 煤til cuando se necesita acceder a m煤ltiples funciones utilizando una sola clave, simplificando la gesti贸n y reduciendo el n煤mero de claves que deben distribuirse o almacenarse de forma segura.
* **Clave Maestra:** La clave maestra (`_master`) sirve como una clave administrativa que ofrece permisos elevados, incluyendo acceso a las APIs REST de tiempo de ejecuci贸n **de una Function App**. Esta **clave no puede ser revocada y debe ser manejada con el m谩ximo cuidado**. Es crucial **no** compartir la clave maestra con terceros o incluirla en aplicaciones cliente nativas para prevenir el acceso administrativo no autorizado.
* Al establecer la autenticaci贸n de una funci贸n en ADMIN (y no ANNIMO o FUNCIN), es necesario usar esta clave.
* **Claves del Sistema:** Las claves del sistema son **gestionadas por extensiones espec铆ficas** y son necesarias para acceder a los puntos finales de webhook utilizados por componentes internos. Ejemplos incluyen el trigger de Event Grid y Durable Functions, que utilizan claves del sistema para interactuar de manera segura con sus respectivas APIs. Las claves del sistema pueden ser regeneradas a trav茅s del Portal de Azure o APIs de claves para mantener la seguridad.

{% hint style="success" %}
Ejemplo para acceder a un punto final de API de funci贸n utilizando una clave:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumeraci贸n
```powershell
# Get only Function Apps
Get-AzFunctionApp
```
## Escalaci贸n de Privilegios

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Referencias

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* Revisa los [**planes de suscripci贸n**](https://github.com/sponsors/carlospolop)!
* **nete al**  [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s铆guenos** en **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>
{% endhint %}
