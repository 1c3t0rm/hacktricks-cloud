# Az - Function Apps

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

## Grundinformationen

Azure Functions ist eine **serverlose** L√∂sung, die es Ihnen erm√∂glicht, weniger Code zu schreiben, weniger Infrastruktur zu warten und Kosten zu sparen. Anstatt sich um das Bereitstellen und Warten von Servern zu k√ºmmern, stellt die Cloud-Infrastruktur alle aktuellen Ressourcen bereit, die ben√∂tigt werden, um Ihre Anwendungen am Laufen zu halten.

Im Azure-Portal wird die Integration zwischen Azure Functions und Azure API Management erleichtert, sodass **HTTP-Trigger-Funktionsendpunkte als REST-APIs exponiert werden k√∂nnen**. Die auf diese Weise exponierten APIs werden mit einer OpenAPI-Definition beschrieben, die eine standardisierte, sprachunabh√§ngige Schnittstelle zu RESTful APIs bietet.

### Verschiedene Pl√§ne

* Der **Flex Consumption Plan** bietet dynamisches, ereignisgesteuertes Skalieren mit flexiblen Rechenoptionen. Er f√ºgt automatisch Funktionsinstanzen basierend auf der Nachfrage hinzu oder entfernt sie, um eine effiziente Ressourcennutzung und Kosteneffektivit√§t durch ein **Pay-as-you-go-Modell** zu gew√§hrleisten. Dieser Plan unterst√ºtzt virtuelles Networking f√ºr verbesserte Sicherheit und erm√∂glicht es Ihnen, Kaltstarts durch die Vorabbereitstellung von Instanzen zu reduzieren. Er ist ideal f√ºr Anwendungen, die variable Arbeitslasten aufweisen und eine schnelle Skalierung ohne Containerunterst√ºtzung erfordern.
* Der traditionelle **Consumption Plan** f√ºr Azure Functions ist die standardm√§√üige serverlose Hosting-Option, bei der Sie nur f√ºr die Rechenressourcen bezahlen, wenn Ihre Funktionen ausgef√ºhrt werden. Er skaliert automatisch basierend auf der Anzahl der eingehenden Ereignisse, was ihn sehr kosteneffektiv f√ºr Anwendungen mit intermittierenden oder unvorhersehbaren Arbeitslasten macht. W√§hrend er keine Containerbereitstellungen unterst√ºtzt, umfasst er Optimierungen zur Reduzierung der Kaltstartzeiten und ist f√ºr eine Vielzahl von serverlosen Anwendungen geeignet, die automatisches Skalieren ohne den Aufwand der Infrastrukturverwaltung erfordern.
* Der **Premium Plan** f√ºr Azure Functions ist f√ºr Anwendungen konzipiert, die konsistente Leistung und erweiterte Funktionen ben√∂tigen. Er skaliert automatisch basierend auf der Nachfrage mit vorgew√§rmten Arbeitern, wodurch Kaltstarts eliminiert werden und sichergestellt wird, dass Funktionen auch nach Inaktivit√§tsphasen umgehend ausgef√ºhrt werden. Dieser Plan bietet leistungsst√§rkere Instanzen, verl√§ngerte Ausf√ºhrungszeiten und unterst√ºtzt die Verbindung zu virtuellen Netzwerken. Dar√ºber hinaus erm√∂glicht er die Verwendung benutzerdefinierter Linux-Images, was ihn f√ºr gesch√§ftskritische Anwendungen geeignet macht, die hohe Leistung und mehr Kontrolle √ºber Ressourcen erfordern.
* Der **Dedicated Plan**, auch bekannt als App Service Plan, f√ºhrt Ihre Funktionen auf dedizierten virtuellen Maschinen innerhalb einer App Service-Umgebung aus. Dieser Plan bietet vorhersehbare Abrechnung und erm√∂glicht manuelles oder automatisches Skalieren von Instanzen, was ihn ideal f√ºr lang laufende Szenarien macht, in denen Durable Functions nicht geeignet sind. Er unterst√ºtzt das Ausf√ºhren mehrerer Web- und Funktionsanwendungen im selben Plan, bietet gr√∂√üere Rechenkapazit√§ten und gew√§hrleistet vollst√§ndige Rechenisolierung und sicheren Netzwerkzugang √ºber App Service Environments (ASE). Diese Option ist am besten f√ºr Anwendungen geeignet, die eine konsistente Ressourcenzuteilung und umfangreiche Anpassungsm√∂glichkeiten ben√∂tigen.
* **Container Apps** erm√∂glichen es Ihnen, containerisierte Funktionsanwendungen innerhalb einer vollst√§ndig verwalteten Umgebung zu implementieren, die von Azure Container Apps gehostet wird. Diese Option ist perfekt f√ºr den Aufbau von ereignisgesteuerten, serverlosen Anwendungen, die neben anderen Mikrodiensten, APIs und Workflows ausgef√ºhrt werden. Sie unterst√ºtzt das Verpacken benutzerdefinierter Bibliotheken mit Ihrem Funktionscode, die Migration von Legacy-Anwendungen zu cloud-nativen Mikrodiensten und die Nutzung leistungsstarker Verarbeitungskapazit√§ten mit GPU-Ressourcen. Container Apps vereinfachen die Bereitstellung, indem sie die Notwendigkeit zur Verwaltung von Kubernetes-Clustern beseitigen, was sie ideal f√ºr Entwickler macht, die Flexibilit√§t und Skalierbarkeit in einer containerisierten Umgebung suchen.

### **Speicher-Buckets**

Beim Erstellen einer neuen Funktionsanwendung, die nicht containerisiert ist (aber den auszuf√ºhrenden Code bereitstellt), werden der **Code und andere funktionsbezogene Daten in einem Speicherkonto gespeichert**. Standardm√§√üig erstellt die Webkonsole f√ºr jede Funktion ein neues Konto, um den Code zu speichern.

Dar√ºber hinaus wird, wann immer eine neue Instanz der Anwendung ausgef√ºhrt werden muss, der **Code der Anwendung von hier abgerufen und ausgef√ºhrt**.

{% hint style="danger" %}
Dies ist aus der Perspektive eines Angreifers sehr interessant, da **Schreibzugriff auf diesen Bucket** einem Angreifer erm√∂glichen w√ºrde, **den Code zu kompromittieren und Berechtigungen** f√ºr die verwalteten Identit√§ten innerhalb der Funktionsanwendung zu eskalieren.
{% endhint %}

### Netzwerk

* Es ist m√∂glich, einer Funktion den Zugriff auf das gesamte Internet zu gew√§hren, ohne eine Authentifizierung zu verlangen, oder den Zugriff IAM-basiert zu gew√§hren.
* Es ist auch m√∂glich, den Zugriff auf die Funktionsanwendung aus dem Internet zu gew√§hren oder einzuschr√§nken und den Zugriff auf ein internes Netzwerk (VPC) zur Funktionsanwendung zu gew√§hren.

{% hint style="danger" %}
Dies ist aus der Perspektive eines Angreifers sehr interessant, da es m√∂glich sein k√∂nnte, **auf interne Netzwerke zu pivotieren** von einer verwundbaren Lambda-Funktion, die dem Internet ausgesetzt ist.
{% endhint %}

### **Funktionsanwendungen unterst√ºtzen verwaltete Identit√§ten.**

Dar√ºber hinaus kann die Funktionsanwendung bestimmte Endpunkte haben, die ein gewisses Ma√ü an Authentifizierung erfordern, wie "admin" oder "anonym".\
Ein Angreifer k√∂nnte versuchen, auf die **anonym erlaubten Endpunkte** zuzugreifen, um die Einschr√§nkungen zu umgehen und Zugriff auf sensible Daten oder Funktionen zu erhalten.

## Zugriffsschl√ºssel

{% hint style="info" %}
Bitte beachten Sie, dass es keine RBAC-Berechtigungen gibt, um Benutzern den Zugriff auf die Funktionen zu gew√§hren. Der **Funktionsaufruf h√§ngt vom Trigger** ab, der bei der Erstellung ausgew√§hlt wurde, und wenn ein HTTP-Trigger ausgew√§hlt wurde, k√∂nnte es erforderlich sein, einen **Zugriffsschl√ºssel** zu verwenden.
{% endhint %}

Beim Erstellen eines Endpunkts innerhalb einer Funktion mit einem **HTTP-Trigger** ist es m√∂glich, das **Autorisierungsniveau des Zugriffsschl√ºssels** anzugeben, das erforderlich ist, um die Funktion auszul√∂sen. Drei Optionen stehen zur Verf√ºgung:

* **ANONYMOUS**: **Jeder** kann √ºber die URL auf die Funktion zugreifen.
* **FUNCTION**: Der Endpunkt ist nur f√ºr Benutzer zug√§nglich, die einen **Funktions-, Host- oder Master-Schl√ºssel** verwenden.
* **ADMIN**: Der Endpunkt ist nur f√ºr Benutzer mit einem **Master-Schl√ºssel** zug√§nglich.

**Arten von Schl√ºsseln:**

* **Funktionsschl√ºssel:** Funktionsschl√ºssel k√∂nnen entweder Standard- oder benutzerdefiniert sein und sind daf√ºr ausgelegt, den Zugriff ausschlie√ülich auf **bestimmte Funktionsendpunkte** innerhalb einer Funktionsanwendung zu gew√§hren. Dies erm√∂glicht eine feingranulare Sicherheitskontrolle, die sicherstellt, dass nur autorisierte Benutzer oder Dienste bestimmte Funktionen aufrufen k√∂nnen, ohne die gesamte Anwendung offenzulegen.
* **Host-Schl√ºssel:** Host-Schl√ºssel, die ebenfalls Standard- oder benutzerdefiniert sein k√∂nnen, gew√§hren Zugriff auf **alle Funktionsendpunkte innerhalb einer Funktionsanwendung**. Dies ist n√ºtzlich, wenn mehrere Funktionen mit einem einzigen Schl√ºssel aufgerufen werden m√ºssen, was die Verwaltung vereinfacht und die Anzahl der Schl√ºssel reduziert, die verteilt oder sicher gespeichert werden m√ºssen.
* **Master-Schl√ºssel:** Der Master-Schl√ºssel (`_master`) dient als administrativer Schl√ºssel, der erweiterte Berechtigungen bietet, einschlie√ülich Zugriff auf die Runtime-REST-APIs **einer Funktionsanwendung**. Dieser **Schl√ºssel kann nicht widerrufen werden und sollte mit √§u√üerster Vorsicht behandelt werden**. Es ist entscheidend, **den Master-Schl√ºssel nicht** mit Dritten zu teilen oder in nativen Client-Anwendungen einzuschlie√üen, um unbefugten administrativen Zugriff zu verhindern.
* Bei der Festlegung der Authentifizierung einer Funktion auf ADMIN (und nicht ANONYMOUS oder FUNCTION) ist es erforderlich, diesen Schl√ºssel zu verwenden.
* **Systemschl√ºssel:** Systemschl√ºssel werden **von bestimmten Erweiterungen verwaltet** und sind erforderlich, um auf Webhook-Endpunkte zuzugreifen, die von internen Komponenten verwendet werden. Beispiele sind der Event Grid-Trigger und Durable Functions, die Systemschl√ºssel verwenden, um sicher mit ihren jeweiligen APIs zu interagieren. Systemschl√ºssel k√∂nnen √ºber das Azure-Portal oder die Schl√ºssel-APIs regeneriert werden, um die Sicherheit aufrechtzuerhalten.

{% hint style="success" %}
Beispiel f√ºr den Zugriff auf einen Funktions-API-Endpunkt mit einem Schl√ºssel:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Aufz√§hlung
```powershell
# Get only Function Apps
Get-AzFunctionApp
```
## Privilegieneskalation

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Referenzen

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Lerne & √ºbe AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Lerne & √ºbe GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtze HackTricks</summary>

* √úberpr√ºfe die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Tritt der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folge** uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Teile Hacking-Tricks, indem du PRs zu den** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos einreichst.

</details>
{% endhint %}
