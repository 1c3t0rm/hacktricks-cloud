# Az - Function Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ğŸ’¬ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Functions je **serverless** reÅ¡enje koje vam omoguÄ‡ava da piÅ¡ete manje koda, odrÅ¾avate manje infrastrukture i Å¡tedite na troÅ¡kovima. Umesto da brinete o implementaciji i odrÅ¾avanju servera, cloud infrastruktura pruÅ¾a sve aÅ¾urirane resurse potrebne za odrÅ¾avanje vaÅ¡ih aplikacija.

U Azure portalu, integracija izmeÄ‘u Azure Functions i Azure API Management je olakÅ¡ana, omoguÄ‡avajuÄ‡i **HTTP trigger funkcijskim krajnjim taÄkama da budu izloÅ¾ene kao REST API**. API-ji izloÅ¾eni na ovaj naÄin su opisani koristeÄ‡i OpenAPI definiciju, pruÅ¾ajuÄ‡i standardno, jezik-agnostiÄko suÄelje za RESTful API.

### Different Plans

* **Flex Consumption plan** nudi dinamiÄko, dogaÄ‘ajem pokrenuto skaliranje sa fleksibilnim opcijama raÄunanja. Automatski dodaje ili uklanja instance funkcija na osnovu potraÅ¾nje, osiguravajuÄ‡i efikasnu upotrebu resursa i isplativost kroz **pay-as-you-go model**. Ovaj plan podrÅ¾ava virtuelno umreÅ¾avanje za poboljÅ¡anu sigurnost i omoguÄ‡ava vam da smanjite hladne startove prethodnim obezbeÄ‘ivanjem instanci. Idealno je za aplikacije koje doÅ¾ivljavaju promenljive radne optereÄ‡enja i zahtevaju brzo skaliranje bez potrebe za podrÅ¡kom kontejnera.
* Tradicionalni **Consumption plan** za Azure Functions je podrazumevani serverless hosting opcija, gde plaÄ‡ate samo za resurse raÄunanja kada su vaÅ¡e funkcije u radu. Automatski se skalira na osnovu broja dolaznih dogaÄ‘aja, ÄineÄ‡i ga veoma isplativim za aplikacije sa povremenim ili nepredvidivim radnim optereÄ‡enjima. Iako ne podrÅ¾ava implementacije kontejnera, ukljuÄuje optimizacije za smanjenje vremena hladnog starta i pogodan je za Å¡irok spektar serverless aplikacija koje zahtevaju automatsko skaliranje bez optereÄ‡enja upravljanja infrastrukturom.
* **Premium plan** za Azure Functions je dizajniran za aplikacije koje zahtevaju dosledne performanse i napredne funkcije. Automatski se skalira na osnovu potraÅ¾nje koristeÄ‡i prethodno zagrejane radnike, eliminiÅ¡uÄ‡i hladne startove i osiguravajuÄ‡i da funkcije rade brzo Äak i nakon perioda neaktivnosti. Ovaj plan nudi moÄ‡nije instance, produÅ¾ene vreme izvrÅ¡enja i podrÅ¾ava virtuelnu mreÅ¾nu povezanost. Pored toga, omoguÄ‡ava koriÅ¡Ä‡enje prilagoÄ‘enih Linux slika, Å¡to ga Äini pogodnim za aplikacije od kritiÄne vaÅ¾nosti koje zahtevaju visoke performanse i veÄ‡u kontrolu nad resursima.
* **Dedicated plan**, poznat i kao App Service plan, pokreÄ‡e vaÅ¡e funkcije na posveÄ‡enim virtuelnim maÅ¡inama unutar App Service okruÅ¾enja. Ovaj plan pruÅ¾a predvidljivo fakturisanje i omoguÄ‡ava ruÄno ili automatsko skaliranje instanci, Å¡to ga Äini idealnim za dugotrajne scenarije gde Durable Functions nisu pogodne. PodrÅ¾ava pokretanje viÅ¡e web i funkcijskih aplikacija na istom planu, nudi veÄ‡e veliÄine raÄunanja i osigurava potpunu izolaciju raÄunanja i sigurni pristup mreÅ¾i kroz App Service Environments (ASE). Ova opcija je najbolja za aplikacije koje zahtevaju doslednu alokaciju resursa i opseÅ¾no prilagoÄ‘avanje.
* **Container Apps** omoguÄ‡avaju vam da implementirate kontejnerizovane funkcijske aplikacije unutar potpuno upravljanog okruÅ¾enja koje hostuje Azure Container Apps. Ova opcija je savrÅ¡ena za izgradnju dogaÄ‘ajem pokrenutih, serverless aplikacija koje rade zajedno sa drugim mikroservisima, API-ima i radnim tokovima. PodrÅ¾ava pakovanje prilagoÄ‘enih biblioteka sa vaÅ¡im funkcijskim kodom, migraciju nasleÄ‘enih aplikacija na cloud-native mikroservise i koriÅ¡Ä‡enje visokih procesorskih resursa sa GPU resursima. Container Apps pojednostavljuju implementaciju eliminisanjem potrebe za upravljanjem Kubernetes klasterima, Å¡to ih Äini idealnim za programere koji traÅ¾e fleksibilnost i skalabilnost u kontejnerizovanom okruÅ¾enju.

### **Storage Buckets**

Kada kreirate novu Function App koja nije kontejnerizovana (ali daje kod za pokretanje), **kod i drugi podaci vezani za funkciju Ä‡e biti pohranjeni u Storage nalogu**. Po defaultu, web konzola Ä‡e kreirati novi nalog po funkciji za pohranu koda.

Å taviÅ¡e, kada god nova instanca aplikacije treba da se pokrene, **kod aplikacije Ä‡e biti prikupljen odavde i izvrÅ¡en**.

{% hint style="danger" %}
Ovo je veoma zanimljivo iz perspektive napadaÄa jer **pristup za pisanje preko ovog bucket-a** Ä‡e omoguÄ‡iti napadaÄu da **kompromituje kod i eskalira privilegije** na upravljane identitete unutar Function App-a.
{% endhint %}

### Networking

* MoguÄ‡e je dati pristup funkciji svima na Internetu bez potrebe za bilo kakvom autentifikacijom ili dati pristup na osnovu IAM-a.
* TakoÄ‘e je moguÄ‡e dati ili ograniÄiti pristup Function App-u sa Interneta, dajuÄ‡i pristup unutraÅ¡njoj mreÅ¾i (VPC) Function App-u.

{% hint style="danger" %}
Ovo je veoma zanimljivo iz perspektive napadaÄa jer bi moglo biti moguÄ‡e **pivotsati na unutraÅ¡nje mreÅ¾e** iz ranjive Lambda funkcije izloÅ¾ene Internetu.
{% endhint %}

### **Environment Variables**

moguÄ‡e je konfigurisati promenljive okruÅ¾enja unutar aplikacije. Å taviÅ¡e, po defaultu, env promenljive **`AzureWebJobsStorage`** i **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`** (meÄ‘u ostalima) se kreiraju. Ove su posebno zanimljive jer **sadrÅ¾e kljuÄ naloga za kontrolu sa POTPUNIM dozvolama nad storage nalogom koji sadrÅ¾i podatke aplikacije**.

### **Function Sandbox**

Unutar sandbox-a, izvorni kod se nalazi u **`/home/site/wwwroot`** u datoteci **`function_app.py`** (ako se koristi python), korisnik koji pokreÄ‡e kod je **`app`** (bez sudo dozvola).

### **Managed Identities**

Å taviÅ¡e, Function App moÅ¾e imati odreÄ‘ene krajnje taÄke koje zahtevaju odreÄ‘eni nivo autentifikacije, kao Å¡to su "admin" ili "anonymous".\
NapadaÄ bi mogao pokuÅ¡ati da pristupi **anonimnim dozvoljenim krajnjim taÄkama** kako bi zaobiÅ¡ao ograniÄenja i dobio pristup osetljivim podacima ili funkcionalnosti.

## Access Keys

{% hint style="info" %}
Napomena da ne postoje RBAC dozvole za davanje pristupa korisnicima da pozivaju funkcije. **Poziv funkcije zavisi od okidaÄa** odabranog prilikom kreiranja i ako je odabran HTTP Trigger, moÅ¾da Ä‡e biti potrebno koristiti **pristupni kljuÄ**.
{% endhint %}

Kada kreirate krajnju taÄku unutar funkcije koristeÄ‡i **HTTP trigger**, moguÄ‡e je naznaÄiti **nivo autorizacije pristupnog kljuÄa** potreban za pokretanje funkcije. Dostupne su tri opcije:

* **ANONYMOUS**: **Svi** mogu pristupiti funkciji putem URL-a.
* **FUNCTION**: Krajnja taÄka je dostupna samo korisnicima koji koriste **funkcijski, host ili master kljuÄ**.
* **ADMIN**: Krajnja taÄka je dostupna samo korisnicima sa **master kljuÄem**.

**Tipovi kljuÄeva:**

* **Function Keys:** KljuÄevi funkcija mogu biti ili podrazumevani ili korisniÄki definisani i dizajnirani su da daju pristup iskljuÄivo **odreÄ‘enim funkcijskim krajnjim taÄkama** unutar Function App-a. Ovo omoguÄ‡ava fino podeÅ¡avanje sigurnosne kontrole, osiguravajuÄ‡i da samo ovlaÅ¡Ä‡eni korisnici ili servisi mogu pozvati odreÄ‘ene funkcije bez izlaganja cele aplikacije.
* **Host Keys:** Host kljuÄevi, koji takoÄ‘e mogu biti podrazumevani ili korisniÄki definisani, pruÅ¾aju pristup **svim funkcijskim krajnjim taÄkama unutar Function App-a**. Ovo je korisno kada je potrebno pristupiti viÅ¡e funkcija koristeÄ‡i jedan kljuÄ, pojednostavljujuÄ‡i upravljanje i smanjujuÄ‡i broj kljuÄeva koji treba distribuirati ili sigurno Äuvati.
* **Master Key:** Master kljuÄ (`_master`) sluÅ¾i kao administrativni kljuÄ koji nudi poviÅ¡ene dozvole, ukljuÄujuÄ‡i pristup runtime REST API-ima **Function App-a**. Ovaj **kljuÄ se ne moÅ¾e opozvati i treba ga rukovati sa najveÄ‡om paÅ¾njom**. KljuÄno je **ne** deliti master kljuÄ sa treÄ‡im stranama ili ga ukljuÄivati u native klijentske aplikacije kako bi se spreÄio neovlaÅ¡Ä‡eni administrativni pristup.
* Kada se postavi autentifikacija funkcije na ADMIN (a ne ANONYMOUS ili FUNCTION), potrebno je koristiti ovaj kljuÄ.
* **System Keys:** Sistem kljuÄevi su **upravljaÄki od strane specifiÄnih ekstenzija** i potrebni su za pristup webhook krajnjim taÄkama koje koriste unutraÅ¡nji komponenti. Primeri ukljuÄuju Event Grid trigger i Durable Functions, koji koriste sistem kljuÄeve za sigurno interagovanje sa svojim API-ima. Sistem kljuÄevi se mogu regenerisati putem Azure Portala ili kljuÄ API-a kako bi se odrÅ¾ala sigurnost.

{% hint style="success" %}
Example to access a function API endpoint using a key:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumeration

{% code overflow="wrap" %}
```bash
# List all the functions
az functionapp list

# Get info of 1 funciton (although in the list you already get this info)
az functionapp show --name <app-name> --resource-group <res-group>

# Get env variables (and privesc tot he sorage account)
az functionapp config appsettings list --name <app-name> --resource-group <res-group>

# Check if a domain was assigned to a function app
az functionapp config hostname list --webapp-name <app-name> --resource-group <res-group>

# Get SSL certificates
az functionapp config ssl list --resource-group <res-group>

# Get network restrictions
az functionapp config access-restriction show --name <app-name> --resource-group <res-group>
```
{% endcode %}

## Eskalacija privilegija

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
UÄite i veÅ¾bajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
UÄite i veÅ¾bajte GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>PodrÅ¾ite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **PridruÅ¾ite se** ğŸ’¬ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** ğŸ¦ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
