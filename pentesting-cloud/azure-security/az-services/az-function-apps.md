# Az - Function Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Basic Information

Azure Functions je **serverless** rešenje koje vam omogućava da pišete manje koda, održavate manje infrastrukture i štedite na troškovima. Umesto da brinete o implementaciji i održavanju servera, cloud infrastruktura pruža sve ažurirane resurse potrebne za održavanje vaših aplikacija.

U Azure portalu, integracija između Azure Functions i Azure API Management je olakšana, omogućavajući **HTTP trigger funkcijskim krajnjim tačkama da budu izložene kao REST API**. API-ji izloženi na ovaj način su opisani koristeći OpenAPI definiciju, pružajući standardno, jezik-agnostičko sučelje za RESTful API.

### Different Plans

* **Flex Consumption plan** nudi dinamičko, događajem pokrenuto skaliranje sa fleksibilnim opcijama računanja. Automatski dodaje ili uklanja instance funkcija na osnovu potražnje, osiguravajući efikasnu upotrebu resursa i isplativost kroz **pay-as-you-go model**. Ovaj plan podržava virtuelno umrežavanje za poboljšanu sigurnost i omogućava vam da smanjite hladne startove prethodnim obezbeđivanjem instanci. Idealno je za aplikacije koje doživljavaju promenljive radne opterećenja i zahtevaju brzo skaliranje bez potrebe za podrškom kontejnera.
* Tradicionalni **Consumption plan** za Azure Functions je podrazumevani serverless hosting opcija, gde plaćate samo za resurse računanja kada su vaše funkcije u radu. Automatski se skalira na osnovu broja dolaznih događaja, čineći ga veoma isplativim za aplikacije sa povremenim ili nepredvidivim radnim opterećenjima. Iako ne podržava implementacije kontejnera, uključuje optimizacije za smanjenje vremena hladnog starta i pogodan je za širok spektar serverless aplikacija koje zahtevaju automatsko skaliranje bez opterećenja upravljanja infrastrukturom.
* **Premium plan** za Azure Functions je dizajniran za aplikacije koje zahtevaju dosledne performanse i napredne funkcije. Automatski se skalira na osnovu potražnje koristeći prethodno zagrejane radnike, eliminišući hladne startove i osiguravajući da funkcije rade brzo čak i nakon perioda neaktivnosti. Ovaj plan nudi moćnije instance, produžene vreme izvršenja i podržava virtuelnu mrežnu povezanost. Pored toga, omogućava korišćenje prilagođenih Linux slika, što ga čini pogodnim za aplikacije od kritične važnosti koje zahtevaju visoke performanse i veću kontrolu nad resursima.
* **Dedicated plan**, poznat i kao App Service plan, pokreće vaše funkcije na posvećenim virtuelnim mašinama unutar App Service okruženja. Ovaj plan pruža predvidljivo fakturisanje i omogućava ručno ili automatsko skaliranje instanci, što ga čini idealnim za dugotrajne scenarije gde Durable Functions nisu pogodne. Podržava pokretanje više web i funkcijskih aplikacija na istom planu, nudi veće veličine računanja i osigurava potpunu izolaciju računanja i sigurni pristup mreži kroz App Service Environments (ASE). Ova opcija je najbolja za aplikacije koje zahtevaju doslednu alokaciju resursa i opsežno prilagođavanje.
* **Container Apps** omogućavaju vam da implementirate kontejnerizovane funkcijske aplikacije unutar potpuno upravljanog okruženja koje hostuje Azure Container Apps. Ova opcija je savršena za izgradnju događajem pokrenutih, serverless aplikacija koje rade zajedno sa drugim mikroservisima, API-ima i radnim tokovima. Podržava pakovanje prilagođenih biblioteka sa vašim funkcijskim kodom, migraciju nasleđenih aplikacija na cloud-native mikroservise i korišćenje visokih procesorskih resursa sa GPU resursima. Container Apps pojednostavljuju implementaciju eliminisanjem potrebe za upravljanjem Kubernetes klasterima, što ih čini idealnim za programere koji traže fleksibilnost i skalabilnost u kontejnerizovanom okruženju.

### **Storage Buckets**

Kada kreirate novu Function App koja nije kontejnerizovana (ali daje kod za pokretanje), **kod i drugi podaci vezani za funkciju će biti pohranjeni u Storage nalogu**. Po defaultu, web konzola će kreirati novi nalog po funkciji za pohranu koda.

Štaviše, kada god nova instanca aplikacije treba da se pokrene, **kod aplikacije će biti prikupljen odavde i izvršen**.

{% hint style="danger" %}
Ovo je veoma zanimljivo iz perspektive napadača jer **pristup za pisanje preko ovog bucket-a** će omogućiti napadaču da **kompromituje kod i eskalira privilegije** na upravljane identitete unutar Function App-a.
{% endhint %}

### Networking

* Moguće je dati pristup funkciji svima na Internetu bez potrebe za bilo kakvom autentifikacijom ili dati pristup na osnovu IAM-a.
* Takođe je moguće dati ili ograničiti pristup Function App-u sa Interneta, dajući pristup unutrašnjoj mreži (VPC) Function App-u.

{% hint style="danger" %}
Ovo je veoma zanimljivo iz perspektive napadača jer bi moglo biti moguće **pivotsati na unutrašnje mreže** iz ranjive Lambda funkcije izložene Internetu.
{% endhint %}

### **Environment Variables**

moguće je konfigurisati promenljive okruženja unutar aplikacije. Štaviše, po defaultu, env promenljive **`AzureWebJobsStorage`** i **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`** (među ostalima) se kreiraju. Ove su posebno zanimljive jer **sadrže ključ naloga za kontrolu sa POTPUNIM dozvolama nad storage nalogom koji sadrži podatke aplikacije**.

### **Function Sandbox**

Unutar sandbox-a, izvorni kod se nalazi u **`/home/site/wwwroot`** u datoteci **`function_app.py`** (ako se koristi python), korisnik koji pokreće kod je **`app`** (bez sudo dozvola).

### **Managed Identities**

Štaviše, Function App može imati određene krajnje tačke koje zahtevaju određeni nivo autentifikacije, kao što su "admin" ili "anonymous".\
Napadač bi mogao pokušati da pristupi **anonimnim dozvoljenim krajnjim tačkama** kako bi zaobišao ograničenja i dobio pristup osetljivim podacima ili funkcionalnosti.

## Access Keys

{% hint style="info" %}
Napomena da ne postoje RBAC dozvole za davanje pristupa korisnicima da pozivaju funkcije. **Poziv funkcije zavisi od okidača** odabranog prilikom kreiranja i ako je odabran HTTP Trigger, možda će biti potrebno koristiti **pristupni ključ**.
{% endhint %}

Kada kreirate krajnju tačku unutar funkcije koristeći **HTTP trigger**, moguće je naznačiti **nivo autorizacije pristupnog ključa** potreban za pokretanje funkcije. Dostupne su tri opcije:

* **ANONYMOUS**: **Svi** mogu pristupiti funkciji putem URL-a.
* **FUNCTION**: Krajnja tačka je dostupna samo korisnicima koji koriste **funkcijski, host ili master ključ**.
* **ADMIN**: Krajnja tačka je dostupna samo korisnicima sa **master ključem**.

**Tipovi ključeva:**

* **Function Keys:** Ključevi funkcija mogu biti ili podrazumevani ili korisnički definisani i dizajnirani su da daju pristup isključivo **određenim funkcijskim krajnjim tačkama** unutar Function App-a. Ovo omogućava fino podešavanje sigurnosne kontrole, osiguravajući da samo ovlašćeni korisnici ili servisi mogu pozvati određene funkcije bez izlaganja cele aplikacije.
* **Host Keys:** Host ključevi, koji takođe mogu biti podrazumevani ili korisnički definisani, pružaju pristup **svim funkcijskim krajnjim tačkama unutar Function App-a**. Ovo je korisno kada je potrebno pristupiti više funkcija koristeći jedan ključ, pojednostavljujući upravljanje i smanjujući broj ključeva koji treba distribuirati ili sigurno čuvati.
* **Master Key:** Master ključ (`_master`) služi kao administrativni ključ koji nudi povišene dozvole, uključujući pristup runtime REST API-ima **Function App-a**. Ovaj **ključ se ne može opozvati i treba ga rukovati sa najvećom pažnjom**. Ključno je **ne** deliti master ključ sa trećim stranama ili ga uključivati u native klijentske aplikacije kako bi se sprečio neovlašćeni administrativni pristup.
* Kada se postavi autentifikacija funkcije na ADMIN (a ne ANONYMOUS ili FUNCTION), potrebno je koristiti ovaj ključ.
* **System Keys:** Sistem ključevi su **upravljački od strane specifičnih ekstenzija** i potrebni su za pristup webhook krajnjim tačkama koje koriste unutrašnji komponenti. Primeri uključuju Event Grid trigger i Durable Functions, koji koriste sistem ključeve za sigurno interagovanje sa svojim API-ima. Sistem ključevi se mogu regenerisati putem Azure Portala ili ključ API-a kako bi se održala sigurnost.

{% hint style="success" %}
Example to access a function API endpoint using a key:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumeration

{% code overflow="wrap" %}
```bash
# List all the functions
az functionapp list

# Get info of 1 funciton (although in the list you already get this info)
az functionapp show --name <app-name> --resource-group <res-group>

# Get env variables (and privesc tot he sorage account)
az functionapp config appsettings list --name <app-name> --resource-group <res-group>

# Check if a domain was assigned to a function app
az functionapp config hostname list --webapp-name <app-name> --resource-group <res-group>

# Get SSL certificates
az functionapp config ssl list --resource-group <res-group>

# Get network restrictions
az functionapp config access-restriction show --name <app-name> --resource-group <res-group>
```
{% endcode %}

## Eskalacija privilegija

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Reference

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Učite i vežbajte AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Učite i vežbajte GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Podržite HackTricks</summary>

* Proverite [**planove pretplate**](https://github.com/sponsors/carlospolop)!
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Podelite hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
{% endhint %}
