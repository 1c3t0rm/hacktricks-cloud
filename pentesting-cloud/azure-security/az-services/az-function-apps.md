# Az - Function Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the**  [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Podstawowe informacje

Azure Functions to **rozwizanie bezserwerowe**, kt贸re pozwala pisa mniej kodu, utrzymywa mniej infrastruktury i oszczdza na kosztach. Zamiast martwi si o wdra偶anie i utrzymanie serwer贸w, infrastruktura chmurowa zapewnia wszystkie aktualne zasoby potrzebne do utrzymania aplikacji w dziaaniu.

W portalu Azure integracja midzy Azure Functions a Azure API Management jest uatwiona, co pozwala na **ujawnienie punkt贸w kocowych funkcji wyzwalanych przez HTTP jako interfejs贸w REST API**. API ujawnione w ten spos贸b s opisane za pomoc definicji OpenAPI, co zapewnia standardowy, niezale偶ny od jzyka interfejs do interfejs贸w RESTful.

### R贸偶ne plany

* **Plan Flex Consumption** oferuje dynamiczne, oparte na zdarzeniach skalowanie z elastycznymi opcjami obliczeniowymi. Automatycznie dodaje lub usuwa instancje funkcji w zale偶noci od popytu, zapewniajc efektywne wykorzystanie zasob贸w i opacalno dziki modelowi **pa w miar korzystania**. Ten plan obsuguje wirtualne sieci dla zwikszonego bezpieczestwa i pozwala na zmniejszenie zimnych start贸w poprzez wstpne przydzielanie instancji. Jest idealny dla aplikacji, kt贸re dowiadczaj zmiennych obci偶e i wymagaj szybkiego skalowania bez potrzeby wsparcia kontener贸w.
* Tradycyjny **plan Consumption** dla Azure Functions to domylna opcja hostingu bezserwerowego, w kt贸rej pacisz tylko za zasoby obliczeniowe, gdy twoje funkcje s uruchomione. Automatycznie skaluje si w zale偶noci od liczby nadchodzcych zdarze, co czyni go bardzo opacalnym dla aplikacji o przerywanym lub nieprzewidywalnym obci偶eniu. Chocia偶 nie obsuguje wdro偶e kontenerowych, zawiera optymalizacje majce na celu skr贸cenie czas贸w zimnego startu i jest odpowiedni dla szerokiego zakresu aplikacji bezserwerowych, kt贸re wymagaj automatycznego skalowania bez obci偶enia zarzdzania infrastruktur.
* **Plan Premium** dla Azure Functions jest zaprojektowany dla aplikacji, kt贸re potrzebuj staej wydajnoci i zaawansowanych funkcji. Automatycznie skaluje si w zale偶noci od popytu, korzystajc z wstpnie podgrzanych pracownik贸w, eliminujc zimne starty i zapewniajc, 偶e funkcje dziaaj szybko nawet po okresach bezczynnoci. Ten plan oferuje pot偶niejsze instancje, wydu偶one czasy wykonania i obsuguje czno z wirtualn sieci. Dodatkowo pozwala na u偶ycie niestandardowych obraz贸w Linux, co czyni go odpowiednim dla aplikacji krytycznych, kt贸re wymagaj wysokiej wydajnoci i wikszej kontroli nad zasobami.
* **Plan Dedicated**, znany r贸wnie偶 jako plan App Service, uruchamia twoje funkcje na dedykowanych maszynach wirtualnych w rodowisku App Service. Ten plan zapewnia przewidywalne rozliczenia i pozwala na rczne lub automatyczne skalowanie instancji, co czyni go idealnym dla scenariuszy dugoterminowych, w kt贸rych Durable Functions nie s odpowiednie. Obsuguje uruchamianie wielu aplikacji webowych i funkcji w tym samym planie, oferuje wiksze rozmiary obliczeniowe i zapewnia pen izolacj obliczeniow oraz bezpieczny dostp do sieci poprzez rodowiska App Service (ASE). Ta opcja jest najlepsza dla aplikacji, kt贸re potrzebuj staej alokacji zasob贸w i rozbudowanej personalizacji.
* **Container Apps** umo偶liwiaj wdra偶anie konteneryzowanych aplikacji funkcji w w peni zarzdzanym rodowisku hostowanym przez Azure Container Apps. Ta opcja jest idealna do budowania aplikacji bezserwerowych opartych na zdarzeniach, kt贸re dziaaj obok innych mikroserwis贸w, API i przepyw贸w pracy. Obsuguje pakowanie niestandardowych bibliotek z kodem funkcji, migracj aplikacji dziedzicznych do mikroserwis贸w natywnych w chmurze oraz wykorzystanie zaawansowanej mocy obliczeniowej z zasobami GPU. Container Apps upraszczaj wdra偶anie, eliminujc potrzeb zarzdzania klastrami Kubernetes, co czyni je idealnymi dla deweloper贸w poszukujcych elastycznoci i skalowalnoci w konteneryzowanym rodowisku.

### **Koszyki pamici**

Podczas tworzenia nowej aplikacji funkcji, kt贸ra nie jest konteneryzowana (ale dostarcza kod do uruchomienia), **kod i inne dane zwizane z funkcj bd przechowywane w koncie pamici**. Domylnie konsola internetowa utworzy now dla ka偶dej funkcji, aby przechowa kod.

Ponadto, gdy nowa instancja aplikacji musi by uruchomiona, **kod aplikacji bdzie zbierany std i wykonywany**.

{% hint style="danger" %}
To jest bardzo interesujce z perspektywy atakujcego, poniewa偶 **dostp do zapisu w tym koszyku** pozwoli atakujcemu na **kompromitacj kodu i eskalacj uprawnie** do zarzdzanych to偶samoci wewntrz aplikacji funkcji.
{% endhint %}

### Sieci

* Mo偶liwe jest udzielenie dostpu do funkcji wszystkim u偶ytkownikom Internetu bez wymagania jakiejkolwiek autoryzacji lub udzielenie dostpu na podstawie IAM.
* Mo偶liwe jest r贸wnie偶 udzielenie lub ograniczenie dostpu do aplikacji funkcji z Internetu, udzielajc dostpu do wewntrznej sieci (VPC) do aplikacji funkcji.

{% hint style="danger" %}
To jest bardzo interesujce z perspektywy atakujcego, poniewa偶 mo偶e by mo偶liwe **przejcie do wewntrznych sieci** z podatnej funkcji Lambda wystawionej na Internet.
{% endhint %}

### **Aplikacje funkcji obsuguj zarzdzane to偶samoci.**

Ponadto aplikacja funkcji mo偶e mie pewne punkty kocowe, kt贸re wymagaj okrelonego poziomu autoryzacji, takich jak "admin" lub "anonimowy".\
Atakujcy mo偶e spr贸bowa uzyska dostp do **dozwolonych punkt贸w kocowych anonimowych**, aby obej ograniczenia i uzyska dostp do wra偶liwych danych lub funkcjonalnoci.

## Klucze dostpu

{% hint style="info" %}
Nale偶y zauwa偶y, 偶e nie ma uprawnie RBAC, aby udzieli u偶ytkownikom dostpu do wywoywania funkcji. **Wywoanie funkcji zale偶y od wyzwalacza** wybranego podczas jej tworzenia, a jeli wybrano wyzwalacz HTTP, mo偶e by konieczne u偶ycie **klucza dostpu**.
{% endhint %}

Podczas tworzenia punktu kocowego wewntrz funkcji za pomoc **wyzwalacza HTTP** mo偶liwe jest wskazanie **poziomu autoryzacji klucza dostpu** potrzebnego do wywoania funkcji. Dostpne s trzy opcje:

* **ANONIMOWY**: **Ka偶dy** mo偶e uzyska dostp do funkcji za pomoc URL.
* **FUNKCJA**: Punkt kocowy jest dostpny tylko dla u偶ytkownik贸w korzystajcych z **klucza funkcji, hosta lub klucza g贸wnego**.
* **ADMIN**: Punkt kocowy jest dostpny tylko dla u偶ytkownik贸w z **kluczem g贸wnym**.

**Rodzaje kluczy:**

* **Klucze funkcji:** Klucze funkcji mog by domylne lub zdefiniowane przez u偶ytkownika i s zaprojektowane w celu przyznania dostpu wycznie do **konkretnych punkt贸w kocowych funkcji** w aplikacji funkcji. Umo偶liwia to precyzyjn kontrol bezpieczestwa, zapewniajc, 偶e tylko autoryzowani u偶ytkownicy lub usugi mog wywoywa konkretne funkcje bez nara偶ania caej aplikacji.
* **Klucze hosta:** Klucze hosta, kt贸re mog by r贸wnie偶 domylne lub zdefiniowane przez u偶ytkownika, zapewniaj dostp do **wszystkich punkt贸w kocowych funkcji w aplikacji funkcji**. Jest to przydatne, gdy wiele funkcji musi by dostpnych za pomoc jednego klucza, co upraszcza zarzdzanie i zmniejsza liczb kluczy, kt贸re musz by dystrybuowane lub przechowywane w spos贸b bezpieczny.
* **Klucz g贸wny:** Klucz g贸wny (`_master`) su偶y jako klucz administracyjny, kt贸ry oferuje podwy偶szone uprawnienia, w tym dostp do interfejs贸w API REST czasu wykonywania **aplikacji funkcji**. Ten **klucz nie mo偶e by cofnity i powinien by traktowany z najwy偶sz ostro偶noci**. Wa偶ne jest, aby **nie** udostpnia klucza g贸wnego osobom trzecim ani nie umieszcza go w natywnych aplikacjach klienckich, aby zapobiec nieautoryzowanemu dostpowi administracyjnemu.
* Ustawiajc autoryzacj funkcji na ADMIN (a nie ANONIMOWY lub FUNKCJA), konieczne jest u偶ycie tego klucza.
* **Klucze systemowe:** Klucze systemowe s **zarzdzane przez konkretne rozszerzenia** i s wymagane do uzyskania dostpu do punkt贸w kocowych webhook贸w u偶ywanych przez wewntrzne komponenty. Przykady obejmuj wyzwalacz Event Grid i Durable Functions, kt贸re wykorzystuj klucze systemowe do bezpiecznej interakcji z ich odpowiednimi interfejsami API. Klucze systemowe mog by regenerowane za porednictwem portalu Azure lub interfejs贸w API kluczy w celu utrzymania bezpieczestwa.

{% hint style="success" %}
Przykad dostpu do punktu kocowego API funkcji za pomoc klucza:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumeracja
```powershell
# Get only Function Apps
Get-AzFunctionApp
```
## Eskalacja Uprawnie

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Odniesienia

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Ucz si i wicz Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Ucz si i wicz Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Wsparcie dla HackTricks</summary>

* Sprawd藕 [**plany subskrypcyjne**](https://github.com/sponsors/carlospolop)!
* **Docz do**  [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegram**](https://t.me/peass) lub **led藕** nas na **Twitterze**  [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Dziel si trikami hackingowymi, przesyajc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytori贸w github.

</details>
{% endhint %}
