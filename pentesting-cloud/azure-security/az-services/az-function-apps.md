# Az - Function Apps

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

## Informa√ß√µes B√°sicas

Azure Functions √© uma **solu√ß√£o sem servidor** que permite escrever menos c√≥digo, manter menos infraestrutura e economizar custos. Em vez de se preocupar com a implanta√ß√£o e manuten√ß√£o de servidores, a infraestrutura em nuvem fornece todos os recursos atualizados necess√°rios para manter suas aplica√ß√µes em funcionamento.

No portal do Azure, a integra√ß√£o entre Azure Functions e Azure API Management √© facilitada, permitindo que **os endpoints de fun√ß√£o acionados por HTTP sejam expostos como APIs REST**. As APIs expostas dessa maneira s√£o descritas usando uma defini√ß√£o OpenAPI, fornecendo uma interface padr√£o e independente de linguagem para APIs RESTful.

### Diferentes Planos

* O **plano Flex Consumption** oferece escalonamento din√¢mico e orientado a eventos com op√ß√µes de computa√ß√£o flex√≠veis. Ele adiciona ou remove automaticamente inst√¢ncias de fun√ß√£o com base na demanda, garantindo uso eficiente de recursos e custo-benef√≠cio por meio de um **modelo de pagamento conforme o uso**. Este plano suporta redes virtuais para maior seguran√ßa e permite reduzir os in√≠cios a frio por meio da pr√©-provisionamento de inst√¢ncias. √â ideal para aplica√ß√µes que experimentam cargas de trabalho vari√°veis e requerem escalonamento r√°pido sem a necessidade de suporte a cont√™ineres.
* O plano tradicional **Consumption** para Azure Functions √© a op√ß√£o de hospedagem sem servidor padr√£o, onde voc√™ paga apenas pelos recursos de computa√ß√£o quando suas fun√ß√µes est√£o em execu√ß√£o. Ele escala automaticamente com base no n√∫mero de eventos recebidos, tornando-se altamente econ√¥mico para aplica√ß√µes com cargas de trabalho intermitentes ou imprevis√≠veis. Embora n√£o suporte implanta√ß√µes de cont√™iner, inclui otimiza√ß√µes para reduzir os tempos de in√≠cio a frio e √© adequado para uma ampla gama de aplica√ß√µes sem servidor que requerem escalonamento autom√°tico sem a sobrecarga de gerenciar infraestrutura.
* O **plano Premium** para Azure Functions √© projetado para aplica√ß√µes que precisam de desempenho consistente e recursos avan√ßados. Ele escala automaticamente com base na demanda usando trabalhadores pr√©-aquecidos, eliminando in√≠cios a frio e garantindo que as fun√ß√µes sejam executadas prontamente mesmo ap√≥s per√≠odos de inatividade. Este plano oferece inst√¢ncias mais poderosas, tempos de execu√ß√£o estendidos e suporta conectividade de rede virtual. Al√©m disso, permite o uso de imagens personalizadas do Linux, tornando-o adequado para aplica√ß√µes cr√≠ticas que requerem alto desempenho e maior controle sobre os recursos.
* O **plano Dedicado**, tamb√©m conhecido como plano App Service, executa suas fun√ß√µes em m√°quinas virtuais dedicadas dentro de um ambiente App Service. Este plano fornece faturamento previs√≠vel e permite escalonamento manual ou autom√°tico de inst√¢ncias, tornando-o ideal para cen√°rios de longa dura√ß√£o onde Durable Functions n√£o s√£o adequadas. Ele suporta a execu√ß√£o de v√°rios aplicativos web e de fun√ß√£o no mesmo plano, oferece tamanhos de computa√ß√£o maiores e garante total isolamento de computa√ß√£o e acesso seguro √† rede por meio de Ambientes de Servi√ßo de Aplicativo (ASE). Esta op√ß√£o √© a melhor para aplica√ß√µes que precisam de aloca√ß√£o consistente de recursos e personaliza√ß√£o extensiva.
* **Container Apps** permitem implantar aplicativos de fun√ß√£o em cont√™ineres dentro de um ambiente totalmente gerenciado hospedado pelo Azure Container Apps. Esta op√ß√£o √© perfeita para construir aplica√ß√µes sem servidor orientadas a eventos que funcionam ao lado de outros microsservi√ßos, APIs e fluxos de trabalho. Suporta o empacotamento de bibliotecas personalizadas com seu c√≥digo de fun√ß√£o, migrando aplica√ß√µes legadas para microsservi√ßos nativos da nuvem e aproveitando o poder de processamento de ponta com recursos de GPU. Container Apps simplificam a implanta√ß√£o ao eliminar a necessidade de gerenciar clusters Kubernetes, tornando-os ideais para desenvolvedores que buscam flexibilidade e escalabilidade em um ambiente de cont√™iner.

### **Buckets de Armazenamento**

Ao criar um novo Function App n√£o cont√™inerizado (mas fornecendo o c√≥digo para executar), o **c√≥digo e outros dados relacionados √† fun√ß√£o ser√£o armazenados em uma conta de Armazenamento**. Por padr√£o, o console da web criar√° um novo por fun√ß√£o para armazenar o c√≥digo.

Al√©m disso, sempre que uma nova inst√¢ncia do aplicativo precisar ser executada, o **c√≥digo do aplicativo ser√° coletado daqui e executado**.

{% hint style="danger" %}
Isso √© muito interessante do ponto de vista de um atacante, pois **o acesso de grava√ß√£o sobre este bucket** permitir√° que um atacante **comprometa o c√≥digo e eleve privil√©gios** para as identidades gerenciadas dentro do Function App.
{% endhint %}

### Rede

* √â poss√≠vel dar acesso a uma fun√ß√£o para toda a Internet sem exigir qualquer autentica√ß√£o ou dar acesso baseado em IAM.
* Tamb√©m √© poss√≠vel dar ou restringir o acesso ao Function App a partir da Internet, dando acesso a uma rede interna (VPC) ao Function App.

{% hint style="danger" %}
Isso √© muito interessante do ponto de vista de um atacante, pois pode ser poss√≠vel **pivotar para redes internas** a partir de uma fun√ß√£o Lambda vulner√°vel exposta √† Internet.
{% endhint %}

### **Vari√°veis de Ambiente**

√â poss√≠vel configurar vari√°veis de ambiente dentro de um aplicativo. Al√©m disso, por padr√£o, as vari√°veis de ambiente **`AzureWebJobsStorage`** e **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`** (entre outras) s√£o criadas. Estas s√£o especialmente interessantes porque **cont√™m a chave da conta para controlar com PERMISS√ïES COMPLETAS a conta de armazenamento contendo os dados da aplica√ß√£o**.

### **Sandbox de Fun√ß√£o**

Dentro da sandbox, o c√≥digo-fonte est√° localizado em **`/home/site/wwwroot`** no arquivo **`function_app.py`** (se o Python for usado) e o usu√°rio que executa o c√≥digo √© **`app`** (sem permiss√µes sudo).

### **Identidades Gerenciadas**

Al√©m disso, o Function App pode ter certos endpoints que requerem um certo n√≠vel de autentica√ß√£o, como "admin" ou "an√¥nimo".\
Um atacante poderia tentar acessar os **endpoints permitidos an√¥nimos** para contornar as restri√ß√µes e obter acesso a dados ou funcionalidades sens√≠veis.

## Chaves de Acesso

{% hint style="info" %}
Observe que n√£o h√° permiss√µes RBAC para dar acesso aos usu√°rios para invocar as fun√ß√µes. A **invoca√ß√£o da fun√ß√£o depende do gatilho** selecionado quando foi criada e, se um Gatilho HTTP foi selecionado, pode ser necess√°rio usar uma **chave de acesso**.
{% endhint %}

Ao criar um endpoint dentro de uma fun√ß√£o usando um **gatilho HTTP**, √© poss√≠vel indicar o **n√≠vel de autoriza√ß√£o da chave de acesso** necess√°rio para acionar a fun√ß√£o. Tr√™s op√ß√µes est√£o dispon√≠veis:

* **AN√îNIMO**: **Todos** podem acessar a fun√ß√£o pela URL.
* **FUN√á√ÉO**: O endpoint √© acess√≠vel apenas para usu√°rios usando uma **chave de fun√ß√£o, host ou mestre**.
* **ADMIN**: O endpoint √© acess√≠vel apenas para usu√°rios com uma **chave mestre**.

**Tipo de chaves:**

* **Chaves de Fun√ß√£o:** As chaves de fun√ß√£o podem ser padr√£o ou definidas pelo usu√°rio e s√£o projetadas para conceder acesso exclusivamente a **endpoints de fun√ß√£o espec√≠ficos** dentro de um Function App. Isso permite um controle de seguran√ßa mais granular, garantindo que apenas usu√°rios ou servi√ßos autorizados possam invocar fun√ß√µes espec√≠ficas sem expor toda a aplica√ß√£o.
* **Chaves de Host:** As chaves de host, que tamb√©m podem ser padr√£o ou definidas pelo usu√°rio, fornecem acesso a **todos os endpoints de fun√ß√£o dentro de um Function App**. Isso √© √∫til quando v√°rias fun√ß√µes precisam ser acessadas usando uma √∫nica chave, simplificando a gest√£o e reduzindo o n√∫mero de chaves que precisam ser distribu√≠das ou armazenadas com seguran√ßa.
* **Chave Mestre:** A chave mestre (`_master`) serve como uma chave administrativa que oferece permiss√µes elevadas, incluindo acesso √†s APIs REST de tempo de execu√ß√£o **de um Function App**. Esta **chave n√£o pode ser revogada e deve ser tratada com o m√°ximo cuidado**. √â crucial **n√£o** compartilhar a chave mestre com terceiros ou inclu√≠-la em aplica√ß√µes cliente nativas para evitar acesso administrativo n√£o autorizado.
* Ao definir a autentica√ß√£o de uma fun√ß√£o como ADMIN (e n√£o AN√îNIMO ou FUN√á√ÉO), √© necess√°rio usar esta chave.
* **Chaves de Sistema:** As chaves de sistema s√£o **gerenciadas por extens√µes espec√≠ficas** e s√£o necess√°rias para acessar endpoints de webhook usados por componentes internos. Exemplos incluem o gatilho do Event Grid e Durable Functions, que utilizam chaves de sistema para interagir com suas respectivas APIs de forma segura. As chaves de sistema podem ser regeneradas atrav√©s do Portal do Azure ou APIs de chave para manter a seguran√ßa.

{% hint style="success" %}
Exemplo para acessar um endpoint de API de fun√ß√£o usando uma chave:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumera√ß√£o

{% code overflow="wrap" %}
```bash
# List all the functions
az functionapp list

# Get info of 1 funciton (although in the list you already get this info)
az functionapp show --name <app-name> --resource-group <res-group>

# Get env variables (and privesc tot he sorage account)
az functionapp config appsettings list --name <app-name> --resource-group <res-group>

# Check if a domain was assigned to a function app
az functionapp config hostname list --webapp-name <app-name> --resource-group <res-group>

# Get SSL certificates
az functionapp config ssl list --resource-group <res-group>

# Get network restrictions
az functionapp config access-restriction show --name <app-name> --resource-group <res-group>
```
{% endcode %}

## Escala√ß√£o de Privil√©gios

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Suporte ao HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}
