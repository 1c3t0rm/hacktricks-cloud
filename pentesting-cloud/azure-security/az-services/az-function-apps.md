# Az - Function Apps

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

## Informazioni di base

Azure Functions √® una soluzione **serverless** che ti consente di scrivere meno codice, mantenere meno infrastruttura e risparmiare sui costi. Invece di preoccuparti di distribuire e mantenere server, l'infrastruttura cloud fornisce tutte le risorse aggiornate necessarie per mantenere le tue applicazioni in esecuzione.

Nel portale di Azure, l'integrazione tra Azure Functions e Azure API Management √® facilitata, consentendo che **gli endpoint delle funzioni attivate da HTTP siano esposti come API REST**. Le API esposte in questo modo sono descritte utilizzando una definizione OpenAPI, fornendo un'interfaccia standard, indipendente dal linguaggio, per le API RESTful.

### Piani diversi

* Il **piano Flex Consumption** offre scalabilit√† dinamica e basata su eventi con opzioni di calcolo flessibili. Aggiunge o rimuove automaticamente le istanze della funzione in base alla domanda, garantendo un uso efficiente delle risorse e un buon rapporto costo-efficacia attraverso un **modello pay-as-you-go**. Questo piano supporta il networking virtuale per una maggiore sicurezza e consente di ridurre i tempi di avvio a freddo pre-provisionando le istanze. √à ideale per applicazioni che presentano carichi di lavoro variabili e richiedono scalabilit√† rapida senza la necessit√† di supporto per container.
* Il tradizionale **piano Consumption** per Azure Functions √® l'opzione di hosting serverless predefinita, in cui paghi solo per le risorse di calcolo quando le tue funzioni sono in esecuzione. Si scala automaticamente in base al numero di eventi in arrivo, rendendolo altamente conveniente per applicazioni con carichi di lavoro intermittenti o imprevedibili. Sebbene non supporti le distribuzioni di container, include ottimizzazioni per ridurre i tempi di avvio a freddo ed √® adatto per una vasta gamma di applicazioni serverless che richiedono scalabilit√† automatica senza l'onere di gestire l'infrastruttura.
* Il **piano Premium** per Azure Functions √® progettato per applicazioni che necessitano di prestazioni costanti e funzionalit√† avanzate. Si scala automaticamente in base alla domanda utilizzando lavoratori pre-riscaldati, eliminando i tempi di avvio a freddo e garantendo che le funzioni vengano eseguite prontamente anche dopo periodi di inattivit√†. Questo piano offre istanze pi√π potenti, tempi di esecuzione prolungati e supporta la connettivit√† di rete virtuale. Inoltre, consente l'uso di immagini Linux personalizzate, rendendolo adatto per applicazioni mission-critical che richiedono alte prestazioni e maggiore controllo sulle risorse.
* Il **piano Dedicated**, noto anche come piano App Service, esegue le tue funzioni su macchine virtuali dedicate all'interno di un ambiente App Service. Questo piano fornisce una fatturazione prevedibile e consente la scalabilit√† manuale o automatica delle istanze, rendendolo ideale per scenari a lungo termine in cui le Durable Functions non sono adatte. Supporta l'esecuzione di pi√π app web e funzioni sullo stesso piano, offre dimensioni di calcolo maggiori e garantisce piena isolamento di calcolo e accesso sicuro alla rete attraverso gli App Service Environments (ASE). Questa opzione √® migliore per applicazioni che necessitano di allocazione costante delle risorse e ampie personalizzazioni.
* **Container Apps** ti consentono di distribuire app di funzione containerizzate all'interno di un ambiente completamente gestito ospitato da Azure Container Apps. Questa opzione √® perfetta per costruire applicazioni serverless basate su eventi che funzionano insieme ad altri microservizi, API e flussi di lavoro. Supporta il packaging di librerie personalizzate con il tuo codice di funzione, la migrazione di applicazioni legacy a microservizi cloud-native e l'utilizzo di potenza di elaborazione di alto livello con risorse GPU. Le Container Apps semplificano la distribuzione eliminando la necessit√† di gestire cluster Kubernetes, rendendole ideali per gli sviluppatori che cercano flessibilit√† e scalabilit√† in un ambiente containerizzato.

### **Storage Buckets**

Quando crei una nuova Function App non containerizzata (ma fornendo il codice da eseguire), il **codice e altri dati relativi alla funzione saranno memorizzati in un account di archiviazione**. Per impostazione predefinita, la console web creer√† un nuovo account per ogni funzione per memorizzare il codice.

Inoltre, ogni volta che √® necessaria l'esecuzione di una nuova istanza dell'app, il **codice dell'app verr√† raccolto da qui ed eseguito**.

{% hint style="danger" %}
Questo √® molto interessante dal punto di vista di un attaccante poich√© **l'accesso in scrittura su questo bucket** consentir√† a un attaccante di **compromettere il codice e aumentare i privilegi** alle identit√† gestite all'interno della Function App.
{% endhint %}

### Networking

* √à possibile dare accesso a una funzione a tutto Internet senza richiedere alcuna autenticazione o dare accesso basato su IAM.
* √à anche possibile dare o limitare l'accesso alla Function App da Internet, dando accesso a una rete interna (VPC) alla Function App.

{% hint style="danger" %}
Questo √® molto interessante dal punto di vista di un attaccante poich√© potrebbe essere possibile **pivotare verso reti interne** da una funzione Lambda vulnerabile esposta a Internet.
{% endhint %}

### **Variabili di ambiente**

√à possibile configurare variabili di ambiente all'interno di un'app. Inoltre, per impostazione predefinita, le variabili di ambiente **`AzureWebJobsStorage`** e **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`** (tra le altre) vengono create. Queste sono particolarmente interessanti perch√© **contengono la chiave dell'account per controllare con PERMESSI COMPLETI l'account di archiviazione contenente i dati dell'applicazione**.

### **Function Sandbox**

All'interno della sandbox, il codice sorgente si trova in **`/home/site/wwwroot`** nel file **`function_app.py`** (se viene utilizzato Python) l'utente che esegue il codice √® **`app`** (senza permessi sudo).

### **Identit√† gestite**

Inoltre, la Function App potrebbe avere determinati endpoint che richiedono un certo livello di autenticazione, come "admin" o "anonymous".\
Un attaccante potrebbe cercare di accedere agli **endpoint consentiti per gli anonimi** per bypassare le restrizioni e ottenere accesso a dati o funzionalit√† sensibili.

## Chiavi di accesso

{% hint style="info" %}
Nota che non ci sono permessi RBAC per dare accesso agli utenti per invocare le funzioni. L'**invocazione della funzione dipende dal trigger** selezionato quando √® stata creata e se √® stato selezionato un Trigger HTTP, potrebbe essere necessario utilizzare una **chiave di accesso**.
{% endhint %}

Quando crei un endpoint all'interno di una funzione utilizzando un **trigger HTTP**, √® possibile indicare il **livello di autorizzazione della chiave di accesso** necessario per attivare la funzione. Sono disponibili tre opzioni:

* **ANONYMOUS**: **Tutti** possono accedere alla funzione tramite l'URL.
* **FUNCTION**: L'endpoint √® accessibile solo agli utenti che utilizzano una **chiave di funzione, host o master**.
* **ADMIN**: L'endpoint √® accessibile solo agli utenti con una **chiave master**.

**Tipo di chiavi:**

* **Chiavi di funzione:** Le chiavi di funzione possono essere predefinite o definite dall'utente e sono progettate per concedere accesso esclusivamente a **specifici endpoint di funzione** all'interno di una Function App. Questo consente un controllo di sicurezza dettagliato, garantendo che solo utenti o servizi autorizzati possano invocare funzioni particolari senza esporre l'intera applicazione.
* **Chiavi host:** Le chiavi host, che possono essere anch'esse predefinite o definite dall'utente, forniscono accesso a **tutti gli endpoint di funzione all'interno di una Function App**. Questo √® utile quando pi√π funzioni devono essere accessibili utilizzando una singola chiave, semplificando la gestione e riducendo il numero di chiavi che devono essere distribuite o memorizzate in modo sicuro.
* **Chiave master:** La chiave master (`_master`) funge da chiave amministrativa che offre permessi elevati, inclusi l'accesso alle API REST runtime **di una Function App**. Questa **chiave non pu√≤ essere revocata e deve essere gestita con la massima attenzione**. √à fondamentale **non** condividere la chiave master con terze parti o includerla in applicazioni client native per prevenire accessi amministrativi non autorizzati.
* Quando si imposta l'autenticazione di una funzione su ADMIN (e non ANONYMOUS o FUNCTION), √® necessario utilizzare questa chiave.
* **Chiavi di sistema:** Le chiavi di sistema sono **gestite da estensioni specifiche** e sono necessarie per accedere agli endpoint webhook utilizzati dai componenti interni. Esempi includono il trigger Event Grid e le Durable Functions, che utilizzano chiavi di sistema per interagire in modo sicuro con le rispettive API. Le chiavi di sistema possono essere rigenerate tramite il Portale di Azure o le API delle chiavi per mantenere la sicurezza.

{% hint style="success" %}
Esempio per accedere a un endpoint API di funzione utilizzando una chiave:

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## Enumerazione

{% code overflow="wrap" %}
```bash
# List all the functions
az functionapp list

# Get info of 1 funciton (although in the list you already get this info)
az functionapp show --name <app-name> --resource-group <res-group>

# Get env variables (and privesc tot he sorage account)
az functionapp config appsettings list --name <app-name> --resource-group <res-group>

# Check if a domain was assigned to a function app
az functionapp config hostname list --webapp-name <app-name> --resource-group <res-group>

# Get SSL certificates
az functionapp config ssl list --resource-group <res-group>

# Get network restrictions
az functionapp config access-restriction show --name <app-name> --resource-group <res-group>
```
{% endcode %}

## Escalation dei privilegi

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## Riferimenti

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Impara e pratica il hacking AWS:<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Impara e pratica il hacking GCP: <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Supporta HackTricks</summary>

* Controlla i [**piani di abbonamento**](https://github.com/sponsors/carlospolop)!
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos su github.

</details>
{% endhint %}
