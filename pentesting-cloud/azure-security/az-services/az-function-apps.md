# Az - Function Apps

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* V√©rifiez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
{% endhint %}

## Informations de base

Azure Functions est une solution **sans serveur** qui vous permet d'√©crire moins de code, de maintenir moins d'infrastructure et d'√©conomiser sur les co√ªts. Au lieu de vous soucier du d√©ploiement et de la maintenance des serveurs, l'infrastructure cloud fournit toutes les ressources √† jour n√©cessaires pour faire fonctionner vos applications.

Dans le portail Azure, l'int√©gration entre Azure Functions et Azure API Management est facilit√©e, permettant aux **points de terminaison de fonction d√©clench√©s par HTTP d'√™tre expos√©s en tant qu'API REST**. Les API expos√©es de cette mani√®re sont d√©crites √† l'aide d'une d√©finition OpenAPI, fournissant une interface standard, ind√©pendante du langage, pour les API RESTful.

### Diff√©rents plans

* Le **plan Flex Consumption** offre une mise √† l'√©chelle dynamique et bas√©e sur les √©v√©nements avec des options de calcul flexibles. Il ajoute ou supprime automatiquement des instances de fonction en fonction de la demande, garantissant une utilisation efficace des ressources et une rentabilit√© gr√¢ce √† un **mod√®le de paiement √† l'utilisation**. Ce plan prend en charge le r√©seau virtuel pour une s√©curit√© accrue et vous permet de r√©duire les d√©marrages √† froid en pr√©-provisionnant des instances. Il est id√©al pour les applications qui connaissent des charges de travail variables et n√©cessitent une mise √† l'√©chelle rapide sans avoir besoin de support de conteneur.
* Le plan **Consumption** traditionnel pour Azure Functions est l'option d'h√©bergement sans serveur par d√©faut, o√π vous ne payez que pour les ressources de calcul lorsque vos fonctions sont en cours d'ex√©cution. Il s'adapte automatiquement en fonction du nombre d'√©v√©nements entrants, ce qui le rend tr√®s rentable pour les applications avec des charges de travail intermittentes ou impr√©visibles. Bien qu'il ne prenne pas en charge les d√©ploiements de conteneurs, il comprend des optimisations pour r√©duire les temps de d√©marrage √† froid et convient √† un large √©ventail d'applications sans serveur n√©cessitant une mise √† l'√©chelle automatique sans la surcharge de gestion de l'infrastructure.
* Le **plan Premium** pour Azure Functions est con√ßu pour les applications qui n√©cessitent des performances constantes et des fonctionnalit√©s avanc√©es. Il s'adapte automatiquement en fonction de la demande en utilisant des travailleurs pr√©chauff√©s, √©liminant les d√©marrages √† froid et garantissant que les fonctions s'ex√©cutent rapidement m√™me apr√®s des p√©riodes d'inactivit√©. Ce plan offre des instances plus puissantes, des temps d'ex√©cution prolong√©s et prend en charge la connectivit√© au r√©seau virtuel. De plus, il permet l'utilisation d'images Linux personnalis√©es, ce qui le rend adapt√© aux applications critiques n√©cessitant des performances √©lev√©es et un meilleur contr√¥le des ressources.
* Le **plan Dedicated**, √©galement connu sous le nom de plan App Service, ex√©cute vos fonctions sur des machines virtuelles d√©di√©es au sein d'un environnement App Service. Ce plan offre une facturation pr√©visible et permet une mise √† l'√©chelle manuelle ou automatique des instances, ce qui le rend id√©al pour des sc√©narios de longue dur√©e o√π les Durable Functions ne sont pas adapt√©es. Il prend en charge l'ex√©cution de plusieurs applications web et de fonctions sur le m√™me plan, offre des tailles de calcul plus grandes et garantit une isolation compl√®te des calculs et un acc√®s r√©seau s√©curis√© via des environnements App Service (ASE). Cette option est la meilleure pour les applications qui n√©cessitent une allocation de ressources constante et une personnalisation √©tendue.
* **Container Apps** vous permettent de d√©ployer des applications de fonction conteneuris√©es dans un environnement enti√®rement g√©r√© h√©berg√© par Azure Container Apps. Cette option est parfaite pour cr√©er des applications sans serveur bas√©es sur des √©v√©nements qui s'ex√©cutent aux c√¥t√©s d'autres microservices, API et flux de travail. Elle prend en charge l'emballage de biblioth√®ques personnalis√©es avec votre code de fonction, la migration d'applications h√©rit√©es vers des microservices cloud-natifs et l'exploitation d'une puissance de traitement haut de gamme avec des ressources GPU. Les Container Apps simplifient le d√©ploiement en √©liminant le besoin de g√©rer des clusters Kubernetes, ce qui les rend id√©ales pour les d√©veloppeurs recherchant flexibilit√© et √©volutivit√© dans un environnement conteneuris√©.

### **Buckets de stockage**

Lors de la cr√©ation d'une nouvelle Function App non conteneuris√©e (mais fournissant le code √† ex√©cuter), le **code et d'autres donn√©es li√©es √† la fonction seront stock√©s dans un compte de stockage**. Par d√©faut, la console web cr√©era un nouveau compte par fonction pour stocker le code.

De plus, chaque fois qu'une nouvelle instance de l'application doit s'ex√©cuter, le **code de l'application sera r√©cup√©r√© ici et ex√©cut√©**.

{% hint style="danger" %}
C'est tr√®s int√©ressant du point de vue d'un attaquant car **l'acc√®s en √©criture sur ce bucket** permettra √† un attaquant de **compromettre le code et d'escalader les privil√®ges** vers les identit√©s g√©r√©es √† l'int√©rieur de la Function App.
{% endhint %}

### R√©seautage

* Il est possible de donner acc√®s √† une fonction √† tout Internet sans n√©cessiter d'authentification ou de donner un acc√®s bas√© sur IAM.
* Il est √©galement possible de donner ou de restreindre l'acc√®s √† la Function App depuis Internet en donnant acc√®s √† un r√©seau interne (VPC) √† la Function App.

{% hint style="danger" %}
C'est tr√®s int√©ressant du point de vue d'un attaquant car il pourrait √™tre possible de **pivoter vers des r√©seaux internes** depuis une fonction Lambda vuln√©rable expos√©e √† Internet.
{% endhint %}

### **Variables d'environnement**

Il est possible de configurer des variables d'environnement √† l'int√©rieur d'une application. De plus, par d√©faut, les variables d'environnement **`AzureWebJobsStorage`** et **`WEBSITE_CONTENTAZUREFILECONNECTIONSTRING`** (entre autres) sont cr√©√©es. Celles-ci sont particuli√®rement int√©ressantes car elles **contiennent la cl√© de compte pour contr√¥ler avec des permissions COMPLETES le compte de stockage contenant les donn√©es de l'application**.

### **Sandbox de fonction**

√Ä l'int√©rieur de la sandbox, le code source est situ√© dans **`/home/site/wwwroot`** dans le fichier **`function_app.py`** (si Python est utilis√©) l'utilisateur ex√©cutant le code est **`app`** (sans permissions sudo).

### **Identit√©s g√©r√©es**

De plus, la Function App peut avoir certains points de terminaison qui n√©cessitent un certain niveau d'authentification, comme "admin" ou "anonyme".\
Un attaquant pourrait essayer d'acc√©der aux **points de terminaison autoris√©s anonymes** pour contourner les restrictions et acc√©der √† des donn√©es ou des fonctionnalit√©s sensibles.

## Cl√©s d'acc√®s

{% hint style="info" %}
Notez qu'il n'y a pas de permissions RBAC pour donner acc√®s aux utilisateurs pour invoquer les fonctions. L'**invocation de fonction d√©pend du d√©clencheur** s√©lectionn√© lors de sa cr√©ation et si un d√©clencheur HTTP a √©t√© s√©lectionn√©, il pourrait √™tre n√©cessaire d'utiliser une **cl√© d'acc√®s**.
{% endhint %}

Lors de la cr√©ation d'un point de terminaison √† l'int√©rieur d'une fonction utilisant un **d√©clencheur HTTP**, il est possible d'indiquer le **niveau d'autorisation de cl√© d'acc√®s** n√©cessaire pour d√©clencher la fonction. Trois options sont disponibles :

* **ANONYME** : **Tout le monde** peut acc√©der √† la fonction par l'URL.
* **FONCTION** : Le point de terminaison n'est accessible qu'aux utilisateurs utilisant une **cl√© de fonction, d'h√¥te ou ma√Ætre**.
* **ADMIN** : Le point de terminaison n'est accessible qu'aux utilisateurs avec une **cl√© ma√Ætre**.

**Type de cl√©s :**

* **Cl√©s de fonction :** Les cl√©s de fonction peuvent √™tre soit par d√©faut, soit d√©finies par l'utilisateur et sont con√ßues pour accorder un acc√®s exclusivement √† **des points de terminaison de fonction sp√©cifiques** au sein d'une Function App. Cela permet un contr√¥le de s√©curit√© granulaire, garantissant que seuls les utilisateurs ou services autoris√©s peuvent invoquer des fonctions particuli√®res sans exposer l'ensemble de l'application.
* **Cl√©s d'h√¥te :** Les cl√©s d'h√¥te, qui peuvent √©galement √™tre par d√©faut ou d√©finies par l'utilisateur, fournissent un acc√®s √† **tous les points de terminaison de fonction au sein d'une Function App**. Cela est utile lorsque plusieurs fonctions doivent √™tre accessibles √† l'aide d'une seule cl√©, simplifiant la gestion et r√©duisant le nombre de cl√©s √† distribuer ou √† stocker en toute s√©curit√©.
* **Cl√© ma√Ætre :** La cl√© ma√Ætre (`_master`) sert de cl√© administrative qui offre des permissions √©lev√©es, y compris l'acc√®s aux API REST d'ex√©cution **d'une Function App**. Cette **cl√© ne peut pas √™tre r√©voqu√©e et doit √™tre manipul√©e avec le plus grand soin**. Il est crucial de **ne pas** partager la cl√© ma√Ætre avec des tiers ou de l'inclure dans des applications clientes natives pour √©viter un acc√®s administratif non autoris√©.
* Lors de la d√©finition de l'authentification d'une fonction sur ADMIN (et non ANONYME ou FONCTION), il est n√©cessaire d'utiliser cette cl√©.
* **Cl√©s syst√®me :** Les cl√©s syst√®me sont **g√©r√©es par des extensions sp√©cifiques** et sont n√©cessaires pour acc√©der aux points de terminaison webhook utilis√©s par des composants internes. Des exemples incluent le d√©clencheur Event Grid et les Durable Functions, qui utilisent des cl√©s syst√®me pour interagir en toute s√©curit√© avec leurs API respectives. Les cl√©s syst√®me peuvent √™tre r√©g√©n√©r√©es via le portail Azure ou les API de cl√©s pour maintenir la s√©curit√©.

{% hint style="success" %}
Exemple pour acc√©der √† un point de terminaison API de fonction en utilisant une cl√© :

`https://<function_uniq_name>.azurewebsites.net/api/<endpoint_name>?code=<access_key>`
{% endhint %}

## √ânum√©ration

{% code overflow="wrap" %}
```bash
# List all the functions
az functionapp list

# Get info of 1 funciton (although in the list you already get this info)
az functionapp show --name <app-name> --resource-group <res-group>

# Get env variables (and privesc tot he sorage account)
az functionapp config appsettings list --name <app-name> --resource-group <res-group>

# Check if a domain was assigned to a function app
az functionapp config hostname list --webapp-name <app-name> --resource-group <res-group>

# Get SSL certificates
az functionapp config ssl list --resource-group <res-group>

# Get network restrictions
az functionapp config access-restriction show --name <app-name> --resource-group <res-group>
```
{% endcode %}

## Escalade de privil√®ges

{% content-ref url="../az-privilege-escalation/az-functions-app-privesc.md" %}
[az-functions-app-privesc.md](../az-privilege-escalation/az-functions-app-privesc.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition](https://learn.microsoft.com/en-us/azure/azure-functions/functions-openapi-definition)

{% hint style="success" %}
Apprenez et pratiquez le hacking AWS :<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" data-size="line">\
Apprenez et pratiquez le hacking GCP : <img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="../../../.gitbook/assets/image (2) (1).png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Soutenir HackTricks</summary>

* Consultez les [**plans d'abonnement**](https://github.com/sponsors/carlospolop) !
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous sur** **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez des astuces de hacking en soumettant des PRs aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>
{% endhint %}
