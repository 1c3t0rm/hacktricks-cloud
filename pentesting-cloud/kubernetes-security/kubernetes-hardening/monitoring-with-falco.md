# 使用Falco进行监控

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

本教程摘自[https://madhuakula.com/kubernetes-goat/scenarios/scenario-18.html#scenario-information](https://madhuakula.com/kubernetes-goat/scenarios/scenario-18.html#scenario-information)

### 场景信息

本场景部署了用于容器和Kubernetes资源的运行时安全监控和检测。

* 要开始使用此场景，您可以使用版本3部署以下Helm图表

> 注意：确保使用Helm v3运行以下部署
```bash
helm repo add falcosecurity https://falcosecurity.github.io/charts
helm repo update
helm install falco falcosecurity/falco
```
![Scenario 18 helm falco setup](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-18-1.png)

### [方案解决](https://madhuakula.com/kubernetes-goat/scenarios/scenario-18.html#scenario-solution)

> `Falco`，云原生的运行时安全项目，是事实上的Kubernetes威胁检测引擎。Falco由Sysdig于2016年创建，并成为CNCF的孵化级项目中的第一个运行时安全项目。Falco在运行时检测意外的应用行为，并在威胁发生时发出警报。

Falco使用系统调用来保护和监控系统，具体包括：

* 在运行时解析来自内核的Linux系统调用
* 将流与强大的规则引擎进行断言
* 在违反规则时发出警报

Falco附带了一组默认规则，用于检查内核是否存在异常行为，例如：

* 使用特权容器进行权限提升
* 使用诸如`setns`之类的工具进行命名空间更改
* 读取/写入诸如/etc、/usr/bin、/usr/sbin等众所周知的目录
* 创建符号链接
* 所有权和模式更改
* 意外的网络连接或套接字变化
* 使用execve生成的进程
* 执行sh、bash、csh、zsh等shell二进制文件
* 执行ssh、scp、sftp等SSH二进制文件
* 变异Linux核心工具可执行文件
* 变异登录二进制文件
* 变异shadowutil或passwd可执行文件，例如shadowconfig、pwck、chpasswd、getpasswd、change、useradd等等。
* 获取有关falco部署的更多详细信息
```bash
kubectl get pods --selector app=falco
```
![Scenario 18 falco get pods](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-18-2.png)

* 从falco系统手动获取日志

```bash
$ kubectl get pods -n falco
```

* 获取falco命名空间中的pod列表

```bash
$ kubectl logs -n falco <pod_name>
```

* 获取特定pod的日志

```bash
$ kubectl logs -n falco <pod_name> -c falco
```

* 获取特定pod中falco容器的日志
```bash
kubectl logs -f -l app=falco
```
* 现在，让我们启动一个黑客容器并读取敏感文件，看看Falco是否能检测到。
```bash
kubectl run --rm --restart=Never -it --image=madhuakula/hacker-container -- bash
```
* 读取敏感文件

```bash
kubectl exec -it <pod_name> -- cat <file_path>
```

使用`kubectl exec`命令以交互模式进入Pod，并使用`cat`命令读取指定的文件路径。
```bash
cat /etc/shadow
```
![Scenario 18 falco detect /etc/shadow](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-18-3.png)

<details>

<summary><strong>支持 HackTricks 并获得福利！</strong></summary>

* 如果您想在 HackTricks 中看到您的公司广告，或者如果您想访问 PEASS 的最新版本或下载 PDF 版的 HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向 HackTricks 和 HackTricks Cloud 的 GitHub 仓库提交 PR 来分享您的黑客技巧。**

</details>
