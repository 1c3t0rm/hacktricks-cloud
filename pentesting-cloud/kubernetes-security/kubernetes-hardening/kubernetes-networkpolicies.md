# Pol√≠ticas de Rede do Kubernetes

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

**Este tutorial foi retirado de** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html)

### Informa√ß√µes do Cen√°rio

Este cen√°rio implanta uma pol√≠tica simples de seguran√ßa de rede para recursos do Kubernetes para criar limites de seguran√ßa.

* Para come√ßar com este cen√°rio, certifique-se de estar usando uma solu√ß√£o de rede que suporte `NetworkPolicy`

### Solu√ß√£o do Cen√°rio

* O cen√°rio abaixo √© de [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)

Se voc√™ deseja controlar o fluxo de tr√°fego no n√≠vel de endere√ßo IP ou porta (camada OSI 3 ou 4), pode considerar o uso de Pol√≠ticas de Rede do Kubernetes para aplicativos espec√≠ficos em seu cluster. As Pol√≠ticas de Rede s√£o uma constru√ß√£o centrada em aplicativos que permitem especificar como um pod pode se comunicar com v√°rias "entidades" de rede (usamos a palavra "entidade" aqui para evitar sobrecarregar os termos mais comuns, como "endpoints" e "servi√ßos", que t√™m conota√ß√µes espec√≠ficas do Kubernetes) pela rede.

As entidades com as quais um Pod pode se comunicar s√£o identificadas por meio de uma combina√ß√£o dos seguintes 3 identificadores

1. Outros pods que s√£o permitidos (exce√ß√£o: um pod n√£o pode bloquear o acesso a si mesmo) Namespaces que s√£o permitidos
2. Blocos de IP (exce√ß√£o: o tr√°fego de e para o n√≥ em que um Pod est√° sendo executado √© sempre permitido, independentemente do endere√ßo IP do Pod ou do n√≥)
3. Ao definir uma Pol√≠tica de Rede baseada em pod ou namespace, voc√™ usa um seletor para especificar qual tr√°fego √© permitido para e a partir do(s) Pod(s) que correspondem ao seletor.

Enquanto isso, quando as Pol√≠ticas de Rede baseadas em IP s√£o criadas, definimos pol√≠ticas com base em blocos de IP (intervalos CIDR).

* Vamos criar uma pol√≠tica de NEGAR todo o tr√°fego para um aplicativo

> Esta Pol√≠tica de Rede ir√° bloquear todo o tr√°fego para pods de um aplicativo, selecionados usando Selectors de Pod.

Casos de uso:

* √â muito comum: Para come√ßar a permitir o tr√°fego usando Pol√≠ticas de Rede, primeiro voc√™ precisa bloquear o tr√°fego usando esta pol√≠tica.
* Voc√™ deseja executar um Pod e deseja impedir que outros Pods se comuniquem com ele.
* Voc√™ deseja isolar temporariamente o tr√°fego para um Servi√ßo de outros Pods.

![Cen√°rio 20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### Exemplo

* Execute um Pod nginx com r√≥tulos `app=web` e exponha-o na porta 80

```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```

* Execute um Pod tempor√°rio e fa√ßa uma solicita√ß√£o ao Servi√ßo `web`

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# Voc√™ ver√° a sa√≠da abaixo
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```

* Funciona, agora salve o manifesto a seguir em `web-deny-all.yaml` e aplique-o ao cluster

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: web-deny-all
spec:
  podSelector:
    matchLabels:
      app: web
  ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```

#### Experimente

* Execute novamente um cont√™iner de teste e tente consultar `web`

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# Voc√™ ver√° a sa√≠da abaixo
#   wget: download timed out
```

* Tr√°fego bloqueado

#### [Observa√ß√µes](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* No manifesto acima, direcionamos os Pods com r√≥tulo app=web para a pol√≠tica de rede. Este arquivo de manifesto est√° sem o campo spec.ingress. Portanto, n√£o permite nenhum tr√°fego para o Pod.
* Se voc√™ criar outra Pol√≠tica de Rede que d√™ a alguns Pods acesso a este aplicativo diretamente ou indiretamente, esta Pol√≠tica de Rede ser√° obsoleta.
* Se houver pelo menos uma Pol√≠tica de Rede com uma regra permitindo o tr√°fego, significa que o tr√°fego ser√° roteado para o pod, independentemente das pol√≠ticas que bloqueiam o tr√°fego.

#### Limpeza

```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```

* Mais refer√™ncias e recursos podem ser encontrados em https://github.com/ahmetb/kubernetes-network-policy-recipes

### Editor Cilium - Editor de Pol√≠tica de Rede

Uma ferramenta/framework para ensin√°-lo a criar uma pol√≠tica de rede usando o Editor. Ele explica conceitos b√°sicos de pol√≠tica de rede e orienta voc√™ pelas etapas necess√°rias para alcan√ßar a seguran√ßa de privil√©gio m√≠nimo desejada e conceitos de confian√ßa zero.

* **Acesse o Editor Cilium** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Cen√°rio 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### Diversos

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegrama**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>