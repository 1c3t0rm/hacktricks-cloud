# Kubernetes网络策略

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版本的HackTricks，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的账号 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>

**本教程摘自** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html)

### 场景信息

本场景旨在为Kubernetes资源部署一个简单的网络安全策略，以创建安全边界。

* 要开始使用此场景，请确保您正在使用支持`NetworkPolicy`的网络解决方案

### 场景解决方案

* 以下场景来自[https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)

如果您想在IP地址或端口级别（OSI第3或第4层）上控制流量流动，那么您可能考虑在集群中的特定应用程序中使用Kubernetes NetworkPolicies。NetworkPolicies是一种以应用程序为中心的构造，允许您指定一个Pod如何与各种网络“实体”进行通信（我们在这里使用“实体”一词来避免过载更常见的术语，如“端点”和“服务”，这些术语在Kubernetes中具有特定的含义）。

Pod可以与的实体通过以下3个标识符的组合进行通信：

1. 允许的其他Pod（例外：一个Pod不能阻止对自身的访问）允许的命名空间
2. IP块（例外：无论Pod或节点的IP地址如何，始终允许与运行Pod的节点之间的流量）
3. 在定义基于Pod或命名空间的NetworkPolicy时，您使用选择器来指定允许与匹配选择器的Pod之间的流量。

同时，当创建基于IP的NetworkPolicies时，我们基于IP块（CIDR范围）定义策略。

* 我们将创建一个拒绝所有流量到一个应用程序的NetworkPolicy

用例：

* 这是非常常见的：要开始使用Network Policies进行流量白名单，首先需要使用此策略进行流量黑名单。
* 您想运行一个Pod，并且希望阻止任何其他Pod与其通信。
* 您暂时希望将流量与其他Pod隔离开来，以便于一个服务。

![Scenario 20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### 示例

* 运行一个带有标签`app=web`的nginx Pod，并将其暴露在端口80上
```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```
* 运行一个临时的 Pod 并向 `web` 服务发出请求
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# You will see the below output
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```
* 现在它可以工作了，将以下清单保存为 `web-deny-all.yaml`，然后应用到集群中。
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
name: web-deny-all
spec:
podSelector:
matchLabels:
app: web
ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```
#### 试一试

* 再次运行一个测试容器，并尝试查询 `web`
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# You will see the below output
#   wget: download timed out
```
* 丢弃的流量

#### [备注](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* 在上面的清单中，我们针对具有app=web标签的Pod进行网络策略。该清单文件缺少spec.ingress字段。因此，它不允许任何流量进入Pod。
* 如果您创建另一个NetworkPolicy，使一些Pod直接或间接地访问此应用程序，则此NetworkPolicy将过时。
* 如果至少有一个NetworkPolicy具有允许流量的规则，则意味着流量将被路由到Pod，而不管阻止流量的策略如何。

#### 清理
```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```
* 更多参考资料和资源可以在https://github.com/ahmetb/kubernetes-network-policy-recipes找到

### Cilium Editor - 网络策略编辑器

一个用于教授如何使用编辑器创建网络策略的工具/框架。它解释了基本的网络策略概念，并指导您完成实现所需的最小特权安全和零信任概念所需的步骤。

* **转到Cilium Editor** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### 杂项

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的**公司广告**，或者如果您想访问**PEASS的最新版本或下载PDF格式的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
