# Kubernetes NetworkPolicies

<details>

<summary><strong>ハックトリックをサポートして特典を得る！</strong></summary>

* **HackTricksで会社を宣伝したい**場合や、**PEASSの最新バージョンを見たい**場合、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をご確認ください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**する🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)
* **ハッキングのトリックを共有する**ために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

**このチュートリアルは** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html) **から取得されました**

### シナリオ情報

このシナリオでは、Kubernetesリソースのためのシンプルなネットワークセキュリティポリシーを展開して、セキュリティ境界を作成します。

* このシナリオを開始するには、`NetworkPolicy`をサポートするネットワーキングソリューションを使用していることを確認してください。

### シナリオの解決策

* 以下のシナリオは、[https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)から取得されています。

特定のアプリケーションに対してIPアドレスまたはポートレベル（OSIレイヤー3または4）でトラフィックフローを制御したい場合は、クラスタ内の特定のアプリケーションに対してKubernetes NetworkPoliciesを使用することを検討するかもしれません。 NetworkPoliciesは、ポッドがネットワーク上のさまざまなネットワーク「エンティティ」とどのように通信することが許可されるかを指定するためのアプリケーション中心の構造です（「エンティティ」という言葉を使用して、より一般的な用語である「エンドポイント」や「サービス」といった用語を過負荷にすることを避けています）。

ポッドが通信できるエンティティは、次の3つの識別子の組み合わせによって識別されます。

1. 許可される他のポッド（例外：ポッド自体へのアクセスをブロックすることはできません）許可される名前空間
2. IPブロック（例外：ポッドが実行されているノードとのトラフィックは、ポッドまたはノードのIPアドレスに関係なく常に許可されます）
3. ポッドまたは名前空間ベースのNetworkPolicyを定義する場合、セレクタを使用して、セレクタに一致するポッドとの間で許可されるトラフィックを指定します。

一方、IPベースのNetworkPoliciesが作成されると、CIDR範囲に基づいてポリシーが定義されます。

* アプリケーションへのすべてのトラフィックをDENYするNetworkPolicyを作成します

> このNetworkPolicyは、ポッドセレクタを使用して選択されたアプリケーションのポッドへのすべてのトラフィックをドロップします。

ユースケース：

* 一般的なケースです：Network Policiesを使用してトラフィックのホワイトリストを作成するには、まずこのポリシーを使用してトラフィックのブラックリストを作成する必要があります。
* ポッドを実行し、他のポッドとの通信を防止したい場合。
* サービスへのトラフィックを一時的に他のポッドから分離したい場合。

![シナリオ20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### 例

* ラベル`app=web`を持つnginxポッドを実行し、ポート80で公開します
```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```
* 一時的なPodを実行し、`web`サービスにリクエストを行います。
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# You will see the below output
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```
* うまくいきました。次のマニフェストを `web-deny-all.yaml` として保存し、クラスターに適用してください。
```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
name: web-deny-all
spec:
podSelector:
matchLabels:
app: web
ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```
#### 試してみる

* 再びテストコンテナを実行し、`web`にクエリを試みます。
```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# You will see the below output
#   wget: download timed out
```
* トラフィックがドロップされました

#### [備考](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* 上記のマニフェストでは、app=webラベルを持つPodにネットワークポリシーを適用しています。このマニフェストファイルにはspec.ingressフィールドがないため、Podへのトラフィックは許可されていません。
* このアプリケーションに直接または間接的にアクセスできるようにする別のNetworkPolicyを作成する場合、このNetworkPolicyは無効になります。
* トラフィックをブロックするポリシーがある場合でも、トラフィックを許可するルールを持つNetworkPolicyが少なくとも1つ存在する場合、トラフィックはポッドにルーティングされます。
```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```
* その他の参考資料は、https://github.com/ahmetb/kubernetes-network-policy-recipes で見つけることができます。

### Cilium Editor - ネットワークポリシーエディター

エディターを使用してネットワークポリシーを作成する方法を教えてくれるツール/フレームワークです。基本的なネットワークポリシーの概念を説明し、望ましい最小特権セキュリティとゼロトラストの概念を実現するための手順を案内します。

* **Cilium Editorに移動します** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### その他

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* **HackTricksの広告を掲載したい場合や、最新バージョンのPEASSにアクセスしたい場合、またはHackTricksをPDFでダウンロードしたい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をご確認ください！**
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)を手に入れましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**をフォローしましょう。**
* **ハッキングのトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
