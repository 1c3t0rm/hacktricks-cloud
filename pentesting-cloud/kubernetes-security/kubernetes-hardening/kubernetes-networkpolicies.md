# Pol√≠ticas de red de Kubernetes

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Este tutorial fue tomado de** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html)

### Informaci√≥n del escenario

Este escenario despliega una pol√≠tica de seguridad de red simple para los recursos de Kubernetes para crear l√≠mites de seguridad.

* Para comenzar con este escenario, aseg√∫rese de estar utilizando una soluci√≥n de red que admita `NetworkPolicy`.

### Soluci√≥n del escenario

* El siguiente escenario es de [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)

Si desea controlar el flujo de tr√°fico a nivel de direcci√≥n IP o puerto (capa OSI 3 o 4), entonces puede considerar el uso de las pol√≠ticas de red de Kubernetes para aplicaciones particulares en su cl√∫ster. Las pol√≠ticas de red son una construcci√≥n centrada en la aplicaci√≥n que le permite especificar c√≥mo se permite que un pod se comunique con varias "entidades" de red (usamos la palabra "entidad" aqu√≠ para evitar sobrecargar los t√©rminos m√°s comunes como "puntos finales" y "servicios", que tienen connotaciones espec√≠ficas de Kubernetes) a trav√©s de la red.

Las entidades con las que un pod puede comunicarse se identifican mediante una combinaci√≥n de los siguientes 3 identificadores:

1. Otros pods que est√°n permitidos (excepci√≥n: un pod no puede bloquear el acceso a s√≠ mismo) Espacios de nombres que est√°n permitidos
2. Bloques de IP (excepci√≥n: el tr√°fico hacia y desde el nodo donde se est√° ejecutando un pod siempre est√° permitido, independientemente de la direcci√≥n IP del pod o del nodo)
3. Al definir una pol√≠tica de red basada en pod o espacio de nombres, se utiliza un selector para especificar qu√© tr√°fico se permite hacia y desde los pod que coinciden con el selector.

Mientras tanto, cuando se crean pol√≠ticas de red basadas en IP, definimos pol√≠ticas basadas en bloques de IP (rangos CIDR).

* Crearemos una pol√≠tica que DENIEGA todo el tr√°fico a una aplicaci√≥n.

> Esta pol√≠tica de red dejar√° caer todo el tr√°fico a los pods de una aplicaci√≥n, seleccionados mediante Selectores de Pod.

Casos de uso:

* Es muy com√∫n: para comenzar a permitir el tr√°fico mediante pol√≠ticas de red, primero debe bloquear el tr√°fico mediante esta pol√≠tica.
* Desea ejecutar un pod y desea evitar que otros pods se comuniquen con √©l.
* Desea aislar temporalmente el tr√°fico a un servicio de otros pods.

![Scenario 20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### Ejemplo

* Ejecute un pod nginx con etiquetas `app=web` y exponga el puerto 80.

```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```

* Ejecute un pod temporal y haga una solicitud al servicio `web`.

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# Ver√° la siguiente salida
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```

* Funciona, ahora guarde el siguiente manifiesto en `web-deny-all.yaml` y apl√≠quelo al cl√∫ster.

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: web-deny-all
spec:
  podSelector:
    matchLabels:
      app: web
  ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```

#### Pru√©balo

* Ejecute nuevamente un contenedor de prueba e intente consultar `web`.

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# Ver√° la siguiente salida
#   wget: download timed out
```

* El tr√°fico se ha bloqueado.

#### [Observaciones](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* En el manifiesto anterior, apuntamos a los pods con la etiqueta app=web para la pol√≠tica de red. Este archivo de manifiesto no tiene el campo spec.ingress. Por lo tanto, no permite ning√∫n tr√°fico al pod.
* Si crea otra pol√≠tica de red que da acceso a algunos pods a esta aplicaci√≥n directa o indirectamente, esta pol√≠tica de red quedar√° obsoleta.
* Si hay al menos una pol√≠tica de red con una regla que permite el tr√°fico, significa que el tr√°fico se enrutar√° al pod independientemente de las pol√≠ticas que bloqueen el tr√°fico.

#### Limpieza

```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```

* Se pueden encontrar m√°s referencias y recursos en https://github.com/ahmetb/kubernetes-network-policy-recipes

### Editor de pol√≠ticas de red de Cilium - Network Policy Editor

Una herramienta / marco para ense√±arle c√≥mo crear una pol√≠tica de red utilizando el Editor. Explica los conceptos b√°sicos de la pol√≠tica de red y lo gu√≠a a trav√©s de los pasos necesarios para lograr la seguridad de privilegios m√≠nimos y los conceptos de confianza cero deseados.

* **Vaya al Editor de Cilium** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### Varios

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>¬°Apoya a HackTricks y obt√©n beneficios!</strong></summary>

* Si quieres ver a tu **empresa anunciada en HackTricks** o si quieres acceder a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).

* **Comparte tus trucos de hacking enviando PR a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>