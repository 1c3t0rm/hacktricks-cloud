# Politiques r√©seau Kubernetes

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>

**Ce tutoriel a √©t√© pris sur** [**https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html**](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html)

### Informations sur le sc√©nario

Ce sc√©nario d√©ploie une politique de s√©curit√© r√©seau simple pour les ressources Kubernetes afin de cr√©er des fronti√®res de s√©curit√©.

* Pour commencer ce sc√©nario, assurez-vous d'utiliser une solution de mise en r√©seau qui prend en charge `NetworkPolicy`

### Solution de sc√©nario

* Le sc√©nario ci-dessous provient de [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)

Si vous souhaitez contr√¥ler le flux de trafic au niveau de l'adresse IP ou du port (couche OSI 3 ou 4), vous pouvez envisager d'utiliser des politiques r√©seau Kubernetes pour des applications particuli√®res dans votre cluster. Les NetworkPolicies sont une construction centr√©e sur l'application qui vous permet de sp√©cifier comment un pod est autoris√© √† communiquer avec diverses "entit√©s" r√©seau (nous utilisons le terme "entit√©" ici pour √©viter de surcharger les termes plus courants tels que "endpoints" et "services", qui ont des connotations Kubernetes sp√©cifiques) sur le r√©seau.

Les entit√©s avec lesquelles un pod peut communiquer sont identifi√©es par une combinaison des 3 identificateurs suivants :

1. D'autres pods autoris√©s (exception : un pod ne peut pas bloquer l'acc√®s √† lui-m√™me) Espaces de noms autoris√©s
2. Blocs IP (exception : le trafic vers et depuis le n≈ìud o√π s'ex√©cute un pod est toujours autoris√©, ind√©pendamment de l'adresse IP du pod ou du n≈ìud)
3. Lors de la d√©finition d'une NetworkPolicy bas√©e sur un pod ou un espace de noms, vous utilisez un s√©lecteur pour sp√©cifier quel trafic est autoris√© vers et depuis le(s) pod(s) qui correspondent au s√©lecteur.

Pendant ce temps, lorsque des NetworkPolicies bas√©es sur IP sont cr√©√©es, nous d√©finissons des politiques bas√©es sur des blocs IP (plages CIDR).

* Nous allons cr√©er un refus de tout le trafic vers une application

> Cette NetworkPolicy va refuser tout le trafic vers les pods d'une application, s√©lectionn√©s √† l'aide de Pod Selectors.

Cas d'utilisation :

* C'est tr√®s courant : Pour commencer √† autoriser le trafic √† l'aide de Network Policies, vous devez d'abord interdire le trafic √† l'aide de cette politique.
* Vous voulez ex√©cuter un Pod et emp√™cher tout autre Pod de communiquer avec lui.
* Vous voulez temporairement isoler le trafic vers un Service des autres Pods.

![Scenario 20 NSP](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-1.gif)

#### Exemple

* Ex√©cutez un pod nginx avec les labels `app=web` et exposez-le sur le port 80

```bash
kubectl run --image=nginx web --labels app=web --expose --port 80
```

* Ex√©cutez un pod temporaire et effectuez une requ√™te vers le service `web`

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- http://web
# Vous verrez la sortie ci-dessous
#    <!DOCTYPE html>
#    <html>
#    <head>
#    ...
```

* Cela fonctionne, maintenant enregistrez la manifestation suivante dans `web-deny-all.yaml`, puis appliquez-la au cluster

```yaml
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: web-deny-all
spec:
  podSelector:
    matchLabels:
      app: web
  ingress: []
```

```bash
kubectl apply -f web-deny-all.yaml
```

#### Essayez-le

* Ex√©cutez √† nouveau un conteneur de test et essayez de requ√™ter `web`

```bash
kubectl run --rm -i -t --image=alpine test-$RANDOM -- sh
```

```bash
wget -qO- --timeout=2 http://web
# Vous verrez la sortie ci-dessous
#   wget: download timed out
```

* Trafic abandonn√©

#### [Remarques](https://madhuakula.com/kubernetes-goat/scenarios/scenario-20.html#remarks)

* Dans la manifestation ci-dessus, nous ciblons les pods avec l'√©tiquette app=web pour la mise en r√©seau de la politique. Ce fichier de manifestation ne contient pas le champ spec.ingress. Par cons√©quent, il n'autorise aucun trafic entrant dans le pod.
* Si vous cr√©ez une autre NetworkPolicy qui donne √† certains pods un acc√®s direct ou indirect √† cette application, cette NetworkPolicy sera obsol√®te.
* S'il existe au moins une NetworkPolicy avec une r√®gle autorisant le trafic, cela signifie que le trafic sera rout√© vers le pod ind√©pendamment des politiques bloquant le trafic.

#### Nettoyage

```bash
kubectl delete pod web
kubectl delete service web
kubectl delete networkpolicy web-deny-all
```

* Plus de r√©f√©rences et de ressources peuvent √™tre trouv√©es sur https://github.com/ahmetb/kubernetes-network-policy-recipes

### √âditeur Cilium - √âditeur de politiques r√©seau

Un outil/cadre pour vous apprendre √† cr√©er une politique r√©seau √† l'aide de l'√©diteur. Il explique les concepts de base des politiques r√©seau et vous guide √† travers les √©tapes n√©cessaires pour atteindre la s√©curit√© de moindre privil√®ge et les concepts de confiance z√©ro souhait√©s.

* **Acc√©dez √† l'√©diteur Cilium** [**https://editor.cilium.io/**](https://editor.cilium.io)

![Scenario 20 NSP Cilium](https://madhuakula.com/kubernetes-goat/scenarios/images/sc-20-2.png)

### Divers

* [https://kubernetes.io/docs/concepts/services-networking/network-policies/](https://kubernetes.io/docs/concepts/services-networking/network-policies/)
* [https://github.com/ahmetb/kubernetes-network-policy-recipes](https://github.com/ahmetb/kubernetes-network-policy-recipes)
* [https://editor.cilium.io/](https://editor.cilium.io)

<details>

<summary><strong>Soutenez HackTricks et b√©n√©ficiez d'avantages !</strong></summary>

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou si vous souhaitez acc√©der √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **d√©p√¥ts Github.**

</details>