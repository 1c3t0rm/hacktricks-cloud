# Exposing Services in Kubernetes

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

There are **different ways to expose services** in Kubernetes so both **internal** endpoints and **external** endpoints can access them. This Kubernetes configuration is pretty critical as the administrator could give access to **attackers to services they shouldn't be able to access**.

### Automatic Enumeration

Before starting enumerating the ways K8s offers to expose services to the public, know that if you can list namespaces, services and ingresses, you can find everything exposed to the public with:
```bash
kubectl get namespace -o custom-columns='NAME:.metadata.name' | grep -v NAME | while IFS='' read -r ns; do
echo "Namespace: $ns"
kubectl get service -n "$ns"
kubectl get ingress -n "$ns"
echo "=============================================="
echo ""
echo ""
done | grep -v "ClusterIP"
# Remove the last '| grep -v "ClusterIP"' to see also type ClusterIP
```
### ClusterIP

**ClusterIP** jup 'ej **default** Kubernetes **service**. vaj vItlhutlh **service** vaj **cluster** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **vaj** vaj **v
```
kubectl proxy --port=8080
```
DaH jImejmeH Kubernetes API vItlhutlh services qaptaHvIS 'ej 'ej vItlhutlh:

`http://localhost:8080/api/v1/proxy/namespaces/<NAMESPACE>/services/<SERVICE-NAME>:<PORT-NAME>/`

mIw vItlhutlh URL vIlo'laHbe':

`http://localhost:8080/api/v1/proxy/namespaces/default/services/my-internal-service:http/`

vItlhutlh service vItlhutlh:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-internal-service
spec:
selector:
app: my-app
type: ClusterIP
ports:
- name: http
port: 80
targetPort: 80
protocol: TCP
```
_**tlhIngan Hol**_

### NodePort

**NodePort** jatlh `kubectl` **authenticated user** **run** **requires**.

**NodePort** **utilized** **when**, **designated port** **made available** **all Nodes** (representing **Virtual Machines**). **Traffic** **directed** **this specific port** **then systematically routed** **service**. **Typically**, **method** **not recommended** **due to** **drawbacks**.

**NodePort specification** **example**:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-nodeport-service
spec:
selector:
app: my-app
type: NodePort
ports:
- name: http
port: 80
targetPort: 80
nodePort: 30036
protocol: TCP
```
**ghItlh** **nodePort** **ghItlh** yaml **ghItlh** **(vaj port)** **ghItlh** **30000–32767** **ghItlh** **range** **ghItlh** **vaj**.

### LoadBalancer <a href="#0d96" id="0d96"></a>

**ghItlh** **Service** **ghItlh** **external** **ghItlh** **(cloud provider's load balancer)** **ghItlh** **exposes**. **GKE** **ghItlh** **(Network Load Balancer)** **ghItlh** **spin up** **ghItlh** **[Network Load Balancer](https://cloud.google.com/compute/docs/load-balancing/network/)** **ghItlh** **single IP address** **ghItlh** **traffic** **ghItlh** **forward**.

**LoadBalancer** **ghItlh** **pay** **ghItlh** **LoadBalancer** **exposed service** **ghItlh** **expensive**.

### ExternalName

**[From the docs:](https://kubernetes.io/docs/concepts/services-networking/service/#externalname)**
**ExternalName** **ghItlh** **Service** **ghItlh** **DNS name** **ghItlh** **map**. **Service** **ghItlh** **typical selector** **ghItlh** **(my-service, cassandra)** **ghItlh** **map** **ghItlh** **spec.externalName** **ghItlh** **parameter**.

**Service definition** **ghItlh** **example** **ghItlh** **my-service** **Service** **ghItlh** **prod** **namespace** **ghItlh** **my.database.example.com** **ghItlh** **map**:
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
namespace: prod
spec:
type: ExternalName
externalName: my.database.example.com
```
### External IPs <a href="#external-ips" id="external-ips"></a>

Traffic that ingresses into the cluster with the **external IP** (as **destination IP**), on the Service port, will be **routed to one of the Service endpoints**. `externalIPs` are not managed by Kubernetes and are the responsibility of the cluster administrator.

In the Service spec, `externalIPs` can be specified along with any of the `ServiceTypes`. In the example below, "`my-service`" can be accessed by clients on "`80.11.12.10:80`" (`externalIP:port`)

### External IPs <a href="#external-ips" id="external-ips"></a>

Traffic that ingresses into the cluster with the **external IP** (as **destination IP**), on the Service port, will be **routed to one of the Service endpoints**. `externalIPs` are not managed by Kubernetes and are the responsibility of the cluster administrator.

In the Service spec, `externalIPs` can be specified along with any of the `ServiceTypes`. In the example below, "`my-service`" can be accessed by clients on "`80.11.12.10:80`" (`externalIP:port`)
```yaml
apiVersion: v1
kind: Service
metadata:
name: my-service
spec:
selector:
app: MyApp
ports:
- name: http
protocol: TCP
port: 80
targetPort: 9376
externalIPs:
- 80.11.12.10
```
### Ingress

**Ingress jatlhbe'**. **Ingress** **ghaH** **service type** jatlhbe'. **Ingress** **services** **front** **multiple services** **'ej** **"smart router"** **'ej** **entrypoint** **cluster**.

**Ingress** **lot** **different things** **'e'** **'ej** **Ingress controllers** **many types** **capabilities**.

**GKE ingress controller** **default** **[HTTP(S) Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/)** **spin up**. **'Iv** **path based** **'ej** **subdomain based routing** **backend services**. **Example**, **foo.yourdomain.com** **foo service** **send** **'ej** **yourdomain.com/bar/ path** **bar service**.

**YAML** **Ingress object** **GKE** **[L7 HTTP Load Balancer](https://cloud.google.com/compute/docs/load-balancing/http/)** **look like** **this**:
```yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
name: my-ingress
spec:
backend:
serviceName: other
servicePort: 8080
rules:
- host: foo.mydomain.com
http:
paths:
- backend:
serviceName: foo
servicePort: 8080
- host: mydomain.com
http:
paths:
- path: /bar/*
backend:
serviceName: bar
servicePort: 8080
```
### References

* [https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0](https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0)
* [https://kubernetes.io/docs/concepts/services-networking/service/](https://kubernetes.io/docs/concepts/services-networking/service/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
