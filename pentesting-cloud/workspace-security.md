# Pentesting de Workspace

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing en Workspace

### Metodolog칤a Gen칠rica de Phishing

### Phishing en Grupos de Google

Por defecto en Workspace los miembros [**pueden crear grupos**](https://groups.google.com/all-groups) **e invitar a personas a ellos**. Luego puedes modificar el correo que se enviar치 al usuario **a침adiendo algunos enlaces**. El **correo vendr치 de una direcci칩n de Google**, por lo que parecer치 **leg칤timo** y la gente podr칤a hacer clic en el enlace.

### Phishing en Hangouts

Podr칤as ser capaz de hablar directamente con una persona solo teniendo su direcci칩n de correo electr칩nico o enviar una invitaci칩n para hablar. De cualquier manera, puedes modificar una cuenta de correo electr칩nico quiz치s nombr치ndola "Seguridad de Google" y a침adiendo algunos logotipos de Google, y la gente pensar치 que est치n hablando con Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **misma t칠cnica** puede ser utilizada con **Google Chat**.

### Phishing en Documentos de Google

Puedes crear un **documento aparentemente leg칤timo** y luego en un comentario **mencionar alg칰n correo electr칩nico (como +usuario@gmail.com)**. Google **enviar치 un correo a esa direcci칩n** notificando que fueron mencionados en el documento. Puedes **poner un enlace en ese documento** para intentar que la persona lo acceda.

### Phishing en Calendario de Google

Puedes **crear un evento en el calendario** y a침adir tantas direcciones de correo electr칩nico de la empresa que est치s atacando como tengas. Programa este evento en el calendario en **5 o 15 minutos** a partir del momento actual. Haz que el evento parezca leg칤timo y **pon un comentario indicando que necesitan leer algo** (con el **enlace de phishing**).\
Para que parezca menos sospechoso:

* Config칰ralo para que los **receptores no puedan ver a las otras personas invitadas**
* **NO env칤es correos electr칩nicos notificando sobre el evento**. Entonces, la gente solo ver치 su aviso sobre una reuni칩n en 5 minutos y que necesitan leer ese enlace.
* Aparentemente usando la API puedes configurar a **Verdadero** que las **personas** han **aceptado** el evento e incluso crear **comentarios en su nombre**.

### Phishing con OAuth

Cualquiera de las t칠cnicas anteriores podr칤a ser utilizada para hacer que el usuario acceda a una **aplicaci칩n de Google OAuth** que **solicitar치** al usuario alg칰n **acceso**. Si el usuario **conf칤a** en la **fuente**, podr칤a **confiar** en la **aplicaci칩n** (incluso si est치 pidiendo permisos de alto privilegio).

Ten en cuenta que Google presenta un aviso feo advirtiendo que la aplicaci칩n no es de confianza en varios casos y los administradores de Workspace incluso pueden evitar que las personas acepten aplicaciones OAuth. M치s sobre esto en la secci칩n de OAuth.

## Ataque de Fuerza Bruta con Contrase침as

Para probar contrase침as con todos los correos electr칩nicos que encontraste (o que has generado bas치ndote en un patr칩n de nombre de correo electr칩nico que podr칤as haber descubierto) puedes usar una herramienta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) que usar치 lambdas de AWS para cambiar la direcci칩n IP.

## Aplicaciones OAuth

**Google** permite crear aplicaciones que pueden **interactuar en nombre de los usuarios** con varios **servicios de Google**: Gmail, Drive, GCP...

Al crear una aplicaci칩n para **actuar en nombre de otros usuarios**, el desarrollador necesita crear una **aplicaci칩n OAuth dentro de GCP** e indicar los 치mbitos (permisos) que la aplicaci칩n necesita para acceder a los datos de los usuarios.\
Cuando un **usuario** quiere **usar** esa **aplicaci칩n**, se le **pedir치** que **acepte** que la aplicaci칩n tendr치 acceso a sus datos especificados en los 치mbitos.

Esta es una forma muy jugosa de **phishing** para usuarios no t칠cnicos para que usen **aplicaciones que acceden a informaci칩n sensible** porque podr칤an no entender las consecuencias. Sin embargo, en cuentas de organizaciones, hay formas de prevenir que esto suceda.

### Aviso de Aplicaci칩n No Verificada

Como se mencion칩, Google siempre presentar치 un **aviso al usuario para aceptar** los permisos que est치n dando a la aplicaci칩n en su nombre. Sin embargo, si la aplicaci칩n se considera **peligrosa**, Google mostrar치 **primero** un **aviso** indicando que es **peligrosa** y **haciendo m치s dif칤cil** para el usuario otorgar los permisos a la aplicaci칩n.

Este aviso aparece en aplicaciones que:

* Usan cualquier 치mbito que pueda acceder a datos privados (Gmail, Drive, GCP, BigQuery...)
* Aplicaciones con menos de 100 usuarios (las aplicaciones > 100 tambi칠n necesitan un proceso de revisi칩n para dejar de mostrar el aviso de no verificado)

### 츼mbitos Interesantes

[**Aqu칤**](https://developers.google.com/identity/protocols/oauth2/scopes) puedes encontrar una lista de todos los 치mbitos de OAuth de Google.

* **cloud-platform**: Ver y gestionar tus datos a trav칠s de los servicios de **Google Cloud Platform**. Puedes suplantar al usuario en GCP.
* **directory.readonly**: Ver y descargar el directorio de GSuite de tu organizaci칩n. Obtener nombres, tel칠fonos, URLs de calendario de todos los usuarios.

## Scripts de Aplicaciones

Los desarrolladores pueden crear Scripts de Aplicaciones y configurarlos como un proyecto independiente o vincularlos a Documentos/Hojas de c치lculo/Presentaciones/Formularios de Google. App Scripts es c칩digo que se activar치 cuando un usuario con permiso de editor acceda al documento (y despu칠s de aceptar el aviso de OAuth)

Sin embargo, incluso si la aplicaci칩n no est치 verificada, hay un par de formas de no mostrar ese aviso:

* Si el publicador de la aplicaci칩n est치 en el mismo Workspace que el usuario que accede a ella
* Si el script est치 en una unidad de disco del usuario
### Supresi칩n de la Solicitud de Verificaci칩n al Copiar Documentos

Cuando creas un enlace para compartir un documento, se crea un enlace similar a este: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si **cambias** el final **"/edit"** por **"/copy"**, en lugar de acceder, Google te preguntar치 si quieres **generar una copia del documento.**

{% hint style="warning" %}
Si alguien crea una **copia** de ese **documento** que **conten칤a el App Script**, tambi칠n estar치 **copiando el App Script**, por lo tanto, cuando **abra** la **hoja de c치lculo** copiada, aparecer치 la **solicitud regular de OAuth**, **evitando la solicitud de verificaci칩n no verificada**, porque **el usuario es ahora el autor del App Script del archivo copiado**.
{% endhint %}

Este m칠todo tambi칠n podr치 evitar la restricci칩n del administrador de Workspace:

Pero se puede prevenir con:

### Supresi칩n de la Solicitud de Verificaci칩n al Compartir Documentos

Adem치s, si alguien **comparti칩** contigo un documento con **acceso de editor**, puedes generar **App Scripts dentro del documento** y el **PROPIETARIO (creador) del documento ser치 el due침o del App Script**.

{% hint style="warning" %}
Esto significa que el **creador del documento aparecer치 como creador de cualquier App Script** que alguien con acceso de editor cree dentro de 칠l.

Esto tambi칠n significa que el **App Script ser치 confiable por el entorno de Workspace** del creador del documento.
{% endhint %}

{% hint style="danger" %}
Esto tambi칠n significa que si un **App Script ya exist칤a** y la gente ha **concedido acceso**, cualquiera con permiso de **Editor** en el documento puede **modificarlo y abusar de ese acceso.**\
Para abusar de esto tambi칠n necesitas que la gente active el App Script. Y un truco interesante es **publicar el script como una aplicaci칩n web**. Cuando la **gente** que ya concedi칩 **acceso** al App Script acceda a la p치gina web, **activar치n el App Script** (esto tambi칠n funciona usando etiquetas `<img>`).
{% endhint %}

## Post-Explotaci칩n

### Escalada de Privilegios en Google Groups

Por defecto en Workspace, un **grupo** puede ser **accedido libremente** por cualquier miembro de la organizaci칩n.\
Workspace tambi칠n permite **otorgar permisos a grupos** (incluso permisos de GCP), as칤 que si se pueden unir a grupos y tienen permisos adicionales, un atacante puede **abusar de ese camino para escalar privilegios**.

Potencialmente necesitas acceso a la consola para unirte a grupos que permiten ser unidos por cualquiera en la org. Verifica la informaci칩n de los grupos en [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoteo de GWS a GCP

* Abusando de la **escalada de privilegios en google groups** podr칤as ser capaz de escalar a un grupo con alg칰n tipo de acceso privilegiado a GCP
* Abusando de **aplicaciones OAuth** podr칤as ser capaz de suplantar usuarios y acceder a GCP en su nombre

### Pivoteo de GCP a GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acceso a la Informaci칩n de Correo de Grupos

Si lograste **comprometer una sesi칩n de usuario de Google**, desde [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) puedes ver el historial de correos enviados a los grupos de correo de los que el usuario es miembro, y podr칤as encontrar **credenciales** u otra **informaci칩n sensible**.

### Takeout - Descargar Todo lo que Google Sabe sobre una Cuenta

Si tienes una **sesi칩n dentro de la cuenta de Google de la v칤ctima** puedes descargar todo lo que Google guarda sobre esa cuenta desde [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Descargar Todos los Datos de Workspace de los Usuarios

Si una organizaci칩n tiene **Google Vault habilitado**, podr칤as ser capaz de acceder a [**https://vault.google.com**](https://vault.google.com/u/1/) y **descargar** toda la **informaci칩n**.

### Descarga de Contactos

Desde [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) puedes descargar todos los **contactos** del usuario.

### Cloudsearch

En [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) puedes simplemente buscar **a trav칠s de todo el contenido de Workspace** (correo, drive, sitios...) al que un usuario tiene acceso. Ideal para **encontrar r치pidamente informaci칩n sensible**.

### Currents

En [**https://currents.google.com/**](https://currents.google.com) puedes acceder a un **Chat de Google**, por lo que podr칤as encontrar informaci칩n sensible all칤.

### Miner칤a en Google Drive

Al **compartir** un documento puedes **especificar** a las **personas** que pueden acceder a 칠l una por una, **compartirlo** con tu **empresa completa** (**o** con algunos **grupos** espec칤ficos) **generando un enlace**.

Al compartir un documento, en la configuraci칩n avanzada tambi칠n puedes **permitir que la gente busque** este archivo (por **defecto** esto est치 **deshabilitado**). Sin embargo, es importante notar que una vez que los usuarios ven un documento, es buscable por ellos.

Por simplicidad, la mayor칤a de las personas generar치 y compartir치 un enlace en lugar de agregar uno por uno a las personas que pueden acceder al documento.

Algunas formas propuestas para encontrar todos los documentos:

* Buscar en chat interno, foros...
* **Rastrear** documentos **conocidos** buscando **referencias** a otros documentos. Puedes hacer esto dentro de un App Script con [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

En [**https://keep.google.com/**](https://keep.google.com) puedes acceder a las notas del usuario, **informaci칩n sensible** podr칤a estar guardada aqu칤.

### Persistencia Dentro de una Cuenta de Google

Si lograste **comprometer una sesi칩n de usuario de Google** y el usuario ten칤a **2FA**, puedes **generar** una [**contrase침a de aplicaci칩n**](https://support.google.com/accounts/answer/185833?hl=en) y **regenerar los c칩digos de respaldo de 2FA** para saber que incluso si el usuario cambia la contrase침a t칰 **podr치s acceder a su cuenta**. Otra opci칩n **en lugar** de **regenerar** los c칩digos es **inscribir tu propia aplicaci칩n autenticadora** en el 2FA.

### Persistencia a trav칠s de Aplicaciones OAuth

Si has **comprometido la cuenta de un usuario,** simplemente puedes **aceptar** otorgar todos los permisos posibles a una **Aplicaci칩n OAuth**. El 칰nico problema es que Workspace puede configurarse para **no permitir aplicaciones OAuth externas y/o internas sin revisi칩n.**\
Es bastante com칰n no confiar por defecto en aplicaciones OAuth externas pero s칤 en las internas, as칤 que si tienes **suficientes permisos para generar una nueva aplicaci칩n OAuth** dentro de la organizaci칩n y las aplicaciones externas est치n prohibidas, gen칠rala y **usa esa nueva aplicaci칩n OAuth interna para mantener la persistencia**.
### Persistencia a trav칠s de delegaci칩n

Puedes simplemente **delegar la cuenta** a una cuenta diferente controlada por el atacante.

### Persistencia a trav칠s de la App de Android

Si tienes una **sesi칩n dentro de la cuenta de Google de la v칤ctima** puedes navegar a la **Play Store** e **instalar malware** que ya hayas subido directamente **al tel칠fono** para mantener la persistencia y acceder al tel칠fono de la v칤ctima.

### **Persistencia a trav칠s de Gmail**

* Puedes crear **filtros para ocultar** notificaciones de seguridad de Google
* de: (no-reply@accounts.google.com) "Alerta de Seguridad"
* Ocultar correos electr칩nicos de restablecimiento de contrase침a
* Crear **direcci칩n de reenv칤o para reenviar informaci칩n sensible** (o todo) - Necesitas acceso manual.
* Crear una direcci칩n de reenv칤o para enviar correos electr칩nicos que contengan la palabra "contrase침a" por ejemplo
* A침adir **correo/tel칠fono de recuperaci칩n bajo control del atacante**

### **Persistencia a trav칠s de** App Scripts

Puedes crear **disparadores basados en tiempo** en App Scripts, as칤 que si el App Script es aceptado por el usuario, se **activar치** incluso **sin que el usuario lo acceda**.

La documentaci칩n menciona que para usar `ScriptApp.newTrigger("funcion")` necesitas el **alcance** `script.scriptapp`, pero **aparentemente eso no es necesario** siempre y cuando hayas declarado alg칰n otro alcance.

### **Administrar Workspace**

En [**https://admin.google.com**/](https://admin.google.com), podr칤as ser capaz de modificar la configuraci칩n de Workspace de toda la organizaci칩n si tienes suficientes permisos.

Tambi칠n puedes encontrar correos electr칩nicos buscando a trav칠s de todas las facturas de los usuarios en [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recuperaci칩n de Cuenta Comprometida

* Cerrar sesi칩n en todas las sesiones
* Cambiar la contrase침a del usuario
* Generar nuevos c칩digos de respaldo para 2FA
* Eliminar contrase침as de App
* Eliminar aplicaciones OAuth
* Eliminar dispositivos 2FA
* Eliminar reenviadores de correo
* Eliminar filtros de correo
* Eliminar correo/tel칠fonos de recuperaci칩n
* Eliminar Apps de Android maliciosas
* Eliminar delegaciones de cuenta maliciosas

## Referencias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
