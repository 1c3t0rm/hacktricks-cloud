# Pentesting no Workspace

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing no Workspace

### Metodologia Gen√©rica de Phishing

### Phishing em Grupos do Google

Aparentemente, por padr√£o no workspace, membros [**podem criar grupos**](https://groups.google.com/all-groups) **e convidar pessoas para eles**. Voc√™ pode ent√£o modificar o email que ser√° enviado ao usu√°rio **adicionando alguns links**. O **email vir√° de um endere√ßo do Google**, ent√£o parecer√° **leg√≠timo** e as pessoas podem clicar no link.

### Phishing no Hangout

Voc√™ pode ser capaz de falar diretamente com uma pessoa apenas tendo o endere√ßo de email dela ou enviar um convite para conversar. De qualquer forma, voc√™ pode modificar uma conta de email talvez nomeando-a "Seguran√ßa do Google" e adicionando alguns logotipos do Google, e as pessoas pensar√£o que est√£o falando com o Google: [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

A **mesma t√©cnica** pode ser usada com o **Google Chat**.

### Phishing no Google Docs

Voc√™ pode criar um **documento aparentemente leg√≠timo** e ent√£o em um coment√°rio **mencionar algum email (como +usuario@gmail.com)**. O Google **enviar√° um email para esse endere√ßo de email** notificando que foram mencionados no documento. Voc√™ pode **colocar um link nesse documento** para tentar fazer a pessoa acess√°-lo.

### Phishing no Google Calendar

Voc√™ pode **criar um evento no calend√°rio** e adicionar quantos endere√ßos de email da empresa que voc√™ est√° atacando tiver. Agende este evento no calend√°rio para **5 ou 15 minutos** a partir do momento atual. Fa√ßa o evento parecer leg√≠timo e **coloque um coment√°rio indicando que eles precisam ler algo** (com o **link de phishing**).\
Para parecer menos suspeito:

* Configure para que os **receptores n√£o possam ver as outras pessoas convidadas**
* **N√ÉO envie emails notificando sobre o evento**. Ent√£o, as pessoas s√≥ ver√£o o aviso sobre uma reuni√£o em 5 minutos e que precisam ler aquele link.
* Aparentemente usando a API voc√™ pode configurar para **Verdadeiro** que as **pessoas** **aceitaram** o evento e at√© criar **coment√°rios em nome delas**.

### Phishing com OAuth

Qualquer uma das t√©cnicas anteriores pode ser usada para fazer o usu√°rio acessar uma **aplica√ß√£o Google OAuth** que ir√° **solicitar** ao usu√°rio algum **acesso**. Se o usu√°rio **confiar** na **fonte**, ele pode **confiar** na **aplica√ß√£o** (mesmo que ela esteja pedindo permiss√µes de alto privil√©gio).

Note que o Google apresenta um aviso feio perguntando se o usu√°rio est√° ciente de que a aplica√ß√£o n√£o √© confi√°vel em v√°rios casos e os administradores do Workspace podem at√© impedir que as pessoas aceitem aplica√ß√µes OAuth. Mais sobre isso na se√ß√£o OAuth.

## Password Spraying

Para testar senhas com todos os emails que voc√™ encontrou (ou que voc√™ gerou baseado em um padr√£o de nome de email que voc√™ pode ter descoberto), voc√™ pode usar uma ferramenta como [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) que usar√° lambdas da AWS para mudar o endere√ßo IP.

## Aplica√ß√µes OAuth

**Google** permite criar aplica√ß√µes que podem **interagir em nome dos usu√°rios** com v√°rios **servi√ßos do Google**: Gmail, Drive, GCP...

Ao criar uma aplica√ß√£o para **agir em nome de outros usu√°rios**, o desenvolvedor precisa criar uma **aplica√ß√£o OAuth dentro do GCP** e indicar os escopos (permiss√µes) que o app precisa para acessar os dados dos usu√°rios.\
Quando um **usu√°rio** deseja **usar** essa **aplica√ß√£o**, ele ser√° **solicitado** a **aceitar** que a aplica√ß√£o ter√° acesso aos seus dados especificados nos escopos.

Esta √© uma maneira muito atraente de **phishar** usu√°rios n√£o t√©cnicos para usar **aplica√ß√µes que acessam informa√ß√µes sens√≠veis** porque eles podem n√£o entender as consequ√™ncias. No entanto, em contas de organiza√ß√µes, existem maneiras de prevenir isso.

### Prompt de Aplicativo N√£o Verificado

Como foi mencionado, o Google sempre apresentar√° um **prompt para o usu√°rio aceitar** as permiss√µes que est√£o dando √† aplica√ß√£o em seu nome. No entanto, se a aplica√ß√£o for considerada **perigosa**, o Google mostrar√° **primeiro** um **prompt** indicando que √© **perigoso** e **tornando mais dif√≠cil** para o usu√°rio conceder as permiss√µes ao app.

Este prompt aparece em apps que:

* Usam qualquer escopo que possa acessar dados privados (Gmail, Drive, GCP, BigQuery...)
* Apps com menos de 100 usu√°rios (apps > 100 tamb√©m precisam de um processo de revis√£o para parar de mostrar o prompt de n√£o verificado)

### Escopos Interessantes

[**Aqui**](https://developers.google.com/identity/protocols/oauth2/scopes) voc√™ pode encontrar uma lista de todos os escopos OAuth do Google.

* **cloud-platform**: Visualizar e gerenciar seus dados em servi√ßos do **Google Cloud Platform**. Voc√™ pode se passar pelo usu√°rio no GCP.
* **directory.readonly**: Ver e baixar o diret√≥rio GSuite da sua organiza√ß√£o. Obter nomes, telefones, URLs de calend√°rio de todos os usu√°rios.

## App Scripts

Desenvolvedores podem criar App Scripts e configur√°-los como um projeto independente ou vincul√°-los ao Google Docs/Sheets/Slides/Forms. App Scripts √© c√≥digo que ser√° acionado quando um usu√°rio com permiss√£o de editor acessar o doc (e ap√≥s aceitar o prompt OAuth)

No entanto, mesmo que o app n√£o seja verificado, existem algumas maneiras de n√£o mostrar esse prompt:

* Se o publicador do app estiver no mesmo Workspace que o usu√°rio que est√° acessando
* Se o script estiver em um drive do usu√°rio
### Bypass de Prompt N√£o Verificado ao Copiar Documento

Quando voc√™ cria um link para compartilhar um documento, um link semelhante a este √© criado: `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Se voc√™ **alterar** o final **"/edit"** para **"/copy"**, em vez de acess√°-lo, o Google perguntar√° se voc√™ deseja **gerar uma c√≥pia do documento.**

{% hint style="warning" %}
Se algu√©m criar uma **c√≥pia** desse **documento** que **continha o App Script**, ele tamb√©m estar√° **copiando o App Script**, portanto, quando ele **abrir** a planilha copiada, o **prompt regular OAuth** aparecer√° **bypassando o prompt n√£o verificado**, porque **o usu√°rio agora √© o autor do App Script do arquivo copiado**.
{% endhint %}

Este m√©todo tamb√©m poder√° bypassar a restri√ß√£o do admin do Workspace:

Mas pode ser prevenido com:

### Bypass de Prompt N√£o Verificado em Documento Compartilhado

Al√©m disso, se algu√©m **compartilhou** com voc√™ um documento com **acesso de editor**, voc√™ pode gerar **App Scripts dentro do documento** e o **PROPRIET√ÅRIO (criador) do documento ser√° o dono do App Script**.

{% hint style="warning" %}
Isso significa que o **criador do documento aparecer√° como criador de qualquer App Script** que qualquer pessoa com acesso de editor criar dentro dele.

Isso tamb√©m significa que o **App Script ser√° confi√°vel pelo ambiente Workspace** do criador do documento.
{% endhint %}

{% hint style="danger" %}
Isso tamb√©m significa que se um **App Script j√° existia** e as pessoas **concederam acesso**, qualquer pessoa com permiss√£o de **Editor** no documento pode **modific√°-lo e abusar desse acesso.**\
Para abusar disso, voc√™ tamb√©m precisa que as pessoas ativem o App Script. E um truque interessante √© **publicar o script como um aplicativo web**. Quando as **pessoas** que j√° concederam **acesso** ao App Script acessarem a p√°gina da web, elas **ativar√£o o App Script** (isso tamb√©m funciona usando tags `<img>`.
{% endhint %}

## P√≥s-Explora√ß√£o

### Privesc de Grupos do Google

Por padr√£o no Workspace, um **grupo** pode ser **acessado livremente** por qualquer membro da organiza√ß√£o.\
O Workspace tamb√©m permite **conceder permiss√£o a grupos** (at√© mesmo permiss√µes do GCP), ent√£o se os grupos podem ser unidos e eles t√™m permiss√µes extras, um atacante pode **abusar desse caminho para escalar privil√©gios**.

Voc√™ potencialmente precisa de acesso ao console para se juntar a grupos que permitem ser unidos por qualquer pessoa na org. Verifique as informa√ß√µes dos grupos em [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoting do GWS para o GCP

* Abusando do **privesc de grupos do Google** voc√™ pode ser capaz de escalar para um grupo com algum tipo de acesso privilegiado ao GCP
* Abusando de **aplica√ß√µes OAuth** voc√™ pode ser capaz de se passar por usu√°rios e acessar o GCP em nome deles

### Pivoting do GCP para o GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acessar Informa√ß√µes de E-mail dos Grupos

Se voc√™ conseguiu **comprometer uma sess√£o de usu√°rio do Google**, a partir de [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) voc√™ pode ver o hist√≥rico de e-mails enviados para os grupos de e-mail dos quais o usu√°rio √© membro, e voc√™ pode encontrar **credenciais** ou outros **dados sens√≠veis**.

### Takeout - Baixar Tudo o Que o Google Sabe Sobre uma Conta

Se voc√™ tem uma **sess√£o dentro da conta do Google da v√≠tima** voc√™ pode baixar tudo o que o Google salva sobre essa conta de [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - Baixar Todos os Dados do Workspace dos Usu√°rios

Se uma organiza√ß√£o tem **Google Vault ativado**, voc√™ pode ser capaz de acessar [**https://vault.google.com**](https://vault.google.com/u/1/) e **baixar** todas as **informa√ß√µes**.

### Download de Contatos

De [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) voc√™ pode baixar todos os **contatos** do usu√°rio.

### Cloudsearch

Em [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) voc√™ pode simplesmente pesquisar **por todo o conte√∫do do Workspace** (email, drive, sites...) ao qual um usu√°rio tem acesso. Ideal para **encontrar rapidamente informa√ß√µes sens√≠veis**.

### Currents

Em [**https://currents.google.com/**](https://currents.google.com) voc√™ pode acessar um **Chat do Google**, ent√£o voc√™ pode encontrar informa√ß√µes sens√≠veis l√°.

### Minera√ß√£o no Google Drive

Ao **compartilhar** um documento, voc√™ pode **especificar** as **pessoas** que podem acess√°-lo uma por uma, **compartilhar** com sua **empresa inteira** (**ou** com alguns **grupos** espec√≠ficos) **gerando um link**.

Ao compartilhar um documento, nas configura√ß√µes avan√ßadas voc√™ tamb√©m pode **permitir que as pessoas pesquisem** por este arquivo (por **padr√£o** isso est√° **desativado**). No entanto, √© importante notar que uma vez que os usu√°rios visualizam um documento, ele se torna pesquis√°vel por eles.

Pela simplicidade, a maioria das pessoas ir√° gerar e compartilhar um link em vez de adicionar as pessoas que podem acessar o documento uma por uma.

Algumas maneiras propostas para encontrar todos os documentos:

* Pesquisar em chat interno, f√≥runs...
* **Spider** em **documentos** conhecidos procurando por **refer√™ncias** a outros documentos. Voc√™ pode fazer isso dentro de um App Script com [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

Em [**https://keep.google.com/**](https://keep.google.com) voc√™ pode acessar as notas do usu√°rio, **informa√ß√µes sens√≠veis** podem estar salvas aqui.

### Persist√™ncia Dentro de uma Conta Google

Se voc√™ conseguiu **comprometer uma sess√£o de usu√°rio do Google** e o usu√°rio tinha **2FA**, voc√™ pode **gerar** uma [**senha de aplicativo**](https://support.google.com/accounts/answer/185833?hl=en) e **regenerar os c√≥digos de backup do 2FA** para saber que mesmo se o usu√°rio mudar a senha voc√™ **ser√° capaz de acessar a conta dele**. Outra op√ß√£o **em vez** de **regenerar** os c√≥digos √© **inscrever seu pr√≥prio aplicativo autenticador** no 2FA.

### Persist√™ncia via Aplicativos OAuth

Se voc√™ **comprometeu a conta de um usu√°rio,** voc√™ pode simplesmente **aceitar** conceder todas as permiss√µes poss√≠veis a um **Aplicativo OAuth**. O √∫nico problema √© que o Workspace pode ser configurado para **n√£o permitir aplicativos OAuth externos e/ou internos n√£o revisados.**\
√â bastante comum n√£o confiar por padr√£o em aplicativos OAuth externos, mas confiar nos internos, ent√£o se voc√™ tem **permiss√µes suficientes para gerar um novo aplicativo OAuth** dentro da organiza√ß√£o e aplicativos externos s√£o proibidos, gere-o e **use esse novo aplicativo OAuth interno para manter a persist√™ncia**.
### Persist√™ncia via delega√ß√£o

Voc√™ pode simplesmente **delegar a conta** para uma conta diferente controlada pelo atacante.

### Persist√™ncia via Aplicativo Android

Se voc√™ tem uma **sess√£o dentro da conta Google da v√≠tima**, voc√™ pode navegar at√© a **Play Store** e **instalar malware** que voc√™ j√° carregou diretamente **no telefone** para manter a persist√™ncia e acessar o telefone da v√≠tima.

### **Persist√™ncia via Gmail**

* Voc√™ pode criar **filtros para ocultar** notifica√ß√µes de seguran√ßa do Google
* de: (no-reply@accounts.google.com) "Alerta de Seguran√ßa"
* Ocultar e-mails de redefini√ß√£o de senha
* Criar **endere√ßo de encaminhamento para encaminhar informa√ß√µes sens√≠veis** (ou tudo) - Voc√™ precisa de acesso manual.
* Criar um endere√ßo de encaminhamento para enviar e-mails que cont√™m a palavra "senha", por exemplo
* Adicionar **e-mail/telefone de recupera√ß√£o sob controle do atacante**

### **Persist√™ncia via** App Scripts

Voc√™ pode criar **gatilhos baseados em tempo** em App Scripts, ent√£o se o App Script for aceito pelo usu√°rio, ele ser√° **acionado** mesmo **sem o usu√°rio acess√°-lo**.

A documenta√ß√£o menciona que para usar `ScriptApp.newTrigger("funcion")` voc√™ precisa do **escopo** `script.scriptapp`, mas **aparentemente isso n√£o √© necess√°rio** contanto que voc√™ tenha declarado algum outro escopo.

### **Administrar Workspace**

Em [**https://admin.google.com**/](https://admin.google.com), voc√™ pode ser capaz de modificar as configura√ß√µes do Workspace de toda a organiza√ß√£o se tiver permiss√µes suficientes.

Voc√™ tamb√©m pode encontrar e-mails pesquisando atrav√©s de todas as faturas dos usu√°rios em [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## Recupera√ß√£o de Conta Comprometida

* Sair de todas as sess√µes
* Mudar senha do usu√°rio
* Gerar novos c√≥digos de backup 2FA
* Remover senhas de App
* Remover aplicativos OAuth
* Remover dispositivos 2FA
* Remover encaminhadores de e-mail
* Remover filtros de e-mails
* Remover e-mail/telefones de recupera√ß√£o
* Remover Aplicativos Android ruins
* Remover delega√ß√µes de conta ruins

## Refer√™ncias

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
