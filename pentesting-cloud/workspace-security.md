# Pentesting de Workspace

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Phishing sur Workspace

### M√©thodologie G√©n√©rique de Phishing

### Phishing avec Google Groups

Apparemment, par d√©faut dans Workspace, les membres [**peuvent cr√©er des groupes**](https://groups.google.com/all-groups) **et inviter des personnes**. Vous pouvez ensuite modifier l'email qui sera envoy√© √† l'utilisateur **en ajoutant des liens**. **L'email proviendra d'une adresse Google**, donc il semblera **l√©gitime** et les gens pourraient cliquer sur le lien.

### Phishing avec Hangout

Vous pourriez √™tre capable de parler directement avec une personne en ayant juste son adresse email ou envoyer une invitation √† parler. Dans les deux cas, vous pouvez modifier un compte email en le nommant par exemple "S√©curit√© Google" et en ajoutant des logos Google, et les gens penseront qu'ils parlent √† Google : [https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

La **m√™me technique** peut √™tre utilis√©e avec **Google Chat**.

### Phishing avec Google Doc

Vous pouvez cr√©er un **document apparemment l√©gitime** et dans un commentaire **mentionner une adresse email (comme +user@gmail.com)**. Google **enverra un email √† cette adresse** pour notifier qu'elle a √©t√© mentionn√©e dans le document. Vous pouvez **mettre un lien dans ce document** pour essayer de faire acc√©der la personne √† celui-ci.

### Phishing avec Google Calendar

Vous pouvez **cr√©er un √©v√©nement dans le calendrier** et ajouter autant d'adresses email de l'entreprise que vous attaquez que vous avez. Planifiez cet √©v√©nement dans **5 ou 15 min** √† partir de l'heure actuelle. Faites en sorte que l'√©v√©nement semble l√©gitime et **mettez un commentaire indiquant qu'ils doivent lire quelque chose** (avec le **lien de phishing**).\
Pour le rendre moins suspect :

* Configurez-le de sorte que **les destinataires ne puissent pas voir les autres personnes invit√©es**
* **NE PAS envoyer d'emails notifiant de l'√©v√©nement**. Ainsi, les gens verront seulement leur avertissement concernant une r√©union dans 5 minutes et qu'ils doivent lire ce lien.
* Apparemment, en utilisant l'API, vous pouvez d√©finir sur **Vrai** que les **personnes** ont **accept√©** l'√©v√©nement et m√™me cr√©er **des commentaires en leur nom**.

### Phishing avec OAuth

N'importe laquelle des techniques pr√©c√©dentes pourrait √™tre utilis√©e pour amener l'utilisateur √† acc√©der √† une **application Google OAuth** qui **demandera** √† l'utilisateur un **acc√®s**. Si l'utilisateur **fait confiance** √† la **source**, il pourrait **faire confiance** √† l'**application** (m√™me si elle demande des permissions √† haut niveau de privil√®ge).

Notez que Google pr√©sente une invite d√©sagr√©able avertissant que l'application n'est pas fiable dans plusieurs cas et les administrateurs de Workspace peuvent m√™me emp√™cher les gens d'accepter des applications OAuth. Plus d'informations dans la section OAuth.

## Password Spraying

Pour tester les mots de passe avec tous les emails que vous avez trouv√©s (ou que vous avez g√©n√©r√©s en vous basant sur un mod√®le de nom d'email que vous pourriez avoir d√©couvert), vous pouvez utiliser un outil comme [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) qui utilisera des lambdas AWS pour changer d'adresse IP.

## Applications OAuth

**Google** permet de cr√©er des applications qui peuvent **interagir pour le compte des utilisateurs** avec plusieurs **services Google** : Gmail, Drive, GCP...

Lors de la cr√©ation d'une application pour **agir pour le compte d'autres utilisateurs**, le d√©veloppeur doit cr√©er une **application OAuth dans GCP** et indiquer les √©tendues (permissions) dont l'application a besoin pour acc√©der aux donn√©es des utilisateurs.\
Lorsqu'un **utilisateur** souhaite **utiliser** cette **application**, il sera **invit√©** √† **accepter** que l'application ait acc√®s √† ses donn√©es sp√©cifi√©es dans les √©tendues.

C'est une mani√®re tr√®s attrayante de **phisher** des utilisateurs non techniques en les faisant utiliser **des applications qui acc√®dent √† des informations sensibles** car ils pourraient ne pas comprendre les cons√©quences. Cependant, dans les comptes d'organisations, il existe des moyens d'emp√™cher cela.

### Invite d'Application Non V√©rifi√©e

Comme mentionn√©, Google pr√©sentera toujours une **invite √† l'utilisateur pour accepter** les permissions qu'ils donnent √† l'application en leur nom. Cependant, si l'application est consid√©r√©e comme **dangereuse**, Google affichera **d'abord** une **invite** indiquant qu'elle est **dangereuse** et **rendant plus difficile** pour l'utilisateur d'accorder les permissions √† l'application.

Cette invite appara√Æt dans les applications qui :

* Utilisent une √©tendue qui peut acc√©der √† des donn√©es priv√©es (Gmail, Drive, GCP, BigQuery...)
* Applications avec moins de 100 utilisateurs (les applications > 100 n√©cessitent √©galement un processus de r√©vision pour arr√™ter d'afficher l'invite non v√©rifi√©e)

### √âtendues Int√©ressantes

[**Ici**](https://developers.google.com/identity/protocols/oauth2/scopes) vous pouvez trouver une liste de toutes les √©tendues OAuth de Google.

* **cloud-platform** : Voir et g√©rer vos donn√©es √† travers les services **Google Cloud Platform**. Vous pouvez vous faire passer pour l'utilisateur dans GCP.
* **directory.readonly** : Voir et t√©l√©charger l'annuaire GSuite de votre organisation. Obtenir les noms, t√©l√©phones, URLs de calendrier de tous les utilisateurs.

## Scripts d'Applications

Les d√©veloppeurs peuvent cr√©er des Scripts d'Applications et les d√©finir comme un projet autonome ou les lier √† Google Docs/Sheets/Slides/Forms. Les Scripts d'Applications sont du code qui sera d√©clench√© lorsqu'un utilisateur avec la permission d'√©diteur acc√®de au document (et apr√®s avoir accept√© l'invite OAuth)

Cependant, m√™me si l'application n'est pas v√©rifi√©e, il existe quelques moyens de ne pas afficher cette invite :

* Si l'√©diteur de l'application est dans le m√™me Workspace que l'utilisateur y acc√©dant
* Si le script est dans un drive de l'utilisateur
### Contournement de l'invite de copie de document non v√©rifi√©e

Lorsque vous cr√©ez un lien pour partager un document, un lien similaire √† celui-ci est cr√©√© : `https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
Si vous **changez** la fin **"/edit"** par **"/copy"**, au lieu d'y acc√©der, Google vous demandera si vous souhaitez **g√©n√©rer une copie du document.**

{% hint style="warning" %}
Si quelqu'un cr√©e une **copie** de ce **document** qui **contenait le App Script**, il copiera √©galement le App Script, donc lorsqu'il **ouvre** la **feuille de calcul copi√©e**, l'**invite OAuth r√©guli√®re** appara√Ætra **en contournant l'invite non v√©rifi√©e**, parce que **l'utilisateur est maintenant l'auteur du App Script du fichier copi√©**.
{% endhint %}

Cette m√©thode permettra √©galement de contourner la restriction d'administration de Workspace :

Mais peut √™tre √©vit√©e avec :

### Contournement de l'invite de document partag√© non v√©rifi√©e

De plus, si quelqu'un a **partag√©** avec vous un document avec un **acc√®s √©diteur**, vous pouvez g√©n√©rer **des App Scripts √† l'int√©rieur du document** et le **PROPRI√âTAIRE (cr√©ateur) du document sera le propri√©taire du App Script**.

{% hint style="warning" %}
Cela signifie que le **cr√©ateur du document appara√Ætra comme cr√©ateur de tout App Script** que toute personne avec un acc√®s √©diteur cr√©e √† l'int√©rieur de celui-ci.

Cela signifie √©galement que le **App Script sera consid√©r√© comme fiable par l'environnement Workspace** du cr√©ateur du document.
{% endhint %}

{% hint style="danger" %}
Cela signifie aussi que si un **App Script existait d√©j√†** et que les gens ont **accord√© l'acc√®s**, toute personne avec une permission **√âditeur** sur le document peut **le modifier et abuser de cet acc√®s.**\
Pour abuser de cela, vous avez √©galement besoin que les gens d√©clenchent le App Script. Et une astuce int√©ressante est de **publier le script en tant qu'application web**. Lorsque les **personnes** qui ont d√©j√† accord√© **l'acc√®s** au App Script acc√®dent √† la page web, elles **d√©clencheront le App Script** (cela fonctionne aussi en utilisant des balises `<img>`).
{% endhint %}

## Post-Exploitation

### √âl√©vation de privil√®ges avec Google Groups

Par d√©faut dans Workspace, un **groupe** peut √™tre **librement accessible** par tout membre de l'organisation.\
Workspace permet √©galement d'**accorder des permissions aux groupes** (y compris des permissions GCP), donc si des groupes peuvent √™tre rejoints et qu'ils ont des permissions suppl√©mentaires, un attaquant peut **abuser de cette voie pour escalader les privil√®ges**.

Vous avez potentiellement besoin d'acc√©der √† la console pour rejoindre des groupes qui permettent √† n'importe qui dans l'org de les rejoindre. V√©rifiez les informations des groupes sur [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups).

### Pivoter de GWS vers GCP

* En abusant de l'**√©l√©vation de privil√®ges avec google groups**, vous pourriez √™tre en mesure d'escalader vers un groupe avec un certain type d'acc√®s privil√©gi√© √† GCP
* En abusant des **applications OAuth**, vous pourriez √™tre en mesure d'usurper l'identit√© des utilisateurs et d'acc√©der √† GCP en leur nom

### Pivoter de GCP vers GWS

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### Acc√©der aux informations de messagerie des groupes

Si vous avez r√©ussi √† **compromettre une session utilisateur Google**, depuis [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) vous pouvez voir l'historique des mails envoy√©s aux groupes de messagerie dont l'utilisateur est membre, et vous pourriez trouver des **identifiants** ou d'autres **donn√©es sensibles**.

### Takeout - T√©l√©charger tout ce que Google sait sur un compte

Si vous avez une **session √† l'int√©rieur du compte Google de la victime**, vous pouvez t√©l√©charger tout ce que Google enregistre sur ce compte depuis [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)

### Vault - T√©l√©charger toutes les donn√©es Workspace des utilisateurs

Si une organisation a **Google Vault activ√©**, vous pourriez √™tre en mesure d'acc√©der √† [**https://vault.google.com**](https://vault.google.com/u/1/) et de **t√©l√©charger** toutes les **informations**.

### T√©l√©chargement des contacts

Depuis [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) vous pouvez t√©l√©charger tous les **contacts** de l'utilisateur.

### Cloudsearch

Dans [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) vous pouvez simplement rechercher **√† travers tout le contenu de Workspace** (email, drive, sites...) auquel un utilisateur a acc√®s. Id√©al pour **trouver rapidement des informations sensibles**.

### Currents

Dans [**https://currents.google.com/**](https://currents.google.com) vous pouvez acc√©der √† un **Chat Google**, donc vous pourriez trouver des informations sensibles l√†-bas.

### Exploration de Google Drive

Lorsque vous **partagez** un document, vous pouvez **sp√©cifier** les **personnes** qui peuvent y acc√©der une par une, **partager** avec votre **entreprise enti√®re** (**ou** avec certains **groupes** sp√©cifiques) en **g√©n√©rant un lien**.

Lors du partage d'un document, dans les param√®tres avanc√©s, vous pouvez √©galement **permettre aux gens de rechercher** ce fichier (par **d√©faut** cela est **d√©sactiv√©**). Cependant, il est important de noter qu'une fois qu'un utilisateur consulte un document, il est recherchable par cet utilisateur.

Pour des raisons de simplicit√©, la plupart des gens vont g√©n√©rer et partager un lien au lieu d'ajouter une par une les personnes pouvant acc√©der au document.

Quelques m√©thodes propos√©es pour trouver tous les documents :

* Rechercher dans le chat interne, les forums...
* **Explorer** les **documents** connus √† la recherche de **r√©f√©rences** √† d'autres documents. Vous pouvez faire cela avec un App Script et [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)

### **Keep Notes**

Dans [**https://keep.google.com/**](https://keep.google.com) vous pouvez acc√©der aux notes de l'utilisateur, des **informations sensibles** pourraient √™tre enregistr√©es ici.

### Persistance √† l'int√©rieur d'un compte Google

Si vous avez r√©ussi √† **compromettre une session utilisateur Google** et que l'utilisateur avait **2FA**, vous pouvez **g√©n√©rer** un [**mot de passe d'application**](https://support.google.com/accounts/answer/185833?hl=en) et **r√©g√©n√©rer les codes de sauvegarde 2FA** pour savoir que m√™me si l'utilisateur change le mot de passe, vous **pourrez acc√©der √† son compte**. Une autre option **au lieu** de **r√©g√©n√©rer** les codes est d'**enregistrer votre propre application d'authentification** dans le 2FA.

### Persistance via les applications OAuth

Si vous avez **compromis le compte d'un utilisateur,** vous pouvez simplement **accepter** d'accorder toutes les permissions possibles √† une **application OAuth**. Le seul probl√®me est que Workspace peut √™tre configur√© pour **interdire les applications OAuth externes et/ou internes non examin√©es.**\
Il est assez courant de ne pas faire confiance par d√©faut aux applications OAuth externes mais de faire confiance √† celles internes, donc si vous avez **assez de permissions pour g√©n√©rer une nouvelle application OAuth** √† l'int√©rieur de l'organisation et que les applications externes sont interdites, g√©n√©rez-la et **utilisez cette nouvelle application OAuth interne pour maintenir la persistance**.
### Persistance via d√©l√©gation

Vous pouvez simplement **d√©l√©guer le compte** √† un autre compte contr√¥l√© par l'attaquant.

### Persistance via Application Android

Si vous avez une **session dans le compte Google de la victime**, vous pouvez naviguer vers le **Play Store** et **installer un logiciel malveillant** que vous avez d√©j√† t√©l√©charg√© directement **sur le t√©l√©phone** pour maintenir la persistance et acc√©der au t√©l√©phone de la victime.

### **Persistance via Gmail**

* Vous pouvez cr√©er des **filtres pour cacher** les notifications de s√©curit√© de Google
* de : (no-reply@accounts.google.com) "Alerte de s√©curit√©"
* Cacher les emails de r√©initialisation de mot de passe
* Cr√©er une **adresse de transfert pour transf√©rer des informations sensibles** (ou tout) - Vous avez besoin d'un acc√®s manuel.
* Cr√©er une adresse de transfert pour envoyer des emails contenant le mot "mot de passe" par exemple
* Ajouter un **email/t√©l√©phone de r√©cup√©ration sous le contr√¥le de l'attaquant**

### **Persistance via** App Scripts

Vous pouvez cr√©er des **d√©clencheurs bas√©s sur le temps** dans App Scripts, donc si le App Script est accept√© par l'utilisateur, il sera **d√©clench√©** m√™me **sans que l'utilisateur y acc√®de**.

La documentation mentionne que pour utiliser `ScriptApp.newTrigger("funcion")` vous avez besoin du **scope** `script.scriptapp`, mais **apparemment ce n'est pas n√©cessaire** tant que vous avez d√©clar√© un autre scope.

### **Administrer Workspace**

Dans [**https://admin.google.com**/](https://admin.google.com), vous pourriez √™tre capable de modifier les param√®tres de Workspace de toute l'organisation si vous avez suffisamment de permissions.

Vous pouvez √©galement trouver des emails en cherchant √† travers toutes les factures des utilisateurs dans [**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)

## R√©cup√©ration d'un Compte Compromis

* Se d√©connecter de toutes les sessions
* Changer le mot de passe de l'utilisateur
* G√©n√©rer de nouveaux codes de sauvegarde 2FA
* Supprimer les mots de passe d'application
* Supprimer les applications OAuth
* Supprimer les dispositifs 2FA
* Supprimer les transferts d'email
* Supprimer les filtres d'email
* Supprimer l'email/les t√©l√©phones de r√©cup√©ration
* Supprimer les mauvaises applications Android
* Supprimer les mauvaises d√©l√©gations de compte

## R√©f√©rences

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - Hacking G Suite: The Power of Dark Apps Script Magic
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch et Beau Bullock - OK Google, How do I Red Team GSuite?

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
