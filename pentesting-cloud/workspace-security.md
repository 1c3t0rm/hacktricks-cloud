# Workspace Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## Workspace Phishing

### 一般的なフィッシング手法

### Google Groups Phishing

デフォルトでは、Workspaceメンバーは[**グループを作成**](https://groups.google.com/all-groups)し、**人々を招待することができます**。その後、ユーザーに送信されるメールを変更し、**リンクを追加することができます**。**メールはGoogleのアドレスから送信される**ので、正当に見え、人々はリンクをクリックするかもしれません。

### Hangout Phishing

メールアドレスを知っているだけで直接人と話すことができるかもしれませんし、話をするための招待を送ることもできます。どちらにしても、"Google Security"という名前のメールアカウントを変更し、Googleのロゴを追加することで、人々はGoogleと話していると思うかもしれません：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

**Google Chat**でも**同じ技術**が使えます。

### Google Doc Phishing

**正当に見えるドキュメント**を作成し、コメントで**メールアドレス（例：+user@gmail.com）**を**言及することができます**。Googleはそのメールアドレスに通知を送り、ドキュメントで言及されたことを知らせます。そのドキュメントに**リンクを置く**ことで、人々がアクセスするように試みることができます。

### Google Calendar Phishing

**カレンダーイベントを作成**し、攻撃している会社のできるだけ多くのメールアドレスを追加します。このカレンダーイベントを現在時刻から**5分または15分後**にスケジュールします。イベントを正当に見せ、**何かを読む必要がある**とコメントで指摘します（**フィッシングリンク**を使用）。\
怪しまれないようにするために：

* 受信者が他の招待された人を見ることができないように設定する
* イベントに関する通知メールを**送らない**。そうすると、人々は5分後の会議の警告とそのリンクを読む必要があることだけを見るでしょう。
* APIを使用して、人々がイベントを**受け入れた**と**True**に設定し、さらに彼らに代わって**コメントを作成する**ことができるようです。

### OAuth Phishing

上記のいずれかの技術を使用して、ユーザーが**Google OAuthアプリケーション**にアクセスさせ、ユーザーにいくつかの**アクセス**を**要求**することができます。ユーザーが**ソース**を**信頼**していれば、アプリケーション（たとえ高い権限を要求していても）を**信頼**するかもしれません。

Googleは、アプリケーションが信頼されていないと警告する醜いプロンプトをいくつかのケースで表示し、Workspace管理者はOAuthアプリケーションを受け入れることを防ぐことさえできます。OAuthセクションで詳しく説明します。

## Password Spraying

見つけた（または発見したかもしれないメール名パターンに基づいて生成した）すべてのメールでパスワードをテストするために、IPアドレスを変更するためにAWSラムダを使用するツール[**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing)を使用できます。

## Oauth Apps

**Google**は、Gmail、Drive、GCPなどのいくつかの**Googleサービス**でユーザーに代わって**操作できるアプリケーション**を作成することを許可しています。

他のユーザーに代わって操作するアプリケーションを作成する場合、開発者は**GCP内にOAuthアプリ**を作成し、アプリがユーザーデータにアクセスするために必要なスコープ（権限）を指定する必要があります。\
**ユーザー**がその**アプリケーション**を**使用**したい場合、スコープで指定されたデータにアプリケーションがアクセスすることを**受け入れるように促されます**。

これは、機密情報にアクセスする**アプリケーション**を使用するように非技術的なユーザーを**フィッシング**する非常に魅力的な方法ですが、組織のアカウントではこれを防ぐ方法があります。

### 未検証アプリプロンプト

言及されたように、googleは常にユーザーにアプリケーションに与える権限を受け入れる**プロンプト**を表示します。しかし、アプリケーションが**危険**と見なされる場合、googleは**最初に**、それが**危険**であることを示す**プロンプト**を表示し、ユーザーがアプリに権限を付与することを**より困難**にします。

このプロンプトは以下のアプリで表示されます：

* プライベートデータにアクセスできるスコープを使用するアプリ（Gmail、Drive、GCP、BigQueryなど）
* 100ユーザー未満のアプリ（100ユーザーを超えるアプリでは、未検証プロンプトを表示しないようにするためにもレビュープロセスが必要です）

### 興味深いスコープ

[**ここ**](https://developers.google.com/identity/protocols/oauth2/scopes)でGoogle OAuthスコープのリストを見ることができます。

* **cloud-platform**: **Google Cloud Platform**サービス全体でデータを表示および管理します。GCPでユーザーになりすますことができます。
* **directory.readonly**: 組織のGSuiteディレクトリを見てダウンロードします。すべてのユーザーの名前、電話、カレンダーURLを取得します。

## App Scripts

開発者はApp Scriptsを作成し、それをスタンドアロンプロジェクトとして設定するか、Google Docs/Sheets/Slides/Formsにバインドすることができます。App Scriptsは、編集権限を持つユーザーがドキュメントにアクセスしたとき（OAuthプロンプトを受け入れた後）にトリガーされるコードです。

しかし、アプリが検証されていなくても、そのプロンプトを表示しない方法がいくつかあります：

* アプリの発行者がアクセスしているユーザーと同じWorkspaceにいる場合
* スクリプトがユーザーのドライブ内にある場合
### コピー文書未検証プロンプトバイパス

文書のリンクを共有すると、このようなリンクが作成されます：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
もし、リンクの最後の **"/edit"** を **"/copy"** に**変更**すると、アクセスする代わりにGoogleは文書の**コピーを生成するかどうか**尋ねます。

{% hint style="warning" %}
もし誰かがその**アプリスクリプトを含む文書**の**コピー**を作成した場合、アプリスクリプトも**コピーされる**ため、コピーされた**スプレッドシート**を**開く**と、**通常のOAuthプロンプト**が表示され、未検証プロンプトが**バイパスされます**。なぜなら、**ユーザーがコピーされたファイルのアプリスクリプトの作者になるからです**。
{% endhint %}

この方法はWorkspace管理者の制限もバイパスできますが、以下の方法で防ぐことができます：

### 共有文書未検証プロンプトバイパス

さらに、編集アクセス権を持っている文書を**共有**された場合、その文書内に**アプリスクリプトを生成**することができ、その文書の**所有者（作成者）がアプリスクリプトの所有者になります**。

{% hint style="warning" %}
これは、編集アクセス権を持つ人がその中で作成した**任意のアプリスクリプトの作成者として文書の作成者が表示される**ことを意味します。

これはまた、その文書の作成者のWorkspace環境によって**アプリスクリプトが信頼される**ことも意味します。
{% endhint %}

{% hint style="danger" %}
これはまた、**アプリスクリプトが既に存在していて**、人々がアクセスを**許可している**場合、文書に**編集者**権限を持つ人はそれを**変更してそのアクセスを悪用する**ことができるということを意味します。\
これを悪用するには、人々がアプリスクリプトをトリガーする必要があります。そして、もしアプリスクリプトを**ウェブアプリとして公開する**という巧妙なトリックがあります。アプリスクリプトに**アクセスを許可した**人々がそのウェブページにアクセスすると、アプリスクリプトを**トリガー**します（これは`<img>`タグを使用しても機能します）。
{% endhint %}

## 侵害後の活動

### Googleグループ権限昇格

デフォルトでは、Workspace内の**グループ**は組織のメンバーによって**自由にアクセス**できます。\
Workspaceでは、**グループに権限を付与**することも可能です（GCP権限も含む）。したがって、グループに参加できて追加の権限がある場合、攻撃者はその道を悪用して**権限を昇格させる**可能性があります。

組織内の誰でも参加できるグループに参加するためには、コンソールへのアクセスが必要になることがあります。[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)でグループ情報を確認してください。

### GWSからGCPへのピボット

* **Googleグループ権限昇格**を悪用することで、GCPへの特権アクセスを持つグループに昇格することができるかもしれません
* **OAuthアプリケーション**を悪用することで、ユーザーになりすましてその代わりにGCPにアクセスすることができるかもしれません

### GCPからGWSへのピボット

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### アクセスグループメール情報

もし**Googleユーザーセッションを侵害**することに成功した場合、[**https://groups.google.com/all-groups**](https://groups.google.com/all-groups)から、ユーザーがメンバーであるメールグループに送信されたメールの履歴を見ることができ、**認証情報**やその他の**機密データ**を見つける可能性があります。

### Takeout - Googleがアカウントについて知っているすべての情報をダウンロード

もし被害者のGoogleアカウント内で**セッションを持っている**場合、[**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none)からGoogleがそのアカウントについて保存しているすべての情報をダウンロードすることができます。

### Vault - ユーザーのWorkspaceデータをすべてダウンロード

もし組織が**Google Vaultを有効にしている**場合、[**https://vault.google.com**](https://vault.google.com/u/1/)にアクセスして、すべての**情報**を**ダウンロード**することができるかもしれません。

### 連絡先ダウンロード

[**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC)から、ユーザーのすべての**連絡先**をダウンロードすることができます。

### Cloudsearch

[**https://cloudsearch.google.com/**](https://cloudsearch.google.com)では、ユーザーがアクセスできるすべてのWorkspaceコンテンツ（メール、ドライブ、サイトなど）を検索することができます。**機密情報を迅速に見つける**のに理想的です。

### Currents

[**https://currents.google.com/**](https://currents.google.com)では、Google **チャット**にアクセスできるため、そこで機密情報を見つける可能性があります。

### Googleドライブマイニング

文書を**共有**する際に、アクセスできる**人々**を一人ずつ**指定**するか、**リンクを生成**して**自社全体**（**または**特定の**グループ**）と**共有**することができます。

文書を共有する際、詳細設定でこのファイルを検索できるように**許可する**こともできます（**デフォルト**ではこれは**無効**です）。ただし、一度ユーザーが文書を閲覧すると、それは彼らによって検索可能になることに注意が必要です。

簡単のために、ほとんどの人はリンクを生成して共有する代わりに、アクセスできる人々を一人ずつ追加することを選びます。

すべての文書を見つけるための提案された方法：

* 内部チャット、フォーラムなどで検索する
* 既知の**文書をスパイダー**して、他の文書への**参照**を検索する。これは[**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser)を使ってアプリスクリプト内で行うことができます

### **Keep Notes**

[**https://keep.google.com/**](https://keep.google.com)では、ユーザーのノートにアクセスでき、ここに**機密**な**情報**が保存されている可能性があります。

### Googleアカウント内での持続性

もし**Googleユーザーセッションを侵害**することに成功し、ユーザーが**2FA**を持っていた場合、[**アプリパスワード**](https://support.google.com/accounts/answer/185833?hl=en)を**生成**し、2FAバックアップコードを**再生成**して、ユーザーがパスワードを変更しても**アカウントにアクセスできる**ことを知ることができます。コードを**再生成する**代わりに、2FAに**自分の認証アプリを登録する**という別のオプションもあります。

### OAuthアプリを通じた持続性

もし**ユーザーアカウントを侵害**している場合、単にOAuthアプリにすべての可能な権限を付与することを**承諾**することができます。唯一の問題は、Workspaceが**未レビューの外部および/または内部OAuthアプリを許可しない**ように設定されている可能性があることです。\
外部OAuthアプリをデフォルトで信頼しないことはかなり一般的ですが、内部のものは信頼されることが多いので、組織内で新しいOAuthアプリケーションを生成するのに十分な権限を持っていて、外部アプリが許可されていない場合は、それを生成し、その新しい内部OAuthアプリを使用して持続性を維持します。
### 権限委譲による持続性

攻撃者が制御する別のアカウントに**アカウントを委譲**することができます。

### Androidアプリを通じた持続性

**被害者のGoogleアカウント内にセッションがある場合**、**Play Store**にアクセスして、すでにアップロードした**マルウェアを電話に直接インストール**し、持続性を維持し、被害者の電話にアクセスできます。

### **Gmailを通じた持続性**

* Googleからのセキュリティ通知を隠す**フィルターを作成**できます
* from: (no-reply@accounts.google.com) "Security Alert"
* パスワードリセットメールを隠す
* **機密情報（またはすべて）を転送する転送アドレスを作成**する - 手動アクセスが必要です。
* 例えば「password」という単語を含むメールを送信するための転送アドレスを作成する
* 攻撃者の制御下にある**回復用メール/電話を追加**

### **App Scriptsを通じた持続性**

App Scriptsで**時間ベースのトリガー**を作成できるため、ユーザーがそれを受け入れると、ユーザーがアクセスしなくても**トリガーされます**。

ドキュメントには`ScriptApp.newTrigger("function")`を使用するには**スコープ**`script.scriptapp`が必要と記載されていますが、他のスコープを宣言している限り、**それは必要ないようです**。

### **Workspaceの管理**

[**https://admin.google.com**/](https://admin.google.com)では、十分な権限があれば、組織全体のWorkspace設定を変更できる可能性があります。

また、[**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)で全ユーザーの請求書を検索することでメールアドレスを見つけることもできます。

## アカウント侵害の回復

* すべてのセッションからログアウトする
* ユーザーパスワードを変更する
* 新しい2FAバックアップコードを生成する
* アプリパスワードを削除する
* OAuthアプリを削除する
* 2FAデバイスを削除する
* メール転送設定を削除する
* メールフィルターを削除する
* 回復用メール/電話を削除する
* 悪意のあるAndroidアプリを削除する
* 不正なアカウント委譲を削除する

## 参考文献

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - G Suiteのハッキング：ダークApp Scriptマジックの力
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch and Beau Bullock - OK Google, GSuiteのレッドチームはどうやって？

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTコレクション**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
