# Workspace 渗透测试

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## Workspace 钓鱼攻击

### 通用钓鱼方法论

### Google Groups 钓鱼

显然，默认情况下，workspace 成员[**可以创建群组**](https://groups.google.com/all-groups) **并邀请人加入**。然后，您可以修改将发送给用户的电子邮件，**添加一些链接**。**电子邮件将来自 Google 地址**，因此看起来**合法**，人们可能会点击链接。

### Hangout 钓鱼

您可能能够直接与仅有电子邮件地址的人交谈，或发送交谈邀请。无论哪种方式，您都可以修改电子邮件账户，可能命名为 "Google 安全" 并添加一些 Google 徽标，人们会认为他们正在与 Google 交谈：[https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s](https://www.youtube.com/watch?v=KTVHLolz6cE\&t=904s)

与 **Google Chat** 使用的是**相同技术**。

### Google Doc 钓鱼

您可以创建一个**看似合法的文档**，然后在评论中**提及某个电子邮件（如 +user@gmail.com）**。Google 将**向该电子邮件地址发送电子邮件**，通知他们在文档中被提及。您可以**在该文档中放置链接**，试图让人访问它。

### Google Calendar 钓鱼

您可以**创建日历事件**，并添加尽可能多的您正在攻击的公司的电子邮件地址。将此日历事件安排在当前时间**5 或 15 分钟后**。使事件看起来合法，并**放置评论指出他们需要阅读某些内容**（带有**钓鱼链接**）。\
为了使其看起来不那么可疑：

* 设置以便**接收者无法看到其他被邀请的人**
* **不发送有关事件的电子邮件通知**。然后，人们只会看到他们关于 5 分钟后会议的警告，并且他们需要阅读那个链接。
* 显然使用 API，您可以将**人们**已**接受**事件设置为**True**，甚至可以代表他们**创建评论**。

### OAuth 钓鱼

之前的任何技术都可能被用来让用户访问一个**Google OAuth 应用程序**，该应用程序将**请求**用户一些**访问权限**。如果用户**信任**这个**来源**，他们可能会**信任**这个**应用程序**（即使它正在请求高权限）。

请注意，Google 在多种情况下会出现一个丑陋的提示，警告应用程序不受信任，Workspace 管理员甚至可以阻止人们接受 OAuth 应用程序。更多信息请参见 OAuth 部分。

## 密码喷涂

为了测试您找到的（或您根据可能发现的电子邮件名称模式生成的）所有电子邮件的密码，您可以使用像 [**https://github.com/ustayready/CredKing**](https://github.com/ustayready/CredKing) 这样的工具，它将使用 AWS lambdas 更换 IP 地址。

## Oauth 应用程序

**Google** 允许创建可以代表用户与多个 **Google 服务** 交互的应用程序：Gmail、Drive、GCP...

创建一个代表其他用户行动的应用程序时，开发者需要在 GCP 内创建一个 **OAuth 应用程序** 并指明应用程序需要访问用户数据的权限范围（scopes）。\
当一个**用户**想要**使用**那个**应用程序**时，他们将被**提示**接受应用程序将对其数据的访问权限。

这是一种非常诱人的方式，用来**钓鱼**非技术用户使用**访问敏感信息的应用程序**，因为他们可能不理解后果。然而，在组织账户中，有方法可以防止这种情况发生。

### 未验证的应用程序提示

如前所述，google 将始终向用户**提示接受**他们代表自己给予应用程序的权限。然而，如果应用程序被认为是**危险的**，google 将**首先**显示一个**提示**，指出它是**危险的**，并**使用户更难**授予应用程序权限。

这个提示出现在以下应用程序中：

* 使用任何可以访问私人数据的权限范围（Gmail、Drive、GCP、BigQuery...）
* 用户少于 100 个的应用程序（> 100 用户的应用程序也需要一个审核过程来停止显示未验证的提示）

### 有趣的权限范围

[**这里**](https://developers.google.com/identity/protocols/oauth2/scopes) 您可以找到所有 Google OAuth 权限范围的列表。

* **cloud-platform**：查看和管理您在 **Google Cloud Platform** 服务中的数据。您可以冒充用户在 GCP 中。
* **directory.readonly**：查看和下载您组织的 GSuite 目录。获取所有用户的姓名、电话、日历 URL。

## 应用脚本

开发者可以创建应用脚本，并将其设置为独立项目或绑定到 Google Docs/Sheets/Slides/Forms。应用脚本是代码，当用户具有编辑权限访问文档时（并在接受 OAuth 提示后）将被触发。

然而，即使应用程序未经验证，也有几种方法可以不显示该提示：

* 如果应用程序的发布者与访问它的用户在同一个 Workspace 中
* 如果脚本在用户的驱动器中
### 复制文档未验证提示绕过

当您创建一个链接来共享文档时，会创建类似这样的链接：`https://docs.google.com/spreadsheets/d/1i5[...]aIUD/edit`\
如果您将结尾的 **"/edit"** **更改**为 **"/copy"**，谷歌不会让您访问，而是会询问您是否要**生成文档的副本。**

{% hint style="warning" %}
如果有人创建了包含 App Script 的**文档**的**副本**，他也将**复制 App Script**，因此当他**打开**复制的**电子表格**时，**常规的 OAuth 提示**将会出现，**绕过未验证的提示**，因为**用户现在是复制文件的 App Script 的作者**。
{% endhint %}

此方法也能绕过 Workspace 管理员限制：

但可以通过以下方式预防：

### 共享文档未验证提示绕过

此外，如果有人与您**共享**了一个具有**编辑权限**的文档，您可以在文档内生成**App Scripts**，而**文档的所有者（创建者）将成为 App Script 的所有者**。

{% hint style="warning" %}
这意味着，任何拥有编辑权限的人在其中创建的任何 App Script，**文档的创建者都将显示为 App Script 的创建者**。

这也意味着，**App Script 将被文档创建者的 Workspace 环境信任**。
{% endhint %}

{% hint style="danger" %}
这也意味着，如果一个**App Script 已经存在**并且人们已经**授权访问**，任何拥有文档**编辑**权限的人都可以**修改它并滥用该访问权限**。\
要滥用这一点，您还需要人们触发 App Script。一个巧妙的技巧是将脚本**发布为网络应用程序**。当已经授权访问 App Script 的**人员**访问网页时，他们将**触发 App Script**（使用 `<img>` 标签也有效）。
{% endhint %}

## 事后利用

### Google Groups 权限提升

默认情况下，在 workspace 中，**群组**可以被组织中的任何成员**自由访问**。\
Workspace 还允许**授予群组权限**（甚至是 GCP 权限），所以如果群组可以加入并且它们有额外的权限，攻击者可能会**利用这一途径提升权限**。

您可能需要访问控制台才能加入组织中任何人都可以加入的群组。在 [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) 检查群组信息。

### 从 GWS 到 GCP 的转移

* 利用 **google groups 权限提升**，您可能能够升级到一个对 GCP 有某种特权访问的群组
* 利用 **OAuth 应用程序**，您可能能够冒充用户并代表他们访问 GCP

### 从 GCP 到 GWS 的转移

{% content-ref url="gcp-security/gcp-to-workspace-pivoting.md" %}
[gcp-to-workspace-pivoting.md](gcp-security/gcp-to-workspace-pivoting.md)
{% endcontent-ref %}

### 访问群组邮件信息

如果您设法**危害了谷歌用户会话**，从 [**https://groups.google.com/all-groups**](https://groups.google.com/all-groups) 您可以看到用户所在的邮件群组发送的邮件历史记录，您可能会找到**凭据**或其他**敏感数据**。

### Takeout - 下载 Google 对一个账户了解的所有信息

如果您在受害者的谷歌账户内有一个**会话**，您可以从 [**https://takeout.google.com**](https://takeout.google.com/u/1/?pageId=none) 下载 Google 保存的该账户的所有信息。

### Vault - 下载用户的所有 Workspace 数据

如果一个组织启用了**Google Vault**，您可能能够访问 [**https://vault.google.com**](https://vault.google.com/u/1/) 并**下载**所有的**信息**。

### 联系人下载

从 [**https://contacts.google.com**](https://contacts.google.com/u/1/?hl=es\&tab=mC) 您可以下载用户的所有**联系人**。

### Cloudsearch

在 [**https://cloudsearch.google.com/**](https://cloudsearch.google.com) 您可以搜索用户有权访问的所有 Workspace 内容（电子邮件、驱动器、网站等）。理想的是**快速找到敏感信息**。

### Currents

在 [**https://currents.google.com/**](https://currents.google.com) 您可以访问 Google **聊天**，因此您可能会在这里找到敏感信息。

### Google Drive 挖掘

当**共享**文档时，您可以**指定**可以访问它的**人员**，通过**生成链接**与您的**整个公司**（**或**某些特定**群组**）**共享**。

共享文档时，在高级设置中，您还可以**允许人们搜索**此文件（**默认情况下**这是**禁用的**）。但是，重要的是要注意，一旦用户查看了文档，他们就可以搜索它。

为了简单起见，大多数人会生成并共享链接，而不是逐个添加可以访问文档的人。

一些提出的查找所有文档的方法：

* 在内部聊天、论坛等中搜索...
* **爬取**已知**文档**，搜索对其他文档的**引用**。您可以在 App Script 中使用 [**PaperChaser**](https://github.com/mandatoryprogrammer/PaperChaser) 来做到这一点

### **Keep Notes**

在 [**https://keep.google.com/**](https://keep.google.com) 您可以访问用户的笔记，**敏感** **信息**可能保存在这里。

### 在 Google 账户内保持持久性

如果您设法**危害了谷歌用户会话**，并且用户启用了**两步验证**，您可以**生成**一个 [**应用程序密码**](https://support.google.com/accounts/answer/185833?hl=en) 并**重新生成两步验证备份代码**，以知道即使用户更改了密码，您**仍然能够访问他们的账户**。另一个选择是**而不是**重新生成代码，而是**注册您自己的验证器**应用程序进行两步验证。

### 通过 OAuth 应用程序保持持久性

如果您**危害了用户的账户**，您可以简单地**接受**授予一个**OAuth 应用程序**所有可能的权限。唯一的问题是 Workspace 可以配置为**不允许未经审查的外部和/或内部 OAuth 应用程序**。\
通常默认情况下不信任外部 OAuth 应用程序，但信任内部应用程序，所以如果您有**足够的权限在组织内生成一个新的 OAuth 应用程序**并且外部应用程序被禁止，生成它并**使用这个新的内部 OAuth 应用程序来维持持久性**。
### 通过委托实现持久性

您可以将**账户委托**给由攻击者控制的不同账户。

### 通过Android应用实现持久性

如果您在**受害者的Google账户中有会话**，您可以浏览到**Play商店**并直接**安装已上传的恶意软件**到手机上，以保持持久性并访问受害者的手机。

### **通过Gmail实现持久性**

* 您可以创建**过滤器以隐藏**来自Google的安全通知
* 来自：(no-reply@accounts.google.com) "安全警报"
* 隐藏密码重置电子邮件
* 创建**转发地址以转发敏感信息**（或全部信息）- 您需要手动访问。
* 创建一个转发地址来发送包含“password”一词的电子邮件，例如
* 添加**攻击者控制下的恢复电子邮件/电话**

### **通过应用脚本实现持久性**

您可以在应用脚本中创建**基于时间的触发器**，所以如果用户接受了应用脚本，即使**用户没有访问它**，它也会被**触发**。

文档提到要使用`ScriptApp.newTrigger("funcion")`您需要**作用域**`script.scriptapp`，但**显然这不是必需的**，只要您声明了其他一些作用域。

### **管理Workspace**

在[**https://admin.google.com**/](https://admin.google.com)，如果您有足够的权限，您可能能够修改整个组织的Workspace设置。

您还可以通过搜索[**https://admin.google.com/ac/emaillogsearch**](https://admin.google.com/ac/emaillogsearch)中所有用户的发票来找到电子邮件。

## 账户被泄露恢复

* 注销所有会话
* 更改用户密码
* 生成新的2FA备份代码
* 删除应用密码
* 删除OAuth应用
* 删除2FA设备
* 删除电子邮件转发器
* 删除电子邮件过滤器
* 删除恢复电子邮件/电话
* 删除恶意Android应用
* 删除不良账户委托

## 参考资料

* [https://www.youtube-nocookie.com/embed/6AsVUS79gLw](https://www.youtube-nocookie.com/embed/6AsVUS79gLw) - Matthew Bryant - 黑客G Suite：暗黑应用脚本魔法的力量
* [https://www.youtube.com/watch?v=KTVHLolz6cE](https://www.youtube.com/watch?v=KTVHLolz6cE) - Mike Felch和Beau Bullock - OK Google，我如何对GSuite进行红队测试？

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
