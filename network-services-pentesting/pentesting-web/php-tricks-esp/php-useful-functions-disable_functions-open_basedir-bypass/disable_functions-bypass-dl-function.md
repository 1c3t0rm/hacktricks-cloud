# disable\_functions bypass - dl function

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Važna napomena:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** je PHP funkcija koja se može koristiti za učitavanje PHP ekstenzija. Ako funkcija nije onemogućena, može se zloupotrebiti da bi se **zaobišle `disable_functions` i izvršile proizvoljne komande**.\
Međutim, postoje neka stroga ograničenja:

* Funkcija `dl` mora biti **prisutna** u **okruženju** i **ne sme biti onemogućena**
* PHP ekstenzija mora biti **kompajlirana sa istom glavnom verzijom** (PHP API verzija) koju koristi server (ovu informaciju možete videti u izlazu phpinfo)
* PHP ekstenzija mora biti **smještena u direktorijumu** koji je **definisan** direktivom **`extension_dir`** (možete je videti u izlazu phpinfo). Vrlo je malo verovatno da će napadač koji pokušava zloupotrebiti server imati pristup pisanju u ovaj direktorijum, pa će ovo zahtevanje verovatno sprečiti zloupotrebu ove tehnike).

**Ako ispunjavate ove zahteve, nastavite čitati post** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **da biste naučili kako zaobići disable\_functions**. Evo sažetka:

[dl funkcija](http://www.php.net/manual/en/function.dl.php) se koristi za dinamičko učitavanje PHP ekstenzija tokom izvršavanja skripte. PHP ekstenzije, obično napisane u C/C++, poboljšavaju funkcionalnost PHP-a. Napadač, primetivši da funkcija `dl` nije onemogućena, odlučuje da napravi prilagođenu PHP ekstenziju za izvršavanje sistemskih komandi.

#### Koraci koje preduzima napadač:

1. **Identifikacija verzije PHP-a:**

* Napadač određuje verziju PHP-a koristeći skriptu (`<?php echo 'PHP verzija je '.PHP_VERSION; ?>`).

2. **Dobavljanje izvornog koda PHP-a:**

* Preuzima izvorni kod PHP-a sa zvanične [PHP veb stranice](http://www.php.net/downloads.php) ili [arhive](http://museum.php.net) ako je verzija starija.

3. **Lokalno podešavanje PHP-a:**

* Izdvaja i instalira određenu verziju PHP-a na svom sistemu.

4. **Kreiranje ekstenzije:**

* Proučava [kreiranje PHP ekstenzija](http://www.php.net/manual/en/zend.creating.php) i pregleda izvorni kod PHP-a.
* Fokusira se na dupliciranje funkcionalnosti [exec funkcije](http://www.php.net/manual/en/function.exec.php) koja se nalazi u `ext/standard/exec.c`.

#### Napomene za kompajliranje prilagođene ekstenzije:

1. **ZEND\_MODULE\_API\_NO:**

* `ZEND_MODULE_API_NO` u `bypass.c` mora se podudarati sa trenutnom Zend Extension Build-om, koji se može dobiti sa:

```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modifikacija PHP\_FUNCTION:**

* Za nove verzije PHP-a (5, 7, 8), možda će biti potrebna prilagođavanje `PHP_FUNCTION(bypass_exec)`. Priloženi kod detaljno opisuje ovu modifikaciju.

#### Datoteke prilagođene ekstenzije:

* **bypass.c**:
* Implementira osnovnu funkcionalnost prilagođene ekstenzije.
* **php\_bypass.h**:
* Header datoteka koja definiše osobine ekstenzije.
* **config.m4**:
* Koristi se od strane `phpize` za konfigurisanje okruženja za izgradnju prilagođene ekstenzije.

#### Izgradnja ekstenzije:

1. **Komande za kompajliranje:**

* Koristi `phpize`, `./configure` i `make` za kompajliranje ekstenzije.
* Rezultirajući `bypass.so` se zatim nalazi u poddirektorijumu modules.

2. **Čišćenje:**

* Pokreće `make clean` i `phpize --clean` nakon kompajliranja.

#### Postavljanje i izvršavanje na žrtvinoj mašini:

1. **Kompatibilnost verzija:**

* Osigurava da se PHP API verzije podudaraju između napadačevog i žrtvinog sistema.

2. **Učitavanje ekstenzije:**

* Koristi funkciju `dl`, zaobilazeći ograničenja korišćenjem relativnih putanja ili skripta za automatizaciju procesa.

3. **Izvršavanje skripte:**

* Napadač postavlja `bypass.so` i PHP skriptu na server žrtve.
* Skripta koristi funkciju `dl_local` za dinamičko učitavanje `bypass.so`, a zatim poziva `bypass_exec` sa komandom koja se prenosi putem upita `cmd`.

#### Izvršavanje komandi:

* Napadač sada može izvršavati komande pristupanjem: `http://www.example.com/script.php?cmd=<komanda>`

Ovaj detaljni vodič opisuje proces kreiranja i implementacije PHP ekstenzije za izvršavanje sistemskih komandi, iskorišćavajući funkciju `dl`, koja bi idealno trebala biti onemogućena kako bi se sprečila takva sigurnosna ugrožavanja.

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** \[\*\*

</details>
