# Seguridad en Terraform Enterprise

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) es la distribución autoalojada de [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs) de hashicorp. Ofrece a las empresas una **instancia privada de la aplicación Terraform Cloud**, sin límites de recursos y con características arquitectónicas adicionales de nivel empresarial como registro de auditoría e inicio de sesión único SAML.

"Por defecto, Terraform Enterprise **no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia**, que puede contener credenciales IAM u otros datos sensibles" ([fuente](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Aunque el enfoque de este artículo está en atacar el servicio de metadatos, vale la pena mencionar que obtener ejecución de código dentro de una ejecución de Terraform puede proporcionar otras vías de ataque. Por ejemplo, se podrían filtrar variables de entorno que pueden contener credenciales sensibles.
{% endhint %}

## Ejecución Remota de Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud ejecuta Terraform en **máquinas virtuales desechables en su propia infraestructura en la nube** por defecto. Puedes aprovechar los [**Agentes de Terraform Cloud**](https://developer.hashicorp.com/terraform/cloud-docs/agents) para ejecutar Terraform en **tu propia infraestructura aislada, privada o local**. A veces se hace referencia a la ejecución remota de Terraform como "operaciones remotas".

Por lo tanto, con una clave API para contactar a Terraform Enterprise es posible **ejecutar código arbitrario en un contenedor en la nube**.

Los [**Tokens de API de Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) se pueden identificar por la subcadena **`.atlasv1.`**. Suelen estar ubicados en `~/.terraform.d/` pero atacando plataformas CI/CD y nubes podrías encontrarlos en secretos o variables de entorno.

Puedes usar este token para **encontrar la Organización:**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
y con esta información encuentra el Workspace:
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
Ahora necesitas crear una configuración para comunicarte con el backend de Terraform Enterprise. Simplemente obtén [este ejemplo](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) y **agrega un `hostname`** con el nombre de host de la instancia de Terraform Enterprise:

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
```markdown
Inicializa tu terraform para usar el token de Terraform Enterprise
```
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
Ahora que tienes **Terraform configurado para contactar con el backend Enterprise** puedes seguir la sección [**RCE en Terraform**](./#rce-in-terraform) desde:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoteo

Como se mencionó anteriormente, la infraestructura de Terrafomr Enterprise puede ejecutarse en cualquier máquina/proveedor de nube utilizando agentes. Por lo tanto, si puedes ejecutar código en esta máquina, podrías obtener **credenciales de la nube desde el punto final de metadatos (**[**IAM, datos de usuario...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Además, revisa el **sistema de archivos** y las **variables de entorno** en busca de otros secretos potenciales y claves de API.\
También, no olvides **verificar la red** donde se encuentra la máquina.

## Protecciones

{% hint style="info" %}
#### Desactivación de Operaciones Remotas <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Muchas de las características de Terraform Cloud dependen de la ejecución remota y no están disponibles al usar operaciones locales. Esto incluye características como la aplicación de políticas Sentinel, estimación de costos y notificaciones.

Puedes desactivar las operaciones remotas para cualquier Workspace cambiando su [Modo de Ejecución](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) a **Local**. Esto hace que el Workspace actúe solo como un backend remoto para el estado de Terraform, con toda la ejecución ocurriendo en tus propias estaciones de trabajo o trabajadores de integración continua.
{% endhint %}

{% hint style="info" %}
**Restringir el Acceso a los Metadatos del Worker de Construcción de Terraform**

Por defecto, Terraform Enterprise no impide que las operaciones de Terraform accedan al servicio de metadatos de la instancia, que puede contener credenciales IAM u otros datos sensibles. Consulta la documentación de [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows), o [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) para más información sobre este servicio.
{% endhint %}

## Referencias

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
