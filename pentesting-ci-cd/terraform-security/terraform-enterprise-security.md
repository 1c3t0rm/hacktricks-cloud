# S√©curit√© de Terraform Enterprise

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) est la distribution auto-h√©berg√©e de [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs) par hashicorp. Il offre aux entreprises une **instance priv√©e de l'application Terraform Cloud**, sans limites de ressources et avec des fonctionnalit√©s architecturales de niveau entreprise telles que la journalisation des audits et l'authentification unique SAML.

"Par d√©faut, Terraform Enterprise **ne bloque pas l'acc√®s au service de m√©tadonn√©es de l'instance** par les op√©rations Terraform, qui peut contenir des identifiants IAM ou d'autres donn√©es sensibles" ([source](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Bien que cet article se concentre sur le ciblage du service de m√©tadonn√©es, il convient de noter que l'obtention d'une ex√©cution de code √† l'int√©rieur d'une ex√©cution Terraform peut offrir d'autres voies d'attaque. Par exemple, des variables d'environnement pourraient √™tre expos√©es, pouvant contenir des identifiants sensibles.
{% endhint %}

## Ex√©cution √† distance de Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Par d√©faut, Terraform Cloud ex√©cute Terraform sur **des machines virtuelles jetables dans sa propre infrastructure cloud**. Vous pouvez utiliser [Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents) pour ex√©cuter Terraform sur **votre propre infrastructure isol√©e, priv√©e ou sur site**. L'ex√©cution √† distance de Terraform est parfois appel√©e "op√©rations √† distance".

Ainsi, avec une cl√© API pour contacter Terraform Enterprise, il est possible d'**ex√©cuter du code arbitraire dans un conteneur dans le cloud**.

Les [**jetons d'API Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) peuvent √™tre identifi√©s par la sous-cha√Æne **`.atlasv1.`**. Ils se trouvent g√©n√©ralement dans `~/.terraform.d/`, mais en attaquant des plateformes CI/CD et des clouds, vous pourriez les trouver dans des secrets ou des variables d'environnement.

Vous pouvez utiliser ce jeton pour **trouver l'Organisation :**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
et avec ces informations, trouvez l'Espace de travail :
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
```hcl
terraform {
  backend "remote" {
    hostname     = "your-instance-hostname"
    organization = "your-organization-name"

    workspaces {
      name = "your-workspace-name"
    }
  }
}
```
{% endcode %}

Vous devez maintenant cr√©er une configuration pour communiquer avec le backend Terraform Enterprise. Prenez simplement [cet exemple](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) et **ajoutez un `hostname`** avec le nom d'h√¥te de l'instance Terraform Enterprise :
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
{% endcode %}

Initialisez votre terraform pour utiliser le jeton Terraform Enterprise
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
Maintenant que vous avez **Terraform configur√© pour contacter le backend Enterprise**, vous pouvez simplement suivre la section [**RCE in Terraform**](./#rce-in-terraform) √† partir de :

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivotement

Comme mentionn√© pr√©c√©demment, l'infrastructure Terrafomr Enterprise peut s'ex√©cuter sur n'importe quelle machine/fournisseur cloud en utilisant des agents. Par cons√©quent, si vous pouvez ex√©cuter du code sur cette machine, vous pourriez r√©cup√©rer **les identifiants cloud depuis le point de terminaison des m√©tadonn√©es (**[**IAM, donn√©es utilisateur...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
De plus, v√©rifiez le **syst√®me de fichiers** et les **variables d'environnement** pour d'autres secrets potentiels et cl√©s API.\
N'oubliez pas non plus de **v√©rifier le r√©seau** o√π la machine est situ√©e.

## Protections

{% hint style="info" %}
#### D√©sactivation des op√©rations √† distance <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

De nombreuses fonctionnalit√©s de Terraform Cloud d√©pendent de l'ex√©cution √† distance et ne sont pas disponibles lors de l'utilisation d'op√©rations locales. Cela inclut des fonctionnalit√©s telles que l'application des politiques Sentinel, l'estimation des co√ªts et les notifications.

Vous pouvez d√©sactiver les op√©rations √† distance pour n'importe quel espace de travail en changeant son [Mode d'ex√©cution](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) en **Local**. Cela fait en sorte que l'espace de travail agisse uniquement comme un backend distant pour l'√©tat de Terraform, avec toute l'ex√©cution se produisant sur vos propres stations de travail ou travailleurs d'int√©gration continue.
{% endhint %}

{% hint style="info" %}
**Restreindre l'acc√®s aux m√©tadonn√©es du travailleur de construction Terraform**

Par d√©faut, Terraform Enterprise ne bloque pas l'acc√®s des op√©rations Terraform au service de m√©tadonn√©es d'instance, qui peut contenir des identifiants IAM ou d'autres donn√©es sensibles. Consultez la documentation [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows), ou [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) pour plus d'informations sur ce service.
{% endhint %}

## R√©f√©rences

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
