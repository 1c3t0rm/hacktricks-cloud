# Terraform Enterprise 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) 是 hashicorp 自托管的 [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs) 发行版。它为企业提供了一个 **私有的 Terraform Cloud 应用实例**，没有资源限制，并具有额外的企业级架构特性，如审计日志和 SAML 单点登录。

“默认情况下，Terraform Enterprise **不会阻止 Terraform 操作访问实例元数据服务**，该服务可能包含 IAM 凭证或其他敏感数据”（[来源](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)）

{% hint style="info" %}
虽然本文的重点是针对元数据服务，但值得注意的是，在 Terraform 运行中获得代码执行可能提供其他攻击途径。例如，可能泄露包含敏感凭证的环境变量。
{% endhint %}

## 远程 Terraform 执行 <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloud 默认在其自己的云基础设施中的 **一次性虚拟机上运行 Terraform**。您可以利用 [Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents) 在 **您自己的隔离的、私有的或本地基础设施上运行 Terraform**。远程 Terraform 执行有时被称为“远程操作”。

因此，有了一个 API 密钥来联系 Terraform Enterprise，就有可能在云中的容器中 **执行任意代码**。

[**Terraform API 令牌**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) 可以通过 **`.atlasv1.` 子字符串** 来识别。它们通常位于 `~/.terraform.d/`，但在攻击 CI/CD 平台和云时，您可能会在 secrets 或 env 变量中找到它们。

您可以使用此令牌来 **找到组织：**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
和使用这些信息找到 Workspace：
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
```markdown
现在您需要创建一个配置文件，以便与terraform Enterprise后端通信。只需获取[此示例](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)并**添加一个`hostname`**，其中包含Terraform Enterprise实例的主机名：

{% code title="backend_config.tf" %}
```
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
```
初始化您的terraform以使用Terraform Enterprise令牌
```
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
```markdown
现在您已经**配置了 Terraform 以联系企业后端**，您可以按照以下部分操作 [**RCE in Terraform**](./#rce-in-terraform)：

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### 转移

如前所述，Terrafomr Enterprise Infra 可以在任何使用代理的机器/云提供商上运行。因此，如果您能在这台机器上执行代码，您可以从元数据端点收集**云凭证（**[**IAM, 用户数据等...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**。\
此外，检查**文件系统**和**环境变量**以寻找其他潜在的秘密和 API 密钥。\
还有，不要忘记**检查**机器所在的网络。

## 防护措施

{% hint style="info" %}
#### 禁用远程操作 <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloud 的许多功能依赖于远程执行，在使用本地操作时无法使用。这包括 Sentinel 策略执行、成本估算和通知等功能。

您可以通过将其 [执行模式](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) 更改为 **Local** 来禁用任何工作区的远程操作。这会导致工作区仅作为 Terraform 状态的远程后端，所有执行都在您自己的工作站或持续集成工作器上进行。
{% endhint %}

{% hint style="info" %}
**限制 Terraform 构建工作器元数据访问**

默认情况下，Terraform Enterprise 不会阻止 Terraform 操作访问实例元数据服务，该服务可能包含 IAM 凭证或其他敏感数据。有关此服务的更多信息，请参考 [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)、[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows) 或 [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) 的文档。
{% endhint %}

## 参考资料

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
```
