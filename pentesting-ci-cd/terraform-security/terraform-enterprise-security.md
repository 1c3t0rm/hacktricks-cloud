# Seguran√ßa do Terraform Enterprise

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise) √© a distribui√ß√£o auto-hospedada do [Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs) pela hashicorp. Oferece √†s empresas uma **inst√¢ncia privada do aplicativo Terraform Cloud**, sem limites de recursos e com recursos arquitet√¥nicos adicionais de n√≠vel empresarial, como registro de auditoria e autentica√ß√£o √∫nica SAML.

"Por padr√£o, o Terraform Enterprise **n√£o impede que as opera√ß√µes do Terraform acessem o servi√ßo de metadados da inst√¢ncia**, que pode conter credenciais IAM ou outros dados sens√≠veis" ([fonte](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
Embora o foco deste artigo seja direcionado ao servi√ßo de metadados, vale ressaltar que obter execu√ß√£o de c√≥digo dentro de uma execu√ß√£o do Terraform pode fornecer outras vias de ataque. Por exemplo, vari√°veis de ambiente podem ser expostas, o que pode conter credenciais sens√≠veis.
{% endhint %}

## Execu√ß√£o Remota do Terraform <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

O Terraform Cloud executa o Terraform em **m√°quinas virtuais descart√°veis em sua pr√≥pria infraestrutura de nuvem** por padr√£o. Voc√™ pode utilizar [Agentes do Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs/agents) para executar o Terraform em **sua pr√≥pria infraestrutura isolada, privada ou local**. A execu√ß√£o remota do Terraform √© √†s vezes referida como "opera√ß√µes remotas".

Portanto, com uma chave de API para contatar o Terraform Enterprise, √© poss√≠vel **executar c√≥digo arbitr√°rio em um cont√™iner na nuvem**.

[**Tokens de API do Terraform**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens) podem ser identificados pela substring **`.atlasv1.`**. Eles geralmente est√£o localizados em `~/.terraform.d/`, mas atacando plataformas CI/CD e nuvens, voc√™ pode encontr√°-los em segredos ou vari√°veis de ambiente.

Voc√™ pode usar este token para **encontrar a Organiza√ß√£o:**
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
e com essa informa√ß√£o, encontre o Workspace:
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
Agora voc√™ precisa criar uma configura√ß√£o para se comunicar com o backend do Terraform Enterprise. Apenas pegue [este exemplo](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf) e **adicione um `hostname`** com o nome do host da inst√¢ncia do Terraform Enterprise:

{% code title="backend_config.tf" %}
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
{% endcode %}

Inicialize seu terraform para usar o token do Terraform Enterprise
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
Agora que voc√™ configurou o **Terraform para contatar o backend Enterprise**, voc√™ pode seguir a se√ß√£o [**RCE no Terraform**](./#rce-in-terraform) de:

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### Pivoteamento

Como mencionado anteriormente, a Infraestrutura do Terraform Enterprise pode rodar em qualquer m√°quina/provedor de nuvem usando agentes. Portanto, se voc√™ conseguir executar c√≥digo nessa m√°quina, poder√° coletar **credenciais de nuvem do endpoint de metadados (**[**IAM, dados do usu√°rio...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**.\
Al√©m disso, verifique o **sistema de arquivos** e as **vari√°veis de ambiente** em busca de outros segredos e chaves de API potenciais.\
N√£o se esque√ßa tamb√©m de **verificar a rede** onde a m√°quina est√° localizada.

## Prote√ß√µes

{% hint style="info" %}
#### Desativando Opera√ß√µes Remotas <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Muitos recursos do Terraform Cloud dependem da execu√ß√£o remota e n√£o est√£o dispon√≠veis ao usar opera√ß√µes locais. Isso inclui recursos como aplica√ß√£o de pol√≠ticas Sentinel, estimativa de custos e notifica√ß√µes.

Voc√™ pode desativar opera√ß√µes remotas para qualquer Workspace alterando seu [Modo de Execu√ß√£o](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode) para **Local**. Isso faz com que o Workspace atue apenas como um backend remoto para o estado do Terraform, com toda a execu√ß√£o ocorrendo em suas pr√≥prias esta√ß√µes de trabalho ou trabalhadores de integra√ß√£o cont√≠nua.
{% endhint %}

{% hint style="info" %}
**Restringir Acesso aos Metadados do Worker de Build do Terraform**

Por padr√£o, o Terraform Enterprise n√£o impede que as opera√ß√µes do Terraform acessem o servi√ßo de metadados da inst√¢ncia, que pode conter credenciais IAM ou outros dados sens√≠veis. Consulte a documenta√ß√£o da [AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html), [Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows), ou [Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata) para mais informa√ß√µes sobre este servi√ßo.
{% endhint %}

## Refer√™ncias

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
