# Terraform Enterprise セキュリティ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

[**Terraform Enterprise**](https://developer.hashicorp.com/terraform/enterprise)は、[Terraform Cloud](https://developer.hashicorp.com/terraform/cloud-docs)のhashicorp自己ホスト型ディストリビューションです。これは、リソース制限なしで、監査ログやSAMLシングルサインオンのような追加のエンタープライズグレードのアーキテクチャ機能を備えた、Terraform Cloudアプリケーションの**プライベートインスタンス**を企業に提供します。

"デフォルトでは、Terraform EnterpriseはTerraformの操作がインスタンスのメタデータサービスにアクセスすることを**防ぎません**。これにはIAMクレデンシャルやその他の機密データが含まれている可能性があります" ([出典](https://www.terraform.io/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access))

{% hint style="info" %}
この記事の焦点はメタデータサービスをターゲットにすることですが、Terraform実行内でコード実行を得ることは、攻撃の他の手段を提供する可能性があることに注意する価値があります。例えば、機密クレデンシャルを含む可能性のある環境変数が漏洩する可能性があります。
{% endhint %}

## リモートTerraform実行 <a href="#remote-terraform-execution" id="remote-terraform-execution"></a>

Terraform Cloudはデフォルトで**独自のクラウドインフラストラクチャ内の使い捨ての仮想マシン上でTerraformを実行します**。[Terraform Cloud Agents](https://developer.hashicorp.com/terraform/cloud-docs/agents)を利用して、**独自の分離された、プライベート、またはオンプレミスのインフラストラクチャ上でTerraformを実行する**ことができます。リモートTerraform実行は、時々「リモート操作」と呼ばれます。

したがって、Terraform Enterpriseに連絡するためのAPIキーがあれば、**クラウド内のコンテナで任意のコードを実行する**ことが可能です。

[**Terraform APIトークン**](https://developer.hashicorp.com/terraform/cloud-docs/users-teams-organizations/api-tokens)は、**`.atlasv1.`の部分文字列**によって識別することができます。通常は`~/.terraform.d/`に位置していますが、CI/CDプラットフォームやクラウドを攻撃する際には、シークレットや環境変数の中で見つけることがあります。

このトークンを使用して、**組織を見つける**ことができます：
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations | jq
```
以下の情報を使用してWorkspaceを見つけます：
```bash
curl -H "Authorization: Bearer $TERRAFORM_ENTERPRISE_TOKEN" https://<terra_enterprise_inst>/api/v2/organizations/<org-id>/workspaces | jq
```
```markdown
Terraform Enterpriseバックエンドと通信するための設定を作成する必要があります。[この例](https://github.com/hashicorp/tfc-getting-started/blob/main/backend.tf)を取得し、Terraform Enterpriseインスタンスのホスト名を**`hostname`に追加**してください：

{% code title="backend_config.tf" %}
```
```json
terraform {
backend "remote" {
hostname = "{{TFE_HOSTNAME}}"
organization = "{{ORGANIZATION_NAME}}"

workspaces {
name = "{{WORKSPACE_NAME}}"
}
}
}
```
```
Terraform Enterprise トークンを使用するように Terraform を初期化します
```
```bash
terraform init --backend-config="token=$TERRAFORM_ENTERPRISE_TOKEN"

# Check if it was correctly initialized
terraform state list
```
**TerraformがEnterpriseバックエンドに接続するように設定された**ので、以下のセクション[**TerraformでのRCE**](./#rce-in-terraform)に従ってください：

{% content-ref url="./" %}
[.](./)
{% endcontent-ref %}

### ピボッティング

以前に述べたように、Terrafomr Enterprise Infraはエージェントを使用して任意のマシン/クラウドプロバイダで実行される可能性があります。したがって、このマシンでコードを実行できる場合、**メタデータエンドポイントからクラウド認証情報を収集することができます（**[**IAM、ユーザーデータなど...**](https://book.hacktricks.xyz/pentesting-web/ssrf-server-side-request-forgery/cloud-ssrf)**)**。\
さらに、他の潜在的なシークレットやAPIキーについて、**ファイルシステム**と**環境変数**をチェックしてください。\
また、マシンが位置する**ネットワークをチェックする**ことも忘れないでください。

## 保護

{% hint style="info" %}
#### リモート操作の無効化 <a href="#disabling-remote-operations" id="disabling-remote-operations"></a>

Terraform Cloudの多くの機能はリモート実行に依存しており、ローカル操作を使用する場合は利用できません。これには、Sentinelポリシーの強制、コスト見積もり、通知などの機能が含まれます。

任意のワークスペースのリモート操作を無効にするには、その[実行モード](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/settings#execution-mode)を**ローカル**に変更します。これにより、ワークスペースはTerraformステートのリモートバックエンドとしてのみ機能し、すべての実行は自分のワークステーションまたは継続的インテグレーションワーカーで行われます。
{% endhint %}

{% hint style="info" %}
**Terraformビルドワーカーメタデータアクセスの制限**

デフォルトでは、Terraform EnterpriseはTerraform操作がインスタンスメタデータサービスにアクセスすることを防ぎません。これにはIAM認証情報やその他の機密データが含まれる可能性があります。このサービスについての詳細は、[AWS](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html)、[Azure](https://docs.microsoft.com/en-us/azure/virtual-machines/windows/instance-metadata-service?tabs=windows)、または[Google Cloud](https://cloud.google.com/compute/docs/storing-retrieving-metadata)のドキュメントを参照してください。
{% endhint %}

## 参考文献

* [https://developer.hashicorp.com/terraform/enterprise](https://developer.hashicorp.com/terraform/enterprise)
* [https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations](https://developer.hashicorp.com/terraform/cloud-docs/run/remote-operations#disabling-remote-operations)
* [https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/](https://hackingthe.cloud/terraform/terraform\_enterprise\_metadata\_service/)
* [https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access](https://developer.hashicorp.com/terraform/enterprise/system-overview/security-model#restrict-terraform-build-worker-metadata-access)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。これは独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
