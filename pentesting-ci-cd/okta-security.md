# Okta安全

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您想在HackTricks中看到您的公司广告，或者如果您想访问PEASS的最新版本或下载PDF版的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我的 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) **和** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧**。

</details>

## 基本信息

Okta, Inc.是一家**身份和访问管理公司**，提供云软件来帮助公司**管理和保护用户身份验证到现代应用程序**，以及为开发人员构建身份控制到应用程序、网站、网络服务和设备。

他们的核心服务称为Okta Identity Cloud，提供的产品包括单点登录（SSO）、多因素身份验证（MFA）、生命周期管理、通用目录、API访问管理等。这有助于公司保护敏感数据，同时简化用户访问，使员工或客户更容易访问和使用应用程序和服务。

Okta的服务广泛应用于企业环境，以及小型公司和开发人员。它在帮助企业安全地采用和管理云技术方面发挥着关键作用。截至我在2021年9月的知识截止日期，Okta仍然是身份和访问管理（IAM）行业的重要参与者。

{% hint style="danger" %}
Okta的主要目标是配置对外部应用程序的不同用户和组的访问。如果您成功地在Okta环境中**获取管理员权限**，您很有可能能够**入侵公司使用的所有其他平台**。
{% endhint %}

{% hint style="success" %}
要对Okta环境进行安全审查，您应该要求获得**管理员只读访问权限**。
{% endhint %}

### 概述

有**用户**（可以**存储在Okta中**，从配置的**身份提供者**登录，或通过**Active Directory**或LDAP进行身份验证）。\
这些用户可以在**组**内。\
还有**认证器**：不同的身份验证选项，如密码，以及几种2FA，如WebAuthn、电子邮件、电话、okta verify（它们可以启用或禁用）...

然后，有与Okta同步的**应用程序**。每个应用程序都将与Okta进行一些**映射**以共享信息（如电子邮件地址、名字等）。此外，每个应用程序必须位于**身份验证策略**中，该策略指示用户访问应用程序所需的**认证器**。

{% hint style="danger" %}
最强大的角色是**超级管理员**。

如果攻击者以管理员访问权限入侵Okta，所有**信任Okta的应用程序**很有可能被**入侵**。
{% endhint %}

## 同事冒充攻击

每个用户可以拥有和修改的**属性**（如电子邮件或名字）可以在Okta中进行配置。如果一个**应用程序**将一个用户可以**修改**的**属性**作为ID进行**信任**，那么他将能够在该平台上**冒充其他用户**。

因此，如果该应用程序信任字段**`userName`**，您可能无法更改它（因为通常无法更改该字段），但如果它信任例如**`primaryEmail`**，您可能能够将其更改为同事的电子邮件地址并冒充他（您需要访问该电子邮件并接受更改）。

请注意，此冒充取决于每个应用程序的配置方式。只有信任您修改的字段并接受更新的应用程序才会受到影响。\
因此，如果存在该字段，应用程序应该启用此字段：

<figure><img src="../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

我还见过其他一些易受攻击的应用程序，但在Okta设置中没有该字段（最终不同的应用程序配置方式不同）。

找出您是否可以在每个应用程序上冒充任何人的最佳方法是尝试一下！


## 目录

### 人员

从攻击者的角度来看，这非常有趣，因为您将能够看到**所有注册的用户**，他们的**电子邮件**地址，他们所属的**组**，**配置文件**甚至**设备**（手机及其操作系统）。

对于白盒审查，请检查是否存在多个“**待处理用户操作**”和“**密码重置**”。

### 组

这是您在Okta中找到的所有已创建组。了解可能授予**用户**的不同组（一组**权限**）。\
可以查看**包含在组内的人员**和每个组分配给的**应用程序**。

当然，任何以**admin**为名称的组都很有趣，特别是**全局管理员**组，检查成员以了解最特权的成员是谁。

从白盒审查的角度来看，**全局管理员不应超过5个**（最好只有2或3个）。

### 设备

在这里找到所有用户的**设备列表**。您还可以看到它是否正在**主动管理**。

### 配置文件编辑器

在这里，可以观察到关键信息（如名字、姓氏、电子邮件、用户名等）在Okta和其他应用程序之间是如何共享的。这很有趣，因为如果用户可以在Okta中**修改字段**（例如他的名字或电子邮件），然后该字段被**外部应用程序**用于**识别**用户，内部人员可能会尝试**接管其他帐户**。

此外，在Okta的**`User (default)`**配置文件中，您可以看到每个**用户**拥有哪些字段以及哪些字段可以由用户**编写**。如果您无法看到管理面板，请转到**更新您的配置文件**信息，您将看到可以更新的字段（请注意，要更新电子邮件地址，您需要进行验证）。
###目录集成

目录允许您从现有来源导入人员。我猜在这里您将看到从其他目录导入的用户。

我还没有看到它，但我猜这对于找出Okta用于导入用户的其他目录是有趣的，因此如果您入侵了该目录，您可以在Okta中设置一些用户创建的属性值，从而可能危及Okta环境。

###配置文件来源

配置文件来源是用户配置文件属性的真实来源。一个用户一次只能由一个应用程序或目录提供。

我还没有看到它，所以任何关于此选项的安全和黑客信息都是受欢迎的。

##自定义

###品牌

在此部分的**域**选项卡中，检查用于发送电子邮件的电子邮件地址和公司在Okta中的自定义域（您可能已经知道）。

此外，在**设置**选项卡中，如果您是管理员，您可以“**使用自定义注销页面**”并设置自定义URL。

###短信

这里没有什么有趣的东西。

###终端用户仪表板

您可以在这里找到已配置的应用程序，但我们将在不同的部分中详细介绍这些应用程序。

###其他

有趣的设置，但从安全角度来看没有什么特别有趣的。

##应用程序

###应用程序

在这里，您可以找到所有已配置的应用程序及其详细信息：谁可以访问它们，如何配置（SAML，OPenID），登录URL，Okta和应用程序之间的映射...

在**`登录`**选项卡中，还有一个名为**`密码显示`**的字段，当检查应用程序设置时，它允许用户**显示密码**。要从用户面板检查应用程序的设置，请单击3个点：

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

然后，您可以查看有关应用程序的更多详细信息（例如密码显示功能是否已启用）：

<figure><img src="../.gitbook/assets/image (1) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

##身份治理

###访问认证

使用访问认证创建审核活动，定期审查用户对资源的访问，并在需要时自动批准或撤销访问权限。

我还没有看到它的使用情况，但我猜从防御的角度来看，这是一个不错的功能。

##安全

###常规

* **安全通知电子邮件**：所有都应该启用。
* **CAPTCHA集成**：建议至少设置不可见的reCaptcha。
* **组织安全**：可以启用所有功能，并且激活电子邮件不应持续很长时间（7天是可以的）。
* **用户枚举预防**：两者都应启用。
* 请注意，如果允许以下任何条件之一，则用户枚举预防不会生效（有关更多信息，请参见[用户管理](https://help.okta.com/oie/en-us/Content/Topics/users-groups-profiles/usgp-main.htm)）：
* 自助注册
* 带有电子邮件身份验证的JIT流程
* **Okta ThreatInsight设置**：基于威胁级别记录和强制执行安全性

###HealthInsight

在这里，您可以找到正确和**危险**配置的**设置**。

###认证器

在这里，您可以找到用户可以使用的所有身份验证方法：密码、电话、电子邮件、代码、WebAuthn...单击密码认证器，您可以查看**密码策略**。确保它足够强大。

在**注册**选项卡中，您可以查看哪些是必需或可选的：

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

建议禁用电话。最强大的可能是密码、电子邮件和WebAuthn的组合。

###认证策略

每个应用程序都有一个认证策略。认证策略验证试图登录应用程序的用户是否满足特定条件，并根据这些条件强制执行因素要求。

在这里，您可以找到访问每个应用程序的**要求**。建议至少要求每个应用程序的密码和另一种方法。但是，如果作为攻击者，您发现某些更弱的东西，您可能能够攻击它。

###全局会话策略

在这里，您可以找到分配给不同组的会话策略。例如：

<figure><img src="../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

建议要求MFA，将会话生命周期限制为几个小时，不要在浏览器扩展程序之间保留会话cookie，并限制位置和身份提供者（如果可能）。例如，如果每个用户应该从一个国家登录，您只能允许该位置。

###身份提供者

身份提供者（IdPs）是管理用户帐户的服务。在Okta中添加IdPs可以通过首先使用社交帐户或智能卡进行身份验证，使您的最终用户能够自定义应用程序进行自注册。

在身份提供者页面上，您可以添加社交登录（IdPs）并通过添加入站SAML将Okta配置为服务提供者（SP）。添加IdPs后，您可以设置路由规则，根据上下文（例如用户的位置、设备或电子邮件域）将用户定向到IdP。

从攻击者和防御者的角度来看，如果配置了任何身份提供者，请检查该配置并确保源确实可信，因为攻击者入侵它也可以访问Okta环境。

###委托认证

委托认证允许用户通过输入其组织的**Active Directory（AD）或LDAP**服务器的凭据登录到Okta。

同样，重新检查此设置，因为攻击者入侵组织的AD可能能够通过此设置转到Okta。

###网络

网络区域是一个可配置的边界，您可以根据请求访问的**IP地址**来使用它来授予或限制组织中计算机和设备的访问权限。您可以通过指定一个或多个单独的IP地址、IP地址范围或地理位置来定义网络区域。

在定义一个或多个网络区域之后，您可以在全局会话策略、认证策略、VPN通知和路由规则中**使用它们**。

从攻击者的角度来看，了解允许的Ps（并检查是否有任何**IP比其他IP更具特权**）是有趣的。从攻击者的角度来看，如果用户应该从特定的IP地址或区域访问，请检查此功能是否正确使用。

###设备集成

* **终端管理**：终端管理是可以应用于认证策略的条件，以确保受管理设备可以访问应用程序。
* 我还没有看到这个被使用。待办事项
* **通知服务**：我还没有看到这个被使用。待办事项
### API

您可以在此页面创建Okta API令牌，并查看已创建的令牌的权限、过期时间和来源URL。请注意，API令牌是使用创建令牌的用户的权限生成的，仅在创建它们的用户处于活动状态时有效。

**受信任的来源**允许您控制和信任的网站通过Okta API访问您的Okta组织。

不应该有很多API令牌，因为如果有攻击者可能会尝试访问并使用它们。

## 工作流程

### 自动化

自动化允许您创建基于一组触发条件的自动操作，这些条件在终端用户的生命周期中发生。

例如，条件可以是“在Okta中的用户不活动”或“在Okta中的用户密码过期”，而操作可以是“向用户发送电子邮件”或“更改Okta中的用户生命周期状态”。

## 报告

### 报告

下载日志。它们将发送到当前帐户的电子邮件地址。

### 系统日志

在这里，您可以找到用户执行的操作的日志，例如通过Okta登录或通过Okta登录应用程序的详细信息。

### 导入监控

这可以导入通过Okta访问的其他平台的日志。

### 速率限制

检查已达到的API速率限制。

## 设置

### 帐户

在这里，您可以找到有关Okta环境的通用信息，例如公司名称、地址、电子邮件帐单联系人、电子邮件技术联系人，以及应该接收Okta更新的人员和Okta更新的类型。

### 下载

在这里，您可以下载Okta代理以将Okta与其他技术同步。

<details>

<summary><strong>支持HackTricks并获得福利！</strong></summary>

* 如果您希望在HackTricks中看到您的公司广告，或者如果您希望访问PEASS的最新版本或下载PDF格式的HackTricks，请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS和HackTricks衍生品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFT**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github仓库提交PR来分享您的黑客技巧。**

</details>
