# Seguran√ßa do Okta

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou se quiser acessar a **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes b√°sicas

A Okta, Inc. √© uma **empresa de gerenciamento de identidade e acesso** que fornece software em nuvem para ajudar as empresas a **gerenciar e proteger a autentica√ß√£o do usu√°rio em aplicativos modernos**, e para os desenvolvedores constru√≠rem controles de identidade em aplicativos, servi√ßos web e dispositivos.

Seu servi√ßo principal, chamado Okta Identity Cloud, oferece produtos que incluem logon √∫nico (SSO), autentica√ß√£o multifator (MFA), gerenciamento do ciclo de vida, diret√≥rio universal, gerenciamento de acesso a API e muito mais. Isso ajuda as empresas a proteger seus dados sens√≠veis e tamb√©m a simplificar o acesso do usu√°rio, tornando os aplicativos e servi√ßos mais acess√≠veis e f√°ceis de usar para funcion√°rios ou clientes.

Os servi√ßos da Okta s√£o amplamente utilizados em contextos empresariais, bem como por empresas menores e desenvolvedores. Ela desempenha um papel crucial ao permitir que as empresas adotem e gerenciem com seguran√ßa as tecnologias em nuvem. At√© o meu conhecimento em setembro de 2021, a Okta continua sendo um jogador significativo na ind√∫stria de Gerenciamento de Identidade e Acesso (IAM).

{% hint style="danger" %}
O principal objetivo da Okta √© configurar o acesso de diferentes usu√°rios e grupos a aplicativos externos. Se voc√™ conseguir **comprometer privil√©gios de administrador em um ambiente Okta**, provavelmente conseguir√° **comprometer todas as outras plataformas que a empresa est√° usando**.
{% endhint %}

{% hint style="success" %}
Para realizar uma revis√£o de seguran√ßa de um ambiente Okta, voc√™ deve solicitar acesso **somente leitura de administrador**.
{% endhint %}

### Resumo

Existem **usu√°rios** (que podem ser **armazenados no Okta**, logados a partir de **Provedores de Identidade** configurados ou autenticados via **Active Directory** ou LDAP). \
Esses usu√°rios podem estar dentro de **grupos**.\
Existem tamb√©m **autenticadores**: diferentes op√ß√µes para autentica√ß√£o, como senha, e v√°rias op√ß√µes de autentica√ß√£o de dois fatores, como WebAuthn, e-mail, telefone, Okta Verify (eles podem estar habilitados ou desabilitados)...

Em seguida, existem **aplicativos** sincronizados com o Okta. Cada aplicativo ter√° algum **mapeamento com o Okta** para compartilhar informa√ß√µes (como endere√ßos de e-mail, nomes...). Al√©m disso, cada aplicativo deve estar dentro de uma **Pol√≠tica de Autentica√ß√£o**, que indica os **autenticadores necess√°rios** para que um usu√°rio **acesse** o aplicativo.

{% hint style="danger" %}
O papel mais poderoso √© o de **Super Administrador**.

Se um invasor comprometer o Okta com acesso de Administrador, todos os **aplicativos que confiam no Okta** provavelmente ser√£o **comprometidos**.
{% endhint %}

## Ataque de Impersona√ß√£o de Colega

Os **atributos que cada usu√°rio pode ter e modificar** (como e-mail ou nome) podem ser configurados no Okta. Se um **aplicativo** est√° **confiando** em um **atributo** como ID que o usu√°rio pode **modificar**, ele poder√° **se passar por outros usu√°rios nessa plataforma**.

Portanto, se o aplicativo est√° confiando no campo **`userName`**, provavelmente voc√™ n√£o poder√° alter√°-lo (porque geralmente n√£o √© poss√≠vel alterar esse campo), mas se ele estiver confiando, por exemplo, em **`primaryEmail`**, voc√™ poder√° **alter√°-lo para o endere√ßo de e-mail de um colega** e se passar por ele (voc√™ precisar√° ter acesso ao e-mail e aceitar a altera√ß√£o).

Observe que essa impersona√ß√£o depende de como cada aplicativo foi configurado. Apenas aqueles que confiam no campo que voc√™ modificou e aceitam atualiza√ß√µes ser√£o comprometidos.\
Portanto, o aplicativo deve ter esse campo habilitado, se existir:

<figure><img src="../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

Tamb√©m vi outros aplicativos que eram vulner√°veis, mas n√£o tinham esse campo nas configura√ß√µes do Okta (no final, diferentes aplicativos s√£o configurados de maneira diferente).

A melhor maneira de descobrir se voc√™ pode se passar por algu√©m em cada aplicativo √© tentar!

## Diret√≥rio

### Pessoas

Do ponto de vista de um invasor, isso √© super interessante, pois voc√™ poder√° ver **todos os usu√°rios registrados**, seus endere√ßos de **e-mail**, os **grupos** dos quais fazem parte, **perfis** e at√© mesmo **dispositivos** (celulares junto com seus sistemas operacionais).

Para uma revis√£o de caixa branca, verifique se n√£o h√° v√°rias "**A√ß√µes pendentes do usu√°rio**" e "**Redefini√ß√£o de senha**".

### Grupos

Aqui √© onde voc√™ encontra todos os grupos criados no Okta. √â interessante entender os diferentes grupos (conjunto de **permiss√µes**) que podem ser concedidos aos **usu√°rios**.\
√â poss√≠vel ver as **pessoas inclu√≠das nos grupos** e os **aplicativos atribu√≠dos** a cada grupo.

Claro, qualquer grupo com o nome de **admin** √© interessante, especialmente o grupo **Administradores Globais**, verifique os membros para saber quem s√£o os membros mais privilegiados.

De uma revis√£o de caixa branca, **n√£o deve haver mais de 5 administradores globais** (melhor se houver apenas 2 ou 3).

### Dispositivos

Encontre aqui uma **lista de todos os dispositivos** de todos os usu√°rios. Voc√™ tamb√©m pode ver se est√° sendo **gerenciado ativamente** ou n√£o.

### Editor de Perfil

Aqui √© poss√≠vel observar como informa√ß√µes-chave, como nomes, sobrenomes, e-mails, nomes de usu√°rio... s√£o compartilhadas entre o Okta e outros aplicativos. Isso √© interessante porque se um usu√°rio pode **modificar no Okta um campo** (como seu nome ou e-mail) que √© usado por um **aplicativo externo** para **identificar** o usu√°rio, um insider pode tentar **assumir outras contas**.

Al√©m disso, no perfil **`Usu√°rio (padr√£o)`** do Okta, voc√™ pode ver **quais campos** cada **usu√°rio** possui e quais s√£o **grav√°veis** pelos usu√°rios. Se voc√™ n√£o consegue ver o painel de administra√ß√£o, basta ir para **atualizar suas informa√ß√µes de perfil** e voc√™ ver√° quais campos voc√™ pode atualizar (observe que para atualizar um endere√ßo de e-mail, voc√™ precisar√° verific√°-lo).
### Integra√ß√µes de Diret√≥rios

Diret√≥rios permitem importar pessoas de fontes existentes. Aqui voc√™ ver√° os usu√°rios importados de outros diret√≥rios.

Eu n√£o vi isso, mas acredito que seja interessante descobrir **outros diret√≥rios que o Okta est√° usando para importar usu√°rios**, para que, se voc√™ **comprometer esse diret√≥rio**, possa definir alguns valores de atributos nos usu√°rios criados no Okta e **possivelmente comprometer o ambiente do Okta**.

### Fontes de Perfil

Uma fonte de perfil √© um **aplicativo que atua como uma fonte de verdade** para atributos de perfil do usu√°rio. Um usu√°rio s√≥ pode ser obtido de um √∫nico aplicativo ou diret√≥rio por vez.

Eu n√£o vi isso, ent√£o qualquer informa√ß√£o sobre seguran√ßa e hacking relacionada a essa op√ß√£o √© apreciada.

## Personaliza√ß√µes

### Marcas

Verifique na guia **Dom√≠nios** desta se√ß√£o os endere√ßos de e-mail usados para enviar e-mails e o dom√≠nio personalizado dentro do Okta da empresa (que voc√™ provavelmente j√° conhece).

Al√©m disso, na guia **Configura√ß√£o**, se voc√™ for administrador, pode "**Usar uma p√°gina de logout personalizada**" e definir uma URL personalizada.

### SMS

Nada interessante aqui.

### Painel do Usu√°rio Final

Aqui voc√™ pode encontrar aplicativos configurados, mas veremos os detalhes deles em uma se√ß√£o diferente posteriormente.

### Outros

Configura√ß√£o interessante, mas nada super interessante do ponto de vista de seguran√ßa.

## Aplicativos

### Aplicativos

Aqui voc√™ pode encontrar todos os **aplicativos configurados** e seus detalhes: quem tem acesso a eles, como est√° configurado (SAML, OpenID), URL para login, os mapeamentos entre o Okta e o aplicativo...

Na guia **`Login √önico`**, h√° tamb√©m um campo chamado **`Revelar senha`** que permitiria a um usu√°rio **revelar sua senha** ao verificar as configura√ß√µes do aplicativo. Para verificar as configura√ß√µes de um aplicativo no Painel do Usu√°rio, clique nos 3 pontos:

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

E voc√™ pode ver mais detalhes sobre o aplicativo (como o recurso de revela√ß√£o de senha, se estiver habilitado):

<figure><img src="../.gitbook/assets/image (1) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

## Governan√ßa de Identidade

### Certifica√ß√µes de Acesso

Use Certifica√ß√µes de Acesso para criar campanhas de auditoria para revisar periodicamente o acesso dos usu√°rios aos recursos e aprovar ou revogar o acesso automaticamente quando necess√°rio.

Eu n√£o vi isso sendo usado, mas acredito que, do ponto de vista defensivo, seja um recurso interessante.

## Seguran√ßa

### Geral

* **E-mails de notifica√ß√£o de seguran√ßa**: Todos devem estar habilitados.
* **Integra√ß√£o CAPTCHA**: √â recomendado definir pelo menos o reCaptcha invis√≠vel.
* **Seguran√ßa da Organiza√ß√£o**: Tudo pode ser habilitado e os e-mails de ativa√ß√£o n√£o devem durar muito tempo (7 dias est√° bom).
* **Preven√ß√£o de enumera√ß√£o de usu√°rio**: Ambos devem estar habilitados.
* Observe que a Preven√ß√£o de Enumera√ß√£o de Usu√°rio n√£o tem efeito se qualquer uma das seguintes condi√ß√µes for permitida (consulte [Gerenciamento de Usu√°rios](https://help.okta.com/oie/en-us/Content/Topics/users-groups-profiles/usgp-main.htm) para obter mais informa√ß√µes):
* Registro de Autoatendimento
* Fluxos JIT com autentica√ß√£o por e-mail
* **Configura√ß√µes do Okta ThreatInsight**: Registrar e aplicar seguran√ßa com base no n√≠vel de amea√ßa

### HealthInsight

Aqui √© poss√≠vel encontrar configura√ß√µes corretas e **perigosas**.

### Autenticadores

Aqui voc√™ pode encontrar todos os m√©todos de autentica√ß√£o que um usu√°rio pode usar: senha, telefone, e-mail, c√≥digo, WebAuthn... Ao clicar no autenticador de senha, voc√™ pode ver a **pol√≠tica de senha**. Verifique se ela √© forte.

Na guia **Inscri√ß√£o**, voc√™ pode ver quais s√£o obrigat√≥rios ou opcionais:

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

√â recomend√°vel desabilitar o telefone. Os mais fortes provavelmente s√£o uma combina√ß√£o de senha, e-mail e WebAuthn.

### Pol√≠ticas de Autentica√ß√£o

Cada aplicativo possui uma pol√≠tica de autentica√ß√£o. A pol√≠tica de autentica√ß√£o verifica se os usu√°rios que tentam fazer login no aplicativo atendem a condi√ß√µes espec√≠ficas e imp√µe requisitos de fator com base nessas condi√ß√µes.

Aqui voc√™ pode encontrar os **requisitos para acessar cada aplicativo**. √â recomendado solicitar pelo menos uma senha e outro m√©todo para cada aplicativo. Mas se como atacante voc√™ encontrar algo mais fraco, poder√° atac√°-lo.

### Pol√≠tica Global de Sess√£o

Aqui voc√™ pode encontrar as pol√≠ticas de sess√£o atribu√≠das a diferentes grupos. Por exemplo:

<figure><img src="../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

√â recomendado solicitar MFA, limitar o tempo de vida da sess√£o para algumas horas, n√£o persistir cookies de sess√£o em extens√µes do navegador e limitar a localiza√ß√£o e o Provedor de Identidade (se isso for poss√≠vel). Por exemplo, se todos os usu√°rios devem fazer login de um pa√≠s espec√≠fico, voc√™ pode permitir apenas essa localiza√ß√£o.

### Provedores de Identidade

Provedores de Identidade (IdPs) s√£o servi√ßos que **gerenciam contas de usu√°rio**. Adicionar IdPs no Okta permite que seus usu√°rios finais se **registrem automaticamente** em seus aplicativos personalizados, autenticando-se primeiro com uma conta social ou um cart√£o inteligente.

Na p√°gina Provedores de Identidade, voc√™ pode adicionar logins sociais (IdPs) e configurar o Okta como um provedor de servi√ßos (SP) adicionando SAML de entrada. Depois de adicionar IdPs, voc√™ pode configurar regras de roteamento para direcionar os usu√°rios para um IdP com base no contexto, como localiza√ß√£o do usu√°rio, dispositivo ou dom√≠nio de e-mail.

**Se algum provedor de identidade estiver configurado**, do ponto de vista de um atacante e de um defensor, verifique essa configura√ß√£o e **se a fonte √© realmente confi√°vel**, pois um atacante que comprometer isso tamb√©m poder√° obter acesso ao ambiente do Okta.

### Autentica√ß√£o Delegada

A autentica√ß√£o delegada permite que os usu√°rios fa√ßam login no Okta inserindo credenciais para o servidor **Active Directory (AD) ou LDAP** de sua organiza√ß√£o.

Novamente, verifique isso, pois um atacante que comprometer o AD de uma organiza√ß√£o poder√° acessar o Okta por meio dessa configura√ß√£o.

### Rede

Uma zona de rede √© um limite configur√°vel que voc√™ pode usar para **conceder ou restringir o acesso a computadores e dispositivos** em sua organiza√ß√£o com base no **endere√ßo IP** que est√° solicitando acesso. Voc√™ pode definir uma zona de rede especificando um ou mais endere√ßos IP individuais, intervalos de endere√ßos IP ou localiza√ß√µes geogr√°ficas.

Depois de definir uma ou mais zonas de rede, voc√™ pode **us√°-las em Pol√≠ticas Globais de Sess√£o**, pol√≠ticas de autentica√ß√£o, notifica√ß√µes VPN e regras de roteamento.

Do ponto de vista de um atacante, √© interessante saber quais Ps s√£o permitidos (e verificar se algum **IP tem mais privil√©gios** do que outros). Do ponto de vista de um atacante, se os usu√°rios devem acessar de um endere√ßo IP ou regi√£o espec√≠fica, verifique se esse recurso est√° sendo usado corretamente.

### Integra√ß√µes de Dispositivos

* **Gerenciamento de Endpoint**: O gerenciamento de endpoint √© uma condi√ß√£o que pode ser aplicada em uma pol√≠tica de autentica√ß√£o para garantir que dispositivos gerenciados tenham acesso a um aplicativo.
* Ainda n√£o vi isso sendo usado. TODO
* **Servi√ßos de notifica√ß√£o**: Ainda n√£o vi isso sendo usado. TODO
### API

Voc√™ pode criar tokens de API do Okta nesta p√°gina e ver aqueles que foram **criados**, seus **privil√©gios**, tempo de **expira√ß√£o** e **URLs de origem**. Observe que os tokens de API s√£o gerados com as permiss√µes do usu√°rio que criou o token e s√£o v√°lidos apenas se o **usu√°rio** que os criou estiver **ativo**.

As **Origens Confi√°veis** concedem acesso a sites que voc√™ controla e confia para acessar sua organiza√ß√£o Okta por meio da API do Okta.

N√£o deve haver muitos tokens de API, pois se houver, um invasor poder√° tentar acess√°-los e us√°-los.

## Fluxo de trabalho

### Automa√ß√µes

As automa√ß√µes permitem que voc√™ crie a√ß√µes automatizadas que s√£o executadas com base em um conjunto de condi√ß√µes de gatilho que ocorrem durante o ciclo de vida dos usu√°rios finais.

Por exemplo, uma condi√ß√£o pode ser "Inatividade do usu√°rio no Okta" ou "Expira√ß√£o da senha do usu√°rio no Okta" e a a√ß√£o pode ser "Enviar e-mail para o usu√°rio" ou "Alterar o estado do ciclo de vida do usu√°rio no Okta".

## Relat√≥rios

### Relat√≥rios

Fa√ßa o download dos logs. Eles s√£o **enviados** para o **endere√ßo de e-mail** da conta atual.

### Log do sistema

Aqui voc√™ pode encontrar os **logs das a√ß√µes realizadas pelos usu√°rios** com muitos detalhes, como login no Okta ou em aplicativos por meio do Okta.

### Monitoramento de importa√ß√£o

Isso pode **importar logs das outras plataformas** acessadas com o Okta.

### Limites de taxa

Verifique os limites de taxa da API atingidos.

## Configura√ß√µes

### Conta

Aqui voc√™ pode encontrar **informa√ß√µes gen√©ricas** sobre o ambiente Okta, como o nome da empresa, endere√ßo, **contato de faturamento por e-mail**, **contato t√©cnico por e-mail** e tamb√©m quem deve receber atualiza√ß√µes do Okta e qual tipo de atualiza√ß√µes do Okta.

### Downloads

Aqui voc√™ pode baixar agentes do Okta para sincronizar o Okta com outras tecnologias.

<details>

<summary><strong>Apoie o HackTricks e obtenha benef√≠cios!</strong></summary>

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou se deseja acessar a **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
