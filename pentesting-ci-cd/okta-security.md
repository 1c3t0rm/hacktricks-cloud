# Oktaセキュリティ

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社をHackTricksで広告掲載**したい場合や、**最新版のPEASSやHackTricksのPDFをダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけて、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションを見つけましょう
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしましょう 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリに**PRを提出**して、あなたのハッキングテクニックを共有しましょう。

</details>

## 基本情報

Okta, Inc.は、クラウドソフトウェアを提供して企業が現代のアプリケーションに対してユーザー認証を**管理し、保護する**ための**アイデンティティとアクセス管理企業**です。また、開発者がアプリケーション、ウェブサービス、デバイスにアイデンティティコントロールを組み込むのを支援します。

彼らのコアサービスであるOkta Identity Cloudは、シングルサインオン（SSO）、マルチファクタ認証（MFA）、ライフサイクル管理、ユニバーサルディレクトリ、APIアクセス管理などの製品を提供しています。これにより、企業は機密データを保護し、ユーザーアクセスを効率化することができます。これにより、従業員や顧客がアプリケーションやサービスによりアクセスしやすく、利用しやすくなります。

Oktaのサービスは、大企業だけでなく、中小企業や開発者にも広く利用されています。それは企業がクラウドテクノロジーを安全に採用し、管理するために重要な役割を果たしています。私の知識の範囲では、2021年9月までにOktaはアイデンティティとアクセス管理（IAM）業界で重要なプレーヤーであると言えます。

{% hint style="danger" %}
Oktaの主な目標は、異なるユーザーやグループに対して外部アプリケーションへのアクセスを設定することです。もしもOktaの管理者特権を侵害できれば、おそらく会社が使用している他のすべてのプラットフォームを侵害することができます。
{% endhint %}

{% hint style="success" %}
Okta環境のセキュリティレビューを実施するには、**管理者の読み取り専用アクセス**を要求する必要があります。
{% endhint %}

### 概要

**ユーザー**（Oktaに保存される、構成された**アイデンティティプロバイダ**からのログイン、または**Active Directory**またはLDAPを介して認証される）が存在します。\
これらのユーザーは**グループ**内に存在することができます。\
また、**認証子**も存在します：パスワードなどの認証方法や、WebAuthn、メール、電話、Okta Verifyなどのさまざまな2要素認証（有効または無効にできます）...

次に、Oktaと同期された**アプリケーション**があります。各アプリケーションはOktaとの**マッピング**を持ち、情報の共有（メールアドレス、名前など）を行います。さらに、各アプリケーションは**認証ポリシー**内に存在する必要があります。これは、ユーザーがアプリケーションに**アクセスするために必要な認証子**を示します。

{% hint style="danger" %}
最も強力な役割は**スーパー管理者**です。

攻撃者が管理者アクセスでOktaを侵害すると、Oktaを信頼している**すべてのアプリケーションが高い確率で侵害されます**。
{% endhint %}

## 同僚のなりすまし攻撃

各ユーザーが持つことができる**属性（メールアドレスや名前など）**はOktaで設定することができます。もしも**アプリケーション**がユーザーが**変更できる属性**としてIDを信頼している場合、そのプラットフォームで**他のユーザーになりすます**ことができます。

したがって、アプリケーションが**`userName`**フィールドを信頼している場合、おそらくそれを変更することはできません（通常、そのフィールドを変更することはできません）。しかし、**`primaryEmail`**などを信頼している場合、同僚のメールアドレスに変更してなりすますことができるかもしれません（メールにアクセスでき、変更を承認する必要があります）。

このなりすましは、各アプリケーションの設定に依存します。変更したフィールドを信頼し、更新を受け入れるアプリケーションのみが侵害されます。\
したがって、そのフィールドが存在する場合、アプリケーションはこのフィールドを有効にする必要があります：

<figure><img src="../.gitbook/assets/image (89).png" alt=""><figcaption></figcaption></figure>

他のアプリケーションでも脆弱性がある場合がありますが、Oktaの設定にはそのフィールドがない場合もあります（最終的には異なるアプリケーションは異なるように設定されています）。

各アプリケーションで誰でもなりすますことができるかどうかを確認する最良の方法は、試してみることです！

## ディレクトリ

### ユーザー

攻撃者の視点からは、**登録されたすべてのユーザー**、彼らの**メールアドレス**、所属する**グループ**、**プロファイル**、さらには**デバイス**（モバイルとそれらのOS）を見ることができます。

ホワイトボックスレビューでは、「**保留中のユーザーアクション**」や「**パスワードリセット**」がないことを確認してください。

### グループ

ここにはOktaで作成されたすべてのグループが表示されます。ユーザーに**付与される権限のセット**である異なるグループを理解することが興味深いです。\
**グループに含まれる人々**や各グループに**割り当てられたアプリケーション**を見ることができます。

もちろん、**admin**という名前のグループは興味深いですが、特に**Global Administrators**グループは、特権を持つメンバーを知るためにメンバーをチェックしてください。

ホワイトボックスレビューでは、**グローバル管理者は5人以上いない**はずです（2人または3人だけの方が良いです）。

### デバイス

すべてのユーザーのデバイスのリストがここに表示されます。アクティ
### ディレクトリの統合

ディレクトリを使用すると、既存のソースから人々をインポートできます。おそらく、ここでは他のディレクトリからインポートされたユーザーが表示されます。

私はそれを見たことはありませんが、おそらくOktaがユーザーをインポートするために使用している他のディレクトリを見つけることは興味深いでしょう。したがって、そのディレクトリを侵害すると、Oktaで作成されたユーザーの属性値を設定し、Okta環境を侵害する可能性があります。

### プロファイルソース

プロファイルソースは、ユーザープロファイル属性の真実のソースとして機能するアプリケーションです。ユーザーは、一度に1つのアプリケーションまたはディレクトリからのみソース化されます。

私はそれを見たことはありませんので、このオプションに関するセキュリティとハッキングに関する情報は歓迎です。

## カスタマイズ

### ブランド

このセクションの**ドメイン**タブで、メールを送信するために使用されるメールアドレスと、会社のOkta内のカスタムドメイン（おそらく既に知っているでしょう）を確認してください。

さらに、**設定**タブでは、管理者であれば「**カスタムサインアウトページを使用する**」ことができ、カスタムURLを設定することができます。

### SMS

ここには興味深いものはありません。

### エンドユーザーダッシュボード

ここでは、構成されたアプリケーションが見つかりますが、後で別のセクションでそれらの詳細を見ることになります。

### その他

興味深い設定ですが、セキュリティの観点からは特に興味深いものはありません。

## アプリケーション

### アプリケーション

ここでは、**構成されたアプリケーション**とその詳細を見つけることができます：アクセス権限を持つユーザー、構成方法（SAML、OPenID）、ログイン用のURL、Oktaとアプリケーション間のマッピング...

**`サインオン`**タブには、アプリケーションの設定を確認するためにユーザーパネルからアプリケーションの設定を確認するために、3つのドットをクリックします：

<figure><img src="../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

そして、アプリに関する詳細（パスワードの表示機能が有効かどうかなど）を見ることができます：

<figure><img src="../.gitbook/assets/image (1) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

## Identity Governance

### アクセス認証

アクセス認証を使用して、ユーザーのリソースへのアクセスを定期的にレビューし、必要に応じて自動的に承認または取り消す監査キャンペーンを作成できます。

私はそれが使用されているのを見たことはありませんが、防御の観点からは素晴らしい機能だと思います。

## セキュリティ

### 一般

* **セキュリティ通知メール**：すべてが有効になっている必要があります。
* **CAPTCHAの統合**：少なくとも不可視のreCaptchaを設定することをお勧めします。
* **組織のセキュリティ**：すべてを有効にすることができ、アクティベーションメールの有効期間は長く続かないはずです（7日間は問題ありません）。
* **ユーザー列挙の防止**：両方を有効にする必要があります。
* ユーザー列挙の防止は、次の条件のいずれかが許可されている場合には効果がありません（詳細については、[ユーザー管理](https://help.okta.com/oie/en-us/Content/Topics/users-groups-profiles/usgp-main.htm)を参照してください）：
* セルフサービス登録
* メール認証を伴うJITフロー
* **Okta ThreatInsightの設定**：脅威レベルに基づいてセキュリティを記録および強制する

### HealthInsight

ここでは、正しく**危険な**設定を見つけることができます。

### 認証子

ここでは、ユーザーが使用できるすべての認証方法を見つけることができます：パスワード、電話、メール、コード、WebAuthn... パスワード認証子をクリックすると、**パスワードポリシー**が表示されます。それが強力であることを確認してください。

**登録**タブでは、必須またはオプションの方法を確認できます：

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

電話は無効にすることをお勧めします。最も強力なものはおそらくパスワード、メール、およびWebAuthnの組み合わせです。

### 認証ポリシー

すべてのアプリには認証ポリシーがあります。認証ポリシーは、アプリにサインインしようとするユーザーが特定の条件を満たしているかどうかを検証し、それに基づいて要素の要件を強制します。

ここでは、各アプリケーションへのアクセス要件を見つけることができます。各アプリケーションに対して少なくともパスワードと別の方法を要求することをお勧めします。ただし、攻撃者としては、より弱いものを見つけることができれば攻撃することができるかもしれません。

### グローバルセッションポリシー

ここでは、さまざまなグループに割り当てられたセッションポリシーを見つけることができます。例えば：

<figure><img src="../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

MFAを要求し、セッションの有効期間を数時間に制限し、セッションクッキーをブラウザ拡張機能全体で永続化しないようにし、場所とIdentity Providerを制限することをお勧めします（これが可能な場合）。たとえば、すべてのユーザーが特定の国からログインする必要がある場合、この場所のみを許可することができます。

### Identity Providers

Identity Providers（IdPs）は、ユーザーアカウントを管理するサービスです。OktaにIdPsを追加すると、エンドユーザーはソーシャルアカウントまたはスマートカードで最初に認証してカスタムアプリケーションに自己登録できるようになります。

Identity Providersページでは、ソーシャルログイン（IdPs）を追加し、受信SAMLを追加することでOktaをサービスプロバイダ（SP）として構成できます。IdPsを追加した後、ユーザーをIdPにリダイレクトするためのルーティングルールを設定することができます。ユーザーの場所、デバイス、またはメールドメインなどのコンテキストに基づいて。

**もしもどのIdentity Providerが構成されている場合**、攻撃者としても防御者としても、その構成を確認し、**ソースが本当に信頼できるもの**であるかを確認してください。攻撃者がそれを侵害すると、Okta環
### API

このページでは、Okta API トークンを作成し、作成されたトークン、その権限、有効期限、および起点 URL を確認することができます。API トークンは、トークンを作成したユーザーの権限で生成され、トークンを作成したユーザーがアクティブである場合にのみ有効です。

**信頼された起点**は、Okta API を介して Okta 組織にアクセスするために制御し信頼できるウェブサイトにアクセス権を付与します。

API トークンが多すぎると、攻撃者がそれらにアクセスして使用しようとする可能性があるため、多くの API トークンは存在すべきではありません。

## ワークフロー

### オートメーション

オートメーションを使用すると、エンドユーザーのライフサイクル中に発生する一連のトリガ条件に基づいて実行される自動アクションを作成できます。

たとえば、「Okta でのユーザーの非アクティブ化」や「Okta でのユーザーのパスワードの有効期限切れ」といった条件があり、アクションは「ユーザーにメールを送信する」や「Okta でのユーザーのライフサイクル状態を変更する」などが考えられます。

## レポート

### レポート

ログをダウンロードします。ログは現在のアカウントのメールアドレスに送信されます。

### システムログ

ここでは、Okta または Okta を介してアプリケーションにログインするなど、ユーザーによって実行されたアクションのログを詳細に確認できます。

### インポートモニタリング

これにより、Okta でアクセスした他のプラットフォームからログをインポートできます。

### レート制限

API のレート制限に達したかどうかを確認します。

## 設定

### アカウント

ここでは、Okta 環境に関する一般的な情報（会社名、住所、請求連絡先メールアドレス、技術連絡先メールアドレス）や、Okta の更新を受け取るべき人物、および Okta の更新の種類についての情報を見つけることができます。

### ダウンロード

ここでは、Okta エージェントをダウンロードして、Okta を他のテクノロジーと同期させることができます。

<details>

<summary><strong>Support HackTricks and get benefits!</strong></summary>

* もしもあなたの**会社を HackTricks で宣伝したい**場合や、**最新バージョンの PEASS を入手したい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を見つけて、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) を手に入れましょう
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) や [**telegram グループ**](https://t.me/peass) に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォロー**しましょう。
* **ハッキングのトリックを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出しましょう。

</details>
