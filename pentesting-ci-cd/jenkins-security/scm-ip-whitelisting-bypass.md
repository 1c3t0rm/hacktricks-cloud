# Bypass de Whitelisting de IP no SCM

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Esta p√°gina foi copiada de [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## Introdu√ß√£o

Muitas organiza√ß√µes combinam sistemas de gerenciamento de controle de fonte baseados em SaaS (como GitHub ou GitLab) com uma solu√ß√£o interna de CI auto-hospedada (por exemplo, Jenkins, TeamCity), permitindo que esses sistemas de CI **recebam eventos de webhook da fonte SaaS**, com o simples prop√≥sito de disparar jobs de pipeline.

Portanto, as organiza√ß√µes **whitelistam** os intervalos de **IP** do **SCM** permitindo que eles alcancem o sistema de CI **interno** com **webhooks**. No entanto, observe como **qualquer pessoa** pode criar uma **conta** no Github ou Gitlab e fazer com que ela **dispare um webhook** que poderia enviar uma solicita√ß√£o para esse **sistema de CI interno**.

Al√©m disso, note que enquanto o intervalo de IP do servi√ßo de webhook do fornecedor SCM foi aberto no firewall da organiza√ß√£o para **permitir que solicita√ß√µes de webhook disparem pipelines** ‚Äì isso **n√£o significa** que solicita√ß√µes de webhook n√£o possam ser **direcionadas para outros endpoints de CI**, al√©m daqueles que regularmente escutam eventos de webhook. Podemos tentar acessar esses endpoints para **visualizar dados valiosos como usu√°rios**, **pipelines**, **sa√≠da do console** de jobs de pipeline, ou se tivermos sorte o suficiente para encontrar uma inst√¢ncia que concede privil√©gios de administrador a usu√°rios n√£o autenticados (sim, isso acontece), podemos acessar as **se√ß√µes de configura√ß√µes e credenciais**.

### Cen√°rio

Imagine um servi√ßo **Jenkins** que **permite apenas** IPs do **GitHub** e **GitLab** para alcan√ß√°-lo **externamente**.

Neste cen√°rio, um atacante ir√° disparar webhooks arbitr√°rios no GitHub e GitLab para fazer login no Jenkins e extrair informa√ß√µes.

### Limita√ß√µes Comuns de Webhooks

* **Apenas solicita√ß√µes POST**: Webhooks geralmente s√≥ permitem que voc√™ envie solicita√ß√µes POST, no entanto, alguns **endpoints** com informa√ß√µes **interessantes** precisam ser acessados via **solicita√ß√µes GET**.
* Se o Post for **respondido com um redirecionamento**, ele pode segui-lo.
* Alguns CIs (Jenkins) permitem ter um **par√¢metro GET indicando onde redirecionar o cliente** assim que ele conseguir fazer login, voc√™ pode usar isso para redirecion√°-lo para uma p√°gina espec√≠fica com um GET.
* **N√£o √© poss√≠vel controlar o corpo da solicita√ß√£o POST**: Se voc√™ quiser enviar dados espec√≠ficos no corpo do POST, voc√™ n√£o poder√°.
* **Tokens CSRF**: Se o endpoint interessante estiver esperando tokens CSRF, voc√™ n√£o ser√° capaz de extra√≠-los e fornec√™-los.

## Webhooks do GitHub

### Abusando do login no Jenkins

O login requer o envio de uma **solicita√ß√£o POST**. Escolher direcionar o endpoint de login resolve o desafio de manter tokens CSRF, j√° que essa solicita√ß√£o espec√≠fica n√£o os requer. Mas ainda enfrentamos o outro desafio, pois nossa capacidade de **modificar o corpo da solicita√ß√£o permanece limitada**.

Uma solicita√ß√£o de login no Jenkins √© assim:
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
Precisamos **enviar as credenciais que for√ßamos bruscamente de alguma forma**.\
Felizmente, o ponto de entrada de login do Jenkins **aceita** uma solicita√ß√£o POST com os **campos enviados como par√¢metros de consulta**:
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
Ent√£o, como podemos fazer isso funcionar? Podemos **criar um novo webhook no GitHub**, definindo a **URL de solicita√ß√£o de login do Jenkins como a URL de carga √∫til**. Em seguida, podemos criar uma automa√ß√£o usando a API do GitHub para **for√ßar bruscamente a senha da conta do usu√°rio**, modificando o campo de senha, acionando o webhook e inspecionando a resposta no log de eventos do webhook do reposit√≥rio.
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
<figure><img src="../../.gitbook/assets/image (7) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

Disparamos o webhook e vemos os resultados. Todos os fornecedores de SCM exibem a solicita√ß√£o HTTP e a resposta enviadas pelo webhook em sua UI.
Se a tentativa de login falhar, somos redirecionados para a p√°gina de erro de login.

<figure><img src="../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

Mas se o **login for bem-sucedido**, somos redirecionados para a p√°gina principal do Jenkins, e um **cookie de sess√£o √© definido**.

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

Ent√£o, podemos **for√ßar bruscamente as credenciais do Jenkins e obter um cookie de sess√£o!**
No entanto, estamos um pouco limitados ‚Äì s√≥ podemos **enviar uma solicita√ß√£o sem estado de cada vez**, e o **cookie n√£o pode ser anexado** √† nossa solicita√ß√£o, pois n√£o podemos controlar os cabe√ßalhos.

Outra op√ß√£o seria tentar obter um **token de acesso do Jenkins**, que pode ser anexado na URL e usado para enviar solicita√ß√µes POST para o Jenkins sem a necessidade de adicionar um token CSRF. Esta op√ß√£o √© um pouco mais complexa, pois exige que um atacante encontre de alguma forma tanto um CI auto-hospedado que s√≥ √© acess√≠vel a partir de faixas de IP do SCM e tamb√©m obtenha um token de acesso v√°lido para esse CI. Ent√£o, por enquanto ‚Äì vamos nos concentrar em cen√°rios mais pr√°ticos.

## Webhooks do GitLab

### Abusando do Login do Jenkins

Vamos tentar enviar a mesma solicita√ß√£o, mas desta vez atrav√©s do GitLab. Devido √†s mesmas limita√ß√µes, enviamos a **mesma solicita√ß√£o POST, adicionando as credenciais como par√¢metros de consulta**.

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

Disparamos a solicita√ß√£o, mas ao contr√°rio do GitHub ‚Äì a resposta √© 200. Como no √∫ltimo exemplo, usamos **o servi√ßo de webhook do GitLab para for√ßar bruscamente um usu√°rio e obter um cookie de sess√£o**, mas desta vez ‚Äì o conte√∫do da resposta do Jenkins foi retransmitido de volta para a UI do GitLab, fornecendo-nos essencialmente com o **conte√∫do completo da p√°gina principal do Jenkins.**
\*\*\*\*Isso ocorre porque o **GitLab seguiu o redirecionamento** adicionando o **Cookie** √† solicita√ß√£o:

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

Isso significa que podemos:

1. for√ßar bruscamente usu√°rios e descobrir credenciais v√°lidas,
2. usar as credenciais v√°lidas contra a p√°gina de login para fazer login com sucesso,
3. obter o conte√∫do da p√°gina principal interna do Jenkins.

### Obtendo Dados Internos do Jenkins

O **login do Jenkins aceita um par√¢metro de redirecionamento** ‚Äì ‚Äú_from_‚Äù. Originalmente usado para **redirecionar usu√°rios para a p√°gina que pretendiam alcan√ßar ap√≥s fazerem login**, mas no nosso caso ‚Äì um recurso que podemos abusar para enviar uma solicita√ß√£o GET anexada com um cookie de sess√£o para uma p√°gina interna do Jenkins de nossa escolha. Vamos ver como:

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

1. Defina um webhook com a seguinte URL:
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
Uma requisi√ß√£o POST √© enviada para o Jenkins, e a autentica√ß√£o √© bem-sucedida.

* Recebemos uma resposta de redirecionamento 302, com um cookie de sess√£o, e um redirecionamento para a p√°gina de sa√≠da do console do trabalho.
* O servi√ßo de webhook do GitLab segue automaticamente o redirecionamento com uma requisi√ß√£o GET enviada para a p√°gina de sa√≠da do console do trabalho, junto com o cookie de sess√£o que √© adicionado √† requisi√ß√£o:
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* A sa√≠da do console do trabalho √© enviada de volta e apresentada no log de eventos de webhook do GitLab do atacante.

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

√â importante mencionar aqui que o Jenkins pode ser **configurado para permitir acesso aos componentes internos sem autentica√ß√£o**, ou de forma que apenas usu√°rios autenticados possam acessar os componentes internos. Como isso nos afeta?

* Se **n√£o houver autentica√ß√£o** configurada, podemos fazer com que o **servi√ßo de webhook do GitLab acesse qualquer p√°gina interna no CI**, capture a resposta e a apresente para n√≥s.
* Se a autentica√ß√£o estiver configurada, podemos tentar for√ßar a entrada de um usu√°rio e, em seguida, usar as credenciais para acessar qualquer p√°gina interna (como no item acima).

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
