# SCM IP 白名单绕过

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

此页面复制自 [https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/](https://www.cidersecurity.io/blog/research/how-we-abused-repository-webhooks-to-access-internal-ci-systems-at-scale/)

## 引言

许多组织将 **基于 SaaS 的源代码管理 (SCM) 系统**（如 GitHub 或 GitLab）与 **内部**、自托管的 **CI** 解决方案（例如 Jenkins、TeamCity）结合起来，允许这些 CI 系统 **接收来自 SaaS 源** 控制供应商的 **webhook 事件**，其简单目的是触发管道作业。

因此，组织 **白名单** 了 **SCM** 的 **IP** 范围，允许它们通过 **webhooks** 访问 **内部** CI 系统。但是，请注意 **任何人** 都可以在 Github 或 Gitlab 中创建一个 **账户** 并使其 **触发 webhook**，该 webhook 可能会向该 **内部 CI 系统** 发送请求。

此外，请注意，尽管 SCM 供应商的 webhook 服务的 IP 范围在组织的防火墙中被打开，以 **允许 webhook 请求触发管道** - 这并 **不意味着** webhook 请求不能被 **引导到其他 CI 端点**，除了那些定期监听 webhook 事件的端点。我们可以尝试访问这些端点以 **查看有价值的数据，如用户**、**管道**、管道作业的 **控制台输出**，或者如果我们足够幸运遇到一个向未经认证的用户授予管理员权限的实例（是的，这种情况确实存在），我们可以访问 **配置和凭证部分**。

### 场景

想象一个 **Jenkins** 服务，它只 **允许** **GitHub** 和 **GitLab** 的 IP **从外部** 访问它。

在这种情况下，攻击者将在 GitHub 和 GitLab 中触发任意 webhook，以登录 Jenkins 并提取信息。

### 常见的 Webhooks 限制

* **只允许 POST 请求**：Webhooks 通常只允许您发送 POST 请求，但是，一些 **端点** 需要通过 **GET 请求** 访问 **有趣的** 信息。
* 如果 Post 被 **回答重定向**，它可能会遵循它。
* 一些 CI（如 Jenkins）允许有一个 **GET 参数指示在登录成功后将客户端重定向到哪里**，您可以使用这个将他重定向到带有 Get 的特定页面。
* **无法控制 POST 请求的正文**：如果您要在 POST 正文中发送特定数据，您无法做到。
* **CSRF 令牌**：如果有趣的端点期望 CSRF 令牌，您将无法提取它们并提供它们。

## GitHub Webhooks

### 滥用 Jenkins 登录

登录需要发送 **POST 请求**。选择目标登录端点解决了持有 CSRF 令牌的挑战，因为这个特定的请求不需要它。但我们仍然面临另一个挑战，因为我们 **修改请求正文的能力仍然有限**。

Jenkins 登录请求如下所示：
```
POST /j_acegi_security_check HTTP/1.1
Host: jenkins.example-domain.com
[...]

j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in
```
我们需要**以某种方式发送我们暴力破解的凭证**。\
幸运的是，Jenkins登录端点**接受**一个POST请求，其中**字段作为查询参数发送**：
```
POST /j_acegi_security_check?j_username=admin&j_password=mypass123&from=%2F&Submit=Sign+in HTTP/1.1
Host: jenkins.example-domain.com
[...]

[webhook json in body of request]
```
因此，我们如何才能让它工作呢？我们可以**在GitHub中创建一个新的webhook**，将**Jenkins登录请求URL设置为payload URL**。然后我们可以使用GitHub API创建一个自动化程序来**暴力破解用户账户的密码**，通过修改密码字段，触发webhook，并在仓库webhook事件日志中检查响应。
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=therealpassword&from=%2F&Submit=Sign+in
```
<figure><img src="../../.gitbook/assets/image (7) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

我们触发 webhook，并查看结果。所有 SCM 供应商都会在他们的 UI 中显示通过 webhook 发送的 HTTP 请求和响应。
如果登录尝试失败，我们会被重定向到登录错误页面。

<figure><img src="../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

但如果**登录成功**，我们会被重定向到 Jenkins 主页面，并且会设置一个**会话 cookie**。

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

所以，我们可以**暴力破解 Jenkins 凭据并获取会话 cookie！**
然而，我们有些受限 — 我们每次只能**发送一个无状态请求**，并且**无法附加 cookie**到我们的请求中，因为我们无法控制头部。

另一个选项是尝试获取一个**Jenkins 访问令牌**，它可以附加在 URL 中，并用于发送 POST 请求到 Jenkins，无需添加 CSRF 令牌。这个选项稍微复杂一些，因为它要求攻击者不仅要找到一个仅从 SCM IP 范围内可访问的自托管 CI，还要获取到该 CI 的有效访问令牌。所以目前 — 我们将专注于更实际的场景。

## GitLab Webhooks

### 滥用 Jenkins 登录

让我们尝试发送相同的请求，但这次通过 GitLab。由于相同的限制，我们发送**完全相同的 POST 请求，将凭据作为查询参数添加**。

<figure><img src="../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

我们触发请求，但与 GitHub 不同 — 响应是 200。如同上一个例子，我们使用了**GitLab 的 webhook 服务来暴力破解用户并获取会话 cookie**，但这次 — Jenkins 的响应内容被传回到 GitLab UI，实际上为我们提供了**Jenkins 主页面的完整内容。**
\*\*\*\*这是因为 **GitLab 跟随了重定向**，在请求中添加了**Cookie**：

<figure><img src="../../.gitbook/assets/image (4) (1) (2).png" alt=""><figcaption></figcaption></figure>

这意味着我们可以：

1. 暴力破解用户并发现有效凭据，
2. 使用有效凭据对登录页面进行登录成功，
3. 获取内部 Jenkins 主页面的内容。

### 获取 Jenkins 内部数据

Jenkins **登录接受一个重定向参数** —— “_from_”。原本用于**在用户登录后重定向他们到他们想要到达的页面**，但在我们的案例中 —— 我们可以滥用这个功能，发送一个附带会话 cookie 的 GET 请求到我们选择的内部 Jenkins 页面。让我们看看如何操作：

<figure><img src="../../.gitbook/assets/image (5) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

1. 设置一个 webhook，使用以下 URL：
```
http://jenkins.example-domain.com/j_acegi_security_check?j_username=admin&j_password=secretpass123&from=/job/prod_pipeline/1/consoleText&Submit=Sign+in
```
POST 请求发送到 Jenkins，认证成功。

* 我们得到一个 302 重定向响应，带有会话 cookie，并重定向到作业控制台输出页面。
* GitLab webhook 服务自动跟随重定向，使用 GET 请求发送到作业控制台输出页面，并将会话 cookie 添加到请求中：
```
http://jenkins.example-domain.com/job/prod_pipeline/1/consoleText
```
* 作业控制台输出被发送回来，并显示在攻击者的 GitLab webhook 事件日志中。

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

这里需要提到的是，Jenkins 可以**配置为允许无需认证即可访问内部组件**，或者配置为只有经过认证的用户才能访问内部组件。这对我们有什么影响？

* 如果**没有配置认证**，我们可以让 **GitLab webhook 服务访问 CI 中的任何内部页面**，捕获响应，并将其展示给我们。
* 如果配置了认证，我们可以尝试暴力破解一个用户，然后使用凭据访问任何内部页面（如上一条所述）。

<details>

<summary><strong>从零开始学习 AWS 黑客攻击，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
